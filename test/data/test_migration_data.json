{"PHID-TASK-2dxobbn6uq2ox5bq3dcu":{"id":"1001","title":"Updates proxy check fails in whonix-ws-15","status":"resolved","priority":"Needs Triage","author":"marmarek","description":"Recent test runs report failure of whonixcheck, I think relevant lines:\n\n```\nJan 05 02:51:27 host sudo[1882]: pam_exec(sudo:auth): /usr/lib/security-misc/pam-abort-on-locked-password failed: exit code 1\nJan 05 02:51:27 host sudo[1882]:     root : PAM authentication error: System error ; TTY=unknown ; PWD=/ ; USER=updatesproxycheck ; ENV=UWT_DEV_PASSTHROUGH=1 ; COMMAND=/usr/bin/curl --silent http://127.0.0.1:8082/\n```\n\n```\nWARNING: Execution of /usr/bin/apt-get prevented by /etc/uwt.d/40_qubes.conf because no torified Qubes updates proxy found.\n```\n\nThe exact command is: `qvm-run -ap whonix-ws-15 'LC_ALL=C whonixcheck --verbose --leak-tests --cli'`\nFull output: https://openqa.qubes-os.org/tests/15305/file/whonixcheck-whonixcheck-whonix-ws-15.log\n\nThis may be related to not setting empty root password anymore.\n\nMore info extracted from logs:\n```\n[2021-01-04 21:51:10] [   16.144317] torified-updates-proxy-check[538]: + true\n[2021-01-04 21:51:10] [   16.146402] torified-updates-proxy-check[538]: ++ sudo -u updatesproxycheck UWT_DEV_PASSTHROUGH=1 curl --silent http://127.0.0.1:8082/\n[2021-01-04 21:51:10] [   16.226376] sudo[629]: pam_exec(sudo:auth): /usr/lib/security-misc/pam-abort-on-locked-password failed: exit code 1\n[2021-01-04 21:51:10] [   16.226983] torified-updates-proxy-check[538]: /usr/lib/security-misc/pam-abort-on-locked-password failed: exit code 1\n[2021-01-04 21:51:10] [   16.230002] torified-updates-proxy-check[538]: sudo: PAM authentication error: System error\n[2021-01-04 21:51:10] [   16.231315] sudo[629]:     root : PAM authentication error: System error ; TTY=unknown ; PWD=/ ; USER=updatesproxycheck ; ENV=UWT_DEV_PASSTHROUGH=1 ; COMMAND=/usr/bin/curl --silent http://127.0.0.1:8082/\n```\n\nLooks like `/usr/lib/security-misc/pam-abort-on-locked-password` prevents root from using sudo (if there is no root password set). Since `torified-updates-proxy-check` is started as root (systemd service?), perhaps sudo usage is not needed there and simple `runuser` or even `setpriv` would be enough?","comments":[{"author":"Patrick","date_created":1609826838,"date_modified":1609826838,"content":"`/usr/lib/qubes-whonix/init/torified-updates-proxy-check` is currently only started by `/lib/systemd/system/qubes-whonix-torified-updates-proxy-check.service`.\n\nWondering why this is happening. When root uses sudo, pam shouldn't even be involved.\n\nWould also be good if the whole script would run as non-root. However, it needs to write into `/run/qubes-service/` folder.\n\n> This may be related to not setting empty root password anymore.\n\nWhen/where/how was this changed? Or how can I reproduce setting the same root password that Qubes is using now? I.e. how/where is it being done now during the build process / package maintainer scripts?"},{"author":"marmarek","date_created":1609869290,"date_modified":1609869290,"content":">>! In T1001#20201, @Patrick wrote:\n> `/usr/lib/qubes-whonix/init/torified-updates-proxy-check` is currently only started by `/lib/systemd/system/qubes-whonix-torified-updates-proxy-check.service`.\n> \n> Wondering why this is happening. When root uses sudo, pam shouldn't even be involved.\n\nPAM is involved always when something needs user authentication, including root. But there may be a PAM configuration bypassing it for root. For example `/etc/pam.d/su` has this quite early:\n```\n# This allows root to su without passwords (normal operation)\nauth       sufficient pam_rootok.so\n```\n\nBut I don't see similar bypass for sudo in Debian.\n\n> Would also be good if the whole script would run as non-root. However, it needs to write into `/run/qubes-service/` folder.\n\nWell, since it needs to switch to another user to run curl, it also needs some kind of extra privileges (here with sudo, which is now broken).\nAs for `/run/qubes-service/`, I think it's quite arbitrary, since `whonix-secure-proxy` isn't really controlled via `qvm-service` framework, it is just a file created by `torified-updates-proxy-check` and then checked by another script. Theoretically it can be anywhere. But indeed some location in `/run` is convenient here.\n\nAnyway, since the script is started by systemd unit only, maybe the whole script can be started by systemd as `updatesproxycheck` user, removing the need for sudo or any other mechanism? And then the flag file put in a (new?) directory where `updatesproxycheck` user could write?\n\n> \n>> This may be related to not setting empty root password anymore.\n> \n> When/where/how was this changed? \n\nhttps://github.com/QubesOS/qubes-issues/issues/5799\n\n> Or how can I reproduce setting the same root password that Qubes is using now? I.e. how/where is it being done now during the build process / package maintainer scripts?\n\nNow root password is simply not set, so it remains locked (`!` in `/etc/shadow`)."},{"author":"marmarek","date_created":1610116089,"date_modified":1610116089,"content":"I've found why sudo asked for password, it wasn't related to security-misc script mentioned earlier. And should be fixed in newer qubes-core-agent package.\n\nBut I think it's still a good idea to not rely on sudo in systemd service."},{"author":"Patrick","date_created":1610174638,"date_modified":1610174638,"content":"https://gitlab.com/whonix/qubes-whonix/-/commit/53ff72ab6ce59cb2c98401fd701ae782ca100e37\n"},{"author":"Patrick","date_created":1611486484,"date_modified":1611486484,"content":"\nBtw this issue tracker is being phased out:\nhttps://www.whonix.org/wiki/Reporting_Bugs#Issue_Tracker"}]},"PHID-TASK-hjx5lt77z4ajsj6w4liz":{"id":"1000","title":"Add Wasabi Bitcoin wallet","status":"invalid","priority":"Needs Triage","author":"ratpoison4","description":"[[ https://wasabiwallet.io/ | Wasabi Wallet ]] is lite wallet focused on privacy. It has coin join function allowing to mix coins with other users of the Wallet. It uses Tor by default to anonymize the user. It uses BIP-157 block filters to protect user's list of addresses. In Electrum servers see the list of user's addresses, so if one address is deanonymized, the whole wallet is. In wasabi you see if a coin was mixed (anonymized) and who may know about your ownership of it.\n\nI think the Wallet is worth being added to Whonix workstation and also to Whonix documentation to this section: https://www.whonix.org/wiki/Bitcoin#Anonymizing_Existing_Bitcoins as it is a non-custodial and cheap way of mixing better in my opinion than washing through exchanges and/or Monero.","comments":[{"author":"Patrick","date_created":1598870315,"date_modified":1598870315,"content":"We don't use this tracker for new feature requests anymore either as per:\nhttps://www.whonix.org/wiki/Reporting_Bugs\n\nHave to be careful for legal reasons too as per:\nhttps://www.whonix.org/wiki/Money#Legality\n\nSee also `Whonix ™ Default Application Policy`:\nhttps://www.whonix.org/wiki/Dev/Default_Application_Policy\n"}]},"PHID-TASK-wjq3rhghhysgspfut43a":{"id":"999","title":"Can't build Whonix from source","status":"invalid","priority":"Needs Triage","author":"el-cpu","description":"Hello! Trying to build from source. The story of my issue here:\nhttps://github.com/Whonix/Whonix/issues/435\nI installed python 3-7 as instructed. Still same error. It was 127, now it is 125. \n\nUnfortunatelly I have debian buster only in VM. If I try install Whonix there it works slowly so I try to find a way to install in host. Also in that discussion I mentioned in above link there was a success with Ubuntu 20.04.\n\nThanks in advance.\n\n############################################################\nERROR in ././build-steps.d/1120_prepare-build-machine detected!\n\ndist_build_version: 15.0.1.3.9\nwhonix_build_error_counter: 1\nbenchmark: 00:00:09\nlast_failed_exit_code: 100\ntrap_signal_type_previous: unset\ntrap_signal_type_last    : ERR\n\nprocess_backtrace_result:\n1: : init\n2: : /usr/bin/mate-terminal -x /bin/sh -c '\\''/home/candra/Desktop/dns.sh'\\'' \n3: : bash \n4: : sudo /home/candra/Whonix/whonix_build --flavor whonix-gateway-xfce --target qcow2 --repo true --build \n5: : /bin/bash /home/candra/Whonix/whonix_build --flavor whonix-gateway-xfce --target qcow2 --repo true --build \n6: : /bin/bash ././build-steps.d/1120_prepare-build-machine \n\nfunction_trace_result:\nmain (line number: 245)\nmain (line number: 242)\nbuild_machine_setup (line number: 85)\nerrorhandlergeneral (line number: 367)\nerrorhandlerprocessshared (line number: 196)\n\n\nlast_failed_bash_command: $apt_get_update_wrapper_source_path_full ${APTGETOPT[@]} -o Dir::Etc::sourcelist=\"$whonix_build_sources_list_primary\" -o Dir::Etc::sourceparts=\"-\" update\n############################################################\n'\n++ unset error_reason\n++ '[' ERR = INT ']'\n++ '[' ERR = TERM ']'\n++ '[' ERR = ERR ']'\n++ '[' '!' 1 = 0 ']'\n++ '[' '' = '' ']'\n++ whonix_build_auto_retry_counter=1\n++ '[' -n 1 ']'\n++ '[' -n 5 ']'\n++ '[' '$apt_get_update_wrapper_source_path_full' = error_ ']'\n++ '[' 1 -gt 1 ']'\n++ true 'INFO: Auto retry attempt number: 1. Max retry attempts: 1 (--retry-max). Auto retry... '\n++ whonix_build_auto_retry_counter=2\n++ '[' '!' 5 = 0 ']'\n++ true 'INFO: Waiting (--retry-wait) 5 seconds before auto retry... '\n++ wait 19285\n++ sleep 5\n++ ignore_error=true\n++ error_handler_do_retry=true\n++ errorhandlerretry\n++ '[' '!' '' = '' ']'\n++ true 'INFO: Skipping whonix_build_dispatch_before_retry (--retry-before), because empty, ok.'\n++ true 'INFO: Retrying last_failed_bash_command...: $apt_get_update_wrapper_source_path_full ${APTGETOPT[@]} -o Dir::Etc::sourcelist=\"$whonix_build_sources_list_primary\" -o Dir::Etc::sourceparts=\"-\" update '\n++ retry_last_failed_bash_command_exit_code=0\n++ eval '$apt_get_update_wrapper_source_path_full' -o 'Dir::Etc::sourcelist=\"$whonix_build_sources_list_primary\"' -o 'Dir::Etc::sourceparts=\"-\"' update\n+++ /home/candra/Whonix/packages/security-misc//usr/lib/security-misc/apt-get-wrapper -o Dir::Etc::sourcelist=/home/candra/Whonix/build_sources/debian_stable_current_clearnet.list -o Dir::Etc::sourceparts=- update\nErr:1 http://HTTPS///deb.debian.org/debian-security buster/updates InRelease\n  Could not resolve 'HTTPS'\nErr:2 http://HTTPS///deb.debian.org/debian buster InRelease\n  Could not resolve 'HTTPS'\nReading package lists...\nW: Failed to fetch http://HTTPS///deb.debian.org/debian-security/dists/buster/updates/InRelease  Could not resolve 'HTTPS'\nW: Failed to fetch http://HTTPS///deb.debian.org/debian/dists/buster/InRelease  Could not resolve 'HTTPS'\nW: Some index files failed to download. They have been ignored, or old ones used instead.\n++ retry_last_failed_bash_command_exit_code=125\n++ true\n++ '[' 125 = 0 ']'\n++ true 'INFO: Retry failed. exit code of last_failed_bash_command: 125 '\n++ last_failed_exit_code=125\n++ last_failed_bash_command='$apt_get_update_wrapper_source_path_full ${APTGETOPT[@]} -o Dir::Etc::sourcelist=\"$whonix_build_sources_list_primary\" -o Dir::Etc::sourceparts=\"-\" update'\n++ '[' '!' '' = '' ']'\n++ true 'INFO: Skipping whonix_build_dispatch_after_retry (--retry-after), because empty, ok.'\n++ '[' 125 = 0 ']'\n++ errorhandlerprocessshared 'NONE_(called_by_errorhandlerretry)'\n++ last_script=././build-steps.d/1120_prepare-build-machine\n++ trap_signal_type_previous=ERR\n++ '[' ERR = '' ']'\n++ trap_signal_type_last='NONE_(called_by_errorhandlerretry)'\n++ whonix_build_error_counter=2\n+++ benchmarktimeend 1595522618\n++++ date +%s\n+++ benchmarktimeend=1595522635\n+++ benchmark_took_seconds=17\n++++ convertsecs 17\n++++ local h m s\n++++ (( h=17/3600 ))\n++++ true\n++++ (( m=(17%3600)/60 ))\n++++ true\n++++ (( s=17%60 ))\n++++ printf '%02d:%02d:%02d\\n' 0 0 17\n+++ echo 00:00:17\n++ benchmark_took_time=00:00:17\n++ local first\n++ read -r first _\n++ processbacktracefunction\n++ true 'INFO: BEGIN: processbacktracefunction'\n++ '[' -o xtrace ']'\n++ set +x\n++ true 'INFO: END  : processbacktracefunction'\n++ functiontracefunction\n++ true 'INFO: BEGIN: functiontracefunction'\n++ '[' -o xtrace ']'\n++ set +x\n++ true 'INFO: END  : functiontracefunction'\n++ output_cmd_set\n++ '[' -o xtrace ']'\n++ output_cmd=true\n++ true '\n############################################################\nERROR in ././build-steps.d/1120_prepare-build-machine detected!\n\ndist_build_version: 15.0.1.3.9\nwhonix_build_error_counter: 2\nbenchmark: 00:00:17\nlast_failed_exit_code: 125\ntrap_signal_type_previous: ERR\ntrap_signal_type_last    : NONE_(called_by_errorhandlerretry)\n\nprocess_backtrace_result:\n1: : init\n2: : /usr/bin/mate-terminal -x /bin/sh -c '\\''/home/candra/Desktop/dns.sh'\\'' \n3: : bash \n4: : sudo /home/candra/Whonix/whonix_build --flavor whonix-gateway-xfce --target qcow2 --repo true --build \n5: : /bin/bash /home/candra/Whonix/whonix_build --flavor whonix-gateway-xfce --target qcow2 --repo true --build \n6: : /bin/bash ././build-steps.d/1120_prepare-build-machine \n\nfunction_trace_result:\nmain (line number: 245)\nmain (line number: 242)\nbuild_machine_setup (line number: 85)\nerrorhandlergeneral (line number: 367)\nerrorhandlerprocessshared (line number: 251)\nerrorhandlerretry (line number: 178)\nerrorhandlerprocessshared (line number: 196)\nerrorhandlerprocessshared (line number: 196)\nerrorhandlergeneral (line number: 367)\nbuild_machine_setup (line number: 85)\nmain (line number: 242)\nmain (line number: 245)\n\n\nlast_failed_bash_command: $apt_get_update_wrapper_source_path_full ${APTGETOPT[@]} -o Dir::Etc::sourcelist=\"$whonix_build_sources_list_primary\" -o Dir::Etc::sourceparts=\"-\" update\n############################################################\n'\n++ unset error_reason\n++ '[' 'NONE_(called_by_errorhandlerretry)' = INT ']'\n++ '[' 'NONE_(called_by_errorhandlerretry)' = TERM ']'\n++ '[' 'NONE_(called_by_errorhandlerretry)' = ERR ']'\n++ '[' 'NONE_(called_by_errorhandlerretry)' = 'NONE_(called_by_errorhandlerretry)' ']'\n++ '[' '!' 1 = 0 ']'\n++ '[' 2 = '' ']'\n++ '[' -n 1 ']'\n++ '[' -n 5 ']'\n++ '[' '$apt_get_update_wrapper_source_path_full' = error_ ']'\n++ '[' 2 -gt 1 ']'\n++ true 'INFO: Auto retried (--retry-max) already 1 times. No more auto retry. '\n++ unset whonix_build_auto_retry_counter\n++ true\n++ ignore_error=false\n++ answer=\n++ '[' 'NONE_(called_by_errorhandlerretry)' = ERR ']'\n++ '[' 'NONE_(called_by_errorhandlerretry)' = 'NONE_(called_by_errorhandlerretry)' ']'\n++ '[' '' = true ']'\n++ '[' -t 0 ']'\n++ true 'INFO: stdin connected to terminal, using interactive error handler.'\n++ true 'ERROR in ././build-steps.d/1120_prepare-build-machine detected!\n\nPlease have a look above (the block within ###...).\n\n - Please enter c and press enter to ignore the error and continue building. (Recommended against!)\n - Please press r and enter to retry.\n - Please press s and enter to open an chroot interactive shell.\n - Please press a and enter to abort.'\n++ read -p 'Answer? ' answer\nAnswer? \n","comments":[{"author":"Patrick","date_created":1595524137,"date_modified":1595524137,"content":"Building on anything other than Debian buster is unsupported.\n\nhttps://www.whonix.org/wiki/Unsupported"}]},"PHID-TASK-spmw3fd424lxblyvwtnd":{"id":"998","title":"Whonix without systemD","status":"wontfix","priority":"Wishlist","author":"sanyo","description":"Hello,\n\nPlease let me know, may be a manual exists about how to switch Whonix to [[ http://dev1galaxy.org/viewtopic.php?pid=23251#p23251 | Devuan base ]] and still keep all or most security enhancements of the Whonix project and [[ https://dev1galaxy.org/viewtopic.php?id=1637 | eliminate systemD ]] from it at the same time?\n\nIt has so many security features I am missing including hardened kernel, but unfortunately it uses systemD which is a very serious unacceptable flaw.\n\nMay be just installing a few packages mentioned on:\nhttps://web.archive.org/web/20200705173024/https://www.whonix.org/wiki/Whonix_Packages_for_Debian_Hosts\ncan do the thing? Though I am not sure about the hardened kernel from Whonix, is there an easy method to borrow its kernel with all its hacks and tunes to Devuan?","comments":[{"author":"Patrick","date_created":1594029679,"date_modified":1594029679,"content":"There's no manual.\n\nToo much work. For an idea how much see:\n\nhttps://forums.whonix.org/t/porting-whonix-to-void-linux/9369\n\nAlso discussion on systemd:\nhttps://forums.whonix.org/t/fixing-the-desktop-linux-security-model/9172\n\nRelated, discussion on which operating system Whonix is based on:\nhttps://www.whonix.org/wiki/Dev/Operating_System\n\n----\n\nhardened-kernel\n\n* Linux doesn't have any dependencies on systemd and we won't introduce superfluous dependencies either.\n* I don't see why it wouldn't work on any other Debian based Linux distributions.\n* Wouldn't even know what would be reducing comparability with any other non-Debian based Linux distributions.\n* For status of hardened-kernel see: https://www.whonix.org/wiki/Hardened-kernel\n* Anyone welcome to contribute/port.\n\n---\n\neasy: Not easy for me.\n"},{"author":"sanyo","date_created":1594059998,"date_modified":1594059998,"content":"I guess it shall not be any harder to port Whonix to Devuan than porting it to original Debian.\n\nAnd I need only console mode for services and daemons like anonymization router, chat, etc.\n\nNo any need for a desktop. X11. etc."},{"author":"sanyo","date_created":1594060140,"date_modified":1594061073,"content":"May I know, what do you think about Whonix vs OpenBSD in terms of security for a headless server without any GUI?\n\nAnd why there are no any public leaks of more recent releases from grsecurity? Would not it be legal provided the kernel is GPLed?\n\nCould not someone create a website like:\nhttps://wpcrack.in/join-the-club-now/\n\nIt is the same idea, since Wordpress is GPLed, most its addons are GPLed too and it is legal to redistribute them for a cheaper price.\n\nSince grsecurity is less popular than Wordpress they could set a price tag like $100-200 USD per year just to support expenses to find a new nominal LLC to purchase further updates to always a new company each time after earlier used company is banned by grsecurity,  say once per 1-3 years. They could make a lag of releasing updates like a year behind of the grsec mainline, so the ban would occur only after subscription is already exhausted. It would be like a group buy campaigns."},{"author":"Patrick","date_created":1594115635,"date_modified":1594115635,"content":">>! In T998#20144, @sanyo wrote:\n> May I know, what do you think about Whonix vs OpenBSD in terms of security for a headless server without any GUI?\n\nmentioned here:\nhttps://www.whonix.org/wiki/Dev/Operating_System\n\n> And why there are no any public leaks of more recent releases from grsecurity? Would not it be legal provided the kernel is GPLed?\n\noff-topic\n"},{"author":"sanyo","date_created":1594145155,"date_modified":1594145217,"content":"Btw, Devuan is almost the same Debian with systemD removed from it.\nDevuan even uses the same Debian binary repository with a few substitutions/replacements by its own Devuan packages  just to eliminate nasty systemD."},{"author":"sanyo","date_created":1594153426,"date_modified":1594153426,"content":"A few more questions:\n\n1) Does systemD track user at least by his personal machine GUID ?\n\n2) Can systemD be operated by invisible virtualization bootkits, trojans and hardware backdoors in negative rings of the CPU just to phone home via many programs nailed hardly to systemD ?\n\nDo you still think after that systemD  allows to make an anonymization distribution?"},{"author":"sanyo","date_created":1598187376,"date_modified":1598187484,"content":"It is important to understand, that systemD is actually much more than simply an init system:\n\n\n\n> systemD is only named \"init system\" just for marketing purposes to hide true (in)security hell promoted by it, IMHO actually systemD is much more like a second kernel running in parallel with general kernel and providing many new unified API for easy phoning home, remote control of many desktop program's data, etc.\n> \n> More details are described here\n> \n> Many spare/odd (if they would be without systemd) software processes are running, not desired ports listening, main kernel options silently changed without permission, may be something else unpredictable, it is like a living on a volcano.\n> \n> If systemD would be just another init system, it would not take years from Devuan to throw it out of the distribution and replace with another true init system like OpenRC or any other like it.\n\n\n\nhttp://dev1galaxy.org/viewtopic.php?pid=21594#p21594"}]},"PHID-TASK-vf2s6pt5legplxcqh4qs":{"id":"997","title":"All pluggable transports stopped working after 11-06-2020 ","status":"invalid","priority":"Normal","author":"leh6r0","description":"https://forums.whonix.org/t/did-pluggable-transports-stop-working-for-you/9831\n\n(Setup: Qubes 4 + Whonix)\n\nI followed the Whonix wiki's snowflake in setting up Snowflake:\n\nhttps://www.whonix.org/wiki/Bridges#Snowflake\n\nIt was always working before 11-06 and I never had a problem. However after updating snowflake-client and updating Whonix something happened that made stop working. I don't think the problem comes from snowflake-client itself since it works fine with a fresh debian-9 Qubes VM.\n\nLooking at the logs this is where it gets stuck:\n\n\n```\n[NOTICE] New control connection opened.\n[NOTICE] Bootstrapped 2% (conn_done_pt): Connected to pluggable transport\n[NOTICE] Bootstrapped 1% (conn_pt): Connecting to pluggable transport\n[NOTICE] Tor 0.4.2.7 opening log file.\n```\n\nEdit: It seems this is not just snowflake specific, I tried to use some obfs4 bridges and it didn't work!","comments":[{"author":"leh6r0","date_created":1592728446,"date_modified":1592728446,"content":"Don't know if this is indicative of anything but after I add `-log snowflake-client.log -log-to-state-dir` at the end of the `ClientTransportPlugin snowflake` line in `/usr/local/etc/torrc.d/50_user.conf` I obtain the following error:\n\n\n\n\n```\n [WARN] Pluggable Transport process terminated with status code 512 [1 duplicate hidden]\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: URL of signaling broker\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: -url string\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: capacity for number of multiplexed\n   WebRTC peers (default 1)\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: -max int\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: resolve the log file relative to tor's\n   pt state dir\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: -logToStateDir\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: name of log file\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: -log string\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: comma-separated list of ICE servers\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: -ice string\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: front domain\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: -front string\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: Usage of /usr/bin/snowflake-client:\n [WARN] Managed proxy at '/usr/bin/snowflake-client' reported: flag provided but not defined:\n   -log-to-state-dir\n```\n\nSo it seems there might be something that terminates the snowflake-client process."},{"author":"leh6r0","date_created":1592999484,"date_modified":1592999484,"content":"More useful information from my tests: When I setup obfs4 using the `Anon-Connection-Wizard` the previous obfs4 that I used worked fine. Unfortunately I can't setup snowflake from it."},{"author":"Patrick","date_created":1593077386,"date_modified":1593077386,"content":"Thanks for the report.\n\nThis issue tracker is legacy as per:\nhttps://www.whonix.org/wiki/Reporting_Bugs#Issue_Tracker\n\nTherefore closing here and continuing in forums.\n\nhttps://forums.whonix.org/t/did-pluggable-transports-stop-working-for-you/9831"}]},"PHID-TASK-jn5qr2gacnak4mj3cspb":{"id":"996","title":"Readying for Tor Browser 9.5 (June 2)","status":"resolved","priority":"Normal","author":"rustybird","description":"A release candidate for next Tuesday's stable Tor Browser 9.5 has been [[ https://lists.torproject.org/pipermail/tor-qa/2020-May/000977.html | announced on tor-qa ]]. Some excerpts from the changelog:\n\n* Update Tor to 0.4.3.5\n\n* [[ https://trac.torproject.org/projects/tor/ticket/19251 | Bug 19251 ]]: Show improved error pages for onion service errors\n(Depends on tor 0.4.3.x and needs an `ExtendedErrors` flag in torrc for the 9150 Socks ports)\n\n* [[ https://trac.torproject.org/projects/tor/ticket/30237 | Bug 30237 ]]: Control port module improvements for v3 client authentication\n(Might be impossible to make this work with onion-grater while still isolating VMs)\n\nhttps://blog.torproject.org/new-release-tor-browser-95","comments":[{"author":"Patrick","date_created":1591286641,"date_modified":1591286641,"content":"Thanks!\n\n> Update Tor to 0.4.3.5\n\nDone\n\n>    Bug 19251: Show improved error pages for onion service errors\n\n`SocksPort` option `ExtendedErrors`\n\nThis is now implemented:\n\nhttps://gitlab.com/whonix/anon-gw-anonymizer-config/-/commit/d7f2e13ad0a2ca1e4a73ca3baa86c5069546b754\n\n>    Bug 30237: Control port module improvements for v3 client authentication\n\n`onion_client_auth_add`\n\nNow implemented too.\n\nhttps://gitlab.com/whonix/anon-gw-anonymizer-config/-/commit/97ff68a6c49ecef3e79ab10e1a930a4f5e13198d\n\n( https://www.whonix.org/wiki/Dev/Control_Port_Filter_Proxy )\n\n----\n\nThis is now in Whonix developers repository."},{"author":"rustybird","date_created":1591288715,"date_modified":1591288715,"content":"https://github.com/adrelanos/anon-gw-anonymizer-config/commit/97ff68a6c49ecef3e79ab10e1a930a4f5e13198d#commitcomment-39671373"},{"author":"Patrick","date_created":1591289372,"date_modified":1591289372,"content":">>! In T996#20096, @rustybird wrote:\n> https://github.com/adrelanos/anon-gw-anonymizer-config/commit/97ff68a6c49ecef3e79ab10e1a930a4f5e13198d#commitcomment-39671373\n\n> Should this really be whitelisted by default? If you log into an onion service with Tor Browser on a particular VM, you're now suddenly logged into it on all other VMs too!\n\nGood point!\n\nWill undo, comment this out now.\n\n//cc @HulaHoop "},{"author":"Patrick","date_created":1591289465,"date_modified":1591289465,"content":"Maybe this is bound per connection similar to ephemeral Tor onion services? In that case, other VMs couldn't re-use it."},{"author":"rustybird","date_created":1591292334,"date_modified":1591292334,"content":"> Maybe this is bound per connection similar to ephemeral Tor onion services?\n\nI'm not familiar with how connections are bound for ephemeral services, but no - you can definitely login across VMs."},{"author":"Patrick","date_created":1591383162,"date_modified":1591383162,"content":"* https://gitlab.com/whonix/onion-grater/-/commit/fb651a3297712627ef8b0ba7ea279b835bf38542\n* https://gitlab.com/whonix/anon-gw-anonymizer-config/-/commit/0624ad6c714b5254c72bc1eaae30406ebcf37e48\n\n[onion_client_auth_add Flags=Permanent fails with 553 Unable to store creds for](https://lists.torproject.org/pipermail/tor-dev/2020-June/014348.html)\n\n----\n\n    onion-grater-add onion_authentication\n\n----\n\n    onion-grater-remove onion_authentication\n\n----\n\n...but that is incomplete.\n\nonion_client_auth_add part is \"contributor required\".\n\nMaking that work would require extensive modifications. Started here but unlikely to finish anytime soon:\nhttps://www.whonix.org/wiki/Dev/Control_Port_Filter_Proxy#onion_client_auth_add\n\nTor Browser currently gets confused by onion-grater. When providing the onion service authentication key, Tor Browser does not even ask Tor ControlPort. (Does not show up in onion-grater.) It works with onion-grater `--complain` (pasthrough without filtering) mode.\n\nWe'd need to make [Tor Circuit View](https://www.whonix.org/wiki/Tor_Browser/Advanced_Users#Tor_Circuit_View) visible inside Whonix-Workstation but filter the actual relay fingerprints / IPs. All Tor Browser control protocol commands should be processed but relayed back to the workstation redacted.\n\nRequires RegEx knowledge which isn't a strong skill of mine.\n\nRegEx contributor required:\n\nhttps://www.whonix.org/wiki/Contribute#Regular_Expression_RegEx\n"},{"author":"HulaHoop","date_created":1592503438,"date_modified":1592503438,"content":"What Tor related apps are broken without support for this?"},{"author":"Patrick","date_created":1592556479,"date_modified":1592556479,"content":"Tor Browser onion authentication prompt:\nhttps://blog.torproject.org/sites/default/files/inline-images/onion-auth%402x.png\n\nPerhaps ricochet, not that it matters currently."},{"author":"Patrick","date_created":1595503625,"date_modified":1595503625,"content":"https://lists.torproject.org/pipermail/tor-dev/2020-June/014353.html\n\n>> 553 Unable to store creds for\n> \n> Did you set ClientOnionAuthDir in torrc (to a directory with \"private\n> enough\" permissions)?\n> \n> Rusty\n\nhttps://github.com/Whonix/anon-gw-anonymizer-config/commit/47cf0e376ab4af6a2b9f2165b6e449c2176a3afd\n"}]},"PHID-TASK-txv6piq7ae2l4goik6c3":{"id":"995","title":"Dino IM","status":"invalid","priority":"Normal","author":"HulaHoop","description":"A recent [[ https://forums.whonix.org/t/dino-im-messenger/7773/21 | report ]]  on the forum indicates that Dino IM's bugs were fixed at last in Debian Backports and it is now functional. A default install won;t happen before Debian Bullseye at the earliest since we don't carry backports.\n\n* Consider if worth documenting in the mean time\n* File report about OMEMO incompatibility upstream \n* See what needs to be done to support isolated streams","comments":[{"author":"HulaHoop","date_created":1589817940,"date_modified":1589817940,"content":"Moved ticket to forum"}]},"PHID-TASK-eynuz74y3dkbgyjg5fgv":{"id":"994","title":"Briar Desktop","status":"invalid","priority":"Needs Triage","author":"HulaHoop","description":"This ticket tracks progress of upstream solving the Tor over Tor issue and/or supporting a Tor instance running on Whonix GW.\n\nAlso tracks packaging request in Debian.","comments":[{"author":"HulaHoop","date_created":1589818052,"date_modified":1589818052,"content":"Ticket moved to forum"}]},"PHID-TASK-gf3ozf5u5lrqaajd6i7m":{"id":"993","title":"improve Windows Hosts / macOS wiki mentions","status":"resolved","priority":"Normal","author":"Patrick","description":"* https://www.whonix.org/wiki/Windows_Hosts and\n* https://www.whonix.org/wiki/Host_Operating_System_Selection\n* https://www.whonix.org/wiki/Template:Windows_Hosts\n\nNeed to be reviewed according to feedback in\n\n~~forums.whonix.org/t/long-wiki-edits-thread/3477/1793~~\n\nhttps://forums.whonix.org/t/host-operating-system-selection-wiki-page-discussion/11303\n\nby @madaidan .\n\nPotential reviewers / implementers for this ticket: @HulaHoop / @Patrick.\n\nHelp welcome.","comments":[{"author":"madaidan","date_created":1590695201,"date_modified":1590695201,"content":"More points that should be removed:\n\n> Windows 10 spyware which tracks text input and unique typing cadence (pattern) [archive] is comparable to a corporate keylogger.\n\nThe source linked in the article does not say that.\n\nhttps://support.microsoft.com/en-us/help/4468250/windows-10-speech-voice-activation-inking-typing-privacy\n\nThe most it says is:\n\n\"As part of inking and typing on your device, Windows collects unique words—like names you write—in a personal dictionary stored locally on your device, which helps you type and ink more accurately.\"\n\nThe keyword is \"locally\". Microsoft gets no information from this.\n\n> When you use the Microsoft cloud-based speech recognition service, Microsoft collects and uses your voice recordings to create a text transcription of the spoken words in the voice data.\n\nObviously. That's the point of it being **cloud-based** and it isn't an issue. If you don't want to use the cloud then read literally the next paragraph:\n\n\"You can use device-based speech recognition without sending your voice data to Microsoft.\""},{"author":"Patrick","date_created":1590759246,"date_modified":1590759246,"content":"The The news report [1] link is nowadays broken. It redirects to another page.\n\nThe news report [1] used a correct citation at that time. Early versions of the cited/linked source link said exactly that. [2] And it's not out of context either.\n\n[1] https://www.pcworld.com/article/2974057/how-to-turn-off-windows-10s-keylogger-yes-it-still-has-one.html\n[2] https://web.archive.org/web/20150801001352/http://windows.microsoft.com/en-us/windows-10/speech-inking-typing-privacy-faq\n\nEdited to clarify: https://www.whonix.org/w/index.php?title=Template%3AWindows_Hosts&type=revision&diff=57500&oldid=56988\n\n> Obviously. That's the point of it being cloud-based and it isn't an issue. \n\nMany non-technical users won't understand the implications of \"cloud-based\", what that really means. Implications needs to be translated to simpler English. Edited to add.\n\n> \"You can use device-based speech recognition without sending your voice data to Microsoft.\"\n\nThis being a non-default is the problem. Also edited to add:\nhttps://www.whonix.org/w/index.php?title=Template%3AWindows_Hosts&type=revision&diff=57501&oldid=57500\n"},{"author":"Patrick","date_created":1616325621,"date_modified":1616325621,"content":"I don't see what else can be done here. This statement is limited to only what was said in this ticket.\n\nIssue tracker was moved meanwhile to forums as per:\nhttps://www.whonix.org/wiki/Reporting_Bugs#Issue_Tracker\n\nI am not calling the whole task done.\n\nSplit discussion into its own forum discussion.\n\nhttps://forums.whonix.org/t/host-operating-system-selection-wiki-page-discussion/11303\n\nWill continue there.\n\n> Patrick closed this task as Resolved.\n\nIt's only really closed once the forum topic says it is. Just doing this since this issue tracker phabricator is being phased out at Whonix project.\n"},{"author":"Patrick","date_created":1616325647,"date_modified":1616325647,"content":">>! In T993#20220, @Patrick wrote:\n> I don't see what else can be done here. This statement is limited to only what was said in this ticket.\n\nIf not... Quote and bring up here:\n\n> https://forums.whonix.org/t/host-operating-system-selection-wiki-page-discussion/11303\n"}]},"PHID-TASK-5a6mr6qzd72xgvojbqco":{"id":"992","title":"Make SDW-Date widget in Qubes invokable by single-click","status":"resolved","priority":"Wishlist","author":"ninavizz","description":"**Problem:** Currently in Qubes, the sdw-date widget needs to be right-clicked upon, for the menu to open. The preferred pattern would be for it to only require a single-click. \n\nOne usability problem, is simple discovery. I am on a project working to migrate journalists to Qubes, and a majority of the Global North's journalists are currently Mac users. Mac users don't have right-click. A secondary problem, is that when right-clicking to invoke the menu, it's not intuitive (again, for native Mac users) how to close the menu—and so inadvertently Exiting the Whonix VM, is the only obvious option. \n\n**Solution:** Single click, not right-click, from the Tray menu widget? :)\n\n**Note** this is a sub-task within T963","comments":[{"author":"ninavizz","date_created":1589655583,"date_modified":1589655583,"content":"@marmarek Is this a Qubes or Whonix thing?"},{"author":"marmarek","date_created":1589668045,"date_modified":1589668045,"content":"Whonix. I'll ask @marmarta if she can help here."},{"author":"Patrick","date_created":1589890572,"date_modified":1589890572,"content":"Merged: https://github.com/Whonix/sdwdate-gui/pull/2\n\nAnd added on top: https://github.com/Whonix/sdwdate-gui/commit/360f52e6cd9fa411b0cb7c9b50a3f3cbb7016b7d\n\nThis is now in buster-developers repository."}]},"PHID-TASK-5bbpqggqpcl7lj5fhorq":{"id":"991","title":"Update sdwdate-gui widget tray icons","status":"resolved","priority":"Wishlist","author":"ninavizz","description":"Sub-task w/in T963\n---\n\nThe `sdw-date` iconography that surfaces in the Qubes tray, is not intuitive to users unfamiliar with the technical details of Whonix. \n\nA majority of Qubes users will simply want to know if Whonix is or is not connected securely: yes or no. The clock semiotic only speaks to users who understand the concepts of time-sync. This imposes a cognitive burden on all non-technical Qubes users, and users new to both Qubes and operating a computer in a high opsec environment. \n\nThe tray icons today are also difficult to visually decipher, at the small size they are. The icons attached to this issue, are both 32x32; they should adequately replace the icons that are today 32x32 and 32x26. Note on the latter—it had displayed as \"broken\" until Marta with Qubes filed a bugfix. I suspect some of what contributed to the problem was that the PNG was not perfectly square. The new ones, I ensured are. They are also both transparent, as to not load with big white blocks behind them.\n\nThis issue is a duplicate of [[ https://github.com/QubesOS/qubes-issues/issues/5813 | an issue I created in the Qubes Issues repo on GitHub. ]] \n\nI also suspect the majority of the \"work\" with implementing this, will be in change-management with regards to updating screenshots on both the Whonix and Qubes websites, and possibly documentation texts. I would love to take the implementation of this on, myself, but am not a developer and also have a very full plate with other user research and design work. {F12298694}\n\n{F12298693}","comments":[{"author":"Patrick","date_created":1589377029,"date_modified":1589377029,"content":"Thanks! The new sdwdate-gui icons were committed to sdwdate-gui git master just now.\n\nhttps://github.com/Whonix/sdwdate-gui/commit/0471ff0d93f337fe83c29705c7ac8618e3b122c6"},{"author":"ninavizz","date_created":1589390381,"date_modified":1589390381,"content":"@Patrick Wow, you are FAST!! <3 Thank you! \n\nI did comment on the GitHub commit, with a \"Waiting\" icon (that Marta from Qubes pinged me on neglecting to include), and a grayscale \"Stopped\" icon—which will color better in the Qubes Tray UI. If those could make it into the commit, that would be superb. \n\nAt FPF, our trainers have a slide deck they use to train users on how to do allthings Qubes—and they will need to update their screenshots to reflect the new icons. Any idea when your commit will go out in a nightly?\n\nAgain, many thanks. :)"},{"author":"Patrick","date_created":1589457710,"date_modified":1589457710,"content":"ninavizz (nina eleanor alter):\n> ninavizz added a comment.\n> \n> \n>   @Patrick Wow, you are FAST!! <3 Thank you!\n>   \n>   I did comment on the GitHub commit, with a \"Waiting\" icon (that Marta from Qubes pinged me on neglecting to include), and a grayscale \"Stopped\" icon—which will color better in the Qubes Tray UI. If those could make it into the commit, that would be superb.\n\n\nhttps://github.com/Whonix/sdwdate-gui/commit/0471ff0d93f337fe83c29705c7ac8618e3b122c6\n\n>   Any idea when your commit will go out in a nightly?\n\n\nAvailable from Whonix developers repository now. I.e. by upgrading from\ndevelopers repository this change would be included.\n\nhttps://www.whonix.org/wiki/Project-APT-Repository\n\nNot sure that counts as nightly."},{"author":"ninavizz","date_created":1589930142,"date_modified":1589932054,"content":"@marmarek When do things ship in Qubes updates, from the Whonix dev repo (per Patrick's comment above)? Sorry, trying to coordinate with our training and documentation peeps for the Workstation—not \"eager\" just needing to manage other ppl's expectations.\n\nMany thanks to you both (and Marta!) for the speedy response. <3"},{"author":"marmarek","date_created":1589975683,"date_modified":1589975683,"content":"That is a question to @Patrick , he is managing Whonix repositories."},{"author":"Patrick","date_created":1590146299,"date_modified":1590146299,"content":"There's no ETA."}]},"PHID-TASK-tvxkao4tftxc2b65sm73":{"id":"990","title":"whonixcheck tirdad module load","status":"open","priority":"Normal","author":"Patrick","description":"Non-Qubes-Whonix only.\n\n(Qubes-Whonix: https://forums.whonix.org/t/qubes-whonix-security-disadvantages-help-wanted/8581)","comments":[]},"PHID-TASK-tey3elufqlzywfw7ya27":{"id":"989","title":"whonixcheck check systemd journal unit","status":"open","priority":"Normal","author":"Patrick","description":"This can happen when LKRG kills systemd units which then causes lot of issues.\n\n● systemd-journald-audit.socket   loaded failed failed Journal Audit Socket\n● systemd-journald-dev-log.socket loaded failed failed Journal Socket (/dev/log)\n● systemd-journald.socket         loaded failed failed Journal Socket","comments":[]},"PHID-TASK-cfoghln4pg5lqfzqho6e":{"id":"988","title":"use linux-perf /perf (performance analysis tools for Linux) and other tools in wats test suite","status":"open","priority":"Normal","author":"Patrick","description":"https://packages.debian.org/buster/linux-perf\nhttps://packages.debian.org/buster/stress\n\n----\n\nContains command line tool `perf`.\n\nDoesn't need to check actual performance but running these tests might trigger any potential future regression in the kernel, virtualizer, etc.\n\nCould use:\n\n    perf test\n    perf bench all\n\nIf exit code is non-zero and system didn't crash that would be considered a good sign. Actual output would not be parsed.\n\n----\n\nAlso - in graphical mode only:\n\n    glxinfo\n\nSame. Only exit code testing. No parsing of results.\n\n---\n\n    netstat -tulpen\n\n----\n\n    stress --cpu 8 --io 4 --vm 2 --vm-bytes 128M --timeout 10s\n","comments":[]},"PHID-TASK-xum5es6ihkhfq4bk5fft":{"id":"987","title":"offer rsync over SSH or TLS for download.whonix.org","status":"resolved","priority":"Normal","author":"Patrick","description":"1) rsync over SSH with a restricted shell:\n\nhttps://www.guyrutenberg.com/2014/01/14/restricting-ssh-access-to-rsync/\n\n2) rsync over TLS: Check out the \"rsync over TLS\" section on https://dotsrc.org/mirrors/\n\n> rsync does by itself not support TLS, but we can simply outsource TLS handling to the openssl s_client. The rsync authors have made a short script to do exactly that. This is how you use it to get a listing from our server:\n> \n> wget https://download.samba.org/pub/rsync/openssl-rsync\n> chmod +x openssl-rsync\n> rsync --rsh=./openssl-rsync rsync://mirrors.dotsrc.org \n\nYou'll need to configure e.g. apache/nginx to act as a proxy.\n\nThis is how mirrors.dotsrc.org nginx is configured:\n\n```\nstream {\n    server {\n        listen        874 ssl;\n        listen        [::]:874 ssl;\n\n        # generated 2020-01-20, https://ssl-config.mozilla.org/#server=nginx&server-version=1.14.0&config=intermediate&openssl-version=1.1.1&hsts=false&ocsp=false\n\n        # certs sent to the client in SERVER HELLO are concatenated in ssl_certificate\n        ssl_certificate /etc/letsencrypt/live/mirrors.dotsrc.org/fullchain.pem;\n        ssl_certificate_key /etc/letsencrypt/live/mirrors.dotsrc.org/privkey.pem;\n        ssl_session_timeout 5m;\n        ssl_session_cache none;\n        ssl_session_tickets off;\n\n        # Diffie-Hellman parameter for DHE ciphersuites, recommended 2048 bits\n        ssl_dhparam /etc/ssl/certs/dhparam.pem;\n\n        # intermediate configuration\n        ssl_protocols TLSv1.2 TLSv1.3;\n        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;\n        ssl_prefer_server_ciphers off;\n\n        # Documentation: http://nginx.org/en/docs/stream/ngx_stream_proxy_module.html\n        # Proxy to rsync\n        proxy_pass    localhost:873;\n\n        # \"Sets the timeout between two successive read or write operationson client or proxied server connections.\n        # If no data is transmitted within this time, the connection isclosed.\"\n        # If a client asks for the entire directory listing to be sent inone go, I think it will take some time.\n        proxy_timeout 10m;\n\n        # \"Defines a timeout for establishing a connection with a proxiedserver.\"\n        # If rsyncd does not respond within 5 sec, close the connection.\n        proxy_connect_timeout 5s;\n    }\n}\n```\n\nWhen done, ask https://dotsrc.org to mirror over SSH or TLS.","comments":[{"author":"Patrick","date_created":1639061167,"date_modified":1639061167,"content":"rsync over TLS or even onion is implemented for a long time already and documented here:\nhttps://www.whonix.org/wiki/Hosting_a_Mirror"}]},"PHID-TASK-uc2adxj2x3z33iborvp7":{"id":"986","title":"Whonix-Host livecheck systray broken","status":"resolved","priority":"Normal","author":"Patrick","description":"> the genmon livecheck panel seems broken (always show Live Mode even when in persistent mode).\n\nhttp://forums.whonix.org/t/whonix-host-operating-system/3931/246","comments":[{"author":"Patrick","date_created":1587486330,"date_modified":1587486330,"content":"Likely fixed in next build already. Updated, relevant code is here:\n\nhttps://github.com/Whonix/whonix-xfce-desktop-config/blob/master/usr/share/livecheck/livecheck.sh\n\nRunning could script manually should show the output and then one can imagine how the systray would look like."},{"author":"Patrick","date_created":1587670559,"date_modified":1587670559,"content":"Fixed in `15.0.1.3.2-developers-only`."}]},"PHID-TASK-xyqvk2xiqti6qgj2uzrr":{"id":"985","title":"consider post Whonix News that recommends VirtualBox users reducing number of virtual CPUs to 3","status":"wontfix","priority":"Normal","author":"Patrick","description":"Let's see if https://www.virtualbox.org/ticket/19500 get confirmed and act accordingly.","comments":[]},"PHID-TASK-azk7v6up5azo6ptf4e7b":{"id":"984","title":"convert /etc/sysctl.d to /etc/default/grub.d kernel Linux boot cmdline","status":"invalid","priority":"Normal","author":"Patrick","description":"Maybe from Linux 5.7+ [sysctls can be set from Linux boot cmdline](https://forums.whonix.org/t/sysctls-can-now-be-set-from-linux-boot-cmdline/9221).","comments":[{"author":"madaidan","date_created":1587058303,"date_modified":1587058303,"content":"We shouldn't stop using `/etc/sysctl.d` for compatibility. I think the best way would be to create `/etc/default/grub.d/40_sysctl.cfg` with:\n\n```\nwhile read -r line; do\n  if [ \"$line\" = \"\" ]; then\n    continue\n  fi\n  if [[ \"$line\" =~ ^# ]]; then\n    continue\n  fi\n  GRUB_CMDLINE_LINUX=\"$GRUB_CMDLINE_LINUX sysctl.${line}\"\ndone < /etc/sysctl.d/30_security-misc.conf\n```"},{"author":"Patrick","date_created":1587070070,"date_modified":1587070070,"content":"Something like that. Maybe covering all of /etc/sysctl.conf and\n/etc/sysctl.d folder to GRUB_CMDLINE_LINUX expansion."},{"author":"Patrick","date_created":1639565403,"date_modified":1639565403,"content":"Is this still reuqired since we also have early sysctl loading during initramfs?\n\nhttps://github.com/Whonix/security-misc/blob/master/etc/initramfs-tools/scripts/init-bottom/sysctl-initramfs\n"},{"author":"Patrick","date_created":1674125291,"date_modified":1674125291,"content":"And we also port to dracut which also does early sysctl loading.\nAdding tons of sysctl to an already very long kernel command line (do we got the world record already :) seems excessive.\nSince nobody is making the argument anymore, rejecting this ticket."}]},"PHID-TASK-3og56njzhtwm2uj2tbeo":{"id":"983","title":"connect to public Tor network by default","status":"open","priority":"Normal","author":"Patrick","description":"ACW = [anon-connection-wizard](https://www.whonix.org/wiki/Anon_Connection_Wizard)\n\nIssue:\nOnce there is #whonix-host there would be two ACW popups. Once on Whonix-Host to configure Tor on the host and yet another one, fully independent in Whonix-Gateway doing the same.\n\nReasoning:\n\n[Quote](https://trac.torproject.org/projects/tor/ticket/10610#comment:7) `lunar`:\n\n> My reasoning is that users who need to bridges or configure a proxy are likely to know. Or if they don't know, they will know by trying to a direct connection and see it fails.\n\nThis is consistent with research [Tor's Usability for Censorship Circumvention](https://digitalassets.lib.berkeley.edu/techreports/ucb/text/EECS-2016-58.pdf).\n\n----\n\nFor users who don't want to connect to Tor public network the advice by Whonix documentation will be:\n\n* don't enter WiFi password before setting up bridges and/or unplug LAN cable\n* use ACW to disable Tor\n* establish host internet connection\n* test host internet connection\n* start ACW to setup bridges\n","comments":[]},"PHID-TASK-tprvngnjwpnfisk6w76o":{"id":"982","title":"use update-initramfs during installation of Whonix-Host","status":"resolved","priority":"Normal","author":"Patrick","description":"* https://forums.whonix.org/t/whonix-host-operating-system/3931/231\n* https://forums.whonix.org/t/whonix-host-operating-system/3931/243\n* https://github.com/Whonix/live-config-dist/blob/master/usr/lib/x86_64-linux-gnu/calamares/modules/initramfs/main.py.dist\n","comments":[{"author":"onion_knight2","date_created":1587425839,"date_modified":1587425839,"content":"Fixed.\nhttps://forums.whonix.org/t/whonix-host-operating-system/3931/261\n"}]},"PHID-TASK-ec3ltoyt7uz6yb2tpyer":{"id":"981","title":"Whonix-Host Tor configuration and anon-connection-wizard (ACW); ipv6 disable; ipv4 forward disable","status":"open","priority":"Normal","author":"Patrick","description":"Still in development. Unreleased. Not yet implemented.\n\n* #Whonix-Host currently connects to the Tor public network by default.\n* #anon-connection-wizard (ACW) is not yet installed by default on Whonix-Host.\n* sdwdate cannot connect because Tor `SocksPort` 127.0.0.1 9108 is not listening (maybe install #anon-gw-anonymizer-config but disable [/etc/torrc.d/70_workstation.conf](https://github.com/Whonix/anon-gw-anonymizer-config/blob/master/etc/torrc.d/70_workstation.conf)).\n* ipv6 disable (anon-gw-anonymizer-config does that as well)\n* ipv4 forward disable  (anon-gw-anonymizer-config does that as well)","comments":[]},"PHID-TASK-chu652d77ea3cfxdaja4":{"id":"980","title":"Kicksecure handing of /etc/hosts /etc/hostname /etc/machine-id","status":"open","priority":"Normal","author":"Patrick","description":"/etc/hosts\n/etc/machine-id\n/var/lib/dbus/machine-id\n/etc/hostname\n","comments":[]},"PHID-TASK-pu56d33gddb64nasfvt4":{"id":"979","title":"co-install grub-efi-amd64 and grub-pc by default on Whonix-Host ISO","status":"open","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/whonix-host-operating-system/3931/214\n\n----\n\n* [1] Whonix ISO calamares installer shouldn't require networking for simplicity / usability. (No need to enter WiFi password / circumvention.)\n* [2] Whonix ISO Live however should be able to go online.\n\n----\n\nEFI based systems currently require `grub-efi-amd64` which would normally be installed using apt. This violates [1].\n\nInstalling `grub-efi-amd64` and `grub-pc` at the same time is not possible since these have `Conflicts:` (in `/debian/control`) with each other.\n\nBut both `grub-efi-amd64` and `grub-pc` are meta packages. These don't contain the actual grub binaries.\n\nTODO: look at https://salsa.debian.org/grub-team/grub/-/blob/master/debian/control and install the actual grub binary package instead of the meta package(s). Thereby it might be possible to install both by default\n\nAlternatively `grub-efi-amd64` could be cached. (Similar to `sudo apt install grub-efi-amd64 --download-only` during Whonix-Host ISO build process inside chroot.)","comments":[]},"PHID-TASK-cjzhmcinoytq2axyotjg":{"id":"978","title":"add Whonix-Host EFI booting support","status":"open","priority":"Normal","author":"Patrick","description":"* https://forums.whonix.org/t/whonix-host-operating-system/3931/214\n* https://forums.whonix.org/t/whonix-host-operating-system/3931/238","comments":[]},"PHID-TASK-nvs45dpe7dli4wmux7tq":{"id":"977","title":"hardened-kernel outreach","status":"open","priority":"Normal","author":"Patrick","description":"Very few are aware of `linux-hardened` let alone `hardened-kernel`.\n\nhttps://github.com/anthraxx/linux-hardened and hardened kernel config (at least host) should be suggested to openwall kernel-hardening mailing list, other related mailing lists and other Linux distributions too.\n\n* https://lists.debian.org/debian-devel/\n* https://www.openwall.com/lists/kernel-hardening/\n* https://github.com/minipli/linux-unofficial_grsec\n* https://blogs.gentoo.org/ago/2017/08/21/sys-kernel-grsecurity-sources-available/\n* Fedora\n* gentoo\n* arch linux\n* Tails\n* Ubuntu\n* GrapheneOS\n* Qubes mailing list\n* https://www.linuxmint.com\n* https://trisquel.info\n* https://mirage.io (might not be aware of linux-hardened)\n* https://nmap.org/mailman/listinfo/fulldisclosure\n* https://mailman.stanford.edu/mailman/listinfo/liberationtech\n\nMost of them were previously interested in grsecurity but I don't see discussions on  `linux-hardened` let alone `hardened-kernel`.\n\nIdeal outcome: another distribution adopts `hardened-kernel`.\n\nVery good outcome: more awareness for this project and new contributors joining `linux-hardened` and/or `hardened-kernel` project.\n\n----\n\n    site:gentoo.org \"linux-hardened\"\n\n----\n\n    site:fedoraproject.org \"linux-hardened\"\n\n----\n\n    site:mirage.io \"linux-hardened\"\n\n----\n\narchlinux heard about `linux-hardened` but not `hardened-kernel`.\n\nhttps://wiki.archlinux.org/index.php/Security#Kernel_hardening\n\n----\n\nSimilar to previous outreach:\nhttps://www.whonix.org/wiki/Hardened-kernel#Upstreaming","comments":[]},"PHID-TASK-tmtgtbdtik2zjavndczu":{"id":"976","title":"Whonix-Host Low RAM Tests","status":"resolved","priority":"Normal","author":"Patrick","description":"Low or \"low\" if we can 4 GB \"low\" RAM.\n\nIf not a too personal privacy intrusive a question, how much host RAM can you test this with? 4 GB, 8 GB, 16 GB, 32 GB? Less than 4 GB RAM? Does booting into live mode work and are VMs still startable? Multiple VMs?\n\nMight be different\n\n* Whonix-Host ISO Live vs\n* Whonix-Host installed with grub-live mode\n\n?\n\nhttps://forums.whonix.org/t/running-live-host-via-grub-live/8912/4","comments":[{"author":"onion_knight2","date_created":1586475562,"date_modified":1586475562,"content":"All tests done in KVM with 4 logical host CPUs, but I would expect to have similar (if not better) results on real hardware.\n\nVersion used:  `Whonix-Host-XFCE-15.0.1.2.2 `\n\n**Whonix-Host ISO, 2GB**:\n\n- ISO Boots normally\n- gw boots normally\n- Impossible to launch ws with default 2GB (system freeze)\n- Setting 256M to gw and 1024M RAM to ws barely works/freezes\n\nConclusion: not suitable,  unusable, very low performance.\n\n**Whonix-Host Installed in live mode, 2GB**:\n-  more usable than Whonix-Host ISO, with: gw 256M RAM and ws 1024M RAM (much faster, no freeze\n-  performance is however still insufficient to do anything productive\n\nConclusion: not suitable, barely usable\n\n**Whonix-Host ISO, 4GB**:\n- works OK with default settings (gw 512M RAM, ws 2048M RAM)\n\nConclusion: suitable\n\n\n**Whonix-Host Installed in live mode, 4GB**\nSame as above \n\n\nI assume any configuration above that would be good enough.\n\nMy takeaway: Whonix-Host needs at least 4GB to be productive and enjoyable"},{"author":"onion_knight2","date_created":1587425869,"date_modified":1587425869,"content":"Do we need more tests or can we close this ticket?"},{"author":"Patrick","date_created":1587459374,"date_modified":1587459374,"content":"Excellent work. Thanks for researching this!\n\nThis is done. Just needs to be documented. Left notes here:\n\nhttps://www.whonix.org/wiki/Whonix-Host\nhttps://www.whonix.org/wiki/Dev/Whonix-Host\n"}]},"PHID-TASK-3wnki5i74wcf3lvwbc56":{"id":"975","title":"Replace Debian mentions in /etc/motd and /etc/issue ","status":"resolved","priority":"Normal","author":"onion_knight2","description":"For Whonix-Host and Kicksecure, replace references to Debian in /etc/motd and /etc/issue with appropriate Whonix-Host references.\nMay also be relevant for Whonix gw/ws VMs.\nSee https://forums.whonix.org/t/whonix-host-operating-system/3931/203","comments":[{"author":"Patrick","date_created":1585309632,"date_modified":1585309632,"content":"Implemented.\n\nhttps://github.com/Whonix/Whonix/commit/f59f94616188d1c3d3fa69b60ec62cdc2ea6aa19"},{"author":"Patrick","date_created":1585309683,"date_modified":1585309683,"content":"Included since Whonix `15.0.1.0.8-developers-only`."},{"author":"Patrick","date_created":1585397413,"date_modified":1585397413,"content":"https://forums.whonix.org/t/whonix-host-operating-system/3931/213"}]},"PHID-TASK-qala7z422pioxk4ddsdn":{"id":"974","title":"Whonix Images Quick Rebuild","status":"open","priority":"Normal","author":"Patrick","description":"Idea that needs to be thought through.\n\nSane to rebuild the same Whonix version git tag? Just re-build and re-upload?\n\nAdvantages:\n\n* an easy, doable way to create \"fresher\" official Whonix stable downloads\n\nThis would be updated in the rebuild images:\n\n* updated packages from packages.debian.org\n  * this will be automatically the case (since we're not building from snapshot.debian.org)\n* updated Tor from deb.torproject.org\n  * this will be automatically the case\n* updated Tor Browser\n  * user/developer that rebuilds needs to set `tbb_version` which is already supported by package tb-updater\n  * just need to make sure that environment variable is passed from the build script to the update-torbrowser script\n\nThis would not be updated in the rebuild images:\n\n* any [packages by Whonix](https://github.com/Whonix)\n\nThe following things would not be done:\n\n* call for testers\n* write release announcement\n* update version numbers\n\n...which would safe a lot maintenance work.\n\nDisadvantages:\n\n* There would be multiple official ova / iso versions of Whonix stored by different people. Same version number but different hashes and different software versions (packages.debian.org, deb.torproject.org, Tor Browser) but same Whonix software versions.\n* Somewhat nontransparent.\n\nNon-Issues:\n\n* gpg signature verification. Since creation of gpg signatures (and sanity tests) are automated users can always verify gpg signatures.\n* upgrading from deb.whonix.org","comments":[]},"PHID-TASK-2ocdvl3d4iuleksip4bw":{"id":"973","title":"merge duplicate wiki pages?","status":"open","priority":"Normal","author":"Patrick","description":"* https://www.whonix.org/wiki/Host_Security\n* https://www.whonix.org/wiki/General_Host_Security\n\n----\n\n* https://www.whonix.org/wiki/Computer_Security_Introduction\n* https://www.whonix.org/wiki/Basic_Security_Guide_Introduction\n\n----\n\nMaybe not merge but better interlinks required?\n\n* https://www.whonix.org/wiki/Support\n* https://www.whonix.org/wiki/Reporting_Bugs\n* https://www.whonix.org/wiki/Reporting_Bugs#Support_Request_Policy\n* https://www.whonix.org/wiki/Known_Issues\n* https://www.whonix.org/wiki/Troubleshooting\n* https://www.whonix.org/wiki/VirtualBox/Troubleshooting\n\n----\n\nMaybe not merge but better interlinks required?\n\n* https://www.whonix.org/wiki/Policy_of_Website_and_Chat\n* https://www.whonix.org/wiki/Wiki_Comments_Policy\n* https://www.whonix.org/wiki/Forum_Best_Practices\n* https://www.whonix.org/wiki/Limitations_on_Free_Speech_on_Whonix_Website\n","comments":[]},"PHID-TASK-ahuwqcdm6qckxyqysawk":{"id":"972","title":"Integrate Vagrant with Jenkins for Testing CI Pipeline","status":"wontfix","priority":"Normal","author":"mycobee","description":"## Description:\n\nAs a Jenkins CI server, I use the Vagrant plugin to build a Whonix VM to run a testing suite inside of it. \n\n### Notes: \n\nIn progress, libvirt is a pain in the ass for this, might be tabling due to higher priority issues ","comments":[{"author":"mycobee","date_created":1702253372,"date_modified":1702253372,"content":"overengineered dumb idea. Current CI is better"}]},"PHID-TASK-dsgfiz3se3hes5ezlbv2":{"id":"971","title":"Onion Feature Test","status":"open","priority":"Normal","author":"mycobee","description":"## Feature Test:\n\nAs a logged in user on a Whonix system:\n\n- I start the Tor Browser\n- I visit duckduckgo\n- I expect my response to equal 200\n- I close tor browser\n- I expect an exit code of 0\n\n\n### Notes: \n\nThis is a point and click test that can be executed with Dogtail","comments":[{"author":"mycobee","date_created":1584663561,"date_modified":1584663561,"content":"Please contact me with any questions about this ticket"}]},"PHID-TASK-zktqvqz54py7h6suzkm4":{"id":"970","title":"Whonix-Host hash, gpg, signify, torrent, signature creation script","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/whonix-developer-meta-files/blob/master/release/prepare_release needs support for `WHONIX_BUILD_TYPE` `whonix-host`.\n","comments":[{"author":"Patrick","date_created":1587670661,"date_modified":1587670661,"content":"Works fine in `15.0.1.3.2-developers-only`."}]},"PHID-TASK-k4nwow2lcmfyge4ddymz":{"id":"969","title":"instructions how to burn Whonix-Host ISO image to DVD or USB","status":"open","priority":"Normal","author":"Patrick","description":"Once we have a #whonix-host ISO, we need #user_documentation on how to write it to DVD or USB for major operating systems such as Windows, Linux, macOS.\n\nAfter that users should be able to boot the iso and use Whonix-Host Live Mode and/or to start Whonix-Host Installer (calamares).\n\nInstalling Whonix-Host without installer (calamares) is out of scope in this ticket since discussed in seaprate ticket T909.\n\nOther Open Source Linux distributions might have this documented already while using a Libre documentation license. In that case we could adapt the documentation and wouldn't need to re-invent it from scratch.","comments":[{"author":"onion_knight2","date_created":1584306461,"date_modified":1584306461,"content":"I could help with this task once it's ready (soon hopefully)."},{"author":"onion_knight2","date_created":1584391886,"date_modified":1584391886,"content":"Where do you want me to write the documentation? In the Whonix wiki?"},{"author":"Patrick","date_created":1584435687,"date_modified":1584435687,"content":"Not sure. For now just https://www.whonix.org/wiki/Whonix-Host to get started.\n\nAnd then move contents around later.\n\nhttps://www.whonix.org/wiki/Whonix-Host\nhttps://www.whonix.org/wiki/Whonix-Host/MacOS\nhttps://www.whonix.org/wiki/Whonix-Host/Windows\nhttps://www.whonix.org/wiki/Whonix-Host/Linux\n\nI.e. Operating specific iso write instructions. But maybe `Whonix-Host`, `/`, `Windows` would be a confusing page name?\n\nMaybe different instruction for burning to DVD vs writing to USB? Same or different page names?"},{"author":"onion_knight2","date_created":1584447057,"date_modified":1584447057,"content":"https://www.whonix.org/wiki/Whonix-Host is probably a good place to write all documentation.\n\nI would also sort information by OS types, and also keep sub-sections for DVD and USB, e.g.:\n\nWhonix-Host/MacOS\nWhonix-Host/MacOS/DVD\nWhonix-Host/MacOS/USB\netc."},{"author":"Patrick","date_created":1584448157,"date_modified":1584448157,"content":"That sounds good!\n\n>>! In T969#19557, @onion_knight2 wrote:\n> I would also sort information by OS types, and also keep sub-sections for DVD and USB, e.g.:\n> \n> Whonix-Host/MacOS\n> Whonix-Host/MacOS/DVD\n> Whonix-Host/MacOS/USB\n> etc.\n\nSub pages or sub chapters of 1 wiki page?\n\nMaybe start with a survey of other Libre Linux distributions that are (somewhat) focused on good usability? Which are...? elementary?\n\n* https://elementary.io\n* https://elementary.io/docs/installation#installation\n* others?\n"},{"author":"onion_knight2","date_created":1584896546,"date_modified":1584896546,"content":"> Sub pages or sub chapters of 1 wiki page?\n\n1 wiki page\n\n\n\n> Maybe start with a survey of other Libre Linux distributions that are (somewhat) focused on good usability? Which are...? elementary?\n> \n>     https://elementary.io\n>     https://elementary.io/docs/installation#installation\n>     others?\n> \n\nYes, definitely."},{"author":"onion_knight2","date_created":1589352432,"date_modified":1589352943,"content":"//**Warning: Whonix-Host is experimental software and still in early development. It is currently still lacking some core features, such as persistent installation in EFI mode or a working firewall on the Host, and is not yet ready for production, nor intended for end-users, only developers. Please see https://forums.whonix.org/t/whonix-host-developers-only-preview-version-15-0-1-2-7-released/9360 for more information on its development state. Help welcome.**\n//\n**What is Whonix-Host?**\nWhonix-Host is a complete Operating System provided by Whonix developers  specifically designed to run Whonix virtual machines (\"Whonix-Gateway\" and \"Whonix-Workstation\").\n\nBased on Kicksecure, Whonix-Host comes out-of-the-box with all Kicksecure security features and KVM hypervisor with ready-to-use pre-installed Whonix virtual machines.\n\nBy default, Whonix-Host runs from a USB flash drive as a Live ISO, as any modern Linux distribution does. This means that you can use and test the whole system, including Whonix-Gateway and Whonix-Workstation, without making any changes to your computer (\"live\" or \"amnesic\" mode). \n\nWhonix-Host can also be installed from the USB flash drive on an internal hard drive or external drive such as another USB flash drive to be used as a permanent Operating System (\"persistent\" mode). \n\n**Installation**\n**Recommended System Specifications**\n1. A 64 bit processor with virtualization capacities\n2. Minimum 4GB of RAM\n3. Minimum 4GB USB flash drive \n4. Optional: another flash drive or HDD/SDD with minimum 10GB of free space if you intend to install Whonix-Host\n\n**Download and verify integrity**\n//To be completed//\n\n**Installation From Windows**\n//To be completed//\n\n**Installation From MacOS**\n//To be completed//\n\n**Installation From Linux**\nOn Linux the easiest way to burn the USB flash drive is to use the 'dd' command.\n\nIdentity your USB flash drive:\n\n'sudo fdisk -l'\n\n//Screenshot to be added wit example//\n\nCopy the Whonix-Host ISO file:\n\n'dd if=path_to_the_ISO of=/dev/your_USB_drive'\n\nIn the example above, we would use the following command:\n\n//Screenshot to be added wit example//\n\n//Warning: this command will copy the Whonix-Host ISO and erase all data on the selected drive! Proceed with extreme caution! Make sure that you selected the correct drive! //\n\nWait until the copy is over. It can take a while depending on your computer. \n\n**Booting From USB Drive**\nTo use Whonix-Host, you must insert the USB flash drive that you prepared in the previous step  into your computer and boot from it. Depending on your computer, you may be able to change your its boot order (to make sure it will boot from the Whonix-Host USB flash drive and not its usual internal disk) by pressing a special key such as F12 or Enter. Select the Whonix-Host USB flash drive press Enter. Please refer to your motherboard specific documentation for instructions on how to change the boot order.\n\n**Using Whonix-Host**\n//To be completed: a few words on general capacities (design/kicksecure/debian-based/any debian package can be installed/firewall(?)), how to use Whonix-VM, with screenshots//\n\n**Whonix-Host Persistent Installation**\n//To be completed: step-by-step Calamares installation tutorial with screenshots. Warning: currently no EFI persistent installation capacities//\n\n//**Anything else?**//"},{"author":"Patrick","date_created":1589364789,"date_modified":1589364789,"content":"Excellent!"},{"author":"onion_knight2","date_created":1589369069,"date_modified":1589369069,"content":"Glad that you liked it!\nIf you don't mind, I can already start modifying the Wiki page:\nhttp://dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion/wiki/Whonix-Host"},{"author":"Patrick","date_created":1589371225,"date_modified":1589371225,"content":"Yes, by all means. Please do.\nGenerally, most non-controversial (and this one certainly is) wiki edits can be done without prior asking.\n\n> This is a wiki. Want to improve this page? Help is welcome and volunteer contributions are happily considered! Read, understand and agree to Conditions for Contributions to Whonix ™, then Edit! Edits are held for moderation. "},{"author":"onion_knight2","date_created":1589386008,"date_modified":1589386008,"content":"Done. Waiting for approval. Still uncompleted, will add instruction step by step.\nI also wanted to add some pictures but I think I don't have sufficient rights..."},{"author":"Patrick","date_created":1589390157,"date_modified":1589390157,"content":"Approved now."},{"author":"Patrick","date_created":1589390739,"date_modified":1589390739,"content":"Added upload access also just now. Please try upload image."},{"author":"onion_knight2","date_created":1589468079,"date_modified":1589468079,"content":"Done, as well as further additions."}]},"PHID-TASK-tihqvambb37byd6jc4wc":{"id":"968","title":"Bullseye: live-boot needs GRUB_DISABLE_LINUX_UUID=\"true\" parameter in /etc/grub.d/11_linux_live","status":"resolved","priority":"Normal","author":"Patrick","description":"http://forums.whonix.org/t/bullseye-live-boot-needs-grub-disable-linux-uuid-true-parameter-in-etc-grub-d-11-linux-live/9066/1","comments":[]},"PHID-TASK-nntpe3vv5b3l2moddb4u":{"id":"967","title":"Test disabling EFI_VARS in hardened-host-kernel","status":"open","priority":"Normal","author":"madaidan","description":"CONFIG_EFI_VARS exposes a lot of attack surface as it allows you to mess with EFI variables.\n\nhttps://github.com/torvalds/linux/blob/master/drivers/firmware/efi/Kconfig\n\nThere have been cases of people bricking their computers by accidentally deleting EFI variables. An attacker might be able to do far more by writing specific things to them.\n\nCLIP OS disables this.\n\nhttps://github.com/clipos/src_platform_config-linux-hardware/blob/master/kernel_config/blacklist#L60\n\nCONFIG_EFI_VARS also seems to be a legacy option replaced by efivarfs.\n\nhttps://github.com/torvalds/linux/blob/master/fs/efivarfs/Kconfig\n\nThis may break some things and requires testing and more research.\n\nhttps://forums.whonix.org/t/kernel-recompilation-for-better-hardening/7598/402","comments":[]},"PHID-TASK-ui27ltubootz7xzyr4pp":{"id":"966","title":"fix pkexec","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/cannot-use-pkexec/8129","comments":[{"author":"Patrick","date_created":1587043794,"date_modified":1587043794,"content":"https://github.com/Whonix/security-misc/commit/72be31e870057b035651c1b5a7e9a9db149e9d25\nhttps://github.com/Whonix/security-misc/commit/442931529121e9e402e7ac56e27df3dcec43167b\nhttps://github.com/Whonix/security-misc/commit/b3ce18f0f9f1da0552a4a1bd882a5b5dda13626e\nhttps://github.com/Whonix/security-misc/commit/8851c9ed29e79d2ef5df9c7b7086878e69b90bd4"}]},"PHID-TASK-5mz4nfhuk2wkr2uzikei":{"id":"965","title":"install gvfs by default / fix access LUKS encrypted USB drive with Thunar","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/cannot-access-encrypted-usb-drive-with-thunar-in-whonix-15/8131/10\n\nreasons for `gvfs`:\n\n* https://forums.whonix.org/t/whonix-xfce-development/6213/99\n* https://forums.whonix.org/t/whonix-host-operating-system/3931/109\n* ( https://forums.whonix.org/t/use-sudoedit-in-whonix-documentation-and-whonix-software/7599/22 )\n","comments":[{"author":"Patrick","date_created":1583583473,"date_modified":1583583473,"content":"https://github.com/Whonix/anon-meta-packages/commit/dcbb0df3002701a5b6336d5eeaeac3fa155cfd82\n\nWill come in Whonix 15.0.0.9.4 and above."},{"author":"onion_knight2","date_created":1587425700,"date_modified":1587425700,"content":"Fixed?\nhttps://forums.whonix.org/t/cannot-access-encrypted-usb-drive-with-thunar-in-whonix-15/8131/9\n\nAlso, just tried it on Whonix-Host 15.0.1.2.7. It works."},{"author":"Patrick","date_created":1587459670,"date_modified":1587459670,"content":"Not 100% sure it would also be fixed inside VMs.\n\nClosing for now.\n\nhttps://forums.whonix.org/t/cannot-access-encrypted-usb-drive-with-thunar-in-whonix-15/8131/12"}]},"PHID-TASK-o2esrrxr34ihvbpkwz3d":{"id":"964","title":"mediawiki fixes #3","status":"invalid","priority":"Normal","author":"Patrick","description":"**merge template footer into real footer**\n\n* This is the \"[template footer](https://www.whonix.org/wiki/Template:Footer)\". (for lack of better term)\n* This is the real footer:\n\n> This page was last edited on 25 January 2020, at 11:42.\n> Imprint Privacy Policy Cookie Policy Terms of Service DMCA E-Sign Consent Priority Support Investors Professional Support\n\nMediawiki doesn't support to put arbitrary text into the footer. Problem with template footer is that it needs to be added to every wiki page at the bottom with `{{Footer}}` and that it does not show up on special pages. Therefore some footer links are duplicated.\n\nCould html be included into CSS (other way around)? Or could the footer CSS somehow pull the footer html?\n\n----\n\n**remove blockquote extraneous newlines**\n\n* See https://www.whonix.org/wiki/Testpage#Blockquote_Test\n* A newline in the wiki markup after the opening `<blockquote>` tag should not result in an empty quote line in the generated html.\n* A newline in the wiki markup before the closing `</blockquote>` tag should not result in an empty quote line in the generated html.\n* Should functional similar to the `<pre>` tag.\n\n----\n\n~~**mobile menu**~~\n\n~~On mobile there is `MENU` on the top right. A user has to click `MENU` before other links such as `HOME` `DOWNLOAD`, `DOCS`, etc. become visible. That is bad usability. Would be better if the mobile menu would be similar to the desktop menu.~~","comments":[{"author":"JasonJAyalaP","date_created":1584484074,"date_modified":1584484074,"content":"**merge template footer into real footer**\n\nCSS cannot pull in or add HTML. Mediawiki's built in footer is only list of links, as far as I can tell. Therefore, a separate module is needed. Something like https://www.mediawiki.org/wiki/Extension:Header_Footer which allows a footer page to be created (multiple in fact, that target namespaces or specific pages)."},{"author":"JasonJAyalaP","date_created":1584484612,"date_modified":1584484612,"content":"**remove blockquote extraneous newlines**\n\nadd this css:\n\n```\nblockquote {\n    white-space: inherit;\n}\n```\nIs that the behavior you expect? I added a third test. "},{"author":"JasonJAyalaP","date_created":1584501515,"date_modified":1584501515,"content":"**mobile menu**\nis JS an option?"},{"author":"Patrick","date_created":1584519822,"date_modified":1584519822,"content":">>! In T964#19580, @JasonJAyalaP wrote:\n> **remove blockquote extraneous newlines**\n> \n> add this css:\n> \n> ```\n> blockquote {\n>     white-space: inherit;\n> }\n> ```\n> Is that the behavior you expect? I added a third test. \n\nFixed! :)\n\n>>! In T964#19581, @JasonJAyalaP wrote:\n> **mobile menu**\n> is JS an option?\n\nNot great but if there is no other option, yes. I guess JS blocking doesn't happen much on mobile, therefore ok-ish. Though, it shouldn't get worse for non-JS mobile.\n\n>>! In T964#19579, @JasonJAyalaP wrote:\n> **merge template footer into real footer**\n> \n> CSS cannot pull in or add HTML.\n\nGood to know.\n\n> Mediawiki's built in footer is only list of links, as far as I can tell. Therefore, a separate module is needed. Something like https://www.mediawiki.org/wiki/Extension:Header_Footer which allows a footer page to be created (multiple in fact, that target namespaces or specific pages).\n\nSounds good. I will try this somewhat soonish."},{"author":"JasonJAyalaP","date_created":1584747862,"date_modified":1584747862,"content":"{F12282270}\n\nis that visually ok? Requires only one piece of css and one js\n\n```\n.top-bar-section ul {\nwidth: auto !important;\n}\n```\nand js\n```\n$( document ).ready(function() {\n    $(\"#navwrapper nav:first\").addClass(\"expanded\");\n});\n```\n"},{"author":"Patrick","date_created":1584785179,"date_modified":1584785179,"content":">>! In T964#19609, @JasonJAyalaP wrote:\n> {F12282270}\n> \n> is that visually ok? Requires only one piece of css and one js\n\nNo, that wastes too much space. Looks really unprofessional / broken."},{"author":"JasonJAyalaP","date_created":1584912532,"date_modified":1584912532,"content":"{F12282486}\n\nanother way, with the main menu stuff horizontal"},{"author":"JasonJAyalaP","date_created":1585348072,"date_modified":1585348072,"content":"{F12283161}\n\nanother option"},{"author":"Patrick","date_created":1585401572,"date_modified":1585401572,"content":"That looks much better!\n\nHow does it look with the legal banner? Does the legal banner overlap the `Whonix` textual string on the top?\n\nThe `Whonix` textual string on the top looks like wasting too much space but I guess it will be needed due to the legal banner."},{"author":"Patrick","date_created":1624570928,"date_modified":1624570928,"content":"migrated to https://forums.whonix.org/t/mediawiki-css-fixes/11874"}]},"PHID-TASK-wcfz6uz4kpejrb6x6tfv":{"id":"963","title":"Make Whonix GUI usable for high-risk non-technical Qubes users","status":"open","priority":"Wishlist","author":"ninavizz","description":"## Problem\nAs a non-technical high-risk user, I will need to understand how to perform basic network performance improvement or risk mitigation tasks, having to do with my network connection through Tor—without being fluent in Tor, Whonix, developer, or opsec unique concepts or language. \n\nSidenote: For the team, this has to be easier to execute, than the history of tickets suggests. No initial implementation is ever perfect. The existing implementation is simply too fraught and problematic, for non-technical users. None of this ask is about many of the things the existing tickets speak to; it's about isolating and surfacing basic from more advanced tasks, and using clearer language with more usable interactions, for all users to navigate towards things. \n\n## Solution\n//working sketch that illustrates the below concepts, not a dev-ready solution.//\n{F12274155}\n\n**1. Clearly surface a GUI control for Whonix among the Tray icons.**\n  - Semiotic should speak to the broadest possible concept (Whonix or Tor), not a sub-functionality within it (the clock for TimeSync, as it is, today).\n  - Icon should be actionable via same interaction other Tray icons are. \n    - Today, all tray icons //but// the TimeSync icon, are acted upon with a simple click. The TimeSync icon, however, requires a right-click. Much as that may be easier to implement, it is a dealbreaker for user adoption. That's just the reality of how non-technical human brains work. :(\n  - Icon should not break (and thus show as a different graphic to non-developer users), when clicked upon. \n    - Qubes bug. Boo. \n  - Tooltip should simply say //Whonix//, not either how to open it or other info.\n  - If redundant Whonix instances exist on a user's machine, build the Whonix widget enacted from the tray to elegantly handle that w/o redundant widgets showing-up.\n    - Possibly a super-duper-edge-case, but currently how the SD Workstation is architected.\n    - As an edge-case thing, this is the lowest priority part of these solution opportunity points.\n\n**2. Follow human centered design best practices for the behavior and layout of a Tray widget.**\n  - //Waves// ohai, I don't know a lick of code but this is my area of expertise... so, just ask! ninavizz-at-riseup-dot-net. :)\n  - Per below mockup: widget's GUI should descend below the Tray, not lay atop it; and, too many things are \"squished\" too close together, which is problematic for users with dexterity issues (arthritis, or simply an input device they're not comfortable with). It's good to put read-only things at the very top of such a menu, to give some space for movement downward. Also, always requiring the lateral movement of navigating into a flyout is a major problem. It's preferred to have more things in the parent list, and ideally no flyouts, if at all possible. But, no, that's not reflected in many Linux GUIs that are out there. \n\n**2. Clearly label functionalty within Whonix GUI**\n{F12274158}\n- Use the label //Time Sync//, instead of `sdwdate`, which is a team-facing/dev-name a lovely widget a community contributor built. :)\n- If a bit of functionality is rarely used (such as I'm guessing Restart sdwdate is), locate it within a control window's UI—not in the menu options.\n- There shouldn't be an \"exit\" button within a menu. That's just odd—unless it's a convention for right-click menus in Linux, but a Tray menu is not supposed to be a right-click menu. \n- No icons except 1 or 2 (and those should not be any of the Gnome icons, most of which were not designed for 16x16 use). Linux GUIs use way too many icons as it is, and too few of them are meaningful and only cause to distract. \n\n**3. Where possible, show the status itself—not a link to showing a status in a window.**\n- Connection Status. Just say what it is, in one word. :)\n- Again, this is my area of expertise—just ask at ninavizz-at-riseup-dot-net, if there are questions. :)\n\n**4. Clearly describe functional outcomes and guiding concepts in text w/in [Connection Wizard](https://www.whonix.org/wiki/Anon_Connection_Wizard).**\n- The Wizard is a great first-step, but its use of written language is overwhelming and likely confusing to non-technical users. Developers and \"maker\" types are very curious, and happy to read. Non-technical users often feel like imposters in technical environments, and such an overwhelming volume of text may trigger greater feelings of alienation that will have an effect opposite to helping them. \"Progressive Disclosure\" is a good concept to google and to learn about. Surface the simplest possible phrases to describe things with, then make longer descriptions about those available for the user to dive into and learn more about if they desire.\n- This complete flow should receive user testing and subsequent text iterations to simplify.\n\n**5. Get user testing and subsequent design iterations funded.**\n- Funding may exsist on the Qubes team to //implement// usability enhancements to existing `sdwdate` tool. It would be great to get some rudimentary user testing and iteration done on solutions, so that funding is used wisely.\n\n----\n\nEdit by Patrick\nFix typo sdwsdate -> sdwdate.","comments":[{"author":"Patrick","date_created":1581847517,"date_modified":1581847517,"content":"Excellent proposal!\n\nSome minor comments:\n\n> Tooltip should simply say Whonix, not either how to open it or other info.\n\nThat would be good. It wasn't implemented that way due to technical challenges, lack of resources. Might require changes to sdwdate itself too.\n\n> If redundant Whonix instances exist on a user's machine, build the Whonix widget enacted from the tray to elegantly handle that w/o redundant widgets showing-up.\n\nSolving this might require solving other non-gui related issues such as T930 first.\n\n> There shouldn't be an \"exit\" button within a menu. That's just odd—unless it's a convention for right-click menus in Linux, but a Tray menu is not supposed to be a right-click menu.\n\nCan be left out from left click menu but what about keeping it at least in a right click menu?\n\nReasons: as long as its is not perfect (such as possible/potential sdwdate-gui bugs, message spam, high CPU load, duplicate sdwdate-gui due to multiple Whonix-Gateway VMs) (also avoiding annoyance for users who don't want that systray) it is good to have an \"emergency exit\" (the right click exit button)."},{"author":"ninavizz","date_created":1581882566,"date_modified":1581882566,"content":"So... keeping an eye on user-needs as the priority driving this story: the list of \"What needs doing\" is ordered, below, as I see it:\n\n1. An icon that signifies either Tor or Whonix, needs to be easily recognizable to users in the Qubes Tray.\n2. That icon needs to be easy to act upon, by users.\n   - Left-click, not right-click.\n   - Any possible right-click functionality has to be de-prioritized until the most basic of basic user needs can be achieved in left-click functionality.\n3. User dexterity needs and ease of information discovery must be prioritized in how this widget's menu is structured.\n    - No flyouts, if at all possible.\n    - If a flyout makes sense, then it needs to be at the end of the menu.\n    - The menu should open \"down\" and not \"up\" from the Tray itself.\n    - Ideally a read-only piece of information should be the first thing on the menu, so the user does not need to initiate a compound movement (down/click) to access functionality.\n4. A path towards addressing generalized Whonix/Tor things, should be clearly labeled and positioned near the top of the menu.\n5. Users should be able to re-start Tor from the menu—which is guessed to be the most common function users are likely to have, in troubleshooting problematic connections. \n  - This decision is based on the acknowledgement, that more users are likely to need this menu to rectify things gone wrong, than to enable advanced features.\n6. More specialized functionality—such as Time Sync—should exist towards the bottom of the menu list, and be more clearly labeled.\n\nI want to be mindful to //not// embrace the traditional Unix development approach, of \"let's do one technical thing and do it really well.\" The one thing this ticket was drafted to achieve, is a goal for users—not developers. Likewise, the desired changes are requested in lieu of the feature's history—tho all the wonderful historic context provided, is always insightful. I just want to be mindful to not get lost in the history, and to instead keep focused on our goals ahead. \n\nIf we can keep our sights on user needs ahead of embracing feature benefits, I feel everything can most naturally fall into place. When we start looking at the benefits of certain features and weighing them as more or less important than the benefits of other features—or considering what's lost if a user cannot access those features—that's when we can get lost in a rabbithole of what we desire as project contributors, vs what known users are known to need. \n\nA harsh truth, is that users really don't care what project contributors want—they just want a thing to work. Which sounds horribly blunt and rude. Especially to a project team that is clearly very, very dedicated to working hard on making a utility that many benefit from using. Many in FLOSS respond to that sentiment with \"Ok, then go build your own damn tool!.\" Because we're all working on our tools in service to vulnerable users, I want to throw this flag with lots of hearts and smiles... only to keep us focused. Not to be a patronizing twat. \n\nWhen simple user needs are prioritized, the features of a product will naturally align to those—and that's how \"what we work on next\" can most easily be prioritized, for tangible execution. Admittedly: using this process can de-prioritize features we all understand and know to be incredibly powerful and to pack a lot of value for users that they may not yet appreciate... but that speaks to bigger needs that exist outside the scope of what this focused ask is about. Make sense?"},{"author":"Patrick","date_created":1589377579,"date_modified":1589377579,"content":"I am not a GUI developer at this point so please don't wait for me to implement this. sdwdate-gui is from a time when Whonix had a contributor doing GUI development.\n\nIf a patch was contributed, I would probably review and merge it."},{"author":"ninavizz","date_created":1589390687,"date_modified":1589390687,"content":"@Patrick I am currently working on a funding proposal, to get the UX work required to get production-ready handoffs to a developer, created. The above was just a shared idea, to kickoff the conversation. My apologies for not being clear on that. I would like to work on a parallel proposal to get the development work done, to improve all of the Whonix GUI stuff; the time-sync widget menu, and the windows that enable deeper settings control. \n\nDo you have ideas about who I might be available to _pay_ to implement a complete UX update to Whonix stuff—the sdw-date widget's menu, included in that? Also, how much abouts that might cost (hours, not currency)? Can email you directly to discuss more—but wanted the above at least shared, here, should anyone else see and wish to raise their hand to join in the fun.  "},{"author":"Patrick","date_created":1589475739,"date_modified":1589475739,"content":"ninavizz (nina eleanor alter):\n> ninavizz added a comment.\n> \n> \n>   @Patrick I am currently working on a funding proposal, to get the UX work required to get production-ready handoffs to a developer, created.\n\n\nThat's great!\n\n> and the windows that enable deeper settings control.\n\n\nOff-topic: Called tor-control-panel.\n\nhttps://github.com/Whonix/tor-control-panel\n\nvs Anon Connection Wizard (ACW)\n\nhttps://www.whonix.org/wiki/Anon_Connection_Wizard\n\nBoth are installed by default. tor-control-panel was contributed, and\nthen not developed further for a while now.\n\nArguably, ACW has better usability for Tor config than\ntor-control-panel. Therefore could even swap back tor-control-panel for\nACW if that would be better for usability. Please create a new ticket\nfor that if you're interested in that.\n\n>   Do you have ideas about who I might be available to _pay_ to implement a complete UX update to Whonix stuff—the sdw-date widget's menu, included in that? Also, how much abouts that might cost (hours, not currency)?\n\n\nProbably no. I will think about this and contact some people but not likely."},{"author":"ninavizz","date_created":1589476865,"date_modified":1589476865,"content":"@Patrick No biggie wrt the paid developer to implement. I like your idea on the Qubes GitHub ticket, of posting an article on the website. I'll email you separately, to coordinate on that. Said website post, I'd like to accomplish two things: one, solicit user input on any/all UX work. Two, put out the call for paid GUI dev work. \n\nInput for UX stuff w/ Whonix, should not be announced until I have a survey setup and ready to go—so said blog post should not be published for probably a few weeks. I'll work on getting access to a Lime Survey instance, often used for internet freedom projects. \n\nBig thank you to the clarification on how those UI elements are segmented. Will help me a lot, in writing that funding ask. More, via email. :)"}]},"PHID-TASK-za7awlfxapxcllvzjyuu":{"id":"962","title":"create new release of Whonix Windows Installer","status":"open","priority":"Normal","author":"Patrick","description":"After Whonix `15.0.0.8.8` or so release was blessed stable.\n\nhttps://www.whonix.org/wiki/Windows_Quick_Start\n\nhttps://www.whonix.org/wiki/Dev/Windows_Installer","comments":[]},"PHID-TASK-xwccjh6okj36fs2maihi":{"id":"961","title":"fix USB auto mounting bug / document","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/disk-usb-automount-in-kicksecure/8728/21","comments":[{"author":"Patrick","date_created":1631113726,"date_modified":1631113726,"content":"https://forums.whonix.org/t/disk-usb-automount-in-kicksecure/8728/31"}]},"PHID-TASK-znffs2e7n6w2ihhu5gqb":{"id":"960","title":"hardened kernel Debian packaging and APT integration - hkapt","status":"open","priority":"Normal","author":"Patrick","description":"    hkapt\n\n* https://forums.whonix.org/t/kernel-recompilation-for-better-hardening/7598/292\n* http://forums.whonix.org/t/kernel-recompilation-for-better-hardening/7598/293\n* https://forums.whonix.org/t/kernel-recompilation-for-better-hardening/7598/340\n\nBefore shipping this it also needs a fallback plan how to \"upgrade\" users to non-hardened kernel in case maintenance cannot be kept up at some point.","comments":[{"author":"Patrick","date_created":1587043852,"date_modified":1587043852,"content":"T977 more important for now."}]},"PHID-TASK-2ckseza5rajnix7odt6x":{"id":"959","title":"investigate QEMU with HAXM acceleration on the Windows platform as VirtualBox replacement","status":"invalid","priority":"Normal","author":"Patrick","description":"* fast enough with [HAXM](https://www.qemu.org/2017/11/22/haxm-usage-windows/)?\n* virt-manager or another good GUI on Windows?\n* usability?\n* shared clipboard?\n* shared folders?\n* installer installing QEMU, HAXM?\n* or portable version?\n* probably other stuff that needs to be considered\n\n\nhttps://forums.whonix.org/t/whonix-kvm-for-qemu-on-windows/8925\n","comments":[{"author":"Patrick","date_created":1702758891,"date_modified":1702758891,"content":"HAXM was deprecated by intel as per:\nhttps://github.com/intel/haxm\n"}]},"PHID-TASK-lbwbsmfisarlp2wm3tpf":{"id":"958","title":"Write VirtualBox Screen Resolution Bug Report","status":"resolved","priority":"Normal","author":"Patrick","description":"* https://www.whonix.org/wiki/Template:VirtualBox_Screen_Resolution_Bug\n* https://forums.whonix.org/t/whonix-15-shared-clipboard-and-dragndrop-not-working/7723/3\n* https://www.whonix.org/wiki/Dev/VirtualBox#VirtualBox_Guest_Additions_Bugs\n\n----\n\n* https://forums.whonix.org/t/consider-making-screen-resolution-1920x1080-by-default-for-all-vms/9143/17\n* https://github.com/Whonix/Whonix/commit/31c28dbf15d4b3e55a97f76e44becee6a5de56c4","comments":[]},"PHID-TASK-dn5blxna6h3cm3r4lch7":{"id":"957","title":"slow shutdown bug","status":"resolved","priority":"Normal","author":"Patrick","description":"http://forums.whonix.org/t/slow-shutdown-of-version-15-workstation-and-gateway/8828/26","comments":[{"author":"Patrick","date_created":1631112718,"date_modified":1631112718,"content":"Cannot reproduce anymore in Whonix for VirtualBox."}]},"PHID-TASK-ke7l2yx6j7or3mhacdq5":{"id":"956","title":"hardened-kernel automated testing","status":"open","priority":"Normal","author":"Patrick","description":"Should utilize any of these if possible.\n\n@HulaHoop\n> https://staging.kernelci.org/\n> \n> https://github.com/kernelci/\n> \n> There's only one public instance supporting x86:\n> \n> https://lkft.validation.linaro.org/scheduler/device_type/x86\n> \n> full list here under \"hardware\":\n> \n> https://github.com/kernelci/kernelci-doc/wiki/KernelCI\n> \n> Here's a project that plumbs together an automated fetch/build/CI/ upload process using a docker container. It should be compatible with any CI :\n> \n> https://github.com/sammcj/kernel-ci\n","comments":[]},"PHID-TASK-mpoupna7fcqiqtlzfl2b":{"id":"955","title":"review hardened kernel config","status":"open","priority":"Normal","author":"Patrick","description":"as per http://forums.whonix.org/t/kernel-recompilation-for-better-hardening/7598/314\n\nhttps://github.com/Whonix/hardened-kernel/blob/master/usr/share/hardened-kernel/hardened-host-kernel\n\nhttps://github.com/Whonix/hardened-kernel/blob/master/usr/share/hardened-kernel/hardened-vm-kernel\n","comments":[{"author":"Patrick","date_created":1587043900,"date_modified":1587043900,"content":"I can't work on this. Please go for T977."}]},"PHID-TASK-ocolbbw5xegkztqyn47v":{"id":"954","title":"Consider reintroducing checking of alloca() calls in STACKLEAK","status":"open","priority":"Normal","author":"madaidan","description":"https://github.com/clipos/src_external_linux/commit/7a94313c154dfe78223729b015b16d5f257afc35\n\nWe might want to add this patch to hardened-kernel once our version catches up with STACKLEAK.\n\nThis patch was part of the original STACKLEAK patch series sent upstream but it was dropped because all VLAs were removed from the kernel so it had no purpose anymore.\n\nThis would only be useful for out-of-tree code (certain kernel modules/patches) or as a fail-safe incase VLAs are reintroduced although that’s unlikely and even more so for an LTS kernel, meaning this patch has likely very little, if any at all, advantage now.","comments":[]},"PHID-TASK-yb3qavhedcneyzc4k7rn":{"id":"953","title":"extrepo - safely adding repos","status":"resolved","priority":"Normal","author":"Patrick","description":"http://forums.whonix.org/t/extrepo-safely-adding-repos/8539/1","comments":[]},"PHID-TASK-ns5rcspq2hdb534ueays":{"id":"952","title":"warn against superadmin / superroot in grub boot menu or initramfs","status":"open","priority":"Normal","author":"Patrick","description":"http://forums.whonix.org/t/apparmor-for-complete-system-including-init-pid1-systemd-everything-full-system-mac-policy/8339/236","comments":[]},"PHID-TASK-irppfgnihrhhoabkpf5w":{"id":"951","title":"sign kernel modules","status":"open","priority":"Normal","author":"Patrick","description":"Sign lkrg, tirdad, VirtualBox guest additions.\n\n    /usr/lib/linux-kbuild-4.19/scripts/sign-file\n\nThat would allow us to enable kernel lockdown. (T670)\n\nhttps://forums.whonix.org/t/enforce-kernel-module-software-signature-verification-module-signing-disallow-kernel-module-loading-by-default/7880\n","comments":[]},"PHID-TASK-rwjib2gat7fydn57kogf":{"id":"950","title":"set kernel.printk sysctl to prevent kernel info leaks","status":"resolved","priority":"Normal","author":"Patrick","description":"[quote](https://forums.whonix.org/t/kernel-hardening/7296/213) @madaidan:\n> During boot, the kernel logs are displayed on the console. As the kernel logs are meant to be restricted to root (`kernel.dmesg_restrict=1`), this should probably be disabled.\n> \n> Setting `kernel.printk=3 3 3 3` with sysctl configures it so only really important errors will be displayed.\n> \n> Also see [Does printk() cause any security issues?](https://security.stackexchange.com/questions/197702/does-printk-cause-any-security-issues)\n> \n> This can improve boot and shutdown speed too. I've noticed that performance improves significantly after setting this.\n\n`dmesg --console-off` does not do the trick.\n\n> I still see some logs after running that. Changing the kernel.printk sysctl hides more. I can still see some logs even with changing kernel.printk as it starts displaying logs before systemd-sysctl is executed.\n\n> The only way around that would be setting kernel.printk in the initramfs, before systemd has started if it’s even possible.\n\nEdit:\nSetting `kernel.printk = 3 3 3 3` [was implemented](https://github.com/Whonix/security-misc/commit/8d2e4b68dcae87b27f519196488e0ed7e8b95ef2) in [/etc/sysctl.d/30_security-misc.conf](https://github.com/Whonix/security-misc/blob/master/etc/sysctl.d/30_security-misc.conf) and it is being set initramfs before systemd has started using [/etc/initramfs-tools/scripts/init-bottom/sysctl-initramfs](https://github.com/Whonix/security-misc/blob/master/etc/initramfs-tools/scripts/init-bottom/sysctl-initramfs).\n\n----\n\nMaybe from Linux 5.7+ [sysctls can be set from Linux boot cmdline](https://forums.whonix.org/t/sysctls-can-now-be-set-from-linux-boot-cmdline/9221) which is planned as per T984 which might fix the remaining unwanted messages.\n\n----\n\nhttps://wiki.archlinux.org/index.php/Silent_boot","comments":[{"author":"madaidan","date_created":1577131688,"date_modified":1577131688,"content":"Should this be set in the initramfs?\n\nSome logs are shown before systemd-sysctl executes so using /etc/sysctl.d/ may not be enough."},{"author":"Patrick","date_created":1577185341,"date_modified":1577185341,"content":"Yes. Probably both. initramfs for apparmor-profile-everything users and\n/etc/sysctl.d/ security-misc."},{"author":"madaidan","date_created":1577201975,"date_modified":1577201975,"content":"Why not use an initramfs hook in security-misc? Not everyone will have security-misc and apparmor-profile-everything installed. Users with just security-misc installed will still have some kernel logs shown during early boot."},{"author":"Patrick","date_created":1577202437,"date_modified":1577202437,"content":"I guess because a sysctl.d drop-in config file is easy and catches most.\ninitramfs hook covers only `initramfs` users. Not `dracut`. But\nsecurity-misc `initramfs` hook sounds good enough. `dracut` support can\ncome later, if ever. Please implement."},{"author":"madaidan","date_created":1577203803,"date_modified":1577203803,"content":"We can use a sysctl.d drop-in and an initramfs hook in security-misc so non-initramfs users will still be mostly protected."},{"author":"madaidan","date_created":1577205291,"date_modified":1577205291,"content":"https://github.com/Whonix/security-misc/pull/51"},{"author":"Patrick","date_created":1577206469,"date_modified":1577206469,"content":"Sounds good."},{"author":"Patrick","date_created":1577208241,"date_modified":1577208241,"content":"Still wondering if initramfs modification this can be avoided... Still wondering if `kernel.printk` can be set through a kernel parameter.  Looking again at https://github.com/torvalds/linux/blob/master/Documentation/admin-guide/kernel-parameters.txt...\n\nWould the following kernel parameter(s) reach the same goal?\n\n* `printk.devkmsg=off`\n* `loglevel=0`\n*  `quiet`\n\nJust now asked:\n[How to set sysctl using kernel comand line parameter?](https://unix.stackexchange.com/questions/558802/how-to-set-sysctl-using-kernel-comand-line-parameter)\n\n>>! In T950#19228, @madaidan wrote:\n> https://github.com/Whonix/security-misc/pull/51\n\nCould you please add a feature to easily enable debugging?\n\nWhat is THE kernel option for \"more verbose, debug\"? `debug`? `ignore_loglevel`? Such as if kernel parameter `debug` is set, do not use `kernel.print` in initramfs. Just exit.\n\nThen I could add `debug` to [grub-output-verbose](https://github.com/Whonix/grub-output-verbose) as kernel parameter. (That package is in next version no longer installed by default.) (And that package is useful at least for me to easily enable debugging.)\n\ngrub-output-verbose could also drop a snippet which deactivates what `/etc/sysctl.d/printk.conf` does and reset kernel.print to default or even higher level.\n"},{"author":"madaidan","date_created":1577210966,"date_modified":1577210966,"content":"> `printk.devkmsg=off`\n\nThis just prevents writing to /dev/kmsg. It doesn't stop kernel logs being displayed during boot.\n\n> `loglevel=0`\n> `quiet`\n\nDunno about these. Need to be tested.\n\n> Could you please add a feature to easily enable debugging?\n\nShould I check for the `debug` kernel parameter or something else?"},{"author":"Patrick","date_created":1577876751,"date_modified":1577876751,"content":">>! In T950#19231, @madaidan wrote:\n>> `quiet`\n\n`quiet` (Debian default :)) works really well. After `sudo apt purge grub-output-verbose` and `sudo update-grub` [1] this is all I am seeing on a VirtualBox [serial console](https://www.whonix.org/wiki/Recovery#Serial_Console).\n\n> Loading Linux 4.19.0-6-amd64 ...\n> Loading initial ramdisk ...\n> [    2.093532] sd 4:0:0:0: [sda] Incomplete mode parameter data\n> [    2.099586] sd 4:0:0:0: [sda] Assuming drive cache: write through\n> /dev/sda1: clean, 110434/6553600 files, 1300598/26213632 blocks\n> [    4.771736] [drm:vmw_host_log [vmwgfx]] *ERROR* Failed to send host log message.\n> [    4.785116] [drm:vmw_host_log [vmwgfx]] *ERROR* Failed to send host log message.\n> [    5.880020] [p_lkrg] Loading LKRG...\n> [    6.474864] [p_lkrg] LKRG initialized successfully!\n> [   14.679246] ram_adjusted_desktop_starter[1624]: [INFO] If your host has little RAM, you are advised to reduce Gateway RAM to 256 MB. No graphical desktop environment will be started in that case. A Gateway without graphical desktop environment works as good as one with, it's just not that convenient. If you want, you can sometimes start a graphical desktop environment by toggling how much RAM is available to Gateway. Documentation about this feature can be found here: https://www.whonix.org/wiki/Desktop\n> [   14.688327] ram_adjusted_desktop_starter[1624]: [INFO] Trying to start login manager (graphical desktop environment) lightdm...\n> \n\n----\n\n[1] `grub-output-verbose` should run \"`sudo update-grub`\" at removal but does not do yet."},{"author":"Patrick","date_created":1577878310,"date_modified":1577878310,"content":"The [loader](https://github.com/Whonix/tirdad/blob/master/debian/loader) of [tirdad](https://github.com/Whonix/tirdad) is currently using `dmesg`.\n\n\n```\n## https://github.com/0xsirus/tirdad/issues/5\n## /var/log/kern.log is unsuitable. It can during manual testing i.e.\n## 'sudo /usr/lib/tirdad/loader' but not when run through systemctl i.e.\n## 'sudo systemctl restart tirdad-dkms'.\n## https://phabricator.whonix.org/T950\nwhile read -r line; do\n  if echo \"$line\" | grep --quiet --ignore-case \"Installing tirdad hook succeeded\" ; then\n     exit \"$exit_code\"\n  fi\ndone < <( dmesg --notime --follow )\n```\n\nSetting `kernel.printk=3 3 3 3` with sysctl might break it. Hopefully no longer needed as per my previous post. Something to keep in mind."},{"author":"Patrick","date_created":1579086660,"date_modified":1579086660,"content":">>! In T950#19249, @Patrick wrote:\n> The [loader](https://github.com/Whonix/tirdad/blob/master/debian/loader) of [tirdad](https://github.com/Whonix/tirdad) is currently using `dmesg`.\n\nThis is no longer the case."},{"author":"madaidan","date_created":1584813327,"date_modified":1584813327,"content":"This issue is fixed now due to the `quiet` boot parameter. `kernel.printk=3 3 3 3` isn't needed anymore."},{"author":"Patrick","date_created":1584877706,"date_modified":1584877706,"content":"Thanks!"},{"author":"Patrick","date_created":1584902870,"date_modified":1584902870,"content":"Not fully fixed.\n\nWhen booting VirtualBox there are still some confusing kernel messages shown. #usability issue.\n\n> [    1.993694] sd 0:0:0:0: [sda] Incomplete mode parameter data\n> [    1.993836] sd 0:0:0:0: [sda] Assuming drive cache: write through\n\n( https://www.whonix.org/wiki/Dev/VirtualBox#.5Bdrm:vmw_host_log_.5Bvmwgfx.5D.5D_ERROR_Failed_to_send_log )\n\n> [    4.376616] [drm:vmw_host_log [vmwgfx]] *ERROR* Failed to send host log message.\n\n( https://www.whonix.org/wiki/Dev/VirtualBox#.5Bsda.5D_Incomplete_mode_parameter_data_.2F_Assuming_drive_cache:_write_through )\n\n---\n\nAbove messages probably do not show up in Whonix KVM but if you like to reproduce this general issue then `sudo apt install lkrg`. Also LKRG shows various confusing messages which should equally apply to Whonix KVM.\n\n> [    3.612811] [p_lkrg] Loading LKRG...\n> [    4.069086] [p_lkrg] LKRG initialized successfully!\n> [    4.261277] [p_lkrg] ALERT !!! FOUND LESS[1] MODULES IN DB IN MODULE LIST[36] THAN IN CURRENT MODULE LIST[37]\n> [    4.261508] [p_lkrg] EXTRA MODULE:\n> [    4.261747] [p_lkrg] ** EXTRA MODULE IS THE SAME AS ON-GOING MODULE ACTIVITY EVENTS **\n> [    4.261914] [p_lkrg] ALERT !!! FOUND LESS[1] MODULES IN DB IN KOBJ[36] THAN IN CURRENT KOBJ[37]\n> [    4.262006] [p_lkrg] EXTRA MODULE:\n> [    4.262245] [p_lkrg] ** EXTRA MODULE IS THE SAME AS ON-GOING MODULE ACTIVITY EVENTS **\n> [    4.277598] [p_lkrg] ALERT !!! FOUND LESS[1] MODULES IN DB IN MODULE LIST[36] THAN IN CURRENT MODULE LIST[37]\n> [    4.277845] [p_lkrg] EXTRA MODULE:\n> [    4.278116] [p_lkrg] ** EXTRA MODULE IS THE SAME AS ON-GOING MODULE ACTIVITY EVENTS **\n> [    4.278338] [p_lkrg] ALERT !!! FOUND LESS[1] MODULES IN DB IN KOBJ[36] THAN IN CURRENT KOBJ[37]\n> [    4.278447] [p_lkrg] EXTRA MODULE:\n> [    4.278738] [p_lkrg] ** EXTRA MODULE IS THE SAME AS ON-GOING MODULE ACTIVITY EVENTS **\n\nI see these messages as a symptom. These messages might not leak something interesting but other messages which might be using the same mechanism might contain kernel info leaks.\n\nShould these messages be hidden? How to hide these messages?"},{"author":"Patrick","date_created":1587029404,"date_modified":1587029404,"content":"And of course these messages are attributed to whatever Whonix issue someone is having.\n\n* https://www.reddit.com/r/Whonix/comments/g0ebgc/unfamiliar_issue_aborted_icon/\n* https://imgur.com/a/IiVaxyc\n\nMaybe from Linux 5.7+ [sysctls can be set from Linux boot cmdline](https://forums.whonix.org/t/sysctls-can-now-be-set-from-linux-boot-cmdline/9221). (Related: T984)"},{"author":"Patrick","date_created":1587036593,"date_modified":1587036593,"content":"`/etc/sysctl.d/20-quiet-printk.conf`\n\n   kernel.printk = 3 3 3 3\n\nfollowed by `sudo update-initramfs -u` hides `[drm:vmw_host_log [vmwgfx]] *ERROR* Failed to send host log message.` Which is progress. But does not hide `[sda] Incomplete mode parameter data`.\n\nMaybe also thanks to [sysctl-initramfs](https://github.com/Whonix/security-misc/blob/master/etc/initramfs-tools/scripts/init-bottom/sysctl-initramfs).\n\nI've also tested the following values.\n\n> kernel.printk = 2 2 2 2\n> kernel.printk = 1 1 1 1\n> kernel.printk = 0 0 0 0\n\nThese also did hide `[drm:vmw_host_log [vmwgfx]] *ERROR* Failed to send host log message.`but did not hide `[sda] Incomplete mode parameter data`.\n"},{"author":"Patrick","date_created":1587038508,"date_modified":1587038508,"content":"https://github.com/Whonix/security-misc/commit/8d2e4b68dcae87b27f519196488e0ed7e8b95ef2"},{"author":"Patrick","date_created":1587045738,"date_modified":1587045738,"content":"Even kernel parameter `quiet loglevel=3 rd.systemd.show_status=auto rd.udev.log_priority=3`\n(from https://wiki.archlinux.org/index.php/Silent_boot)\ndoes not hide `[sda] Incomplete mode parameter data`.\n\nMore ideas that don't require kernel recompilation?"},{"author":"Patrick","date_created":1587660039,"date_modified":1587660039,"content":"Setting `quiet loglevel=0` in that exact order as per https://github.com/Whonix/security-misc/commit/6485df8126b52a2072824fa442e8d1dd5cb18981 does now hide `[sda] Incomplete mode parameter data`. However, messages by LKRG are not yet hidden.\n\n```\n[    5.382817] [p_lkrg] Loading LKRG...\n[    5.864095] [p_lkrg] LKRG initialized successfully!\n[    6.118039] [p_lkrg] ALERT !!! FOUND LESS[1] MODULES IN DB IN MODULE LIST[39] THAN IN CURRENT MODULE LIST[40]\n[    6.118231] [p_lkrg] EXTRA MODULE:\n[    6.118477] [p_lkrg] ** EXTRA MODULE IS THE SAME AS ON-GOING MODULE ACTIVITY EVENTS **\n[    6.118646] [p_lkrg] ALERT !!! FOUND LESS[1] MODULES IN DB IN KOBJ[39] THAN IN CURRENT KOBJ[40]\n[    6.118739] [p_lkrg] EXTRA MODULE:\n[    6.118978] [p_lkrg] ** EXTRA MODULE IS THE SAME AS ON-GOING MODULE ACTIVITY EVENTS *\n```\n\nMore ideas that don't require kernel recompilation?"},{"author":"Patrick","date_created":1589482718,"date_modified":1589482718,"content":"* https://github.com/Whonix/security-misc/commit/3cd7b144bba1a92ca771b16fc5215073c7561a1a\n* https://github.com/Whonix/debug-misc/commit/5a856595c1cf0a4a3b08e6ea75bd2fe2b3f2f398\n* https://github.com/Whonix/debug-misc/commit/9e1ea579ca0a2d4399f2e1126b2ae2f583410947\n* https://github.com/Whonix/debug-misc/commit/2cac2bed7169ae4d5477cbca1f2916bae110a450\n"},{"author":"Patrick","date_created":1601303564,"date_modified":1601303564,"content":"Looks all good and quite in Whonix `15.0.1.5.1`.\n\nhttps://forums.whonix.org/t/whonix-15-0-1-5-1-for-virtualbox-point-release/10294"}]},"PHID-TASK-4sbzymqxbt7ahq56gz3q":{"id":"949","title":"easy remote support VNC alternative, NX, SPICE, X2Go, Remmina","status":"open","priority":"Normal","author":"Patrick","description":"obstacles:\n\n* NAT to NAT\n* users don't know their own IPs\n\nTry use Tor onion services as a transport.\n\nOpenVPN is hard to setup in a secure way.\n\nWireguard is not yet in Debian buster.\n\nOptions to try:\n\n* SPICE originally developed fro KVM but can be used independently with\nany Linux host. It was designed for high latency environments. It can\nalso transfer audio I think. [[ https://www.systutorials.com/docs/linux/man/1-remote-viewer/ | remote-viewer ]] implements it besides VNC:\n\n* NX protocol: https://en.wikipedia.org/wiki/NX_technology\n\n* Remmina implements it as one of its options (it also supports SPICE).\n\n* X2Go\n\n* Remmina seems to be the premier graphical remote support tool. Remmina usage guide: https://www.tecmint.com/remmina-remote-desktop-sharing-and-ssh-client/\n","comments":[]},"PHID-TASK-s3idxehkmm2ljm6iptx5":{"id":"948","title":"/tmp etc. separation through polyinstantiation by using namespaces.conf","status":"open","priority":"Normal","author":"Patrick","description":"http://forums.whonix.org/t/etc-security-hardening/8592/6\n\nQuote @madaidan \n\n> namespaces.conf looks really interesting. We can give users their own view of certain directories. e.g. we can add\n> \n>     /tmp     /tmp-inst/       \tlevel      root,adm\n> \n> Which would show all users (except root and adm) only their own private /tmp which is really a copy of /tmp-inst/ that is mounted over /tmp for that user.\n> \n> https://linux.die.net/man/5/namespace.conf\n> \n> https://linux.die.net/man/8/pam_namespace\n> \n> I can't seem to enable the pam_namespace module to use this though.\n\nNeeds #research how to use this.","comments":[]},"PHID-TASK-wzfrhrz5qiodswyxbwoo":{"id":"947","title":"Qubes-Whonix eth1 static networking","status":"open","priority":"Normal","author":"Patrick","description":"That could abolish need for https://github.com/Whonix/qubes-whonix/blob/master/usr/lib/qubes-whonix/replace-ips and related dpkg triggers hack.\n\nTest this in dom0:\n\n    qvm-prefs sys-whonix ip 10.152.152.10\n\nRelated:\n\n* https://github.com/Whonix/qubes-whonix/blob/master/lib/systemd/system/qubes-whonix-network.service\n* https://github.com/Whonix/qubes-whonix/blob/master/usr/lib/qubes-whonix/init/network-proxy-setup","comments":[{"author":"Patrick","date_created":1585939492,"date_modified":1585939492,"content":"How can I undo `qvm-prefs sys-whonix ip 10.152.152.10` back to default?"},{"author":"marmarek","date_created":1585943181,"date_modified":1585943181,"content":"qvm-prefs -D sys-whonix ip"},{"author":"Patrick","date_created":1585944949,"date_modified":1585944949,"content":"`qvm-prefs sys-whonix ip 10.152.152.10` works great so far. Will test more. And call for testers.\n\nBut we couldn't just set that IP inside sys-whonix without touching dom0?\n\nI am asking, because I am wondering how would we port existing and new users to be using this? Changing something for everyone in dom0 might be harder than if just a Whonix package upgrade could make the change."},{"author":"marmarek","date_created":1585945419,"date_modified":1585945419,"content":">>! In T947#19761, @Patrick wrote:\n> But we couldn't just set that IP inside sys-whonix without touching dom0?\n\nNo, qubes specifically enforce anti-spoofing firewall rules and VM is constrained to IP set in this property. Allowing VM to freely modify it would defeat the purpose.\n\n> I am asking, because I am wondering how would we port existing and new users to be using this? Changing something for everyone in dom0 might be harder than if just a Whonix package upgrade could make the change.\n\nThere is https://github.com/QubesOS/qubes-core-admin-addon-whonix that can be used to set the IP.\n\nHave you checked how it behaves with multiple Whonix Gateways? Isn't same IP a problem there? "},{"author":"Patrick","date_created":1586294877,"date_modified":1586294877,"content":"marmarek (Marek Marczykowski-Górecki):\n>   Have you checked how it behaves with multiple Whonix Gateways?\n\n\nAren't these separated at the virtualizer level? Separate internal networks?\n\n> Isn't same IP a problem there?\n\n\nThat would for sure be a problem. At worst non-functional or traffic\nprocessed by the wrong gateway."}]},"PHID-TASK-khe5kkwec52nimk6nz6f":{"id":"946","title":"test sdwdate apparmor profile and remove complain mode","status":"resolved","priority":"Normal","author":"Patrick","description":"remove `,complain`\n\nhttps://github.com/Whonix/sdwdate/blob/master/etc/apparmor.d/usr.bin.sdwdate","comments":[{"author":"Patrick","date_created":1670516656,"date_modified":1670516656,"content":"Done for a long time."}]},"PHID-TASK-nx3ggmysxg3sq3hjkmz6":{"id":"945","title":"/etc/default/grub.d/40_kernel_hardening.cfg fails to detect kernel upgrade","status":"resolved","priority":"Normal","author":"Patrick","description":"    kver=\"$(uname -r)\"\n\nConfuses running kernel vs installed (upgraded) kernel.\n\nMaybe better:\n\n    dpkg-query --show --showformat='${Version}' linux-image-amd64\n\nhttps://github.com/Whonix/security-misc/blob/master/etc/default/grub.d/40_kernel_hardening.cfg\n\nhttp://forums.whonix.org/t/kernel-hardening/7296/325\n","comments":[{"author":"madaidan","date_created":1577131088,"date_modified":1577131088,"content":"That worked.\n\nhttps://github.com/Whonix/security-misc/pull/49"},{"author":"Patrick","date_created":1577186115,"date_modified":1577186115,"content":"https://github.com/Whonix/security-misc/commit/ede536913daa0c7ddfe55e20c93d7b752daa5de3"}]},"PHID-TASK-hhctmevumbvuijiwu55o":{"id":"944","title":"Hardened sshd Setup","status":"wontfix","priority":"Normal","author":"HulaHoop","description":"https://unix.stackexchange.com/questions/14312/how-to-restrict-an-ssh-user-to-only-allow-ssh-tunneling\n\n***\n\nWhitelisting the sshd allowed addresses can work by adding a special internal IP that uses Tor's mapadddress to refer to some onion address generated for SSH access later on.\n\nhttps://www.golinuxcloud.com/restrict-allow-ssh-certain-users-groups-rhel/","comments":[{"author":"Patrick","date_created":1670516883,"date_modified":1670516883,"content":"This is for whonix.org server security?\n\nDue to the months ongoing DDoS on the Tor network, I don't think this would be reliable. Big risk of locking oneself out of the server. Therefore not implementing this and rejecting this ticket. Could be re-opened if these issues are one day resolved and onions being reliable and DDoS resistant.\n\nreferences:\n\n* https://forums.whonix.org/t/most-onions-timing-out-before-loading-on-whonix-v-16/16065\n* https://status.torproject.org/issues/2022-06-09-network-ddos/\n"}]},"PHID-TASK-ikdtkehxadknzfoo7keb":{"id":"943","title":"make /boot and /lib/modules unreadable even for root","status":"resolved","priority":"Normal","author":"Patrick","description":"Similar to T937 but this is for defense in depth and even preventing root from getting access to kernel symbols.","comments":[{"author":"madaidan","date_created":1577132820,"date_modified":1577132820,"content":"/boot/ is already unreadable.\n\nhttps://github.com/Whonix/apparmor-profile-everything/pull/31"},{"author":"Patrick","date_created":1577186253,"date_modified":1577186253,"content":"Still need to add /boot to https://github.com/Whonix/apparmor-profile-everything/blob/master/etc/apparmor.d/abstractions/dangerous-files? Currently cannot find it there."},{"author":"madaidan","date_created":1577201836,"date_modified":1577201836,"content":"/boot isn't allowed in init-systemd anyway so we don't need to add it to dangerous-files. Apparmor denies access to files that aren't explicitly allowed. The only reason we need to blacklist /lib/modules and not /boot is because we give access to all libraries."},{"author":"Patrick","date_created":1577202542,"date_modified":1577202542,"content":"Awesome!\n\nWould an `audit deny`rule for `/boot` be useful for the sake of `audit`?"},{"author":"madaidan","date_created":1577203650,"date_modified":1577203650,"content":"Any attempted access of /boot would be logged the same way anyway although it might be good to use that to stop it from showing up in `aa-logprof`."}]},"PHID-TASK-jnqsravods4gpf3izr7j":{"id":"942","title":"Whonix Host Firewall for Whonix Host","status":"open","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/whonix-host-firewall\n\n* only Whonix VMs / Tor / upgrade / sdwdate traffic should be allowed by the host\n* merge into https://github.com/Whonix/whonix-firewall\n* https://forums.whonix.org/t/should-whonix-host-be-fully-torified-by-default/7404/15\n* https://forums.whonix.org/t/should-whonix-host-have-any-features-besides-hosting-whonix-vms-in-a-secure-way/9150\n* https://forums.whonix.org/t/whonix-host-firewall/9151\n","comments":[]},"PHID-TASK-qbnj6za35lnyztxsu2pf":{"id":"941","title":"lock down interpreters / compilers (interpreter lock) (compiler lock)","status":"open","priority":"Normal","author":"Patrick","description":"https://chromium.googlesource.com/chromiumos/docs/+/HEAD/security/noexec_shell_scripts.md\n\nhttps://forums.whonix.org/t/re-mount-home-and-other-with-noexec-and-nosuid-among-other-useful-mount-options-for-better-security/7707 should be implemented first before this one.\n\nThis could be implemented by removing read access for user `user` from interpreter's such as `python` and compilers such as `gcc`.\n\nInterpreter lock might break many things. Not clear yet if this might become a default enabled feature.\n\nhttps://github.com/Kicksecure/security-misc/pull/139\n\nhttps://www.kicksecure.com/wiki/Noexec\n\nSo we don't have to parse on/off for each, best to make a syntax similar to systemctl. Here:\n\n* `permission-hardener enable all`\n* `permission-hardener disable all`\n* `permission-hardener enable compiler`\n* `permission-hardener disable compiler`\n* `permission-hardener enable interpreter`\n* `permission-hardener disable interpreter`","comments":[]},"PHID-TASK-fp5bouispx5cqr7jdedl":{"id":"940","title":"grub boot password","status":"open","priority":"Normal","author":"Patrick","description":"* password for specific boot menu entries (recovery mode)\n* password for changing kernel command line or manual boot commands\n\nThis could either be an installer option or be prompted after first boot.\n\nImplementation:\n\n`grub-mkpasswd-pbkdf2` can create the password hash.\n\nCreate a file `/etc/grub.d/02_password`:\n\ncontents:\n\n```\n#!/bin/sh\ncat << EOF\nset superusers=\"user\"\npassword_pbkdf2 user grub.pbkdf2.sha512.10000.59212648B05E3BC4D862681E83480B1EBC0D4715A3EB382FA38AD6F55CDD2F742A02B9B3E885897B2698FDF3966CD2E75CF5992FD045305D88FD1D30F0DD6114.D532492BB61F378E932BB66FF49217805574850E09B53D9A5EB2CC1006544CE8B32F4644DBD4E59CFC26FECA8C7A0162305F4DD0C8BE200D81619BF96951615D\nEOF\n```\n","comments":[]},"PHID-TASK-u6b72g5ho7hb27hwaj74":{"id":"939","title":"file permissions hardening lockdown","status":"open","priority":"Normal","author":"Patrick","description":"* https://trent.utfs.org/wiki/Hardening/Linux\n* https://trent.utfs.org/wiki/Hardening/Linux#Permission_lockdown\n* https://trent.utfs.org/wiki/Hardening/Linux#.2Fproc\n* https://wiki.archlinux.org/index.php/Security#File_access_permissions\n\nhttps://forums.whonix.org/t/kernel-hardening/7296/234\n","comments":[]},"PHID-TASK-lmu7zifcy5hgwjxnx753":{"id":"938","title":"request apparmor environment scrubbing whitelist from AppArmor upstream","status":"resolved","priority":"Normal","author":"Patrick","description":"@madaidan \n\n> Or, maybe we can make an issue on the apparmor gitlab repo about adding specific variables that can be whitelisted when using environment scrubbing if that's even possible.\n\nhttp://forums.whonix.org/t/apparmor-for-complete-system-including-init-pid1-systemd-everything-full-system-mac-policy/8339/156\n\nhttps://gitlab.com/apparmor/apparmor/issues\n","comments":[{"author":"madaidan","date_created":1574527861,"date_modified":1574527861,"content":"I created the issue:\n\nhttps://gitlab.com/apparmor/apparmor/issues/66"},{"author":"Patrick","date_created":1574528012,"date_modified":1574528012,"content":"Awesome!"}]},"PHID-TASK-npy4o5xtllrng6w4r7ci":{"id":"937","title":"make /boot and /lib/modules unreadable for non-root users","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/kernel-hardening/7296/230","comments":[{"author":"madaidan","date_created":1577132805,"date_modified":1577132812,"content":""},{"author":"madaidan","date_created":1577132943,"date_modified":1577132943,"content":"https://github.com/Whonix/security-misc/pull/50"}]},"PHID-TASK-ugb53cnrkpnq7furmbdh":{"id":"936","title":"apparmor-profile-everything breaks Qubes upgrading ","status":"resolved","priority":"Normal","author":"Patrick","description":"```\nsudo aa-status\n```\n\n> user@host:~$ sudo journalctl -b | grep -i denied\n> Nov 23 14:35:26 host audit[1923]: AVC apparmor=\"DENIED\" operation=\"link\" info=\"link not subset of target\" error=-13 profile=\"/usr/bin/apt-get\" name=\"/usr/lib/security-misc/pam_tally2-info.dpkg-tmp\" pid=1923 comm=\"dpkg\" requested_mask=\"x\" denied_mask=\"x\" fsuid=0 ouid=0 target=\"/usr/lib/security-misc/pam_tally2-info\"\n> Nov 23 14:35:27 host audit[2198]: AVC apparmor=\"DENIED\" operation=\"file_inherit\" profile=\"/usr/lib/security-misc/permission-lockdown\" name=\"/dev/pts/1\" pid=2198 comm=\"permission-lock\" requested_mask=\"wr\" denied_mask=\"wr\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2198]: AVC apparmor=\"DENIED\" operation=\"file_inherit\" profile=\"/usr/lib/security-misc/permission-lockdown\" name=\"/dev/pts/1\" pid=2198 comm=\"permission-lock\" requested_mask=\"wr\" denied_mask=\"wr\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2198]: AVC apparmor=\"DENIED\" operation=\"file_inherit\" profile=\"/usr/lib/security-misc/permission-lockdown\" name=\"/dev/pts/1\" pid=2198 comm=\"permission-lock\" requested_mask=\"wr\" denied_mask=\"wr\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2198]: AVC apparmor=\"DENIED\" operation=\"file_inherit\" profile=\"/usr/lib/security-misc/permission-lockdown\" name=\"/dev/pts/1\" pid=2198 comm=\"permission-lock\" requested_mask=\"wr\" denied_mask=\"wr\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2207]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2207 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2207]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2207 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2207]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2207 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2207]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2207 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2207]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2207 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2207]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2207 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2212]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2212 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2212]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2212 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2212]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2212 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2212]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2212 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2212]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2212 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2212]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2212 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2217]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2217 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2217]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2217 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2217]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2217 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2217]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2217 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2217]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2217 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2217]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2217 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2247]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2247 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2247]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2247 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2247]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2247 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2247]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2247 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2247]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2247 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2247]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2247 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2251]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2251 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2251]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2251 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2251]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2251 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2251]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2251 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2251]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2251 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2251]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2251 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2255]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2255 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2255]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2255 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2255]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2255 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2255]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2255 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2255]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2255 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2255]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2255 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2259]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2259 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2259]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2259 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2259]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2259 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2259]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2259 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2259]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2259 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2259]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2259 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2309]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2309 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2309]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2309 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2309]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2309 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2309]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2309 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2309]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2309 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:27 host audit[2309]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2309 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2335]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2335 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2335]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2335 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2335]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2335 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2335]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2335 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2335]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2335 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2335]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2335 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2386]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2386 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2386]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2386 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2386]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2386 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2386]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2386 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2386]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2386 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2386]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2386 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2432]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2432 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2432]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2432 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2432]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2432 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2432]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2432 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2432]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda\" pid=2432 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:28 host audit[2432]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xvda3\" pid=2432 comm=\"grub-probe\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n> Nov 23 14:35:29 host audit[2535]: AVC apparmor=\"DENIED\" operation=\"capable\" profile=\"/usr/bin/apt-get\" pid=2535 comm=\"(sd-askpwagent)\" capability=24  capname=\"sys_resource\"\n> Nov 23 14:35:39 host audit[2980]: AVC apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/apt-get\" name=\"/dev/xen/gntalloc\" pid=2980 comm=\"qrexec-client-v\" requested_mask=\"wr\" denied_mask=\"wr\" fsuid=0 ouid=0\n\n","comments":[{"author":"madaidan","date_created":1574522421,"date_modified":1574522421,"content":"Try adding:\n\n    owner /dev/xvda r,\n    owner /dev/xvda[0-9]* r,\n    owner /dev/xen/ r,\n    owner /dev/xen/* rw,"},{"author":"Patrick","date_created":1574523487,"date_modified":1574523487,"content":"Works."},{"author":"Patrick","date_created":1574523694,"date_modified":1574523694,"content":"Could you add to git please?"},{"author":"madaidan","date_created":1574523883,"date_modified":1574523883,"content":"https://github.com/Whonix/apparmor-profile-everything/pull/7"}]},"PHID-TASK-aytoajrpdelfvzw3kemu":{"id":"935","title":"add Whonix newsletter","status":"open","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/Whonix-Website\n\nhttps://forums.whonix.org/t/whonix-newsletter/2872\n\nCould the backend be related to mailman?","comments":[]},"PHID-TASK-nxyegzm6b7etg36tgwmc":{"id":"934","title":"fix whonix-wiki-html backup / fix scrape-whonix-wiki.sh","status":"resolved","priority":"Normal","author":"Patrick","description":"Script https://github.com/WhonixBOT/whonix-wiki-html/blob/master/scrape-whonix-wiki.sh is broken.\n\nhttps://github.com/WhonixBOT/whonix-wiki-html outdated.","comments":[{"author":"Patrick","date_created":1571999448,"date_modified":1571999448,"content":"Sitemap was broken. May be unrelated to https://github.com/WhonixBOT/whonix-wiki-html/blob/master/scrape-whonix-wiki.sh. Just a follow up issue. Not cause. In progress of fixing this."}]},"PHID-TASK-zpe6fvxlpwalmkdrabjh":{"id":"933","title":"fix offline documentation - pdfbook","status":"invalid","priority":"Normal","author":"Patrick","description":"pdfbook is broken.\n\nhttps://www.mediawiki.org/wiki/Extension:PdfBook\n\nhttps://forums.whonix.org/t/the-offline-documentation-isnt-loading/8350\n\nhttps://forums.whonix.org/t/offline-documentation-discussion/413\n","comments":[{"author":"Patrick","date_created":1639061352,"date_modified":1639061352,"content":"No longer using this extension. Alternatives here:\nhttps://www.whonix.org/wiki/Offline_Documentation\n"}]},"PHID-TASK-af7jiufm3dbtjq3je3z4":{"id":"932","title":"fix Git-Mediawiki whonix-wiki-backup","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/WhonixBOT/whonix-wiki-backup unfortunately broken. Outdated.\n\nBecause,\n\n* https://github.com/Git-Mediawiki/Git-Mediawiki\n* https://packages.debian.org/search?keywords=git-mediawiki\n\nis broken.","comments":[{"author":"Patrick","date_created":1587320790,"date_modified":1587320790,"content":"https://github.com/Git-Mediawiki/Git-Mediawiki/issues/70"}]},"PHID-TASK-cne4wrzhrinuxjw27xek":{"id":"931","title":"Testing tpm2-pkcs11with KVM vTPM 2.0","status":"invalid","priority":"Normal","author":"HulaHoop","description":"KVM supports emulated TPM2 hardware and the version in Bullseye gains the ability to encrypt its secrets [0]. tpm2-pk11 [1] is a program that allows protecting OpenSSH and firefox private keys using the TPM. If the package finds a new upstream maintainer we can test it in Debian stable-next with the virtual TPM hardware.\n\nDebian maintainers will move to tpm2-pkcs11 [3]\n\n[0] http://forums.whonix.org/t/kvm-virtual-tpm-aka-the-universal-smartcard/8244\n\n[1] https://github.com/irtimmer/tpm2-pk11\n\n[2] https://github.com/irtimmer/tpm2-pk11/wiki\n\n[3] https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=941951#10\n\n***\n\nEDIT:\n\nThe above package depends on gnupg-pkcs11-scd which is available in Debian. \n\nhttps://packages.debian.org/source/stable/gnupg-pkcs11-scd\n\n***\n\n\nhttps://packages.debian.org/buster/simple-tpm-pk11\n\nonly works for TPM 1.2\n\n\n***\n\nOpened a RFP for this package which fulfills this ticket in case someone upstream picks it up. https://bugs.debian.org/941951\n\n\n***\n\nThe upstream TPM2 project is looking at consolidating the multiple code projects out there into an upstream implementation superseding the projects above.\n\nhttps://github.com/tpm2-software/tpm2-tools/issues/518\n\nhttps://github.com/tpm2-software/tpm2-pkcs11\n","comments":[{"author":"HulaHoop","date_created":1570288231,"date_modified":1570476561,"content":"TPM hw not working. Troubleshooting thread:\n\nhttps://www.redhat.com/archives/libvirt-users/2019-October/msg00006.html\n\n***\n\nTurns out it isn;t packaged for Debian yet. Opened a RFP: https://bugs.debian.org/941939"},{"author":"HulaHoop","date_created":1570715272,"date_modified":1570715272,"content":"Already packaged in Debian but is currently orphaned and needs a maintainer accoridng to its ex-maintainer:\n\nhttps://tracker.debian.org/pkg/tpm2-pk11"},{"author":"Patrick","date_created":1674125597,"date_modified":1674125597,"content":"Due to https://www.whonix.org/wiki/Reporting_Bugs#Transition_to_Discourse_Forums all tickets need to be migrated to forums. Please re-open in forums if this still still relevant."}]},"PHID-TASK-pydwvddu22mxum7x5cee":{"id":"930","title":"whonix.SdwdateStatus service starts VMs that were killed","status":"open","priority":"Wishlist","author":"marmarek","description":"@marmarek:\nWhen Whonix Workstation (for example `anon-whonix`) is properly shutdown, it executes `whonix.NewStatus+anon-whonix_shutdown` call to unregister itself from sdwdate in Whonix Gateway. But when `anon-whonix` is killed or crashed, that unregister call isn't made, and sdwdate still periodically calls `whonix.SdwdateStatus`, which causes `anon-whonix` started again. -> @Patrick said: This part would fixed by Qubes [#7169](https://github.com/QubesOS/qubes-issues/issues/7169) / [PR 13](https://github.com/QubesOS/qubes-core-admin-addon-whonix/pull/13).\n\nIdeas how to solve this:\n1. make one call `whonix.NewStatus` that a) registers new domain, b) waits for EOF from the other end  (`cat >/dev/null` or such) c) unregisters domain. This way, when the other end is terminated,  the EOF will still be delivered, as the connection will be terminated.\n2. Use just one call ws->gw to receive status updates, to avoid `whonix.SdwdateStatus` calls at all. If data flow would be tricky to do this natively, `whonix.NewStatus` (or renamed if appropriate) could listen on on a unix socket (with a VM name in path) with socat, and whatver would call `whonix.SdwdateStatus`, could connect to that socket instead.\n3. Modify qrexec policy syntax to allow `autostart=no` or similar in the policy. This way, `whonix.SdwdateStatus` could be configured to not start the domain. (I think I want this feature anyway, but not sure if this is really the best fit to fix this issue). -> EDIT by Patrick: Created [Qubes #7168](https://github.com/QubesOS/qubes-issues/issues/7168) for it.\n\nSlightly offtopic:\n - what `whonix.SdwdateStatus` calls are for? sdwdate-gui runs and show status in sys-whonix, so why is anon-whonix making the calls?\n\n----\n\nEdit by Patrick:\n\n1. `/usr/lib/python3/dist-packages/sdwdate_gui/sdwdate_watcher.py` in `anon-whonix` notifies `sys-whonix` by running `/usr/bin/qrexec-client-vm sys-whonix whonix.NewStatus+status`.\n2. `/usr/libexec/sdwdate-gui/notify-shutdown` in `anon-whonix` notifies `sys-whonix` by running `/usr/bin/qrexec-client-vm sys-whonix whonix.NewStatus+shutdown`.\n3. In `sys-whonix` `sdwdate-gui-qubes` polls the status from VMs using for example:\n\n    `qrexec-client-vm anon-whonix whonix.SdwdateStatus`\n\n> {\"icon\": \"busy\", \"message\": \"Initial time fetching in progress...\"}\n\n---\n\n - ~~`whonix.NewStatus` seems to get remote VM name from an argument; this could be spoofed by the source VM; reliable way to get remote domain name in qrexec service is `QREXEC_REMOTE_DOMAIN` env variable.~~ (Fixed.)\n - BTW for some reason this disappeared from qrexec3 documentation, it's only mentioned in qrexec2...\n","comments":[{"author":"Patrick","date_created":1639230515,"date_modified":1639230515,"content":"Funding available. Anyone up to implement this?"}]},"PHID-TASK-l7pl33g5lx6ek2yehtxf":{"id":"929","title":"Whonix XFCE Wallpaper / Background Image","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/whonix-xfce-wallpaper-background-image/7984","comments":[{"author":"Patrick","date_created":1584877934,"date_modified":1584877934,"content":"https://forums.whonix.org/t/whonix-host-calamares-branding-suggestion/7772/31"},{"author":"onion_knight2","date_created":1587425950,"date_modified":1587425950,"content":"As of Whonix-Host 15.0.1.2.7 each environment (Host, gw, ws) has its own background color.\nShould we close this ticket?"}]},"PHID-TASK-sdlwb42vr2gjn4hq57sq":{"id":"928","title":"install xfce4-power-manager on Whonix Host and Kicksecure Host","status":"resolved","priority":"Normal","author":"Patrick","description":"@Onion_Knight https://forums.whonix.org/t/whonix-desktop-installer-with-calamares-field-report/7350/109?u=patrick\n\n> As we are dealing with a host system (be it ISO or HDD install), it would be nice to have a power-manager plugin on the panel (xfce4-power-manager), something expected on a laptop for instance, I think this package does the trick (I must retest it on laptop hardware):\n\nProbably should invent Kicksecure Host package for that.\n\nhttps://github.com/Whonix/anon-meta-packages/blob/master/debian/control\n","comments":[{"author":"Patrick","date_created":1584002043,"date_modified":1584002043,"content":"https://github.com/Whonix/anon-meta-packages/commit/9550d47959e37cb8cca508e169c121dc65cde342"},{"author":"Patrick","date_created":1587670638,"date_modified":1587670638,"content":"xfce4-power-manager is installed on Whonix-Host in `15.0.1.3.2-developers-only`."}]},"PHID-TASK-yip4d2luvzgivxf4rqsg":{"id":"927","title":"port to /etc/apparmor.d/abstractions/base.d in Debian 11 bullseye","status":"resolved","priority":"Normal","author":"Patrick","description":"`/etc/apparmor.d/abstractions/base.d` will be available in Debian 12, `bookworm`.\n\nhttps://forums.whonix.org/t/whonix-apparmor-profiles-development-discussion/108/689\n\nhttps://gitlab.com/apparmor/apparmor/issues/50\n\nThen:\n\n* https://github.com/Whonix/apparmor-profile-anondist/blob/master/etc/apparmor.d/abstractions/base.anondist no longer needs to be config-package-dev `displace`ed and\n* can be split into appropriate drop-in files in the respective packages in folder `/etc/apparmor.d/abstractions/base.d`.\n","comments":[]},"PHID-TASK-qwti67qgoos6dtxud65v":{"id":"926","title":"TBB removed obfs3 support But still in ACW","status":"open","priority":"Normal","author":"TNTBOMBOM","description":"TBB has removed the ability of giving obfs3 bridges within the browser.\n\n{F12093974}","comments":[]},"PHID-TASK-hpdkg4tzdzu3z32b3drj":{"id":"925","title":"whonixcheck false positive in check_journal","status":"resolved","priority":"Normal","author":"marmarek","description":"whonixcheck reports non-issues:\n```\n[WARNING] [whonixcheck] systemd journal check Result:\nwarnings:\n########################################\nJul 21 00:34:59 host kernel: random: 5 urandom warning(s) missed due to ratelimiting\nJul 21 00:34:22 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/Crypto/pct_warnings.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/Crypto/pct_warnings.py'\nJul 21 00:34:32 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/trial/test/test_warning.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/trial/test/test_warning.py'\n########################################\n\nerrors:\n########################################\nJul 21 00:34:54 host kernel: ACPI Error: No handler or method for GPE 00, disabling event (20190215/evgpe-835)\nJul 21 00:34:54 host kernel: ACPI Error: No handler or method for GPE 01, disabling event (20190215/evgpe-835)\nJul 21 00:34:54 host kernel: ACPI Error: No handler or method for GPE 03, disabling event (20190215/evgpe-835)\nJul 21 00:34:54 host kernel: ACPI Error: No handler or method for GPE 04, disabling event (20190215/evgpe-835)\nJul 21 00:34:54 host kernel: ACPI Error: No handler or method for GPE 05, disabling event (20190215/evgpe-835)\nJul 21 00:34:54 host kernel: ACPI Error: No handler or method for GPE 06, disabling event (20190215/evgpe-835)\nJul 21 00:34:54 host kernel: ACPI Error: No handler or method for GPE 07, disabling event (20190215/evgpe-835)\nJul 21 00:34:54 host kernel: RAS: Correctable Errors collector initialized.\nJul 21 00:34:55 host kernel: Error: Driver 'pcspkr' is already registered, aborting...\nJul 21 00:35:03 host apparmor.systemd[476]: Error: Loading AppArmor profiles - failed, Do you have the correct privileges?\nJul 21 00:35:04 host xl[531]: libxl: error: libxl_utils.c:818:libxl_cpu_bitmap_alloc: failed to retrieve the maximum number of cpus\nJul 21 00:34:24 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/conch/error.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/conch/error.py'\nJul 21 00:34:25 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/cred/error.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/cred/error.py'\nJul 21 00:34:25 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/internet/error.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/internet/error.py'\nJul 21 00:34:28 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/names/error.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/names/error.py'\nJul 21 00:34:31 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/test/test_error.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/test/test_error.py'\nJul 21 00:34:32 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/test/test_strerror.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/test/test_strerror.py'\nJul 21 00:34:33 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/web/error.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/web/error.py'\nJul 21 00:34:33 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/web/test/test_error.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/web/test/test_error.py'\nJul 21 00:34:33 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/words/protocols/jabber/error.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/words/protocols/jabber/error.py'\nJul 21 00:34:33 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/words/test/test_jabbererror.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/twisted/words/test/test_jabbererror.py'\nJul 21 00:34:34 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/txsocksx/errors.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/txsocksx/errors.py'\nJul 21 00:34:34 host first-boot-home-population[769]: '/var/cache/tb-binary/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/yaml/error.py' -> '/home/user/.tb/tor-browser/Browser/TorBrowser/Tor/PluggableTransports/yaml/error.py'\n########################################\n```\n\njournal keeps metadata about each message, so it's possible to avoid it with `journalctl -p err -b` (I've added `-b` to avoid listing messages from previous boot).\n\nAnyway, in normal boot warnings/errors are logged (for example looks like some kernel messages have wrong priority, like `ACPI: No IOAPIC entries present` logged as an error is perfectly normal and even desirable on Xen PVH without PCI devices). So, I'm considering disabling this check for automated tests. Alternative could be excluding known false positives, but I'm not sure if you want to maintain such a list...\n\nSee https://openqa.qubes-os.org/tests/3446/file/whonixcheck-whonixcheck-anon-whonix.log and other files at https://openqa.qubes-os.org/tests/3446#downloads","comments":[{"author":"Patrick","date_created":1563714709,"date_modified":1563714709,"content":">   journal keeps metadata about each message, so it's possible to avoid it with `journalctl -p err -b` (I've added `-b` to avoid listing messages from previous boot).\n\n\nCool. I will move to be using that soon.\n\n> Alternative could be excluding known false positives, but I'm not sure if you want to maintain such a list...\n\n\nNot really.\n\nI didn't suppose whonixcheck --verbose output to be taken for granted.\nWouldn't want users run it and then ask about it.\n\nwhonixcheck \"systemd journal check\" was only supposed to be manually\nglimpsed over as a convenience for advanced users and developers. It's\nseverity could be lowered to \"info\" and not causing non-zero exit codes\nin any case.\n\n\n> So, I'm considering disabling this check for automated tests.\n\n\nDoes lowering \"severity could be lowered to \"info\" and not causing\nnon-zero exit codes\" + `journalctl -p err -b` sound like a good solution?"},{"author":"marmarek","date_created":1563715569,"date_modified":1563715569,"content":">   Does lowering \"severity could be lowered to \"info\" and not causing\n>   non-zero exit codes\" + `journalctl -p err -b` sound like a good solution?\n\nYes, makes sense. It would allow to still run the check (and log the\noutput, for manual check if necessary), while avoiding false positives."},{"author":"Patrick","date_created":1563725265,"date_modified":1563725265,"content":"```\n   ## '--priority=0..4'\n   ## \"emerg\" (0), \"alert\" (1), \"crit\" (2), \"err\" (3), \"warning\" (4)\n   journalctl_output=\"$(sudo --non-interactive /bin/journalctl\n--no-pager --priority=0..4 --boot)\" || true\n```\n\nSounds good?"},{"author":"Patrick","date_created":1563726545,"date_modified":1563726545,"content":"Done in git master."},{"author":"marmarek","date_created":1563733606,"date_modified":1563733606,"content":"Sounds good, thanks."}]},"PHID-TASK-7cpghe67du24tplioien":{"id":"924","title":"rename to bullseye-security","status":"resolved","priority":"Normal","author":"Patrick","description":"Check if this is true story (probably is).\n\n> Package: release-notes\n> Severity: normal\n> \n> For bullseye, the security suite is now named bullseye-security\n> instead of buster/updates and users should adapt their sources.list\n> accordingly when upgrading.\n> \n> People should probably use something like\n> \n>   deb http://security.debian.org/debian-security bullseye-security main\n> \n> (adding /debian-security was proposed in [1]).\n> \n> See [2][3][4] for some more information.\n> \n> I should probably also sent a mail to d-d-a@ or so about this in the\n> near future...\n> \n> Ansgar\n> \n>   [1] https://lists.debian.org/debian-devel/2015/12/msg00333.html\n>   [2] https://bugs.debian.org/614204\n>   [3] https://lists.debian.org/debian-devel/2015/12/msg00254.html\n>   [4] https://lists.debian.org/debian-security/2019/06/msg00015.html\n> \n\n","comments":[]},"PHID-TASK-3ziwp3tyq3ifeqswvw4j":{"id":"923","title":"Some texts on whonix connection wizard are truncated","status":"resolved","priority":"Needs Triage","author":"marmarek","description":"Some labels in bold are truncated, for example:\n`Which of the following best describes your situatio`\nor\n`Disable To`\n\nSee https://openqa.qubes-os.org/tests/2679#step/whonix_firstrun/1\n\nIt's qubes-template-whonix-gw-15-4.0.1-201906201340.","comments":[{"author":"Patrick","date_created":1561637701,"date_modified":1561637701,"content":"I have no idea why this started happening without changes. Perhaps due to underlying libraries changes. Anyhow, fixed in git master.\n\n* https://github.com/Whonix/anon-connection-wizard/commit/b3b672b12d2db7d06f8bf423046598000e9adfca\n* https://github.com/Whonix/anon-connection-wizard/commit/d2a66ba67523d4aa8fbb4fca7f28771d1129a69b"},{"author":"marmarek","date_created":1561638872,"date_modified":1561638872,"content":"Maybe different fonts installed? Is there a reason for fixed geometry of those widgets, instead of letting Qt figure it out based on the content? I suppose there may be more problems like this in the future. Especially if proper HiDPI support will come into play..."},{"author":"Patrick","date_created":1561639244,"date_modified":1561639244,"content":"marmarek (Marek Marczykowski-Górecki):\n> Is there a reason for fixed geometry of those widgets, instead of letting Qt figure it out based on the content?\n\n\nNo reason except that no one is contributing who knows python GUI stuff\nwhich isn't one of my skills."},{"author":"marmarek","date_created":1561639678,"date_modified":1561639678,"content":"I see.\nBTW it's certainly about fonts. [here](https://openqa.qubes-os.org/tests/2679#step/whonix_firstrun/2)  you can select ` \twhonix_firstrun-whonix-14-firstrun-20180915` from the dropdown above the screenshot (click eye icon at the right) and slide vertical bar to see old and new version."}]},"PHID-TASK-w2qkmia6nvjpoj3vqirg":{"id":"922","title":"Tor-Control-Panel has extra bridge (snowflake) feature which are missed in ACW & normal TBB","status":"open","priority":"Low","author":"TNTBOMBOM","description":"https://forums.whonix.org/t/qubes-whonix-version-14-debian-stretch-based-can-be-upgraded-to-version-15-debian-buster-based-testers-wanted/7143/39\n\n{F12027680}\n\n{F12027682}\n\n","comments":[]},"PHID-TASK-42aptyaftpswn7xjcrsg":{"id":"921","title":"Installing git-all will delete some Whonix packages ","status":"resolved","priority":"Normal","author":"TNTBOMBOM","description":"installing git-all package will results into damaging Whonix-ws-15:\n\nhttps://privatebin.net/?3e85d10070c10735#9Q8yy+JMmmSYyelnUPtmbN4belioCLQ4PNITf2ZZ0GU=\n\nThis issue only in Whonix not in Debian template.\n\nCommand used:\n\n\n```\nsudo apt install git-all\n```\n\n\n```\nGet:86 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libdatetime-format-iso8601-perl all 0.08-2 [15.7 kB]\n    Get:87 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 git-mediawiki all 1:2.20.1-2 [807 kB]\n    Get:88 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libserf-1-1 amd64 1.3.9-7+b10 [53.6 kB]\n    Get:89 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libutf8proc2 amd64 2.3.0-1 [53.0 kB]\n    Get:90 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libsvn1 amd64 1.10.4-1 [1,400 kB]\n    Get:91 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libsvn-perl amd64 1.10.4-1 [1,046 kB]\n    Get:92 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libyaml-perl all 1.27-1 [66.8 kB]\n    Get:93 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libterm-readkey-perl amd64 2.38-1 [27.4 kB]\n    Get:94 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 git-svn all 1:2.20.1-2 [866 kB]\n    Get:95 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 git-email all 1:2.20.1-2 [816 kB]\n    Get:96 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libtcl8.6 amd64 8.6.9+dfsg-2 [1,005 kB]\n    Get:97 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libtk8.6 amd64 8.6.9-2 [768 kB]\n    Get:98 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 tk8.6 amd64 8.6.9-2 [72.1 kB]\n    Get:99 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 tcl8.6 amd64 8.6.9+dfsg-2 [123 kB]\n    Get:100 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 tcl amd64 8.6.9+1 [5,636 B]\n    Get:101 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 tk amd64 8.6.9+1 [5,676 B]\n    Get:102 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 git-gui all 1:2.20.1-2 [1,002 kB]\n    Get:103 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 gitk all 1:2.20.1-2 [922 kB]\n    Get:104 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libcgi-pm-perl all 4.40-1 [222 kB]\n    Get:105 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 gitweb all 1:2.20.1-2 [796 kB]\n    Get:106 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 git-all all 1:2.20.1-2 [792 kB]\n    Get:107 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 runit-helper all 2.8.6 [4,900 B]\n    Get:108 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 sysuser-helper all 1.3.3 [3,844 B]\n    Get:109 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 runit amd64 2.1.2-25 [112 kB]\n    Get:110 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 git-daemon-run all 1:2.20.1-2 [794 kB]\n    Get:111 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 guile-2.2-libs amd64 2.2.4+1-2 [4,969 kB]\n    Get:112 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libauthen-sasl-perl all 2.1600-1 [50.8 kB]\n    Get:113 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libfcgi-perl amd64 0.78-2+b3 [39.0 kB]\n    Get:114 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libcgi-fast-perl all 1:2.13-1 [11.4 kB]\n    Get:115 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libclass-c3-xs-perl amd64 0.14-1+b3 [16.9 kB]\n    Get:116 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libclass-xsaccessor-perl amd64 1.19-3+b2 [38.0 kB]\n    Get:117 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libcommon-sense-perl amd64 3.74-2+b7 [24.0 kB]\n    Get:118 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libpadwalker-perl amd64 2.3-1+b1 [20.1 kB]\n    Get:119 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libdevel-caller-perl amd64 2.06-2+b1 [12.1 kB]\n    Get:120 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libdevel-lexalias-perl amd64 0.05-2+b1 [9,068 B]\n    Get:121 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libdigest-bubblebabble-perl all 0.02-2 [8,238 B]\n    Get:122 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libdigest-hmac-perl all 1.03+dfsg-2 [10.6 kB]\n    Get:123 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libnet-ip-perl all 1.26-2 [29.0 kB]\n    Get:124 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libnet-dns-perl all 1.19-1 [372 kB]\n    Get:125 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libnet-domain-tld-perl all 1.75-1 [33.3 kB]\n    Get:126 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libemail-valid-perl all 1.202-1 [23.0 kB]\n    Get:127 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libntlm0 amd64 1.5-1 [22.0 kB]\n    Get:128 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libgsasl7 amd64 1.8.0-8+b2 [207 kB]\n    Get:129 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libtypes-serialiser-perl all 1.0-1 [12.7 kB]\n    Get:130 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libjson-xs-perl amd64 3.040-1+b1 [91.0 kB]\n    Get:131 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libkyotocabinet16v5 amd64 1.2.76-4.2+b1 [298 kB]\n    Get:132 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 mailutils-common all 1:3.5-3 [689 kB]\n    Get:133 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 mysql-common all 5.8+1.0.5 [7,324 B]\n    Get:134 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 mariadb-common all 1:10.3.15-1 [31.3 kB]\n    Get:135 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libmariadb3 amd64 1:10.3.15-1 [173 kB]\n    Get:136 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libmailutils5 amd64 1:3.5-3 [881 kB]\n    Get:137 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libnet-dns-sec-perl amd64 1.11-1 [48.1 kB]\n    Get:138 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libnet-libidn-perl amd64 0.12.ds-3+b1 [18.6 kB]\n    Get:139 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libpackage-stash-xs-perl amd64 0.29-1 [19.8 kB]\n    Get:140 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libreadonly-perl all 2.050-1 [22.7 kB]\n    Get:141 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libref-util-perl all 0.204-1 [17.1 kB]\n    Get:142 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libref-util-xs-perl amd64 0.117-1+b1 [14.0 kB]\n    Get:143 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 libyaml-libyaml-perl amd64 0.76+repack-1 [33.1 kB]\n    Get:144 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 mailutils amd64 1:3.5-3 [585 kB]\n    Get:145 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 runit-sysv all 2.1.2-25 [16.8 kB]\n    Get:146 tor+http://vwakviie2ienjx6t.onion/debian buster/main amd64 ssl-cert all 1.0.39 [20.8 kB]\n    Fetched 79.8 MB in 7min 18s (182 kB/s)                                         \n    Extracting templates from packages: 100%\n    Preconfiguring packages ...\n    (Reading database ... 58664 files and directories currently installed.)\n    Removing qubes-whonix-workstation (3:11.7-1) ...\n    Removing whonix-workstation-shared-packages-shared-meta (3:11.7-1) ...\n    Removing whonix-shared-packages-recommended-cli (3:11.7-1) ...\n    Removing hardened-packages-dependencies-cli (3:11.7-1) ...\n    Removing bootclockrandomization (3:3.2-1) ...\n    Removing whonixcheck (3:11.2-1) ...\n    Removing whonix-workstation-packages-recommended-gui (3:11.7-1) ...\n    Removing whonix-ws-start-menu-additions (3:2.1-1) ...\n    Removing hardened-desktop-applications-xfce (3:11.7-1) ...\n    Removing policykit-1-gnome (0.105-7) ...\n    Removing policykit-1 (0.105-25) ...\n    Removing tb-updater (3:9.1-1) ...\n    Removing whonix-shared-default-applications-gui (3:11.7-1) ...\n    Removing msgcollector-gui (3:4.1-1) ...\n    Removing open-link-confirmation (3:3.0-1) ...\n    dpkg: gvfs-daemons: dependency problems, but removing anyway as you requested:\n     gvfs:amd64 depends on gvfs-daemons (<< 1.38.1-5.1~).\n     gvfs:amd64 depends on gvfs-daemons (>= 1.38.1-5).\n     gvfs:amd64 depends on gvfs-daemons (<< 1.38.1-5.1~).\n     gvfs:amd64 depends on gvfs-daemons (>= 1.38.1-5).\n\n    Removing gvfs-daemons (1.38.1-5) ...\n    Removing udisks2 (2.8.1-4) ...\n    Removing libpam-systemd:amd64 (241-5) ...\n    dpkg: systemd-sysv: dependency problems, but removing anyway as you requested:\n     init depends on systemd-sysv | sysvinit-core | runit-init; however:\n      Package systemd-sysv is to be removed.\n      Package sysvinit-core is not installed.\n      Package runit-init is not installed.\n\n    Removing systemd-sysv (241-5) ...\n    dpkg: tb-starter: dependency problems, but removing anyway as you requested:\n     tb-default-browser depends on tb-starter.\n\n    Removing tb-starter (3:5.1-1) ...\n    Removing msgcollector (3:4.1-1) ...\n    Removing 'diversion of /etc/bash.bash_logout to /etc/bash.bash_logout.anondist-orig by msgcollector'\n    Removing gvfs:amd64 (1.38.1-5) ...\n    Selecting previously unselected package sysvinit-core.\n    (Reading database ... 58220 files and directories currently installed.)\n    Preparing to unpack .../sysvinit-core_2.93-8_amd64.deb ...\n    Unpacking sysvinit-core (2.93-8) ...\n    (Reading database ... 58243 files and directories currently installed.)\n    Removing tb-default-browser (3:2.6-1) ...\n    Selecting previously unselected package install-info.\n    (Reading database ... 58232 files and directories currently installed.)\n    Preparing to unpack .../install-info_6.5.0.dfsg.1-4+b1_amd64.deb ...\n    Unpacking install-info (6.5.0.dfsg.1-4+b1) ...\n    Setting up install-info (6.5.0.dfsg.1-4+b1) ...\n    Selecting previously unselected package libapr1:amd64.\n    (Reading database ... 58247 files and directories currently installed.)\n    Preparing to unpack .../000-libapr1_1.6.5-1+b1_amd64.deb ...\n    Unpacking libapr1:amd64 (1.6.5-1+b1) ...\n    Selecting previously unselected package libaprutil1:amd64.\n    Preparing to unpack .../001-libaprutil1_1.6.1-4_amd64.deb ...\n    Unpacking libaprutil1:amd64 (1.6.1-4) ...\n    Selecting previously unselected package libaprutil1-dbd-sqlite3:amd64.\n    Preparing to unpack .../002-libaprutil1-dbd-sqlite3_1.6.1-4_amd64.deb ...\n    Unpacking libaprutil1-dbd-sqlite3:amd64 (1.6.1-4) ...\n    Selecting previously unselected package libaprutil1-ldap:amd64.\n    Preparing to unpack .../003-libaprutil1-ldap_1.6.1-4_amd64.deb ...\n    Unpacking libaprutil1-ldap:amd64 (1.6.1-4) ...\n    Selecting previously unselected package apache2-bin.\n    Preparing to unpack .../004-apache2-bin_2.4.38-3_amd64.deb ...\n    Unpacking apache2-bin (2.4.38-3) ...\n    Selecting previously unselected package apache2-data.\n    Preparing to unpack .../005-apache2-data_2.4.38-3_all.deb ...\n    Unpacking apache2-data (2.4.38-3) ...\n    Selecting previously unselected package apache2-utils.\n    Preparing to unpack .../006-apache2-utils_2.4.38-3_amd64.deb ...\n    Unpacking apache2-utils (2.4.38-3) ...\n    Selecting previously unselected package apache2.\n    Preparing to unpack .../007-apache2_2.4.38-3_amd64.deb ...\n    Unpacking apache2 (2.4.38-3) ...\n    Selecting previously unselected package openssh-client.\n    Preparing to unpack .../008-openssh-client_1%3a7.9p1-10_amd64.deb ...\n    Unpacking openssh-client (1:7.9p1-10) ...\n    Selecting previously unselected package cvs.\n    Preparing to unpack .../009-cvs_2%3a1.12.13+real-27_amd64.deb ...\n    Unpacking cvs (2:1.12.13+real-27) ...\n    Selecting previously unselected package cvsps.\n    Preparing to unpack .../010-cvsps_2.1-8_amd64.deb ...\n    Unpacking cvsps (2.1-8) ...\n    Selecting previously unselected package emacs-common.\n    Preparing to unpack .../011-emacs-common_1%3a26.1+1-3.2_all.deb ...\n    Unpacking emacs-common (1:26.1+1-3.2) ...\n    Selecting previously unselected package emacs-bin-common.\n    Preparing to unpack .../012-emacs-bin-common_1%3a26.1+1-3.2_amd64.deb ...\n    Unpacking emacs-bin-common (1:26.1+1-3.2) ...\n    Selecting previously unselected package libgif7:amd64.\n    Preparing to unpack .../013-libgif7_5.1.4-3_amd64.deb ...\n    Unpacking libgif7:amd64 (5.1.4-3) ...\n    Selecting previously unselected package m17n-db.\n    Preparing to unpack .../014-m17n-db_1.8.0-1_all.deb ...\n    Unpacking m17n-db (1.8.0-1) ...\n    Selecting previously unselected package libgd3:amd64.\n    Preparing to unpack .../015-libgd3_2.2.5-5.2_amd64.deb ...\n    Unpacking libgd3:amd64 (2.2.5-5.2) ...\n    Selecting previously unselected package libotf0:amd64.\n    Preparing to unpack .../016-libotf0_0.9.13-4_amd64.deb ...\n    Unpacking libotf0:amd64 (0.9.13-4) ...\n    Selecting previously unselected package libm17n-0:amd64.\n    Preparing to unpack .../017-libm17n-0_1.8.0-2_amd64.deb ...\n    Unpacking libm17n-0:amd64 (1.8.0-2) ...\n    Selecting previously unselected package emacs-gtk.\n    Preparing to unpack .../018-emacs-gtk_1%3a26.1+1-3.2_amd64.deb ...\n    Unpacking emacs-gtk (1:26.1+1-3.2) ...\n    Selecting previously unselected package emacs.\n    Preparing to unpack .../019-emacs_1%3a26.1+1-3.2_all.deb ...\n    Unpacking emacs (1:26.1+1-3.2) ...\n    Selecting previously unselected package elpa-async.\n    Preparing to unpack .../020-elpa-async_1.9.3-1_all.deb ...\n    Unpacking elpa-async (1.9.3-1) ...\n    Selecting previously unselected package elpa-dash.\n    Preparing to unpack .../021-elpa-dash_2.14.1+dfsg-1_all.deb ...\n    Unpacking elpa-dash (2.14.1+dfsg-1) ...\n    Selecting previously unselected package elpa-graphql.\n    Preparing to unpack .../022-elpa-graphql_0.1.1-3_all.deb ...\n    Unpacking elpa-graphql (0.1.1-3) ...\n    Selecting previously unselected package elpa-let-alist.\n    Preparing to unpack .../023-elpa-let-alist_1.0.5-3_all.deb ...\n    Unpacking elpa-let-alist (1.0.5-3) ...\n    Selecting previously unselected package elpa-treepy.\n    Preparing to unpack .../024-elpa-treepy_0.1.1-1_all.deb ...\n    Unpacking elpa-treepy (0.1.1-1) ...\n    Selecting previously unselected package elpa-ghub.\n    Preparing to unpack .../025-elpa-ghub_3.2.0-1_all.deb ...\n    Unpacking elpa-ghub (3.2.0-1) ...\n    Selecting previously unselected package elpa-with-editor.\n    Preparing to unpack .../026-elpa-with-editor_2.8.1-1_all.deb ...\n    Unpacking elpa-with-editor (2.8.1-1) ...\n    Selecting previously unselected package elpa-git-commit.\n    Preparing to unpack .../027-elpa-git-commit_2.90.1-2_all.deb ...\n    Unpacking elpa-git-commit (2.90.1-2) ...\n    Selecting previously unselected package liberror-perl.\n    Preparing to unpack .../028-liberror-perl_0.17027-2_all.deb ...\n    Unpacking liberror-perl (0.17027-2) ...\n    Selecting previously unselected package git-man.\n    Preparing to unpack .../029-git-man_1%3a2.20.1-2_all.deb ...\n    Unpacking git-man (1:2.20.1-2) ...\n    Selecting previously unselected package git.\n    Preparing to unpack .../030-git_1%3a2.20.1-2_amd64.deb ...\n    Unpacking git (1:2.20.1-2) ...\n    Selecting previously unselected package elpa-magit-popup.\n    Preparing to unpack .../031-elpa-magit-popup_2.12.5-1_all.deb ...\n    Unpacking elpa-magit-popup (2.12.5-1) ...\n    Selecting previously unselected package elpa-magit.\n    Preparing to unpack .../032-elpa-magit_2.90.1-2_all.deb ...\n    Unpacking elpa-magit (2.90.1-2) ...\n    Selecting previously unselected package emacs-el.\n    Preparing to unpack .../033-emacs-el_1%3a26.1+1-3.2_all.deb ...\n    Unpacking emacs-el (1:26.1+1-3.2) ...\n    Selecting previously unselected package exim4-config.\n    Preparing to unpack .../034-exim4-config_4.92-7_all.deb ...\n    Unpacking exim4-config (4.92-7) ...\n    Selecting previously unselected package exim4-base.\n    Preparing to unpack .../035-exim4-base_4.92-7_amd64.deb ...\n    Unpacking exim4-base (4.92-7) ...\n    Selecting previously unselected package libunbound8:amd64.\n    Preparing to unpack .../036-libunbound8_1.9.0-2_amd64.deb ...\n    Unpacking libunbound8:amd64 (1.9.0-2) ...\n    Selecting previously unselected package libgnutls-dane0:amd64.\n    Preparing to unpack .../037-libgnutls-dane0_3.6.7-4_amd64.deb ...\n    Unpacking libgnutls-dane0:amd64 (3.6.7-4) ...\n    Selecting previously unselected package exim4-daemon-light.\n    Preparing to unpack .../038-exim4-daemon-light_4.92-7_amd64.deb ...\n    Unpacking exim4-daemon-light (4.92-7) ...\n    Selecting previously unselected package git-doc.\n    Preparing to unpack .../039-git-doc_1%3a2.20.1-2_all.deb ...\n    Unpacking git-doc (1:2.20.1-2) ...\n    Selecting previously unselected package git-el.\n    Preparing to unpack .../040-git-el_1%3a2.20.1-2_all.deb ...\n    Unpacking git-el (1:2.20.1-2) ...\n    Selecting previously unselected package libdbi-perl:amd64.\n    Preparing to unpack .../041-libdbi-perl_1.642-1+b1_amd64.deb ...\n    Unpacking libdbi-perl:amd64 (1.642-1+b1) ...\n    Selecting previously unselected package libdbd-sqlite3-perl:amd64.\n    Preparing to unpack .../042-libdbd-sqlite3-perl_1.62-3_amd64.deb ...\n    Unpacking libdbd-sqlite3-perl:amd64 (1.62-3) ...\n    Selecting previously unselected package git-cvs.\n    Preparing to unpack .../043-git-cvs_1%3a2.20.1-2_all.deb ...\n    Unpacking git-cvs (1:2.20.1-2) ...\n    Selecting previously unselected package libjson-perl.\n    Preparing to unpack .../044-libjson-perl_4.02000-1_all.deb ...\n    Unpacking libjson-perl (4.02000-1) ...\n    Selecting previously unselected package libmediawiki-api-perl.\n    Preparing to unpack .../045-libmediawiki-api-perl_0.41-1_all.deb ...\n    Unpacking libmediawiki-api-perl (0.41-1) ...\n    Selecting previously unselected package libclass-factory-util-perl.\n    Preparing to unpack .../046-libclass-factory-util-perl_1.7-3_all.deb ...\n    Unpacking libclass-factory-util-perl (1.7-3) ...\n    Selecting previously unselected package libclass-inspector-perl.\n    Preparing to unpack .../047-libclass-inspector-perl_1.32-1_all.deb ...\n    Unpacking libclass-inspector-perl (1.32-1) ...\n    Selecting previously unselected package libfile-sharedir-perl.\n    Preparing to unpack .../048-libfile-sharedir-perl_1.116-2_all.deb ...\n    Unpacking libfile-sharedir-perl (1.116-2) ...\n    Selecting previously unselected package libb-hooks-op-check-perl.\n    Preparing to unpack .../049-libb-hooks-op-check-perl_0.22-1+b1_amd64.deb ...\n    Unpacking libb-hooks-op-check-perl (0.22-1+b1) ...\n    Selecting previously unselected package libdynaloader-functions-perl.\n    Preparing to unpack .../050-libdynaloader-functions-perl_0.003-1_all.deb ...\n    Unpacking libdynaloader-functions-perl (0.003-1) ...\n    Selecting previously unselected package libdevel-callchecker-perl.\n    Preparing to unpack .../051-libdevel-callchecker-perl_0.008-1_amd64.deb ...\n    Unpacking libdevel-callchecker-perl (0.008-1) ...\n    Selecting previously unselected package libparams-classify-perl.\n    Preparing to unpack .../052-libparams-classify-perl_0.015-1+b1_amd64.deb ...\n    Unpacking libparams-classify-perl (0.015-1+b1) ...\n    Selecting previously unselected package libmodule-runtime-perl.\n    Preparing to unpack .../053-libmodule-runtime-perl_0.016-1_all.deb ...\n    Unpacking libmodule-runtime-perl (0.016-1) ...\n    Selecting previously unselected package libmodule-implementation-perl.\n    Preparing to unpack .../054-libmodule-implementation-perl_0.09-1_all.deb ...\n    Unpacking libmodule-implementation-perl (0.09-1) ...\n    Selecting previously unselected package libsub-exporter-progressive-perl.\n    Preparing to unpack .../055-libsub-exporter-progressive-perl_0.001013-1_all.deb ...\n    Unpacking libsub-exporter-progressive-perl (0.001013-1) ...\n    Selecting previously unselected package libvariable-magic-perl.\n    Preparing to unpack .../056-libvariable-magic-perl_0.62-1+b1_amd64.deb ...\n    Unpacking libvariable-magic-perl (0.62-1+b1) ...\n    Selecting previously unselected package libb-hooks-endofscope-perl.\n    Preparing to unpack .../057-libb-hooks-endofscope-perl_0.24-1_all.deb ...\n    Unpacking libb-hooks-endofscope-perl (0.24-1) ...\n    Selecting previously unselected package libpackage-stash-perl.\n    Preparing to unpack .../058-libpackage-stash-perl_0.38-1_all.deb ...\n    Unpacking libpackage-stash-perl (0.38-1) ...\n    Selecting previously unselected package libsub-identify-perl.\n    Preparing to unpack .../059-libsub-identify-perl_0.14-1+b1_amd64.deb ...\n    Unpacking libsub-identify-perl (0.14-1+b1) ...\n    Selecting previously unselected package libsub-name-perl.\n    Preparing to unpack .../060-libsub-name-perl_0.21-1+b3_amd64.deb ...\n    Unpacking libsub-name-perl (0.21-1+b3) ...\n    Selecting previously unselected package libnamespace-clean-perl.\n    Preparing to unpack .../061-libnamespace-clean-perl_0.27-1_all.deb ...\n    Unpacking libnamespace-clean-perl (0.27-1) ...\n    Selecting previously unselected package libnamespace-autoclean-perl.\n    Preparing to unpack .../062-libnamespace-autoclean-perl_0.28-1_all.deb ...\n    Unpacking libnamespace-autoclean-perl (0.28-1) ...\n    Selecting previously unselected package libparams-util-perl.\n    Preparing to unpack .../063-libparams-util-perl_1.07-3+b4_amd64.deb ...\n    Unpacking libparams-util-perl (1.07-3+b4) ...\n    Selecting previously unselected package libsub-install-perl.\n    Preparing to unpack .../064-libsub-install-perl_0.928-1_all.deb ...\n    Unpacking libsub-install-perl (0.928-1) ...\n    Selecting previously unselected package libdata-optlist-perl.\n    Preparing to unpack .../065-libdata-optlist-perl_0.110-1_all.deb ...\n    Unpacking libdata-optlist-perl (0.110-1) ...\n    Selecting previously unselected package libsub-exporter-perl.\n    Preparing to unpack .../066-libsub-exporter-perl_0.987-1_all.deb ...\n    Unpacking libsub-exporter-perl (0.987-1) ...\n    Selecting previously unselected package libeval-closure-perl.\n    Preparing to unpack .../067-libeval-closure-perl_0.14-1_all.deb ...\n    Unpacking libeval-closure-perl (0.14-1) ...\n    Selecting previously unselected package libclass-data-inheritable-perl.\n    Preparing to unpack .../068-libclass-data-inheritable-perl_0.08-3_all.deb ...\n    Unpacking libclass-data-inheritable-perl (0.08-3) ...\n    Selecting previously unselected package libdevel-stacktrace-perl.\n    Preparing to unpack .../069-libdevel-stacktrace-perl_2.0300-1_all.deb ...\n    Unpacking libdevel-stacktrace-perl (2.0300-1) ...\n    Selecting previously unselected package libexception-class-perl.\n    Preparing to unpack .../070-libexception-class-perl_1.44-1_all.deb ...\n    Unpacking libexception-class-perl (1.44-1) ...\n    Selecting previously unselected package libparams-validationcompiler-perl.\n    Preparing to unpack .../071-libparams-validationcompiler-perl_0.30-1_all.deb ...\n    Unpacking libparams-validationcompiler-perl (0.30-1) ...\n    Selecting previously unselected package libalgorithm-c3-perl.\n    Preparing to unpack .../072-libalgorithm-c3-perl_0.10-1_all.deb ...\n    Unpacking libalgorithm-c3-perl (0.10-1) ...\n    Selecting previously unselected package libclass-c3-perl.\n    Preparing to unpack .../073-libclass-c3-perl_0.34-1_all.deb ...\n    Unpacking libclass-c3-perl (0.34-1) ...\n    Selecting previously unselected package libmro-compat-perl.\n    Preparing to unpack .../074-libmro-compat-perl_0.13-1_all.deb ...\n    Unpacking libmro-compat-perl (0.13-1) ...\n    Selecting previously unselected package libclass-method-modifiers-perl.\n    Preparing to unpack .../075-libclass-method-modifiers-perl_2.12-1_all.deb ...\n    Unpacking libclass-method-modifiers-perl (2.12-1) ...\n    Selecting previously unselected package librole-tiny-perl.\n    Preparing to unpack .../076-librole-tiny-perl_2.000006-1_all.deb ...\n    Unpacking librole-tiny-perl (2.000006-1) ...\n    Selecting previously unselected package libsub-quote-perl.\n    Preparing to unpack .../077-libsub-quote-perl_2.005001-1_all.deb ...\n    Unpacking libsub-quote-perl (2.005001-1) ...\n    Selecting previously unselected package libspecio-perl.\n    Preparing to unpack .../078-libspecio-perl_0.43-1_all.deb ...\n    Unpacking libspecio-perl (0.43-1) ...\n    Selecting previously unselected package libdatetime-locale-perl.\n    Preparing to unpack .../079-libdatetime-locale-perl_1%3a1.23-1_all.deb ...\n    Unpacking libdatetime-locale-perl (1:1.23-1) ...\n    Selecting previously unselected package libclass-singleton-perl.\n    Preparing to unpack .../080-libclass-singleton-perl_1.5-1_all.deb ...\n    Unpacking libclass-singleton-perl (1.5-1) ...\n    Selecting previously unselected package libdatetime-timezone-perl.\n    Preparing to unpack .../081-libdatetime-timezone-perl_1%3a2.23-1+2019a_all.deb ...\n    Unpacking libdatetime-timezone-perl (1:2.23-1+2019a) ...\n    Selecting previously unselected package libdatetime-perl:amd64.\n    Preparing to unpack .../082-libdatetime-perl_2%3a1.50-1+b1_amd64.deb ...\n    Unpacking libdatetime-perl:amd64 (2:1.50-1+b1) ...\n    Selecting previously unselected package libdatetime-format-strptime-perl.\n    Preparing to unpack .../083-libdatetime-format-strptime-perl_1.7600-1_all.deb ...\n    Unpacking libdatetime-format-strptime-perl (1.7600-1) ...\n    Selecting previously unselected package libparams-validate-perl.\n    Preparing to unpack .../084-libparams-validate-perl_1.29-1+b1_amd64.deb ...\n    Unpacking libparams-validate-perl (1.29-1+b1) ...\n    Selecting previously unselected package libdatetime-format-builder-perl.\n    Preparing to unpack .../085-libdatetime-format-builder-perl_0.8100-2_all.deb ...\n    Unpacking libdatetime-format-builder-perl (0.8100-2) ...\n    Selecting previously unselected package libdatetime-format-iso8601-perl.\n    Preparing to unpack .../086-libdatetime-format-iso8601-perl_0.08-2_all.deb ...\n    Unpacking libdatetime-format-iso8601-perl (0.08-2) ...\n    Selecting previously unselected package git-mediawiki.\n    Preparing to unpack .../087-git-mediawiki_1%3a2.20.1-2_all.deb ...\n    Unpacking git-mediawiki (1:2.20.1-2) ...\n    Selecting previously unselected package libserf-1-1:amd64.\n    Preparing to unpack .../088-libserf-1-1_1.3.9-7+b10_amd64.deb ...\n    Unpacking libserf-1-1:amd64 (1.3.9-7+b10) ...\n    Selecting previously unselected package libutf8proc2:amd64.\n    Preparing to unpack .../089-libutf8proc2_2.3.0-1_amd64.deb ...\n    Unpacking libutf8proc2:amd64 (2.3.0-1) ...\n    Selecting previously unselected package libsvn1:amd64.\n    Preparing to unpack .../090-libsvn1_1.10.4-1_amd64.deb ...\n    Unpacking libsvn1:amd64 (1.10.4-1) ...\n    Selecting previously unselected package libsvn-perl:amd64.\n    Preparing to unpack .../091-libsvn-perl_1.10.4-1_amd64.deb ...\n    Unpacking libsvn-perl:amd64 (1.10.4-1) ...\n    Selecting previously unselected package libyaml-perl.\n    Preparing to unpack .../092-libyaml-perl_1.27-1_all.deb ...\n    Unpacking libyaml-perl (1.27-1) ...\n    Selecting previously unselected package libterm-readkey-perl.\n    Preparing to unpack .../093-libterm-readkey-perl_2.38-1_amd64.deb ...\n    Unpacking libterm-readkey-perl (2.38-1) ...\n    Selecting previously unselected package git-svn.\n    Preparing to unpack .../094-git-svn_1%3a2.20.1-2_all.deb ...\n    Unpacking git-svn (1:2.20.1-2) ...\n    Selecting previously unselected package git-email.\n    Preparing to unpack .../095-git-email_1%3a2.20.1-2_all.deb ...\n    Unpacking git-email (1:2.20.1-2) ...\n    Selecting previously unselected package libtcl8.6:amd64.\n    Preparing to unpack .../096-libtcl8.6_8.6.9+dfsg-2_amd64.deb ...\n    Unpacking libtcl8.6:amd64 (8.6.9+dfsg-2) ...\n    Selecting previously unselected package libtk8.6:amd64.\n    Preparing to unpack .../097-libtk8.6_8.6.9-2_amd64.deb ...\n    Unpacking libtk8.6:amd64 (8.6.9-2) ...\n    Selecting previously unselected package tk8.6.\n    Preparing to unpack .../098-tk8.6_8.6.9-2_amd64.deb ...\n    Unpacking tk8.6 (8.6.9-2) ...\n    Selecting previously unselected package tcl8.6.\n    Preparing to unpack .../099-tcl8.6_8.6.9+dfsg-2_amd64.deb ...\n    Unpacking tcl8.6 (8.6.9+dfsg-2) ...\n    Selecting previously unselected package tcl.\n    Preparing to unpack .../100-tcl_8.6.9+1_amd64.deb ...\n    Unpacking tcl (8.6.9+1) ...\n    Selecting previously unselected package tk.\n    Preparing to unpack .../101-tk_8.6.9+1_amd64.deb ...\n    Unpacking tk (8.6.9+1) ...\n    Selecting previously unselected package git-gui.\n    Preparing to unpack .../102-git-gui_1%3a2.20.1-2_all.deb ...\n    Unpacking git-gui (1:2.20.1-2) ...\n    Selecting previously unselected package gitk.\n    Preparing to unpack .../103-gitk_1%3a2.20.1-2_all.deb ...\n    Unpacking gitk (1:2.20.1-2) ...\n    Selecting previously unselected package libcgi-pm-perl.\n    Preparing to unpack .../104-libcgi-pm-perl_4.40-1_all.deb ...\n    Unpacking libcgi-pm-perl (4.40-1) ...\n    Selecting previously unselected package gitweb.\n    Preparing to unpack .../105-gitweb_1%3a2.20.1-2_all.deb ...\n    Unpacking gitweb (1:2.20.1-2) ...\n    Selecting previously unselected package git-all.\n    Preparing to unpack .../106-git-all_1%3a2.20.1-2_all.deb ...\n    Unpacking git-all (1:2.20.1-2) ...\n    Selecting previously unselected package runit-helper.\n    Preparing to unpack .../107-runit-helper_2.8.6_all.deb ...\n    Unpacking runit-helper (2.8.6) ...\n    Selecting previously unselected package sysuser-helper.\n    Preparing to unpack .../108-sysuser-helper_1.3.3_all.deb ...\n    Unpacking sysuser-helper (1.3.3) ...\n    Selecting previously unselected package runit.\n    Preparing to unpack .../109-runit_2.1.2-25_amd64.deb ...\n    Unpacking runit (2.1.2-25) ...\n    Selecting previously unselected package git-daemon-run.\n    Preparing to unpack .../110-git-daemon-run_1%3a2.20.1-2_all.deb ...\n    Unpacking git-daemon-run (1:2.20.1-2) ...\n    Selecting previously unselected package guile-2.2-libs:amd64.\n    Preparing to unpack .../111-guile-2.2-libs_2.2.4+1-2_amd64.deb ...\n    Unpacking guile-2.2-libs:amd64 (2.2.4+1-2) ...\n    Selecting previously unselected package libauthen-sasl-perl.\n    Preparing to unpack .../112-libauthen-sasl-perl_2.1600-1_all.deb ...\n    Unpacking libauthen-sasl-perl (2.1600-1) ...\n    Selecting previously unselected package libfcgi-perl.\n    Preparing to unpack .../113-libfcgi-perl_0.78-2+b3_amd64.deb ...\n    Unpacking libfcgi-perl (0.78-2+b3) ...\n    Selecting previously unselected package libcgi-fast-perl.\n    Preparing to unpack .../114-libcgi-fast-perl_1%3a2.13-1_all.deb ...\n    Unpacking libcgi-fast-perl (1:2.13-1) ...\n    Selecting previously unselected package libclass-c3-xs-perl.\n    Preparing to unpack .../115-libclass-c3-xs-perl_0.14-1+b3_amd64.deb ...\n    Unpacking libclass-c3-xs-perl (0.14-1+b3) ...\n    Selecting previously unselected package libclass-xsaccessor-perl.\n    Preparing to unpack .../116-libclass-xsaccessor-perl_1.19-3+b2_amd64.deb ...\n    Unpacking libclass-xsaccessor-perl (1.19-3+b2) ...\n    Selecting previously unselected package libcommon-sense-perl.\n    Preparing to unpack .../117-libcommon-sense-perl_3.74-2+b7_amd64.deb ...\n    Unpacking libcommon-sense-perl (3.74-2+b7) ...\n    Selecting previously unselected package libpadwalker-perl.\n    Preparing to unpack .../118-libpadwalker-perl_2.3-1+b1_amd64.deb ...\n    Unpacking libpadwalker-perl (2.3-1+b1) ...\n    Selecting previously unselected package libdevel-caller-perl.\n    Preparing to unpack .../119-libdevel-caller-perl_2.06-2+b1_amd64.deb ...\n    Unpacking libdevel-caller-perl (2.06-2+b1) ...\n    Selecting previously unselected package libdevel-lexalias-perl.\n    Preparing to unpack .../120-libdevel-lexalias-perl_0.05-2+b1_amd64.deb ...\n    Unpacking libdevel-lexalias-perl (0.05-2+b1) ...\n    Selecting previously unselected package libdigest-bubblebabble-perl.\n    Preparing to unpack .../121-libdigest-bubblebabble-perl_0.02-2_all.deb ...\n    Unpacking libdigest-bubblebabble-perl (0.02-2) ...\n    Selecting previously unselected package libdigest-hmac-perl.\n    Preparing to unpack .../122-libdigest-hmac-perl_1.03+dfsg-2_all.deb ...\n    Unpacking libdigest-hmac-perl (1.03+dfsg-2) ...\n    Selecting previously unselected package libnet-ip-perl.\n    Preparing to unpack .../123-libnet-ip-perl_1.26-2_all.deb ...\n    Unpacking libnet-ip-perl (1.26-2) ...\n    Selecting previously unselected package libnet-dns-perl.\n    Preparing to unpack .../124-libnet-dns-perl_1.19-1_all.deb ...\n    Unpacking libnet-dns-perl (1.19-1) ...\n    Selecting previously unselected package libnet-domain-tld-perl.\n    Preparing to unpack .../125-libnet-domain-tld-perl_1.75-1_all.deb ...\n    Unpacking libnet-domain-tld-perl (1.75-1) ...\n    Selecting previously unselected package libemail-valid-perl.\n    Preparing to unpack .../126-libemail-valid-perl_1.202-1_all.deb ...\n    Unpacking libemail-valid-perl (1.202-1) ...\n    Selecting previously unselected package libntlm0:amd64.\n    Preparing to unpack .../127-libntlm0_1.5-1_amd64.deb ...\n    Unpacking libntlm0:amd64 (1.5-1) ...\n    Selecting previously unselected package libgsasl7.\n    Preparing to unpack .../128-libgsasl7_1.8.0-8+b2_amd64.deb ...\n    Unpacking libgsasl7 (1.8.0-8+b2) ...\n    Selecting previously unselected package libtypes-serialiser-perl.\n    Preparing to unpack .../129-libtypes-serialiser-perl_1.0-1_all.deb ...\n    Unpacking libtypes-serialiser-perl (1.0-1) ...\n    Selecting previously unselected package libjson-xs-perl.\n    Preparing to unpack .../130-libjson-xs-perl_3.040-1+b1_amd64.deb ...\n    Unpacking libjson-xs-perl (3.040-1+b1) ...\n    Selecting previously unselected package libkyotocabinet16v5:amd64.\n    Preparing to unpack .../131-libkyotocabinet16v5_1.2.76-4.2+b1_amd64.deb ...\n    Unpacking libkyotocabinet16v5:amd64 (1.2.76-4.2+b1) ...\n    Selecting previously unselected package mailutils-common.\n    Preparing to unpack .../132-mailutils-common_1%3a3.5-3_all.deb ...\n    Unpacking mailutils-common (1:3.5-3) ...\n    Selecting previously unselected package mysql-common.\n    Preparing to unpack .../133-mysql-common_5.8+1.0.5_all.deb ...\n    Unpacking mysql-common (5.8+1.0.5) ...\n    Selecting previously unselected package mariadb-common.\n    Preparing to unpack .../134-mariadb-common_1%3a10.3.15-1_all.deb ...\n    Unpacking mariadb-common (1:10.3.15-1) ...\n    Selecting previously unselected package libmariadb3:amd64.\n    Preparing to unpack .../135-libmariadb3_1%3a10.3.15-1_amd64.deb ...\n    Unpacking libmariadb3:amd64 (1:10.3.15-1) ...\n    Selecting previously unselected package libmailutils5:amd64.\n    Preparing to unpack .../136-libmailutils5_1%3a3.5-3_amd64.deb ...\n    Unpacking libmailutils5:amd64 (1:3.5-3) ...\n    Selecting previously unselected package libnet-dns-sec-perl.\n    Preparing to unpack .../137-libnet-dns-sec-perl_1.11-1_amd64.deb ...\n    Unpacking libnet-dns-sec-perl (1.11-1) ...\n    Selecting previously unselected package libnet-libidn-perl.\n    Preparing to unpack .../138-libnet-libidn-perl_0.12.ds-3+b1_amd64.deb ...\n    Unpacking libnet-libidn-perl (0.12.ds-3+b1) ...\n    Selecting previously unselected package libpackage-stash-xs-perl.\n    Preparing to unpack .../139-libpackage-stash-xs-perl_0.29-1_amd64.deb ...\n    Unpacking libpackage-stash-xs-perl (0.29-1) ...\n    Selecting previously unselected package libreadonly-perl.\n    Preparing to unpack .../140-libreadonly-perl_2.050-1_all.deb ...\n    Unpacking libreadonly-perl (2.050-1) ...\n    Selecting previously unselected package libref-util-perl.\n    Preparing to unpack .../141-libref-util-perl_0.204-1_all.deb ...\n    Unpacking libref-util-perl (0.204-1) ...\n    Selecting previously unselected package libref-util-xs-perl.\n    Preparing to unpack .../142-libref-util-xs-perl_0.117-1+b1_amd64.deb ...\n    Unpacking libref-util-xs-perl (0.117-1+b1) ...\n    Selecting previously unselected package libyaml-libyaml-perl.\n    Preparing to unpack .../143-libyaml-libyaml-perl_0.76+repack-1_amd64.deb ...\n    Unpacking libyaml-libyaml-perl (0.76+repack-1) ...\n    Selecting previously unselected package mailutils.\n    Preparing to unpack .../144-mailutils_1%3a3.5-3_amd64.deb ...\n    Unpacking mailutils (1:3.5-3) ...\n    Selecting previously unselected package runit-sysv.\n    Preparing to unpack .../145-runit-sysv_2.1.2-25_all.deb ...\n    Unpacking runit-sysv (2.1.2-25) ...\n    Selecting previously unselected package ssl-cert.\n    Preparing to unpack .../146-ssl-cert_1.0.39_all.deb ...\n    Unpacking ssl-cert (1.0.39) ...\n    Setting up runit-helper (2.8.6) ...\n    Setting up mysql-common (5.8+1.0.5) ...\n    update-alternatives: using /etc/mysql/my.cnf.fallback to provide /etc/mysql/my.cnf (my.cnf) in auto mode\n    Setting up libotf0:amd64 (0.9.13-4) ...\n    Setting up elpa-graphql (0.1.1-3) ...\n    Setting up libclass-inspector-perl (1.32-1) ...\n    Setting up libdynaloader-functions-perl (0.003-1) ...\n    Setting up libclass-method-modifiers-perl (2.12-1) ...\n    Setting up libref-util-xs-perl (0.117-1+b1) ...\n    Setting up libsub-identify-perl (0.14-1+b1) ...\n    Setting up openssh-client (1:7.9p1-10) ...\n    Setting up cvs (2:1.12.13+real-27) ...\n    Allowing use of questionable username.\n    Adding group `_cvsadmin' (GID 123) ...\n    Done.\n    Setting up libauthen-sasl-perl (2.1600-1) ...\n    Setting up libutf8proc2:amd64 (2.3.0-1) ...\n    Setting up libkyotocabinet16v5:amd64 (1.2.76-4.2+b1) ...\n    Setting up libcgi-pm-perl (4.40-1) ...\n    Setting up libyaml-libyaml-perl (0.76+repack-1) ...\n    Setting up libapr1:amd64 (1.6.5-1+b1) ...\n    Setting up m17n-db (1.8.0-1) ...\n    Setting up libcommon-sense-perl (3.74-2+b7) ...\n    Setting up libclass-singleton-perl (1.5-1) ...\n    Setting up libpadwalker-perl (2.3-1+b1) ...\n    Setting up elpa-with-editor (2.8.1-1) ...\n    Setting up git-doc (1:2.20.1-2) ...\n    Setting up libyaml-perl (1.27-1) ...\n    Setting up libclass-c3-xs-perl (0.14-1+b3) ...\n    Setting up libdevel-caller-perl (2.06-2+b1) ...\n    Setting up libsub-install-perl (0.928-1) ...\n    Setting up liberror-perl (0.17027-2) ...\n    Setting up mariadb-common (1:10.3.15-1) ...\n    update-alternatives: using /etc/mysql/mariadb.cnf to provide /etc/mysql/my.cnf (my.cnf) in auto mode\n    Setting up libreadonly-perl (2.050-1) ...\n    Setting up libdevel-lexalias-perl (0.05-2+b1) ...\n    Setting up libpackage-stash-xs-perl (0.29-1) ...\n    Setting up elpa-treepy (0.1.1-1) ...\n    Setting up libclass-data-inheritable-perl (0.08-3) ...\n    Setting up libunbound8:amd64 (1.9.0-2) ...\n    Setting up elpa-dash (2.14.1+dfsg-1) ...\n    Setting up libalgorithm-c3-perl (0.10-1) ...\n    Setting up libdigest-hmac-perl (1.03+dfsg-2) ...\n    Setting up libntlm0:amd64 (1.5-1) ...\n    Setting up libref-util-perl (0.204-1) ...\n    Setting up ssl-cert (1.0.39) ...\n    hostname: Non-recoverable failure in name resolution\n    make-ssl-cert: Could not get FQDN, using \"host\".\n    make-ssl-cert: You may want to fix your /etc/hosts and/or DNS setup and run\n    make-ssl-cert: make-ssl-cert generate-default-snakeoil --force-overwrite\n    make-ssl-cert: again.\n    Setting up libnet-domain-tld-perl (1.75-1) ...\n    Setting up libnet-libidn-perl (0.12.ds-3+b1) ...\n    Setting up libgd3:amd64 (2.2.5-5.2) ...\n    Setting up libvariable-magic-perl (0.62-1+b1) ...\n    Setting up mailutils-common (1:3.5-3) ...\n    Setting up libtcl8.6:amd64 (8.6.9+dfsg-2) ...\n    Setting up libb-hooks-op-check-perl (0.22-1+b1) ...\n    Setting up libmariadb3:amd64 (1:10.3.15-1) ...\n    Setting up libparams-util-perl (1.07-3+b4) ...\n    Setting up libsub-exporter-progressive-perl (0.001013-1) ...\n    Setting up sysuser-helper (1.3.3) ...\n    Setting up libsub-name-perl (0.21-1+b3) ...\n    Setting up libgif7:amd64 (5.1.4-3) ...\n    Setting up libtypes-serialiser-perl (1.0-1) ...\n    Setting up elpa-let-alist (1.0.5-3) ...\n    Setting up exim4-config (4.92-7) ...\n    Adding system-user for exim (v4)\n    /usr/sbin/update-exim4.conf: 467: /usr/sbin/update-exim4.conf: /usr/sbin/exim4: Operation not permitted\n    Invalid new configfile /var/lib/exim4/config.autogenerated.tmp, not installing \n    /var/lib/exim4/config.autogenerated.tmp to /var/lib/exim4/config.autogenerated\n    dpkg: error processing package exim4-config (--configure):\n     installed exim4-config package post-installation script subprocess returned error exit status 1\n    Setting up libclass-factory-util-perl (1.7-3) ...\n    Setting up libjson-perl (4.02000-1) ...\n    Setting up librole-tiny-perl (2.000006-1) ...\n    Setting up libfile-sharedir-perl (1.116-2) ...\n    Setting up libfcgi-perl (0.78-2+b3) ...\n    Setting up git-man (1:2.20.1-2) ...\n    Setting up libsub-quote-perl (2.005001-1) ...\n    Setting up libdevel-stacktrace-perl (2.0300-1) ...\n    Setting up libclass-xsaccessor-perl (1.19-3+b2) ...\n    Setting up apache2-data (2.4.38-3) ...\n    Setting up cvsps (2.1-8) ...\n    Setting up libterm-readkey-perl (2.38-1) ...\n    Setting up emacs-common (1:26.1+1-3.2) ...\n    Setting up libnet-ip-perl (1.26-2) ...\n    Setting up sysvinit-core (2.93-8) ...\n    Not restarting sysvinit\n    Setting up elpa-git-commit (2.90.1-2) ...\n    tsort: -: input contains a loop:\n    tsort: elpa-dash\n    tsort: emacsen-common\n    tsort: -: input contains a loop:\n    tsort: emacsen-common\n    tsort: elpa-with-editor\n    Setting up guile-2.2-libs:amd64 (2.2.4+1-2) ...\n    Setting up libdbi-perl:amd64 (1.642-1+b1) ...\n    Setting up libaprutil1:amd64 (1.6.1-4) ...\n    Setting up libdigest-bubblebabble-perl (0.02-2) ...\n    Setting up elpa-ghub (3.2.0-1) ...\n    Setting up libjson-xs-perl (3.040-1+b1) ...\n    Setting up libgnutls-dane0:amd64 (3.6.7-4) ...\n    Setting up tcl8.6 (8.6.9+dfsg-2) ...\n    dpkg: dependency problems prevent configuration of exim4-base:\n     exim4-base depends on exim4-config (>= 4.82) | exim4-config-2; however:\n      Package exim4-config is not configured yet.\n      Package exim4-config-2 is not installed.\n      Package exim4-config which provides exim4-config-2 is not configured yet.\n\n    dpkg: error processing package exim4-base (--configure):\n     dependency problems - leaving unconfigured\n    Setting up libmediawiki-api-perl (0.41-1) ...\n    Setting up libcgi-fast-perl (1:2.13-1) ...\n    Setting up libtk8.6:amd64 (8.6.9-2) ...\n    Setting up libserf-1-1:amd64 (1.3.9-7+b10) ...\n    Setting up libgsasl7 (1.8.0-8+b2) ...\n    Setting up libnet-dns-perl (1.19-1) ...\n    Setting up libexception-class-perl (1.44-1) ...\n    Setting up libm17n-0:amd64 (1.8.0-2) ...\n    Setting up libaprutil1-ldap:amd64 (1.6.1-4) ...\n    Setting up libclass-c3-perl (0.34-1) ...\n    Setting up libaprutil1-dbd-sqlite3:amd64 (1.6.1-4) ...\n    Setting up libdevel-callchecker-perl (0.008-1) ...\n    Setting up runit (2.1.2-25) ...\n    Setting up libdata-optlist-perl (0.110-1) ...\n    Setting up emacs-el (1:26.1+1-3.2) ...\n    Setting up git (1:2.20.1-2) ...\n    Setting up git-email (1:2.20.1-2) ...\n    Setting up gitweb (1:2.20.1-2) ...\n    Package apache2 is not configured yet. Will defer actions by package gitweb.\n    Setting up emacs-bin-common (1:26.1+1-3.2) ...\n    update-alternatives: using /usr/bin/ctags.emacs to provide /usr/bin/ctags (ctags) in auto mode\n    update-alternatives: using /usr/bin/ebrowse.emacs to provide /usr/bin/ebrowse (ebrowse) in auto mode\n    update-alternatives: using /usr/bin/emacsclient.emacs to provide /usr/bin/emacsclient (emacsclient) in auto mode\n    update-alternatives: using /usr/bin/etags.emacs to provide /usr/bin/etags (etags) in auto mode\n    Setting up libdbd-sqlite3-perl:amd64 (1.62-3) ...\n    Setting up libmro-compat-perl (0.13-1) ...\n    Setting up libsvn1:amd64 (1.10.4-1) ...\n    Setting up runit-sysv (2.1.2-25) ...\n    dpkg: dependency problems prevent configuration of exim4-daemon-light:\n     exim4-daemon-light depends on exim4-base (>= 4.92); however:\n      Package exim4-base is not configured yet.\n\n    dpkg: error processing package exim4-daemon-light (--configure):\n     dependency problems - leaving unconfigured\n    Setting up libmailutils5:amd64 (1:3.5-3) ...\n    Setting up libsub-exporter-perl (0.987-1) ...\n    Setting up apache2-utils (2.4.38-3) ...\n    Setting up libeval-closure-perl (0.14-1) ...\n    Setting up tk8.6 (8.6.9-2) ...\n    Setting up libparams-validationcompiler-perl (0.30-1) ...\n    Setting up libsvn-perl:amd64 (1.10.4-1) ...\n    Setting up mailutils (1:3.5-3) ...\n    update-alternatives: using /usr/bin/frm.mailutils to provide /usr/bin/frm (frm) in auto mode\n    update-alternatives: using /usr/bin/from.mailutils to provide /usr/bin/from (from) in auto mode\n    update-alternatives: using /usr/bin/messages.mailutils to provide /usr/bin/messages (messages) in auto mode\n    update-alternatives: using /usr/bin/movemail.mailutils to provide /usr/bin/movemail (movemail) in auto mode\n    update-alternatives: using /usr/bin/readmsg.mailutils to provide /usr/bin/readmsg (readmsg) in auto mode\n    update-alternatives: using /usr/bin/dotlock.mailutils to provide /usr/bin/dotlock (dotlock) in auto mode\n    update-alternatives: using /usr/bin/mail.mailutils to provide /usr/bin/mailx (mailx) in auto mode\n    Setting up git-cvs (1:2.20.1-2) ...\n    Setting up git-daemon-run (1:2.20.1-2) ...\n    Warning: The home dir /nonexistent you specified can't be accessed: No such file or directory\n    Adding system user `gitlog' (UID 116) ...\n    Adding new user `gitlog' (UID 116) with group `nogroup' ...\n    Not creating home directory `/nonexistent'.\n    Warning: The home dir /nonexistent you specified can't be accessed: No such file or directory\n    Adding system user `gitdaemon' (UID 117) ...\n    Adding new user `gitdaemon' (UID 117) with group `nogroup' ...\n    Not creating home directory `/nonexistent'.\n    Service git-daemon added.\n    Setting up libemail-valid-perl (1.202-1) ...\n    Setting up libparams-classify-perl (0.015-1+b1) ...\n    Setting up libnet-dns-sec-perl (1.11-1) ...\n    Setting up git-svn (1:2.20.1-2) ...\n    Setting up apache2-bin (2.4.38-3) ...\n    Setting up libmodule-runtime-perl (0.016-1) ...\n    Setting up emacs-gtk (1:26.1+1-3.2) ...\n    update-alternatives: using /usr/bin/emacs-gtk to provide /usr/bin/emacs (emacs) in auto mode\n    Install emacsen-common for emacs\n    emacsen-common: Handling install of emacsen flavor emacs\n    Install git for emacs\n    Install elpa-graphql for emacs\n    install/graphql-0.1.1: Handling install of emacsen flavor emacs\n    install/graphql-0.1.1: byte-compiling for emacs\n    Install dictionaries-common for emacs\n    install/dictionaries-common: Byte-compiling for emacsen flavour emacs\n    Install elpa-treepy for emacs\n    install/treepy-0.1.1: Handling install of emacsen flavor emacs\n    install/treepy-0.1.1: byte-compiling for emacs\n    Install elpa-dash for emacs\n    install/dash-2.14.1: Handling install of emacsen flavor emacs\n    install/dash-2.14.1: byte-compiling for emacs\n    Install elpa-let-alist for emacs\n    install/let-alist-1.0.5: Handling install of emacsen flavor emacs\n    install/let-alist-1.0.5: byte-compiling for emacs\n    Install elpa-with-editor for emacs\n    install/with-editor-2.6.0: Handling install of emacsen flavor emacs\n    install/with-editor-2.6.0: byte-compiling for emacs\n    Install elpa-ghub for emacs\n    install/ghub-3.0.0: Handling install of emacsen flavor emacs\n    install/ghub-3.0.0: byte-compiling for emacs\n    Install elpa-git-commit for emacs\n    install/git-commit-2.90.1: Handling install of emacsen flavor emacs\n    install/git-commit-2.90.1: byte-compiling for emacs\n    Setting up git-el (1:2.20.1-2) ...\n    Install git for emacs\n    Install git for emacs\n    Setting up emacs (1:26.1+1-3.2) ...\n    Setting up libmodule-implementation-perl (0.09-1) ...\n    Setting up libpackage-stash-perl (0.38-1) ...\n    Setting up apache2 (2.4.38-3) ...\n    Enabling module mpm_event.\n    Enabling module authz_core.\n    Enabling module authz_host.\n    Enabling module authn_core.\n    Enabling module auth_basic.\n    Enabling module access_compat.\n    Enabling module authn_file.\n    Enabling module authz_user.\n    Enabling module alias.\n    Enabling module dir.\n    Enabling module autoindex.\n    Enabling module env.\n    Enabling module mime.\n    Enabling module negotiation.\n    Enabling module setenvif.\n    Enabling module filter.\n    Enabling module deflate.\n    Enabling module status.\n    Enabling module reqtimeout.\n    Enabling conf charset.\n    Enabling conf localized-error-pages.\n    Enabling conf other-vhosts-access-log.\n    Enabling conf security.\n    Enabling conf serve-cgi-bin.\n    Enabling site 000-default.\n    info: Executing deferred 'a2enconf gitweb' for package gitweb\n    Enabling conf gitweb.\n    Created symlink /etc/systemd/system/multi-user.target.wants/apache2.service → /lib/systemd/system/apache2.service.\n    Created symlink /etc/systemd/system/multi-user.target.wants/apache-htcacheclean.service → /lib/systemd/system/apache-htcacheclean.service.\n    insserv: warning: current start runlevel(s) (empty) of script `apache-htcacheclean' overrides LSB defaults (2 3 4 5).\n    insserv: warning: current stop runlevel(s) (0 1 2 3 4 5 6) of script `apache-htcacheclean' overrides LSB defaults (0 1 6).\n    Setting up elpa-async (1.9.3-1) ...\n    Install emacsen-common for emacs\n    emacsen-common: Handling install of emacsen flavor emacs\n    Install elpa-async for emacs\n    install/async-1.9.3: Handling install of emacsen flavor emacs\n    install/async-1.9.3: byte-compiling for emacs\n    Setting up elpa-magit-popup (2.12.5-1) ...\n    tsort: -: input contains a loop:\n    tsort: elpa-async\n    tsort: emacsen-common\n    tsort: -: input contains a loop:\n    tsort: elpa-dash\n    tsort: emacsen-common\n    Install elpa-async for emacs\n    install/async-1.9.3: Handling install of emacsen flavor emacs\n    install/async-1.9.3: byte-compiling for emacs\n    Install elpa-dash for emacs\n    install/dash-2.14.1: Handling install of emacsen flavor emacs\n    install/dash-2.14.1: byte-compiling for emacs\n    Install emacsen-common for emacs\n    emacsen-common: Handling install of emacsen flavor emacs\n    Install elpa-magit-popup for emacs\n    install/magit-popup-2.12.5: Handling install of emacsen flavor emacs\n    install/magit-popup-2.12.5: byte-compiling for emacs\n    Setting up elpa-magit (2.90.1-2) ...\n    tsort: -: input contains a loop:\n    tsort: elpa-dash\n    tsort: emacsen-common\n    tsort: -: input contains a loop:\n    tsort: elpa-ghub\n    tsort: emacsen-common\n    tsort: -: input contains a loop:\n    tsort: elpa-git-commit\n    tsort: emacsen-common\n    tsort: elpa-with-editor\n    tsort: -: input contains a loop:\n    tsort: elpa-git-commit\n    tsort: emacsen-common\n    tsort: -: input contains a loop:\n    tsort: emacsen-common\n    tsort: elpa-magit-popup\n    tsort: -: input contains a loop:\n    tsort: elpa-with-editor\n    tsort: emacsen-common\n    Install elpa-async for emacs\n    install/async-1.9.3: Handling install of emacsen flavor emacs\n    install/async-1.9.3: byte-compiling for emacs\n    Install elpa-graphql for emacs\n    install/graphql-0.1.1: Handling install of emacsen flavor emacs\n    install/graphql-0.1.1: byte-compiling for emacs\n    Install elpa-let-alist for emacs\n    install/let-alist-1.0.5: Handling install of emacsen flavor emacs\n    install/let-alist-1.0.5: byte-compiling for emacs\n    Install elpa-treepy for emacs\n    install/treepy-0.1.1: Handling install of emacsen flavor emacs\n    install/treepy-0.1.1: byte-compiling for emacs\n    Install git for emacs\n    Install git for emacs\n    Install elpa-dash for emacs\n    install/dash-2.14.1: Handling install of emacsen flavor emacs\n    install/dash-2.14.1: byte-compiling for emacs\n    Install elpa-ghub for emacs\n    install/ghub-3.0.0: Handling install of emacsen flavor emacs\n    install/ghub-3.0.0: byte-compiling for emacs\n    Install elpa-git-commit for emacs\n    install/git-commit-2.90.1: Handling install of emacsen flavor emacs\n    install/git-commit-2.90.1: byte-compiling for emacs\n    Install elpa-with-editor for emacs\n    install/with-editor-2.6.0: Handling install of emacsen flavor emacs\n    install/with-editor-2.6.0: byte-compiling for emacs\n    Install emacsen-common for emacs\n    emacsen-common: Handling install of emacsen flavor emacs\n    Install elpa-magit-popup for emacs\n    install/magit-popup-2.12.5: Handling install of emacsen flavor emacs\n    install/magit-popup-2.12.5: byte-compiling for emacs\n    Install elpa-magit for emacs\n    install/magit-2.90.1: Handling install of emacsen flavor emacs\n    install/magit-2.90.1: byte-compiling for emacs\n    Setting up libspecio-perl (0.43-1) ...\n    Setting up libparams-validate-perl (1.29-1+b1) ...\n    Setting up libb-hooks-endofscope-perl (0.24-1) ...\n    Setting up libnamespace-clean-perl (0.27-1) ...\n    Setting up libnamespace-autoclean-perl (0.28-1) ...\n    Setting up libdatetime-locale-perl (1:1.23-1) ...\n    Setting up libdatetime-timezone-perl (1:2.23-1+2019a) ...\n    Setting up libdatetime-perl:amd64 (2:1.50-1+b1) ...\n    Setting up libdatetime-format-strptime-perl (1.7600-1) ...\n    Setting up libdatetime-format-builder-perl (0.8100-2) ...\n    Setting up libdatetime-format-iso8601-perl (0.08-2) ...\n    Setting up git-mediawiki (1:2.20.1-2) ...\n    Processing triggers for install-info (6.5.0.dfsg.1-4+b1) ...\n    Processing triggers for menu (2.1.47+b1) ...\n    Processing triggers for desktop-file-utils (0.23-4) ...\n    Processing triggers for mime-support (3.62) ...\n    Processing triggers for hicolor-icon-theme (0.17-2) ...\n    Processing triggers for libglib2.0-0:amd64 (2.58.3-2) ...\n    Processing triggers for libc-bin (2.28-10) ...\n    Processing triggers for systemd (241-5) ...\n    Processing triggers for man-db (2.8.5-2) ...\n    Processing triggers for qubes-core-agent (4.0.45-1+deb10u1) ...\n    Processing triggers for dbus (1.12.16-1) ...\n    Setting up tcl (8.6.9+1) ...\n    Setting up tk (8.6.9+1) ...\n    Setting up git-gui (1:2.20.1-2) ...\n    Setting up gitk (1:2.20.1-2) ...\n    Setting up git-all (1:2.20.1-2) ...\n    Errors were encountered while processing:\n     exim4-config\n     exim4-base\n     exim4-daemon-light\n    E: Sub-process /usr/bin/dpkg returned an error code (1)\n    user@host:~$ sudo apt install git-all \n    Reading package lists... Done\n    Building dependency tree       \n    Reading state information... Done\n    git-all is already the newest version (1:2.20.1-2).\n    The following packages were automatically installed and are no longer required:\n      acl bsdtar curl-scripts fuse gdisk gpg-bash-lib gvfs-common gvfs-libs inotify-tools libarchive-tools libatasmart4\n      libblockdev-fs2 libblockdev-loop2 libblockdev-part-err2 libblockdev-part2 libblockdev-swap2 libblockdev-utils2\n      libblockdev2 libfuse2 libgck-1-0 libgcr-base-3-1 libinotifytools0 libntfs-3g883 libparted-fs-resize0\n      libpolkit-agent-1-0 libpolkit-backend-1-0 libpolkit-gobject-1-0 libudisks2-0 ntfs-3g pv spectre-meltdown-checker\n      virt-what vrms wmctrl\n    Use 'sudo apt autoremove' to remove them.\n    0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.\n    3 not fully installed or removed.\n    After this operation, 0 B of additional disk space will be used.\n    Do you want to continue? [Y/n] y\n    Setting up exim4-config (4.92-7) ...\n    /usr/sbin/update-exim4.conf: 467: /usr/sbin/update-exim4.conf: /usr/sbin/exim4: Operation not permitted\n    Invalid new configfile /var/lib/exim4/config.autogenerated.tmp, not installing \n    /var/lib/exim4/config.autogenerated.tmp to /var/lib/exim4/config.autogenerated\n    dpkg: error processing package exim4-config (--configure):\n     installed exim4-config package post-installation script subprocess returned error exit status 1\n    dpkg: dependency problems prevent configuration of exim4-base:\n     exim4-base depends on exim4-config (>= 4.82) | exim4-config-2; however:\n      Package exim4-config is not configured yet.\n      Package exim4-config-2 is not installed.\n      Package exim4-config which provides exim4-config-2 is not configured yet.\n\n    dpkg: error processing package exim4-base (--configure):\n     dependency problems - leaving unconfigured\n    dpkg: dependency problems prevent configuration of exim4-daemon-light:\n     exim4-daemon-light depends on exim4-base (>= 4.92); however:\n      Package exim4-base is not configured yet.\n\n    dpkg: error processing package exim4-daemon-light (--configure):\n     dependency problems - leaving unconfigured\n    Errors were encountered while processing:\n     exim4-config\n     exim4-base\n     exim4-daemon-light\n    E: Sub-process /usr/bin/dpkg returned an error code (1)\n    user@host:~$ \n```\n\n-----\n\n`remove qubes-core-agent dependency on initscripts`\nhttps://github.com/QubesOS/qubes-issues/issues/5133\n\n","comments":[{"author":"Patrick","date_created":1561329003,"date_modified":1561329003,"content":"Workaround:\nWhile this should be fixed, note, meanwhile the following works perfectly well for general use of `git` (I did not ever had any situation where I was missing any features):\n\n    sudo apt install git"},{"author":"Patrick","date_created":1561329153,"date_modified":1561329153,"content":"Another workaround:\n\n    sudo apt install git-all --no-install-recommends\n"},{"author":"Patrick","date_created":1561329475,"date_modified":1561329475,"content":"Another workaround with full `git-all` functionality that does not break Whonix:\n\n    sudo apt install git-all runit-systemd\n"},{"author":"Patrick","date_created":1561329740,"date_modified":1561329740,"content":"`git-all` also breaks Qubes Debian buster template. @marmarek \n\n    user@debian-10:~$ sudo apt install git-all\n\n```\n...\nThe following packages will be REMOVED:\n  colord dbus-user-session gnome-sushi gvfs gvfs-backends gvfs-daemons\n  libpam-systemd nautilus network-manager network-manager-gnome packagekit\n  packagekit-tools policykit-1 policykit-1-gnome\n  qubes-core-agent-network-manager qubes-vm-recommended rtkit systemd-sysv\n  udisks2\n...\n```\n"},{"author":"Patrick","date_created":1561330363,"date_modified":1561330363,"content":"`git-all` `Recommends:` `git-daemon-run`.\n\n`git-daemon-run` `Depends:` on `runit`.\n\n`runit` `Recommends:` `runit-sysv`.\n\n`runit-sysv` is incompatible with Whonix and Qubes Debian template. Even `sudo apt install runit-sysv --no-install-recommends` would uninstall some Whonix or Qubes packages.\n\nIt is because `runit-sysv` `Depends:` on `sysvinit-core`, which `Conflicts:` with `systemd-sysv`.\n\n`systemd-sysv` `Depends:` on `systemd`.\n\nSome of Whonix / Qubes packages `Depends:` on `systemd`.\n\nA workaround could be installing package `runit-systemd` by default but I don't know yet what it does so in theory it could cause more issues than it solves.\n\nClean solution (even if theoretic)...?:\n\n* Maybe Whonix / Qubes packages having a `Depends:` on `systemd` is considered a bug?\n* Perhaps this could be a Debian packaging bug? Maybe they'd say that's just the limitations of APT and the sysadmin has to deal with these for example by using `--no-install-recommends`?"},{"author":"TNTBOMBOM","date_created":1564061581,"date_modified":1564062281,"content":"~~but it doesnt happen on plain debian-qubes template , any idea why?~~\n\nActually it did , just tested again. So o think leaving systemd dependency better. \n\n"},{"author":"Patrick","date_created":1564067291,"date_modified":1564067291,"content":"`remove qubes-core-agent dependency on initscripts`\nhttps://github.com/QubesOS/qubes-issues/issues/5133\n"},{"author":"Patrick","date_created":1670517725,"date_modified":1670517725,"content":"No longer an issue in Whonix 16."}]},"PHID-TASK-t23kc2opojovnfey2fhn":{"id":"920","title":"consider /etc/xdg/xfce4/ defaults","status":"open","priority":"Normal","author":"Patrick","description":"Most of these files are also in Debian packages.\n\nPackage xfce4-session also owns file\n\n`/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfce4-session.xml`\n\nPackage xfce4-settings also owns file:\n\n`/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xsettings.xml`\n\nPackage lxqt-common also owns file:\n\n`/etc/xdg/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml` \t\n\netc.\n\nTherefore consider the Debian defaults.\n\nhttps://github.com/Whonix/whonix-xfce-desktop-config/tree/master/etc/skel/.config/xfce4\n\nhttps://github.com/Whonix/security-misc/blob/master/etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/thunar.xml","comments":[]},"PHID-TASK-gl3dqztsvc25tcc6bl2v":{"id":"919","title":"Whonix Live Branding","status":"testbuild","priority":"Normal","author":"Patrick","description":"* http://forums.whonix.org/t/whonix-host-operating-system/3931/64\n* https://forums.whonix.org/t/whonix-host-calamares-branding-suggestion/7772/7\n\n@Onion_Knight \n\n> Regarding branding, actually very easy, all files live in `/etc/calamares/branding/debian/` (with package `calamares-settings-debian` installed).\n> \n> Just need to modify the .png files and the config file accordingly: `/etc/calamares/branding/debian/branding.desc`\n","comments":[{"author":"Patrick","date_created":1584001793,"date_modified":1584001793,"content":"https://forums.whonix.org/t/whonix-host-calamares-branding-suggestion/7772/8"}]},"PHID-TASK-kdx7nlvwdtk62eu6y4ia":{"id":"918","title":"mediawiki extensions to install for better links","status":"resolved","priority":"Normal","author":"Patrick","description":"https://www.mediawiki.org/wiki/Extension:ArchiveLinks\nhttps://www.mediawiki.org/wiki/Extension:WebCache\nhttps://www.mediawiki.org/wiki/Extension:LinkToArchive\nhttps://www.mediawiki.org/wiki/Extension:RottenLinks\nhttps://www.mediawiki.org/wiki/Extension:LinkSuggest","comments":[{"author":"Patrick","date_created":1572878018,"date_modified":1572878018,"content":"> https://www.mediawiki.org/wiki/Extension:RottenLinks\n\nInstalled. See:\n\nhttps://www.whonix.org/wiki/Special:RottenLinks\n\n> https://www.mediawiki.org/wiki/Extension:LinkSuggest\n\nInstalled. See screenshot on how to use:\n\n https://upload.wikimedia.org/wikipedia/mediawiki/5/56/LinkSuggestExample.png\n\n> https://www.mediawiki.org/wiki/Extension:ArchiveLinks\n\nFrom 2011. syn only. Not git. Didn't bother trying.\n\n> https://www.mediawiki.org/wiki/Extension:WebCache\n\nLink to github offline.\n\n> https://www.mediawiki.org/wiki/Extension:LinkToArchive\n\nInstalled. It does not actually archive links. It adds an `[archive]` link behind all external links. Clicking on it will show that some of them are indeed archived. Others can be archived if we instruct web archive of doing so. This is a manual process."}]},"PHID-TASK-kmwzdkkklbudumelczjm":{"id":"917","title":"whonix.org server SSL settings enhancement","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/dns-certification-authority-authorization-caa-policy-dnssec-for-whonix-org-ssllabs-com-test-results/5487/5\n\n@TNTBOMBOM \n\n> TLS 1.1 and CBC cipher considered weak now better to be deprecated for security reasons: \n> \n> https://www.ssllabs.com/ssltest/analyze.html?d=deb.whonix.org&s=95.216.25.250&latest\n> \n> Also now TLS 1.3 available with Lets Encrypt, is it good idea to support it ? \n> \n> https://kinsta.com/blog/tls-1-3/\n\n\n","comments":[{"author":"Patrick","date_created":1639061130,"date_modified":1639061130,"content":"This was done a long time ago."}]},"PHID-TASK-unh27zmxrdwp5zjhqcxw":{"id":"916","title":"improve sdwdate connectivity check","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/helper-scripts/blob/master/usr/lib/helper-scripts/te_pe_tb_check needs to be split.\n\n#sdwdate should not (as currently) just call `/usr/lib/helper-scripts/te_pe_tb_check` but needs to be internally aware of different states such as \"Tor not enabled yet\" vs \"Tor bootstrap in progress\" vs \"Tor bootstrap failed\".","comments":[{"author":"Patrick","date_created":1610202878,"date_modified":1610202878,"content":"No longer required. Was implemented through te_pe_tb_check enhancements."}]},"PHID-TASK-i6pbp6fhva6qwteipoik":{"id":"915","title":"sdwdate connectivity check host support","status":"open","priority":"Normal","author":"Patrick","description":"https://github.com/Kicksecure/helper-scripts/blob/master/usr/libexec/helper-scripts/te_pe_tb_check\n\n\n```\n   if [ -f \"/usr/share/anon-gw-base-files/gateway\" ]; then\n      VM=\"Gateway\"\n   elif [ -f \"/usr/share/anon-ws-base-files/workstation\" ]; then\n      VM=\"Workstation\"\n   else\n      VM=\"Could not determine if this is gateway or workstation. Please report this bug.\"\n   fi\n```\n\n\n```\n if [ \"$VM\" = \"Gateway\" ]; then\n```","comments":[]},"PHID-TASK-zyooer26fhdajrbqbi7f":{"id":"914","title":"Whonix Host Live - enable KVM readonly mode - virt-xml vm-name --edit --disk readonly=on","status":"resolved","priority":"Normal","author":"Patrick","description":"http://forums.whonix.org/t/whonix-host-operating-system/3931/80\n\n@HulaHoop\n\n> Dug around on how to modify XML settings on the fly via cli. Other options were too messy or required manual editing which are useless for scripting.\n> \n>     sudo virt-xml Whonix-Workstation --edit --disk readonly=on\n> \n> readonly takes values on/off\n> \n> I am not sure whonix-libvirt is the ideal place for detection of live mode and the adjustment of image write options. Perhaps the grub-live package is a better place. \n> \n> However wouldn't doing this break VM usage since ro-mode-init is not our first choice for using it?\n\n","comments":[{"author":"Patrick","date_created":1566222309,"date_modified":1566222309,"content":"@Onion_Knight :\n\nhttps://forums.whonix.org/t/whonix-desktop-installer-with-calamares-field-report/7350/109\n\n> By default, the VMs do not start because the virtual disks are not set to readonly. This is only needed when using the ISO though. Might stay this way as long as the user is correctly advised to change to set the disk to readonly mode.\n\nI can invent a systemd unit file which detects if being run in live mode, and if so, set VM disks to readonly mode. Will add to #whonix-libvirt package unless better suggestions."},{"author":"Patrick","date_created":1566369484,"date_modified":1566369484,"content":"For the record, this is the diff being generated.\n\n```\ndiff --git a/qemu/Whonix-Workstation.xml b/qemu/Whonix-Workstation.xml\nindex edce9b1..749ae6e 100644\n--- a/qemu/Whonix-Workstation.xml\n+++ b/qemu/Whonix-Workstation.xml\n@@ -52,7 +52,6 @@ or other application using the libvirt API.\n       <driver name='qemu' type='qcow2'/>\n       <source file='/var/lib/libvirt/images/Whonix-Workstation.qcow2'/>\n       <target dev='vda' bus='virtio'/>\n-      <readonly/>\n       <address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/>\n     </disk>\n     <controller type='virtio-serial' index='0'>\n```"},{"author":"Patrick","date_created":1566371599,"date_modified":1566371599,"content":"Implemented.\n\nhttps://github.com/Whonix/whonix-libvirt/commit/bb7773e62850fdc76b794500e6bb0c282a55bb2b\n\nShould work on manual invocation.\n\n    sudo /lib/systemd/system/whonix-libvirt-set-live-to-readonly.service\n\nIf it gets actually automatically started by systemd at boot is untested.\n\nDoes\n\n    cat /proc/cmdline\n\nshow `boot=live`?\n\nThe pipe \"`|`\" in `ConditionKernelCommandLine=|boot=live` isn't a mistake. It means triggering condition.\n\nIn next build please try:\n\n    sudo systemctl status whonix-libvirt-set-live-to-readonly.service\n"},{"author":"onion_knight2","date_created":1584276704,"date_modified":1584276704,"content":"It seems that https://github.com/Whonix/whonix-libvirt/blob/master/usr/lib/whonix-libvirt/live-mode-to-read-only is not ran by root. Thus it cannot get the virsh list --all (returns void) nor change the VM xml configuration file.\n\nWe can already change\n\n```\nvm_names_list=\"$(virsh list --all | awk '{print $2}'| grep -v Name)\"\n\n```\nto\n```\nvm_names_list=\"$(virsh -c qemu:///system list --all | awk '{print $2}'| grep -v Name)\"\n```\nto get the VM list. But  I don't know how to safely get root to run the command  \n```\nvirt-xml \"$vm_name_item\" --edit --disk readonly=on \n```\n?"},{"author":"Patrick","date_created":1584279476,"date_modified":1584279476,"content":"Pretty sure it is run by root.\n\nhttps://github.com/Whonix/whonix-libvirt/blob/master/lib/systemd/system/whonix-libvirt-set-live-to-readonly.service\n\nThat's systemd default.\n(Unless `User=` is set which is not.)\n\nI'll add a `whoami` for debugging purposes.\n\nBut maybe it shouldn't be run by root but as user `user`?\n\nAlso should https://github.com/Whonix/whonix-libvirt/blob/master/usr/lib/whonix-libvirt/install run as root or user `user` I guess as user `user` because https://www.whonix.org/wiki/KVM does \"seldom use sudo\".\n\nAlso created https://forums.whonix.org/t/help-welcome-kvm-development-staying-the-course/166/401 for it."},{"author":"onion_knight2","date_created":1584281371,"date_modified":1584281371,"content":"Yes, it should be run by root. Maybe it is run by root but somehow the changes don't take place as they should. More debugging could help. "},{"author":"onion_knight2","date_created":1584287067,"date_modified":1584287371,"content":"I added whoami in the script and it confirmed it runs as root.\n\n\n```\nsudo systemctl status whonix-libvirt-set-live-to-readonly.service\n```\nis \"succeeded\". But it still doesn't work...\n\nIt works only if I run it manually.\n\nEDIT: I think I know what the problem is:\nwhonix-libvirt-set-live-to-readonly.service fails to retrieve the domain names as it appears to be run BEFORE whonix-libvirt-install.service which sets the domain names..."},{"author":"onion_knight2","date_created":1584289337,"date_modified":1584289337,"content":"Fixed by adding\n\n\n```\nAfter=whonix-libvirt-install.service\n```\nin https://github.com/Whonix/whonix-libvirt/blob/master/lib/systemd/system/whonix-libvirt-set-live-to-readonly.service\n(under [Unit]).\nPull request: https://github.com/Whonix/whonix-libvirt/pull/109"},{"author":"Patrick","date_created":1584303189,"date_modified":1584303189,"content":"Good catch! Merged.\n\nI guess images will be set to kvm images read-only when booted in live iso mode (and probably live mode too). But once installed, images are still set to live mode. That would be probably kvm images read-only is set when run in iso live mode, cached in RAM and then installed to local disk?\n\nHow to solve this? Set to read-write when booting in non-live mode? That seems intrusive and might lead to things teh user does not want.\n\nIf that is the case, maybe at the end of calamares we need to run a script in chroot (same script with new paramater support?) that sets images in chroot (installed system on disk) to read-write?"},{"author":"onion_knight2","date_created":1584305131,"date_modified":1584305131,"content":"> I guess images will be set to kvm images read-only when booted in live iso mode (and probably live mode too). But once installed, images are still set to live mode. That would be probably kvm images read-only is set when run in iso live mode, cached in RAM and then installed to local disk?\n\nMmm I'm not sure, let me try it out to verify how it works.\n\n\n> If that is the case, maybe at the end of calamares we need to run a script in chroot (same script with new paramater support?) that sets images in chroot (installed system on disk) to read-write?\n\nThat seems a reasonable option, yes.\n\n"},{"author":"onion_knight2","date_created":1584314399,"date_modified":1584314461,"content":"There are two read-only parameters:\n\n* read-only permissions (0444) of  Whonix VMs files set by https://github.com/Whonix/whonix-libvirt/blob/master/usr/lib/whonix-libvirt/install\n* read-only KVM paramaters set by https://github.com/Whonix/whonix-libvirt/blob/master/lib/systemd/system/whonix-libvirt-set-live-to-readonly.service\n\nWhen both are set Whonix VMs work (as of now with last commit) if in live-boot AND in live-mode (meaning live-mode has to be chosen for them too at grub menu when they are booted).\n\nAs expected, this behavior is currently copied over during the installation on a persistent drive (Calamares installer, I have just tried it).\n\nAs a result, once the user boots an installed version of Whonix-Host, he has to manually revert these ro paramaters to rw in order to have working Whonix VMs. Not practical/user-friendly.\n\nI agree that a solution would probably to run some kind of script at the end of the Calamares installtion to revert ro to rw.\n\n"},{"author":"Patrick","date_created":1584343372,"date_modified":1584343372,"content":"> I agree that a solution would probably to run some kind of script at the end of the Calamares installtion to revert ro to rw.\n\nCreated:\nhttps://github.com/Whonix/whonix-libvirt/blob/master/usr/lib/whonix-libvirt/persistent-mode-to-read-write\n\nMy idea was: keep the virtualizer specific scripts in the virtualizer specific package `whonix-libvirt`. The (calamares) hook script which calls that script can be added to package `live-config-dist`.\n\n>>! In T914#19538, @onion_knight2 wrote:\n> There are two read-only parameters:\n\nGood catch. Would have forgotten about the next one and figured out later.\n\n> * read-only permissions (0444) of  Whonix VMs files set by https://github.com/Whonix/whonix-libvirt/blob/master/usr/lib/whonix-libvirt/install\n\nI think that is only here:\nhttps://github.com/Whonix/Whonix/blob/master/build-steps.d/1800_copy_vms_into_raw#L35\n\n----\n\nIn summary, related files, implementation so far:\n\n* https://github.com/Whonix/Whonix/blob/master/build-steps.d/1800_copy_vms_into_raw#L35\n* https://github.com/Whonix/whonix-libvirt/blob/master/usr/lib/whonix-libvirt/live-mode-to-read-only\n* https://github.com/Whonix/whonix-libvirt/blob/master/usr/lib/whonix-libvirt/persistent-mode-to-read-write\n* calamares hook script remains todo.\n\nThere might be an issue. There is a [[ https://forums.whonix.org/t/whonix-host-operating-system/3931/180?u=patrick | reason ]] why write access (previously chmod 444) was removed during build in chroot, right? If I remember right, reason being setting chmod in iso live mode boot results the whole image to be modified in RAM? \n\nThen what about hdd live mode boot? Does this issue apply there too?\n\nI.e. we need to keep all boot modes in mind.\n\n* `iso live mode boot`\n* `installed disk live mode boot`\n* `installed disk persistent mode boot`\n\nThis implementation path might not work for `installed disk live mode boot`?"},{"author":"onion_knight2","date_created":1584373645,"date_modified":1584373645,"content":"> I think that is only here:\n> https://github.com/Whonix/Whonix/blob/master/build-steps.d/1800_copy_vms_into_raw#L35\n\nYes, my mistake. Only here.\n\n\n\n> There might be an issue. There is a reason why write access (previously chmod 444) was removed during build in chroot, right? If I remember right, reason being setting chmod in iso live mode boot results the whole image to be modified in RAM?\n\n\nYes.\n\n\n\n> Then what about hdd live mode boot? Does this issue apply there too?\n>This implementation path might not work for installed disk live mode boot?\n\nI don't know. Not implemented yet. Currently installed (persistent) Whonix-Host does not have live-boot option.\n\nTo sum up, we still need a calamares hook script to run https://github.com/Whonix/whonix-libvirt/blob/master/usr/lib/whonix-libvirt/persistent-mode-to-read-write at the end of installation, right?\n\n"},{"author":"Patrick","date_created":1584447557,"date_modified":1584447557,"content":">>! In T914#19541, @onion_knight2 wrote:\n> I don't know. Not implemented yet. Currently installed (persistent) Whonix-Host does not have live-boot option.\n\nCreated for it:\n\n* https://forums.whonix.org/t/whonix-host-operating-system/3931/189\n* https://forums.whonix.org/t/running-live-host-via-grub-live/8912\n\n> To sum up, we still need a calamares hook script to run https://github.com/Whonix/whonix-libvirt/blob/master/usr/lib/whonix-libvirt/persistent-mode-to-read-write at the end of installation, right?\n\nYes.\n\n(Though, Whonix-Host installed live mode might not have VMs with right read-only settings.)\n\nDo you know how to run calamares hook scripts? I think I saw this before but I can't find it anymore. Or we have to invent our own mini calamares module similar to how package calamares-settings-debian invented new calamares modules?"},{"author":"onion_knight2","date_created":1584451541,"date_modified":1584451541,"content":"> Do you know how to run calamares hook scripts? I think I saw this before but I can't find it anymore. Or we have to invent our own mini calamares module similar to how package calamares-settings-debian invented new calamares modules?\n\nI don't know yet. Will look into that. "},{"author":"onion_knight2","date_created":1585257907,"date_modified":1585257907,"content":"As of 15.0.1.0.7, the following behavior is observed:\n\n\n\n  - Whonix-Host in ISO mode correctly sets the gw/ws VMs in read-only mode (kvm xml config files)\n  - Whonix-Host in ISO mode correctly sets the gw/ws image files permissions in read-only mode\n  - Whonix-Host in installed (persistent, post-Calamares) mode correctly unsets the gw/ws VMs read-only mode (kvm xml config files)\n  - Whonix-Host in installed (persistent, post-Calamares) mode fails to set correct permissions fpor gw/ws imafge files\n\n"},{"author":"Patrick","date_created":1585582048,"date_modified":1585582048,"content":"[1] There is currently no trigger (systemd unit file) to execute `/usr/lib/whonix-libvirt/persistent-mode-to-read-write`.\n\nYou could try to manually run:\n\n    sudo /usr/lib/whonix-libvirt/persistent-mode-to-read-write\n\nJust now added [1].\n\nhttps://github.com/Whonix/whonix-libvirt/blob/master/lib/systemd/system/whonix-libvirt-set-persistent-mode-to-read-write.service\n\nUntested. Not sure `ConditionKernelCommandLine=!boot=live` is going to work.\n\nThe exclamation mark `!` hopefully means \"do this only if `boot=live` kernel command line is not set\"."},{"author":"onion_knight2","date_created":1587431726,"date_modified":1587431726,"content":"**Some progress made as of Whonix-Host 15.0.1.2.7**:\n\n  - Whonix-Host in ISO mode correctly sets the gw/ws VMs in read-only mode (kvm xml config files)\n  - Whonix-Host in ISO mode correctly sets the gw/ws image files permissions in read-only mode\n  - Whonix-Host in installed (persistent, post-Calamares) mode correctly unsets the gw/ws VMs read-only mode (kvm xml config files)\n  - Whonix-Host in installed (persistent, post-Calamares) mode correctly sets rw permissions for gw/ws image files\n\n**However**,\n\n  - Installed Whonix-Host in live-mode fails to set correct ro permissions for gw/ws image files (but it does correctly set the gw/ws VMs in read-only mode (kvm xml config files))\n\n**Reason**: https://github.com/Whonix/whonix-libvirt/blob/master/lib/systemd/system/whonix-libvirt-set-live-to-readonly.service does not provide for setting gw/ws disk images to read-only since it is done during the build only.\n\nOn the installed host, this means that rw disk images are never set back to ro (440) permissions in live-mode once the installed host has been booted in persistent mode. Meaning, gw/ws VM are not usable in installed host booted in live-mode.\n\n**Solution**: adding (ideally when meeting condition: \"if rw permission, then...\")\n```\n\nchmod --verbose --recursive ugo-w \"/var/lib/libvirt/images/Whonix-Gateway.qcow2\"\nchmod --verbose --recursive ugo-w \"/var/lib/libvirt/images/Whonix-Workstation.qcow2\"\n```\n\nat the end of https://github.com/Whonix/whonix-libvirt/blob/master/lib/systemd/system/whonix-libvirt-set-live-to-readonly.service\n\n**Next problem**: this does not work as in live-mode changing a file permission means copying its content into the live overlay... which is impossible due to the size of the disk images...\n\n\n```\nuser@host:~$ sudo service whonix-libvirt-set-live-to-readonly status\n● whonix-libvirt-set-live-to-readonly.service - sets all libvirt VM disks to read-only when Live Mode is detected\n   Loaded: loaded (/lib/systemd/system/whonix-libvirt-set-live-to-readonly.service; enabled; vendor preset: enabled)\n   Active: failed (Result: exit-code) since Tue 2020-04-21 00:19:03 UTC; 1min 2s ago\n     Docs: https://github.com/Whonix/whonix-libvirt\n  Process: 670 ExecStart=/usr/lib/whonix-libvirt/live-mode-to-read-only (code=exited, status=1/FAILURE)\n Main PID: 670 (code=exited, status=1/FAILURE)\n\nApr 21 00:18:54 host live-mode-to-read-only[670]: chmod: changing permissions of '/var/lib/libvirt/images/Whonix-Gateway.qcow2': No space left on device\nApr 21 00:18:54 host live-mode-to-read-only[670]: failed to change mode of '/var/lib/libvirt/images/Whonix-Gateway.qcow2' from 0660 (rw-rw----) to 0440 (r--r-----)\nApr 21 00:18:54 host live-mode-to-read-only[670]: ++ error_handler\nApr 21 00:18:54 host live-mode-to-read-only[670]: ++ exit_code=1\nApr 21 00:18:54 host live-mode-to-read-only[670]: + chmod --verbose --recursive ugo-w /var/lib/libvirt/images/Whonix-Workstation.qcow2\nApr 21 00:19:03 host live-mode-to-read-only[670]: mode of '/var/lib/libvirt/images/Whonix-Workstation.qcow2' changed from 0660 (rw-rw----) to 0440 (r--r-----)\nApr 21 00:19:03 host live-mode-to-read-only[670]: + exit 1\nApr 21 00:19:03 host systemd[1]: whonix-libvirt-set-live-to-readonly.service: Main process exited, code=exited, status=1/FAILURE\nApr 21 00:19:03 host systemd[1]: whonix-libvirt-set-live-to-readonly.service: Failed with result 'exit-code'.\nApr 21 00:19:03 host systemd[1]: Failed to start sets all libvirt VM disks to read-only when Live Mode is detected.\n\n```\n\n**Workaround**: we could create a systemd service that runs in persistent mode only right before shutdown/reboot and would set back the gw/ws disk images permissions to read-only after each session in persistent mode. "},{"author":"Patrick","date_created":1587486514,"date_modified":1587486514,"content":"Awesome analysis and description!\n\n>>! In T914#19876, @onion_knight2 wrote:\n> **Next problem**: this does not work as in live-mode changing a file permission means copying its content into the live overlay... which is impossible due to the size of the disk images...\n\nMaybe this can be fixed. I.e. change mode of file and at the same time don't copy it all to the live overlay.\n\nhttps://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt has a chapter `Metadata only copy up`:\n\n> When metadata only copy up feature is enabled, overlayfs will only copy up metadata (as opposed to whole file), when a metadata specific operation like chown/chmod is performed. Full file will be copied up later when file is opened for WRITE operation.\n>\n> In other words, this is delayed data copy up operation and data is copied up when there is a need to actually modify data.\n>\n> There are multiple ways to enable/disable this feature.\n> [...]\n\nCould you have a look please?\n\n> **Workaround**: we could create a systemd service that runs in persistent mode only right before shutdown/reboot and would set back the gw/ws disk images permissions to read-only after each session in persistent mode. \n\nThat would be OK but this is not my preferred solution. Reason: an unclean shutdown in Whonix installed persistent mode would with a subsequent boot into live mode would result in a failed reboot into Whonix installed live mode."},{"author":"onion_knight2","date_created":1587494065,"date_modified":1587494236,"content":"> That would be OK but this is not my preferred solution. Reason: an unclean shutdown in Whonix installed persistent mode would with a subsequent boot into live mode would result in a failed reboot into Whonix installed live mode.\n\nYes, that is correct.\n\n\n\n> Maybe this can be fixed. I.e. change mode of file and at the same time don't copy it all to the live overlay.\n> \n> https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt has a chapter Metadata only copy up:\n\nVery interesting. And guess what... It works :)\n\nJust tried it on installed Whonix-Host 15.0.1.2.7.\n\nIn persistent mode, I created a module conf file, then updated the initramfs\n\n```\necho \"options overlay metacopy=on\" > /etc/modprobe.d/overlay.conf \nupdate-initramfs -u\n```\n\nRebooting in live-mode:\n\n```\nroot@host:~# chmod -v 440 /var/lib/libvirt/images/Whonix-Workstation.qcow2\nmode of '/var/lib/libvirt/images/Whonix-Workstation.qcow2' changed from 0660 (rw-rw----) to 0440 (r--r-----)\n```\nVM start normally!\nAnd cat /sys/module/overlay/parameters/metacopy shows Y instead of N:\n\n```\n\nroot@host:~# cat /sys/module/overlay/parameters/metacopy \nY\n```\n\nAwesome!\n\nReminder: let's not forget to still do\n\n> Solution: adding (ideally when meeting condition: \"if rw permission, then...\")\n> \n> chmod --verbose --recursive ugo-w \"/var/lib/libvirt/images/Whonix-Gateway.qcow2\"\n> chmod --verbose --recursive ugo-w \"/var/lib/libvirt/images/Whonix-Workstation.qcow2\"\n> \n> at the end of https://github.com/Whonix/whonix-libvirt/blob/master/lib/systemd/system/whonix-libvirt-set-live-to-readonly.service\n\n\nAlso found this warning in the documentation you referred to, is it something we should be afraid of?\n\n\n> \n> Do not use metacopy=on with untrusted upper/lower directories. Otherwise\n> it is possible that an attacker can create a handcrafted file with\n> appropriate REDIRECT and METACOPY xattrs, and gain access to file on lower\n> pointed by REDIRECT. This should not be possible on local system as setting\n> \"trusted.\" xattrs will require CAP_SYS_ADMIN. But it should be possible\n> for untrusted layers like from a pen drive.\n\n\n"},{"author":"Patrick","date_created":1587639682,"date_modified":1587639682,"content":"> ```\n> echo \"options overlay metacopy=on\" > /etc/modprobe.d/overlay.conf \n> update-initramfs -u\n> ```\n\nThis was implemented:\n\n* https://github.com/Whonix/live-config-dist/commit/e51112a722d98372c64f3543dda0e3b75f7ccaef\n* https://github.com/Whonix/live-config-dist/blob/master/etc/modprobe.d/30_live-config-dist.conf\n* https://github.com/Whonix/live-config-dist/blob/master/debian/live-config-dist.triggers\n\n> Very interesting. And guess what... It works :)\n\nAwesome!\n\nDid you try to boot / use the VMs? Because I just found something which might make this not work...\n\nQuote https://www.kernel.org/doc/Documentation/filesystems/overlayfs.txt\n\n> Full file will be copied up later when file is opened for WRITE operation.\n\nI guess there won't be a write operation since in Whonix-Host ISO mode or Whonix-Host installed Live-Mode, VMs needs to be booted into Live Mode too and then there would be not write operation.\n\n> Reminder: let's not forget to still do\n> \n>> Solution: adding (ideally when meeting condition: \"if rw permission, then...\")\n\nI guess you meant \"if ro (read-only) permission, then...\"?\n\n>> chmod --verbose --recursive ugo-w \"/var/lib/libvirt/images/Whonix-Gateway.qcow2\"\n>> chmod --verbose --recursive ugo-w \"/var/lib/libvirt/images/Whonix-Workstation.qcow2\"\n>> \n>> at the end of https://github.com/Whonix/whonix-libvirt/blob/master/lib/systemd/system/whonix-libvirt-set-live-to-readonly.service\n\nWas implemented (\"if ro (read-only) permission, then set libvirt images to read-only\"):\nhttps://github.com/Whonix/whonix-libvirt/commit/4680b30c634af3eaaa40db85eb47a034fb0fb957\n\n> Also found this warning in the documentation you referred to, is it something we should be afraid of?\n> \n> \n>> \n>> Do not use metacopy=on with untrusted upper/lower directories. Otherwise\n>> it is possible that an attacker can create a handcrafted file with\n>> appropriate REDIRECT and METACOPY xattrs, and gain access to file on lower\n>> pointed by REDIRECT. This should not be possible on local system as setting\n>> \"trusted.\" xattrs will require CAP_SYS_ADMIN. But it should be possible\n>> for untrusted layers like from a pen drive.\n\nGood to think through for sure. The threat model described I think is related to \"[untrusted root](https://forums.whonix.org/t/untrusted-root-improve-security-by-restricting-root/7998)\" (even though that term isn't widely established yet). Means users with CAP_SYS_ADMIN (for example root) could modify all overlay layers but that is the case anyhow. There might be threat models where root shall only be able to modify one layer but not a deeper layer.\n\n----\n\nAll of this is included in Whonix `15.0.1.3.0-developers-only` and untested."},{"author":"onion_knight2","date_created":1587651534,"date_modified":1587651534,"content":"Great news! I am rebuilding the whole package Host+gw+ws now, excited to test it out! Will report asap."},{"author":"onion_knight2","date_created":1589467643,"date_modified":1589467643,"content":"Seems I have quite a flexible notion of \"asap\" :)...\n\nAnyway, I have just rebuilt Host+gw+ws, 15.0.1.3.4-12.\n\nApparently everything went fine during the build, but the VMs don't boot into graphical target (stuck after GRUB bootloader, black screen with blinking white cursor). No output, even without the 'quiet' flag.\n\nProbably a temporary error with this specific build(?).\n\nChanging file permissions back and forth on the installed system still doesn't work. The installed system does not have the /etc/modprobe.d/30_live-config-dist.conf file that is however found on the ISO file. \n\nThe metacopy=on parameter is therefore not set on the installed system in live mode, which prevents to modify the VM file permissions (No space left on device):\n\n```\n\nroot@host:~# cat /sys/module/overlay/parameters/metacopy \nN\n```\n\n"},{"author":"Patrick","date_created":1589483498,"date_modified":1589483498,"content":">>! In T914#20017, @onion_knight2 wrote:\n> Seems I have quite a flexible notion of \"asap\" :)...\n\n:)\n\n> Apparently everything went fine during the build, but the VMs don't boot into graphical target (stuck after GRUB bootloader, black screen with blinking white cursor). No output, even without the 'quiet' flag.\n\nThat's probably because of T950. You'd need to remove both:\n\n    quiet loglevel=0\n\nAdded some enhancements to package #debug-misc just now. (T950#20021) Included in Whonix `15.0.1.3.5-developers-only`.\n\nIt would be possible to install package debug-misc. Either,\n\n* we can install it by default on Whonix-Host (and in VMs) for now. But then not forget to disable for stable releases. Cumbersome.\n* Or better add `install_package_list+=\" debug-misc \"` to [build configuration](https://www.whonix.org/wiki/Dev/Source_Code_Intro#Build_Configuration).\n\nExample... If this is your usual build command:\n\n    sudo ~/Whonix/whonix_build [...]\n\nMaybe easiest to change to:\n\n    sudo install_package_list+=\" debug-misc \" ~/Whonix/whonix_build [...]\n\n(The extra variable needs to be set after `sudo` but before `whonix_build` script.)\n\nOr by setting and environment variable and adding `-E` to sudo. I.e. `sudo -E`\n\n    export install_package_list+=\" debug-misc \"\n    sudo -E ~/Whonix/whonix_build [...]\n\nNot yet tested but will test soon.\n\nThe latter I will test now. Let me know which way to set this build variable is the most usable one of if there would be a more sane way to do this.\n\nPlease add your build commands to Whonix wiki [Dev/Whonix-Host](https://www.whonix.org/wiki/Dev/Whonix-Host), then I can add suggestion there how to improve these.\n\n> Probably a temporary error with this specific build(?).\n\nI don't see why.\n\n> Changing file permissions back and forth on the installed system still doesn't work. The installed system does not have the /etc/modprobe.d/30_live-config-dist.conf file that is however found on the ISO file. \n\nThat's because `/etc/modprobe.d/30_live-config-dist.conf` part of package #live-config-dist which is [removed](https://github.com/Whonix/live-config-dist/blob/master/etc/calamares/modules/packages.conf.dist#L7) during calamares. Maybe that is the bug?\n\nWould it be sane if `/etc/modprobe.d` `options overlay metacopy=on` was also set during persistent boot? Could you try that please? (I guess can be tested with any Debian or even Whonix.) If so, I would remove that file from package #live-config-dist and add to package #whonix-libvirt which is installed on both, Whonix-Host ISO and also Whonix-Host Installed.\n"},{"author":"onion_knight2","date_created":1589493952,"date_modified":1589493990,"content":"> \n> That's probably because of T950. You'd need to remove both:\n> \n> quiet loglevel=0\n> \nI see. But I won't lose time trying to debug this particular build, I will just try a new one and see if the problem persists. Had some problems with lack of space on the VM I am building with, maybe related. Not worth debugging if it's a one time thing. We'll see.\n\n\n\n\n> The latter I will test now. Let me know which way to set this build variable is the most usable one of if there would be a more sane way to do this.\n\n\n\nI prefer this command, as it is a one-liner:\n\n\n```\nsudo install_package_list+=\" debug-misc \" ~/Whonix/whonix_build [...]\n```\n\n\n\n> Please add your build commands to Whonix wiki Dev/Whonix-Host, then I can add suggestion there how to improve these.\n> \n\n\nNot sure what you mean here?\n\n\n\n> That's because /etc/modprobe.d/30_live-config-dist.conf part of package #live-config-dist which is removed during calamares. Maybe that is the bug?\n\nYes, most probably.\n\n\n> \n> Would it be sane if /etc/modprobe.d options overlay metacopy=on was also set during persistent boot?\n\nYes, I don't see why it wouldn't. Just tested it on a Debian 10 custom VM which also has live-mode. Works fine. As expected module option is only loaded if the overlay module is loaded.\nlive-boot -> overlay module loaded -> overlay module option activated\npersistent boot -> overlay module not loaded -> overlay module option not activated\n\nLooks sane to me!\n\n"},{"author":"Patrick","date_created":1589497554,"date_modified":1589497554,"content":">> Please add your build commands to Whonix wiki Dev/Whonix-Host, then I can add suggestion there how to improve these.\n>> \n> \n> \n> Not sure what you mean here?\n\nThe full `sudo install_package_list+=\" debug-misc \" ~/Whonix/whonix_build [...]` command. But not important. Maybe I am overthinking this. Maybe not too complex to warrant documenting this on the wiki.\n\n>> Would it be sane if /etc/modprobe.d options overlay metacopy=on was also set during persistent boot?\n> \n> Yes, I don't see why it wouldn't. Just tested it on a Debian 10 custom VM which also has live-mode. Works fine. As expected module option is only loaded if the overlay module is loaded.\n> live-boot -> overlay module loaded -> overlay module option activated\n> persistent boot -> overlay module not loaded -> overlay module option not activated\n> \n> Looks sane to me!\n\nMakes sense. Implemented.\n\n* https://github.com/Whonix/live-config-dist/commit/96b6b10c519b47eb29e21c92c01a22043077f018\n* https://github.com/Whonix/whonix-libvirt/commit/4b827db5496553d7f71d0ebf003fdfe3ceb1df87\n\nIncluded in `15.0.1.3.6-developers-only`."},{"author":"onion_knight2","date_created":1589497917,"date_modified":1589497917,"content":"Great! Will try to build tomorrow and report back... asap :)"},{"author":"onion_knight2","date_created":1589535772,"date_modified":1589536323,"content":"Just built 15.0.1.3.6-developers-only\n\nBut forgot to add sudo install_package_list+=\" debug-misc \"...\n\n**Good news**: ro/rw mode seems fixed! Correctly set back to 0440 when booting installed Whonix-Host on live-mode. Great!\n\n**Bad news**: booting virtual machines is very slow (on all boot modes and targets. Tested on KVM only, not real hardware).\n\nThey boot but are stuck for a few minutes at \n\n```\nEXT4-fs (vda1): mounted filesystem with ordered data mode.\n\n```\nbefore reaching the desktop environment.\n\nWhonix-Workstation:\n\n```\nStartup finished in 43.014s (kernel) + 3 min 6.816s (userspace) ⁼ 3min 49.831s \n```\n\nI thought maybe a  problem with the video settings, which are set to use \"Virtio\" (isn't it supposed to be QXL? don't remember). But changing the video model to \"QXL\" doesn't change anything.\n\nOutside of  Whonix-Host  Whonix-Workstation 15.0.1.3.6 booted on KVM on my main machine works normally.\n\n\n```\nStartup finished in 4.069s (kernel) + 8.549s (userspace) = 12.619s \ngraphical.target reached after 8.205s in userspace\n\n```\n\nDid we make any changes lately that could explain this behavior? Maybe some new kernel flag?\n\nAnyway this is not related to this particular topic. Maybe worth a new ticket (or not, if it doesn't happen on real hardware. Not supposed to be working fast in nested virtualization anyway)."},{"author":"Patrick","date_created":1589641556,"date_modified":1589641556,"content":"> But forgot to add sudo install_package_list+=\" debug-misc \"...\n\nWithout that will be hard to gather debug output.\n\nPerhaps [virtual serial console](https://www.whonix.org/wiki/KVM#Command_Line_Interface_.28CLI.29)?\n\n> **Bad news**: booting virtual machines is very slow (on all boot modes and targets. Tested on KVM only, not real hardware).\n\nPreviously wasn't the case? I guess nested virtualization will be unusable slow.\n\n> ```\n> EXT4-fs (vda1): mounted filesystem with ordered data mode.\n> \n> ```\n\nThat message is just a useless message, usability issue, hard to hide by default. From now,when anything goes wrong that line will be cited. Very most likely not the cause. Until a way if found to silence that too.\n\n> I thought maybe a  problem with the video settings, which are set to use \"Virtio\" (isn't it supposed to be QXL? don't remember). But changing the video model to \"QXL\" doesn't change anything.\n\nI don't have an opinion but here are most recent discussions / relevant references that I could find:\n\n* https://forums.whonix.org/t/make-screen-resolution-1920x1080-by-default-for-all-vms/9143/13\n* https://www.whonix.org/wiki/Dev/KVM#Virgl3D\n\n> Did we make any changes lately that could explain this behavior? Maybe some new kernel flag?\n\nNot that I know.\n\n> Anyway this is not related to this particular topic. Maybe worth a new ticket (or not, if it doesn't happen on real hardware. Not supposed to be working fast in nested virtualization anyway).\n\nYes, worth it. I guess lots of people are going to try Whonix-Host inside a virtual machine before considering installation on real hardware. That's why I even would like to have ability to run Whonix-Host inside VirtualBox.\n\nPlease post new tickets in forums as per:\nhttps://forums.whonix.org/t/abolishing-whonix-phabricator-issue-tracker-moving-issue-tracking-to-forums-migrating-phabricator-whonix-org-to-forums-whonix-org/7112\n\n----\n\nSomething left to do here?"},{"author":"onion_knight2","date_created":1589741677,"date_modified":1589741677,"content":"> Yes, worth it. I guess lots of people are going to try Whonix-Host inside a virtual machine before considering installation on real hardware. That's why I even would like to have ability to run Whonix-Host inside VirtualBox.\n> \n> Please post new tickets in forums as per:\n> https://forums.whonix.org/t/abolishing-whonix-phabricator-issue-tracker-moving-issue-tracking-to-forums-migrating-phabricator-whonix-org-to-forums-whonix-org/7112\n\nOk, see:\n\nhttps://forums.whonix.org/t/nested-virtualization-unbearably-slow-on-whonix-host-kvm/9550\n\n> Something left to do here?\n\nNo, I think we're good!\n"},{"author":"Patrick","date_created":1589743301,"date_modified":1589743301,"content":"Awesome!"}]},"PHID-TASK-vxju3gsnn2wvjdcpz7mj":{"id":"913","title":"bug: not all files form /etc/skel are copied to /home/user / create user \"user\" at boot time","status":"resolved","priority":"Normal","author":"Patrick","description":"This is important for #whonix_15 for non-live (!) as well as #live-mode.\n\nhttps://forums.whonix.org/t/bug-not-all-files-form-etc-skel-are-copied-to-home-user/6778/4\n\nhttp://forums.whonix.org/t/whonix-desktop-installer-with-calamares-field-report/7350/67\n\nUser `user` should not be created when booting in live mode since then `calamares` will do that. -> Maybe can be simplified? -> https://forums.whonix.org/t/whonix-desktop-installer-with-calamares-field-report/7350/78\n\nPotential solution:\n\n* http://blog.dailystuff.nl/2012/07/create-home-directory-on-first-login/\n* `sudo pam-auth-update --enable mkhomedir`\n\n----\n\n* https://github.com/Whonix/anon-base-files/blob/master/debian/anon-base-files.postinst\n\n* https://github.com/Whonix/whonix-base-files/blob/master/lib/systemd/system/whonix-base-files-skel-first-boot.service\n* https://github.com/Whonix/whonix-base-files/blob/master/usr/lib/anon-base-files/first-boot-skel\n\n----\n\n#Qubes specific considerations:\n\n>> Templates are always booted first before the user has a chance to start a templatebased VM?\n\n> Yes, part of the template installation process is starting it and launching `qubes.PostInstall` service.\n\n> Although there is no retry mechanism, if the first attempt fails (for example not enough memory).\n\n","comments":[{"author":"marmarek","date_created":1563227908,"date_modified":1563227908,"content":"Can you give some more context here? Is it the problem that `user` is created too early (before `/etc/skel` is fully populated)? Or is it a problem that it's created at all? Should there be a difference between Qubes and non-Qubes case?\n\nIn Qubes case, `user` is created by installing `qubes-core-agent` package. How is it done in non-Qubes case?\n\nIs requirement of not creating `user` (if I understand correctly) a limitation of `calamares`, or is there some good reason behind it? I see creating user at first-boot time (instead of build time) as unnecessary slowing down the process, and yet another place potentially resulting in unique per-installation identifiers being created."},{"author":"Patrick","date_created":1563230550,"date_modified":1563230550,"content":">>! In T913#18743, @marmarek wrote:\n> Can you give some more context here?\n\n> Is it the problem that `user` is created too early (before `/etc/skel` is fully populated)?\n\nYes.\n\n[1] `/etc/skel` is not fully populated by the time.\n\n[anon-base-files postinst](https://github.com/Whonix/anon-base-files/blob/master/debian/anon-base-files.postinst) (which creates user \"user\") runs at a \"random\" time. I.e. not at a fixed time. There is no mechanism to say \"install this package last - after all packages that write into /etc/skel have been installed\".\n\n> Or is it a problem that it's created at all?\n\nNot sure yet but possibly not.\n\n> Should there be a difference between Qubes and non-Qubes case?\n\nIdeally, not.\n\nAfter more research / testing I was considering to submit a pull request for qubes-core-agent linux maintainer scripts to make these configurable so these wouldn't create user `user` so this could be left to the derivative (here: Whonix). (Should be easy. \"If this file exists, skip this code.\")\n\nAlthough this wouldn't work perfectly. Since the template build process is roughly create Debian base image, Qubesify them, Whonixify them, there is no way Whonix could ship a config/status file to disable qubes-core-agent-linux user `user` creation. But not a big deal either. Some solution? Some existing environment variable? As fallback Whonix could also during build delete user `user` and/or home folder and then use its own code for that.\n\nSwitching the build process to create Debian base image, Whonixify them and Qubesify at the end may not be great either since then the Whonix packages can't easily detect it's going to be a Qubes environment or? A lot work, potential breakage?\n\n> In Qubes case, `user` is created by installing `qubes-core-agent` package. How is it done in non-Qubes case?\n\n[anon-base-files postinst](https://github.com/Whonix/anon-base-files/blob/master/debian/anon-base-files.postinst)\n\n> Is requirement of not creating `user` (if I understand correctly) a limitation of `calamares`, or is there some good reason behind it?\n\nCalamares was one, later added, reason but we might find a way to overcome that. (Trying to avoid a special case for that too.)\n\n[1] (`/etc/skel` is not fully populated at user `user` creation time) was the [original](https://forums.whonix.org/t/bug-not-all-files-form-etc-skel-are-copied-to-home-user/6778) and main reason for this ticket.\n\n> I see creating user at first-boot time (instead of build time) as unnecessary slowing down the process, and yet another place potentially resulting in unique per-installation identifiers being created.\n\nHm, good point. I didn't have that one in mind.\n\nIdeally, as much as possible the standard ways to do things can be utilized without any special cases Qubes vs non-Qubes. Having [custom /etc/skel to user home population code](https://github.com/Whonix/whonix-base-files/blob/master/usr/lib/anon-base-files/first-boot-skel) is really not great.\n\n----\n\nDo you see any issues with \"create home directory on first login\" in Qubes?\n\n* http://blog.dailystuff.nl/2012/07/create-home-directory-on-first-login/\n* `sudo pam-auth-update --enable mkhomedir`\n\nThat was my latest idea. Create user `user` with `--no-create-home` by default at build time and then \"create home directory on first login\".\n\nThe current [file list](https://forums.whonix.org/t/bug-not-all-files-form-etc-skel-are-copied-to-home-user/6778) shouldn't take more than a second to copy?\n\nUnique per-installation identifiers... What could that be? Different user id (`id user`) per installation?\n\nI was on a different train of thought: shipping without /home folder makes reproducible builds slightly easier since less files which are not owned by any package.\n\n----\n\nOr do you know any way to do \"install this package last\", so user `user` creation could be done after /etc/skel for sure is fully populated? It would be easy to do with a chroot script but we got rid of chroot scripts. Therefore [\"sudo apt install whonix\"](https://www.whonix.org/wiki/Dev/Installation_from_Repository) is now possible [and being done in the wild](https://forums.whonix.org/t/sudo-apt-get-install-whonix-part-i/2346/3)."},{"author":"marmarek","date_created":1563232036,"date_modified":1563232036,"content":">>! In T913#18744, @Patrick wrote:\n> Do you see any issues with \"create home directory on first login\" in Qubes?\n\nHmm, in fact, this is already the case. It is initialized from `/etc/skel` at VM first boot time. When initializing private volume. Looks like home dir created during template build time is moved to `/home.orig` and ignored. Artifact from <=R3.2 time when it was used to initialize actual home in private volume.\n\nAnd in fact it is a problem some times. If you have `whonix-15-dvm` and never started it, private volume will be empty. And will be initialized at every Whonix DisposableVM  start time. It caused such DisposableVMs to timeout during start, due to accumulated TB instances (https://github.com/QubesOS/qubes-issues/issues/4918). I'm not sure about good generic solution, other than \"don't put a lot of files in /etc/skel or other places used to initialize home dir\".\n\n> * http://blog.dailystuff.nl/2012/07/create-home-directory-on-first-login/\n> * `sudo pam-auth-update --enable mkhomedir`\n> \n> That was my latest idea. Create user `user` with `--no-create-home` by default at build time and then \"create home directory on first login\".\n\nMakes sense. Although in Qubes there is still a code to do that at proper time (after mounting /home, but before starting any user process). And also handle UID change that may happen if you switch template.\n\n> The current [file list](https://forums.whonix.org/t/bug-not-all-files-form-etc-skel-are-copied-to-home-user/6778) shouldn't take more than a second to copy?\n> \n> Unique per-installation identifiers... What could that be? Different user id (`id user`) per installation?\n\nMostly timestamps if you're not careful. But those will be different anyway, so probably can be ignored here. I was also thinking about some identifiers generated at application start time (like firefox profile id), but it is totally independent here: either those are included in `/etc/skel` and should be the same everywhere regardless of when it's copied. Or not included and will be different, also regardless of when home is initialized.\nIn short: not a problem.\n\n> I was on a different train of thought: shipping without /home folder makes reproducible builds slightly easier since less files which are not owned by any package.\n\nYes, makes sense.\n\n> Or do you know any way to do \"install this package last\", so user `user` creation could be done after /etc/skel for sure is fully populated? It would be easy to do with a chroot script but we got rid of chroot scripts. Therefore [\"sudo apt install whonix\"](https://www.whonix.org/wiki/Dev/Installation_from_Repository) is now possible [and being done in the wild](https://forums.whonix.org/t/sudo-apt-get-install-whonix-part-i/2346/3).\n\nIn RPM there is `%post` and `%posttrans`. The later is run after all requested packages are installed. Not sure if there is any Debian equivalent."},{"author":"Patrick","date_created":1582961161,"date_modified":1582961161,"content":"Works well in Non-Qubes-Whonix. Solution was this one:\n\nhttps://forums.whonix.org/t/bug-not-all-files-form-etc-skel-are-copied-to-home-user/6778/6\n\nWill re-open should this be a problem in Qubes-Whonix. But looks like Qubes doesn't mind about pam mkhomedir and the /etc/skel to /home/user code is functional."}]},"PHID-TASK-wf44kd73erw5oe453djg":{"id":"912","title":"qubes integration tools missing","status":"resolved","priority":"Normal","author":"Patrick","description":"@TNTBOMBOM \n\nhttps://forums.whonix.org/t/qubes-whonix-version-14-debian-stretch-based-can-be-upgraded-to-version-15-debian-buster-based-testers-wanted/7143/18\n\n> There are differences with whonix 14 and whonix 15 intigration with Qubes helping tools like opening files in disposableVM , Transfer/Copy Files between VMs ... look at the images:\n> \n> - Normal options for file.txt inside Qubes-Debian:\n> \nhttps://forums.whonix.org/uploads/default/original/2X/2/2390a319e48787095aa11a761b6d9d92e9285ada.png\n> \n> - Options missed in Whonix 15: \n> \nhttps://forums.whonix.org/uploads/default/original/2X/c/cb479a69c8e651797ce4918b88617bf95292c31e.png\n\n","comments":[{"author":"Patrick","date_created":1560504079,"date_modified":1560504079,"content":"Might be fixed with upgrades / (over) next Qubes-Whonix images.\n\nhttps://github.com/Whonix/qubes-whonix/commit/e8c9b106bd101f1f72280b42f2afce0656b53b09\nhttps://github.com/Whonix/qubes-whonix/commit/8d8ab41bbf9c7fa63f3e79b8511d439efe33caeb\n"},{"author":"Patrick","date_created":1561032199,"date_modified":1561032199,"content":"available:\n\n* Copy to VM\n* Move to VM\n* Create Archive...\n\nmissing:\n\n* Edit In DisposableVM\n* View In DisposableVM\n\nPackage qubes-core-agent-thunar is installed."},{"author":"Patrick","date_created":1561040307,"date_modified":1561040307,"content":"^\n\nAny idea why these are missing? @marmarek "},{"author":"marmarek","date_created":1561081812,"date_modified":1561081812,"content":"I cannot reproduce. I've installed qubes-template-whonix-15-4.0.1-201905241112, updated it with qubes testing repository enabled and I see all the actions available in thunar.\nBut I do see some warnings on thunar's stderr, like this:\n```\n(Thunar:27375): Gtk-WARNING **: 01:41:41.317: Refusing to add non-unique action 'uca-action-1507455450991127-4' to action group 'ThunarActions'\n```\nLooks like actions are added multiple times to `/etc/xdg/Thunar/uca.xml`, which is later copied to `/home/user/.cnfig/Thunar/uca.xml`. Relevant code in https://github.com/QubesOS/qubes-core-agent-linux/blob/master/debian/qubes-core-agent-thunar.postinst"},{"author":"Patrick","date_created":1561625591,"date_modified":1561625591,"content":"Work for me too in new build https://forums.whonix.org/t/qubes-whonix-15-templatevms-debian-buster-based-4-0-1-201906232114-testers-wanted/7601\n\nIt might not work in upgraded builds since thunar was started before qubes-core-agent-thunar was ever installed. Cannot reproduce anymore.\n\nWhat is the contents of your `/home/user/.config/Thunar/uca.xml`? @TNTBOMBOM (only relevant for VMs where this is an issue)"},{"author":"TNTBOMBOM","date_created":1564058735,"date_modified":1564058735,"content":"```\n<?xml encoding=\"UTF-8\" version=\"1.0\"?>\n<actions>\n<action>\n\t<icon>utilities-terminal</icon>\n\t<name>Open Terminal Here</name>\n\t<unique-id>1555514114536034-1</unique-id>\n\t<command>exo-open --working-directory %f --launch TerminalEmulator</command>\n\t<description>Example for a custom action</description>\n\t<patterns>*</patterns>\n\t<startup-notify/>\n\t<directories/>\n</action>\n<action>\n\t<icon>folder-copy</icon>\n\t<name>Copy to VM</name>\n\t<unique-id>1507455450991127-4</unique-id>\n\t<command>/usr/lib/qubes/qvm-actions.sh copy %F</command>\n\t<description></description>\n\t<patterns>*</patterns>\n\t<directories/>\n\t<audio-files/>\n\t<image-files/>\n\t<other-files/>\n\t<text-files/>\n\t<video-files/>\n</action>\n<action>\n\t<icon>folder-move</icon>\n\t<name>Move to VM</name>\n\t<unique-id>1507455437157027-3</unique-id>\n\t<command>/usr/lib/qubes/qvm-actions.sh move %F</command>\n\t<description></description>\n\t<patterns>*</patterns>\n\t<directories/>\n\t<audio-files/>\n\t<image-files/>\n\t<other-files/>\n\t<text-files/>\n\t<video-files/>\n</action>\n<action>\n\t<icon>document-open</icon>\n\t<name>Open in VM</name>\n\t<unique-id>1507455471075266-5</unique-id>\n\t<command>/usr/lib/qubes/qvm-actions.sh openvm %F</command>\n\t<description></description>\n\t<patterns>*</patterns>\n\t<audio-files/>\n\t<image-files/>\n\t<other-files/>\n\t<text-files/>\n\t<video-files/>\n</action>\n<action>\n\t<icon>gtk-convert</icon>\n\t<name>Convert in DisposableVM</name>\n\t<unique-id>1507455488971315-6</unique-id>\n\t<command>/usr/lib/qubes/qvm-actions.sh pdf %F</command>\n\t<description></description>\n\t<patterns>*.pdf</patterns>\n\t<other-files/>\n</action>\n<action>\n\t<icon>gtk-convert</icon>\n\t<name>Convert in DisposableVM</name>\n\t<unique-id>1507455503129941-7</unique-id>\n\t<command>/usr/lib/qubes/qvm-actions.sh img %F</command>\n\t<description></description>\n\t<patterns>*</patterns>\n\t<image-files/>\n</action>\n<action>\n\t<icon>document-open</icon>\n\t<name>Edit in DisposableVM</name>\n\t<unique-id>1507455559234996-8</unique-id>\n\t<command>/usr/lib/qubes/qvm-actions.sh opendvm %F</command>\n\t<description></description>\n\t<patterns>*</patterns>\n\t<audio-files/>\n\t<image-files/>\n\t<other-files/>\n\t<text-files/>\n\t<video-files/>\n</action>\n<action>\n\t<icon>document-open</icon>\n\t<name>View in DisposableVM</name>\n\t<unique-id>1507455559234997-9</unique-id>\n\t<command>/usr/lib/qubes/qvm-actions.sh viewdvm %F</command>\n\t<description></description>\n\t<patterns>*</patterns>\n\t<audio-files/>\n\t<image-files/>\n\t<other-files/>\n\t<text-files/>\n\t<video-files/>\n</action>\n</actions>\n\n```"},{"author":"Patrick","date_created":1564226733,"date_modified":1564226733,"content":"Looks like mine.\n\n(Only difference is `unique-id` which shouldn't matter.)"},{"author":"Patrick","date_created":1670517655,"date_modified":1670517655,"content":"Still works for me, still not reproducible. Old ticket. Therefore closing. Please re-report in the new issue tracker (and link to this old ticket) should this still be an issue."}]},"PHID-TASK-4lc2sxtj4febb2ud5grj":{"id":"911","title":"xfce theming","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/xfce-theming-a-few-suggestions/7205\n\nall processed up to post 58\n\nfrom [post 59](https://forums.whonix.org/t/xfce-theming-a-few-suggestions/7205/59) remains TODO\n","comments":[]},"PHID-TASK-t46eppmrszoi66n4xi35":{"id":"910","title":"anti-forensics / amnesia testing of Whonix-Host in Live mode","status":"open","priority":"Normal","author":"Patrick","description":"Similar to:\nhttps://www.whonix.org/wiki/Dev/Technical_Introduction#Anti-forensic_Claims\n","comments":[{"author":"onion_knight2","date_created":1584896846,"date_modified":1584896846,"content":"Do you mean: starting an installed version in live-mode (not tested, not supported yes) or starting a Whonix-Host iso file?"},{"author":"Patrick","date_created":1584897562,"date_modified":1584897562,"content":"This ticket was written at a time when there was only grub-live. I.e. install Whonix on hardware (or Debian + grub live). Boot in live mode. Test if that works. If yes, take an hdd image. Boot again into live mode. Then take another hdd image. Compare these hdd images. Do they 100% match or are there differences? Differences: something wrong. No differences: that would be nice.\n\nIn case of Whonix Live ISO if that is booted I guess it won't modify the internal hdd (unless the user chooses to install). Pretty sure it is that way. But should be tested nonetheless."},{"author":"onion_knight2","date_created":1584903208,"date_modified":1584903208,"content":"Whonix Live ISO runs without an HDD.\nI am not sure what you want to test here? Please precise."},{"author":"Patrick","date_created":1584905007,"date_modified":1584905007,"content":">>! In T910#19667, @onion_knight2 wrote:\n> Whonix Live ISO runs without an HDD.\n\nCorrect.\n\n> I am not sure what you want to test here? Please precise.\n\nOne would assume that Whonix Live ISO does not modify HDD. But are we sure? Should be tested."},{"author":"onion_knight2","date_created":1584906676,"date_modified":1584906676,"content":"Ok, so you want me to:\n- boot a Whonix-Host ISO\n- Install on HDD\n- Reboot on Whonix-Host ISO, do some stuff, shutdown\n- See if HDD has been modified (why would it be?)\nCorrect?"},{"author":"Patrick","date_created":1584914000,"date_modified":1584914000,"content":"These tests are fully independent.\n\n----\n\nTest Nr 1)\n\n* boot a Whonix-Host ISO (or any ISO)\n* create a hashsum of the internal hdd\n* reboot\n* boot a Whonix-Host ISO\n* reboot\n* create a hashsum of the internal hdd\n* compare hashsums\n\nVery unlikely that hashsums changed.\n\n----\n\nTest Nr 2)\n\n* boot a Whonix-Host ISO\n* install Whonix-Host to internal hdd\n* boot Wohnix-Host installed from internal hdd (in persistent mode)\n* `sudo apt install grub-live`\n* shutdown\n* boot any Live ISO\n* create a hashsum of the internal hdd\n* shutdown\n* boot Wohnix-Host installed from internal hdd in Live Mode\n* do some stuff\n* shutdown\n* boot any Live ISO\n* create a hashsum of the internal hdd\n* compare hashsums\n\nUnlikely that hashsum changed."},{"author":"Patrick","date_created":1692019965,"date_modified":1692019965,"content":"[Have the dev team tested the anti-forensic capability of Whonix-live mode and grub live?](https://www.reddit.com/r/Whonix/comments/15q7vcs/have_the_dev_team_tested_the_antiforensic/)\n"}]},"PHID-TASK-efvmnvyqfhvyutqveyap":{"id":"909","title":"installing Whonix-Host without installer (calamares)","status":"open","priority":"Normal","author":"Patrick","description":"Do we want to support the use case of writing Whonix-Host images to disks with no use of any installer (calamares) required?\n\n----\n\n- to internal disk: do we want to support this initially?\n- to USB disk: easier, since users can use their existing operating system to do that. Host operating specific.\n\n----\n\nThis is related to `resize disk image at first boot of Whonix Host` (T907) and `encrypt Whonix-Host disk after first boot` (T906). I.e. after writing a Whonix disk image to (USB) disk it would:\n\n* boot\n* no run of installer required\n* use maximum available disk size (T907)\n* ready to use out of the box\n* encrypt disk (T906)\n\n----\n\nsee also on\n\n* live iso\n* live USB\n* BIOS\n* UEFI\n* BIOS + UEFI\n\nhttps://willhaley.com/blog/custom-debian-live-environment/\n\n----\n\nRelated:\n`instructions how to burn Whonix-Host ISO image to DVD or USB` (T969)","comments":[{"author":"onion_knight2","date_created":1584004393,"date_modified":1584004393,"content":"No disk encryption?"},{"author":"Patrick","date_created":1584020731,"date_modified":1584021113,"content":">>! In T909#19506, @onion_knight2 wrote:\n> No disk encryption?\n\nGood point I hadn't considered yet for this installation method.\n\nCreating an encrypted base image containing Debian is hard. There's no tool yet that can do that I am aware of. Possible in theory, though\n\n[grml-debootstrap feature request:\nencrypted VM images support](https://github.com/grml/grml-debootstrap/issues/131)\n\nIf that was possible then `cryptsetup-reencrypt` could be used to add full disk encryption after first boot.\n\nSince disk encryption is probably not feasible, we probably don't want to go for installing Whonix-Host without installer (calamares)?\n\nI'll split this ticket.\n\n* 1 easier ticket about instructions how to get the iso on USB or DVD -> T969,\n* and a separate one for installing Whonix-Host without installer (calamares) (this very ticket)\n"},{"author":"onion_knight2","date_created":1584051995,"date_modified":1584051995,"content":"It is possible to automatize grml-debootstrap with full-disk encryption. Nothing too hard. I could hack together a semi-working bash script after a couple of hours of online documentation.  \n\nEven easier to automatically create an encrypted partition and rsync Whonix-Host into it, and then modify some paramaters inside the encrypted partition to make it bootable.\n\nBut then, why even bother? Calamares does it just as well, and is much more powerful, elegant and modular."},{"author":"Patrick","date_created":1584082141,"date_modified":1584082141,"content":">>! In T909#19527, @onion_knight2 wrote:\n> It is possible to automatize grml-debootstrap with full-disk encryption. Nothing too hard. I could hack together a semi-working bash script after a couple of hours of online documentation.  \n\nThat would be super cool!\n\n> Even easier to automatically create an encrypted partition and rsync Whonix-Host into it, and then modify some paramaters inside the encrypted partition to make it bootable.\n\nThis is very host operating system specific. Writing an iso to a device is an easier process since much more popular.\n\n> But then, why even bother? Calamares does it just as well, and is much more powerful, elegant and modular.\n\nGreat question! Could be useful for:\n\n* An easy, fast was to get a fully persistent installation of Whonix-Host on USB (or any external disk).\n  * Otherwise one would have to burn Whonix-Host to DVD, boot DVD, install to USB.\n  * Or in absence of an DVD drive, write the ISO to an Whonix-Host installer USB device, boot that Whonix-Host installer USB device, and then install to yet another USB device.\n* Unattended installation. Fully automated, no user input required, no graphical user interface requested for installation.\n* Server support.\n  * Think future Kicksecure installations perhaps useful for Tor relays and public web servers.\n  * Didn't think about Whonix-Host installation on dedicated servers yet. Maybe that could then happen too.\n* Vendors could sell pre-installed (persistent) Whonix-Host USB devices with zero installer/setup by user needed.\n  * Just write the iso to USB and done.\n* Selling hardware with Whonix-Host pre-installed would also be easier since the process of installing the Whonix-Host image would be super simple.\n\n(Calamares) installer seems more useful to completely replace the installed operating system and install Whonix-Host on internal disk.\n"}]},"PHID-TASK-y44fskkb33hvmtq7qyjk":{"id":"908","title":"copy Whonix VM images to Whonix-Host and set up during build","status":"invalid","priority":"Normal","author":"Patrick","description":"Should we delete the Whonix VM images after importing them to save disk space?\n\nOr keep them on the user's disk so the user can easily re-create the VMs or add multiple VMs?","comments":[{"author":"Patrick","date_created":1584787476,"date_modified":1584787476,"content":"We actually ended up using Whonix KVM and placing images to:\n\n* `/var/lib/libvirt/images/Whonix-Gateway.qcow2`\n* `/var/lib/libvirt/images/Whonix-Workstation.qcow2`\n\nhttps://github.com/Whonix/Whonix/blob/master/build-steps.d/1800_copy_vms_into_raw\n\nThere are no duplicate images."}]},"PHID-TASK-ja26tsdoz3cvbgk6m2zb":{"id":"907","title":"resize Whonix-Host disk at first boot of Whonix-Host","status":"open","priority":"Wishlist","author":"Patrick","description":"https://forums.whonix.org/t/whonix-host-operating-system/3931/6\n\n> Disk size issues: We don’t know how big the target device is. A 16 GB stick (we only need perhaps 4 GB) or 1000 GB USB hard drive. We have --vmsize but what size do we select for default download users? I remember netrunner-odroid has a script “on boot, expand my parition to maximum size of this boot drive”.","comments":[]},"PHID-TASK-y4qrdy5n5xxu4j6bjdy7":{"id":"906","title":"encrypt Whonix-Host disk after first boot of Whonix-Host","status":"open","priority":"Normal","author":"Patrick","description":"This would be useful in case of `installing Whonix-Host without installer (calamares)` (T909),\n\nBuilding encrypted images and then later using `cryptsetup-reencrypt` (to get a secret master key) [is not yet possible](https://github.com/grml/grml-debootstrap/issues/131) and may or may not be simple to implement in `grml-debootstrap`.\n\nAlso shipping already encrypted images would probably increase the size of the images since then compression would be hard.\n\nThere is probably no compression tool that understands the encryption master key and uses that for the benefit of the compression.\n\n----\n\ncryptsetup-reencrypt as far as I understand (I hope I am wrong?) can only be used for already encrypted luks images.\n\n----\n\nluksipc apparently seems capable of in-place encryption of non-luks disks.\n\n* https://www.johannes-bauer.com/linux/luksipc/\n* https://packages.debian.org/search?keywords=luksipc\n\nAt first boot after T907 the user could be prompted an offer to encrypt the disk in place.\n\n----\n\nTODO:\n\n* test lukspic to encrypt a previously unencrypted installed Debian and convert it into a full disk encrypted system\n* #research if there are better alternatives\n","comments":[{"author":"onion_knight2","date_created":1584446348,"date_modified":1584446348,"content":"Should we consider closing this task since Calamares installer provides the option of full disk encryption?"},{"author":"Patrick","date_created":1584464868,"date_modified":1584464868,"content":"This ticket is only useful if we go for T909. I will update the ticket descriptions now."}]},"PHID-TASK-gjdjmbbstr6vslwiogq2":{"id":"905","title":"emergency shutdown on USB removal","status":"open","priority":"Normal","author":"Patrick","description":"See if we can re-use the code from Tails or if T552 is easier.\n\nOverlaps with T552.","comments":[]},"PHID-TASK-qywtgzknblz6nkripxy6":{"id":"904","title":"Whonix-Host Swap Considerations - Swap Partition vs Swap File vs No Swap By default","status":"open","priority":"Normal","author":"Patrick","description":"Calamares does not support swap files yet.\n\nSee also:\nhttps://forums.whonix.org/t/whonix-host-operating-system/3931/190\n\nEncrypted swap file may not be compatible with hibernation to disk?\n\nStrong rationale to avoid an encrypted swap partition?","comments":[{"author":"madaidan","date_created":1557503732,"date_modified":1557503732,"content":"There is none. You can run `swapon -s` or `cat /proc/swaps` to verify. \n\nBoth the Gateway and Workstation have no swap."},{"author":"Patrick","date_created":1557658411,"date_modified":1557658411,"content":"Thanks for testing! Would have been surprising if there was.\n\nWe need to re-check this for Whonix Host. Since it gets installed using calamares (which handles partitioning) there could be an unwanted swap partition.\n"},{"author":"madaidan","date_created":1557664499,"date_modified":1557664499,"content":"> We need to re-check this for Whonix Host. Since it gets installed using calamares (which handles partitioning) there could be an unwanted swap partition.\n\nI can test it for that too. Where do I download it?"},{"author":"Patrick","date_created":1558001769,"date_modified":1558001769,"content":"madaidan (madaidan):\n> madaidan added a comment.\n> \n> \n>   > We need to re-check this for Whonix Host. Since it gets installed using calamares (which handles partitioning) there could be an unwanted swap partition.\n>   \n>   I can test it for that too. Where do I download it?\n\nNot yet available for download. Even developers-only builds aren't fully\nbootable yet. Development on going. That's the recent topics on Whonix\nHost Operating system and Hardened Debian in Whonix development forums\nrecently."},{"author":"Patrick","date_created":1562409049,"date_modified":1562409049,"content":"There is none indeed for VMs but it has to be re-checked once/if #whonix-host becomes a thing."},{"author":"Patrick","date_created":1584787699,"date_modified":1584787699,"content":"Whonix-Host considerations:\n\nCalamares does not support swap files yet.\n\nEncrypted swap file may not be compatible with hibernation to disk?\n\nStrong rationale to avoid an encrypted swap partition?\n\nSee also:\nhttps://forums.whonix.org/t/whonix-host-operating-system/3931/190"}]},"PHID-TASK-g7emz623k3ix4byceimx":{"id":"903","title":"find new name for Hardened Debian and rename it","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/hardened-debian-security-focused-linux-distribution-based-on-debian-in-development-feedback-wanted/5943/15?u=patrick","comments":[{"author":"Patrick","date_created":1566224402,"date_modified":1566224402,"content":"https://forums.whonix.org/t/hardened-debian-security-focused-linux-distribution-based-on-debian-in-development-feedback-wanted/5943/30?u=patrick"}]},"PHID-TASK-fsmqbx3d6ieyoryxxhol":{"id":"902","title":"disable removable drives auto-mounting - XFCE only","status":"review","priority":"Normal","author":"Patrick","description":"Maybe there is no auto mounting by default anyhow.","comments":[{"author":"madaidan","date_created":1557347270,"date_modified":1557347270,"content":"Automounting can be configured in /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/thunar-volman.conf \n\nThe property \"automount-media\" should have the value \"false\".\n\nIt looks like these are disabled by default in Whonix. I've only tested this from the CLI version and installed xfce manually. The ordinary xfce version may be different. "},{"author":"Patrick","date_created":1557365484,"date_modified":1557365484,"content":"Debian buster package thunar-volman (`thunar-volman-0.9.1`) contains a file `debian/thunar-volman.xml`\n\nfile `debian/install` contains\n\n    debian/thunar-volman.xml /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/\n\n.\n\n    dpkg -S /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/thunar-volman.xml \n\n> thunar-volman: /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/thunar-volman.xml\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<channel name=\"thunar-volman\" version=\"1.0\">\n  <property name=\"automount-media\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"false\"/>\n  </property>\n  <property name=\"automount-drives\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"false\"/>\n  </property>\n  <property name=\"autobrowse\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"false\"/>\n  </property>\n  <property name=\"autoopen\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"false\"/>\n  </property>\n</channel>\n```\n\n----\n\nFYI: There is file [`/etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/thunar.xml`](https://github.com/Whonix/security-misc/blob/master/etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/thunar.xml) as part of #security-misc package.\n\nSee also:\nhttps://forums.whonix.org/t/whonix-xfce-development/6213/83\n\n----\n\nthunar-volman has a ton of auto something features. It may or may not be the case that these are enabled by default. I enabled them all manually to make the point.\n\n```\ncat xfconf/xfce-perchannel-xml/thunar-volman.xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n\n<channel name=\"thunar-volman\" version=\"1.0\">\n  <property name=\"automount-media\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"true\"/>\n  </property>\n  <property name=\"automount-drives\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"true\"/>\n  </property>\n  <property name=\"autobrowse\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"true\"/>\n  </property>\n  <property name=\"autoopen\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"true\"/>\n  </property>\n  <property name=\"autorun\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"true\"/>\n  </property>\n  <property name=\"autoburn\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"false\"/>\n  </property>\n  <property name=\"autoplay-audio-cds\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"true\"/>\n  </property>\n  <property name=\"autoplay-video-cds\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"true\"/>\n  </property>\n  <property name=\"autoipod\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"true\"/>\n  </property>\n  <property name=\"autophoto\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"true\"/>\n  </property>\n  <property name=\"autoprinter\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"true\"/>\n  </property>\n  <property name=\"autokeyboard\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"true\"/>\n  </property>\n  <property name=\"automouse\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"true\"/>\n  </property>\n  <property name=\"autotablet\" type=\"empty\">\n    <property name=\"enabled\" type=\"bool\" value=\"true\"/>\n  </property>\n</channel>\n```\n\n----\n\nCan you see from thunar-volman source code where defaults are configured? Would be good to watch for future versions.\n\n----\n\nI think by disabling thunar-volman in thunar settings, we automatically get rid of any thunar-volman auto mounting. Done that. (Following commit not yet tested.) Good to have as safeguard.\n\nhttps://github.com/Whonix/security-misc/commit/b00a264ce27c48584879d85275a3fa3f19030906\n\nWhat do you think?"},{"author":"madaidan","date_created":1557422654,"date_modified":1557422654,"content":"> Can you see from thunar-volman source code where defaults are configured? Would be good to watch for future versions.\n\ndebian/thunar-volman.xml has all the default settings for auto-mounting if that's what you mean.\n\n> What do you think?\n\nAll the auto stuff should probably be disabled. Disabling volman altogether should disable these anyway but it'd be good to disable individual settings just in case.\n\nMaybe add /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/thunar-volman.conf to security-misc with all the auto-mounting disabled."},{"author":"Patrick","date_created":1557449035,"date_modified":1557449035,"content":"madaidan (madaidan):\n> madaidan added a comment.\n> \n> \n>   > Can you see from thunar-volman source code where defaults are configured? Would be good to watch for future versions.\n>   \n>   debian/thunar-volman.xml has all the default settings for auto-mounting if that's what you mean.\n\nNo, I mean the upstream repository thunar-volman by XFCE developers.\n\n* https://git.xfce.org/xfce/thunar-volman/tree/\n* https://github.com/xfce-mirror/thunar-volman\n\n>   > What do you think?\n>   \n>   All the auto stuff should probably be disabled.\n\nEven if these are disabled by default? The reasoning being, they're\ndisabled by default now, but we don't know about the future?\n\n>   Maybe add /etc/xdg/xfce4/xfconf/xfce-perchannel-xml/thunar-volman.conf to security-misc with all the auto-mounting disabled.\n\nIt would require config-package-dev `displace` (used elsewhere in\npackages by Whonix) to take over package ownership of that file since\nthat file is already owned by Debian thunar-volman package. I am\nwondering if that effort is justified."},{"author":"madaidan","date_created":1557503268,"date_modified":1557503268,"content":">No, I mean the upstream repository thunar-volman by XFCE developers.\n>\n>- https://git.xfce.org/xfce/thunar-volman/tree/\n>- https://github.com/xfce-mirror/thunar-volman\n\nIt looks like they're configured in thunar-volman-settings/tvm-preferences-dialog.c. \n\nhttps://git.xfce.org/xfce/thunar-volman/tree/thunar-volman-settings/tvm-preferences-dialog.c\n\nDo a ctrl + f for \"auto\". It looks like it enables some.\n\nThere isn't an actual configuration file. Just code.\n\n> Even if these are disabled by default? The reasoning being, they're\n> disabled by default now, but we don't know about the future?\n\nYes. It's better to be prepared, just incase.\n\n> I am wondering if that effort is justified.\n\nI say it's justified. We probably won't know if the defaults are ever changed so it's better to make sure it wont affect us anyway.\n"}]},"PHID-TASK-6ncnbmg4saprr7uawfhl":{"id":"901","title":"package and test wiperam for Debian","status":"resolved","priority":"Normal","author":"Patrick","description":"* https://forums.whonix.org/t/is-ram-wipe-possible-inside-whonix/5596\n* https://tails.boum.org/contribute/design/memory_erasure/","comments":[{"author":"HulaHoop","date_created":1558503728,"date_modified":1558503728,"content":"https://github.com/AvANa-BBS/freepto-lb/issues/53"},{"author":"Patrick","date_created":1700627153,"date_modified":1700627153,"content":"There's now a dedicated project:\nhttps://www.kicksecure.com/wiki/Ram-wipe\nhttps://github.com/Kicksecure/ram-wipe"}]},"PHID-TASK-urahjck5om66mckkxlgk":{"id":"900","title":"Installation and setup of Kicksecure tutorials","status":"open","priority":"Normal","author":"0brand","description":"Kicksecure is a security focused Distribution. Kicksecure targets beginner to advanced Linux users and has a particular focus on educating first-time Linux users so they have the necessary skills to stand on their own two feet. Initial docs will focus on installation and set up in VirtualBox with other hypervisor specific instructions to follow.\n\nInitial documentation will consist of an OS / project overview with the following tutorials.\n\n  - Download: VM image and VirtualBox (tutorial) \n  - First steps: Setup/configuration inside VirtualBox (tutorial) \n  - Learning areas: Mostly basic information to get new users started with Linux \n    - Terminal / Cli\n    - `sudo` / root\n    - File system hierarchy \n    - File system navigation\n    - File permissions / ownership\n    - Misc ( `touch`,` mkdir`, `ls`,` ...`)\n    - `...`\n  - Possibly advanced configuration ?\n\n~~Due to the Debian trademark policy a new name must be found for this OS.~~\n\nDone !\n\n https://www.whonix.org/wiki/Kicksecure\n\nhttps://www.debian.org/trademark\n\n\n\nRelated\n- https://forums.whonix.org/t/hardened-debian-security-focused-linux-distribution-based-on-debian-in-development-feedback-wanted/5943\n- https://whonix.org/wiki/Kicksecure\n- https://forums.whonix.org/t/document-hardened-debian-setup/7078\n\nInspiration\n- https://forums.whonix.org/t/whonix-can-become-a-distribution-targeting-first-time-linux-users/7050\n    \n\n\n\n  ","comments":[{"author":"0brand","date_created":1555721221,"date_modified":1555721221,"content":"Hardened Debian Linux  has been added to Google Season of Docs project ideas. \n\n https://whonix.org/wiki/Design/Google_Season_of_Docs_2019#Project_Ideas "},{"author":"0brand","date_created":1566555740,"date_modified":1566555740,"content":"Season of Docs starts on Sep 02 2019."},{"author":"0brand","date_created":1567186113,"date_modified":1567186113,"content":"This forum thread will be used for community documentation discussions (currently under Organizational sub forum). \n\nhttps://forums.whonix.org/t/document-installation-and-setup-of-the-new-security-focused-hardened-debian-linux-distribution-selected-by-whonix-for-season-of-docs-2019/7887"}]},"PHID-TASK-psxb3feaho4bgcyqbptm":{"id":"899","title":"Fix file saving issues in scurl wrappers","status":"resolved","priority":"Normal","author":"Xavier","description":"> {icon info-circle color=lightbluetext}  //Forum topic with details: https://forums.whonix.org/t/scurl-wrapper-problem/7125 //\n\nA few fixes are needed for scurl wrappers to use them in many regular cases.\n\n---\n\n(NOTE) {icon github color=blue}  Pull request: https://github.com/Whonix/scurl/pull/1\n\n- Fix main scurl wrapper:\n  - {icon share-square color=lightbluetext}  Remove `--remote-name` to avoid forced saving to file and restore vanilla behavior of writing to stdout instead\n    - this flag breaks correct `scurl` usage in place of `curl`\n    - download wrappers were already added for saving to file\n- Improve download wrappers:\n  - {icon share-square color=lightbluetext}  Replace `--remote-name` with `--remote-name-all`\n    - allows to download multiple URLs at once and auto-save all of them to files with extracted names\n    - allows to explicitly specify filename (`-o filename`) for any URL, or prevent saving to file but write to stdout instead (`-o -` or `--no-remote-name`)\n      - Attention: the order of naming options and URLs doesn't matter, the first option is for the first URL and so on, so e.g. to override filename for 3rd URL only, user must specify auto-saving of first 2: `-O -O -o -`\n  - {icon share-square color=lightbluetext}  Add `--remote-header-name`\n    - curl will try to get server-specified filename from `Content-Disposition` response header, otherwise extract it from URL the usual way — allows to download and auto-save dynamically generated files, different files from the same common URL, etc.\n\n---\n\n(WARNING) {icon question-circle color=orange}  Whonix developers decision is needed\n\n- Consider renaming `curl-download` / `scurl-download` wrappers, or adding symlinks with short and simple names for convenience of regular users (to use as a replacement for `wget`):\n  - curld / scurld\n  - curlget / scurlget\n  - durl / sdurl\n  - etc.","comments":[{"author":"Patrick","date_created":1555082720,"date_modified":1555082720,"content":"https://github.com/Whonix/scurl/commit/e200c6e38c395406840894820ba8ae9bd8bdc374"}]},"PHID-TASK-qcrswo3zu63inrx7xvj5":{"id":"898","title":"sdwdate - check file timestamp of Tor consensus file to detect stale Tor consensus","status":"open","priority":"Normal","author":"Patrick","description":"* https://github.com/Whonix/anon-shared-helper-scripts/blob/master/usr/lib/anon-shared-helper-scripts/anondate\n* https://github.com/Whonix/anon-shared-helper-scripts/blob/master/usr/lib/anon-shared-helper-scripts/te_pe_tb_check","comments":[]},"PHID-TASK-ao37kfij5ki746cjdjq7":{"id":"897","title":"Unable to write to '/sys/fs/cgroup/blkio/machine.slice/machine...","status":"resolved","priority":"Normal","author":"jmliz","description":"Following KVM instructions I get this error on step:\n\n\n```\n$ virsh -c qemu:///system start Whonix-Gateway\nerror: Failed to start domain Whonix-Gateway\nerror: Unable to write to '/sys/fs/cgroup/blkio/machine.slice/machine-qemu\\x2d3\\x2dWhonix\\x2dGateway.scope/blkio.weight': No such file or directory\n```\n\nI'm on a Fedora 29.\n","comments":[{"author":"jmliz","date_created":1554399781,"date_modified":1554399781,"content":"https://www.whonix.org/wiki/KVM#Verify_the_Whonix_images"},{"author":"HulaHoop","date_created":1563755673,"date_modified":1563755673,"content":"This bug does not exist on Debian stable after I upgraded. I have it documented for Arch and a work around for it. Nothing more to be done on my end."}]},"PHID-TASK-jp46jfomv7o6k55nhvfl":{"id":"896","title":"Hidden onion services GUI in sys-whonix","status":"wontfix","priority":"Normal","author":"insurgo","description":"The main goal of this GUI would be to permit remote assistance for trusted third party services directly into dom0.\n\nThat GUI should permit:\n- Visibility of currently active onion services\n- Creation/Deletion/Recreation of onion services\n- For each service, permit port forward definition\n- For each service, permit services to be hidden and authenticated.\n- Ask user to restart tor after having committing changes.\n- v3 should be supported.\n\nCombined with proper salt recipes at QubesOS installation in dom0/additional AdminVMs to [[ https://www.whonix.org/wiki/Dev/Qubes#ssh_into_Qubes_dom0 | automate installation and configuration of required software and services startup ]],\n\nFor this dom0 remote assistance service, the user should be able to turn remote assistance on, and be prompted with:\n- onion service name\n- authentication token\n\nSo the user can share those information through encrypted communication channel of his choice. \n\nPrior discussion happened [[ https://github.com/SkypLabs/my-qubes-os-formula/issues/6 | here ]]","comments":[{"author":"insurgo","date_created":1553363346,"date_modified":1553363346,"content":"@Patrick previously [[ https://github.com/SkypLabs/my-qubes-os-formula/issues/6#issuecomment-430931634 | said ]]: \nPerhaps make remote dom0 support as simple as / similar to OninoShare?\n\nTwo choices:\n- Qubes start menu -> sys-whonix -> persistent remote support (would always start, also after reboot, until \"Stop\" pressed\n- Qubes start menu -> sys-whonix -> one time remote support (would start only once)\n\nTwo buttons:\n- Start\n- Stop\n\nAfter start, a new field opens with information to be copied to the one who should gain remote access.\n- It should contain the commands required for accessing an authenticated onion service using HiddenServiceVersion 3 (the one just started) to be run on remote onion service. \n- The command supposed to be pasted into sys-whonix. It should also contain the SSH / VNC line supposed to be pasted in anon-whonix to access the remote dom0.\n"},{"author":"insurgo","date_created":1553363507,"date_modified":1553363528,"content":"[[ https://github.com/SkypLabs/my-qubes-os-formula/issues/6#issuecomment-456897720 | Here ]], Marmarek saying that AdminVMs will soon enough have everything needed to manage Templates and created VMs of their own."},{"author":"insurgo","date_created":1553706270,"date_modified":1553706270,"content":"@Patrick I'm filling grant application related to https://github.com/osresearch/heads/issues/540#issuecomment-474921281.\nHow would you estimate development costs for this feature?"},{"author":"Patrick","date_created":1553731151,"date_modified":1553731151,"content":"This is very interesting.\n\nCost estimation in software development is very difficult. By the time you have the estimate, most of the work required to do is already done."},{"author":"insurgo","date_created":1553994954,"date_modified":1553994975,"content":">>! In T896#18062, @Patrick wrote:\n> This is very interesting.\n> \n> Cost estimation in software development is very difficult. By the time you have the estimate, most of the work required to do is already done.\n\n@Patrick Lol! Check here. The estimate can be rough: https://mensuel.framapad.org/p/AQqOdrEBWr\nSection 4 point 3. Thanks!\n"},{"author":"Patrick","date_created":1554042562,"date_modified":1554042562,"content":"Sorry, I don't have a better answer."},{"author":"Patrick","date_created":1563526054,"date_modified":1563526054,"content":"https://forums.whonix.org/t/focus-on-whonix-core-development/5036"}]},"PHID-TASK-5jl2smbsoddciybs2dul":{"id":"895","title":"Proposed Download Directory Structure / download redirects / stable download links / permalinks","status":"resolved","priority":"Wishlist","author":"tempest","description":"the debian team uses a directory structure for their iso files that uses a \"current\" directory where the latest version of the installation disks can always be found.  this allows for various scripting/bash commands from a user to always be able to download the latest version of a particular release, regardless of the version point release number.  \n\nfor example the following command will always download the latest version of the amd64 debian netinst installer for stretch with the proprietary drivers:\n\n  wget -c -e robots=off -r -l1 -nd -P ./ -np \"https://cdimage.debian.org\\\n  /cdimage/unofficial/non-free/cd-including-firmware/current/amd64/iso-cd\" \\\n  -A \"firmware-9.*.*-amd64-netinst.iso\"\n\nthis helps greatly with documentation efforts, since documentation does not break and need updating based on a new point release being available.\n\nwhonix, however, currently uses a directory structure that is specific to point release names, which are linked from the webpage. would it be problematic to implement a \"current\" directory in a manner similar to debian's that hosts the latest whonix point release?\n\nhttps://forums.whonix.org/t/permalink-download-links/8190\nhttps://www.whonix.org/wiki/Dev/Redistribution#Update_Permanent_Links","comments":[{"author":"Patrick","date_created":1551013554,"date_modified":1551013554,"content":"I requested such a feature myself once from Tor Project. They refused this because they said, when you ask users what version they are using, they will reply `latest`.\n\nNot sure this is a good enough reason to refuse this?"},{"author":"tempest","date_created":1551014270,"date_modified":1551014270,"content":"it seems a rather odd reason to me since debian has literally done it this way for years. i understand that it would be a problem if the downloaded file name was always the same (for example, \"tor-current.exe\").  but, since the filenames always include the version number, there are multiple means of documenting for a user how to determine their version number before making support requests."},{"author":"Patrick","date_created":1551030502,"date_modified":1551030502,"content":"Alright. If you know how to automate / implement that... Using mediawiki or else... Would speed up implementation a ton."},{"author":"Patrick","date_created":1553601704,"date_modified":1553601704,"content":"I don't have ideas how to implement this. [Patches are Welcome](https://www.whonix.org/wiki/FAQ#Patches_are_Welcome)."},{"author":"mig5","date_created":1555281875,"date_modified":1555281875,"content":"It doesn't strike me as too hard to just add a 'current' symlink pointing to the latest release?\n\nWhat is the current process of uploading new images/releases onto the server? Can we not just add a step to adjust that symlink, at the end of the process?\n\nOn the other hand, I'm not sure how much time this really solves. Current links to downloads in the wiki look like this: https://download.whonix.org/ova/14.0.1.4.4/Whonix-XFCE-14.0.1.4.4.ova\n\nWhilst the above wget command does use a wildcard approach to avoid explicitly stating *some* of the version name, you would have to change the download instructions to use such a method, no? Otherwise you *will* still have to list the full filename, with its version contained therein, as something like https://download.whonix.org/ova/current/Whonix-XFCE-14.0.1.4.4.ova, and so you haven't saved much time. Do you want to really replace hyperlinks with a code block showing a wget command like the above? "},{"author":"mig5","date_created":1555282061,"date_modified":1555282061,"content":"Another approach might be to use Nginx redirects (and a shell script or something, to maintain changes as new versions come out), so that URLs like https://download.whonix.org/ova/current/Whonix-XFCE-current.ova redirect to https://download.whonix.org/ova/14.0.1.4.4/Whonix-XFCE-14.0.1.4.4.ova . Useful?\n\nHypothetical:\n```\n/usr/local/bin/update-redirects.sh --new-version=14.0.1.4.4\n# (automatically updates redirects file to use the new version and reloads nginx)\n```"},{"author":"Patrick","date_created":1555517791,"date_modified":1555517791,"content":">>! In T895#18241, @mig5 wrote:\n> It doesn't strike me as too hard to just add a 'current' symlink pointing to the latest release?\n\nI've tried a symlink.\n\n    mkdir /var/rsync/ova/current\n\n    ln -s /var/rsync/ova/14.0.1.4.4/Whonix-XFCE-14.0.1.4.4.ova /var/rsync/ova/current/Whonix-XFCE-current.ova\n\nProblem: it changes the filename to `Whonix-XFCE-current.ova`. Fixable?\n\n> What is the current process of uploading new images/releases onto the server?\n\nrsync ( https://github.com/Whonix/whonix-developer-meta-files/blob/master/release/upload_images )\n\n> Can we not just add a step to adjust that symlink, at the end of the process?\n\nupload_images indeed could have a switch for stable vs testers-only (different or no symlink).\n\n> On the other hand, I'm not sure how much time this really solves. Current links to downloads in the wiki look like this: https://download.whonix.org/ova/14.0.1.4.4/Whonix-XFCE-14.0.1.4.4.ova\n> \n> Whilst the above wget command does use a wildcard approach to avoid explicitly stating *some* of the version name, you would have to change the download instructions to use such a method, no? Otherwise you *will* still have to list the full filename, with its version contained therein, as something like https://download.whonix.org/ova/current/Whonix-XFCE-14.0.1.4.4.ova, and so you haven't saved much time. Do you want to really replace hyperlinks with a code block showing a wget command like the above? \n\nI am indeed not a fan of a long complicated download command. (It's a user contributed guide on its own domain name.)\n"},{"author":"mig5","date_created":1555564087,"date_modified":1555564715,"content":"@Patrick:\n\nAdded this to /etc/nginx/sites-enabled/download.whonix.org.conf:\n\n```\ninclude /etc/nginx/conf.d/download_redirects;\n```\n\nThe contents of that file, just 3 lines:\n\n```\nset $version \"14.0.1.4.4\";\nrewrite ^/ova/current(?:/)?$ /ova/$version permanent;\nrewrite ^/ova/current/Whonix-(.*)-current.(.*)$ /ova/$version/Whonix-$1-$version.$2 permanent;\n```\n\nNow you can simply hit https://download.whonix.org/ova/current/Whonix-CLI-current.ova and it will  redirect with a 301 so that the filename ends up as https://download.whonix.org/ova/14.0.1.4.4/Whonix-CLI-14.0.1.4.4.ova\n\nSo all your links in the webpages could be to the non-version-specific URL.\n\nUsers could also browse to https://download.whonix.org/ova/current/ and they'll be redirected to https://download.whonix.org/ova/14.0.1.4.4\n\nNo symlinks required.\n\nThen your upload script only needs to do a `sed` on the `/etc/nginx/conf.d/download_redirects` to change the `$version` variable from `14.0.1.4.4` to something else, e.g to change to `15.0.0.0.7`:\n\n```\nsed -i 's/version \".*\";$/version \"15.0.0.0.7\";/' /etc/nginx/conf.d/download_redirects\nservice nginx reload\n```\n\nHappy with that? We would keep that file `download_redirects` outside of puppet so that it doesn't clobber any changes made by you or your script."},{"author":"mig5","date_created":1555564726,"date_modified":1555564726,"content":"Edited above comment a few times to fix syntax"},{"author":"marmarek","date_created":1555572174,"date_modified":1555572174,"content":"I suggest not permanent redirection, otherwise browsers may cache old version."},{"author":"Patrick","date_created":1555669628,"date_modified":1555669628,"content":"* https://download.whonix.org/ova/current/Whonix-CLI-current.ova\n* https://download.whonix.org/ova/current/Whonix-CLI-current.ova.asc\n\n* https://download.whonix.org/ova/current/Whonix-XFCE-current.ova\n* https://download.whonix.org/ova/current/Whonix-XFCE-current.ova.asc\n\nWorks great! Thanks @mig5!\n\n>>! In T895#18256, @marmarek wrote:\n> I suggest not permanent redirection, otherwise browsers may cache old version.\n\nThanks, @marmarek!\n\nCould you address this too please, @mig5?"},{"author":"mig5","date_created":1555972311,"date_modified":1555972311,"content":"@Patrick I have set it to a temporary redirect now (302). In my tests in Firefox, the request is not being cached (server sends back the 302 each time according to Nginx logs)\n\nI tried fiddling with adding no-cache headers too but it doesn't seem necessary (and I couldn't get it to work without spending more time)"},{"author":"Patrick","date_created":1556878395,"date_modified":1556878395,"content":"Awesome!\n\nDoes this work for you? @tempest"},{"author":"tempest","date_created":1560215922,"date_modified":1560215922,"content":"@Patrick @mig5 it appears to be working great. thank you and sorry for the late reply."}]},"PHID-TASK-iwfi5eyklspfoatpciir":{"id":"894","title":"Tor Browser in whonix-ws-14 based VMs sometimes blocks JavaScript on first start","status":"resolved","priority":"Normal","author":"phabricator","description":"Expected behavior: Tor Browser does not block JavaScript by default\n\nObserved behavior: Tor Browser in whonix-ws-14 based AppVMs in Qubes OS 4 blocks JavaScript on first boot (in ~50% of the cases)\n\nThis issue can not be reproduced with vanilla Tor Browser on a non-whonix machine so the assumption is that it is somehow related to Whonix even though Whonix does not aim to make changes to Tor Browser, but minor changes to its configuration are required by Whonix (i.e. SOCKS settings, startpage, ..) that could be triggering this issue.\n\nI also noticed the file \"~/.tb/first-boot-home-population.done\" which suggests that whonix does something on first boot that it does not everytime (which would explain why this happens only on first boot if at all). The issue is particularly annoying on dispVMs based on whonix-ws-14 because there every boot is the \"first boot\".\n\nTor Browser Version: 8.0.6 (it also happened with 8.0.5)\n\nhttps://forums.whonix.org/t/tor-browser-in-whonix-blocks-javascript-only-when-started-for-the-first-time-and-in-dispvms/6843","comments":[{"author":"Patrick","date_created":1550321695,"date_modified":1550321695,"content":"> I also noticed the file \"~/.tb/first-boot-home-population.done\" which suggests that whonix does something on first boot\n\nIt copies Tor Browser from root image /var/cache/tb-binary/ to TemplateBasedVM (that includes DispVMs) user home folder.\n\nhttps://github.com/Whonix/tb-updater/blob/master/usr/lib/tb-updater/first-boot-home-population\n\nhttps://www.whonix.org/wiki/Dev/git#grep_Whonix_source_code\n\nSo by the time `/usr/bin/torbrowser` starts it might not be fully copied to user home folder yet.\n\nThis is now fixed.\n\nhttps://github.com/Whonix/tb-starter/commit/7827ef3ffc61d1c85724d5bbc4ed5b7003b3c882\n\nUpdated packages in stable-proposed-updates and testers repository. Will flow to stable as per usual process."}]},"PHID-TASK-ckt4w2i463uklofamro2":{"id":"893","title":"Mouse cursor rarely works on KVM Whonix WS 14.0.1.3.8","status":"open","priority":"Normal","author":"WhoCares","description":"I'm connecting to VM with just virt-viewer (not using virt-manager). There is a bug T872 with similar symptoms, stating that the problem was virtio mouse. I checked xml config - only ps2 mouse is present.\nVersions:\nWhonix 14.0.1.3.8 (fresh install, not an upgrade from previous version)\nvirt-viewer 7.0\nlibvirt 5.0.0\nqemu 3.1.0\nhost kernel 4.20.7\nSteps to reproduce:\na) Boot Whonix Workstation VM with virsh (virsh start Whonix-Workstation)\nb) Connect to VM with virt-viewer. One of the following then happens:\n\n\n  # VM's display is completely unresponsive to mouse cursor. Restarting virt-viewer doesn't help at all.\n  # It is possible to click on start menu button then press Esc to hide start menu. Then VM's display becomes completely unresponsive to mouse cursor. Restarting virt-viewer doesn't help at all.\n  # VM's display behaves normally. This happens like 1 time out of 10 VM boots.","comments":[{"author":"HulaHoop","date_created":1550781212,"date_modified":1550781212,"content":"\nWhat distro are you using?\n\nUnfortunately if it's a rolling or bleeding edge one, you will occasionally run into problems like this, but on the upside they will be fixed quickly (and replaced with other new problems?)\n\nI can't reproduce this on Debian stable and even if I could I can't do much about it. I recommend you switch to stable for a better experience. There is no tangible benefit of running newer packages at this time. No killer features in testing packages that I would sacrifice stability for.\n\nI recommend you report this to upstream so they can fix it before its part of stable."},{"author":"WhoCares","date_created":1550929970,"date_modified":1550929970,"content":"I'm using Arch.\nAll the software versions (libvirt, QEMU, virt-viewer, kernel) are deemed stable upstream (by their respective developers, not by Debian folks)."},{"author":"WhoCares","date_created":1551464894,"date_modified":1551464894,"content":"I reopened this because KVM page (https://www.whonix.org/wiki/KVM#Arch_Linux) explicitly mentions Arch as a host OS.\nIf someone here is using Arch as well, maybe you guys can reproduce this after all. Also see my previous comment."},{"author":"HulaHoop","date_created":1563755792,"date_modified":1563755792,"content":"Whonix 15 has since come out. Has this been resolved? Not reproducible on Debian Buster either."}]},"PHID-TASK-uu3osh2zhvblim5iqq6i":{"id":"892","title":"Mixmaster replacement remailer stat lists","status":"invalid","priority":"Normal","author":"HulaHoop","description":"According to the topic https://forums.whonix.org/t/mixmaster-no-longer-working-in-whonix-14/6761\n\nnoreply.org remailer stats is defunct and remailer keys and info are no longer available. I propose replacing them with many of these alternatives and to comment them out if only one can be used at any given time.\n\nhttps://remailer.paranoici.org/stats/mlist2.html\nhttps://apricot.fruiti.org/echolot/\nhttp://echolot.anon-proxy.de/\nhttps://www.tahina.priv.at/%7Ecm/stats/\nhttps://www.deuxpi.ca/echolot/mlist2.html\nhttps://www.mixmin.net/echolot/\n\n\nSearch terms for future replacements \"mixmaster echolot\"","comments":[{"author":"Patrick","date_created":1548917144,"date_modified":1548917144,"content":"Whonix doesn't ship a list of these.\n\n`mixmaster-update` is provided by Debian. So this bug needs to be reported against Debian package `mixmaster`."},{"author":"HulaHoop","date_created":1549075418,"date_modified":1549075418,"content":"Looks like someone beat us to it:\n\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=919017\n\nThen the suggested changes to the update lists (from my thread) are considered out of scope."},{"author":"HulaHoop","date_created":1549075509,"date_modified":1549075509,"content":"Mixmaster is not present in Buster BTW"}]},"PHID-TASK-42f4zszdos2s2uhonj6r":{"id":"891","title":"upgrade build_sources/rpi-preferences for Debian 10/ buster","status":"open","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/Whonix/blob/master/build_sources/rpi-preferences\n\nCould you please create a `buster` branch so I can merge this once sources get switched to #debian_version_10_codename_buster? @Algernon ","comments":[]},"PHID-TASK-g2iqzgr2uduuvnctrobo":{"id":"890","title":"Have cryptsetup installed by default in Whonix","status":"resolved","priority":"Low","author":"TNTBOMBOM","description":"> That’s what I need and that’s what’s required in order to use the current GUI (the XFCE File Manager) with encrypted USBs. Without cryptsetup, an error regarding cryptsetup appears after entering the passphrase. A less technical user may assume the problem is with the passphrase rather than with a missing package.\n\n\n\n\nhttp://forums.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion/t/have-cryptsetup-installed-by-default-in-whonix/6684/5","comments":[{"author":"Patrick","date_created":1547960657,"date_modified":1547960657,"content":"postpone to Whonix 15 since cryptsetup has initramfs hooks (small chance of regressions)"},{"author":"Patrick","date_created":1554562214,"date_modified":1554562214,"content":"https://github.com/Whonix/anon-meta-packages/commit/2d96e901c5be0438281ac2dc1d07aea38923b2b4"}]},"PHID-TASK-3r2rfw2wr6wxrvkh3xtv":{"id":"889","title":"Add qtox app to whonix 15","status":"resolved","priority":"Normal","author":"TNTBOMBOM","description":"Debian code buster: \n\nhttps://packages.debian.org/buster/qtox\n\n\n\nhttp://forums.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion/t/tox-over-tor-and-i2p-in-development/1219/11","comments":[{"author":"Patrick","date_created":1554561839,"date_modified":1554561839,"content":"https://github.com/Whonix/anon-meta-packages/commit/03d4c6de551f7df4c055aa2f7829176a4b7ec8d9"}]},"PHID-TASK-n7qfkfg4h6a3o3tuuivf":{"id":"888","title":"change Qubes-Whonix default applications from KDE-ish to XFCE-ish","status":"resolved","priority":"Normal","author":"Patrick","description":"`Qubes-Whonix default applications will most likely change from KDE-ish to XFCE-ish`\nhttps://groups.google.com/forum/#!topic/qubes-devel/pkvvm1WNznY\n","comments":[{"author":"Patrick","date_created":1554561886,"date_modified":1554561886,"content":"https://github.com/Whonix/anon-meta-packages/blob/master/debian/control"}]},"PHID-TASK-55otfz3nmmxchtnwlmgt":{"id":"887","title":"download Tor Browser on Whonix-Gateway as provider for latest Tor and pluggable transports","status":"open","priority":"Normal","author":"Patrick","description":"Idea: We give up on trying to use using tor-launcher on Whonix-Gateway. (T118)\n\nA simpler approach:\n\n* We could download TBB using #tb-updater on Whonix-Gateway.\n* That way we could use the Tor and the pluggable transports shipped by TBB on Whonix-Gateway.","comments":[]},"PHID-TASK-op4gw33pknlcrqv7gxz4":{"id":"886","title":"add grub-live","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/installing-whonix-live-mode-in-all-distributed-images/6467\n\nhttps://github.com/Whonix/anon-meta-packages/pull/18","comments":[]},"PHID-TASK-qe3bxphohiy4ts6jigfp":{"id":"885","title":"Add MAT2 to Whonix 15 / Debian buster","status":"resolved","priority":"Normal","author":"TNTBOMBOM","description":"in Debian packages its there for buster and sid: (but not maintaining/upgrading the old one?)\n\nhttps://packages.debian.org/buster/mat2 \n\nForum Topic\nhttps://forums.whonix.org/t/add-mat2-to-whonix-15/6489","comments":[{"author":"HulaHoop","date_created":1547341221,"date_modified":1547341221,"content":"Seems so. This one is a context menu option or commandline but it supports a lot more stuff than the original and it pulls in other specialized tools to do the work."}]},"PHID-TASK-ltx2vikg4wjp5jkfcaju":{"id":"884","title":"add qvm-service support to onion-grater systemd service file","status":"wontfix","priority":"Normal","author":"nusenu","description":"Please add support for qvm-service subsustem to onion-grater. The goal of this ticket is to allow users to disable onion-grater via qvm-service for a specific deployed whonix-gw-14 AppVM via the qvm-service command.\n\nThis is usually implemented via a line like the following in the systemd service file:\n\n\n```\nConditionPathExists=/var/run/qubes-service/onion-grater\n```\n\n\nrationale:\nhttps://forums.whonix.org/t/feature-suggestion-introducing-support-for-a-minimal-hardened-mode-socksport-only/6450\n\nrelated:\nT879","comments":[{"author":"Patrick","date_created":1554576259,"date_modified":1554576259,"content":"Reducing the number of lingering, unrealistic tickets, therefore closing.\n\nThis either needs source code contributions is is realistically never going to happen."}]},"PHID-TASK-idqwho5ct5n2qf222swd":{"id":"883","title":"configure Qubes-Whonix XFCE default start menu entries (whitelisted appmenus)","status":"resolved","priority":"Normal","author":"Patrick","description":"* https://github.com/Whonix/qubes-template-whonix/tree/master/appmenus_buster_whonix-gateway\n** add Restart Tor GUI\n\n* https://github.com/Whonix/qubes-template-whonix/tree/master/appmenus_buster_whonix-workstation","comments":[{"author":"Patrick","date_created":1555075309,"date_modified":1555075309,"content":"https://github.com/Whonix/qubes-template-whonix/commit/3265347bb667af65daf58eb8ccccf48de4acc7b6"},{"author":"Patrick","date_created":1561038675,"date_modified":1561038675,"content":"anon-whonix / sys-whonix lacks a lot entries.\n\nWhonix TemplateVMs look ok."},{"author":"Patrick","date_created":1561040547,"date_modified":1561040547,"content":"sys-whonix shows sdwdate-gui.desktop by default but not\n\n* xfce4-terminal.desktop\n* Thunar.desktop\n* and most others too\n\nI guess https://github.com/Whonix/qubes-template-whonix/blob/master/appmenus_buster_whonix-gateway/vm-whitelisted-appmenus.list is the right file since that file contains sdwdate-gui.desktop.\n\nAny idea why default appmenus are broken? @marmarek "},{"author":"marmarek","date_created":1561083521,"date_modified":1561083521,"content":"It works for me (checked with `qubes-template-whonix-gw-15-4.0.1-201906201340`).\n\nYou can inspect `~/.local/share/qubes-appmenus/sys-whonix/whitelisted-appmenus.list` to see if if has everything expected listed (ignore extra empty lines). Then you can check if expected `.desktop` files are in `~/.local/share/qubes-appmenus/sys-whonix/apps` - if not, check `~/.local/share/qubes-appmenus/whonix-gw-15/apps.templates`. If they are missing in the latter too, then something gone wrong with retrieving them from the template during installation. You can try to find more details in `journalctl`. And retry with `qvm-sync-appmenus whonix-gw-15`."},{"author":"Patrick","date_created":1561285160,"date_modified":1561285160,"content":"QVMM applications tab looks good btw. Just the default applications listed in Qubes start menu (without ever using QVMM applications tab) is not properly populated.\n\n```\n[user@dom0 ~]$ cat ~/.local/share/qubes-appmenus/sys-whonix/whitelisted-appmenus.list \nsdwdate-gui.desktop\n```\n\n```\n[user@dom0 ~]$ ls -la ~/.local/share/qubes-appmenus/sys-whonix/apps/\ntotal 24\ndrwxr-xr-x 2 user user 4096 Jun 20 09:48 .\ndrwxr-xr-x 4 user user 4096 Jun 20 09:47 ..\n-rw-r--r-- 1 user user  239 Jun 20 09:47 sys-whonix-qubes-vm-settings.desktop\n-rw-r--r-- 1 user user  415 Jun 20 09:47 sys-whonix-sdwdate-gui.desktop\n-rw-r--r-- 1 user user   88 Jun 20 09:47 sys-whonix-vm.directory\n-rw-r--r-- 1 user user  532 Jun 20 09:47 sys-whonix-whonixcheck.desktop\n```\n\n```\n[user@dom0 ~]$ ls -la ~/.local/share/qubes-appmenus/whonix-gw-15/apps.templates/\ntotal 148\ndrwxr-xr-x 2 user user 4096 Jun 20 05:34 .\ndrwxr-xr-x 6 user user 4096 Jun 20 05:33 ..\n-rw-rw-r-- 1 user user  466 Jun 20 05:34 anon_connection_wizard.desktop\n-rw-rw-r-- 1 user user  405 Jun 20 05:34 debian-uxterm.desktop\n-rw-rw-r-- 1 user user  413 Jun 20 05:34 debian-xterm.desktop\n-rw-rw-r-- 1 user user  388 Jun 20 05:34 exo-file-manager.desktop\n-rw-rw-r-- 1 user user  377 Jun 20 05:34 exo-mail-reader.desktop\n-rw-rw-r-- 1 user user  503 Jun 20 05:34 exo-preferred-applications.desktop\n-rw-rw-r-- 1 user user  406 Jun 20 05:34 exo-terminal-emulator.desktop\n-rw-rw-r-- 1 user user  376 Jun 20 05:34 exo-web-browser.desktop\n-rw-rw-r-- 1 user user  409 Jun 20 05:34 firejail-ui.desktop\n-rw-rw-r-- 1 user user  377 Jun 20 05:34 firetools.desktop\n-rw-rw-r-- 1 user user  445 Jun 20 05:34 gateway-arm.desktop\n-rw-rw-r-- 1 user user  409 Jun 20 05:34 gateway-reloadtor.desktop\n-rw-rw-r-- 1 user user  368 Jun 20 05:34 gateway-stoptor.desktop\n-rw-rw-r-- 1 user user  395 Jun 20 05:34 gateway-tordata.desktop\n-rw-rw-r-- 1 user user  456 Jun 20 05:34 gateway-torrc.desktop\n-rw-rw-r-- 1 user user  445 Jun 20 05:34 gateway-torrcexamples.desktop\n-rw-rw-r-- 1 user user  469 Jun 20 05:34 mate-notification-properties.desktop\n-rw-rw-r-- 1 user user  405 Jun 20 05:34 mousepad.desktop\n-rw-rw-r-- 1 user user  399 Jun 20 05:34 onioncircuits.desktop\n-rw-rw-r-- 1 user user  355 Jun 20 05:34 qubes-run-terminal.desktop\n-rw-rw-r-- 1 user user  436 Jun 20 05:34 restart-tor-gui.desktop\n-rw-rw-r-- 1 user user  403 Jun 20 05:34 sdwdate-gui.desktop\n-rw-rw-r-- 1 user user  453 Jun 20 05:34 Thunar-bulk-rename.desktop\n-rw-rw-r-- 1 user user  459 Jun 20 05:34 Thunar.desktop\n-rw-rw-r-- 1 user user  422 Jun 20 05:34 thunar-settings.desktop\n-rw-rw-r-- 1 user user  441 Jun 20 05:34 tor-control-panel.desktop\n-rw-rw-r-- 1 user user  378 Jun 20 05:34 vim.desktop\n-rw-rw-r-- 1 user user  480 Jun 20 05:34 whonixcheck.desktop\n-rw-rw-r-- 1 user user  530 Jun 20 05:34 whonix-firewall30default.desktop\n-rw-rw-r-- 1 user user  492 Jun 20 05:34 whonix-firewall50user.desktop\n-rw-rw-r-- 1 user user  419 Jun 20 05:34 whonix-reloadfirewall.desktop\n-rw-rw-r-- 1 user user  451 Jun 20 05:34 whonix-repository-wizard.desktop\n-rw-rw-r-- 1 user user  397 Jun 20 05:34 xarchiver.desktop\n-rw-rw-r-- 1 user user  438 Jun 20 05:34 xfce4-terminal.desktop\n-rw-rw-r-- 1 user user  471 Jun 20 05:34 xfce4-terminal-settings.desktop\n```\n\n```\nqvm-sync-appmenus whonix-gw-15 \nWarning: ignoring key 'Comment' of whonix-reloadfirewall\nWarning: ignoring key 'Comment' of xarchiver\nWarning: ignoring key 'Name' of display-im6.q16\nwhonix-gw-15: Updating mousepad\nwhonix-gw-15: Updating qubes-run-terminal\nwhonix-gw-15: Updating gateway-stoptor\nwhonix-gw-15: Failed to get icon for gateway-stoptor: Something went wrong with receiver\nwhonix-gw-15: Updating vim\nwhonix-gw-15: Updating gateway-arm\nwhonix-gw-15: Updating tor-control-panel\nwhonix-gw-15: Updating debian-uxterm\nwhonix-gw-15: Updating firejail-ui\nwhonix-gw-15: Updating whonix-firewall30default\nwhonix-gw-15: Updating anon_connection_wizard\nwhonix-gw-15: Creating display-im6.q16\nWarning: not creating/updating '/home/user/.local/share/qubes-appmenus/whonix-gw-15/apps.templates/display-im6.q16.desktop' because of missing 'Name' key\nwhonix-gw-15: Updating restart-tor-gui\nwhonix-gw-15: Updating xfce4-terminal\nwhonix-gw-15: Updating xfce4-terminal-settings\nwhonix-gw-15: Updating exo-preferred-applications\nwhonix-gw-15: Updating exo-file-manager\nwhonix-gw-15: Updating exo-web-browser\nwhonix-gw-15: Updating xarchiver\nwhonix-gw-15: Updating whonix-reloadfirewall\nwhonix-gw-15: Updating exo-terminal-emulator\nwhonix-gw-15: Updating Thunar\nwhonix-gw-15: Updating gateway-reloadtor\nwhonix-gw-15: Updating exo-mail-reader\nwhonix-gw-15: Updating mate-notification-properties\nwhonix-gw-15: Updating firetools\nwhonix-gw-15: Updating gateway-torrc\nwhonix-gw-15: Updating Thunar-bulk-rename\nwhonix-gw-15: Updating sdwdate-gui\nwhonix-gw-15: Failed to get icon for sdwdate-gui: Something went wrong with receiver\nwhonix-gw-15: Updating whonixcheck\nwhonix-gw-15: Updating gateway-tordata\nwhonix-gw-15: Failed to get icon for gateway-tordata: No icon received\nwhonix-gw-15: Updating debian-xterm\nwhonix-gw-15: Updating whonix-repository-wizard\nwhonix-gw-15: Updating onioncircuits\nwhonix-gw-15: Updating whonix-firewall50user\nwhonix-gw-15: Updating gateway-torrcexamples\nwhonix-gw-15: Updating thunar-settings\nwhonix-gw-15: Creating appmenus\nsys-whonix: Creating appmenus\n```"},{"author":"Patrick","date_created":1561285309,"date_modified":1561285309,"content":"`sudo journalctl -f` in dom0 does not show anything when running `qvm-sync-appmenus whonix-gw-15` in dom0."},{"author":"marmarek","date_created":1561287428,"date_modified":1561287428,"content":"How have you created sys-whonix? Default applications list is copied from template only at VM creation time. If you modify it (using VM settings for example), or just switch template, it isn't re-copied from template (it would break user's changes)."},{"author":"Patrick","date_created":1561624300,"date_modified":1561624300,"content":"Seems ok after full removal and re-creation."}]},"PHID-TASK-omhcrd4xfzipwkkwlut3":{"id":"882","title":"install unrar-free by default","status":"resolved","priority":"Low","author":"TNTBOMBOM","description":"install unrar-free by default to whonix, as its useful to unrar .rar inside whonix.\n\nrelated: \n\nhttps://forums.whonix.org/t/whonix-for-virtualbox-with-xfce-14-0-0-9-6-release-candidate-1-testers-wanted/6352/4","comments":[{"author":"Patrick","date_created":1547275645,"date_modified":1547275645,"content":"https://forums.whonix.org/t/archive-decompression-tools/6533/8?u=patrick\n\n[quote=\"HulaHoop, post:8, topic:6533, full:true\"]\nunrar-free is redundant because it supports a smaller feature-set of unar\n[/quote]\n"}]},"PHID-TASK-fpib4soqacp3ecuevg6o":{"id":"881","title":"remove attempts to hide CPU information from VM in VirtualBox","status":"resolved","priority":"Normal","author":"Patrick","description":"Reasons:\n\n* There's been research showing that trying to hide CPU information in a virtualizer is futile.\n* There's been a Xen issue where hiding CPU information lead to a security issue.\n* spectre / meltdown defenses may depend on easy CPU detection.\n\nCould you help with references for these please? @HulaHoop ","comments":[{"author":"HulaHoop","date_created":1543860428,"date_modified":1543860428,"content":"> There's been research showing that trying to hide CPU information in a virtualizer is futile.\n\n\nI can't find papers to that effect. That's based on my intuition that someone can just benchmark the CPU in a VM to figure out what model they're running on. \nWith full emulation it may be possible to conceal all aspects about a CPU from the guest code at expense of performance.\n\nThe opposite however is true. It's impossible to hide the fact someone is running under a hypervisor.\n\n\n\n> There's been a Xen issue where hiding CPU information lead to a security issue.\n\nDug through their CVE database with no success. Search results are equally useless.\n\n\n\n\n> spectre / meltdown defenses may depend on easy CPU detection.\n\n\nhttps://www.berrange.com/posts/2018/06/29/cpu-model-configuration-for-qemu-kvm-on-x86-hosts/\n\n\n"}]},"PHID-TASK-e7edya26e4cilwpk6zhe":{"id":"880","title":"disable maximize window when moving to the top","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/whonix-xfce-14-0-0-9-6-for-virtualbox-released/6368/14","comments":[{"author":"Patrick","date_created":1543386210,"date_modified":1543386210,"content":"https://github.com/Whonix/whonix-xfce-desktop-config/commit/ea4afc3a5fca2994a3d99604160c17275731c47e"},{"author":"Patrick","date_created":1555248719,"date_modified":1555248719,"content":"Does this work? @TNTBOMBOM "},{"author":"TNTBOMBOM","date_created":1555253942,"date_modified":1555253942,"content":"yes its working"},{"author":"Patrick","date_created":1555253957,"date_modified":1555253957,"content":"Awesome!"}]},"PHID-TASK-3wdsqkevkhqabsgayz3e":{"id":"879","title":"qvm-service infrastructure does not work with whonix-gw-14 template","status":"wontfix","priority":"Wishlist","author":"nusenu","description":"If you disable a qvm-service (example: qubes-updates-proxy) for sys-whonix VM\nthe file\n/var/run/qubes-service/qubes-updates-proxy \nis created nonetheless (**not** expected) and as a result of that, the systemd service qubes-updates-proxy.service is enabled (because above file exists).\n\nThis means that the Qubes methodology to enable/disable service appears broken for whonix-gw-14 based AppVMs.\n\ndom0: \"qvm-service sys-whonix\" output:\nqubes-updates-proxy off\n\n","comments":[{"author":"Patrick","date_created":1543314694,"date_modified":1543314694,"content":"Does this also happen in Qubes Debian based VMs?"},{"author":"nusenu","date_created":1543317529,"date_modified":1543317529,"content":"the default debian-9 template is not affected (it works as expected in that template)"},{"author":"Patrick","date_created":1554576371,"date_modified":1554576371,"content":"Reducing the number of lingering, unrealistic tickets, therefore closing.\n\nThis either needs source code contributions is is realistically never going to happen."}]},"PHID-TASK-7avqqf7o3alrjr43ye7k":{"id":"878","title":"remove mapaddress entries in torrc for 1.1.1.1 and 2.2.2.2 since these allow fingerprinting Whonix users","status":"invalid","priority":"Normal","author":"nusenu","description":"You make use of MapAddress in the default torrc on whonix-gw\nhttps://www.torproject.org/docs/tor-manual.html.en#MapAddress\n\nhttps://github.com/Whonix/anon-gw-anonymizer-config/blob/master/usr/share/tor/tor-service-defaults-torrc.anondist#L107\ncontains:\n\n> mapaddress 1.1.1.1 k54ids7luh523dbi.onion\n> mapaddress 2.2.2.2 gbhpq7eihle4btsn.onion\n\nWhy are you redirecting traffic aiming to 1.1.1.1 (Cloudflare DNS resolver IP address) and 2.2.2.2 (Orange France) to some onion addresses?\n\nThis breaks connectivity to these destinations for all Whonix users by default and discloses the traffic to the operators of the onion addresses.\n\nWhat are you trying to do with these torrc configuration lines?\n\n\n\n","comments":[{"author":"Patrick","date_created":1543300119,"date_modified":1543300119,"content":"The rationale is making mixmaster work by default.\n\nhttps://github.com/Whonix/anon-mixmaster/blob/master/etc/skel/.Mix/mix.cfg\n\nAny suggestions for invalid IP addresses that we can use instead?"},{"author":"nusenu","date_created":1543318902,"date_modified":1543318902,"content":"first rule:  don't use public IP addresses that are not assigned to you\n\n> The rationale is making mixmaster work by default.\n\ndoes that require a MapAddress entry?"},{"author":"Patrick","date_created":1543382936,"date_modified":1543382936,"content":"Removed for now.\n\nhttps://github.com/Whonix/anon-gw-anonymizer-config/commit/377bbef9585ea067990ee54c1e40a6bb5eabd6da\n\nPackage upgrade available in Whonix testers repository soon."},{"author":"HulaHoop","date_created":1543965222,"date_modified":1543965222,"content":"My advice is to use a private address range reserved for this purpose by IANA. These will never be used in the future by anyone. Sine we use 10.x.x.x and moved away from 192.x.x.x, this leaves 172.x.x.x\n\n172.16.0.0 – 172.31.255.255\n\n\nhttps://en.wikipedia.org/wiki/Private_network"},{"author":"Patrick","date_created":1548933318,"date_modified":1548933318,"content":">>! In T878#17661, @HulaHoop wrote:\n> My advice is to use a private address range reserved for this purpose by IANA. These will never be used in the future by anyone. Sine we use 10.x.x.x and moved away from 192.x.x.x, this leaves 172.x.x.x\n> \n> 172.16.0.0 – 172.31.255.255\n> \n> \n> https://en.wikipedia.org/wiki/Private_network\n\nOk.\n\nPlease pick some range in the middle. Not the very first ones. This is to prevent issues for someone changing internal IP addresses (not likely using the same) or perhaps also to avoid issues with VPNs."},{"author":"HulaHoop","date_created":1549075012,"date_modified":1549075012,"content":"**172.24.0.0 **\n&\n **172.24.0.1**\n\nMiddle of the range solution. How does this sound? Confirmed it falls within the private address CIDR:\n\n\nhttps://ipduh.com/ip/cidr/?172.24.0.0/24\n\n\n\n> 172.24.0.0 is in the 172.16.0.0/12 block which is set aside for use in private networks. Addresses within this block do not legitimately appear on the public Internet. Addresses within 172.16.0.0/12 can be used without any coordination with IANA or an Internet registry. \n> \n\n\n"},{"author":"Patrick","date_created":1549095586,"date_modified":1549095586,"content":"Sounds good!"},{"author":"HulaHoop","date_created":1550512869,"date_modified":1550512869,"content":"Other imporvements in this thread such as functioning SMTP gateways are also part of this ticket:\n\nhttps://forums.whonix.org/t/mixmaster-no-longer-working-in-whonix-14/6761\n\n@Patrick Are pull requests needed?"},{"author":"Patrick","date_created":1550526474,"date_modified":1550526474,"content":"Yes."},{"author":"HulaHoop","date_created":1553470416,"date_modified":1553470416,"content":"https://github.com/Whonix/anon-gw-anonymizer-config/pull/17/commits/5351bd4765476e9522c77cea5a8e30e6c4f94083\n\n"},{"author":"HulaHoop","date_created":1553470534,"date_modified":1553470534,"content":"@Patrick Now we have to figure out how or if we can use the version in sid on Buster since it is no longer available in stable-next after the freeze. Let me know what you think and I will open a ticket for it is doable. "},{"author":"Patrick","date_created":1553496143,"date_modified":1553496143,"content":"https://github.com/Whonix/anon-gw-anonymizer-config/pull/17\n\nOn a second thought I wonder if this is still a Whonix specific fingerprinting vector. Any DNS request for `172.24.0.0` would resolve to `bshc44ac76q3kskw.onion`. Not something a remote website could exploit?"},{"author":"Patrick","date_created":1553496225,"date_modified":1553496225,"content":"https://github.com/Whonix/anon-gw-anonymizer-config/commit/57e3976d9726fc636741865ee90d1bb2bbf3dfad"},{"author":"HulaHoop","date_created":1553542760,"date_modified":1553542760,"content":"> On a second thought I wonder if this is still a Whonix specific fingerprinting vector. Any DNS request for 172.24.0.0 would resolve to bshc44ac76q3kskw.onion. Not something a remote website could exploit?\n\n\nNo because Tor Browser blocks access to localhost and all private IANA addresses by default to prevent malicious websites tricking itinto leaking a user's identity."},{"author":"Patrick","date_created":1553601620,"date_modified":1553601620,"content":"But this isn't a Tor Browser only thing. Applies to any application, specifically those using system default networking (Tor's `TransPort`)."},{"author":"HulaHoop","date_created":1553619885,"date_modified":1553619898,"content":"Can you think of any other app besides a browser that parses JS/Remote code that can manipulate it into requesting those particular addresses?\n\nNo user would consciously configure a daemon running on the internal network to use these IPs since it doesn't make sense - they are not within the 10.x.x.x range that we use."},{"author":"Patrick","date_created":1554401771,"date_modified":1554401771,"content":">>! In T878#18059, @HulaHoop wrote:\n> Can you think of any other app besides a browser that parses JS/Remote code that can manipulate it into requesting those particular addresses?\n\nYes. A file sharing protocol or messenger protocol (something with a feature to get around firewalls / discovery protocol like retroshare).\n"},{"author":"Patrick","date_created":1554562663,"date_modified":1554562663,"content":"mixmaster is unavaiable in #debian_version_10_codename_buster.\n\nhttps://packages.debian.org/search?keywords=mixmaster\n\nTherefore closing this ticket to have one ticket less for #Whonix_15. Please feel free to re-open this ticket or creating a new one in case you think it's possible to still have mixmaster working.\n\n> remove mapaddress entries in torrc for 1.1.1.1 and 2.2.2.2 since these allow fingerprinting Whonix users\n\nThis was done."},{"author":"Patrick","date_created":1554573996,"date_modified":1554573996,"content":"mixmaster said to be dead upstream and permanently removed from Debian\n\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=880101"}]},"PHID-TASK-hzvry6zn3fn4xggyciy7":{"id":"877","title":"Control_Port_Filter_Proxy wiki page is outdated","status":"resolved","priority":"Normal","author":"nusenu","description":"https://www.whonix.org/wiki/Dev/Control_Port_Filter_Proxy \nsays:\n\n\n> onion-grater listens on 0.0.0.0 port 9052, filters (white list) incoming control port messages and forwards them to the real Tor Control Port listening in 127.0.0.1:9051\n\nLooking at the netstat output suggests that the above documentation is no longer up to date and needs an update.","comments":[{"author":"nusenu","date_created":1543240918,"date_modified":1543240918,"content":"after the latest edit:\nhttps://www.whonix.org/w/index.php?title=Dev%2FControl_Port_Filter_Proxy&type=revision&diff=39840&oldid=39799\n\nthe documentation says:\n> onion-grater listens on Whonix internal network interface, port 9052, filters (white list) incoming control port messages and forwards them to the real Tor Control Port listening in 127.0.0.1:9051. \n\nwhich is still not correct?\nonion-grater port: 9052 vs. 9051 \nand \ntor control port: 127.0.0.1:9051 vs. control socket"},{"author":"Patrick","date_created":1544180163,"date_modified":1544180163,"content":"Thanks, fixed!"}]},"PHID-TASK-6scp7avd5sgp4vzjgktq":{"id":"876","title":"remove browser starter in xfce task bar","status":"wontfix","priority":"Normal","author":"Patrick","description":"On the left there are shortcuts:\n\n* xfce4-terminal\n* thunar\n* browser\n\nIf doable, `browser` should be removed on Whonix-Gateway.\n","comments":[{"author":"Algernon","date_created":1542449061,"date_modified":1542449061,"content":"I guess the only solution would be two separate packages of the desktop config for the gateway and the workstation. Maybe also some kind of postinst script which detects when it is run on the gateway and changes the xml. However, such a starter is also present on a default Xfce installation without a browser so it is more or less default behaviour."},{"author":"Patrick","date_created":1542460632,"date_modified":1542460632,"content":"That might work. Seems like a lot effort just to implement this.\n\nMaybe there is a simpler solution...  If possible...? Let's add this file to `whonix-gw-kde-desktop-conf`?\n\nhttps://github.com/Whonix/whonix-gw-kde-desktop-conf\n\nLet's pretend as if the `-kde` part in the package name does not exist. I.e. let's pretend the package name is `whonix-gw-desktop-conf`. Maybe we'll even rename that package some day.\n\nThat existing contents of the package can be kept. May still be useful for some users or eventual future maintainers. We can consider it a gateway / [workstation](https://github.com/Whonix/whonix-ws-kde-desktop-conf) specific desktop configuration package which is desktop environment agnostic. Support for other desktop environments might be added by future maintainers one day."},{"author":"Algernon","date_created":1542538386,"date_modified":1542538830,"content":"> Seems like a lot effort just to implement this.\n\nIndeed.\n\n> Let's add this file to whonix-gw-kde-desktop-conf?\n\nThen you need to remove it from the whonix-xfce-desktop-config and create a new package with the right xml file just for the workstation. Afaik using the same file in multiple packages won't work. \n\nOr we would need to merge all files into whonix-gw-kde-desktop-conf + the changed xml and use whonix-xfce-desktop-config with the browser shortcut  just in the workstation. ( I'll give that a try) Alternative is to leave it as is or remove shortcut from gateway and workstation.\n\n\n\n"},{"author":"Patrick","date_created":1542539249,"date_modified":1542539249,"content":">>! In T876#17521, @Algernon wrote:\n>> Seems like a lot effort just to implement this.\n> \n> Indeed.\n> \n>> Let's add this file to whonix-gw-kde-desktop-conf?\n> \n> Then you need to remove it from the whonix-xfce-desktop-config and create a new package with the right xml file just for the workstation.\n\nYes. We cannot have the same file in whonix-xfce-desktop-config and whonix-**gw**-kde-desktop-conf at the same time and install both packages at the same time.\n\n> Afaik using the same file in multiple packages won't work. \n\nMostly correct.\n\nThe same file can be in multiple package if these packages never get installed at the same time. For example the same file could be inside:\n\n* whonix-**gw**-kde-desktop-conf AND\n* whonix-**ws**-kde-desktop-conf\n\nat the same time since it would be unsupported to have both packages installed at the same time.\n\n> Or we would need to merge all files into whonix-gw-kde-desktop-conf + the changed xml and use whonix-xfce-desktop-config with the browser shortcut  just in the workstation.\n\nPossible. However, sharing as much code as sensible inside whonix-xfce-desktop-config and use whonix-**(gw|ws)**-kde-desktop-conf only where required would be preferably.\n\n> Alternative is to leave it as is or remove shortcut from gateway and workstation.\n\nYes."},{"author":"Algernon","date_created":1542620617,"date_modified":1542620617,"content":"> Possible. However, sharing as much code as sensible inside whonix-xfce-desktop-config and use whonix-(gw|ws)-kde-desktop-conf only where required would be preferably.\n\nThen we would have 3 packages (including security-misc 4) just for the desktop configuration showing only a minor difference on the desktop. Clicking the icon on the gateway even tells you to use the workstation. Therefore I'd opt for keep as is.\n"}]},"PHID-TASK-pcanne36xkuf3mgzmcz2":{"id":"875","title":"fix fail closed mechanism","status":"open","priority":"Normal","author":"Patrick","description":"i.e. do not start networking if whonix-firewall.service fails to load.\n\nCurrently disabled since it breaks networking on whonix-firewall package upgrades.\n\n* https://github.com/Whonix/whonix-firewall\n* https://github.com/Whonix/whonix-firewall/blob/master/lib/systemd/system/networking.service.d/30_whonix-gw-firewall-fail-closed.conf","comments":[{"author":"madaidan","date_created":1557505177,"date_modified":1557505177,"content":"Maybe disable it just for package upgrades?\n\nYou could edit [[ https://github.com/Whonix/whonix-firewall/blob/master/usr/lib/whonix-firewall/enable-firewall | whonix-firewall ]] to disable the fail closed mechanism if an apt upgrade is running then after, it could re-enable it.\n\nYou'd probably want something like:\n\n\n```\ndisable_fail_closed {\n  ## Check if apt is being used to update.\n  if ps aux | grep \"apt \\-\\-upgrade\"; then\n\n    ## Disables fail closed mechanism.\n    sed -i 's/After=whonix-firewall.service/#After=whonix-firewall.service/' /lib/systemd/system/networking.service.d/30_whonix-gw-firewall-fail-closed.conf\n    sed -i 's/Requires=whonix-firewall.service/#After=whonix-firewall.service/' /lib/systemd/system/networking.service.d/30_whonix-gw-firewall-fail-closed.conf\n  fi\n\n  ## Checks if apt is not being used to update.\n  if ! ps aux | grep \"apt \\-\\-upgrade\"; then\n\n    ## Enables fail closed mechanism.\n    sed -i 's/#After=whonix-firewall.service/After=whonix-firewall.service/' /lib/systemd/system/networking.service.d/30_whonix-gw-firewall-fail-closed.conf\n    sed -i 's/#Requires=whonix-firewall.service/After=whonix-firewall.service/' /lib/systemd/system/networking.service.d/30_whonix-gw-firewall-fail-closed.conf\n  fi\n}\n```\n\nDetection of other ways of updating like --dist-upgrade will obviously need to be added."},{"author":"Patrick","date_created":1557658523,"date_modified":1557658523,"content":"Seems quite hacky. What's the root cause for failing?"},{"author":"madaidan","date_created":1557663259,"date_modified":1557663259,"content":"> Seems quite hacky. What's the root cause for failing?\n\nProbably, when the package is getting updated, it disables the firewall for a minute so it can apply the updates and the fail closed mechanism kicks in.\n\nI can't think of any other way to fix this."},{"author":"Patrick","date_created":1560511286,"date_modified":1560511286,"content":">>! In T875#18470, @madaidan wrote:\n>> Seems quite hacky. What's the root cause for failing?\n> \n> Probably, when the package is getting updated, it disables the firewall for a minute so it can apply the updates and the fail closed mechanism kicks in.\n\nI don't think anything Debian does would modify any iptables rules nor Whonix ships any code to disable the firewall. So \"disables the firewall for a minute\" is non-existing. Would be bad if that happened.\n"},{"author":"madaidan","date_created":1561062391,"date_modified":1561062391,"content":"> I don't think anything Debian does would modify any iptables rules nor Whonix ships any code to disable the firewall. So \"disables the firewall for a minute\" is non-existing. Would be bad if that happened.\n\nMaybe we should ask upstream about this then. I can't think of any other way this might happen."}]},"PHID-TASK-vu4qgo3knc2g2ctxhkkw":{"id":"874","title":"Remove Whonix non-free,contrib in the repository ","status":"invalid","priority":"Normal","author":"TNTBOMBOM","description":"in whonix main repo we have contrib and non-free , which has no place in whonix. ","comments":[{"author":"Patrick","date_created":1540538268,"date_modified":1540538268,"content":"Was discussed before.\n\nhttps://forums.whonix.org/t/adding-non-free-packages-by-default-is-it-safe/3300"}]},"PHID-TASK-oa6uzuj5g622lmd5efuy":{"id":"873","title":"Remove Ricochet from Whonix","status":"invalid","priority":"Normal","author":"TNTBOMBOM","description":"Ricochet is a dead project , and its produces multiple problems: \n\n- The application is dead , no further updates\n- It uses Tor 2.x while stable Tor is 3.x\n- Tor 3.x fixes hidden services issues which Tor 2.x was having , since Ricochet depending on the Hidden services then this is a problem to the privacy\n- Ricochet has the lacks of alot of things like sharing files,voip,voice messages ...etc\n- Last anybody made any changed to the software was before at least a Year ago\n- no body using it then no further testing then more 0 day at high possibility \n\nRe-installing it once it will be uploaded to Debian official repos with new and working version. having it by default is worthless,meaningless...","comments":[{"author":"HulaHoop","date_created":1539296148,"date_modified":1539296148,"content":"There is nothing dead about it. I jsut explained this on the forum. It is perfectly workable and openprivacy is owrking on creating a P2P asynchronous chat solution over its protocol.\n\nWe can include it from stable-backports and it will work."},{"author":"Patrick","date_created":1539331083,"date_modified":1539331083,"content":"https://forums.whonix.org/t/remove-ricochet-from-whonix/5009"}]},"PHID-TASK-4ffkqcdv35mf6nvenwxk":{"id":"872","title":"mouse does not work in Whonix-Workstation 14 KVM","status":"invalid","priority":"High","author":"toxdosvyqydtexlr","description":"I have a cursor, clicking does nothing, UI elements do not react to mouse over.\nGateway works as expected, both are clean installs with no changes in the guest or domain XML.\n\nWhonix version: 14.0.0.7.4\n\nHost:\nCompiled against library: libvirt 4.0.0\nUsing library: libvirt 4.0.0\nUsing API: QEMU 4.0.0\nRunning hypervisor: QEMU 2.11.1\nUbuntu 18.04.1","comments":[{"author":"HulaHoop","date_created":1539295870,"date_modified":1539295870,"content":"It could be the VM is confused because apparently there are two types of mice attached. I assumed that by adding virtio-mouse it would override and replace the emulated one. Turns out its not this way and I went ahead and reverted this config which should be effective in the next release.\n\nPlease remove virtio input devices mouse and keyboard from VM hardware settings and test again."},{"author":"toxdosvyqydtexlr","date_created":1539343053,"date_modified":1539343053,"content":"made no difference.\n\nalso, Gateway works fine, Workstation does not.\n\n```\n$ virsh dumpxml Whonix-Gateway | grep input\n    <input type='mouse' bus='virtio'>\n      <alias name='input0'/>\n    </input>\n    <input type='keyboard' bus='virtio'>\n      <alias name='input1'/>\n    </input>\n    <input type='mouse' bus='ps2'>\n      <alias name='input2'/>\n    </input>\n    <input type='keyboard' bus='ps2'>\n      <alias name='input3'/>\n    </input>\n\n$ virsh dumpxml Whonix-Workstation | grep input\n    <input type='mouse' bus='ps2'/>\n    <input type='keyboard' bus='ps2'/>\n```"},{"author":"HulaHoop","date_created":1539383845,"date_modified":1539383874,"content":"Sorry not reproducible on my end. May be related to the fact that you are running a non-standard setup with custom compiled binaries. By running packages from your distro there is a higher chance that bugs are more visible for  more people and more likely to be fixed.\n\nNote that Debian is more stable than Ubuntu and has more resources to produce fixes in a more timely way."},{"author":"toxdosvyqydtexlr","date_created":1539560498,"date_modified":1539560498,"content":">>! In T872#17440, @HulaHoop wrote:\n> By running packages from your distro there is a higher chance that bugs are more visible for  more people and more likely to be fixed.\n\nI am.\n```\n$ apt-cache policy libvirt-bin libvirt-daemon libvirt0 qemu-system-x86 qemu-kvm\nlibvirt-bin:\n  Installed: 4.0.0-1ubuntu8.5\n  Candidate: 4.0.0-1ubuntu8.5\n  Version table:\n *** 4.0.0-1ubuntu8.5 500\n        500 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 Packages\n        100 /var/lib/dpkg/status\n     4.0.0-1ubuntu8.2 500\n        500 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages\n     4.0.0-1ubuntu8 500\n        500 http://archive.ubuntu.com/ubuntu bionic/main amd64 Packages\nlibvirt-daemon:\n  Installed: 4.0.0-1ubuntu8.5\n  Candidate: 4.0.0-1ubuntu8.5\n  Version table:\n *** 4.0.0-1ubuntu8.5 500\n        500 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 Packages\n        100 /var/lib/dpkg/status\n     4.0.0-1ubuntu8.2 500\n        500 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages\n     4.0.0-1ubuntu8 500\n        500 http://archive.ubuntu.com/ubuntu bionic/main amd64 Packages\nlibvirt0:\n  Installed: 4.0.0-1ubuntu8.5\n  Candidate: 4.0.0-1ubuntu8.5\n  Version table:\n *** 4.0.0-1ubuntu8.5 500\n        500 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 Packages\n        100 /var/lib/dpkg/status\n     4.0.0-1ubuntu8.2 500\n        500 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages\n     4.0.0-1ubuntu8 500\n        500 http://archive.ubuntu.com/ubuntu bionic/main amd64 Packages\nqemu-system-x86:\n  Installed: 1:2.11+dfsg-1ubuntu7.5\n  Candidate: 1:2.11+dfsg-1ubuntu7.6\n  Version table:\n     1:2.11+dfsg-1ubuntu7.6 500\n        500 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 Packages\n *** 1:2.11+dfsg-1ubuntu7.5 100\n        100 /var/lib/dpkg/status\n     1:2.11+dfsg-1ubuntu7.3 500\n        500 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages\n     1:2.11+dfsg-1ubuntu7 500\n        500 http://archive.ubuntu.com/ubuntu bionic/main amd64 Packages\nqemu-kvm:\n  Installed: 1:2.11+dfsg-1ubuntu7.5\n  Candidate: 1:2.11+dfsg-1ubuntu7.6\n  Version table:\n     1:2.11+dfsg-1ubuntu7.6 500\n        500 http://archive.ubuntu.com/ubuntu bionic-updates/main amd64 Packages\n *** 1:2.11+dfsg-1ubuntu7.5 100\n        100 /var/lib/dpkg/status\n     1:2.11+dfsg-1ubuntu7.3 500\n        500 http://security.ubuntu.com/ubuntu bionic-security/main amd64 Packages\n     1:2.11+dfsg-1ubuntu7 500\n        500 http://archive.ubuntu.com/ubuntu bionic/main amd64 Packages\n```\n\nWorks fine:\nWhonix-Gateway 13\n**Whonix-Gateway 14**\nWhonix-Workstation 13\nWindows 7\nWindows 10\nUbuntu 14.04\nUbuntu 16.04\nUbuntu 18.04\nDebian 9.5\n\nDoes not work:\nWhonix-Workstation 14\n\nI'm fairly sure the problem is not me."}]},"PHID-TASK-b5r3dimzboz2ngsrs4qw":{"id":"871","title":"Account of IRC Admin/Moderator ","status":"resolved","priority":"High","author":"TNTBOMBOM","description":"as i see many ppl entering the room and leaving once they dont see lights on the left side of the chat (lights for registered ppl as admin or moderators). so they leave thinking its a dead room. \n\ni have tried to create an account but luck. \n\nmy name there is BlackMug , if you can create an account with the same username thats great if not then anything.\n\n","comments":[{"author":"Patrick","date_created":1538977920,"date_modified":1538977920,"content":"You need an account here.\n\nhttps://www.oftc.net/Services/"},{"author":"TNTBOMBOM","date_created":1538999435,"date_modified":1538999435,"content":"Registered my nickname as BlackMug  , but i dont have access to OP or VOICE to whonix channel"},{"author":"Patrick","date_created":1539003584,"date_modified":1539003615,"content":"Done.\n\n    /msg chanserv access #Whonix add BlackMug chanop\n\n> -ChanServ- BlackMug added to #Whonix access list as CHANOP.\n\nTo get op use.\n\n    /msg chanserv op #Whonix\n\nMake sure to NEVER enter nickserv / chanserv messages inside a chat\nchannel. ALWAYS only interact in server tab (called OFTC). This is to\nprotect/msg chanserv op #Whonix form accidentally posting a private\nmessage into a channel and get a password stolen."}]},"PHID-TASK-lng7f6bywi6s52oysz6e":{"id":"870","title":"Shift/Open Peertube Video Channel","status":"resolved","priority":"Normal","author":"TNTBOMBOM","description":"Sinc we have a Youtube channel , and youtube channel getting old and we need to be present in new fresh projects , so the best one atm is Peertube. \n\neven if we just have to copy/paste the same videos of whonix in youtube to Peertube. \n\nhttps://joinpeertube.org/en/#getting-started","comments":[{"author":"TNTBOMBOM","date_created":1545021053,"date_modified":1545021053,"content":"This is done now: \n\nour channel in this server: https://sikke.fi/login"}]},"PHID-TASK-ooak7764y3xkvxayfat7":{"id":"869","title":"Install Firejail by default inside Whonix","status":"resolved","priority":"Normal","author":"TNTBOMBOM","description":"http://forums.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion/t/install-firejail-firetools-by-default/5363/3\n\n","comments":[{"author":"HulaHoop","date_created":1539295978,"date_modified":1539295978,"content":"It's on the roadmap but a little far off until ParrotOS changes can be combined with the upstream package. It will make maintenance and turning it on by default  much more easier."},{"author":"HulaHoop","date_created":1539296471,"date_modified":1539296471,"content":"Closing. duplicate of:\n\nhttps://phabricator.whonix.org/T804\n\n"},{"author":"Patrick","date_created":1555088424,"date_modified":1555088424,"content":"T804 is actually not a duplicate of this. T804 seems a lot to do while this ticket is just something similar to:\n\n    sudo apt-get install firetools --no-install-recommends\n\n(Adding to #anon-meta-packages https://github.com/Whonix/anon-meta-packages/blob/master/debian/control.)\n\nNot sure if/when T804 gets implemented but this ticket looks easier, perhaps possible in #Whonix_15.\n\nFor required technical reasons, Whonix is always build as if using `--no-install-recommends`:\nhttps://www.whonix.org/wiki/Whonix_Debian_Packages#Technical_Stuff\n\nSo `firetools` and by dependency `firejail` only?\n\n```\nsudo apt-get install firetools --no-install-recommends\nReading package lists... Done\nBuilding dependency tree       \nReading state information... Done\nThe following package was automatically installed and is no longer required:\n  libevent-2.0-5\nUse 'sudo apt autoremove' to remove it.\nThe following additional packages will be installed:\n  firejail\nRecommended packages:\n  firejail-profiles xpra | xserver-xephyr | xvfb\nThe following NEW packages will be installed:\n  firejail firetools\n0 upgraded, 2 newly installed, 0 to remove and 69 not upgraded.\nNeed to get 530 kB of archives.\nAfter this operation, 1,727 kB of additional disk space will be used.\nDo you want to continue? [Y/n] \n```\n\nOr should we also install `firejail-profiles`?\n\n```\nsudo apt-get install firetools firejail-profiles --no-install-recommends\nReading package lists... Done\nBuilding dependency tree       \nReading state information... Done\nThe following package was automatically installed and is no longer required:\n  libevent-2.0-5\nUse 'sudo apt autoremove' to remove it.\nThe following additional packages will be installed:\n  firejail\nRecommended packages:\n  xpra | xserver-xephyr | xvfb\nThe following NEW packages will be installed:\n  firejail firejail-profiles firetools\n0 upgraded, 3 newly installed, 0 to remove and 69 not upgraded.\nNeed to get 600 kB of archives.\nAfter this operation, 2,495 kB of additional disk space will be used.\nDo you want to continue? [Y/n] \n```\n\nBut if we could drop `--no-install-recommends` (which we ought not to)...\n\n```\nsudo apt-get install firejail-profiles \nReading package lists... Done\nBuilding dependency tree       \nReading state information... Done\nThe following package was automatically installed and is no longer required:\n  libevent-2.0-5\nUse 'sudo apt autoremove' to remove it.\nThe following additional packages will be installed:\n  firejail libgtkglext1 libpango1.0-0 libpangox-1.0-0 libturbojpeg0 python-bcrypt python-future python-gtkglext1 python-lz4 python-lzo python-nacl python-opengl\n  python-paramiko python-pyasn1 python-rencode python-uritools ssh-askpass xpra xserver-xorg-input-void xserver-xorg-video-dummy\nSuggested packages:\n  python-future-doc python-nacl-doc libgle3 python-gssapi openssh-server python-pyopencl python-gst-1.0 python-avahi cups-pdf python-cups python-opencv v4l2loopback-dkms\n  python-yaml python-uinput\nThe following NEW packages will be installed:\n  firejail firejail-profiles libgtkglext1 libpango1.0-0 libpangox-1.0-0 libturbojpeg0 python-bcrypt python-future python-gtkglext1 python-lz4 python-lzo python-nacl\n  python-opengl python-paramiko python-pyasn1 python-rencode python-uritools ssh-askpass xpra xserver-xorg-input-void xserver-xorg-video-dummy\n0 upgraded, 21 newly installed, 0 to remove and 69 not upgraded.\nNeed to get 4,204 kB/4,341 kB of archives.\nAfter this operation, 22.8 MB of additional disk space will be used.\nDo you want to continue? [Y/n] \n```\n\nThen I am wondering if we ought to install any of the following recommended packages too?\n\n* ssh-askpass\n* xpra \n* xserver-xorg-input-void\n* xserver-xorg-video-dummy\n\nPerhaps these are required to make some of the firejail-profiles work?"},{"author":"TNTBOMBOM","date_created":1555092862,"date_modified":1555092896,"content":"Yes this command will do the job:\n\n\n```\nsudo apt install --no-install-recommends firetools firejail-profiles \n```\n\ni never used or installed xpra , ssh-askpass, xserver-xorg-input-void , xserver-xorg-video-dummy \n\nso i dont know why they are there , but for surely they are not needed for firejail-profiles to perform. "},{"author":"HulaHoop","date_created":1555210886,"date_modified":1555210886,"content":"> Then I am wondering if we ought to install any of the following recommended packages too?\n\nThe xserver/xpra stuff is necessary if you want to properly isolate GUI apps which I think is a major use case."},{"author":"Patrick","date_created":1555258738,"date_modified":1555258738,"content":"https://github.com/Whonix/anon-meta-packages/commit/45ea369055d513c07e28ac81ef113e13b33f3a5a"},{"author":"TNTBOMBOM","date_created":1555669567,"date_modified":1555669567,"content":"There is one issue with installing xpra: \n\n- it will install xpra browser (unwanted in Whonix)\n- also it has ability to connect to an outside xpra servers (unwanted in Whonix)\n\nlaunch xpra GUI or from terminal and you will find all these stuff. "},{"author":"Patrick","date_created":1555669877,"date_modified":1555669877,"content":">>! In T869#18260, @TNTBOMBOM wrote:\n> There is one issue with installing xpra: \n> \n> - it will install xpra browser (unwanted in Whonix)\n> - also it has ability to connect to an outside xpra servers (unwanted in Whonix)\n> \n> launch xpra GUI or from terminal and you will find all these stuff. \n\n>>! In T869#18236, @Patrick wrote:\n> https://github.com/Whonix/anon-meta-packages/commit/45ea369055d513c07e28ac81ef113e13b33f3a5a\n\nThe `xpra` package could be a problem.\n\n   apt-file list xpra | grep browser\n\n> xpra: /usr/bin/xpra_browser\n> xpra: /usr/share/applications/xpra-browser.desktop\n\nhttps://manpages.debian.org/testing/xpra/xpra_browser.1.en.html\n\nBut `browser` here may not mean `Internet Browser` so it may not be an issue?\n"},{"author":"Patrick","date_created":1555670368,"date_modified":1555670368,"content":"```\napt-file list xpra | grep desktop\n```\n\n```\nxpra: /usr/share/applications/xpra-browser.desktop\nxpra: /usr/share/applications/xpra-launcher.desktop\nxpra: /usr/share/applications/xpra-shadow.desktop\nxpra: /usr/share/applications/xpra.desktop\n```\n\n/usr/share/applications/xpra-launcher.desktop for example is an issue.\n\nScreenshot:\nhttps://www.xpra.org/trac/raw-attachment/ticket/1281/Screen%20Shot%202016-08-10%20at%2011.02.16.png\n\nWe could easily hide all of these start menu entries. Would that be a good solution?"},{"author":"TNTBOMBOM","date_created":1555671443,"date_modified":1555671443,"content":"i would say purge xpra , if someone want xpra he can install it easily. "},{"author":"Patrick","date_created":1561007303,"date_modified":1561007303,"content":"The problem is, `xpra` (actually `xpra | xserver-xephyr | xvfb`) isn't in the list of `Recommends:` of the `firejail` package by accident. We don't really know the rationale of that. Could be an optional dependency and without it, some things someone who knows firejail who is happy to find it installed would wonder why it actually does not work.\n\nThe root cause of this ticket is \"install firejail by default, even though we don't have a firejail maintainer, so perhaps we find one in future and easy experimenting with firejail\". Looking back at the root cause it would be better to not install firejail by default at all than adding an perhaps incomplete implementation not well understood."},{"author":"madaidan","date_created":1561401242,"date_modified":1561401242,"content":"> The problem is, xpra (actually xpra | xserver-xephyr | xvfb) isn't in the list of Recommends: of the firejail package by accident. We don't really know the rationale of that. Could be an optional dependency and without it, some things someone who knows firejail who is happy to find it installed would wonder why it actually does not work.\n\nXpra is only used for GUI isolation.\n\nhttps://firejail.wordpress.com/documentation-2/x11-guide/\n\nThere would be no other use for an external X server with firejail.\n\nI've used firejail many times without xpra and it has worked fine."},{"author":"Patrick","date_created":1561467636,"date_modified":1561467636,"content":">>! In T869#18656, @madaidan wrote:\n> Xpra is only used for GUI isolation.\n\nGUI isolation is very important, no?\n"},{"author":"madaidan","date_created":1561495393,"date_modified":1561495393,"content":"> GUI isolation is very important, no?\n\nIt is, but it isn't enabled by default in any profiles, so unless a user chooses to specifically enable it then nothing will break."},{"author":"Patrick","date_created":1561624491,"date_modified":1561624491,"content":"Implementation looks good enough for now."}]},"PHID-TASK-ecxe4ni74m64awhrt4oo":{"id":"868","title":"mediawiki fixes #2","status":"invalid","priority":"Normal","author":"Patrick","description":"**too much white space after headline**\n\nexample:\nhttps://www.whonix.org/wiki/Linux_Kernel_Runtime_Guard_LKRG\n\nBetween `Linux Kernel Runtime Guard (LKRG)` and `Introduction` is too much whitespace.\n\n----\n\n~~**two separate pre tags get intermingled and shown as one box**~~\n\n```\n<pre>\ntext 1\n</pre>\n\n<pre>\ntext 2\n</pre>\n```\n\n~~Shows one box only. Should be two separate boxes separated by a space.~~\n\n~~Example:~~\n~~https://www.whonix.org/wiki/Testpage2~~\n\n**~~replace Menu bar with hardcoded links~~**\n\n~~Can we remove the `Menu` drop down menu?~~\n\n~~And instead, can we have some - clickable - without javascript - (even hardcoded) links up there `HOME DOWNLOAD DOCS HELP NEWS` in the top bar?~~\n\n~~See also upstream bug report:~~\n~~https://github.com/jthingelstad/foreground/issues/182~~\n\nThis was fixed. Now always visible links. Links functional without noscript.\n\nhttps://www.whonix.org/wiki/MediaWiki:Sidebar\n\n----\n\n~~**clickable expand button inside text**~~ ([solved](https://forums.whonix.org/t/long-wiki-edits-thread/3477/1696) T868#19256)\n\n~~Example:~~ ~~www.whonix.org/wiki/Template:Reload_Tor~~\n> ~~`If you are using a terminal-only Whonix-Gateway, press on Expand on the right.`~~\n\n~~A bit hard for the users to look to the very right side. Would be nicer if we could say~~\n\n> ~~`If you are using a terminal-only Whonix-Gateway, click on {{Expand}}.`~~\n\n~~(`{{Expand}}` is just a placeholder for some code we would place there.)~~\n\n~~Bonus: Hiding the mediawiki's default `Expand` button on the right but not very important.~~\n\n~~If this is very difficult to do, please don't use too much time on it.~~\n\n----\n\n~~**Whonix wiki footer**~~\n\nWhonix wiki footer links...\n\nImprint\nPrivacy Policy\nCookie Policy\nTerms of Service\nDMCA\nE-Sign Consent\nPriority Support\nInvestors\nProfessional Support\n\nare currently using one new line per footer link.\n\nHowever, should be more reasonable in one (or two) `Imprint | Privacy Policy ...` lines.\n\n----\n\n~~**CookieWarning on mobile devices CSS**~~\n\n[CookieWarning](https://www.mediawiki.org/wiki/Extension:CookieWarning) on mobile devices is too big.\n","comments":[{"author":"JasonJAyalaP","date_created":1579319580,"date_modified":1579322138,"content":"**too  much whitespace**\nThere is unnecessary whitespace from the html line:\n\n```\n<h5 id=\"siteSub\" class=\"subtitle\"></h5>\n```\nwhich shows nothing + padding all h5's get.\n\nThe proper way, I presume, is to tell mediawiki to not display \"subtitle\", whatever that is. It seems to be similar to \"tagline\" which is set to \"From Whonix\" and outputted in html but set to hidden via css (dumb but whatever).\n\nThis can be solved in css with the code\n\n```\n#siteSub {\ndisplay: none;\n}\n```\nif mediawiki doesn't cooperate. (There is display:none for #siteSub in the css for #siteSub under specific sections, but not simply in the <body>)"},{"author":"JasonJAyalaP","date_created":1579320026,"date_modified":1579320026,"content":"**two separate pre tags get intermingled and shown as one box**\nCan you link me to an example (or create a page with one)?"},{"author":"JasonJAyalaP","date_created":1579320100,"date_modified":1579320100,"content":"**replace Menu bar with hardcoded links**\nIsn't this a mediawiki configuration option? It should have basic nav choices."},{"author":"JasonJAyalaP","date_created":1579321958,"date_modified":1579322032,"content":"**clickable expand button inside text**\n\nDone. Check: https://www.whonix.org/wiki/Template:Reload_Tor\n\nChange text as necessary, observe the example. The -suffix goes on both the \"customtoggle\" and the collapsible area. The class names for the collapsible area is \n```\n\"mw-collapsible mw-collapsed\"\n```\ninstead of\n\n```\n\"mw-collapsible-content\"\n```\nfor some reason.\n\nexample:\n```\n\nIf you want to see more, click\n<span class=\"mw-customtoggle-myDivision\">HERE</span>\nfor instructions.\n\n<div id=\"mw-customcollapsible-myDivision\" class=\"mw-collapsible mw-collapsed\">\nComplete the following steps.\n\nReload Tor.\n</div>\n\n\n```\nAnother note: That template had a weird extra collapsible <div> wrapped around the \"terminal\" line AND its instructions that seemed to do nothing. I removed it but can't explain why it was there.\n\nhttps://www.whonix.org/w/index.php?title=Template:Reload_Tor&diff=54237&oldid=47515\n(https://www.mediawiki.org/wiki/Manual:Collapsible_elements)"},{"author":"Patrick","date_created":1579345952,"date_modified":1579345952,"content":">>! In T868#19257, @JasonJAyalaP wrote:\n> **two separate pre tags get intermingled and shown as one box**\n> Can you link me to an example (or create a page with one)?\n\nhttps://www.whonix.org/wiki/Testpage2"},{"author":"Patrick","date_created":1579346054,"date_modified":1579346054,"content":">>! In T868#19258, @JasonJAyalaP wrote:\n> **replace Menu bar with hardcoded links**\n> Isn't this a mediawiki configuration option? It should have basic nav choices.\n\nActually not easy. See https://github.com/jthingelstad/foreground/issues/182 for more discussion."},{"author":"Patrick","date_created":1579347587,"date_modified":1579347587,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   **clickable expand button inside text**\n>   \n>   Done. Check: https://www.whonix.org/wiki/Template:Reload_Tor\n\n\nAwesome! (Announced here:)\n\nhttps://forums.whonix.org/t/long-wiki-edits-thread/3477/1696"},{"author":"Patrick","date_created":1579522125,"date_modified":1579522125,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   **too  much whitespace**\n>   This is unnecessary whitespace from the html line:\n>   \n>     <h5 id=\"siteSub\" class=\"subtitle\"></h5>\n>   \n>   which shows nothing + padding all h5's get.\n>   \n>   The proper way, I presume, is to tell mediawiki to not display \"subtitle\", whatever that is. It seems to be similar to \"tagline\" which is set to \"From Whonix\" and outputted in html but set to hidden via css (dumb but whatever).\n\n\nIndeed. Mediawiki doesn't support that.\n\nhttps://www.mediawiki.org/wiki/Manual:Tagline_(Site_Subtitle)\n\n>   This can be solved in css with the code\n>   \n>     #siteSub {\n>     display: none;\n>     }\n>   \n>   if mediawiki doesn't cooperate\n\n\nThat helped. Less whitespace now. But still too much whitespace."},{"author":"Patrick","date_created":1624570939,"date_modified":1624570939,"content":"migrated to https://forums.whonix.org/t/mediawiki-css-fixes/11874"}]},"PHID-TASK-y6ltaxwlry7bcvrnfdir":{"id":"866","title":"check systemd DNS when porting to Debian Buster","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/naming-changes-for-systemd-dns-resolver/6079","comments":[{"author":"Patrick","date_created":1555075350,"date_modified":1555075350,"content":"I don't see anything to do here."}]},"PHID-TASK-okx6byjhjvsyeu4lwwim":{"id":"865","title":"\"do not show this message again checkbox\" tool needed","status":"open","priority":"Normal","author":"Patrick","description":"\n\n> UPGRADE NOTICE!\n> \n> Whonix 14 was be released on xxx xx, 2018.\n> \n> Support for Whonix 13 will end on xxx xx, 2018.\n> \n> Please visit ... for more information.\n> \n> [ ] Do not show this message again\n>\n> OK\n\n----\n\nPerhaps add to `generic_gui_message`?\n\nhttps://github.com/Whonix/msgcollector/blob/master/usr/lib/msgcollector/generic_gui_message\n\n----\n\n```\ntitle=\"UPGRADE NOTICE!\"\n\ntype=\"warning\"\n\nquestion=\"\"\n\nmsg=\"<p>Whonix 14 was released on xxx xx, 2018.<br />\n<br />\nSupport for Whonix 13 will end on xxx xx, 2018.<br />\n<br />\nPlease visit <a href=https://www.whonix.org/wiki/Upgrading_Whonix_13_to_Whonix_14>https://www.whonix.org/wiki/Upgrading_Whonix_13_to_Whonix_14</a> for more information.</p>\"\n\nbutton=\"ok\"\n\nexport title type question button\n\n/usr/lib/msgcollector/generic_gui_message \"$type\" \"$title\" \"$msg\" \"$question\" \"$button\"\n```","comments":[]},"PHID-TASK-35vaqe5i737uwduezuh5":{"id":"864","title":"Fixing old links","status":"resolved","priority":"Low","author":"TNTBOMBOM","description":"I found these links and they need just trivial fixes: \n\n- https://anonymousoperatingsystem.wordpress.com/\n\n\"Whonix blog has moved to: https://www.whonix.org/blog/\" \n\nchange the URL  to https://forums.whonix.org/c/news\n\nalso its better to disable \"leave a comment\" if the comments doesnt reach to you. \n\n- https://trac.torproject.org/projects/tor/wiki/doc/TorBOX\n\nthe correct URL to current hidden services: \n\nhttp://dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion\n\n\ni dunno if these websites still under your control.","comments":[{"author":"Patrick","date_created":1538057984,"date_modified":1538057984,"content":"https://www.whonix.org/blog/ already redirects to https://forums.whonix.org/c/news\n\nrequested deletion of https://anonymousoperatingsystem.wordpress.com/ - but little point - zero visitors since 2014 - the only two visitors recently was probably you and me. It's contents were migrated to Whonix blog and therefore now also to Whonix news forum. Nothing lost. (And it's still available in https://web.archive.org/ for history reasons.)\n\nhttps://trac.torproject.org/projects/tor/wiki/doc/TorBOX can't be edited anymore. Looks like Tor Project disabled editing for non-admins or something. Who still goes to the https://trac.torproject.org/projects/tor/wiki/doc/TorBOX page, and then at the same time follows an old onion link, and can't be bothered to use clearnet link or search engines.... Unlikely.\n\nWouldn't bother Tor Project with this. Since last edit and rename of TorBOX was 5 years ago. Actually the risk is higher of getting the old page deleted without replacement. The history there - https://trac.torproject.org/projects/tor/wiki/doc/TorBOX?action=history - nice to have for historic reasons."}]},"PHID-TASK-ooywy6yr7zuudht3uxjh":{"id":"863","title":"Duplicate Debian repos + fix one repo","status":"invalid","priority":"Normal","author":"TNTBOMBOM","description":"Debian repos are duplicated in /debian.list:\n\n```\ndeb tor+http://sgvtcaew4bxjd7ln.onion stretch/updates main contrib non-free\ndeb http://security.debian.org stretch/updates main contrib non-free\n\ndeb tor+http://vwakviie2ienjx6t.onion/debian stretch main contrib non-free\ndeb http://ftp.us.debian.org/debian stretch main contrib non-free \n\n\n#deb tor+http://sgvtcaew4bxjd7ln.onion stretch/updates main contrib non-free\n#deb http://security.debian.org stretch/updates main contrib non-free\n\n#deb tor+http://vwakviie2ienjx6t.onion/debian stretch main contrib non-free\n#deb http://ftp.us.debian.org/debian stretch main contrib non-free\n```\nand its better to change ftp.us.debian to deb.debian as it contain https support:\n\n```\ndeb https://deb.debian.org/debian stretch main contrib non-free \n```","comments":[{"author":"Patrick","date_created":1537862126,"date_modified":1537862126,"content":"There is no duplicate. It's:\n\n* security repository vs regular repository\n* `deb` vs `deb-src`\n\ndeb.debian.org -> T721"}]},"PHID-TASK-ine4h32dlhvmhd2eqmq7":{"id":"862","title":"test2","status":"invalid","priority":"Needs Triage","author":"mig5","description":"test2","comments":[]},"PHID-TASK-kiz7v7bq74433unavls2":{"id":"861","title":"Test","status":"invalid","priority":"Needs Triage","author":"mig5","description":"test","comments":[]},"PHID-TASK-dnpdpmnway5ysjnfn7mf":{"id":"860","title":"I cant reply?","status":"resolved","priority":"Needs Triage","author":"TNTBOMBOM","description":"i can only create tasks , but i cant reply. \n\n{F11877189}\n\n","comments":[{"author":"mig5","date_created":1537824588,"date_modified":1537824588,"content":"Fixed.\n\n@Patrick had unmarked the 'Create Task' form as an Edit Form on September 20th: https://phabricator.whonix.org/transactions/editengine/maniphest.task/view/1/\n\nNot sure why or if on purpose.\n\nThe effect was that users could no longer edit a task (ticket) nor comment on them, since 'Edit forms' dictate what can be edited *and* commented on (since a comment is a sort of edit).\n\nI have marked it as an Edit form again, and as you can see, I can comment now.\n"},{"author":"mig5","date_created":1537824824,"date_modified":1537824824,"content":"Response provided by the Phabricator devs: https://discourse.phabricator-community.org/t/comment-form-disappeared-in-maniphest/1950/"},{"author":"Patrick","date_created":1537860205,"date_modified":1537860205,"content":"test"},{"author":"Patrick","date_created":1537860294,"date_modified":1537860294,"content":"My mistake. Sorry!"}]},"PHID-TASK-gi7skuxlfou6ecmjhpeu":{"id":"859","title":"test","status":"resolved","priority":"Low","author":"Patrick","description":"","comments":[]},"PHID-TASK-ftkfpgtue6tdsa5iljub":{"id":"858","title":"test if Qubes-Whonix TemplateMVs can upgrade in timesync-fail-closed mode (should not be possible)","status":"resolved","priority":"Normal","author":"Patrick","description":"timesync-fail-closed means sdwdate did not succeed yet. Networking for all but Tor and #sdwdate should still be locked.","comments":[{"author":"0brand","date_created":1539998002,"date_modified":1539998002,"content":"Not sure how to test this. I read through T533  and found this command but it does not restrict Apt traffic.\n\n`sudo rm /var/run/sdwdate/* && sudo service sdwdate restart && sudo service tor restart && whonixcheck_tor_bootstrap_wait_max=10 whonixcheck --gui --cli`\n\nAlso edited :\n\n`/etc/whonix_firewall.d/30_whonix_workstation_default.conf`\n\nChanged `firewall_mode=full` -> `firewall_mode=timesync-fail-closed` but Apt traffic still possible.\n\n\n\nObviously I'm not going in the right directions with this. Or doing something wrong?\n"},{"author":"0brand","date_created":1540028404,"date_modified":1540028404,"content":"Got it. Set `firewall_mode=timesync-fail-closed` in `sys-whonix` and reload `whonix_firewall`. When that is done both `whonix-ws-14` and `whonix-gw-14` upgrades fail.\n\n```\nIgn:1 tor+http://sgvtcaew4bxjd7ln.onion stretch/updates InRelease\nIgn:2 http://vwakviie2ienjx6t.onion/debian stretch-backports InRelease                    \nErr:3 tor+http://sgvtcaew4bxjd7ln.onion stretch/updates Release                           \n  500  Unable to connect\n[...]\nE: The repository 'tor+http://sgvtcaew4bxjd7ln.onion stretch/updates Release' does no longer have a Release file.\nN: Updating from such a repository can't be done securely, and is therefore disabled by default.\nN: See apt-secure(8) manpage for repository creation and user configuration details.\n```"},{"author":"Patrick","date_created":1540379545,"date_modified":1540379545,"content":"Yes. To simulate being in `timesync-fail-closed` mode:\n\nIn `sys-whonix`:\n\n    sudo firewall_mode=timesync-fail-closed whonix_firewall\n\nLooks like ticket is closeable?"},{"author":"0brand","date_created":1540501001,"date_modified":1540501001,"content":"Yes (closeable), updates were not possible in `timesyc-fail-closed` mode. Nothing more to do with this ticket."}]},"PHID-TASK-g6yh37iy6vahqjgl2kts":{"id":"857","title":"Why? Keep? Qubes-Whonix /sbin/ethtool -K ${INTERFACE} sg off | /sbin/ethtool -K ${INTERFACE} tx off","status":"open","priority":"Normal","author":"Patrick","description":"Why does #Qubes-Whonix use\n\n    /sbin/ethtool -K ${INTERFACE} sg off || true\n    /sbin/ethtool -K ${INTERFACE} tx off || true\n\n?\n\n* https://github.com/Whonix/qubes-whonix/blob/master/usr/lib/qubes-whonix/init/network-proxy-setup#L61\n* https://github.com/Whonix/qubes-whonix/blob/master/usr/lib/qubes-whonix/init/network-proxy-setup#L76\n\nWhy is that? (Was introduced by nrgaway.)\n\nUsed in Qubes generally.\n\nShould we keep that?\n\n//cc @marmarek ","comments":[{"author":"Patrick","date_created":1562409132,"date_modified":1562409132,"content":"Any idea? @marmarek "},{"author":"marmarek","date_created":1562420724,"date_modified":1562420724,"content":"It was copied from native setup_ip script, details here:\nhttps://github.com/qubesos/qubes-core-agent-linux/commit/5cbb38a2\nhttps://github.com/qubesos/qubes-issues/issues/700\nIt definitely was relevant for old stubdomain hosting qemu (which is still possible to use in R4.0). Not sure if applies to new linux-based stubdomain.\nIt may be not needed anymore. To verify that, try removing those lines and check networking in Windows (or other OS without Xen PV drivers)."}]},"PHID-TASK-lc5pvkeeujt3tuqdi3kj":{"id":"856","title":"whonix TemplateVM time fetching qrexec service","status":"open","priority":"Normal","author":"Patrick","description":"How should Whonix TemplateVM get their time from?\n\nsdwdate doesn't start. Probably good to reduce attack surface.\n\nWhonix TemplateVM could ask sys-whonix using qrexec.","comments":[]},"PHID-TASK-t7owvelw465ulmj22vgu":{"id":"855","title":"automate /var/lib/tor permission fix","status":"resolved","priority":"Normal","author":"Patrick","description":"~~whonixcheck runs as user `whonixcheck` so we might need a wrapper which gets called using sudo with sudoers.d exception for this test.~~","comments":[{"author":"Patrick","date_created":1541563479,"date_modified":1541563479,"content":"https://github.com/Whonix/whonix-legacy/commit/68741a067c0f4d34bc93149fa8e59b4c222bda51\n\n^ I hope this won't be causing issues in future such as when user/group changes from `debian-tor` to something else (very unlikely?) or when advanced users change user/group ownership for some reason (very unlikely?)."}]},"PHID-TASK-pqafzvs6ofnr6gmns6ev":{"id":"854","title":"whonixcheck grep journal for \"fail\", \"error\" and \"denied\"","status":"resolved","priority":"Normal","author":"Patrick","description":"add here:\nhttps://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_services.bsh\n","comments":[{"author":"Patrick","date_created":1555083630,"date_modified":1555083630,"content":"https://github.com/Whonix/whonixcheck/commit/ded4e9324ffc804a3a4a6118d09de4a2effa63ae"}]},"PHID-TASK-64z2eahfecd4aud34paj":{"id":"853","title":"whonixcheck suggest to start networking / onion-grater if not running","status":"resolved","priority":"Normal","author":"Patrick","description":"Tests are implemented but could offer better advice.","comments":[]},"PHID-TASK-fidlu5s5zn2rjf3ugha7":{"id":"852","title":"research and document how to shut down system on removal of some USB device","status":"open","priority":"Normal","author":"Patrick","description":"Qubes-Whonix:\n\nhttps://www.qubes-os.org/doc/yubi-key/#locking-the-screen-when-yubikey-is-removed\n\nLock screen is not as secure as it could be. Cold instant poweroff would be better. I.e. not \"sudo poweroff\" because Qubes sometimes has bugs preventing clean shutdown (it might wait forever). So better to just use some kernel command to cold poweroff.\n\nIdea not sure it will lead somewhere:\n\n    echo b > /proc/sysrq-trigger\n\n----\n\nNon-Qubes-Whonix:\n\nTODO","comments":[]},"PHID-TASK-37o42i4pjw3mjaqp2umm":{"id":"851","title":"whonixcheck: before claiming the clock is fast -> check if Tor consensus download is done first","status":"open","priority":"Normal","author":"Patrick","description":"","comments":[]},"PHID-TASK-gqurn7oiciecigcvwao5":{"id":"850","title":"sdwdate message tor consensus improvement","status":"resolved","priority":"Normal","author":"Patrick","description":"- the clock is fast -> the clock might be fast\n- ~~add: the Tor consensus might be stale~~ -> T898\n","comments":[{"author":"Patrick","date_created":1555077416,"date_modified":1555077416,"content":"https://github.com/Whonix/anon-shared-helper-scripts/commit/9198d616889389aa4130e21265646a9d73934db1"}]},"PHID-TASK-t5xiacnzl4nd2hfylnwu":{"id":"849","title":"make onion-grater resilient if networking is down","status":"open","priority":"Normal","author":"Patrick","description":"onion-grater if\n\n    ip_address = get_ip_address(global_args.listen_interface)\n\nfails just wait\n\nhttps://github.com/Whonix/onion-grater/blob/master/usr/lib/onion-grater#L749","comments":[]},"PHID-TASK-y3jrj6bxxomwv377ubxr":{"id":"848","title":" [VirtualBox] [FAILED] Failed to start Virtualbox guest utils.","status":"resolved","priority":"Low","author":"Patrick","description":"http://forums.whonix.org/t/failed-failed-to-start-virtualbox-guest-utils/5975/4","comments":[{"author":"Patrick","date_created":1538393320,"date_modified":1538393320,"content":"* https://github.com/Whonix/vbox-disable-timesync/commit/c9c36ebda2134d16cdaa18a3bd20b95978d3f8b6\n* https://github.com/Whonix/vbox-disable-timesync/commit/f669dbc265e246c1a4df0f6c9d6a4e898f6dbcc0\n"}]},"PHID-TASK-23qssx3rle2ecayyzqys":{"id":"847","title":"update https://www.whonix.org/wiki/Dev/Redistribution#Announcement","status":"resolved","priority":"Normal","author":"Patrick","description":"collect all the places where Whonix release announcements should be posted\n\nsuch as\n\n* T846\n* jodonym forum\n* etc.","comments":[{"author":"TNTBOMBOM","date_created":1537947318,"date_modified":1537947347,"content":"At the moment:\n\n- Jondonym Forum\nhttps://anonymous-proxy-servers.net/forum/\n- Widerssecurity \nhttps://www.wilderssecurity.com/threads/whonix-anonymous-os-thread.408150/\n- Bitcoin\nhttps://bitcointalk.org/\n\n\nalso maybe links in T837 (which some of them needs your reviews)"},{"author":"TNTBOMBOM","date_created":1538663708,"date_modified":1538663816,"content":""},{"author":"TNTBOMBOM","date_created":1538824070,"date_modified":1538824070,"content":"i will add to the wiki directly if i will find more."}]},"PHID-TASK-afhntqjbksnswehmapch":{"id":"846","title":"post Whonix release announcements on crypto currency reddit","status":"resolved","priority":"Normal","author":"Patrick","description":"* https://www.reddit.com/r/Monero\n* https://www.reddit.com/r/zec/\n* etc.","comments":[]},"PHID-TASK-t7veafuxnstpfxx54aks":{"id":"844","title":"post on mediawiki mailing list request for mediawiki job","status":"resolved","priority":"Normal","author":"Patrick","description":"post on mediawiki mailing list `mediawiki-l `\n\nhttps://www.mediawiki.org/wiki/Mailing_lists\n\n----\n\nsubject\n\n    Developer Wanted! - Paid modifications for mediawiki skin foreground.\n\n----\n\n> Are you available for paid modifications for mediawiki skin foreground?\n>\n> https://github.com/thingles/foreground\n>\n> List of tasks:\n> * fix wiki Expand All / Collapse All\n> * mediawiki foreground skin: make items in navigation clickable without drop-down and without javascript\n>\n> * There is too much white space on the left and the right side of any wiki page.\n> * Some of our boxes or something breaks mobile view.\n> * css fixes required\n> * mediawiki markup fix required\n> * CodeSelect needs fixes\n> * Bullet point font sizes within footnotes are too big (bigger than normal footnote size), should be smaller.\n> * After a bullet point, there is too little white space before the next non-bullet point text. \n>\n> task details:\n> https://phabricator.whonix.org/T809\n>\n> Conditions:\n>\n> - All modifications could stay Libre Software of course.\n> - The copyright would stay with you. I am neither interested in copyright nor attribution.\n> - The level of transparency is up to you.\n> - I am myself a huge fan of Libre Software.\n> - Contribute the solution as a pull request upstream whenever possible.\n","comments":[{"author":"Patrick","date_created":1537213226,"date_modified":1537213226,"content":"(Also posted here just now: https://github.com/thingles/foreground/issues/334)\n"}]},"PHID-TASK-qq5dsf4ltq3uwzgkgbae":{"id":"843","title":"unsubscribing to whonix mailing list sending empty message","status":"wontfix","priority":"Wishlist","author":"TNTBOMBOM","description":"we need to have nice message sent to user after unsubscribing to whonix mailing list\n\neven very short one like:\n\n\"Thanks for all the efforts you made for Whonix\" ","comments":[{"author":"mig5","date_created":1537237019,"date_modified":1537237019,"content":"@Patrick if you want to share with me out-of-band, the admin password for the mailman lists, I can look at this. I think the 'goodbye' setting is quick and easy to set."},{"author":"Patrick","date_created":1639061250,"date_modified":1639061250,"content":"No mailing list at the moment. Deprecating this issue tracker. Can be re-considered in the future."}]},"PHID-TASK-3l7n34ce2jz4b2wvfcf2":{"id":"842","title":"Cant create not visible tickets","status":"invalid","priority":"Normal","author":"TNTBOMBOM","description":"I need to put stuff here like notes,work schedule ...etc \n\nand sure this is not interest anybody except me, but i cant create ticket and showing this message: \n\n> You can not select this view policy, because you would no longer be able to view the object.\n> You can not select this edit policy, because you would no longer be able to edit the object.\n\n\n\n","comments":[{"author":"Patrick","date_created":1537169105,"date_modified":1537169105,"content":"That's actually very good. I am happy to hear. It's not a bug. It's a feature. We don't want invisible items here for legal reasons."}]},"PHID-TASK-tx5tkncwcuyqju6n2fn6":{"id":"841","title":"Whonix mailing notifications doesnt work for my account","status":"resolved","priority":"Normal","author":"TNTBOMBOM","description":"Im not receiving email notification even though i have enabled them.","comments":[{"author":"mig5","date_created":1537158701,"date_modified":1537158701,"content":"@TNTBOMBOM let me know if it's working now?"},{"author":"mig5","date_created":1537159446,"date_modified":1537159446,"content":"Apparently you didn't get the notification above, but Phabricator tells me it's your fault not ours:\n\n\n```\nroot@whonix:# ./bin/mail show-outbound  --id 36569\n\n...\n\n! TNTBOMBOM (TNT BOM BOM)\n    - Mail Tags: This mail has tags which control which users receive it, and this recipient has not elected to receive mail with any of the tags on this message (Settings > Email Preferences).\n```"},{"author":"mig5","date_created":1537159583,"date_modified":1537159583,"content":"You might need to set many or any of the values at https://phabricator.whonix.org/settings/user/TNTBOMBOM/page/emailpreferences/ to 'Email'"},{"author":"Patrick","date_created":1537169500,"date_modified":1537169500,"content":"If you can't fix, please send me your login password for phabricator so\nI can look."},{"author":"Patrick","date_created":1537179736,"date_modified":1537179736,"content":"https://phabricator.whonix.org/settings/user/TNTBOMBOM/page/emailpreferences/ is wrong indeed. Set to `notify` rather than `e-mail`."}]},"PHID-TASK-2e4yiyoytcgbntx7qvxk":{"id":"840","title":"sign up for mailing lists","status":"resolved","priority":"Normal","author":"Patrick","description":"** http://lists.debian.org/debian-derivatives/\n*** debian-derivatives@lists.debian.org\n\n** https://lists.torproject.org/pipermail/tor-talk/\n*** tor-talk@lists.torproject.org\n\n** https://whonix.org/cgi-bin/mailman/listinfo/whonix-devel\n*** whonix-devel@whonix.org\n\n** https://nmap.org/mailman/listinfo/fulldisclosure\n*** \tfulldisclosure@seclists.org\n\n** https://mailman.stanford.edu/mailman/listinfo/liberationtech\n*** liberationtech@lists.stanford.edu\n","comments":[{"author":"Patrick","date_created":1537031843,"date_modified":1537031843,"content":"Any other mailing lists worth signing up for? @HulaHoop "},{"author":"TNTBOMBOM","date_created":1537105641,"date_modified":1537105641,"content":"> http://lists.debian.org/debian-derivatives/\n>     debian-derivatives@lists.debian.org\n\nDone.\n\n```\n    https://lists.torproject.org/pipermail/tor-talk/\n        tor-talk@lists.torproject.org\n```\n\nDone. (this one looks more accurate i think https://lists.torproject.org/cgi-bin/mailman/listinfo/tor-talk)\n\n>     https://whonix.org/cgi-bin/mailman/listinfo/whonix-devel\n>         whonix-devel@whonix.org\n\nDone.\n\n>     https://nmap.org/mailman/listinfo/fulldisclosure\n>         fulldisclosure@seclists.org\nDone.\n\n>     https://mailman.stanford.edu/mailman/listinfo/liberationtech\n>         liberationtech@lists.stanford.edu\nDone.\n\n\n"}]},"PHID-TASK-ketr5g36ngewulqni3nz":{"id":"839","title":"bookmark outreach workboard","status":"resolved","priority":"High","author":"Patrick","description":"https://phabricator.whonix.org/project/board/144/","comments":[{"author":"TNTBOMBOM","date_created":1537103073,"date_modified":1537103073,"content":"alright done"}]},"PHID-TASK-ntqcstdep55ld4ucutak":{"id":"838","title":"create https://www.virtualbox.org Whonix account","status":"wontfix","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"TNTBOMBOM","date_created":1537102884,"date_modified":1537102884,"content":"Oracle blocking Tor Connections: \n\n\n> \n> The page you are trying to access has been blocked.\n> \n> We apologize for any inconvenience this may have caused.\n> \n> To speak with an Oracle sales representative: 1.800.ORACLE1.\n> \n> To contact Oracle Corporate Headquarters from anywhere in the world: 1.650.506.7000.\n> \n> To get technical support in the United States: 1.800.633.0738.\n>  \n> \n\n"}]},"PHID-TASK-25ulgzodrqpyavztkbax":{"id":"837","title":"create Whonix project accounts","status":"open","priority":"Normal","author":"Patrick","description":"done:\n\n- ~~steemit.com~~ -> T837#19315\n- ~~minds.com~~ -> T837#19315\n- ~~Mastodon~~ -> T837#19315\n- ~~GNU Social (federated service. Each server has independent content policy)~~ -> T837#19315\n- ~~Diaspora~~ -> T837#19315\n\nmaybe later:\n\n- medium.com -> T837#19315\n- dev.to (Developer's log)\n- read https://blog.medium.com/how-to-grow-your-audience-on-medium-307f879a3468\n","comments":[{"author":"TNTBOMBOM","date_created":1537101940,"date_modified":1537101940,"content":"> https://steemit.com\n\nneeds 1-2 weeks for account approval\n\n> https://www.minds.com \n\nneeds ethereum wallet setup which we dont have. mobile number for tokens ( you need to login there and check them out). \n\ncheck your email for username/passwords.\n\n> https://medium.com\n\nin order to sign-up with it , it needs an account either in FB or Google which i dont have access to both.\n"},{"author":"HulaHoop","date_created":1538658740,"date_modified":1538658740,"content":"@TNTBOMBOM I added a few more sites in a second paragraph first ticket. Please create the accounts when you have time."},{"author":"TNTBOMBOM","date_created":1538663614,"date_modified":1538663614,"content":"@HulaHoop \n\nThank you for the good touch: \n\ntake a look at what we have from social media atm: \n\nhttps://www.whonix.org/wiki/Official_Whonix_Online_Profiles#Whonix_Social_Media_Profiles\n\n> dev.to\n\nits not really a tester person like me would do any good there , it fits for programs only.\n\n> GNU Social (federated service. Each server has independent content policy)\n\nalthough i really liked to be there , but it was just a mess of either inactivity + news spammers... it wasnt really well presented to fit anything there. \n\nso let us give them sometime , until they fix that. \n"},{"author":"TNTBOMBOM","date_created":1538824350,"date_modified":1538824350,"content":"@Patrick what do u think of atlyo ? \n\nhttp://atlayofke5rqhsma.onion"},{"author":"TNTBOMBOM","date_created":1545021125,"date_modified":1545021178,"content":"GNU-Social i had an account in it: \n\nhttps://gnusocial.cc/whonix\n\n@Patrick  feel free to close. "},{"author":"Patrick","date_created":1581517245,"date_modified":1581517245,"content":"We now have all of these for a while now:\n\n* https://www.minds.com/Whonix/\n* https://mastodon.technology/@whonix\n* https://gnusocial.cc/whonix\n* steemit.com whonixos (although I cannot login, not even a website login error)\n\nThese are listed here:\nhttps://www.whonix.org/wiki/Official_Whonix_Online_Profiles\n\nGood enough for now."}]},"PHID-TASK-p2h3mm5qk72bapgfghzk":{"id":"836","title":"google: social media strategy; learn","status":"resolved","priority":"Normal","author":"Patrick","description":"google: means \"search the internet\". No need to use actual google. Any search machine will do.\n\nRead the first ~ 20 search results links or so.","comments":[]},"PHID-TASK-mcec4qct6lpsxt4xmwsm":{"id":"835","title":"post contents to https://gab.ai/Whonix","status":"wontfix","priority":"Normal","author":"Patrick","description":"https://gab.ai/Whonix","comments":[{"author":"TNTBOMBOM","date_created":1537097166,"date_modified":1537097166,"content":"{F11874887}\n\nwith TBB security set to \"safer\" , every social media works Twitter,FB,Mastodon ...etc\n\nbut this Gab.ai has extremely bad design filled with JS which is very dangerous. \n\nand tried to find their support forum or email or anything i just couldnt find any. if u have found that please link it to me in order to inform them about this issue and see what they will say. "},{"author":"Patrick","date_created":1537102835,"date_modified":1537102835,"content":"support@gab.ai"},{"author":"TNTBOMBOM","date_created":1537106281,"date_modified":1537106307,"content":"Email have been sent, and waiting for good respond. "},{"author":"Patrick","date_created":1537119489,"date_modified":1537120238,"content":"I don't think they know what TBB is."},{"author":"TNTBOMBOM","date_created":1538663875,"date_modified":1538663875,"content":"this is most likely going to be in the category of wont fix, as they have 0 interaction with emails. "}]},"PHID-TASK-2lopjd3ax52s5l3ap77a":{"id":"834","title":"learn about forum signatures","status":"invalid","priority":"Normal","author":"Patrick","description":"See:\n\nhttps://www.wilderssecurity.com/account/signature\n\nIt just means a text which gets append to each and every post. Whenever possible (usually just classic forums, forums other than discourse) allow it.\n\nEven if just a small signature is allowed, configure one. Because later when account matures, changing the signature will usually change it in all old posts as well.","comments":[{"author":"TNTBOMBOM","date_created":1538677038,"date_modified":1538677560,"content":"They don't accept any HTML or Image preview signature e.g: \n\n```\n<a href=\"htthttp://www.auplod.com/i-odlaupaeb50.htmlp://www.auplod.com/i-odlaupaeb50.html\"><img src=\"http://www.auplod.com/u/odlaupaeb50.png\" alt=\"Image\" border=\"0\" /></a>\n```\n- It will not preview it as an image. though here is a good one: \n\n{F11878648}\n\n- More forms: \n\nhttp://www.auplod.com/i-odlaupaeb50.html\n\n- I have this website to produce nice signatures: \n\nhttp://www.webestools.com/\n\nin wilderssecurity case i doesnt work, maybe just text or so? \n\n"},{"author":"TNTBOMBOM","date_created":1538823906,"date_modified":1538823906,"content":"will use it as a reference if i face one, but sadly those days of signatures seems to be gone. "}]},"PHID-TASK-x6ernfwnds53rrl5hujh":{"id":"833","title":"Software to inlcude from backports","status":"open","priority":"Normal","author":"HulaHoop","description":"Since backports is now necessary for secure components like the kernel and microcode [0] Here is other useful software that is wrth incorporating from this repo once we add it to sources:\n\n*Electrum\n*Ricochet IM\n\n\n[0] http://forums.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion/t/kernel-versions-and-security/5791/10\n","comments":[]},"PHID-TASK-53yt6a2ubqxx2mm5gcbo":{"id":"832","title":"sdwdate support for GETINFO “current-time/{local,utc}”","status":"invalid","priority":"Normal","author":"HulaHoop","description":"At last it seems the Tor network supports natively time queries which makes it the ideal way to check time for sdwdate.\n\nAdvantages:\n\n*Attack surface reduced to that of the Tor daemon\n*No need to worry about miantining lists of active onions or the upcoming deprecation of v2 addresses.\n\n***\n\nThis potentially simplifies a sdwdate-server implementation\n\n\n***\n\nhttps://blog.torproject.org/new-release-tor-0348-also-other-stable-updates-02917-03212-and-03310\n\nMinor features (control port):\n\n    Introduce GETINFO \"current-time/{local,utc}\" to return the local and UTC times respectively in ISO format. This helps a controller like Tor Browser detect a time-related error. Closes ticket 25511 (https://bugs.torproject.org/25511). Patch by Neel Chauhan.","comments":[{"author":"Patrick","date_created":1536735664,"date_modified":1536735664,"content":"https://forums.whonix.org/t/sdwdate-support-for-getinfo-current-time-local-utc/5909/3"}]},"PHID-TASK-iun2jjvftvff2rsll6wu":{"id":"831","title":"create Whonix wilderssecurity.com with new riseup e-mail address","status":"wontfix","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"TNTBOMBOM","date_created":1536761242,"date_modified":1536761242,"content":"communicated with \"contact us\" to approve whonix@riseup.net account and waiting for reply"},{"author":"TNTBOMBOM","date_created":1537106408,"date_modified":1537106408,"content":"will open that once wilderssecurity will communicate with me"}]},"PHID-TASK-nme2jrpgtpk5japlv72k":{"id":"830","title":"Whonix","status":"resolved","priority":"Normal","author":"Patrick","description":"Similar to:\nhttps://www.wilderssecurity.com/threads/qubes-os-thread.379918/page-4\n\n----\n\nsubject:\n\n    Whonix - Anonymous Operating System\n\ncontent:\n\n* mirror all **new** [Whonix News](https://forums.whonix.org/c/news)\n* start with https://forums.whonix.org/t/whonix-14-has-been-released\n","comments":[]},"PHID-TASK-dqojeq3xsam4max4kuo7":{"id":"829","title":"wilderssecurity needs an activated account","status":"resolved","priority":"Needs Triage","author":"TNTBOMBOM","description":"have account there with whonix@riseup.org , but they didnt approve it yet\n","comments":[{"author":"Patrick","date_created":1536687636,"date_modified":1536687636,"content":"Provided `adrelanos` account."}]},"PHID-TASK-66gjbwhdudjbpwr4qxhw":{"id":"828","title":"Send invitation code for riseup","status":"resolved","priority":"Normal","author":"TNTBOMBOM","description":"just send me an invitation so i have riseup email.\n\nThank you","comments":[]},"PHID-TASK-v3lbe7zbze3pax2rvtvp":{"id":"827","title":"make whonixcheck work outside of Whonix","status":"resolved","priority":"Normal","author":"Patrick","description":"Useful in context of a Debian VM deployed by Whonix project\n\nMaybe will be renamed to something suitable.\n\nhttps://forums.whonix.org/t/debian-onevm-anononevm-non-self-contained-host-depending-onevm\n\n    lsb_release -is\n\nDebian","comments":[{"author":"Patrick","date_created":1670517499,"date_modified":1670517499,"content":"whonixcheck was renamed to systemcheck and is now functional in Kicksecure."}]},"PHID-TASK-mdqsp5lq56g76w7s36xr":{"id":"826","title":"try find mediawiki developer","status":"resolved","priority":"Normal","author":"Patrick","description":"Could you please find try to find a\n\ncss / html / javascript / mediawiki developer\n\nfor T809 and  T808\n\nmediawiki developer can be paid.","comments":[{"author":"TNTBOMBOM","date_created":1538824142,"date_modified":1538824142,"content":"seems to be one already been found. closing "}]},"PHID-TASK-4vvpnieeb6o7rxeq5qcq":{"id":"825","title":" Add “Description” to whonix-vbox images ","status":"resolved","priority":"Normal","author":"TNTBOMBOM","description":"It will be nice to add short description about necessary things inside whonix-vbox description part:\n\n{F11871508}\n\nlike e.g:\n\n\n    Whonix is an Anonymous OS That Protects Your Privacy While Surfing The Internet\n\n    Root password: changeme\n    (Please Change Root Password Once You Login)\n\n    #Whonix Website\n\n    Clearnet Link:\n    Onion Link:\n\n    #IRC\n    OFTC -> #whonix\n\n    …etc\n\n\nhttps://forums.whonix.org/t/add-description-to-whonix-vbox-images/5828/1","comments":[{"author":"Patrick","date_created":1555076617,"date_modified":1555076617,"content":"https://github.com/Whonix/whonix-developer-meta-files/commit/2a0064f4214e04a0f454fd1b29fe9f14c6629d2e"}]},"PHID-TASK-qf5y2ngdmefqjudvh5ot":{"id":"824","title":"Graphical issue inside Dolphine (xfce nautilus working fine)","status":"wontfix","priority":"Normal","author":"TNTBOMBOM","description":"Some icons missed/hidden when you use Dolphine inside whonix-qubes\n\n**Pictures:**\n\nhttps://forums.whonix.org/uploads/default/original/2X/3/37c7cf2a8763c804810b966ce682855c834fb1b1.png\n\nhttps://forums.whonix.org/uploads/default/original/2X/a/ae17a4a5a5e8f3c4a917284cbd5b60200b68f577.png\n\nhttps://forums.whonix.org/uploads/default/original/2X/a/ae17a4a5a5e8f3c4a917284cbd5b60200b68f577.png\n\n**Ticket posted here: **\n\nhttps://forums.whonix.org/t/qubes-whonix-14-0-0-6-9-templatevms-for-r3-2-and-r4-testers-wanted/4988/8\n\nNote: Priority i made it \"High\" because it distortion the image/compatibility of files inside Dolphine.","comments":[{"author":"marmarek","date_created":1535893624,"date_modified":1535893624,"content":"whonix.onion links looks invalid (I know what you meant...)\n\nBack to topic: probably some missing package carrying those icons - can you compare list of packages between working and broken system?"},{"author":"TNTBOMBOM","date_created":1535903886,"date_modified":1535903886,"content":">>! In T824#16684, @marmarek wrote:\n> whonix.onion links looks invalid (I know what you meant...)\n> \n> Back to topic: probably some missing package carrying those icons - can you compare list of packages between working and broken system?\n\ni dunno why its mentioned as .onion but not the original onion link, anyway i changed them to the clearnet. \n\nalso there is no working qubes-whonix with icons. all defected."},{"author":"marmarek","date_created":1535904425,"date_modified":1535904425,"content":"Do you have non-qubes instance to compare?"},{"author":"TNTBOMBOM","date_created":1535909435,"date_modified":1535909435,"content":">>! In T824#16687, @marmarek wrote:\n> Do you have non-qubes instance to compare?\n\nhere you go for the packages comparison: \n\nhttps://www.diffchecker.com/8eYB5ijZ\n\nbut i dont know which one is causing the problem. "},{"author":"marmarek","date_created":1535920825,"date_modified":1535920825,"content":"I'd guess breeze-icon-theme."},{"author":"TNTBOMBOM","date_created":1535988386,"date_modified":1535988386,"content":">>! In T824#16689, @marmarek wrote:\n> I'd guess breeze-icon-theme.\n\nnope didnt solve the issue"},{"author":"Patrick","date_created":1536129628,"date_modified":1536129628,"content":"Did you install in TemplateVM, shut down TemplateVM and then restart\nTemplateBasedVM?"},{"author":"TNTBOMBOM","date_created":1536190217,"date_modified":1536190217,"content":">>! In T824#16702, @Patrick wrote:\n> Did you install in TemplateVM, shut down TemplateVM and then restart\n> TemplateBasedVM?\n\nyep tried that , the only thing is the icons will be there but they will not be attached to the missed icons folders automatically. like this: \n\n{F11872397}\n\nso it will keep damaged."},{"author":"Patrick","date_created":1554575856,"date_modified":1554575856,"content":"No longer installing dolphin by default in #Whonix_15."}]},"PHID-TASK-3t3dfutbaujjtkzqtl3y":{"id":"823","title":"stop showing old versions in tb-updater / improve version parser / port version parser to python3 or so","status":"open","priority":"Normal","author":"Patrick","description":"http://forums.whonix.org/t/whonix-shows-older-versions-of-tbb-from-tbb-downloader/5621/6","comments":[]},"PHID-TASK-34asmwbfiqjlgwnc4hji":{"id":"822","title":"disable KDE session restoration","status":"resolved","priority":"High","author":"Patrick","description":"https://forums.whonix.org/t/kdesudo-error-popup-window-sdwdate-gui","comments":[{"author":"Patrick","date_created":1542729183,"date_modified":1542729183,"content":"https://forums.whonix.org/t/user-poll-xfce-vs-kde-kde-deprecation-considered/6235/12"},{"author":"Patrick","date_created":1542729200,"date_modified":1542729200,"content":"Actually this was implemented."}]},"PHID-TASK-kxuwh33wdqqebp47kv45":{"id":"821","title":"Run WhonixCheck in Workstation on First Time Boot","status":"resolved","priority":"Normal","author":"tempest","description":"the new configuration of whonixcheck in whonix 14 runs less frequently in the whonix workstation. yet, for most users, when they first install and run the whonix workstation, numerous updates will be available, including kernel updates. therefore, whonixcheck should run and check for updates on the first boot of the whonix workstation.","comments":[{"author":"Patrick","date_created":1552749127,"date_modified":1552749127,"content":"Done in Whonix `14.0.1.4.4`."}]},"PHID-TASK-ji3igzf4velvi5wf3mvb":{"id":"820","title":"Missing pinentry-qt","status":"resolved","priority":"Normal","author":"HulaHoop","description":"dpkg -l | grep pinentry\nOutput: pinentry-curses\n\nexpected: pinentry-qt\n\nWithout it Enigmail decryption is broken out of the box with no clear explanation.\n\nhttps://forums.whonix.org/t/missing-pinentry-package-whonix-14/5630","comments":[{"author":"Patrick","date_created":1534536207,"date_modified":1534536207,"content":"https://forums.whonix.org/t/missing-pinentry-package-whonix-14/5630/8?u=patrick"}]},"PHID-TASK-jeh27tmet7sfbb5x7pqb":{"id":"819","title":"persistent / live mode indicator systray - graphical indication on the desktop that system is running in live mode vs persistent mode","status":"resolved","priority":"Normal","author":"Patrick","description":"What would be useful is some sort of indication on the desktop that system is running in live mode vs persistent mode.\n\nThis is to inform the user about the mode and not having confused the wrong startup option and believing to have booted another boot option. Would be bad if someone thought it is persistent, but accidentally chosen live and then loosing data. Or chosen persistent but wanting to choose live and then persisting data not wanting to persist.\n\nWhat about a persistent checker systray...?\n\nColors:\n\n* green persistent indicator systray for persistent mode\n* red persistence indicator systray for live mode\n\nAutostart:\n\n* persistent: no, don't autostart persistence indicator systray\n* non-persistent: yes, autostart persistence indicator systray\n\n-----\n\nReference:\nhttps://www.whonix.org/wiki/Whonix_Live\n\n-----\n\nFor now, this is Non-Qubes-Whonix only as per:\nhttps://www.whonix.org/wiki/Whonix_Live#Live-mode_on_Qubes\n","comments":[{"author":"Patrick","date_created":1584001750,"date_modified":1584001750,"content":"* https://github.com/Whonix/whonix-xfce-desktop-config/blob/master/usr/share/livecheck/livecheck.sh\n* https://github.com/Whonix/whonix-xfce-desktop-config/blob/master/etc/skel/.config/xfce4/panel/genmon-12.rc"}]},"PHID-TASK-hb27puul4gcqrpqvinj2":{"id":"818","title":"simplify tb-starter function tb_detect_starter_bin","status":"invalid","priority":"Low","author":"Patrick","description":"Now that https://trac.torproject.org/projects/tor/ticket/18022 was fixed, can be simplified.\n\nIn what TBB version this was fixed?\nIn `7.5.6`? No.\nIn `8.x`?\n\nBy the time this gets fixed it should be available in the stable version of Tor Browser already.\n\n-----\n\n\nSimplified version:\n```\ntb_detect_starter_bin() {\n   if [ ! \"$tb_starter_bin\" = \"\" ]; then\n      return 0\n   fi\n\n   if [ -x \"$tb_browser_folder/start-tor-browser.desktop\" ]; then\n      tb_starter_bin=\"$tb_browser_folder/start-tor-browser.desktop\"\n   else\n      local MSG=\"Neither <code>$tb_browser_folder/Browser/start-tor-browser</code> nor\\\n<code>$tb_browser_folder/start-tor-browser</code> nor \\\n<code>$tb_browser_folder/start-tor-browser.desktop</code> is executable.\"\n      $output ${output_opts[@]} --messagex --typex \"error\" --titlex \"$TITLE\" --message \"$MSG\" --done\n      $output ${output_opts[@]} --messagecli --typecli \"error\" --titlecli \"$TITLE\" --message \"$MSG\" --done\n      exit 2\n   fi\n}\n```","comments":[{"author":"Patrick","date_created":1561619634,"date_modified":1561619634,"content":"https://github.com/Whonix/tb-starter/commit/11ed26d14ed308891db5fc366a1002da41bdd3c1"},{"author":"Patrick","date_created":1561642004,"date_modified":1561642004,"content":"Reverted.\n\nhttps://github.com/Whonix/tb-starter/commit/bd9f6f8c991ad0c170e63ce1412006239aee0760\n\nBlocked by #Qubes.\n`Qubes start menu incompatible with DispVMs launching GUI applications into the background`\nhttps://github.com/QubesOS/qubes-issues/issues/5129"},{"author":"Patrick","date_created":1634319262,"date_modified":1634319262,"content":"Not possible because of above issue."}]},"PHID-TASK-3la4ualaafxtn5dyhvei":{"id":"817","title":"install jitterentropy by default","status":"resolved","priority":"Normal","author":"HulaHoop","description":"Summary: jitterentropy is a RNG designed in the spirit of haveged (using CPU timer jitter as entropy source) except it made up of a kernel module - mainlined since Linux 4.2 and a userspace daemon (jitterentropy-rngd*)  to prevent /dev/random from blocking. The advantage of jitterentropy is by taking advantage of a loaded kernel module, it can ensure randomness is being collected before the CSPRNG is initialized. So, when CSPRNG initialization happens, we can ensure that it is properly seeded on first boot, minimizing the likelihood that exact keys will be created on distinct systems. This is something haveged can't provide, as it runs entirely in userspace.\n\n*jitterentropy-rngd is now included in Debian sid so we should look out for its eventual inclusion in stable next.\n\nhttp://www.chronox.de/jent.html\nhttp://www.chronox.de/jent/doc/CPU-Jitter-NPTRNG.pdf\nhttps://pthree.org/2016/05/24/cpu-jitter-entropy-for-the-linux-kernel/\nhttps://packages.debian.org/sid/jitterentropy-rngd\n\n***\n\nIt would be a good alternative to haveged especially for hypervisors that don't support virtio-RNG and so don't have access to entropy sources early during boot process.\n\n-----\n\n* mailing list thread answered with jitterentropy developer: [How to confirm jitter .ko was loaded](https://www.whonix.org/pipermail/whonix-devel/2019-April/001364.html) (and more explanations provided)\n* https://bugs.debian.org/927972\n* https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=927974\n* https://forums.whonix.org/t/jitterentropy-rngd/7204/11\n* https://github.com/QubesOS/qubes-issues/issues/4174","comments":[{"author":"Patrick","date_created":1555260971,"date_modified":1555260971,"content":"https://github.com/Whonix/anon-meta-packages/commit/060ea154879e4a953cc44751d705f3c686215ddc\n\n`ask Xen developers about Efficacy of jitterentropy RNG in Xen`\nhttps://github.com/QubesOS/qubes-issues/issues/4174\n\n`[Xen-users] Efficacy of jitterentropy RNG in Xen?`\nhttps://lists.xen.org/archives/html/xen-users/2019-04/msg00017.html\n"},{"author":"Patrick","date_created":1555261226,"date_modified":1555261226,"content":"`consider installing jitterentropy-rngd to improve entropy collection`\nhttps://github.com/QubesOS/qubes-issues/issues/4169"},{"author":"Patrick","date_created":1555325534,"date_modified":1555325534,"content":"Answer by jitterentropy developer:\nhttps://github.com/smuellerDD/jitterentropy-rngd/issues/6#issuecomment-483191719\n"},{"author":"Patrick","date_created":1555514652,"date_modified":1555514652,"content":"Could you please test https://github.com/smuellerDD/jitterentropy-rngd/issues/6#issuecomment-483191719 in #Qubes / #VirtualBox? @TNTBOMBOM \n\nCould you please test https://github.com/smuellerDD/jitterentropy-rngd/issues/6#issuecomment-483191719 in #KVM? @HulaHoop"},{"author":"HulaHoop","date_created":1556670103,"date_modified":1556670103,"content":"user@host:~/jitterentropy-20140131/tests_userspace/timing$ ./jitterentropy-inittest\nPass 10000 - Fail 0 - Rounds 10000\n\nfoldtime.O0\nfoldtime.O2\n\nhttps://anonfile.com/g8E9mal5n6/foldtime_O2\nhttps://anonfile.com/63H8m6l9nb/foldtime_O0"},{"author":"Patrick","date_created":1556670231,"date_modified":1556670231,"content":">>! In T817#18429, @HulaHoop wrote:\n> user@host:~/jitterentropy-20140131/tests_userspace/timing$ ./jitterentropy-inittest\n> Pass 10000 - Fail 0 - Rounds 10000\n> \n> foldtime.O0\n> foldtime.O2\n> \n> https://anonfile.com/g8E9mal5n6/foldtime_O2\n> https://anonfile.com/63H8m6l9nb/foldtime_O0\n\nCould you please copy this over to https://github.com/smuellerDD/jitterentropy-rngd/issues/6#issuecomment-483191719 since jitterentropy developer was the one who requested it (and who can make head or tail of it)."},{"author":"HulaHoop","date_created":1558503266,"date_modified":1558503266,"content":"His detailed reply:\n\nhttps://github.com/smuellerDD/jitterentropy-rngd/issues/6#issuecomment-489428226"}]},"PHID-TASK-4l6umjxmpkfzyytlacdi":{"id":"816","title":"error when opening file from Tor Browser / empty open-link-confirmation zenity question box / libGL error: unable to load driver: swrast_dri.so / swrast","status":"open","priority":"Low","author":"Patrick","description":"How to reproduce:\n\n* Download a file such as an image using Tor Browser.\n* Go to the Download tab of Tor Browser.\n* Try to open the file from Tor Browser by double clicking it inside Tor Browser download tab.\n\nWhat's happening?\n\n#open-link-confirmation popup shows up. The buttons are functional but no text is displayed (so one has to guess which one is yes/no).\n\nThis is the relevant bash xtrace.\n\n```\n++ /usr/lib/msgcollector/generic_gui_message warning 'Confirm Open' '<p>The following <b>file</b> will be opened in <u>Tor Browser</u>.</p>\n<p>Be careful if <u>Tor Browser</u> is already running as your activities might get linked.</p>\n<p><code><blockquote>/home/user/.tb/tor-browser/Browser/Downloads/tor-on.png</blockquote></code></p>' 'Continue?' yesno\nlibGL error: unable to load driver: swrast_dri.so\nlibGL error: failed to load driver: swrast\n```\n\n-----\n\n(Saw this xtrace this by commenting in\n\n\n```\nset -x\nexec 1>/tmp/torbrowser.log\nexec 2>/tmp/torbrowser.log\n```\n\nat the top of `/usr/bin/torbrowser`)\n\n-----\n\n* Qubes-Whonix: affected\n* Non-Qubes-Whonix: untested\n\n","comments":[]},"PHID-TASK-p5poiknsmbl46iphg2qg":{"id":"815","title":"sclockadj fingerprinting defense - set time using sclockadj the same way NTP / sntp / chrony / systemd-timesyncd  is changing the clock","status":"open","priority":"Normal","author":"Patrick","description":"* (prefered) Could we install T814, but only use it locally and manually? (#sdwdate calculates the date, but then tells T814 what to do)\n* (fallback) Is it possible to reimplement what T814 does?\n\n-----\n\n* https://www.whonix.org/wiki/Dev/TimeSync#Adjusting_time_slowly_using_adjtimex.2Fntp_adjtime\n* T691#13739\n* T691#13748\n\n-----\n\ncurrent implementation:\n\n* https://github.com/Whonix/sdwdate/blob/master/usr/lib/sdwdate/sclockadj.c\n* https://github.com/Whonix/sdwdate/blob/master/usr/bin/sdwdate\n\n----\n\n* https://www.kicksecure.com/wiki/Dev/sdwdate#chrony_as_a_replacement_for_sclockadj\n","comments":[{"author":"HulaHoop","date_created":1532546450,"date_modified":1532546450,"content":"\n \nthe time could be set with timedatectl by feeding it the time with this command:\n\nset-time [TIME]\n\nhttps://www.freedesktop.org/software/systemd/man/timedatectl.html\n"},{"author":"Patrick","date_created":1532676897,"date_modified":1532676897,"content":"Currently time is set using gnu `date` (clock jump) (initial run after current boot) or `sclockadj` (consecutive run) (slow clock adjustment).\n\n`timedatectl set-time` seems to be doing the same as gnu `date`, i.e. just a clock jump or did I oversee something?\n\nWe'll have figure out what systemd-timesyncd is using to adjust the clock and then figure out if we can call that from sdwdate."},{"author":"HulaHoop","date_created":1532708517,"date_modified":1532708546,"content":"It doesn't seem that timedatectl supports gradual time adjustment. Our next best option is ntpd which can do so but cannot coexist with timedatectl - we can only run either but not both. According to popcon, ntpd is the mos widely used time daemon so its the natural choice.\n\nhttps://www.digitalocean.com/community/tutorials/how-to-set-up-time-synchronization-on-ubuntu-16-04"},{"author":"HulaHoop","date_created":1532712786,"date_modified":1532712786,"content":"\n\nSince we are interested in ntpd's default behavior (for blending in purposes) it turns out that it performs instant clock jumps once the delta difference is excessively large otherwise its slewing algorithm would take forever to adjust the time.\n\nhttps://stackoverflow.com/questions/33746324/ntp-questions-slewing-versus-jumping-the-time\n\n\n\n> ntp doesn't want to jump your clock, because discontinuous time jumps are Bad. It wants to adjust your clock gradually -- very gradually. It's very conservative: by default, it won't slew your clock by more than xx parts per million (ppm).\n> \n> But since ntp is so conservative, if it finds out that your clock is too far off, such that adjusting it gradually would take forever, it will fall back and jump your clock anyway (even though that's Bad). It does this, by default, if it would take longer than yy to adjust your clock gradually.\n\n\n\n\nFor default ntpd:\n\n\n\n> xx: 128ms\n> \n> The ntpd algorithms discard sample offsets exceeding 128 ms, unless the interval during which no sample offset is less than 128 ms exceeds 900s.\n\n\n\n\n> \n> yy: 600s\n> \n> In practice, the need for a step has been extremely rare and almost always the result of a hardware failure or operator error. The step threshold and stepout threshold can be changed using the step and stepout options of the tinker command, respectively. If the step threshold is set to zero, the step function is entirely disabled and the clock is always slewed. The daemon sets the step threshold to 600 s using the -x option on the command line.\n\n\n\n***\n\n**Now with this info in mind, what is the best way to go about this? I think sudden clock jumps done by sdwdate directly are acceptable and less complex than relying on another time daemon that essentially does the same thing. **"},{"author":"Patrick","date_created":1533477174,"date_modified":1533477174,"content":">>! In T815#16509, @HulaHoop wrote:\n> It doesn't seem that timedatectl supports gradual time adjustment.\n\nsystemd-timesyncd does support gradual time adjustment.\n\nhttps://github.com/systemd/systemd/blob/master/src/timesync/timesyncd-manager.c#L247\n\n```\n\n        /*\n         * For small deltas, tell the kernel to gradually adjust the system\n         * clock to the NTP time, larger deltas are just directly set.\n         */\n```\n\n(But even if it wasn't gradually adjusting he clock but was Debian's default we could still consider it nonetheless.)\n\n----\n\n> Since we are interested in ntpd's default behavior (for blending in purposes) it turns out that it performs instant clock jumps **once the delta difference is excessively** large otherwise its slewing algorithm would take forever to adjust the time.\n\nEmphasis is mine. And \"once the delta difference is excessively\" is the crucial point.\n\n> I think sudden clock jumps done by sdwdate directly are acceptable and less complex than relying on another time daemon that essentially does the same thing. \n\n* NTP: uses only clock jumps once the delta difference is excessive, otherwise gradual adjustment\n* sdwdate: therefore should do the same and not only clock jump (otherwise it's fingerprintable)\n"},{"author":"HulaHoop","date_created":1533570395,"date_modified":1533570395,"content":"From what I understand, this code path is only relevant when timesyncd is talking directly with NTP servers and reacting to replies about deltas between local and remote times. There is no  way you can call that function from the command line when using timedatectl standalone AFAICT.\n\nThe only option here is to include this C code snippet in our sclockadj with the variables changed appropriately so sclockadj can call the kernel directly and do this operation by itself.\n\nAnother option is to look into ntpd and see if it can do these operations without it needing to contact servers."},{"author":"HulaHoop","date_created":1533580080,"date_modified":1533580160,"content":"The easy way: calculating the offset between local time and the onion average in timesync then using ntpdate's slew option if the offset is less than 0.5s. Otherwise you tell it to step up the time immediately so that you are accurately mimicking the default behavior. However you can force slewing all the time with -B. This way you won't need to touch kernel syscalls as ntpdate should be able to do the operation for you.\n\nhttps://man.cx/ntpdate(1)\n\n\n> The ntpdate utility makes time adjustments in one of two ways. If it determines that your clock is off by more than 0.5 seconds it simply steps the time by calling gettimeofday(3C). If the error is less than 0.5 seconds, by default, it slews the clock’s time with the offset, by way of a call to adjtime(2). The latter technique is less disruptive and more accurate when the offset is small; it works quite well when ntpdate is run by cron every hour or two. The adjustment made in the latter case is actually 50% larger than the measured offset. This adjustment tends to keep a badly drifting clock more accurate, at some expense to stability. This tradeoff is usually advantageous. At boot time, however, it is usually better to step the time. This can be forced in all cases by specifying the -b option on the command line.\n\n\n\n \t\n\n\n> \n> -b\n> \t\t\n> \n> Step the time by calling gettimeofday(3C).\n\n\n\t\n\n\n\n> -B\n> \t\t\n> \n> Force the time to always be slewed using the adjtime(2) system call, even if the measured offset is greater than +-128 ms. The default is to step the time using settimeofday(3C) if the offset is greater than +-128 ms. If the offset is much greater than +-128 ms in this case, that it can take a long time (hours) to slew the clock to the correct value. During this time the host should not be used to synchronize clients.\n\n\n\n\n\n***\n\nWe need to blackhole network access for ntpdate. Is this easy?"},{"author":"Patrick","date_created":1533581282,"date_modified":1533581282,"content":"Yes, not readily accessible from command line.\n\n>>! In T815#16548, @HulaHoop wrote: \n> The only option here is to include this C code snippet in our sclockadj with the variables changed appropriately so sclockadj can call the kernel directly and do this operation by itself.\n\nYes. Something like that.\n\nPerhaps we could link that code? (In bash terms `source`.) i.e. make sclockadj call that function without having to copy/paste it to our sclockadj. If that is not (reasonably) doable (for example if that code is too systemd specific / too intermingled with systemd) we could also copy/paste that code snippet into sclockadj. Either way, on each major Debian upgrade we would have to check how their code changed but I guess it will change very very little.\n\n> Another option is to look into ntpd and see if it can do these operations without it needing to contact servers.\n\nYes. Similarly if we could pinpoint ntp's time setting C code that could also be linked or copy/pasted for reuse in sclockadj."},{"author":"Patrick","date_created":1533581967,"date_modified":1533581967,"content":"/usr/sbin/ntpdate as far as I know doesn't accept a command line command to take an offset (or anything). It connects to remote servers in its default design.\n\nIn theory, we could make sdwdate provide a local (default) (or optional opt-in server) NTP compatible time provider. Could be useful anyhow. -> #sdwdate-server No idea how hard that would be.\n\nAnd then configure NTP to connect only to that local NTP server.\n\n> We need to blackhole network access for ntpdate. Is this easy?\n\nSounds like a very doable part. NTP runs under user `NTP` anyhow so that user could be firewalled. (NTP is somewhat firewalled anyhow since it's using UDP.)\n"},{"author":"HulaHoop","date_created":1533623873,"date_modified":1533623873,"content":"> In theory, we could make sdwdate provide a local (default) (or optional opt-in server) NTP compatible time provider. Could be useful anyhow. -> sdwdate-server No idea how hard that would be.\n> \n> And then configure NTP to connect only to that local NTP server.\n\nI had the same idea at first but then it gets much more complex as I thought about it. Having the NTP client communicate over localhost is the easier part, however talking to the client would require sdwdate-server to talk NTP - a huge task. A way around that is to also have an offline NTP server which sdwdate then feeds time data that in turn relays it to the NTP client whenever it asks for it and then sets time accordingly - but then I don't see any way we can arbitrarily feed time to the NTP server.\n\n> Perhaps we could link that code? (In bash terms source.) i.e. make sclockadj call that function without having to copy/paste it to our sclockadj.\n\n\nLooks like the most practical solution and one where we can switch out code to support the more popular daemon in the future.\n\n\n\n> Yes. Similarly if we could pinpoint ntp's time setting C code that could also be linked or copy/pasted for reuse in sclockadj.\n\nHere it is but I think its more complicated than timesyncd's code. might as well stick with the latter because its the most widely used now.\n\nhttps://github.com/ntp-project/ntp/blob/1a399a03e674da08cfce2cdb847bfb65d65df237/libntp/adjtime.c\n\n\n\n"},{"author":"Patrick","date_created":1654421789,"date_modified":1654421789,"content":"https://www.kicksecure.com/wiki/Dev/sdwdate#chrony_as_a_replacement_for_sclockadj"}]},"PHID-TASK-brnm247gl7zex4eqbarn":{"id":"814","title":"find out what the most popular time synchronization daemon is / find out debian's default time synchronization daemon","status":"resolved","priority":"Normal","author":"Patrick","description":"How popular is NTP vs sntp vs chrony vs systemd-timesyncd?\n\nIs systemd-timesyncd the new default in Debian stretch?\n","comments":[{"author":"HulaHoop","date_created":1532543909,"date_modified":1532543939,"content":"Stretch+ uses systemd-timesyncd by default therefore its the most popular.\n\nhttps://www.raspberrypi.org/forums/viewtopic.php?t=202779"}]},"PHID-TASK-i7gwtkrcvzidlltmkts5":{"id":"813","title":"Onion Vanguard Security plugin","status":"open","priority":"Normal","author":"HulaHoop","description":"Install Vanguard plugin and ship sane defaults do HS users are easily protected and to enhance privacy level for Onionshare and similar software.\n\nhttps://blog.torproject.org/announcing-vanguards-add-onion-services","comments":[]},"PHID-TASK-3zcmyyrfy65rxic5pe2f":{"id":"812","title":"use onion sources list exclusively for apt-get updating by default","status":"wontfix","priority":"Normal","author":"Patrick","description":"Considering TODO:\n\n* remove clearnet apt sources\n* keep onion apt sources\n\n(At the moment both clearnet and onion sources are being used with priority given to onions and clearnet as a fallback in case of onion connectivity issues.)\n\n* https://github.com/Whonix/anon-apt-sources-list/blob/master/etc/apt/sources.list.d/debian.list\n* https://github.com/Whonix/anon-shared-build-apt-sources-tpo/blob/master/etc/apt/sources.list.d/torproject.list\n* Qubes onion - https://forums.whonix.org/t/onionizing-qubes-whonix-repositories\n\nRelated:\n`deb.debian.org instead of us.debian.org and use https (SSL, TLS) by default` - T721\n","comments":[{"author":"Patrick","date_created":1544858475,"date_modified":1544858475,"content":"`onion service name must be 16 characters long - can't reach Whonix onion repository`\nhttps://forums.whonix.org/t/onion-service-name-must-be-16-characters-long-cant-reach-whonix-onion-repository/6484"},{"author":"Patrick","date_created":1545475869,"date_modified":1545475869,"content":"`onion V3 (repo,website,forum…) reported from different sources is down.`\nhttps://forums.whonix.org/t/onion-v3-for-whonix-website-repo-down/5693/8"},{"author":"Patrick","date_created":1670517469,"date_modified":1670517469,"content":"Not a good idea nowadays due to prolonged DDoS attack on the Tor network. References:\n\n* https://forums.whonix.org/t/most-onions-timing-out-before-loading-on-whonix-v-16/16065\n* https://status.torproject.org/issues/2022-06-09-network-ddos/\n"}]},"PHID-TASK-uh3isqz3afovs27clcdf":{"id":"811","title":"document multiple Qubes TemplateVMs","status":"resolved","priority":"Normal","author":"Patrick","description":"In context of https://www.whonix.org/wiki/Install_Software#Install_from_Debian_testing (and probably others) it would be useful to document on https://www.whonix.org/wiki/Multiple_Whonix-Workstations the possibility of cloned of TemplateVMs. Perhaps we could also link to Qubes documentation if they have that documented.","comments":[{"author":"Patrick","date_created":1554575898,"date_modified":1554575898,"content":"https://www.whonix.org/wiki/Multiple_Whonix-Workstations#Multiple_Qubes-Whonix_TemplateVMs"}]},"PHID-TASK-33y4drgipsoeg3js3hjy":{"id":"810","title":"Qubes template repo does not have a LICENSE or COPYING file","status":"resolved","priority":"Normal","author":"eloquence","description":"The repository at https://github.com/whonix/qubes-template-whonix lacks a COPYING file in the repo, even though there are references to the nonexistent file in other files. While Whonix itself is clearly licensed under GPLv3, it would be useful to also have a COPYING file in this specific repository, so that re-users can be sure that their use is covered by a free software license.","comments":[{"author":"Patrick","date_created":1531124107,"date_modified":1531124107,"content":"Fixed, thanks!"}]},"PHID-TASK-l2cvcxxncfgqxtek7jjb":{"id":"809","title":"mediawiki fixes","status":"resolved","priority":"Normal","author":"Patrick","description":"**mediawiki foreground skin: make items in navigation clickable without drop-down and without javascript**\n\nUpstream ticket.\n\nhttps://github.com/thingles/foreground/issues/182\n\nhttps://forums.whonix.org/uploads/default/original/2X/5/5e5684a89715910c5fcba42b628fd0449a53020c.png\n\nForum discussion:\nhttps://forums.whonix.org/t/wiki-new-skin-is-not-well-functioning/5447/2\n\n-----\n\n~~There is too much white space on the left and the right side of any wiki page.~~\n\n-----\n\n~~Some of our boxes or something breaks mobile view.~~\n\n~~Example page:~~\n~~https://www.whonix.org/wiki/Bridges - There you can scroll to the right even if it shouldn't be possible to scroll to the right.~~\n\n-----\n\n~~css fixes required~~\n\n* ~~reduce space between lines a bit~~\n* ~~increase space between chapters a bit~~\n\n~~Example:~~\n~~whonix.org/wiki/Security_in_Real_World#Nautilus~~\n\n\n~~a) mediawiki original (examples: en.wikipedia.org/wiki/Whonix / en.wikipedia.org/wiki/Unix-like)~~\n\n* ~~The underline below a chapter is good.~~\n* ~~Right amount of space between chapter title and text.~~\n* ~~Right amount of space between chapters.~~\n\n~~b) Whonix wiki:~~\n\n* ~~Too much space after title headline.~~\n* ~~There is too much space between lines of text.~~\n\n~~mediawiki original space between title headline and text and space between lines of text is better. We want Whonix similar to mediawiki in regards to space between lines.~~\n\n----\n\n~~mediawiki markup fix required~~\n\n~~pretty up table / add border between cells~~\n\n~~Examples:~~\n\n* ~~www.whonix.org/wiki/Template:VPN_on_the_host_vs_on_Whonix-Gateway~~\n* ~~www.whonix.org/wiki/Comparison_with_Others~~\n\n----\n\n~~CodeSelect needs fixes:~~\n\n~~www.whonix.org/wiki/Template:CodeSelect~~\n\n* ~~Too big when there is just one line.~~\n* ~~Too small when there are two lines, example: www.whonix.org/wiki/Template:Deactivate_Misc_Proxy_Settings~~\n* ~~Also, if fixable, the `[select code]` text should never cover other text if there is a lot text input.~~\n\n~~Note: these have to look ok with and without javascript enabled.~~\n\n-----\n\n~~Bullet point font sizes within footnotes are too big (bigger than normal footnote size), should be smaller.~~\n\n~~Example on page https://www.whonix.org/wiki/Comparison_with_Others look for\n`Open Source software does not automatically prevent`~~\n\n-----\n\n~~After a bullet point, there is too little white space before the next non-bullet point text. ~~\n\n~~There is more space before the bullet point text than after the bullet point text which is bad style. Should not be needed to use two new lines after a bullet point list.~~\n\n~~Example:~~\n~~www.whonix.org/wiki/FAQ#Software_Comparison~~\n\n-----\n\n~~fix wiki Expand All / Collapse All~~ [already SOLVED](https://forums.whonix.org/t/expand-all-at-once-button-for-wiki-documentation/3959/9?u=patrick)\n\n~~Fix www.whonix.org/wiki/Widget:Expand_or_Collapse_All~~\n\n~~Broken since we switched from mediawiki strapping to mediawiki foreground skin.~~\n\n~~To be used on www.whonix.org/wiki/Documentation~~\n\n~~(It worked previously:)~~\n~~web.archive.org/web/20180430153424/www.whonix.org/wiki/Documentation~~\n\n~~Experiment here:~~\n~~www.whonix.org/wiki/Dev/Documentation~~\n\n~~See browser developer console to see javascript error.~~\n\n-----\n\n**Any other CSS recommendations for a well readable pretty wiki page?**\n\n-----\n\nLikely related:\nhttps://www.whonix.org/wiki/MediaWiki:Common.css\n","comments":[{"author":"Hutchy68","date_created":1538140565,"date_modified":1538140565,"content":"Most of the items have been solved. Exceptions:\n\n  #   mediawiki foreground skin: make items in navigation clickable without drop-down and without javascript\n  #   CodeSelect needs fixes:\n\nCodeSelect has a hard set row=\"1\" in the widget powering it. I cannot find any examples of multiple lines used except as the demo on the template page.\n\nForeground requires JS to function. Not sure how to solve the navigation issue. No JS - no navigation.\n\nhttps://www.whonix.org/wiki/Whonix:Sandbox is a Documentation page change suggested. Works with mobile well, using the tricks MediaWiki uses for columns in `<ref>` tags stacking and unstacking columns.\n\n\n\n\n"},{"author":"Patrick","date_created":1538215125,"date_modified":1538215125,"content":">>! In T809#17271, @Hutchy68 wrote:\n> CodeSelect has a hard set row=\"1\" in the widget powering it. I cannot find any examples of multiple lines used except as the demo on the template page.\n\nCodeSelect multiple line examples (there is a tiny unnecessary scroll bar):\n\n* https://www.whonix.org/wiki/Template:VirtualBox_Spectre_Meltdown\n\nCodeSelect example \"Too big when there is just one line.\" \n\n* https://www.whonix.org/wiki/Template:Open_with_root_rights\n\n> Foreground requires JS to function. Not sure how to solve the navigation issue. No JS - no navigation.\n\nCould you submit https://github.com/thingles/foreground/issues/182#issuecomment-409635256 to mediawiki upstream if that helps?\n\n> https://www.whonix.org/wiki/Whonix:Sandbox is a Documentation page change suggested. Works with mobile well, using the tricks MediaWiki uses for columns in `<ref>` tags stacking and unstacking columns.\n\nMuch better indeed!\n\n----\n\nNot fixed:\n\n* There is too much white space on the left and the right side of any wiki page. (I always have to zoom in to 130% - 150% to use all the space of the screen.) (That is in a maximized desktop browser window.)\n* Some of our boxes or something breaks mobile view. - Example page:\nhttps://www.whonix.org/wiki/Bridges - There you can scroll to the right even if it shouldn't be possible to scroll to the right.\n* `css fixes required` (in original post)\n\nPerhaps more, perhaps a client caching issue? But I was using Tor Browser which shouldn't be caching things."},{"author":"Patrick","date_created":1538292679,"date_modified":1538292679,"content":"For CodeSelect multi line test:\n\n```\n{{CodeSelect|code=\nVBoxManage modifyvm \"Whonix-Gateway\" --ibpb-on-vm-entry on\nVBoxManage modifyvm \"Whonix-Workstation\" --ibpb-on-vm-entry on\nVBoxManage modifyvm \"Whonix-Gateway\" --ibpb-on-vm-exit on\nVBoxManage modifyvm \"Whonix-Workstation\" --ibpb-on-vm-exit on\nVBoxManage modifyvm \"Whonix-Gateway\" --l1d-flush-on-vm-entry on\nVBoxManage modifyvm \"Whonix-Workstation\" --l1d-flush-on-vm-entry on\nVBoxManage modifyvm \"Whonix-Gateway\" --l1d-flush-on-sched on\nVBoxManage modifyvm \"Whonix-Workstation\" --l1d-flush-on-sched on\nVBoxManage modifyvm \"Whonix-Gateway\" --spec-ctrl on\nVBoxManage modifyvm \"Whonix-Workstation\" --spec-ctrl on\nVBoxManage modifyvm \"Whonix-Gateway\" --nestedpaging off\nVBoxManage modifyvm \"Whonix-Workstation\" --nestedpaging off\n}}\n```"},{"author":"Hutchy68","date_created":1538333621,"date_modified":1538333621,"content":"> Not fixed:\n> \n> There is too much white space on the left and the right side of any wiki page. (I always have to zoom in to 130% - 150% to use all the space of the screen.) (That is in a maximized desktop browser window.)\n\nSorry, I was misunderstanding your request. I set the `max-width` to 100%. Most website use a container with a max-width hard set to a number of pixels which is what Foreground does out of the box. You might find the 100% great on lots of pages, maybe not so on others. That would be your call. Anyway, the 100% is now set.\n\n> Some of our boxes or something breaks mobile view. - Example page:\n> https://www.whonix.org/wiki/Bridges - There you can scroll to the right even if it shouldn't be possible to scroll to the right.\n\nThis really has nothing to do with the skin. The issue is the use of `width=800px` or whatever you are setting as a width. Basically, this tells the browser to hard set a width of 800px no matter what the viewport size is which will break mobile if the size is greater than the viewport width. I fixed the template calling your example page. \n\nIf you need a max-width on a page because of formatting, use `max-width:###px`. It is better to just leave off the width call IMHO.\n\n\n"},{"author":"Patrick","date_created":1538376875,"date_modified":1538376875,"content":"Hutchy68 (Tom Hutchison):\n> Hutchy68 added a comment.\n> \n> \n>   > Not fixed:\n>   > \n>   > There is too much white space on the left and the right side of any wiki page. (I always have to zoom in to 130% - 150% to use all the space of the screen.) (That is in a maximized desktop browser window.)\n>   \n>   Sorry, I was misunderstanding your request. I set the `max-width` to 100%. Most website use a container with a max-width hard set to a number of pixels which is what Foreground does out of the box. You might find the 100% great on lots of pages, maybe not so on others. That would be your call. Anyway, the 100% is now set.\n\nGreat!\n\n>   > Some of our boxes or something breaks mobile view. - Example page:\n>   >  https://www.whonix.org/wiki/Bridges - There you can scroll to the right even if it shouldn't be possible to scroll to the right.\n>   \n>   This really has nothing to do with the skin.\n\nSome of our mediawiki css issues indeed aren't directly related to the skin.\n\n> The issue is the use of `width=800px` or whatever you are setting as a width. Basically, this tells the browser to hard set a width of 800px no matter what the viewport size is which will break mobile if the size is greater than the viewport width. I fixed the template calling your example page.\n\nI see. No idea what's doing that. Could you try please to figure out\nwhat's doing this?"},{"author":"Hutchy68","date_created":1538405514,"date_modified":1538405514,"content":"> I see. No idea what's doing that. Could you try please to figure out\nwhat's doing this?\n\nThe use of `style=\"width:800px'\"` being hard set in wiki markup on pages. Seems to mainly focus around pages using mw-expand and mw-collaspse. No idea how many there are. I didn't check but if you have replaceText extension installed you could search for the code and replace with `style=\"width:100%;\"`. Of course it would miss containers that have other style settings hard set. Maybe `width:800px;` to `width:100%;` might work. This is why it is a bad to use style and not classes.\n\n> CodeSelect needs fixes:\n> \n> https://www.whonix.org/wiki/Template:CodeSelect\n> \n> Too big when there is just one line.\n> Too small when there are two lines, example: https://www.whonix.org/wiki/Template:Deactivate_Misc_Proxy_Settings\n> Also, if fixable, the [select code] text should never cover other text if there is a lot text input.\n> Note: these have to look ok with and without javascript enabled.\n\nThis has a lot going on. First, you are hiding a <pre>, then selecting from a textarea, z-indexing a div and the select link, then the link is traversing the dom tree to select text in the textarea while resizing the textarea with a JS call on the classes..... see where I am going? There is a lot going on for a textarea view with a select all code to make it easier to copy it.\n\nBacking up, I added https://www.whonix.org/wiki/Whonix:Sandbox/Code_select as a demo on something a little easier to do. Hover over the text area, left click to select or right click to select and copy. Done. Check it out. I know the `[select text]` link is gone, but hover over the textarea box will add some styling which will clue there is something active to do. I set it so the mouse pointer will change to a \"grab hand\" which is another clue. Click anywhere in the box and the text is all selected. Click again and you can click to select just text you want, which is probably not the use. \n\nMobile, will focus, but not select and I can not see a need to select all and copy to paste somewhere. Who is using their mobile device to copy and paste code to execute or change config files?"},{"author":"Hutchy68","date_created":1538427868,"date_modified":1538427868,"content":"Just a note, I change the mouseover pointer to `cursor: text;` just as the current textareas."},{"author":"Patrick","date_created":1538474465,"date_modified":1538474465,"content":"Awesome!\n\n* `style=\"width:800px'\"` fixed using https://www.whonix.org/wiki/Special:ReplaceText (long time user, awesome extension) Pages such as the https://www.whonix.org/wiki/Bridges no longer needlessly let mobile users to scroll empty content on the right which is good.\n* New code select looks nice. However it does not work yet when javascript is disabled.\n\nI will keep ~~striking through~~ all items which are done in the original ticket."},{"author":"Hutchy68","date_created":1538487546,"date_modified":1538487546,"content":"> New code select looks nice. However it does not work yet when javascript is disabled.\n\nOops, fixed now. \n\n\n\n> a) mediawiki original (examples: https://en.wikipedia.org/wiki/Whonix / https://en.wikipedia.org/wiki/Unix-like)\n> \n> The underline below a chapter is good.\n> Right amount of space between chapter title and text.\n> Right amount of space between chapters.\n> b) Whonix wiki:\n> \n> Too much space after title headline.\n> There is too much space between lines of text.\n> mediawiki original space between title headline and text and space between lines of text is better. We want Whonix similar to mediawiki in regards to space between lines\n\nI made some adjustments which are live right now. Do you want font-size of `h1`, `h2`, etc tags reduced to be more inline with mediawiki? Most of my earlier changes were based on what web-archive whonix looked like with the previous skin. Just need more direction, examples and I will try to match."},{"author":"Hutchy68","date_created":1538489066,"date_modified":1538489066,"content":"I went ahead and toned down font-size on `h` tags a bit. Looks better although `<h3>` might need to drop a touch more, 1.5 instead of 1.6."},{"author":"Patrick","date_created":1538571443,"date_modified":1538571443,"content":"Awesome! All done except: `mediawiki foreground skin: make items in navigation clickable without drop-down and without javascript`\n"},{"author":"Hutchy68","date_created":1538607011,"date_modified":1538607011,"content":"> mediawiki foreground skin: make items in navigation clickable without drop-down and without javascript\n\n@Patrick \n\nI think you are referring to the Actions button. The top bar works with a click, but Foundation 5 has no fallback for clients without JS turned on. So.... I rolled one myself with a pure CSS fallback. Check it out. Actions button now falls back to \"on hover\" with a dropdown menu below the Actions button. Tested and seems to work ok for a user without JS enabled."},{"author":"Hutchy68","date_created":1538623136,"date_modified":1538623136,"content":"Darn, I see the top nav does click to drop but no links are usable in the drops."},{"author":"Patrick","date_created":1538637306,"date_modified":1538637306,"content":"No, not action buttons. But it's cool that this works now. Didn't know that's possible.\n\nYes, I mean the MENU drop down menu.\n\n* Worst: links aren't even clickable without javascript.\n* Very bad: we don't even want a drop-down menu for HOME, DOWNLOAD, DOCS, HELP, NEWS. These items should just be clickable, always visible items at the very top.\n"},{"author":"Hutchy68","date_created":1541423989,"date_modified":1541423989,"content":"Tracker updated at https://github.com/jthingelstad/foreground/issues/182 \n\nWill need to think about the most sensible method to fix this and it will probably break mobile views without JS so it should be noted to users of mobile devices with JS turned off."},{"author":"Patrick","date_created":1551790919,"date_modified":1551790919,"content":"Hi Tom!\n\nCan we remove the `Menu` drop down menu? I don't like drop down menus much anyhow.\n\nAnd instead, can we have some - clickable - without javascript - (even hardcoded) links up there `HOME DOWNLOAD DOCS HELP NEWS` in the top bar?\n\nEven if the \"Menu\" cannot be removed: can we have some - clickable - without javascript - (even hardcoded) links up there `HOME DOWNLOAD DOCS HELP NEWS` in the top bar?\n"},{"author":"Patrick","date_created":1573225007,"date_modified":1573225007,"content":"Migrated remaining task to T868."}]},"PHID-TASK-k367sk5ptlybg4kzyxip":{"id":"808","title":"mediawiki foreground skin: make items in navigation clickable without drop-down and without javascript","status":"invalid","priority":"Normal","author":"Patrick","description":"Upstream ticket.\n\nhttps://github.com/thingles/foreground/issues/182\n\nhttps://forums.whonix.org/uploads/default/original/2X/5/5e5684a89715910c5fcba42b628fd0449a53020c.png\n\nForum discussion:\nhttps://forums.whonix.org/t/wiki-new-skin-is-not-well-functioning/5447/2\n","comments":[{"author":"Patrick","date_created":1537212460,"date_modified":1537212460,"content":"merged into T809"}]},"PHID-TASK-r4otu4anctbap7l4hhlu":{"id":"807","title":"fix wiki Expand All / Collapse All","status":"invalid","priority":"Normal","author":"Patrick","description":"Fix https://www.whonix.org/wiki/Widget:Expand_or_Collapse_All\n\nBroken since we switched from mediawiki strapping to mediawiki foreground skin.\n\nTo be used on https://www.whonix.org/wiki/Documentation\n\n(It worked previously:)\nhttps://web.archive.org/web/20180430153424/https://www.whonix.org/wiki/Documentation\n\nExperiment here:\nhttps://www.whonix.org/wiki/Dev/Documentation\n\nSee browser developer console to see javascript error.","comments":[{"author":"Patrick","date_created":1537212443,"date_modified":1537212443,"content":"merged into T809"}]},"PHID-TASK-erwp4upfahmfzjiuoc4h":{"id":"806","title":"Preload and similar performance tuneups","status":"open","priority":"Normal","author":"HulaHoop","description":"This ticket is for discussing the efficacy of performance profiling programs and their inclusion by default.\n\nhttps://forums.whonix.org/t/preload-to-increase-system-performance/5364/2\n","comments":[]},"PHID-TASK-xlhjb4jtdmqggyi6slsj":{"id":"805","title":"cwtch","status":"invalid","priority":"Normal","author":"HulaHoop","description":"This ticket is for monitoring the progress of cwtch.im the asynchronous IM system constructed on Ricochet. If it reaches maturity and is packaged in the future it would be nice to have by default. If we get packaging help before then it could be a solid addition to our distro.\n\nhttps://forums.whonix.org/t/cwtch-messaging/5353/5\n\n","comments":[{"author":"Patrick","date_created":1670517355,"date_modified":1670517355,"content":"Tracked in https://forums.whonix.org/t/cwtch-messaging/5353/ but could use some new forum tag for things which aren't actionable (not in packages.debian.org) that we want to monitor every now and then over the various releases maybe."}]},"PHID-TASK-jyxuysgqotxr54ayw2xv":{"id":"804","title":"ParrotOS's Firejail Code","status":"open","priority":"Normal","author":"HulaHoop","description":"ParrotOS have made a lot of progress in making firejail a general usable solution out of the box while supporting a ton of programs and surviving upgrades. This ticket is for taking advantage of their code and merging it in our distro. \n\nhttps://forums.whonix.org/t/install-firejail-firetools-by-default/5363/4\nhttps://forums.whonix.org/t/check-parrot-os-sandboxing-code/5361/5\nhttps://forums.whonix.org/t/firejail-seccomp-more-options-for-program-containment/1030/65\n","comments":[{"author":"TNTBOMBOM","date_created":1539450002,"date_modified":1539450061,"content":"@HulaHoop that doesnt mean we dont install firejail by default. \n\nwith or without parrot profiles. because firejail by default it has their own profiles. "},{"author":"TNTBOMBOM","date_created":1540538470,"date_modified":1540538470,"content":"firejail is enough for Whonix-GW\nfirejail + firetools for Whonix-WS"},{"author":"HulaHoop","date_created":1540698543,"date_modified":1540698543,"content":"I disagree. Firetools makes administration easier and has a place on both VMs."},{"author":"TNTBOMBOM","date_created":1540704951,"date_modified":1540704991,"content":"No problem, but needs to add the commands manually to firetools in the GW. \n\nas Firetools doesnt has the graphical icons for non-graphical programs e.g Tor. (and even some graphical programs e.g Tor Browser). \n\nneeds some extra steps , but hope no big deal. "}]},"PHID-TASK-sah57ejyhb4ef2dbciny":{"id":"803","title":"coyIM","status":"invalid","priority":"Normal","author":"HulaHoop","description":"\ncoyIM has the advantage of being designed around Tor support, forcing encryption by default, including INSTANT XMPP account generation and for using a secure backend written in Go.\n\nThe disadvantage is it uses OTR which lack offline message support.\n\nLast blocker to inclusion from Stretch repos was that we needed to confirm stream isolation support which it likely does.\n\nhttps://packages.debian.org/stretch/coyim","comments":[{"author":"HulaHoop","date_created":1533911907,"date_modified":1533911907,"content":"So what task remains for this DNS/TransPort leak testing?"},{"author":"HulaHoop","date_created":1534093627,"date_modified":1534093627,"content":"Done. Connects successfully even when Transparent TCP/DNS  disabled on gateway. So it uses stream isolation out of the box and is ready for prime time."},{"author":"Patrick","date_created":1534271850,"date_modified":1534271850,"content":"Nice!\n\nPlease add to #anon-meta-packages."},{"author":"HulaHoop","date_created":1534354421,"date_modified":1534354421,"content":"\nOld pull request:\nhttps://github.com/Whonix/anon-meta-packages/pull/8\n\nPlease re-base off master so it doesn't erase recent changes by you(?)"},{"author":"Patrick","date_created":1534507407,"date_modified":1534507407,"content":"Could you please send a new pull request?"},{"author":"HulaHoop","date_created":1534521199,"date_modified":1534521199,"content":"Done: https://github.com/Whonix/anon-meta-packages/pull/10\n\nOfftopic: There is a PR from Algernon for intramfs packages, what s their status?"},{"author":"Patrick","date_created":1534533805,"date_modified":1534533805,"content":"Was the wrong package now after CLI / GUI packages split. Anyhow. Done now."},{"author":"Patrick","date_created":1534533976,"date_modified":1534533976,"content":"I've improved the package descriptions btw just now to include if it is a GUI or CLI package.\n\n>>! In T803#16624, @HulaHoop wrote:\n> Offtopic: There is a PR from Algernon for intramfs packages, what s their status?\n\nhttps://forums.whonix.org/t/whonix-for-arm64/1788/58"},{"author":"Patrick","date_created":1555509121,"date_modified":1555509121,"content":"Should remove coyim. Reason:\n\n* https://github.com/coyim/coyim/issues/527\n* https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=927290"},{"author":"TNTBOMBOM","date_created":1555669745,"date_modified":1555669745,"content":"also another reason why CoyIM wont come back in the near future:\n\nhttps://twitter.com/FreeOlaBini"},{"author":"HulaHoop","date_created":1558503397,"date_modified":1558503397,"content":"He was a major dev/creator of CoyIM but not the only one."},{"author":"HulaHoop","date_created":1558503474,"date_modified":1558503474,"content":"@Patrick were you able to reproduce this? I wasn't"},{"author":"Patrick","date_created":1558543524,"date_modified":1558543524,"content":">>! In T803#18478, @HulaHoop wrote:\n> @Patrick were you able to reproduce this?\n\nYes."},{"author":"HulaHoop","date_created":1563755743,"date_modified":1563755743,"content":"Problem has since been reported and fixed upstream. Let's look into re-including by Bullseye."},{"author":"Patrick","date_created":1674124875,"date_modified":1674124875,"content":"Now tracked here:\nhttps://forums.whonix.org/t/coyim-in-whonix-development-discussion/5901"}]},"PHID-TASK-ep3ow54tnspdvbusphee":{"id":"802","title":"whonixcheck should check if torsocks IsolatePID stream isolation is functional","status":"open","priority":"Normal","author":"Patrick","description":"We should run (simplified `[*]`) `curl https://check.torproject.org` three times during `whonixcheck --leak-tests` and compare the returned IP. If it differs, then stream isolation is functional.\n\nThis is important since use use `torsocks` through #uwt / `uwtwrapper`.\n\n----\n\n`[*]` actual code similar to here: https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_stream_isolation.bsh\n\n----\n\nRelated:\n\n* `IsolatePID 1` in https://github.com/Whonix/uwt/blob/master/etc/tor/torsocks.conf.anondist#L44\n","comments":[]},"PHID-TASK-zjqmqtzwtauffleupupr":{"id":"801","title":"use libresolv-wrapper rather than functional Whonix-Gateway system DNS resolver?","status":"invalid","priority":"Normal","author":"Patrick","description":"History:\n\n* We allowed user `debian-tor` on Whonix-Gateway to use system default DNS to make `meek-lite` work.\n** Reference: https://forums.whonix.org/t/censorship-circumvention-tor-pluggable-transports/2601/4?u=patrick\n* We are no longer shipping https://github.com/Whonix/anon-gw-dns-conf/blob/master/etc/resolv.conf.anondist.\n\nMaybe libresolv-wrapper would be a better solution.\n\n* https://packages.debian.org/stretch/libresolv-wrapper\n* https://cwrap.org/resolv_wrapper.html\n\nRelated:\n\n* `libresolv-wrapper does not work with curl` - https://bugzilla.samba.org/show_bug.cgi?id=13482\n* https://c-ares.haxx.se/\n","comments":[{"author":"HulaHoop","date_created":1530309490,"date_modified":1530309490,"content":"Check these alternatives out:\n\nhttps://packages.debian.org/stretch/udns-utils\nhttps://packages.debian.org/stretch/python-adns\n"},{"author":"Patrick","date_created":1554575528,"date_modified":1554575528,"content":"Unfortunately, not possible.\n\n>>! In T801#16285, @HulaHoop wrote:\n> Check these alternatives out:\n> \n> https://packages.debian.org/stretch/udns-utils\n> https://packages.debian.org/stretch/python-adns\n\nThese would require application support."}]},"PHID-TASK-wo55qbljscjnuu4bnt5x":{"id":"800","title":"Migrating from Github","status":"resolved","priority":"High","author":"HulaHoop","description":"In the longterm it would be a good idea to migrate from github. Lets discuss alternatives in this ticket. Fortunately our bugtracker issues have long been migrated to our infrastructure.\n\nThe first question is whether we should self-host the code or use third parties. If we decide on a third party we should see which cannot impose lock-in on our git data.","comments":[{"author":"yzxd","date_created":1529788980,"date_modified":1529788980,"content":"I've done a little research into this. I found the following (free) self-hosted alternatives to GitHub.\n\n  - [[ https://about.gitlab.com/ | GitLab CE ]] ([[ https://gitlab.com/explore | demo ]])\n  - [[ http://gitblit.com/ | Gitblit ]] ([[ https://dev.gitblit.com/ | demo ]])\n  - [[ https://rhodecode.com/ | RhodeCode ]] ([[ https://code.rhodecode.com/ | demo ]])\n  - [[ https://gogs.io/ | Gogs ]] ([[ https://try.gogs.io/ | demo ]])\n  - [[ https://gitea.io/en-US/ | Gitea ]] ([[ https://try.gitea.io/ | demo ]]; this is a fork of Gogs)\n"},{"author":"Patrick","date_created":1546518143,"date_modified":1546518143,"content":"[https://qubes-os.org/faq/#what-does-it-mean-to-distrust-the-infrastructure](https://qubes-os.org/faq/#what-does-it-mean-to-distrust-the-infrastructure)\n\n>What does it mean to “distrust the infrastructure”?\n>\n> A core tenet of the Qubes philosophy is “distrust the infrastructure,” where “the infrastructure” refers to things like hosting providers, CDNs, DNS services, package repositories, email servers, PGP keyservers, etc. As a project, we focus on securing endpoints instead of attempting to secure “the middle” (i.e., the infrastructure), since one of our primary goals is to free users from being forced to entrust their security to unknown third parties. Instead, our aim is for users to be required to trust as few entities as possible (ideally, only themselves and any known persons whom they voluntarily decide to trust).\n>\n>\n> Users can never fully control all the infrastructure they rely upon, and they can never fully trust all the entities who do control it. Therefore, we believe the best solution is not to attempt to make the infrastructure trustworthy, but instead to concentrate on solutions that obviate the need to do so. We believe that many attempts to make the infrastructure appear trustworthy actually provide only the illusion of security and are ultimately a disservice to real users. Since we don’t want to encourage or endorse this, we make our distrust of the infrastructure explicit.\n\n[https://qubes-os.org/faq/#why-do-you-use-github](https://qubes-os.org/faq/#why-do-you-use-github)\n\n>Why do you use GitHub?\n>\n> Three main reasons:\n> \n> 1. We [distrust the infrastructure](http://sik5nlgfc5qylnnsr57qrbm64zbdx6t4lreyhpon3ychmxmiem7tioad.onion/faq/#what-does-it-mean-to-distrust-the-infrastructure), including GitHub (though there are aspects we’re still [working on](https://github.com/QubesOS/qubes-issues/issues/3958)).\n> 2. It’s free (as in beer). We’d have to spend either time or money to implement a solution ourselves or pay someone to do so, and we can’t spare either one right now.\n> 3. It has low admin/overhead requirements, which is very important, given how little time we have to spare."},{"author":"Patrick","date_created":1591290008,"date_modified":1591290008,"content":"Alternative to github.com now needed.\n\nGithub allows maximum file size 100 MB and at time of writing `monero-wallet-gui` was slightly bigger.\n\n```\ngit push origin master\n```\n\n```\nremote: Resolving deltas: 100% (24/24), completed with 13 local objects.\nremote: error: GH001: Large files detected. You may want to try Git Large File Storage - https://git-lfs.github.com.\nremote: error: Trace: 524ad74301f8bed01b8fae36025cbadf\nremote: error: See http://git.io/iEPt8g for more information.\nremote: error: File usr/bin/monero-wallet-gui is 110.91 MB; this exceeds GitHub's file size limit of 100.00 MB\nTo ssh://github.com/Whonix/monero-gui.git\n ! [remote rejected] master -> master (pre-receive hook declined)\nerror: failed to push some refs to 'ssh://git@github.com/Whonix/monero-gui.git'\n```\n\nhttp://git.io/iEPt8g\n\nCan't use gitlab... There is...\n\n> https://gitlab.com/whonix\n\n...but... gitlab.com blocking Tor users:\nhttps://forum.gitlab.com/t/gitlab-com-blocking-tor/38195"},{"author":"Patrick","date_created":1591806056,"date_modified":1591806056,"content":"https://forums.whonix.org/t/whonix-moving-from-github-to-gitlab/9676"}]},"PHID-TASK-xnmam7npoixl7dx5lypt":{"id":"799","title":"Windows(8) Install: Tor not fully bootstrapped - tor control port unreachable.","status":"invalid","priority":"Needs Triage","author":"Martin","description":"Virtualbox updated successfully.\n\nWhonix GW & WS not updateable, tor error.\n\nIn Konsole\nsudo apt-get update\nsomething wicked happened resolving 'deb.whonix.org:http' (-4- Non-recoverable failure in name resolution)\nErr Indexes fail to download.\n\nInstalled just fine under Windows 7.\n\nAny assistance welcome.\n\n","comments":[{"author":"Patrick","date_created":1529666806,"date_modified":1529666806,"content":"Happening since VirtualBox upgrade only and before it worked for you?\n\nDownloaded Whonix version?\n\nRun whonixcheck.\n\n    whonixcheck"},{"author":"Martin","date_created":1529671744,"date_modified":1529671744,"content":"Happening before and after VirtualBox upgarde.\nHappens regardless of installation order.\nHappens also after re-installing GW & WS individually.\n\nWhonixcheck reports Tor's Contol Port could not be reached\nError code 255\n& Err 113 Socket error No route to host."},{"author":"Martin","date_created":1529672034,"date_modified":1529672034,"content":"Whonix Gateway & Workstation :\nVer. 13.0.0.1.4"},{"author":"Patrick","date_created":1529676330,"date_modified":1529676330,"content":"Which message is from Whonix-Gateway whonixcheck?"},{"author":"Martin","date_created":1529678297,"date_modified":1529678297,"content":"Both errors are reported by Whonix-Gateway whonixcheck?\n\nSame errors if run from Konsole or Graphical link in window."},{"author":"Patrick","date_created":1529738739,"date_modified":1529738739,"content":"Did Whonix work for you previously or are you a first time user?\n\nOn https://www.whonix.org/wiki/VirtualBox under `3.Import Whonix into\nVirtualBox` under `For Whonix VirtualBox import instructions, please\npress on expand on the right.` please press the `expand` button for\ndetailed Whonix installation instructions."},{"author":"Martin","date_created":1529738980,"date_modified":1529738980,"content":"It worked just fine in Win 7 install"},{"author":"Patrick","date_created":1529739699,"date_modified":1529739699,"content":"What made it stop working? The VirtualBox update?"},{"author":"Martin","date_created":1529747946,"date_modified":1529747946,"content":"No, it's a fresh install in Win 8.\n"},{"author":"Patrick","date_created":1529807969,"date_modified":1529807969,"content":"Can you try please if any other virtual machines, ones you created yourself or from a different vendor (not Whonix) have working internet?"},{"author":"Martin","date_created":1529810939,"date_modified":1529810939,"content":"Yes, they have working internet.\n\nAlso various tor applications have working internet.\n\nTorbrowser outside of Whonix run from disk or USB also working fine."},{"author":"0brand","date_created":1529887922,"date_modified":1529887922,"content":"Did you [[ https://whonix.org/wiki/Verify_the_virtual_machine_images_using_Windows | verify the Whonix images ]]?\n\nWhere any changes made to Virtualbox or Whonix VMs?\n\n Could you please try using the toubleshooting guide. You have already completed some of the steps.\n\n\n[[ https://whonix.org/wiki/Troubleshooting#Before_you_start | https://whonix.org/wiki/Troubleshooting  ]]"},{"author":"Patrick","date_created":1544334705,"date_modified":1544334705,"content":"User disappeared. Closing."}]},"PHID-TASK-2tdxl2n5tld6cbpi2xio":{"id":"798","title":"VLC X11 Decoding by default","status":"resolved","priority":"Normal","author":"HulaHoop","description":"@Patrick since we now know how to manipulate VLC settings, how about setting its video decoding to X11 by default so it works out of the box and the long text in the known problems section can be removed?","comments":[{"author":"Patrick","date_created":1527671407,"date_modified":1527671407,"content":"Ok."},{"author":"HulaHoop","date_created":1527770673,"date_modified":1527770673,"content":"Did a diff between the versions of the file before/after the change and here is the output:\n\n3760c3760\n #vout=\n---\n vout=xcb_x11\n\n\n***\n\nLet me know what file you changed for the metadata thing so I can do a PR.\n\nThe original path is /home/user/.config/vlc/vlcrc"},{"author":"Patrick","date_created":1528871770,"date_modified":1528871770,"content":"I am not aware of any options. Only location:\n\nhttps://github.com/Whonix/anon-apps-config/blob/master/etc/skel/.config/vlc/vlcrc"},{"author":"HulaHoop","date_created":1529678516,"date_modified":1529678516,"content":"https://github.com/Whonix/anon-apps-config/pull/3/commits/4a882d8b5573839d0e8bbad1a06da1d448cddba6\n"},{"author":"Patrick","date_created":1529738510,"date_modified":1529738510,"content":"Could you please add comments (rationale and ticket link) as well?"},{"author":"HulaHoop","date_created":1530308037,"date_modified":1530308037,"content":"OK did so there\n\nhttps://github.com/Whonix/anon-apps-config/pull/3#issuecomment-401480236"},{"author":"Patrick","date_created":1530325623,"date_modified":1530325623,"content":"No change was registered on that github pull request."},{"author":"Patrick","date_created":1530325805,"date_modified":1530325805,"content":"https://github.com/Whonix/anon-apps-config/blob/master/etc/skel/.config/vlc/vlcrc#L7 is commented\n\nI meant a comment on top here https://github.com/Whonix/anon-apps-config/blob/master/etc/skel/.config/vlc/vlcrc#L8\n\nhttps://github.com/Whonix/anon-apps-config/blob/master/etc/skel/.config/vlc/vlcrc#L8 is currently not commented."},{"author":"HulaHoop","date_created":1530395560,"date_modified":1530395560,"content":"\nhttps://github.com/Whonix/anon-apps-config/pull/4/commits/295b0702221cb4bc2116379fe0861cc6367bfa22"}]},"PHID-TASK-ixkd72wdhcemccfa5nhb":{"id":"797","title":"Issue with Symbolic Links","status":"resolved","priority":"Normal","author":"yzxd","description":"The uwtwrapper script does not handle symlinks properly.\n\nFor example, git installs two symlinks at `/usr/bin/git-receive-pack` and `/usr/bin/git-upload-archive` that point to `/usr/bin/git`. I'm not well versed in bash, but I think that $uwtwrapper_parent is incorrectly set to the symlink, rather than what the symlink points to. The script then tries to run `/usr/bin/git-receive-pack.anondist-orig`, rather than `/usr/bin/git.anondist-orig`. This causes the following error.\n\n```\nuwtwrapper uwt wrapper ERROR: /usr/bin/git-receive-pack.anondist-orig does not exist.\n```","comments":[{"author":"yzxd","date_created":1527481032,"date_modified":1527481447,"content":"I've created a pull request that fixes this issue [here](https://github.com/Whonix/uwt/pull/5). It is a bit clunky since I'm not well-versed in bash, so any criticism is welcome.\n\nEdit: This fixes the symlink part of the issue, but git appears to change behavior based on what symlink it was called by. I haven't a clue on how that would be fixed."},{"author":"Patrick","date_created":1527483934,"date_modified":1527483934,"content":">>! In T797#16103, @yzxd wrote:\n> I've created a pull request that fixes this issue [here](https://github.com/Whonix/uwt/pull/5).\n\nThat looks really good!\n\n> Edit: This fixes the symlink part of the issue, but git appears to change behavior based on what symlink it was called by. I haven't a clue on how that would be fixed.\n\nDunno either how to fix. How does git figure out by which symlink it was called?\n\nDoes it help to add uwt wrappers for /usr/bin/git-receive-pack and /usr/bin/git-upload-archive? I guess either way we should add uwt wrappers for those?"},{"author":"yzxd","date_created":1527515744,"date_modified":1527515744,"content":"> How does git figure out by which symlink it was called?\n\nI thought they were using some magic, but the program name is passed to it as the first argument and parsed [[ https://github.com/git/git/blob/e144d126d74f5d2702870ca9423743102eec6fcd/git.c#L662 | here]]. So it takes `git-receive-pack` and makes it the same as `git receive-pack`.\n\nAfter looking into it a bit further, there is definitely a way to fix it. You can emulate `git-receive-pack` by just calling `exec -a git-receive-pack git` without uwt. The `-a` argument passes its value as the first argument to the program.\n\n> Does it help to add uwt wrappers for /usr/bin/git-receive-pack and /usr/bin/git-upload-archive? I guess either way we should add uwt wrappers for those?\n\nAdding wrappers for them does seem to fix the symbolic link issue without changing any of the code, but git still only gets `/usr/bin/git.anondist-orig` as its first argument. It might make sense to do so.\n"},{"author":"Patrick","date_created":1527558821,"date_modified":1527558821,"content":"Sure. (Let's still fix the code to make it more resilient.)"},{"author":"yzxd","date_created":1527975458,"date_modified":1527975458,"content":"I think I may have another solution that involves just adding the wrapper. If the wrappers were added for them and the symlink renamed to `/usr/bin/git-receive-pack.anondist-orig`, perhaps the symlink could be changed to point from `/usr/bin/git` to `/usr/bin/git.anondist-orig`. Would that still provide stream isolation?\n\nAs for fixing it in the code, I've done limited research so far. The `exec \"$uwtwrapper_parent.anondist-orig\" \"$@\"` cases at the end of the script could be fixed easily with the `-a` parameter. As for `faketime`, it appears that it does preserve the first argument (e.g., `faketime 'yesterday' random-executable` would pass it as `random-executable`, rather than `faketime`). I haven't tested time_privacy or torsocks yet."},{"author":"Patrick","date_created":1528211504,"date_modified":1528211504,"content":">>! In T797#16123, @yzxd wrote:\n> I think I may have another solution that involves just adding the wrapper. If the wrappers were added for them and the symlink renamed to `/usr/bin/git-receive-pack.anondist-orig`, perhaps the symlink could be changed to point from `/usr/bin/git` to `/usr/bin/git.anondist-orig`. Would that still provide stream isolation?\n\nNot easy. Currently handled by config-package-dev (very reliable method). Better not mess with symlinks in other ways.\n"},{"author":"Patrick","date_created":1528212435,"date_modified":1528212628,"content":"```\nuser@host:~$ ls -la /usr/bin/git-receive-pack \nlrwxrwxrwx 1 root root xxx 7 /usr/bin/git-receive-pack -> git\n```\n\nWith your patch https://github.com/Whonix/uwt/pull/5 which is now merged....\n\n    export uwtwrapper_verbose=1\n    git-receive-pack clone https://github.com/Whonix/uwt.git\n\nFirst execution of uwt.\n\n> `exec git clone https://github.com/Whonix/uwt.git`\n\nSecond execution of uwt.\n\n> `exec torsocks /usr/bin/git.anondist-orig clone https://github.com/Whonix/uwt.git`\n\nLooks really good, right? Solved already?"},{"author":"Patrick","date_created":1528217658,"date_modified":1528217658,"content":"`/usr/bin/git-receive-pack` symlinks to `git`.\n\n`/usr/bin/git` symlinks to the bash based uwt wrapper `git.anondist`.\n\nInterestingly during execution of `/usr/bin/git`, `${BASH_SOURCE[0]}` will be set to `/usr/bin/git-receive-pack`.\n\nThis is what will happen during execution of `/usr/bin/git`.\n\n    export uwtwrapper_parent=/usr/bin/git-receive-pack\n    exec /usr/lib/uwtwrapper\n\nWhat the user has run is `git-receive-pack`, which symlinked to `git` but what is actually running is `/usr/lib/uwtwapper` (while `uwtwrapper_parent` is being set to `/usr/bin/git-receive-pack`). So uwt falsely \"thinks\", that `uwtwrapper_parent` is `/usr/bin/git-receive-pack`, while actually `git` is the latest script that has executed `/usr/lib/uwtwapper`.\n\n-----\n\nRelated:\n* Improved comments / debugging.\n* https://github.com/Whonix/uwt/commit/03cc4c8568564d5993fcc8ea975cf00e851f7052\n* https://www.whonix.org/wiki/Stream_Isolation#Nested_Execution\n"},{"author":"yzxd","date_created":1528319298,"date_modified":1528321631,"content":"> Looks really good, right? Solved already?\n\nYup, it's working great! I just tested git pushing to a server with uwt installed and the push went through successfully, so it appears git now gets the proper executable name (`git-receive-pack`). ~~I think this should be safe to close now.~~\n\nEdit: I didn't realize I had `git-receive-pack` symlinked to `git.anondist-orig`. The symlink issue is fixed, but it still only gets `git` as the first argument, rather than `git-receive-pack`. This causes git pushes to still fail, since git interprets `git-receive-pack` differently than just `git`. It should output something like `You must specify a directory.` with some other usage tips rather than the git help page.\n"},{"author":"Patrick","date_created":1528872781,"date_modified":1528872781,"content":"Any `exec -a` command that would work?"},{"author":"Patrick","date_created":1528872881,"date_modified":1528872881,"content":"If yes... We could `uwtwrapper_parent` into variable `uwtwrapper_parent_previous` and pass it to `exec -a` on nested execution of uwt (when `uwtwrapper_counter` is bigger than `1`)."},{"author":"yzxd","date_created":1529029146,"date_modified":1529029146,"content":"> If yes... We could uwtwrapper_parent into variable uwtwrapper_parent_previous and pass it to exec -a on nested execution of uwt (when uwtwrapper_counter is bigger than 1).\n\nFor the simple `exec \"$uwtwrapper_parent.anondist-orig\" \"$@\"`s at the end of the script, I believe the `-a` parameter will work fine.\n\nI tried testing `exec -a git-receive-pack faketime \"today\" git` as well as `exec -a git-receive-pack torsocks git`, but it doesn't appear that they pass the zeroth argument to the program and there's no similar `-a` parameter for them. The only solutions to these I can think of are another wrapper or filing a feature request with those projects.\n\nThe `time_privacy` script could probably be amended to allow a similar functionality to `-a`, since it's local to `uwt` (if it doesn't already, I haven't checked).\n\n"},{"author":"Patrick","date_created":1529058065,"date_modified":1529058065,"content":"Btw don't mind faketime. I doubt anyone is using it. Might be because it\nwas never been documented.\n\nSo solution that only works with torsocks would be good enough and worth\nmerging."},{"author":"yzxd","date_created":1529279588,"date_modified":1529279588,"content":"I've created pull request [#6](https://github.com/Whonix/uwt/pull/6) that fixes this issue and doesn't break any functionality. It adds a new wrapper (`/usr/lib/uwtexec`), which uses a new variable `$uwtwrapper_zeroarg`, `$uwtwrapper_parent`, and the original parameters (`$@`) to execute the program.\n\nI haven't verified that torsocks still isolates the stream (I don't know enough to do so), but I believe it should still work normally."},{"author":"Patrick","date_created":1529282028,"date_modified":1529282028,"content":"Do we really need a new wrapper just for that? See T797#16131 how to do it without.\n\ntorsocks is configured to isolate per PID so it will probably still just work fine."},{"author":"yzxd","date_created":1529347618,"date_modified":1529347618,"content":"For `exec` calls without any wrappers (`faketime` or `torsocks`), the `-a` parameter will work fine.\n\nFor `exec` calls with wrappers, `exec -a {zeroarg} torsocks program.anondist-orig` will provide `{zeroarg}` as the zeroth argument to torsocks, but torsocks will not pass it onto `program.anondist-orig`. We could submit feature requests to the projects and ask for a parameter similar to exec's `-a`, but I'm not sure how long that would take for them."},{"author":"Patrick","date_created":1529373537,"date_modified":1529373537,"content":"Store it in a variable. Export. Read that variable and use it on nested\nexecution?"},{"author":"yzxd","date_created":1529459868,"date_modified":1529459868,"content":"Do you mean something like `exec {wrappers} exec -a $uwtwrapper_zeroarg $uwtwrapper_parent.anondist-orig $@`? I can create a pull request for that but I'm not entirely sure if I'm understanding correctly."},{"author":"Patrick","date_created":1529542967,"date_modified":1529542967,"content":"See https://github.com/Whonix/uwt/pull/6/files#r196984725.\n\nDo you think introducing a second wrapper cannot be avoided?"},{"author":"yzxd","date_created":1529629964,"date_modified":1529630810,"content":"> See https://github.com/Whonix/uwt/pull/6/files#r196984725.\n\nThat specifically won't work due to the wrappers not passing on the zeroth argument, but ~~my above comment with the exec within an exec will work~~.\n\n> Do you think introducing a second wrapper cannot be avoided?\n\n~~It can definitely be avoided, I just didn't realize it at the time. I'll close #6 and make another that doesn't require the additional wrapper.~~\n\nI thought it could be avoided by using exec within an exec, but it turns out exec is a shell builtin and needs to be in a shell script. You can test this by running `exec exec`, which will return something like this: `-bash: exec: exec: not found`."},{"author":"Patrick","date_created":1529640307,"date_modified":1529640307,"content":"Merged. Added some commits on top. Uploaded to Whonix 14 testers repository. Please have a look and test.\n\nhttps://github.com/Whonix/uwt/pull/6/files#r197324054\n\n> Did you test any application using bindp is still functional?\n"},{"author":"yzxd","date_created":1529770324,"date_modified":1529770324,"content":"The two main issues of this issue, following symlinks and passing the zeroth argument properly, do work correctly now with the update in the testers repository.\n\n# torsocks stream isolation\nI've tested that torsocks still isolates streams by changing its `TorAddress` in `/etc/tor/torsocks.conf` to `127.0.0.1`, which didn't have a Tor daemon listening on it. For some strange reason, the change didn't apply immediately, but after a few minutes all binaries with wrappers failed to connect to the outside world.\n\n# bindp\nOn the first run, it failed instantly (for me), since I'm running Debian Stretch. The `/sbin/ifconfig` command no longer exists and the `ip` command is now recommended. This can be solved by installing the `net-tools` package, which provides `/sbin/ifconfig`.\n\nOn the second run with `/sbin/ifconfig` present, it fails with `eth0: error fetching interface information: Device not found`. This is due to Debian 9 using systemd 197+, which implements [Predictable Network Interface Names](https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/). I'm not certain how we could fix the default, but I simply specified my interface's name by prefacing the command with `bindp_interface=ens3`.\n\nOn the third run, I got the error `ERROR: ld.so: object '/usr/lib/libindp.so' from LD_PRELOAD cannot be preloaded (cannot open shared object file): ignored.`, which means the `bindp` package was not installed.\n\nOn the fourth run with `bindp` installed, it succeeded without any error. I ran both `bindp_dispatch=true BIND_ADDR=\"127.0.0.1\" wget http://whonix.org` and `wget http://whonix.org`. The first command failed (as it should, since it only allows local connections, see the second example on [this](https://github.com/yongboy/bindp#usage)) while the second command succeeded."},{"author":"Patrick","date_created":1529899479,"date_modified":1529899479,"content":"Could you try please any application depending on #bindp is still functional? I guess onionshare would be the easiest.\n\nhttps://www.whonix.org/wiki/Onionshare\n\nAre you using #uwt outside of Whonix? That's interesting! Didn't know that happens.\n\nIn Whonix we are disabling systemd predictable network interfaces.\n\n* https://github.com/Whonix/whonix-gw-network-conf/blob/master/debian/whonix-gw-network-conf.links\n* https://github.com/Whonix/whonix-ws-network-conf/blob/master/debian/whonix-ws-network-conf.links\n\nI will fix the missing dependencies of #uwt by adding #bindp and net-tools to `Depends:`.\n\n> which didn't have a Tor daemon listening on it\n\nbtw that is related to https://www.whonix.org/wiki/Dev/anon-ws-disable-stacked-tor"},{"author":"yzxd","date_created":1529976390,"date_modified":1529976390,"content":"> Could you try please any application depending on bindp is still functional? I guess onionshare would be the easiest.\n\nI've tried getting Onionshare v1.3.1 to work, but I'm stuck on step 7 on the wiki page you linked me. It mentions something about onion-grater, but that doesn't exist on my Gateway installation (13.0.0.1.4 for libvirt). I tried skipping the step, but it appears that it won't recognize the `/var/run/tor/control` and tries to fallback to Tor's control port at `127.0.0.1:9050`. \n\nI tried to circumvent this by just setting the control port to `10.152.152.10:9052` and the proxy to `10.152.152.10:9050`, but it failed with the message `Connected to 10.152.152.10:9052, but can't authenticate. Maybe this isn't a Tor controller?`.\n\nI then verified that the control port actually worked, by running `telnet 10.152.152.10:9052` and got a `250 OK` to the `authenticate` command.\n\nI'm not really sure where to continue from here, I can't even get it to run on its own."},{"author":"Patrick","date_created":1529981792,"date_modified":1529981792,"content":"It needs to be developed and tested on Whonix 14."},{"author":"yzxd","date_created":1530206508,"date_modified":1530206508,"content":"> It needs to be developed and tested on Whonix 14.\n\nI must have missed the banner at the top of the page, whoops!\n\nI just tested OnionShare on a fresh Whonix 14 installation using the latest #uwt in the testing repository and it went a lot smoother than trying it with 13. After installing, I tried sharing a few files and it worked perfectly.\n\nI also tested the version in the Debian testing repository and it seems they've updated it to version 1.3, but the current is 1.3.1."},{"author":"Patrick","date_created":1530244467,"date_modified":1530244467,"content":"Awesome, thanks!\n\nThank you for your contribution, I would appreciate if keep contributing to Whonix!"}]},"PHID-TASK-2kxnl5zshc7fq2adqh34":{"id":"796","title":"make anon-ws-disable-stacked-tor systemd-unit-files-generator configurable","status":"resolved","priority":"Normal","author":"Patrick","description":"make #anon-ws-disable-stacked-tor `systemd-unit-files-generator` configurable\n\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/usr/share/anon-ws-disable-stacked-tor/systemd-unit-files-generator","comments":[{"author":"Patrick","date_created":1525858168,"date_modified":1525858168,"content":"Done.\n\n* https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/etc/anon-ws-disable-stacked-tor.d/30_anon-dist.conf\n* https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/usr/lib/anon-ws-disable-stacked-tor/systemd-unit-files-generator"}]},"PHID-TASK-ombircrao5hk4i7rxmrg":{"id":"795","title":"Customized welcome page and bookmarks for I2P / Alt TBB (keyword: homepage)","status":"open","priority":"Normal","author":"HulaHoop","description":"To avoid confusion of users we need a custom landing page for the second \"special\" TBB instance, that explains it won't connect to the clearnet for privacy reasons. The page would have the Whonix ASCII but none of the other clearnet links. Something along the line of \"Attention: This browser is configured to connect to local proxies only. Please check bookmarks for possible destinations. Make sure you have installed/enabled the corresponding software.\"\n\nCustom Bookmarks that point to:\n\n* I2P router config page\n* Any other major default eepsites \n* Freenet\n* Zeronet landing page\n\nOther ideas welcome.","comments":[{"author":"iry","date_created":1527324804,"date_modified":1527324804,"content":"I realized the homepage was set by an environment variable.\n\n /usr/lib/whonix-welcome-page/env_var.sh :\n\n```\n\nTOR_DEFAULT_HOMEPAGE=\"/usr/share/homepage/whonix-welcome-page/whonix.html\"\nexport TOR_DEFAULT_HOMEPAGE\n\n```\n\nI am not sure how we can set different TBB instances to use different homepages. Any thoughts on this? :)"},{"author":"Patrick","date_created":1527347105,"date_modified":1527347105,"content":"The starter script of the alternative TBB instance could overwrite this\nglobal, default environment variable.\n\n(Same syntax as quoted.)\n\nSounds ok?\n\nPackage #tb-starter `/usr/bin/torbrowser` should be enhanced for the\nalternative TBB instance starter (new command line switch?)?"},{"author":"iry","date_created":1527389430,"date_modified":1527389430,"content":"> The starter script of the alternative TBB instance could overwrite this\nglobal, default environment variable.\n\nI was thinking about this solution, the problem is that there maybe some confusion when two TBB instances running at the same time.\n\nLet's say a user starts the Alt TBB, which sets the environment variable, then the user starts the normal TBB, which overwrites the environment variable again. Then when a new homepage tab is opened in Alt TBB, it actually shows the homepage of the normal TBB.\n\nWe may somehow detect if a TBB instance has been running and reject starting another TBB instance?"},{"author":"Patrick","date_created":1527397359,"date_modified":1527397359,"content":"I don't know about running multiple Tor Browser's in parallel, but as\nfar as this environment variable is concerned, there won't be an issue\nmost likely.\n\niry (iry):\n> iry added a comment.\n> \n> \n>     The starter script of the alternative TBB instance could overwrite this\n> \n> global, default environment variable.\n> \n> I was thinking about this solution, the problem is that there maybe some \n> confusion when two TBB instances running at the same time.\n> \n> Let's say a user starts the Alt TBB, which sets the environment variable,\n\nSet the environment variable only for the child process - not globally.\n\nOne cannot change environment variables globally without logout/login\n(usually reboot) to my knowledge.\n\nLike to test? Set `sometest=1` in `/etc/environment`. Then `echo\n\"$sometest\"` in one konsole tab. Then `export sometest=2`. Then `echo\n\"$sometest\"`. Then Then `echo \"$sometest\"` in another konsole tab. In\nthe other konsole tab it will still be set to the original value of `1`.\n\n> then \n> the user starts the normal TBB, which overwrites the environment variable again. \n> Then when a new homepage tab is opened in Alt TBB, it actually shows the \n> homepage of the normal TBB.\n\nI am sure we won't have this issue.\n\n> We may somehow detect if a TBB instance has been running and reject starting \n> another TBB instance?\n\nThis may or may not be required for other reasons but unrelated to\nenvironment variables most likely.\n\nI suggest a new forum thread for this."},{"author":"Patrick","date_created":1527397523,"date_modified":1527397523,"content":"Please reference\n\nhttps://www.whonix.org/wiki/Advanced_Security_Guide#Multiple_Tor_Browser_Instances\n\nsince it might require improvements. It doesn't cover running them at\nthe very same time yet."},{"author":"madaidan","date_created":1557506909,"date_modified":1557506909,"content":"Alternatively, you could change the home page to the program's interface e.g. 127.0.0.1:7657 for I2P and start the browser with a script that creates a popup box using zenity or similar that tells the user the information.\n\nFor example:\n\n\n```\n#!/bin/bash -e\n\nzenity --info --text=\"Attention: This browser is configured to use I2P only. This means it will not use clearnet connections.\"\n\n/usr/bin/i2pbrowser\n```\n\nThe browser would have `(\"browser.startup.homepage\", \"127.0.0.1:7657\")` in a user.js somewhere.\n\nWould it be useful to use Freenet with a second TBB? Fingerprinting isn't an issue on Freenet as only plain HTML/CSS is allowed which means no javascript and there is no central server to analyse any data."}]},"PHID-TASK-kvhbrifn76nrru7rbzmb":{"id":"794","title":"wiki template / broken gpg command updated","status":"open","priority":"Normal","author":"HulaHoop","description":"Updated command to show key fingerprint before adding is in thread. Also updated other IP2 related commands found in the 4th post down.:\n\nhttps://forums.whonix.org/t/gpg-fingerprint-command-obsolete/4819","comments":[]},"PHID-TASK-wpevsiahyxbrxingtzx5":{"id":"793","title":"test if systemd FallbackDNS is really disabled","status":"open","priority":"Normal","author":"Patrick","description":"Shouldn't be needed since `systemd-resolved` is already disabled by #anon-apps-config. Just in case.\n\nreferences:\n\n* T471\n* http://forums.whonix.org/t/os-generated-network-traffic/5084/14\n* how to disable - https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=761658#216\n\nTODO:\n\n* test\n","comments":[{"author":"Patrick","date_created":1525859021,"date_modified":1525859021,"content":"https://github.com/Whonix/anon-apps-config/commit/1174a69194a8d18bd3de1b8a1f6c19d429f69fb4"}]},"PHID-TASK-55cg3jbo2yx6odf4i5ju":{"id":"792","title":"make sure qubes-core-admin-addon-whonix gets installed","status":"resolved","priority":"Normal","author":"Patrick","description":"`qubes-template-whonix-gw` should depend on `qubes-core-admin-addon-whonix`?\n`qubes-template-whonix-ws` should depend on `qubes-core-admin-addon-whonix`?\n\nWhere to declare such a dependency?\n\n([T792](https://phabricator.whonix.org/T792))\n\n----\n\nRelated:\n\n* https://github.com/QubesOS/qubes-issues/issues/3595\n* https://github.com/QubesOS/qubes-core-admin-addon-whonix\n* https://forums.whonix.org/t/qubes-core-admin-addon-whonix-for-qubes-r4-testers-wanted\n\n-----\n\nQubes ticket:\nhttps://github.com/QubesOS/qubes-issues/issues/3881","comments":[]},"PHID-TASK-o2chtmcovuiqtexiv3ux":{"id":"791","title":"qubes-core-admin-addon-whonix / qvm-features-request whonix-ws=1 / add anon-vm tag to whonix-ws-based VMs","status":"resolved","priority":"Normal","author":"Patrick","description":"Quote https://github.com/QubesOS/qubes-core-admin-addon-whonix:\n\n> /etc/qubes/post-install.d (with .sh extension), with just one call:\n> `qvm-features-request whonix-ws=1`\n\ninquiry:\nhttps://github.com/QubesOS/qubes-issues/issues/3765#issuecomment-386805491\n\n-----\n\nadd `anon-vm` tag to `whonix-ws-based` VMs\nhttps://github.com/QubesOS/qubes-issues/issues/3595\n\n-----\n\nTODO (release critical blocker):\nhttps://github.com/QubesOS/qubes-issues/issues/3951","comments":[]},"PHID-TASK-mn7ylgzogy7oyh7toprg":{"id":"790","title":"Reducing the size of raw files","status":"resolved","priority":"Normal","author":"Onion_Knight","description":"The size of raw images produced by the Whonix build process can be significantly reduced by zeroing their remaining unused space. As a result, the size of VirtualBox (.ova) and KVM (.qcow2) distributed images is greatly reduced too, shortening the download process and making their distribution easier. As a side effect, importation of ova images in VirtualBox is also much faster.\n\nThe package zerofree (available in the free Debian repositories) can be conveniently used to perform this task against the raw images (as block devices). Zeroing should occur before the conversion to .qcow2 or .vdi formats. \n\nhttp://forums.whonix.org/t/reducing-size-of-ova-images\n","comments":[{"author":"Onion_Knight","date_created":1525082040,"date_modified":1525096249,"content":""},{"author":"Onion_Knight","date_created":1525096238,"date_modified":1525096266,"content":"{F8152017}\n\nvirt-sparsify solution dropped because needs booting the image with qemu-system (not clean, to much unknown consequences, see attached ouptut).\n"}]},"PHID-TASK-yyyppz6noe3oltt3qz3t":{"id":"789","title":"test Tor Browser first boot population in Qubes-Whonix 14 Qubes R4","status":"resolved","priority":"Normal","author":"Patrick","description":"In TemplateBased AppVM and DispVM.\n\nhttps://github.com/Whonix/tb-updater/issues/2\n\nhttps://github.com/QubesOS/qubes-issues/issues/3740","comments":[]},"PHID-TASK-zy3743a6gkfphlrwvsjd":{"id":"788","title":"Qubes-Whonix 14 SaltStack state files required","status":"resolved","priority":"High","author":"Patrick","description":"https://github.com/QubesOS/qubes-issues/issues/3765\n\nhttps://forums.whonix.org/t/qubes-whonix-14-saltstack-state-files-testers-wanted/5324/1\n","comments":[]},"PHID-TASK-edxhcdhr5va73o5xp64l":{"id":"787","title":"Use correct Tor --verify command","status":"resolved","priority":"Normal","author":"iry","description":"The only correct torrc checking in Whonix-Gateway is `sudo --non-interactive /usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-torrc -f /etc/tor/torrc --RunAsDaemon 0 --verify-config`. Because we need to simulate what Tor really uses normally. Tor is started by systemd which uses the parameters as above, therefore, we need to keep the verification consistent with it.\n\n`sudo -u debian-tor tor --verify-config`, which is currently widely used in Whonix, will give us a false positive that `Configuration was valid` but it only examines the situation where Tor only uses default torrc. \n\n```\n       --defaults-torrc FILE\n           Specify a file in which to find default values for Tor options. The contents of this file are overridden by those\n           in the regular configuration file, and by those on the command line. (Default: /etc/tor/torrc-defaults.)\n```\n\nPatrick [[ https://github.com/Whonix/whonixsetup/pull/1#discussion_r179678165 | has helped to pointed out that ]]:\n\n    whonixcheck (currently using tor --verify-config)\n    whonixsetup (currently using tor --verify-config)\n    acw (maybe using tor --verify-config in future)\n    anon-shared-helper-scripts (maybe the code should be shared and put there but not sure it's enough code to justify the code sharing, maybe not)\n\nTherefore, we need to switch to the correct tor --verify command.\n\nWe may also keep an eye on the command line to start Tor used by systemd, just in case there will be any changes in the future.","comments":[{"author":"iry","date_created":1523661122,"date_modified":1523661122,"content":"https://github.com/Whonix/whonixcheck/pull/9"},{"author":"iry","date_created":1523661473,"date_modified":1523661473,"content":"https://github.com/Whonix/whonixsetup/pull/2"},{"author":"iry","date_created":1523661904,"date_modified":1523661904,"content":"I grepped all the whonix source code and I believe these two PRs are enough to fix all the existing  wrong tor --verify commands and hints used in Whonix."},{"author":"iry","date_created":1523662269,"date_modified":1523662269,"content":"> Tor is started by systemd which uses the parameters as above, therefore, we need to keep the verification consistent with it.\n\nThis means we should always keep an eye on the changes on the systemd changes in debian tor package.\n\nSpecifically:\n\n\n```\nuser@host:~$ grep -r -i \"exec\" /lib/systemd/system/tor@default.service\nExecStartPre=/usr/bin/install -Z -m 02755 -o debian-tor -g debian-tor -d /var/run/tor\nExecStartPre=/usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-torrc -f /etc/tor/torrc --RunAsDaemon 0 --verify-config\nExecStart=/usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-torrc -f /etc/tor/torrc --RunAsDaemon 0\nExecReload=/bin/kill -HUP ${MAINPID}\n```\n"},{"author":"Patrick","date_created":1523694795,"date_modified":1523694795,"content":"It fixes it in theory but it's very user unfriendly to ask to type such a long command.\n\nCould you add a new (python) wrapper here please? (Also the reason why using the short command in the first place.)\n\nhttps://github.com/Whonix/anon-gw-anonymizer-config/tree/master/usr/bin\n\nAnd the reference that wrapper instead?\n\nIdeal...? (So this won't need updates long term?)\n\nMatch from `ExecStartPre=/usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-torrc -f /etc/tor/torrc --RunAsDaemon 0 --verify-config` the `/usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-torrc -f /etc/tor/torrc --RunAsDaemon 0 --verify-config` part and execute?"},{"author":"iry","date_created":1523762688,"date_modified":1523762688,"content":"> Could you add a new (python) wrapper here please? (Also the reason why using the short command in the first place.)\n\nGreat idea.\n\nI haven't done yet. But here is the progress:\n\nhttps://github.com/Whonix/anon-gw-anonymizer-config/pull/10"},{"author":"iry","date_created":1529260801,"date_modified":1529260801,"content":"Patrick Schleizer:\n> Added a very few commits on top. Including sudoers.d. Should be shorted. But not fully tested. Please test when convenient.\n> \n> https://github.com/Whonix/anon-gw-anonymizer-config/blob/master/etc/sudoers.d/anonymizer-config-gateway\n> \nThank you for the commits, Patrick!\n\nIt works fine for me! :)"}]},"PHID-TASK-5z6xai4isvjqkw52vsor":{"id":"786","title":"consider installing phonon4qt5-backend-null by default on Whonix-Gateway","status":"invalid","priority":"Normal","author":"Patrick","description":"Trying to rip out anything audio, vlc and phonon related from Whonix-Gateway.\n\n[1]\n\n    sudo apt-get install phonon4qt5-backend-null\n\nAnd also...\n\n    sudo apt-get autoremove\n    sudo apt-get purge vlc*\n    sudo apt-get purge libvlc*\n    sudo apt-get autoremove\n\nStill dependency hell.\n\n    sudo apt-get purge phonon-backend-gstreamer\n\nCould a Debian bug.\n\n```\nreverse-depends phonon-backend-gstreamer\nReverse-Depends\n===============\n* auralquiz\n* phonon\n```\n\nPerhaps `phonon` should depend on virtual package `phonon-backend` rather than `phonon-backend-gstreamer` directly.\n\n-----\n\n[1]\nResults in a for the user confusing debconf question.\n\n```\n┌─────────────────────────────────┤ Warning: Phonon4Qt5 is not functional ├─────────────────────────────────┐\n │                                                                                                           │ \n │ Missing back-end for Phonon4Qt5                                                                           │ \n │                                                                                                           │ \n │ Applications using Phonon4Qt5 (the KF 5 multimedia framework) will produce no audio or video output,      │ \n │ because only a dummy Phonon back-end is installed on this system. This is typically an unintended         │ \n │ configuration.                                                                                            │ \n │                                                                                                           │ \n │ To restore full Phonon4Qt5 multimedia capabilities, install one of the real Phonon4Qt5 back-end packages  │ \n │ which are currently available for this system:                                                            │ \n │                                                                                                           │ \n │ phonon4qt5-backend-vlc (recommended), phonon4qt5-backend-gstreamer                                        │ \n │                                                                                                           │ \n │                                                  <Ok>                                                     │ \n │                                                                                                           │ \n └───────────────────────────────────────────────────────────────────────────────────────────────────────────┘ \n```\nMaybe it can be silenced.","comments":[{"author":"Patrick","date_created":1555257050,"date_modified":1555257050,"content":"Since we no longer install any KDE applications by default (such as dolphin; ark), no dependency pulls phonon anymore so in extension nothing pulls vlc anything anymore. Therefore this is no longer needed."}]},"PHID-TASK-gx3udxfmpqdboun5frx7":{"id":"785","title":"Use /lib/systemd/system/tor@service.d instead","status":"open","priority":"Normal","author":"iry","description":"We want to executing some scripts before starting Tor. For example, script that fix the missing file and directory or script that shows [detailed Tor configuration report](http://forums.whonix.org/t/whonixcheck-whonix-14-ideas/2456/15). \n\nHowever, a drop-in file in `/lib/systemd/system/tor@default.service.d` may not work as expected. This is because, before executing the drop-in file, tor@default.service will check the tor configuration. If the --verify-config return non-zero, the tor@default.service will just fail and stop further executing, without giving the drop-in file a chance to fix the problem.\n\n> user@host:~$ grep -i \"execstartpre\" /lib/systemd/system/tor@default.service\n> ExecStartPre=/usr/bin/install -Z -m 02755 -o debian-tor -g debian-tor -d /var/run/tor\n> ExecStartPre=/usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-torrc -f /etc/tor/torrc --RunAsDaemon 0 --verify-config\n\n[[ http://forums.whonix.org/t/whonixcheck-whonix-14-ideas/2456/18 | Patrick proposed a workaround that ]]:\n\n> we can extend /lib/systemd/system/tor.service with ExecStartPre=... systemd unit file drop-in instead.\n> [...]\n> Maybe we shouldn’t tell users to engage with sudo systemctl restart tor@default.service directly but use sudo systemctl restart tor.service instead.\n\nThis approach has been used by Qubes:\n\n```\nuser@host:~$ ls -l /lib/systemd/system/tor.service.d\ntotal 8\n-rw-r--r-- 1 root root  90 Feb 22 11:49 30_qubes.conf\n-rw-r--r-- 1 root root 313 Oct 21  2015 40_qubes.conf\n```","comments":[]},"PHID-TASK-hruj7emykqcbxghnrbnx":{"id":"784","title":"Tor log parsing for better debugging info","status":"open","priority":"Low","author":"iry","description":"Patrick [[ https://github.com/Whonix/whonixcheck/pull/8#issuecomment-377917888 | proposed ]] a good idea:\n\n> Tor log parsing would be cool in case there are no Tor config issues but the Tor systemd unit is still failing.","comments":[]},"PHID-TASK-uk633xxg22rj6kqwqqua":{"id":"783","title":"Tor log parsing for better debugging info","status":"open","priority":"Normal","author":"iry","description":"Patrick [[ https://github.com/Whonix/whonixcheck/pull/8#issuecomment-377917888  | proposed ]] a good idea :\n\n> \n> Tor log parsing would be cool in case there are no Tor config issues but the Tor systemd unit is still failing.\n\n","comments":[]},"PHID-TASK-gekpg3cqmfshqswiv6jf":{"id":"782","title":"Change Settings in VirtualBox GW and WS - boot devices and audio","status":"resolved","priority":"Normal","author":"unman","description":"As per TNT_BOM_BOM [[ https://forums.whonix.org/t/whonix-virtualbox-14-0-0-6-9-release-candidate-2-testers-wanted/4972/4 | here ]] -\n\n\nWhonix GW and Whonix WS the Floppy + Optical are on by default. They need to be disabled for enhanced security.\n(Settings - System - Motherboard - Boot Order - :x: :floppy_disk: Floppy & :cd: Optical)\n\nWhonix GW Audio should be disabled by default :mute:.\n(Settings - Audio - :x: Enable Audio)\n","comments":[{"author":"Patrick","date_created":1522999832,"date_modified":1522999832,"content":"https://github.com/Whonix/Whonix/pull/415"},{"author":"Patrick","date_created":1555248722,"date_modified":1555248722,"content":"Does this work? @TNTBOMBOM "},{"author":"TNTBOMBOM","date_created":1555253917,"date_modified":1555253917,"content":"yes it working"},{"author":"Patrick","date_created":1555253944,"date_modified":1555253944,"content":"Awesome!"}]},"PHID-TASK-arozqyokt4wx3whnyuen":{"id":"781","title":" tb-updater do not populate home directory at first boot?","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/tb-updater/issues/2","comments":[{"author":"Patrick","date_created":1522673515,"date_modified":1522673515,"content":"Attempted fix:\nhttps://github.com/Whonix/tb-updater/commit/8a923d959fb2c0a3e2a4af554cfb2decef0dfa91"}]},"PHID-TASK-2ep3huph5roy7uueeyor":{"id":"780","title":"sound / video broken in Qubes-Whonix 14","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/QubesOS/qubes-issues/issues/3685","comments":[{"author":"Patrick","date_created":1520690581,"date_modified":1520690581,"content":"https://github.com/QubesOS/qubes-issues/issues/3685#issuecomment-372031972"},{"author":"Patrick","date_created":1520690598,"date_modified":1520690609,"content":""}]},"PHID-TASK-dtn6sb7adcyreajnxfbw":{"id":"778","title":"scrub environment variables leftovers from Whonix 13 -> Whonix 14 upgrade","status":"wontfix","priority":"Normal","author":"Patrick","description":"    env\n\nCompare new build and upgraded build.","comments":[{"author":"unman","date_created":1520560188,"date_modified":1520560188,"content":"Clean install of 13, and upgraded as per the instructions.\nCompared to a clean install of 14:\nThe significant differences - WS:\n|Upgraded|Clean install|\n| SSH_AUTH_SOCK=/tmp/ssh-VznSVpYqegHr/agent.1151 | \n| SSH_AGENT_PID=1280||\n|QT_ACCESSIBILITY=1||\n|GTK_MODULES=gail:atk-bridge |   |\n| QT_LINUX_ACCESSIBILITY_ALWAYS_ON=1||\n|DBUS_SESSION_BUS_ADDRESS=unix:abstract=/tmp/dbus-uWy1DusqXy,guid=899496dd6877f2478d08a7145aa1410e|DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus|\n|XDG_CONFIG_DIRS=/usr/share/whonix-ws-kde-desktop-conf/:/usr/share/torbrowser-default-browser/:/usr/share/security-misc/:/usr/share/kde-sounds-off/:/usr/share/kde-privacy/:/usr/share/kde-no-move-max-win/:/usr/share/kde-mouse-doubleclick/:/usr/share/kde-lowfat/:/usr/share/kde-kgpg-tweaks/:/usr/share/kde-dolphin-menubar-enable/:/usr/share/kde-common-resolution/:/usr/share/kde-apper-no-autoupdate/:/usr/share/anon-ws-kde-startmenu/:/usr/share/anon-kde-streamiso/:/usr/share/anon-apps-config/:/usr/share/open-link-confirmation/:/usr/share/kde-power-savings-disable-in-vms/:/usr/share/kde-screen-locker-disable-in-vms/:/etc/xdg| XDG_CONFIG_DIRS=/usr/share/torbrowser-default-browser/:/usr/share/security-misc/:/usr/share/kde-apper-no-autoupdate/:/usr/share/anon-ws-kde-startmenu/:/usr/share/anon-apps-config/:/usr/share/open-link-confirmation/:/usr/share/kde-power-savings-disable-in-vms/:/usr/share/kde-screen-locker-disable-in-vms/:/etc/xdg|\n\nApart from these, all environment variables are consistent between the two VMs."},{"author":"unman","date_created":1520560472,"date_modified":1520560472,"content":"And for GW:\n\n|Upgraded|Clean install|\n|SSH_AUTH_SOCK=/tmp/ssh-udPZOk1axu2G/agent.1050||\n|SSH_AGENT_PID=1179||\n|QT_ACCESSIBILITY=1||\n|GTK_MODULES=gail:atk-bridge||\n|QT_LINUX_ACCESSIBILITY_ALWAYS_ON=1||\n|DBUS_SESSION_BUS_ADDRESS=unix:abstract=/tmp/dbus-Yy4aEyhItS,guid=00496b5a6863fc5cb9aa9ef95aa13f64|DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus|\n|XDG_CONFIG_DIRS=/usr/share/whonix-gw-kde-desktop-conf/:/usr/share/security-misc/:/usr/share/kde-sounds-off/:/usr/share/kde-privacy/:/usr/share/kde-no-move-max-win/:/usr/share/kde-mouse-doubleclick/:/usr/share/kde-lowfat/:/usr/share/kde-kgpg-tweaks/:/usr/share/kde-dolphin-menubar-enable/:/usr/share/kde-common-resolution/:/usr/share/kde-apper-no-autoupdate/:/usr/share/anon-gw-kde-startmenu/:/usr/share/anon-apps-config/:/usr/share/open-link-confirmation/:/usr/share/kde-power-savings-disable-in-vms/:/usr/share/kde-screen-locker-disable-in-vms/:/etc/xdg|XDG_CONFIG_DIRS=/usr/share/whonix-gw-kde-desktop-conf/:/usr/share/security-misc/:/usr/share/kde-apper-no-autoupdate/:/usr/share/anon-gw-kde-startmenu/:/usr/share/anon-apps-config/:/usr/share/open-link-confirmation/:/usr/share/kde-power-savings-disable-in-vms/:/usr/share/kde-screen-locker-disable-in-vms/:/etc/xdg|\n"},{"author":"Patrick","date_created":1521033268,"date_modified":1521033268,"content":"Looks like nothing serious.\n\naccessibility leftovers. Probably env var load from `/etc/X11/Xsession.d/` so should be deleted from #whonix-legacy.\n\n- https://github.com/Whonix/whonix-legacy/blob/master/debian/whonix-legacy.preinst#L402\n\nIf so, could you `rm -f` it from there please?\n\nNot sure what the ssh means or is coming from but probably similar and also remove?\n\nNot worth delaying the Whonix 14 release but good to be cleaned up at some point."},{"author":"Patrick","date_created":1530354977,"date_modified":1530354977,"content":"TODO: investigate and scrub leftovers"}]},"PHID-TASK-hfmeo3rks4oqzbgjwyz7":{"id":"777","title":"torproject.org tlsv1.0 downgrade regressino breaks tb-updater breaks building Whonix","status":"resolved","priority":"Unbreak Now!","author":"Patrick","description":"torproject.org SSL changes break #tb-updater breaks Whonix build process.\n\nhttps://trac.torproject.org/projects/tor/ticket/25426\n\nhttps://forums.whonix.org/t/failure-to-download-tor-browser-ssl-fail\n\nDowngrading from `curl` `--tlsv1.2` to `--tlsv1.0` seems weird.\n\nWhat do we do? Download from torproject onion by default? That however would make building Whonix without being behing Tor fail since it couldn't connect to onions by default.\n\nThese users we would recommend to build using `--tb none` for \"not install Tor Browser\". Hopefully `--tb none` is even working. Not easy to propagate variable all the way down to tb-updater.\n","comments":[{"author":"iry","date_created":1521664870,"date_modified":1521664870,"content":"The ticket can be closed now since TPO has fixed the problem. (I do not have the permission to close it.)\n\nRelated ticket:\nhttps://trac.torproject.org/projects/tor/ticket/25354\n\nSSL status of www.torproject.org:\nhttps://www.ssllabs.com/ssltest/analyze.html?d=www.torproject.org"},{"author":"Patrick","date_created":1521816074,"date_modified":1521816074,"content":"Thanks! :)"}]},"PHID-TASK-kebxu2uatimwadntly33":{"id":"776","title":"Have 'Obey DRM limitations' in Okular unticked by default","status":"resolved","priority":"Needs Triage","author":"ThirdTimeLucky","description":"[[ https://forums.whonix.org/t/two-pdf-privacy-anonymity-risks-and-possible-whonix-suggestions/4736 | As discussed in the forums ]], in Okular, the current default PDF reader in Whonix, there is a privacy and anonymity risk in PDF files which contain 'DRM' which may [[ https://www.locklizard.com/track-pdf-monitoring/ | track the user ]] in Whonix through such code. \n\nCan we have ‘Obey DRM limitations’ unticked by default in Whonix to help mitigate this risk?","comments":[{"author":"HulaHoop","date_created":1526085895,"date_modified":1526085939,"content":"Interesting [[ https://lwn.net/Articles/335415/ | backstory ]] about this anti-feature in Debian. Nonetheless I've found a solution.\n\n\nThis is done by changing the following file:\n\n/home/user/.kde/share/config/okularpartrc\n\n to:\n\n[$Version]\nupdate_info=okular.upd:sep_settings\n\n[Core General]\nObeyDRM=false\n"},{"author":"Patrick","date_created":1526133990,"date_modified":1526133990,"content":"HulaHoop (HulaHoop):\n> /home/user/.kde/share/config/okularpartrc\n\nOught to avoid writing into the home folder.\n\nAdding that file into this folder might do the trick.\n\nhttps://github.com/Whonix/anon-apps-config/tree/master/usr/share/anon-apps-config\n\nPlease send a pull request.\n\nThen we might still get this into #Whonix_14. (Or #Whonix_15.)"},{"author":"HulaHoop","date_created":1526471879,"date_modified":1526471879,"content":"Done:\n\nhttps://github.com/Whonix/anon-apps-config/pull/2/commits/d3659fe3de243a799a76bee147f393e06426adbe"}]},"PHID-TASK-aon2kqrewbaouljok7qq":{"id":"775","title":"I2P Integration","status":"open","priority":"Wishlist","author":"HulaHoop","description":"I2P comes to Debian sid. Expected to land in stable-next. This should remove the need for adding 3rd party repos.\n\nhttps://geti2p.net/en/blog/post/2018/02/11/high-level-roadmap \n\n\nThere are standard ways to deal with Debian starting daemons by default:\n\nhttps://major.io/2016/05/05/preventing-ubuntu-16-04-starting-daemons-package-installed/\n\nSyndie the distributed privacy forum software is seeing a re-write. Would be worthy to include if its packaged in Debian also\nhttps://twitter.com/GetI2P/status/967164243127697408\n\nT770 is a blocker for this ticket","comments":[]},"PHID-TASK-bpqnhr2dsaavhwva3z2s":{"id":"774","title":"[Revised] Clock Drift Correction Proposal","status":"open","priority":"Normal","author":"HulaHoop","description":"Here is what we know:\n*You don't need QEMU guest-agent to suspend or resume guests. This is possible with virsh.\n*This works because of ACPI S3 events. This means I will have to reinstate ACPI once more but that seems a small tradeoff for completing this task. What do you think? \n*QEMU guest-agent is safe to use if we decide to go that route. There are some interesting things we can do with the agent if we ever need it in the future. This proposal assumes we are NOT using it.\n\n\n\nHost package has two parts, one for manipulating GWs and the other for WSs. It must enumerate all VMs and then acts in 1 of 2 ways according to whether they are designated as GW or WS. This is crucial for scaling to Multi Whonix setups. This can be designed to happen during during boot of a new session instead of before suspend. Process: Enumerate all Whonix VMs recognized by livbirt by regexing to determine if they have \"Whonix-Gateway\" or \"Whonix-Workstation\" in their names.\n\nvirsh is the tool of choice. That should work for Qubes too because they use libvirt. Theoretically this works for VBox on Linux if using libvirt but on non supported platforms like vanilla VBox or Vbox Windows this design won't break usability since the guest doesn't experience suspend/resume ACPI events.\n\n\n-System suspend:\n\n*Upon host system suspend it just sends a suspend-to-ram signal for all VMs via guest ACPI. \n\n***\n\n-System resume:\n\n*GW resumed first (to prevent race-conditions), monit checks logs, triggers iptables lockdown for enough time until WS iptables takes over, WSs timesync traffic exempt. timesync is started for the GW.\n\n*WSs resumed later 5-10s later, start iptables lockdown, WS timesync initiated.\n\n***\n\nThis ticket is a summary of the best way to implement T550 and supersedes it. Any technical references can be found in that thread.","comments":[{"author":"Patrick","date_created":1519930702,"date_modified":1519930702,"content":"HulaHoop (HulaHoop):\n> -System suspend: *Upon host system suspend it just sends a\n> suspend-to-ram signal for all VMs via guest ACPI.\n> --------------------------------------------------------------------------------\n> -System resume: *GW resumed first (to prevent race-conditions), monit\n> checks logs, triggers iptables lockdown for enough time until WS\n> iptables takes over, WSs timesync traffic exempt. timesync is started\n> for the GW. *WSs resumed later 5-10s later, start iptables lockdown, WS\n> timesync initiated.\n\nThis still leaves room for race conditions. The proper way to implement\nthis is to lock Whonix-Gateway network on pre-suspend."}]},"PHID-TASK-k7hyvbnpvrfailio6ith":{"id":"773","title":"Shipping Mumble VoIP","status":"open","priority":"Normal","author":"HulaHoop","description":"Thread proposes outline of bringing a Tor friendly VoIP solution to Whonix. All other zRTP solutions are UDP based without exception. Tox can use TCP but performance is not as optimal as Mumble which can work in extremely high latency environments. Coop on a common framework with Tail server could open the door for easy integration of other collaborative tools in the future.\n\nSince Mumble doesn't understand Tor DNS, this ticket depends on T772.\n\nhttps://forums.whonix.org/t/shipping-a-working-mumble-voip/4848/2\n\n\n","comments":[]},"PHID-TASK-ycdezhyl5wpjqa3mj6lq":{"id":"772","title":"Managing programs without Tor Socks / DNS Support","status":"open","priority":"Normal","author":"HulaHoop","description":"Hoevenstein's AORTA tool can be used to force applications that don't honor Tor DNS which breaks stream isolation.\n\nhttps://forums.whonix.org/t/managing-programs-without-tor-dns-support/4840/10\n","comments":[{"author":"Patrick","date_created":1519837856,"date_modified":1519837856,"content":"Does aorta support stream isolation? Doesn't look like? It uses hardcoded `TransPort` / `DnsPort`.\n\naorta source code:\n```\n#define TOR_TCP_PORT              \"9040\"\n#define TOR_DNS_PORT              \"9041\"\n```\n\nWithout stream isolation it's as good as not using aorta.\n\nPlease request a feature to do configure this by command line or environment variable.\n\nDoes it modify Whonix-Workstation firewall rules or is this contained through cgroup usage? Please test as per https://www.whonix.org/wiki/Dev/Firewall_Refactoring#How_to_refactor_the_firewall_script_while_being_sure_there_are_no_iptables_changes.\n\nAnother issue: compiled code and not available in packages.debian.org. We could use a similar solution to bindp.\n\nDoes it even work with electrum?\n\nIs it better (less likely to leak) than `torsocks electrum` (if torsocks would work, we'd already have an uwt wrapper?)?\n\nhttps://hoevenstein.nl/aorta-a-transparent-tor-proxy-for-linux-programs\n> What can go wrong?\n> \n> AORTA can only do its magic if the program it starts is under its control. In technical terms: the program must be a child process of the aorta program.\n> \n> Some programs escape aorta's control if the program is already running. These programs detect at start if there is a running instance of the program. If so, they do not start a new program but instead clone the running program. This clone is a child of th\n\nCan you ask the author please if he considered running under different linux user account name (temporarily and dynamically created) or linux network namespaces? Perhaps that would be more leak proof?\n\nRewrite in scripting language since C is not really required?"},{"author":"Patrick","date_created":1529736110,"date_modified":1529736110,"content":"Could you please ask upstream about above? @HulaHoop "}]},"PHID-TASK-rlfff2rqrztd2zcadujt":{"id":"771","title":"install magic-wormhole by default / Implementing an Onionshare alternative","status":"resolved","priority":"Normal","author":"HulaHoop","description":"Onionshare not in stable. Pinning not possible to support upgrades thru apt. magic-wormhole is a great alternative to easily share data between two endpoints. It will require a uwt wrapper to support stream isolation.\n\nhttps://forums.whonix.org/t/onionshare-alternatives/4877/11\n\nhttps://forums.whonix.org/t/magic-wormhole-easyly-get-things-from-one-computer-to-another-safely-review/4026","comments":[{"author":"Patrick","date_created":1547274333,"date_modified":1547274333,"content":"* https://github.com/Whonix/uwt/commit/e29bf650d777deabf2cb9ef900ac0e3d535b95dd\n* https://github.com/Whonix/anon-meta-packages/commit/412acec56ade3ae05214d08f08df6dbdb1ceb057"},{"author":"Patrick","date_created":1555248945,"date_modified":1555248945,"content":"wormwhole works amazing!"}]},"PHID-TASK-a5i725l2n2m223k4kwc3":{"id":"770","title":"Custom TBB profile for localhost access + Privoxy","status":"open","priority":"Normal","author":"HulaHoop","description":"This ticket keeps track of the proposed way to access localhost daemons with TBB and redirecting darkweb TLDs (.i2p) with privoxy. This is a more superior approach than running foxyproxy which cannot be installed by default, needs updates to its rule lists to support new things, opens unsafe ads for their aid service and breaks for no reason all the time.\n\nhttps://forums.whonix.org/t/tbb-profile-with-custom-about-config-settings/4888/4","comments":[{"author":"madaidan","date_created":1557508552,"date_modified":1557508552,"content":"You can create directories in tor-browser_en-US/Browser/TorBrowser/Data/Browser/ called (profile_name).default. Here will be all the configurations for the profile. It should have a custom user.js with proxy settings using privoxy and setting network.proxy.no_proxies_on to 0.\n\nIn tor-browser_en-US/Browser/TorBrowser/Data/Browser/profiles.ini you would add the new profile so Tor Browser can use it.\n\nFor example, if the profile is called \"privoxy\" then you would add:\n\n```\n[Profile1]\nName=privoxy\nIsRelative=1\nPath=privoxy.default\nDefault=0\n```\n\nThis profile can then be started with `tor-browser_en-US/Browser/firefox.real --profile=(path)`. You can add this command in start menus, desktop icons etc."}]},"PHID-TASK-kgh5hszcxspz6gowzkr5":{"id":"769","title":"Add LUKS container GUI or CLI utility by default","status":"resolved","priority":"Low","author":"HulaHoop","description":"Summary: zulcrypt is a GUI to make managing/creating LUKS containers easy. The version in Stretch has some problems that prevent it from working correctly. We can always add it later when these problems are fixed.\n\nTesting thread: https://forums.whonix.org/t/zulucrypt-in-whonix-14/4876\n\n* https://packages.debian.org/buster/zulucrypt-gui\n* https://packages.debian.org/buster/zulumount-gui\n\n***\n\nTomb is the pioneer of portable LUKS containers on Linux. See if they are a better experience when Buster rolls around.\n\n* https://packages.debian.org/buster/tomb\n\n----\n\n* https://github.com/Whonix/anon-meta-packages/blob/master/debian/control\n* belongs to `non-qubes-vm-enhancements-gui`","comments":[{"author":"HulaHoop","date_created":1536889572,"date_modified":1536889572,"content":"Test out the (LUKS wrapper) Tomb implementation in KDE Vault.  Should be around by Buster.\n\nhttps://www.omgubuntu.co.uk/2017/06/plasma-vault-create-encrypted-folder-linux \n"},{"author":"HulaHoop","date_created":1549075792,"date_modified":1549075792,"content":"Moved to xfce so past comment is irrelevant. Will test Zulu after moving to Buster and add if it works."},{"author":"HulaHoop","date_created":1553294372,"date_modified":1553294372,"content":"Test the tomb LUKS container script as an alternative.\n\nhttps://packages.debian.org/buster/tomb\n\nThe package is now part of Buster"},{"author":"HulaHoop","date_created":1555474130,"date_modified":1555474151,"content":"zulucrypt works in Buster. Tomb does not.\n\nhttps://forums.whonix.org/t/15-0-0-0-9-review/7162\n\n\nSteps remaining:\n\n* Add zulucrypt to Whonix including its extensions?\n* Document zulucrypt best practices. Where do instructions go?\n\n@Patrick please give your input on the above questions."},{"author":"Patrick","date_created":1555506226,"date_modified":1555506226,"content":">>! In T769#18244, @HulaHoop wrote:\n> * Add zulucrypt to Whonix including its extensions?\n\nYes. See original ticket about where to add.\n\n> * Document zulucrypt best practices. Where do instructions go?\n\nNo idea. Please ask in https://forums.whonix.org/t/long-wiki-edits-thread mentioning this is non-qubes-whonix only."},{"author":"HulaHoop","date_created":1555605293,"date_modified":1555605293,"content":"https://github.com/Whonix/anon-meta-packages/pull/20/commits/0ab1a0aa4b5e22149286d6156a1816e3ca65626c"},{"author":"HulaHoop","date_created":1555605368,"date_modified":1555605454,"content":"I also added the cli version to the  non-qubes-vm-enhancements-cli section. It is a dep of a gui install but not vice versa. Zulucrypt plugin package was added there too since enchancements-cli is a subset of enhancements-gui."},{"author":"Patrick","date_created":1555659664,"date_modified":1555659664,"content":"Merged."},{"author":"Patrick","date_created":1561624973,"date_modified":1561624973,"content":"Does this work in https://forums.whonix.org/t/whonix-virtualbox-15-0-0-3-3-debian-buster-based-testers-wanted/7604? @HulaHoop"},{"author":"HulaHoop","date_created":1563757436,"date_modified":1563757436,"content":"Yes Zulucrypt included and functional on KVM 15. However fixes for both zulucrypt and tomb haven't made it into Buster from what I've tested. Zulucrypt has a tomb plugin to open Tomb files too."}]},"PHID-TASK-sbekuylui7hadd5hg64t":{"id":"768","title":"use symlinks rather than copy for onion-grater profiles","status":"resolved","priority":"Normal","author":"Patrick","description":"Using `cp` is bad - since as we learned through onionshare 1.2 - onion-grater profiles require upgrades.\n\nCan we use symlinks rather than copies? Does #onion-grater_control_port_filter_proxy follow symlinks?\n\n* https://www.whonix.org/wiki/Template:Control_Port_Filter_Python_Profile_Add\n* https://github.com/Whonix/onion-grater\n\nWould be cool to have this in #whonix_14 (if easy) or #whonix_15 (if hard) and to upstream the patch to Tails (original authors, shared code Whonix/Tails) if a patch is required.","comments":[{"author":"Patrick","date_created":1520517150,"date_modified":1520517150,"content":"https://www.whonix.org/w/index.php?title=Template%3AControl_Port_Filter_Python_Profile_Add&type=revision&diff=33314&oldid=33276"}]},"PHID-TASK-sq5a6sjxzomy674kyll7":{"id":"767","title":"Tor Browser segfaults in Qubes-Whonix","status":"resolved","priority":"Normal","author":"Patrick","description":"* https://forums.whonix.org/t/whonix-14-fresh-install-browser-seg-faults\n* https://github.com/QubesOS/qubes-issues/issues/3611\n\nUpstream bug report:\n`Tor Browser refuses to start / XDG_CONFIG_DIRS environment variable segfaults Tor Browser`\nhttps://trac.torproject.org/projects/tor/ticket/25305\n\nWe had a similar issue previously:\n\n* T651\n* https://trac.torproject.org/projects/tor/ticket/21804","comments":[{"author":"Patrick","date_created":1519142660,"date_modified":1519142660,"content":"https://github.com/Whonix/tb-starter/commit/cc61bafe8bbfe3df20de6bee0dbe3a097dee78a7"}]},"PHID-TASK-bjujflcjmrbsbxoxnhl2":{"id":"766","title":"use tinyproxy socks proxy support once available in Qubes-Whonix-Gateway","status":"open","priority":"Normal","author":"Patrick","description":"tinyproxy `socks` proxy support was merged upstream.\n\nhttps://github.com/tinyproxy/tinyproxy/pull/64#event-1460467771\n\nOnce it flows down to Debian, Qubes-Whonix should make use of it. Better than transparent proxying, better stream isolation.\n\nRelated:\n`add proxy capabiltiies (provides_network) to Whonix-Workstation / move Qubes updates proxy to Whonix-Workstation`\nT725\n\nhttps://github.com/QubesOS/qubes-issues/issues/8398","comments":[]},"PHID-TASK-yp7xkbzawu2g6wk6kswm":{"id":"765","title":"Merge restart-tor-gui in tor-control-panel","status":"open","priority":"Normal","author":"troubadour","description":"https://github.com/Whonix/tor-control-panel","comments":[{"author":"troubadour","date_created":1517334852,"date_modified":1517334852,"content":"This can be easily done. A package with the merging has been tested already.\n \nhttps://github.com/troubadoour/anon-connection-wizard\n\nNote: only for testing, anon-connection-wizard is not updated in this package. "}]},"PHID-TASK-lsejlxqa46suree4u3er":{"id":"764","title":"Fingerprinting: push tor 0.3.2.9 to stable repo at time of TB 7.5 release","status":"resolved","priority":"High","author":"rustybird","description":"This may be on your radar already, I'm just leaving it here to be safe:\n\nTor Browser 7.5, due for release on 2018-01-23, will include tor 0.3.2.9, and IMO it is important to ship this tor version (in the Whonix Gateway stable Debian repository) as close to the actual TB release as possible. Otherwise, it will be trivial to fingerprint Whonix users, because tor 0.3.1.x  does not support v3 onions, but 0.3.2.x does.","comments":[{"author":"Patrick","date_created":1516545568,"date_modified":1516545568,"content":"Uploaded tor_0.3.2.9-1~d80.jessie+1_amd64.deb to Whonix jessie-proposed-updates and testers repository."},{"author":"Patrick","date_created":1516586192,"date_modified":1516586192,"content":"(Adjusting tags as reminder.)"},{"author":"rustybird","date_created":1516748812,"date_modified":1516748812,"content":"TB 7.5 was released today, so you may want to transition this to the stable repository."},{"author":"Patrick","date_created":1516844429,"date_modified":1516844429,"content":"Done."}]},"PHID-TASK-gk7su4c222crkwuq4g4y":{"id":"763","title":"build Qubes-Whonix images","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1515004792,"date_modified":1515004792,"content":"https://github.com/QubesOS/qubes-issues/issues/3441"}]},"PHID-TASK-7dnjjmkxxg35vhumss4t":{"id":"762","title":"disable systemd-resolved","status":"resolved","priority":"Normal","author":"Patrick","description":"By using a `/lib/systemd/system/systemd-resolved.service.d/` drop-in.\n\nConsequence of abolishing #anon-gw-dns-conf.\n\nhttps://github.com/Whonix/anon-gw-dns-conf/blob/master/lib/systemd/system/systemd-resolved.service.d/40_anon-dns-conf.conf","comments":[{"author":"Patrick","date_created":1514905716,"date_modified":1514905716,"content":"https://github.com/Whonix/anon-apps-config/commit/96d6e1e741cdf8456ea1ca1b07ce014289aeb7bf\n\nhttps://github.com/Whonix/anon-ws-dns-conf/commit/427aac3a96dfd9e9b5a7e229574096c1879d98a0\n"}]},"PHID-TASK-ffycu63v2gojsu5htxwm":{"id":"761","title":"compare dpkg -l Whonix 13 -> Whonix 14","status":"resolved","priority":"Normal","author":"Patrick","description":"Compare new build and upgraded build.","comments":[{"author":"unman","date_created":1520560916,"date_modified":1520560916,"content":"Let me check - is this New 14 against upgraded 13, or new 13 against upgraded 13-14?"},{"author":"Patrick","date_created":1520594313,"date_modified":1520594313,"content":"Good question.\n\n* Upgraded and `apt-get autoremove`ed 13\n\ncompared with\n\n* newly built, upgraded and `apt-get autoremove`ed 14\n\nIf that makes sense."},{"author":"unman","date_created":1520601547,"date_modified":1520601547,"content":"That's what I thought - the entry in T778 is made on that basis."},{"author":"unman","date_created":1520988070,"date_modified":1520988070,"content":"I have run the upgrade a number of times now with the latest rc. update.\nThere seem to be significant differences between the upgraded 13 and a clean install of 14 - in addition to the architectural changes evident in the move to Stretch.(i386/amd64)\nI've attached a summary file of the differences - 14 is generally much cleaner.\nThe obvious extras included in an upgraded system would seem to be as summarised below. I see loittle differencd between upgraded GW and upgraded WS, in terms of additional programs, drivers and libraries.\nKDE stuff:\n|  accountsservice                                            |\n|  akonadi-backend-mysql                                      |\n|  akonadi-server                                             |\n|  anon-kde-streamiso                                         |\n|  anon-ws-kde-startmenu                                      |\n\n|  bluedevil                                                  |\n|  bluez                                                      |\n|  bluez-obexd                                                |\n|  exfat-fuse                                                 |\n|  exfat-utils                                                |\n|  firmware-linux-free                                        |\nFonts:\n|  fonts-droid-fallback                               |\n|  fonts-freefont-ttf                                         |\n|  fonts-hack-ttf                                             |\n|  fonts-lato                                                 |\n|  fonts-noto                                                 |\n|  fonts-noto-cjk                                             |\n|  fonts-noto-mono                                            |\n|  fonts-noto-unhinted                                        |\n\n|  mariadb-client-core-10.1                                   |\n|  mariadb-common                                             |\n|  mysql-common                                       |\n|  mysql-server-core-5.5                                      |\n\n|  mesa-utils                                                 |\n|  mesa-vdpau-drivers:i386                                    |\n\n\n|  nepomuk-core-data                                          |\n|  netcat-traditional                                         |\n|  nfacct                                                     |\n|  openssh-client                                             |\n|  oxygencursors                                              |\n\n|  powerdevil                                                 |\n|  powerdevil-data                                            |\n|  poweroff-passwordless                                      |\n|  publicsuffix                                       |\nSome Python and Ruby:\n|  perl-modules                                       |\n|  python-reportlab                                           |\n|  python-reportlab-accel:i386                                |\n|  python-support                                             |\n|  python3.4                                                  |\n|  python3.4-minimal                                          |\n|  ruby                                               |\n|  ruby-dev:i386                                              |\n|  ruby-did-you-mean                                          |\n|  ruby-minitest                                              |\n|  ruby-net-telnet                                            |\n|  ruby-power-assert                                          |\n|  ruby-test-unit                                             |\n|  ruby2.1                                                    |\n|  ruby2.3                                                    |\n|  ruby2.3-dev:i386                                           |\n|  rubygems-integration                               |\nVLC etc:\n|  alsa-base                                                  |\n|  ffmpeg                                                     |                                          |\n|  mpv                                                        |\n|  vlc-plugin-video-splitter:i386                             |\n|  vlc-plugin-visualization:i386                              |\n|  wamerican              \n                                    |\nSome Whonix stuff:\n|  whonix-setup-wizard                                        |\n|  whonix-ws-firewall                                         |\n|  whonix-ws-kde-desktop-conf                                 |\n|  whonixsetup                                                |\n{F5750023}\n\nObviously these carry a large number of attendant libs."},{"author":"Patrick","date_created":1521032930,"date_modified":1521032930,"content":"Looks like nothing unexpected / nothing need fixing."}]},"PHID-TASK-bk5fxdeigmtxmh2cxyp5":{"id":"760","title":"compare ps aux Whonix 13 -> Whonix 14","status":"resolved","priority":"Normal","author":"Patrick","description":"Compare new build and upgraded build.","comments":[{"author":"unman","date_created":1520988744,"date_modified":1520988744,"content":"I have performed a number of upgrades of GW and WS using the latest rc.\nI have taken snapshots of running processes, and I would say that (almost) all of the main differences seem to be related to KDE changes between the versions.\n{F5750353}\n"},{"author":"Patrick","date_created":1521033013,"date_modified":1521033013,"content":"Looks like nothing unexpected / nothing need fixing."}]},"PHID-TASK-dzbxftkmdck4hhz3qe2y":{"id":"738","title":"Change default application to not use kmail  ","status":"wontfix","priority":"Low","author":"TNTBOMBOM","description":"i know kmail its not installed , though its better to not put any interruption request for it , check the screenshot\n\n{F2400104}","comments":[{"author":"Patrick","date_created":1542729655,"date_modified":1542729655,"content":"https://forums.whonix.org/t/user-poll-xfce-vs-kde-kde-deprecation-considered/6235"}]},"PHID-TASK-rqqtbgvrrx4papmm47ya":{"id":"737","title":"Desktop Session Login better to start it with empty session / kdesudo error popup window ( sdwdate-gui )","status":"resolved","priority":"Normal","author":"TNTBOMBOM","description":"its better to start with fresh/empty session each time the user login. rather than saving the previous one\n\n{F2400062}\n\nThis is causing a bug `kdesudo error popup window ( sdwdate-gui )`:\n\nhttps://forums.whonix.org/t/kdesudo-error-popup-window-sdwdate-gui/5642","comments":[{"author":"TNTBOMBOM","date_created":1536194094,"date_modified":1536194094,"content":"linking to forum: \n\nhttps://forums.whonix.org/t/kdesudo-error-popup-window-sdwdate-gui/5642"},{"author":"Patrick","date_created":1536217510,"date_modified":1536217526,"content":""},{"author":"Patrick","date_created":1536217660,"date_modified":1536217660,"content":"This should be fixed by default in the next build.\n\nhttps://github.com/Whonix/anon-apps-config/commit/008d206ec20c74e0d03926b939522b7036b8693b"}]},"PHID-TASK-imdahpahgeuo5zmcz5kn":{"id":"736","title":"Disable VLC metadata collection by default","status":"resolved","priority":"Normal","author":"TNTBOMBOM","description":"This is for user safety , to avoid pressing on continue and he wasn't aware of what it does say.\n\n{F2399084}\n\nTODO:\n\n* /etc/vlc.d configuration snippet drop-in feature request\n* Meanwhile should be implemented minimal VLC config preconfiguring this in #anon-apps-config `/etc/skel`.","comments":[{"author":"Tibo","date_created":1523119123,"date_modified":1523119273,"content":"Withc VLC a config file is created per user and there is no global configuration.\nThe path is $HOME/.config/vlc/vlcrc.\n\nAs far as I understand, the content of /etc/skel/ is magically being copied in the user directory.\nSo I modified the architecture as follow :\n\n```\netc\n|-- skel\n|   `-- .config\n|       `-- vlc\n|           `-- vlcrc\n```\n\nI tested it, and it works, what do you think ?\nShould I fork the anon-apps-config repo on github, and make a pull request ?{F6896915}"},{"author":"Patrick","date_created":1523246442,"date_modified":1523246442,"content":"Looks good!\n\n> Should I fork the anon-apps-config repo on github,\n\nYes.\n\n> and make a pull request ?\n\n* Pull request is one accepted way.\n* Another accepted way is just posting to any branch and posting the branch name here.\n* Currently it's even accepted to to commit to you fork's master branch and then I'll merge that as well. (However, in case we'd ever reach a dead-end you'd have to reset your master branch.)\n* Other suggestions?\n\nPlease pick the most comfortable one."},{"author":"Tibo","date_created":1523251269,"date_modified":1523251269,"content":"I'm fine a with a pull request !\nDo you have other tasks for me ?\n\nI have just a simple question, how do you know if somebody is not already working on a task ?\n"},{"author":"Patrick","date_created":1523272601,"date_modified":1523272601,"content":">>! In T736#15889, @Tibo wrote:\n> I have just a simple question, how do you know if somebody is not already working on a task ?\n\nIf it is assigned to someone on phabricator like now. (Or by the context of the discussion but we should assign tasks.)"},{"author":"Patrick","date_created":1523272757,"date_modified":1523272757,"content":">>! In T736#15889, @Tibo wrote:\n> Do you have other tasks for me ?\n\nEasy, testing only:\nT444\n\nEasy, testing only:\nT652\n\nQubes specific, testing should be easy but if it's broken maybe not easy to fix:\nT781\n"},{"author":"Patrick","date_created":1523277054,"date_modified":1523277054,"content":"T772 has stalled as well."},{"author":"Patrick","date_created":1523290927,"date_modified":1523290927,"content":"https://github.com/Whonix/anon-apps-config/pull/1"},{"author":"Patrick","date_created":1523291115,"date_modified":1523291139,"content":"> qt-privacy-ask=0 \n\nBy name only means \"do not ask\".\n\nStop VLC.\nDelete VLC config.\nStart with your config.\n\nDoes the metadata collection show up as disabled in VLC settings?\n\nIf yes, this is ready to merge. Even easy enough for #Whonix_14."},{"author":"Patrick","date_created":1523291235,"date_modified":1523291235,"content":"Answering the meta questions here for me was not so clever this it created these references. Not a big deal either. However, better to have a development forum thread.\n\n> Mentioned Here\n>     T772: Managing programs without Tor DNS Support\n>     T444: Ricochet IM\n>     T652: anon-gpg-tweaks Debian stretch changes required\n>     T781: tb-updater do not populate home directory at first boot? \n"},{"author":"Tibo","date_created":1523295997,"date_modified":1523295997,"content":"Hi !\n\nThe name is confusing I agree.\nBut it actually does disallow metadata network access.\n\n\n| qt-privacy-ask=0 | qt-privacy-ask=1 |\n| No pop-up asking for allowing metadata |The pop-up is showing and asking for metadata collection |\n| Correctly disable in VLC settings | Either have to check it or not (If you close the popup it also disallow metadata collection) |\n|{F7027941}|{F7027955}|\n\n\n"},{"author":"Patrick","date_created":1523443601,"date_modified":1523443601,"content":"Merged."}]},"PHID-TASK-cm2bzz2kbm35bbayjlru":{"id":"735","title":"settings-plasma search/configure search configurations from Whonix-Gateway","status":"wontfix","priority":"Low","author":"TNTBOMBOM","description":"it shouldnt search through bookmarks,document,web shortcuts since these are not inside Whonix-Gateway (audio and power r not used there)\n\n{F2398999}\n\n{F2399004}\n\ncheck out the screenshots","comments":[{"author":"Patrick","date_created":1542729521,"date_modified":1542729521,"content":"https://forums.whonix.org/t/user-poll-xfce-vs-kde-kde-deprecation-considered/6235"}]},"PHID-TASK-lezouodp5gli2oruvlxj":{"id":"734","title":"disable web shortcuts ","status":"wontfix","priority":"Normal","author":"TNTBOMBOM","description":"as it will request to open browsing action (true whonix previnting that but still disabling it by default much better)\n\n{F2398959}","comments":[{"author":"Patrick","date_created":1542729530,"date_modified":1542729530,"content":"https://forums.whonix.org/t/user-poll-xfce-vs-kde-kde-deprecation-considered/6235"}]},"PHID-TASK-lli6mm7d7uvuj4ijlrhr":{"id":"733","title":"disable/remove KDE System Settings - Network - Settings","status":"wontfix","priority":"Low","author":"TNTBOMBOM","description":"Applies to konquerer which we don't use in Whonix.\n\nNot needed on Whonix-Gateway in any case.\n\n{F2398776}\n\neither removing it or disabling every option there\n","comments":[{"author":"Patrick","date_created":1542729540,"date_modified":1542729540,"content":"https://forums.whonix.org/t/user-poll-xfce-vs-kde-kde-deprecation-considered/6235"}]},"PHID-TASK-avgqx2yyqxy6sw26sjf7":{"id":"732","title":"whonix-gw-14 template fails to boot on Qubes 3.2","status":"invalid","priority":"Normal","author":"entr0py","description":"fails with `cannot execute qrexec-daemon`\n\nxen console log:\n```\n[    1.137089] blkfront: xvda: flush diskcache: enabled; persistent grants: enabled; indirect descriptors: enabled;\n[    1.138230] random: fast init done\n[    1.157058]  xvda: xvda1 xvda2 xvda3\n[    1.183743] blkfront: xvdb: flush diskcache: enabled; persistent grants: enabled; indirect descriptors: enabled;\n[    1.197403] blkfront: xvdc: flush diskcache: enabled; persistent grants: enabled; indirect descriptors: enabled;\n[    1.204163]  xvdc: xvdc1\n[    1.238083] blkfront: xvdd: barrier or flush: disabled; persistent grants: enabled; indirect descriptors: enabled;\nWaiting for /dev/xvda* devices...\nQubes: Doing R/W setup for TemplateVM...\n[    1.253947]  xvdc: xvdc1\n[    1.254705]  xvdc: xvdc1\nSetting up swapspace version 1, size = 1073737728 bytes\nUUID=xxxx\nQubes: done.\nmodprobe: module ext4 not found in modules.dep\nmount: mounting /dev/mapper/dmroot on /sysroot failed: Invalid argument\nWaiting for /dev/xvdd device...\n[    1.284169] EXT4-fs (xvdd): mounting ext3 file system using the ext4 subsystem\n[    1.285457] EXT4-fs (xvdd): mounted filesystem with ordered data mode. Opts: (null)\nmount: can't find /sysroot in /proc/mounts\nmount: can't find /sysroot in /proc/mounts\n```\n\n`qvm-run -a -u root whonix-gw-14 xterm`\n    Cannot execute qrexec-daemon!\n`sudo xl console whonix-gw-14`\n    whonix-gw-14 is an invalid domain identifier (rc=-6)\n","comments":[{"author":"entr0py","date_created":1513205306,"date_modified":1513205306,"content":"Perhaps related to https://github.com/QubesOS/qubes-issues/issues/3187?\n\nNot sure which commits fixed that issue, and whether or not they are compatible with 3.2."},{"author":"Patrick","date_created":1513251825,"date_modified":1513251825,"content":"Any idea about this one? @marmarek \n\n>>! In T732#14884, @entr0py wrote:\n> Perhaps related to https://github.com/QubesOS/qubes-issues/issues/3187?\n> \n> Not sure which commits fixed that issue, and whether or not they are compatible with 3.2.\n\nThat issue was Qubes R4 only as far as I know and was fixed in xen-hvm-stubdom-linux 1.0.5 according to @HW42.\n\nCan you get a Debian stretch template please? Does that work reliably for you?"},{"author":"entr0py","date_created":1513280411,"date_modified":1513280411,"content":"Oops, should have tested plain Debian first. Doesn't work either.\n\nClosing and tracking here: https://github.com/QubesOS/qubes-issues/issues/3399"},{"author":"entr0py","date_created":1513283159,"date_modified":1513283159,"content":"[Qubes R4 templates can not be started on Qubes 3.2](https://github.com/QubesOS/qubes-issues/issues/3399#issuecomment-351821742)"}]},"PHID-TASK-w7vv3x3zn3zzvsrnec5p":{"id":"731","title":"document sdwdate code flow","status":"open","priority":"Normal","author":"Patrick","description":"","comments":[]},"PHID-TASK-leo64fe2nxvtdw6iwqrb":{"id":"730","title":"spam","status":"resolved","priority":"Wishlist","author":"cyylyy1","description":"spam","comments":[]},"PHID-TASK-t3oqqbabmzxzrf52t3vu":{"id":"729","title":"network hardening","status":"open","priority":"Normal","author":"Patrick","description":"https://github.com/adrelanos/vpn-firewall/pull/43\n\nMaybe not only useful for VPN-Firewall.","comments":[{"author":"madaidan","date_created":1557508733,"date_modified":1557508733,"content":"My [[ https://github.com/Whonix/security-misc/pull/6 | pull request ]] enables all of these except martian packet logging which I doubt would be useful on Whonix."},{"author":"Patrick","date_created":1557658563,"date_modified":1557658563,"content":"Could you please review this? @HulaHoop "}]},"PHID-TASK-yu5oh25asrqnlrod6z5a":{"id":"728","title":"Tor 0.3+ does not work on QubesOS (but Tor 0.2.9.10 works)","status":"invalid","priority":"Needs Triage","author":"ons2ibypk5","description":"Had been using Whonix GW Testing on Qubes OS 4.0 RC2 without any issue.\nFollowing Whonix GW Testing update, sys-whonix would no longer connect or bootstrap.\nTested on another PC with same result.\n\nReinstalled Qubes OS and the default sys-whonix proxy based on the whonix-gw Stable template worked fine. \nI upgraded this template, rebooted it and the sys-whonix proxy, and they continue to work fine. Tor version is Tor 0.2.9.10 (unrecommended).\n\nCloned whonix-gw  Stable template and set it to Stable Proposed Updates repo and upgraded, rebooted, etc.\nCloned whonix-gw Stable template and set it to Testing repo and upgraded, rebooted, etc.\n\nCreated a  sys-whonix proxy based on Stable Proposed Updates template.\nCreated a Testers sys-whonix proxy based on Stable Proposed Updates template.\n\nThe  sys-whonix proxies based on the Stable Proposed Updates template and the Testers templates will not bootstrap or connect to tor network.\n\nThe two sys-whonix proxies that will not bootstrap or connect are both using the newer Tor 0.3+.\n\nAny ideas?\n","comments":[{"author":"Patrick","date_created":1510497926,"date_modified":1510497926,"content":"Cannot reproduce. See https://forums.whonix.org/t/long-wiki-edits-thread/3477/349. For support requests, the forum is better suited."}]},"PHID-TASK-reh3qoq6kwlunl2dzimm":{"id":"727","title":"solve the Xen entropy scarcity problem / implement something like virtio-rng into Xen upstream","status":"open","priority":"Normal","author":"Patrick","description":"- solve the low entropy issue in Xen VMs\n- look into kvm virtio-rng\n- implement something similar into Xen\n- submit the patch to the original Xenproject.org developers so it passes their quality check and they merge it upstream\n\n(No - haveged is not a solution. It starts much too late. We need a real /dev/random inside all VMs. So something like virtio-rng.)\n\n(Related or even duplicate: T31 - but this ticket has a much clearer description.)\n\nQubes upstream ticket `Improve entropy collection in VMs`:\nhttps://github.com/QubesOS/qubes-issues/issues/673\n","comments":[{"author":"HulaHoop","date_created":1526649630,"date_modified":1526649630,"content":"You can probably use virtio-rng since Qubes now runs on HVM mode and uses QEMU"},{"author":"Patrick","date_created":1526956361,"date_modified":1526956361,"content":"Asked. Unfortunately not so.\n\nhttps://github.com/QubesOS/qubes-issues/issues/673#issuecomment-390391346"},{"author":"HulaHoop","date_created":1527652327,"date_modified":1527652327,"content":"\n\nPerhaps Qubes guys can have the entropybroker package communicate over the qrexec protocol to seed entropy from a reliable source like Dom0 to the other domains.\n\nhttps://packages.debian.org/sid/utils/entropybroker"},{"author":"Patrick","date_created":1527668936,"date_modified":1527668936,"content":"That's technically too late during boot process. See ticket discussion\nabove."},{"author":"HulaHoop","date_created":1533003817,"date_modified":1533003817,"content":"\njitterentropy-rng should solve this and is a mainline Linux solution that works the same way haveged does. Please see: https://phabricator.whonix.org/T817"},{"author":"Patrick","date_created":1533011919,"date_modified":1533011919,"content":"> jitterentropy-rng should solve this\n\nI am not sure about that. Addressed here:\nhttps://github.com/QubesOS/qubes-issues/issues/673#issuecomment-409091212\n\nT817 seems like a good idea anyhow."},{"author":"HulaHoop","date_created":1533180788,"date_modified":1533180788,"content":"I think its worth asking the hypervisor devs if this applies for the platforms we care about. "},{"author":"HulaHoop","date_created":1533267256,"date_modified":1533267256,"content":"Done. Asked about Xen too but they may not be familiar with its innards. You may want to contact the Xen devs directly using my message as a template.\n\nhttps://lists.nongnu.org/archive/html/qemu-devel/2018-08/msg00368.html\n\n\n"},{"author":"HulaHoop","date_created":1533268396,"date_modified":1533268396,"content":"An interesting implementation to work around early boot entropy scarcity with havegedis to include it in the initrd. May be hackish but could be easier for Marmarek than writing something at the EFI level.\n\n\nhttps://plus.google.com/+LennartPoetteringTheOneAndOnly/posts/K22yyHRc6hn\n\n\n\n> +Dustin Kirkland Sorry for not being entirely clear. I don't meant to have haveged running as daemon all the time. But just use haveged --run 1024, which will give you 1MB of random data gathered by the haveg algorithm in a file called sample. THIS file you then use as a last resort to seed the random pool. Wouldn't that be a much nicer option :)? Haveged would even be small enough to embed into the initrd with only 115kB and no library dependencies beside libc (eg. to guarantee that \"normal\" user space is never executed with a bad seeded random pool).\n\n"},{"author":"HulaHoop","date_created":1533269432,"date_modified":1533269494,"content":"\nPlaying devil's advocate here: Ted Ts'o [0] expresses strong skepticism about the efficacy of RNGs that rely on CPU jitter. summary: CPU jitter may not be random as thought to someone who designed the CPU cache and know how its internals \"tick\" [1]. So while these RNGs may not harm, another solution for RNG-less platforms may be a good idea.\n\n[0] He's the main developer behind Linux's RNG and staunchly resisted relying only on Intel's RDRAND. His opinions carry weight with good reason.\n\n[1] https://lwn.net/Articles/586427/\n\n\n \n\n> It may be that there is some very complex state which is hidden inside the the CPU execution pipeline, the L1 cache, etc., etc. But just because *you* can't figure it out, and just because *I* can't figure it out doesn't mean that it is ipso facto something which a really bright NSA analyst working in Fort Meade can't figure out. (Or heck, a really clever Intel engineer who has full visibility into the internal design of an Intel CPU....) \n\n"},{"author":"Patrick","date_created":1533288087,"date_modified":1533288087,"content":">>! In T727#16540, @HulaHoop wrote:\n> Done. Asked about Xen too but they may not be familiar with its innards. You may want to contact the Xen devs directly using my message as a template.\n> \n> https://lists.nongnu.org/archive/html/qemu-devel/2018-08/msg00368.html\n\n`ask Xen developers about Efficacy of jitterentropy RNG in Xen`:\nhttps://github.com/QubesOS/qubes-issues/issues/4174"}]},"PHID-TASK-btrujgeytjcnwjonwgru":{"id":"726","title":"if tb-updater storage path for Qubes R4 DispVMs","status":"resolved","priority":"Normal","author":"Patrick","description":"as per https://forums.whonix.org/t/qubes-dispvm-technical-discussion/3232/58 as reported by @entr0py ","comments":[{"author":"Patrick","date_created":1512383735,"date_modified":1512383735,"content":"How do I detect being run inside a DispVM Template? @marmarek \n\n(How do I detect being run inside a whonix-ws-dvm Template?)\n\nReason:\n\n* I would want to avoid `tb-updater-first-boot` to copy Tor Browser from root image's `/var/cache/tb-binary` to `/home/user` so the DispVM's `tb-updater-first-boot` will do that, rather than DispVM Template's `tb-updater-first-boot`.\n* Therefore upgrading whonix-ws (package `tb-updater`) will result in fresh Tor Browser versions in `whonix-wd-dvm` based DispVMs (named `Disp[...]`).\n\n([systemd unit file](https://github.com/Whonix/tb-updater/blob/master/lib/systemd/system/tb-updater-first-boot.service) / [script](https://github.com/Whonix/tb-updater/blob/master/usr/lib/tb-updater/first-boot-home-population))\n\nRelated:\nhttps://www.whonix.org/wiki/Tor_Browser/Advanced_Users#tb-updater_in_Qubes_TemplateVM\n\n\nBtw Whonix 14 getting close. (Postponed a few difficult tickets.) This ticket (T698) and T698 are the last two remaining ones as it looks now before a testers-only release can be made."},{"author":"Patrick","date_created":1513362103,"date_modified":1513362103,"content":"In `whonix-ws-dvm` the status file `/var/cache/tb-updater/first-boot-home-population.done` is not persistent either.\n\nhttps://github.com/Whonix/tb-updater/commit/49a23475915e809b9a58403181fb0218d349952d\n"}]},"PHID-TASK-k7dk44vkxthfqfmo6v7e":{"id":"725","title":"add proxy capabiltiies (provides_network) to Whonix-Workstation / move Qubes updates proxy to Whonix-Workstation","status":"open","priority":"Normal","author":"Patrick","description":"Could we reasonably make a Whonix-Workstation be a ProxyVM (`provides_network`)?\n\nRunning tinyproxy / Qubes updates proxy in a `whonix-ws` based disposable UpdateVM would have some advantages:\n\n* Whonix-Gateway firewall rules simplification\n* [ currently ] Qubes torified updates proxy runs in Whonix-Gateway, a VM that has a \"wire\" to:\n    * access Tor: yes\n    * access clearnet: yes\n          *  --> not great\n* [ proposed ] Qubes torified updates proxy runs in Whonix-Workstation, a VM that has a \"wire\" to:\n    * access Tor: yes\n    * access clearnet: no\n          *  --> better\n* Moving the attack surface of tinyproxy from #Qubes `sys-whonix` to a `whonix-ws` based AppVM running behind `sys-whonix`.\n * a compromised tinyproxy is less likely of compromising Whonix-Gateway and sending clearnet traffic\n\nOther advantages:\n\n* Prerequisite for Qubes `whonix-ws` based disposable UpdateVM.\n* (low priority) Allows sanely running an DHCP server on a Whonix-Workstation.\n** (low priority) Opens up for torification of Android emulator. ([ref](https://www.whonix.org/wiki/Other_Operating_Systems#Whonix-Android-Workstation))\n** (low priority) Whonix-Workstation could be assigned a WiFi device and being developed to provide a torified WiFi hotspot (useful for circumvention only, not so much for anonymity)\n\nRelated:\n\n* DHCP support T239","comments":[{"author":"marmarek","date_created":1509716762,"date_modified":1509716762,"content":"VM do not need to be a ProxyVM or have `provides_network=True` to serve as updatevm on Qubes 4.0. You just need to start updates proxy there (tinyproxy, enabled with `qvm-service --enable vmname qubes-updates-proxy`), and just qrexec policy of `qubes.UpdatesProxy` to direct the traffic there.\n\nIf you want it to be a DispVM, it should be easy:\n```\nqvm-create --class DispVM -t whonix-ws -l yellow whonix-updateproxy\nqvm-prefs whonix-updateproxy netvm sys-whonix\nqvm-prefs whonix-updateproxy default_dispvm ''\n```\nSuch VM can be started normally, the main difference is that its state (private volume) gets discarded at restart.\n\nSo, being updates proxy is mostly unrelated to providing DHCP service and such."}]},"PHID-TASK-w4r4mgzv2dglzlmy72mg":{"id":"724","title":"whonixcheck fixes for Qubes R4","status":"resolved","priority":"High","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1508879963,"date_modified":1508879963,"content":"Whonix 14:\nhttps://github.com/Whonix/whonixcheck/commit/ac614c35717fb3450b6415b3010396d1549ab7d7\n\nWhonix 13:\nTODO\n"},{"author":"Patrick","date_created":1508933423,"date_modified":1508933423,"content":"Whonix 14:\nhttps://github.com/Whonix/whonixcheck/commit/967bea77f61c03f0b2d52cd446cedc6c0cca7e27\n\nWhonix 13:\nhttps://github.com/Whonix/whonixcheck/commit/743ccc9233e14c549214cd2b4727e97d7ff9ad4c"},{"author":"Patrick","date_created":1509183522,"date_modified":1509183522,"content":"Whonix 13: uploaded to jessie-proposed-updates.\n"}]},"PHID-TASK-njw3fbmteq43ozgtqlh4":{"id":"723","title":"Qubes R4 RC1 - Whonix 13 - updates proxy test failing sometimes","status":"resolved","priority":"High","author":"Patrick","description":"The following is showing a false positive.\n\nhttps://github.com/Whonix/qubes-whonix/blob/Whonix13/usr/lib/qubes-whonix/qubes-whonixsetup#L41\n\n```\n    # Display warning that TemplateVM is not connected to a Tor update proxy.\n    if [ ! -e '/var/run/qubes-service/whonix-secure-proxy' ]; then\n        /usr/lib/qubes-whonix/alert update /usr/lib/qubes-whonix/messages.yaml\n    fi\n```\n\nSomething in\n\n* https://github.com/Whonix/qubes-whonix/blob/Whonix13/usr/lib/qubes-whonix/init/torified-updates-proxy-check\n* or https://github.com/Whonix/qubes-whonix/blob/Whonix13/usr/lib/qubes-whonix/utility_functions.sh\n\nMust be wrong.\n\nThe [timeout](https://github.com/Whonix/qubes-whonix/blob/Whonix13/usr/lib/qubes-whonix/init/torified-updates-proxy-check#L40) is currently set to `10`. Perhaps it's enough to increase it?\n\nWhat do you think would be a safe value even covering slow machines? @marmarek ","comments":[{"author":"Patrick","date_created":1508505070,"date_modified":1508505070,"content":"A timeout might not be sufficient? Just starting the `whonix-gw` (or `whonix-ws`) template alone does not result in invoking Qubes updates proxy qrexec call and thereby starting `sys-whonix`? Imagine the user just starting `whonix-gw` (or `whonix-ws`)  and then getting distracted, doing something else, not upgrading."},{"author":"marmarek","date_created":1508505535,"date_modified":1508505535,"content":"sys-whonix is started by first request to updates proxy (if not already running). In most cases it will be that connectivity check. I think connect timeout doesn't matter here, as connection (in terms of TCP) is to localhost, instant. Only the response comes later.\nI guess the problem is that the warning is displayed, while the connectivity check is still running (i.e. race condition). Since sys-whonix takes some time to start, it happens reliably. Maybe some dependencies between those services would help (is it possible to order GUI application after system service startup?). Or some lock file to synchronize those things?\nIf none of above is possible, some solution would be ordering connectivity check with `Before=qubes-gui-agent.service`. But I'd treat this as last resort."},{"author":"Patrick","date_created":1508510317,"date_modified":1508510317,"content":"While I was at it, improved that popup message a bit. It's hard for me to word what to say in such a situation.\n\nhttps://github.com/Whonix/qubes-whonix/commit/d4d47b9c28514a82538f8cf7bfd2c2dbc6336389\n\nThis check makes less and less sense since Qubes R4. I never liked having that check in the #qubes-whonix package. It doesn't have the right infrastructure there to support it. If anything, it belongs to #whonixcheck. There is T656 for that.\n\nFixing that race condition is very hard. See T424 for research and attempts to fix that.\n\nMeanwhile I backported the Whonix 13 solution which waits up to 120 seconds.\n\nhttps://github.com/Whonix/qubes-whonix/commit/c6ab06fcc27d4d76e9c90eeef6ee8e2c9c7644a3\n\nGood enough?"},{"author":"Patrick","date_created":1508510765,"date_modified":1508510765,"content":"Uploaded to jessie-proposed-updates."}]},"PHID-TASK-krhcipr62l733wzavc4d":{"id":"722","title":"remove kmix-disable-autostart","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"I suspected that kmix-disable-autostart was no longer needed as a workaround. According to it's control file description, it's there to make sure the clipboard history icon is loaded into the system tray. If that's it, it is no longer needed. To test, I removed it from meta-packages and removed the folder. I built an ova. The clipboard icon is there in the system tray and functioning normally.\n\n{F1375323}","comments":[{"author":"Patrick","date_created":1508236916,"date_modified":1508236916,"content":"https://github.com/Whonix/kmix-disable-autostart/blob/master/usr/share/lintian/overrides/kmix-disable-autostart doesn't do anything relevant to disable autostart - besides disabling a linitian warning.\n\nThe implementation is done in https://github.com/Whonix/kmix-disable-autostart/blob/master/debian/kmix-disable-autostart.hide and by using config-package-dev.\n\nIf a new image was built without package `kmix-disable-autostart` and kmix didn't autostart, and kilpper is visible in systray by default, then everything should be fine indeed and `kmix-disable-autostart.` can be deprecated, removed from anon-meta-packages and removed from github.com/Whonix/Whonix packages folder.\n\nWe don't install kmix by default anymore anyhow, right? What mixer gets installed if any?"},{"author":"JasonJAyalaP","date_created":1508365046,"date_modified":1508365215,"content":"> We don't install kmix by default anymore anyhow, right? What mixer gets installed if any?\n\nHa! kmix is no longer installed by default in Debian 9. Plasma uses a native pulseaudio mixer widget thingie. I think that confirms that we can remove this package.\n\nfrom the changelog.upstream of anon-meta:\n```\nDate:   Sun Jan 15 06:28:43 2017 +0000\n\nadd plasma-pa to anon-shared-applications-kde (kmix replacement)\n```"},{"author":"JasonJAyalaP","date_created":1508365263,"date_modified":1508365295,"content":"@Patrick I haven't removed a package from packages/ before. What is the process? Just git rm? (I've already removed it from the control file of anon-meta-packages."},{"author":"Patrick","date_created":1508395575,"date_modified":1508395575,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   @Patrick I haven't removed a package from packages/ before. What is the process?\n\n1)\n\ngrep all to see it is no longer referenced somewhere. Specifically not\nfrom anon-meta-packages.\n\n2)\n\n    git rm packages/pkg-name\n\n3)\n\n    git push\n\n4)\n\nUpdate the package description on github. (At the very top. Not part of\nthe readme.) Mention, that the package is deprecated since Whonix 14 and\nmigrated where.\n\n5)\n\nLeave a note with the link to github on\nhttps://www.whonix.org/wiki/Dev/Redistribution#Misc so we'll remove\nthese packages after release."},{"author":"JasonJAyalaP","date_created":1508436766,"date_modified":1508436790,"content":"done:\nhttps://github.com/Whonix/Whonix/commit/8a14e809dbda096a86bef5705dff9b652ce46b24\nhttps://github.com/Whonix/anon-meta-packages/commit/b16958fe77fd370ade22fb3e87354ce2483739b9\nhttps://www.whonix.org/wiki/Dev/Redistribution#Misc \nhttps://github.com/Whonix/kmix-disable-autostart"}]},"PHID-TASK-pocnajtuibt5d3ol2hvp":{"id":"721","title":"deb.debian.org instead of us.debian.org and use https (SSL, TLS) by default / fix build --connection onion","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"the USA server is hard coded into Whonix. If debian could successfully provide a mirror, we could use local.debian.org instead of us.debian.org. You'd think this would be easy...\n\nTails has attempted to use debian's previous geo mirror CDN service thingies, but could not get it work. See: https://labs.riseup.net/code/issues/9235\n\nI've asked them to try again with debian's latest version:\nhttps://labs.riseup.net/code/issues/14669 \n\nAnd we should look into it for Whonix 15.\n\nhttps://lists.debian.org/debian-security/2017/10/msg00006.html\n\n----\n\nuse https by default\n\n* https://github.com/QubesOS/qubes-issues/issues/4415#issuecomment-431805798\n* http://forums.whonix.org/t/enable-qubes-onion-repo-by-default/6156/8\n* https://forums.whonix.org/t/debian-apt-get-updates-over-https-ssl-tls-by-default-or-avoiding-amazon-aws-pick-one/6272","comments":[{"author":"JasonJAyalaP","date_created":1505853336,"date_modified":1505853336,"content":"@Patrick have you considered following tails and using onion sources? I don't see security the benefit that outweighs the load on tor."},{"author":"Patrick","date_created":1505856738,"date_modified":1530804934,"content":"> I don't see security the benefit that outweighs the load on tor.\n\n- security: everyone is exited about onion sources nowadays. It's an extra layer of encryption and authentication. ... etc ...\nhttps://www.whonix.org/wiki/Security_Guide#Onionizing_Repositories\n\n> I don't see security the benefit that outweighs the load on tor.\n\n- load on Tor is invalid: Tor Project does is okay with that. They support apt onion sources. The only load they don't want is the endless upload by file sharing.\n\n> @Patrick have you considered following tails and using onion sources?\n\nYes. We go all onion by default. One day.\n\nIt's hard.\n\n- reminder: using Tor is suspicious in some countries\n\n- prevent no Tor over Tor (perhaps support non-Tor over Tor builds in Whonix-Workstation VMs only - easy - already implemented in anon-ws-disable-stacked-tor)\n\n- can there be a legitimate case where someone wants to build Whonix while at the same time being surprised it connected to the Tor network while doing so?\n\n- the build script would - if still needed - update from clearnet repositories - and install Tor - so all of the build script can then be torified and using onion sources\n\n-- hard, because we'd have to honor users who wish to use bridges\n\n- Interactive asking for all of this by default? Not great, and we'd also need switches to make it non-interactive (for automated build environments, CI testing and the like)\n\nI am undecided how to do this. But this can be sorted at the right time."},{"author":"Patrick","date_created":1541667753,"date_modified":1541667753,"content":"* https://github.com/Whonix/anon-apt-sources-list/commit/9f08431be63b4977931fe2db57b067e660828997\n* https://github.com/Whonix/Whonix/commit/867a481710077f6bf4e14a5d8c87471e81db85df\n"},{"author":"Patrick","date_created":1541676732,"date_modified":1541676732,"content":"Reverted. Main reason:\nhttps://forums.whonix.org/t/https-ssl-tls-by-default-broke-apt-cacher-ng-apt-package-caching-during-build/6276\n\nMaybe another reason:\nhttps://forums.whonix.org/t/debian-apt-get-updates-over-https-ssl-tls-by-default-or-avoiding-amazon-aws-pick-one/6272\n"},{"author":"HulaHoop","date_created":1545955472,"date_modified":1546025513,"content":""},{"author":"Patrick","date_created":1545989520,"date_modified":1546264126,"content":""},{"author":"Patrick","date_created":1548049257,"date_modified":1548049257,"content":"https://github.com/Whonix/Whonix/commit/64b5b6133d733b7bb400262199992d116ae8709b\nhttps://github.com/Whonix/Whonix/commit/b83dddec7c191160332bc9233feb6069bb28d435\nhttps://github.com/Whonix/Whonix/commit/d182a2720c8c6a56492fccf45a8bc8c2b2902e67\nhttps://github.com/Whonix/Whonix/commit/abaf332e0d831dc61dbe3ef0f37e701be63a494e\nhttps://github.com/Whonix/Whonix/commit/360cc8f283d3d7ad5f1ef1a2984fa78465187dd9\nhttps://github.com/Whonix/Whonix/commit/ec204c7434efbf985e8526d1d81ff5c9e91e1c44\nhttps://github.com/Whonix/Whonix/commit/5e06301a66e93cbd1253ea7a52af993848a0d099\nhttps://github.com/Whonix/Whonix/commit/0a370cf1c98ed7ac46edfda1371e81b7df314154\nhttps://github.com/Whonix/Whonix/commit/8add221ae13de742c3c615fb7c63ce518a9c99f3\nhttps://github.com/Whonix/Whonix/commit/54483462c12e30ec52d05f7e75537d607d9b3422\nhttps://github.com/Whonix/Whonix/commit/3f087b337903a7e37685b0de464eb0c1ab9fc622\nhttps://github.com/Whonix/Whonix/commit/d035e40127ca922749f6273f6f193db27be19601\nhttps://github.com/Whonix/Whonix/commit/ca3add2343abd5846987400c04fd043082f1a489\nhttps://github.com/Whonix/Whonix/commit/5f88d1d7377ff275679f629539d0de24f57e031e\nhttps://github.com/Whonix/anon-shared-build-apt-sources-tpo/commit/7948da7d5c6e964455375499704851b3ca2cc21d\nhttps://github.com/Whonix/whonix-repository/commit/903f0893182ecdbebd6eacd483f373940573e4bc\nhttps://github.com/Whonix/whonix-legacy/commit/25663b8c9bd91185586ce9e18d07500abb81ca18\nhttps://github.com/Whonix/whonix-initializer/commit/6705fa45965c20612ed40276fc961deb0e40890e\n\n----\n\nThis has potential to break builds. Please try to build.\n\n* KVM: //cc @HulaHoop \n* RPi: //cc @Algernon \n\nnew requirements for build machine:\n\n    sudo apt-get install git time curl apt-cacher-ng\n\ngit tag\n\n    14.0.1.0.7-developers-only"},{"author":"Patrick","date_created":1548054622,"date_modified":1548054622,"content":"This is now in `stretch-testers` repository."},{"author":"HulaHoop","date_created":1548106361,"date_modified":1548106361,"content":"Building initiates. I had these deps installed anyhow. Unpinning the CPU resolved some early build error, but now it craps out at RAW image creation. Not really related to your inquiry."},{"author":"Patrick","date_created":1548218408,"date_modified":1548218408,"content":"Use SSL and apt-cacher-ng also during genmkfile inside cowbuilder.\n\nfix `--connection onion`\n\nTor Browser onion connection when using `--connection onion`\n\n----\n\nT678\nhttps://github.com/Whonix/genmkfile/commit/2023d66d30fea53eddd408400e85bdc61998ea18\nhttps://github.com/Whonix/Whonix/commit/13fae08f3fec4f2fccc30a8aa00202aefe363b86\nhttps://github.com/Whonix/Whonix/commit/87dd2e7848eff3f1e5e5b6feb5db26d02c5e9431\nhttps://github.com/Whonix/Whonix/commit/9565bd21782c5a94f0e592dda4b1c3c8919a644d\nhttps://github.com/Whonix/Whonix/commit/e2027e93827768ecc6b88f2a44ac9d3b86986d8b\nhttps://github.com/Whonix/Whonix/commit/99b3292a929ceed3a893df212a6639b32b872e46\nhttps://github.com/Whonix/Whonix/commit/206f4a00af107012ce3162114e1ce9b940d52c39\nhttps://github.com/Whonix/Whonix/commit/be98658fe717abaeba34fb724fc12727dd99504e\nhttps://github.com/Whonix/Whonix/commit/c01ab5ccd6188f5e0cf816a310c1ad2d67021086\nhttps://github.com/Whonix/Whonix/commit/6e683dadf2426e6832a8d1d1663a8eb7b1bea075\nhttps://github.com/Whonix/Whonix/commit/fc07b3b3d640d9e420584ba6366e223a0e3571a6\nhttps://github.com/Whonix/Whonix/commit/86220935732765dc29dfceec9ab1c82b8fecc441\nhttps://github.com/Whonix/Whonix/commit/1d7eb7180b98fe73c0eb124f9d9cbaa426dc27c8\n\n----\n\nnew build dependencies:\n\n    sudo apt-get install git time curl apt-cacher-ng lsb-release fakeroot\n\n(Actually same build dependencies but sacrifices builder convenience of installing fewer packages manually for simplified code and quicker to fix `--connection onion`.)\n\n----\n\ngit tag including this coming soon."},{"author":"Patrick","date_created":1548225156,"date_modified":1548225156,"content":"https://github.com/Whonix/genmkfile/commit/c0d35c24569dea4af1b873c3a89bbf492cd44470\nhttps://github.com/Whonix/Whonix/commit/0c63f16671e2387f1ccf86f791a77657f305f4f7\n\n----\n\nThis is done in `14.0.1.1.3-developers-only` but building Whonix is currently not safe anyhow due to apt security update - DSA 4371-1. Will elaborate here:\n\nhttps://forums.whonix.org/t/apt-rce-announced-new-whonix-images-needed/6715/3?u=patrick"}]},"PHID-TASK-l35pxmljlimbn42mm2bt":{"id":"720","title":"post feature request for more secure clipboard sharing against VirtualBox and KVM","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"```\nIn VirtualBox / KVM:\n\n* `ctrl + c` in a VM leads to copying the contents into the VMs clipboard as well as into the host clipboard as well as into the clipboard of any other VM\n* `ctrl + c` on the host leads to copying the contents into the host's clipboard as well as into the clipboard of any VM\n* this is non-ideal for security since in many cases VMs are used to compartmentalize things.\n\nIn Qubes:\n\n* `ctrl + c` / `ctrl + v` takes effect only inside the VM. \n* Each VM has its own independent clipboard.\n* The Qubes host (dom0) has its own independent clipboard.\n* Qubes introduced the concept of a global clipboard.\n* To global copy the user has to run `ctrl + shift + c`. This copies contents into the global clipboard.\n* A subsequent `ctrl + shift + v` pastes it into one other VM.\n* (\"global clipboard\" is a non-ideal name. The \"global\" clipboard cannot be read by other VMs in which `ctrl + shift + v` was not used.)\n* After `ctrl + shift + v` the global clipboard gets cleared to prevent accidental leakage into another VM.\n* These are my words. This is how Qubes describes the feature: [1]\n\n[1] https://www.qubes-os.org/doc/copy-paste/\n```\n\nTODO:\nrehash and post feature requests against #VirtualBox and #KVM\n\n----\n\nKVM\n\n* https://lists.freedesktop.org/archives/spice-devel/2015-April/019617.html\n* https://bugzilla.redhat.com/show_bug.cgi?id=1320263#c4\n* https://bugzilla.redhat.com/show_bug.cgi?id=1320263#c5\n* https://forums.whonix.org/t/why-use-virtualbox-over-kvm-on-linux-hosts-considering-deprecation-of-virtualbox-on-linux-hosts/7198/14\n* https://gitlab.freedesktop.org/spice/spice-protocol/issues/8\n* https://gitlab.freedesktop.org/spice/spice-gtk/issues/97","comments":[{"author":"JasonJAyalaP","date_created":1508191207,"date_modified":1508191207,"content":"> rehash and post feature requests against VirtualBox and KVM\nI don't remember. What were the feature requests that we wanted from VB/KVM?\n\n> defer\nTwo small changes. Tell me if you want it for 14. \nFor reference:\n\nhttps://github.com/Whonix/Whonix/blob/master/build-steps.d/2600_create-vbox-vm#L103\n`sudo $SUDO_OPTS VBoxManage modifyvm \"$VMNAME\" --clipboard bidirectional`\nhttps://github.com/Whonix/Whonix/blob/master/build-steps.d/2600_create-vbox-vm#L106\n`sudo $SUDO_OPTS VBoxManage modifyvm \"$VMNAME\" --draganddrop hosttoguest`"},{"author":"Patrick","date_created":1508237327,"date_modified":1508237327,"content":">>! In T720#14631, @JasonJAyalaP wrote:\n>> rehash and post feature requests against VirtualBox and KVM\n> I don't remember. What were the feature requests that we wanted from VB/KVM?\n\nSame way Qubes is doing it. In VirtualBox case that would be:\n\nhost key + ctrl + c\nhost key + ctrl + v\nhost key + ctrl + x\n\nhost key is the terminology that VirtualBox developers are already using.\n\nThat. And then read https://www.qubes-os.org/doc/copy-paste/ and rehash to make the case for VirtualBox.\n\nDefer making the KVM feature request to HulaHoop.\n\n>> defer\n> Two small changes. Tell me if you want it for 14. \n> For reference:\n> \n> https://github.com/Whonix/Whonix/blob/master/build-steps.d/2600_create-vbox-vm#L103\n> `sudo $SUDO_OPTS VBoxManage modifyvm \"$VMNAME\" --clipboard bidirectional`\n> https://github.com/Whonix/Whonix/blob/master/build-steps.d/2600_create-vbox-vm#L106\n> `sudo $SUDO_OPTS VBoxManage modifyvm \"$VMNAME\" --draganddrop hosttoguest`\n\nSince it's that easy, can be done for Whonix 14."},{"author":"HulaHoop","date_created":1556157715,"date_modified":1556157715,"content":"**Update:**\n\nIssue was discussed by Libvirt devs on RedHat bugzilla:\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1320263#c4\nI even linked to a secure clipboard proposal that would have given a secure clipboard functionality by copying Qubes style interaction. It went no where and was closed as WONTFIX.\n\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1320263#c5\n\n***\n\nFeel free to pursue this for VBox, as for KVM the issue is moot and you can close the ticket."},{"author":"Patrick","date_created":1556276357,"date_modified":1556276357,"content":">>! In T720#18410, @HulaHoop wrote:\n> https://bugzilla.redhat.com/show_bug.cgi?id=1320263#c5\n\nNo suggestion for a secure implementation was posted there. Therefore not too surprising it went nowhere. I woulnd't take that one as reason to give up already.\n\n> https://lists.freedesktop.org/archives/spice-devel/2015-April/019617.html\n\nThat one sounds friendly, interested. Perhaps it just was forgotten?\n\nCould you please rehash and post a feature request at https://gitlab.freedesktop.org/groups/spice/-/issues?"},{"author":"HulaHoop","date_created":1556661157,"date_modified":1556661157,"content":"https://gitlab.freedesktop.org/spice/spice-protocol/issues/8"},{"author":"Patrick","date_created":1556670344,"date_modified":1556670344,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>   https://gitlab.freedesktop.org/spice/spice-protocol/issues/8\n\nAwesome!"},{"author":"HulaHoop","date_created":1558503196,"date_modified":1558503196,"content":"Update:\n\nAccepted as optional feature/usecase. Moved implementation design from protocol level to spice-gtk.\n\nhttps://gitlab.freedesktop.org/spice/spice-gtk/issues/97"}]},"PHID-TASK-htjw5cmfmhncj2mcykg4":{"id":"719","title":"gpg --with-fingerprint patrick.asc doesn't show fingerpint on GW","status":"resolved","priority":"Low","author":"JasonJAyalaP","description":"Under “get the signing key” in the wiki\n```\nVerify it shows the following:\npub  4096R/2EEACCDA 2014-01-16 Patrick Schleizer <adrelanos@riseup.net>\n      Key fingerprint = 916B 8D99 C38E AF5E 8ADC  7A2A 8D66 066A 2EEA CCDA\nsub  4096R/CE998547 2014-01-16 [expires: 2016-10-05]\nsub  4096R/119B3FD6 2014-01-16 [expires: 2016-10-05]\nsub  4096R/77BB3C48 2014-01-16 [expires: 2016-10-05]\n```\nAnd that works on the WS:\n```\nWS\npub   rsa4096/0x8D66066A2EEACCDA 2014-01-16 [SC] [expires: 2021-04-17]\n      Key fingerprint = 916B 8D99 C38E AF5E 8ADC  7A2A 8D66 066A 2EEA CCDA\nuid                             Patrick Schleizer <adrelanos@riseup.net>\nsub   rsa4096/0x3B1E6942CE998547 2014-01-16 [E] [expires: 2021-04-17]\nsub   rsa4096/0x10FDAC53119B3FD6 2014-01-16 [A] [expires: 2021-04-17]\nsub   rsa4096/0xCB8D50BB77BB3C48 2014-01-16 [S] [expires: 2021-04-17]\n```\n\nBut gpg --with-fingerprint patrick.asc doesn’t show the fingerprint on GW\n```\nuser@host:~$ gpg --with-fingerprint patrick.asc\npub   rsa4096 2014-01-16 [SC] [expires: 2021-04-17]\nuid           Patrick Schleizer <adrelanos@riseup.net>\nsub   rsa4096 2014-01-16 [E] [expires: 2021-04-17]\nsub   rsa4096 2014-01-16 [A] [expires: 2021-04-17]                                                                           \nsub   rsa4096 2014-01-16 [S] [expires: 2021-04-17]  \n```","comments":[{"author":"Patrick","date_created":1504615904,"date_modified":1504615904,"content":"Is there a `gpg --version` mismatch?"},{"author":"JasonJAyalaP","date_created":1504720511,"date_modified":1504720511,"content":"Looks the same.\n\nws\n```\nuser@host:~$ gpg --version\ngpg (GnuPG) 2.1.18\nlibgcrypt 1.7.6-beta\nCopyright (C) 2017 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.                                                                                                                              \n                                                                                                                                                                                   \nHome: /home/user/.gnupg                                                                                                                                                            \nSupported algorithms:                                                                                                                                                              \nPubkey: RSA, ELG, DSA, ECDH, ECDSA, EDDSA                                                                                                                                          \nCipher: IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,                                                                                                                 \n        CAMELLIA128, CAMELLIA192, CAMELLIA256                                                                                                                                      \nHash: SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224                                                                                                                              \nCompression: Uncompressed, ZIP, ZLIB, BZIP2    \n```\n\ngw\n```\nuser@host:~$ gpg --version\ngpg (GnuPG) 2.1.18\nlibgcrypt 1.7.6-beta\nCopyright (C) 2017 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\n\nHome: /home/user/.gnupg\nSupported algorithms:\nPubkey: RSA, ELG, DSA, ECDH, ECDSA, EDDSA\nCipher: IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,\n        CAMELLIA128, CAMELLIA192, CAMELLIA256\nHash: SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224\nCompression: Uncompressed, ZIP, ZLIB, BZIP2\n```"},{"author":"JasonJAyalaP","date_created":1504828782,"date_modified":1504828782,"content":"Very odd, but not using --with-fingerprint prints out the same fingerprint:\n\n```\nuser@host:~$ gpg patrick.asc \npub   rsa4096/0x8D66066A2EEACCDA 2014-01-16 [SC] [expires: 2021-04-17]\n      916B8D99C38EAF5E8ADC7A2A8D66066A2EEACCDA\nuid                             Patrick Schleizer <adrelanos@riseup.net>\nsub   rsa4096/0x3B1E6942CE998547 2014-01-16 [E] [expires: 2021-04-17]\nsub   rsa4096/0x10FDAC53119B3FD6 2014-01-16 [A] [expires: 2021-04-17]\nsub   rsa4096/0xCB8D50BB77BB3C48 2014-01-16 [S] [expires: 2021-04-17]\n```\n\nThe \"Fingerprint\" line isn't as nice, but it is fine and it works on both ws and gw.\n\nI will change the wiki to match this unless someone can figure out why fingerprint won't print out in gw"},{"author":"Patrick","date_created":1504831838,"date_modified":1504831838,"content":"gpg config by https://github.com/Whonix/anon-gpg-tweaks probably makes\nthe difference which is only installed on Whonix-Workstation."}]},"PHID-TASK-hquj3lq7xoutigth4hv3":{"id":"718","title":"Shared Clipboard and Drag n Drop defaults for WS and GW","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"As explained in https://www.whonix.org/wiki/VirtualBox/Guest_Additions#Clipboard_Sharing\nThe OVAs for WS and GW have different defaults for shared clipboard and drag n drop.\n\nWS has both disabled.\nGW has clipboard set to host-to-guest and dnd to disabled.\n\n1. The footnotes seem to missing. What was the reasoning? Having bidirection clipboard sharing is very important to usability and required by all new users.\n\nMy proposal is that it's on by default so that new users have one less thing to look up in the wiki, and advanced users facing advanced threats will know how to turn it off. I don't mean to open up the usability vs security discussion, but I guess I just did.","comments":[{"author":"Patrick","date_created":1504607212,"date_modified":1504607212,"content":"Footnotes were missing due to a wiki markup bug with the `div` tags. Now fixed.\n\nA secure solution is how Qubes implements clipboard sharing."},{"author":"Patrick","date_created":1504607294,"date_modified":1504607294,"content":"Since this is a Whonix wide discussion. If we change it in VirtualBox, we should consider changing it in Whonix KVM as well.\n\nDo you remember where this was originally discussed? @HulaHoop Or do you remember the reasoning for it?\n"},{"author":"HulaHoop","date_created":1504754788,"date_modified":1504754788,"content":"The reasoning for the clipboard was prevention of pasting sensitive host commands or clearnet URLs into the WS and vice versa. For the drag and drop it was to reduce attack surface and prevent user mistakes by forcing them to explicitly move files they want in the guest to a specific folder in the VM."},{"author":"JasonJAyalaP","date_created":1504824365,"date_modified":1504824384,"content":"I believe that new users are in a \"practice\" phase, where they try Whonix out, mess things up, remove the VM and try again. In this scenario, anything that a new user (who has a low tolerance for headache) would want to enable in order to learn how to use Whonix, should be enabled. As they learn how to be security-smart, they can make decisions about what stays on or off.\n\nThere are limits to that argument, of course, and the big downside is that they may never learn about dangers related to clipboard sharing or drag and drop. \n\nI don't have too strong an opinion. Really, new users should learn with a guide (that someone, maybe me, needs to write) that goes over all these points. There's just no way to satisfy all concerns via defaults. \n\nI'll defer this decision to Patrick. We can close the issue for now (and keep the current defaults) and if Patrick/you guys change your mind, I'll update the wiki and OVAs"},{"author":"Patrick","date_created":1505232196,"date_modified":1557307593,"content":"Actually, this default setting annoys myself. It's the first thing to\nturn off, after an annoying session of forget-shutdown-enable-reboot.\nIt's a non-solution. If users stop using Whonix because of such\nusability hurdles, the whole thing shoots itself into the foot.\n\nA real solution is how Qubes implements this. Unfortunately it's very\nhard to implement, so that's out of scope for now.\n\nTODO #whonix_15:\n\n* learn why Qubes does \"secure copy and paste\"\n* learn how Qubes implements it from a usability perspective (global\ncopy/paste: ctrl + shift + c | ctrl + shift + v)\n* rehash and post feature requests against VirtualBox and KVM\n* enable clipboard sharing by default in Whonix VirtualBox\n* Let's defer enabling/disabling clipboard sharing by default in Whonix KVM to @HulaHoop.\n\nPlease create a ticket."}]},"PHID-TASK-ec2ebw4isc6dt3hgs4yg":{"id":"717","title":"curl: (4) OpenSSL was built without TLS 1.3 support","status":"wontfix","priority":"Needs Triage","author":"JasonJAyalaP","description":"I forget if we've talked about this already.\n\ncurl --tlsv1.3 and therefore scurl currently fails with the TLS 1.3 error message. What are we doing for Whonix 14?","comments":[{"author":"Patrick","date_created":1504605608,"date_modified":1504605608,"content":"We keep --tlsv1.2 and update T682."}]},"PHID-TASK-pjx276kobggt7q3hglzj":{"id":"716","title":"Integrate anon-connection-wizard into whonix-setup-wizard","status":"resolved","priority":"Low","author":"iry","description":"`anon-connection-wizard` is now [mature enough](http://forums.kkkkkkkkkk63ava6.onion/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/303) to be shipped with Whonix14.\n\n\nHowever, it would be even better to integrate `anon-connection-wizard` into `whonix-setup-wizard`. Specifically, `whonix-setup-wizard` should be able to start `anon-connection-wizard` instead of showing the current network configuration page.\n\nIn the further future, Patrick [pointed out](http://forums.kkkkkkkkkk63ava6.onion/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/323):\n> From next year, we can abolish the Whonix first time setup disclaimer. And we’ll enable Whonix’s repository by default for Whonix download version. From then, we’ll only autostart anon-connection-wizard on Whonix-Gateway.\n\nwhonix-setup-wizard code: https://github.com/Whonix/whonix-setup-wizard\nanon-connection-wizard code: https://github.com/irykoon/anon-connection-wizard","comments":[{"author":"iry","date_created":1512615698,"date_modified":1512615698,"content":"Could anyone please help me to test if these two pull request will be enough to Integrate anon-connection-wizard into whonix-setup-wizard? \n\nhttps://github.com/Whonix/anon-connection-wizard/pull/10\nhttps://github.com/Whonix/whonix-setup-wizard/pull/3"},{"author":"Patrick","date_created":1513627008,"date_modified":1513627008,"content":"status update:\n\nhttps://forums.whonix.org/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/377"}]},"PHID-TASK-bjjjyog6l7tstsota5dx":{"id":"715","title":"Whonix Setup doesn't fire on first run of gateway","status":"resolved","priority":"Needs Triage","author":"JasonJAyalaP","description":"After importing the gateway ova (14.0.0.2.6) and running, whonix setup never fires off automatically. I have to manually run it. After that it works fine. \n\nWhat is the package/script that detects first boot and runs whonix setup?","comments":[{"author":"Patrick","date_created":1504124909,"date_modified":1504124909,"content":"Might be fixed in 14.0.0.4.2 already."},{"author":"JasonJAyalaP","date_created":1504558983,"date_modified":1504558983,"content":"Fixed"}]},"PHID-TASK-kw6a7u5343wlzombc2ig":{"id":"714","title":"Whonix live mode / grub-live","status":"resolved","priority":"Normal","author":"Algernon","description":"First patches to run Whonix as a live system.\n\n( https://forums.whonix.org/t/whonix-live-mode )\n\n{F844246}","comments":[{"author":"Patrick","date_created":1504616059,"date_modified":1504616059,"content":"A `tar.xz` is not a great source for source code. Could you publish this using git please?"},{"author":"Algernon","date_created":1509559216,"date_modified":1509559216,"content":"{F1622187}\n\nAttached is the diff against 14.0.0.5.2-developers-only. It contains minor changes to the original Whonix source and some new files for the dracut live system. I removed some changes which should be only relevant on my side. If it doesn't build I can add them. \nWith this patch the raw gateway and workstation boot in normal, live and live toram mode. You can choose in the grub menu what option you want to boot. I didn't check each application but I don't see a reason why some app shouldn't work due to running live. Exception is currently Apparmor confined stuff which will complain when booted with overlayfs (currently default). So either the profiles have to be adapted or I'll change the default mode to device-mapper. \nIf you want to boot without overlayfs and use device-mapper instead just remove rd.live.overlay.overlayfs from the grub menu for the normal live mode. For the toram mode you have to use \"rd.live.plainroot\" instead of \"rd.live.mksquashfs rd.live.overlay.overlayfs\" . "},{"author":"Patrick","date_created":1509654820,"date_modified":1509654820,"content":"I can see you know your way around in Whonix source code and found a lot. :) Gave it a quick review. Looks mostly good for me except...\n\nI don't like the idea to tell the builder \"apply this patch to build Whonix live\". Applying patches on top adds another level of complexity that I don't like. Could you just send git pull requests please and then implement this with an `if`/`else` code style?\n\nRather than patching `grml_packages`, just add another file `grml_packages_live` or so.  (This is because inside that file we cannot add if/else.)\n\n\"$WHONIX_SOURCE_FOLDER/grml_packages\" should be turned into a variable in `help-steps/variables` and then referenced that way. Not a big deal. If that sounds difficult, just add `grml_packages_live` or so and leave that to me.\n\nswap-file-creator changes: can these be made `if`/`else` changes please as well? I.e. \"if live mode is enabled, do it that way, otherwise do it the default way\" style?\n\nFor example, the following does not even need an `if`/`else` for simplicity - just a comment \"only used in case of Whonix live build\" or so.\n\n> +   rm --force \"$CHROOT_FOLDER/$WHONIX_SOURCES_LIST_TEMP_BUILD_FOLDER/build_sources_testing.list\"\n> +   rm --force \"$CHROOT_FOLDER/etc/apt/preferences\"\n\nDo we still need dracut-live-patches in Whonix 14 which is stretch based? If so, I wouldn't mind adding another package `packages/dracut-live-patches` to the mainline.\n\nPlease use config-package-dev rather than dpkg-divert. (There are examples in Whonix source code.) (Which we are using for a long term in Whonix and which is a lot better.) If you find config-package-dev difficult, just leave it as is and I will add another revision on top.\n\nFor new files in `/etc/grub.d/` etc.\n\n* If existing: if it was imported from a third party open source, please copy the link to the original in here.\n* If existing and modified: Please add the original to the git history first, then add another change on top in case you needed to add modifications. (Makes it easier to see original and changes.)\n\n/packages/whonix-gw-network-conf/debian/whonix-gw-network-conf.triggers is unfortunate. Can't we have\n\n```\nactivate update-initramfs\nactivate dracut\n```\n\nat the same time? Or would `activate dracut` break on systems that do not have it dracut installed? Or would `activate update-initramfs` break on systems without initramfs? Anyhow... Somehow we'll manage to avoid a patch here.\n\npackages/whonix-developer-meta-files/package_documentation doesn't need a patch. That file is not all that strict. Just add it unconditionally with the appropriate comment, that's it.\n\npackages/anon-meta-packages/debian/control - I hope very much we can avoid a patch here as well. A patch isn't really suitable - imagine this package gets upgraded from Whonix apt repository. There is only one Whonix repository and not live/not-live. (We also shouldn't have two repositories. The diff is way to minor (I don't say developing this is simple - just it does not interfere much with exiting Whonix) for separate Whonix apt repositories.\n\nPerhaps we\n\n* remove `initramfs-tools` from `non-qubes-vm-enhancements` and then add to\n* add `initramfs-tools` to `non-qubes-whonix-gateway` and `non-qubes-whonix-workstation`\n* new packages `non-qubes-whonix-gateway-live` and `non-qubes-whonix-workstation-live` that depend on the dracut packages\n\nOr better as per https://forums.whonix.org/t/whonix-live-mode/3894/6 we make `initramfs-tools` a `weak recommended package`? Add it to `grml_packages` (and ensure it does not get purged, keeps kept on Whonix 13 -> Whonix 14 upgrades)? If that sounds difficult, I can also look into that.\n\n\npackages/whonixcheck/etc/apparmor.d/usr.bin.whonixcheck what does it do? Any reason for not having that in the mainline non-live?\n\nAs said... Except for this being a patch rather than `if`/`else` code style, there is little to complain.  Once converted into `if`/`else` code style, I can give it a more thoroughly review but I am confident a speedy review/merge is possible here since it interferes little with Whonix non-live.\n\nAfter that... We make it a build option? What about `sudo apt-get install pkg-name` method to transform existing Whonix versions into this? Should be quite doable? (Whatever you like to maintain - won't push you into that.)\n\n> So either the profiles have to be adapted or I'll change the default mode to device-mapper. \n\nDunno yet. Please elaborate. What options are there? device-mapper is one choice, what's the other? What are the differences?\n\nIn which way the apparmor profiles would have to be changed? Could we consider these bugs in Whonix apparmor profiles? Then we should do-it-right(tm), just fix them anyhow and not require other packages (yours) to add workarounds. Or is not using device-mapper mode causing other issues as well?"},{"author":"Algernon","date_created":1509711320,"date_modified":1509711453,"content":"The patch was not meant to be integrated already in the official Whonix source. More like: $interested_person can get an idea how a 14.0.0.5.2 live image would build and look in the end.\n\nFor the \n\n> if/else\n\nI'm not 100% sure how it should work. As build option or as boot option or both?\nI think a dedicated build option like \"--live\" should be possible and depending on this using the different config files like `grml_packages_live`\n\nThe swap file changes already have some kind of if/else option but more for booting and not for building. I.e. it is tested if the system was booted live and if it was it skips creation of the file and if it boots normally it will just do what it always has done.\n\n\nThe dracut live patches are still required, the version which the patches use is currently in testing. So either the patches have to be added to mainline or the dracut package including the patches could be added (then we could maybe also get rid of the dpkg-divert stuff). I'll take a look at config-package-dev.\n\nThe grub files as well as the dmsquash files are based on the original files for debian. I'll add them.\n\n`activate update-initramfs`\n`activate dracut`\n\nI'm also not sure if adding both would break something. Sure one command would not work. Maybe this would interfere with dpkg or the build script. Tbh I don't know if and when the triggers are run. I couldn't find anything related during the build process at least.\n\n`packages/anon-meta-packages/debian/control`\n\nCould maybe stay the same though we need to ensure that dracut + patches gets installed after this package has been installed so initramfs-tools get removed.\n\n`packages/whonixcheck/etc/apparmor.d/usr.bin.whonixcheck what does it do? Any reason for not having that in the mainline non-live?`\n\nI don't think there is a reason against it, the flag is required for apparmor to not break on overlayfs systems. There are likely more profiles where this flag is missing.\n\n`Device mapper vs overlayfs`\n\nDevice mapper \n\npro: no changes needed for apparmor profiles, and other MAC\ncon: when you add files you won't get the RAM back when you delete them (except you reboot of course). Not sure how likely this is though.\n\nOverlayfs: you get your memory back if you delete something but you have to change the profiles for apparmor. \nIn most cases I encountered using an alias and using the attach_disconnected flag was enough, but there seems to be more in case of the Whonix profiles. \nI'm in slight favor for device mapper at the moment as the default boot option.\n\nGenerally speaking, I'm not 100% sure if we want to make live mode a build option. If we use it as default Whonix should still work as normal with installing new packages, configuring stuff ..., just like with the normal initramfs that Whonix currently uses. Additionally, you have new boot options if you want some kind of amnesia/non-persistence/throw-away/disposable vm.\nSo at some point Whonix could just make new download images available with dracut by default and for upgrading there needs to be some extra-package. I'll take a closer look at such a package.\n\n"},{"author":"Patrick","date_created":1509718238,"date_modified":1509718238,"content":">>! In T714#14714, @Algernon wrote:\n> The patch was not meant to be integrated already in the official Whonix source. More like: $interested_person can get an idea how a 14.0.0.5.2 live image would build and look in the end.\n\nI see.\n\n(I personally didn't build it. Not sure I would even build it. Perhaps I would just build and upload whonix.org officially redistributed testers-only, RC and stable releases, but leave all the testing and maintenance to you.)\n\n> For the \n> \n>> if/else\n> \n> I'm not 100% sure how it should work. As build option or as boot option or both?\n\nI find both good to have. It's up to what you would like to maintain.\n\n> I think a dedicated build option like \"--live\" should be possible and depending on this using the different config files like `grml_packages_live`\n\nYes, looks very possible. It's amazing how few changes to the current Whonix source code is required.\n\n> The swap file changes already have some kind of if/else option but more for booting and not for building. I.e. it is tested if the system was booted live and if it was it skips creation of the file and if it boots normally it will just do what it always has done.\n\nYes, for booting only should be alright.\n\nThe following should be if/else. \n\n```\n+[ -n \"$SHRED_OPTS\" ] || SHRED_OPTS=\"--verbose --iterations=1 --remove\"\n```\n\n```\n-#SHRED_ON_STOP=\"yes\"\n+SHRED_ON_STOP=\"yes\"\n```\n\n\n> \n> The dracut live patches are still required, the version which the patches use is currently in testing. So either the patches have to be added to mainline or the dracut package including the patches could be added (then we could maybe also get rid of the dpkg-divert stuff). I'll take a look at config-package-dev.\n\nAlright.\n\n> The grub files as well as the dmsquash files are based on the original files for debian. I'll add them.\n> \n> `activate update-initramfs`\n> `activate dracut`\n> \n> I'm also not sure if adding both would break something. Sure one command would not work. Maybe this would interfere with dpkg or the build script. Tbh I don't know if and when the triggers are run. I couldn't find anything related during the build process at least.\n\nLooked around in `/var/lib/dpkg/info` for `.triggers` files. Testwise uninstalled `initramfs-tools`. Removed and reinstalled `ntfs-3g` which uses `activate initramfs`. No issue. Tried whonix-ws-network-config package reinstallation with `activate dracut`. No issue. Probably won't break the build. Probably safe. Please try.\n\n> `packages/anon-meta-packages/debian/control`\n> \n> Could maybe stay the same though we need to ensure that dracut + patches gets installed after this package has been installed so initramfs-tools get removed.\n\nProblem is, initramfs-tools conflict with dracut as per their debian/control file. Meaning installation of dracut will result in uninstallation of initramfs-tools. Therefore, installing dracut results in uninstallation of non-qubes-vm-enhancements which results in uninstallation of non-qubes-whonix-gateway / non-qubes-whonix-workstation on current Whonix installations.\n\nsudo apt-get install dracut currently creates a mess, it is related to https://www.whonix.org/wiki/Whonix_Debian_Packages. So initramfs-tools should not be part of non-qubes-vm-enhancements anyhow.\n\n> `packages/whonixcheck/etc/apparmor.d/usr.bin.whonixcheck what does it do? Any reason for not having that in the mainline non-live?`\n> \n> I don't think there is a reason against it, the flag is required for apparmor to not break on overlayfs systems. There are likely more profiles where this flag is missing.\n\nAlright, so please send pull requests for mainline non-live so we fix the apparmor bugs in any case (device mapper vs overlyfs does not matter - if we have a bug - we fix it).\n\n> `Device mapper vs overlayfs`\n> \n> Device mapper \n> \n> pro: no changes needed for apparmor profiles, and other MAC\n> con: when you add files you won't get the RAM back when you delete them (except you reboot of course). Not sure how likely this is though.\n> \n> Overlayfs: you get your memory back if you delete something but you have to change the profiles for apparmor. \n> In most cases I encountered using an alias and using the attach_disconnected flag was enough, but there seems to be more in case of the Whonix profiles. \n> I'm in slight favor for device mapper at the moment as the default boot option.\n\nAlright. Default sounds good.\n\n> Generally speaking, I'm not 100% sure if we want to make live mode a build option. If we use it as default Whonix should still work as normal with installing new packages, configuring stuff ..., just like with the normal initramfs that Whonix currently uses. Additionally, you have new boot options if you want some kind of amnesia/non-persistence/throw-away/disposable vm.\n> So at some point Whonix could just make new download images available with dracut by default and for upgrading there needs to be some extra-package. I'll take a closer look at such a package.\n\nI am open to changing Whonix upgraded builds as well as new Whonix builds from initramfs-tools to dracut.\n\nIt would probably only require changing non-qubes-vm-enhancements dependency from initramfs-tools to dracut. Then on upgrade to Whonix 14, apt-get/dpkg would sort out the migration automatically. (uninstall initramfs-tools first since dracut conficts with it, then install dracut)\n\ninitramfs-tools was chosen without too much regard. I didn't follow initramfs-tools vs dracut. It looks pretty much like a drop-in replacement that does not cause any issues? Please open a new Whonix development forum topic suggesting to migrate Whonix by default from initramfs-tools to dracut. Unless there are any strong arguments against it (breaking VirtualBox guest additions or KVM something or so), I don't see why not."},{"author":"Algernon","date_created":1510153303,"date_modified":1510153384,"content":"I'm currently trying to add a custom dracut build to the whonix temporary repository.\nI cloned the dracut repository at https://anonscm.debian.org/gitweb/?p=collab-maint/dracut.git and added the changes we need for the live systems.\nThen added the folder to the packages directory of the whonix source, renamed it to dracut-whonix and also changed the control file so that packages with the name dracut-whonix-* are created.\nIn 1200_create-debian-packages I added:\n\nif [ \"$base_name\" = \"dracut-whonix\" ]; then\ndebuild -b -us -uc\npopd\ncontinue\nfi\n\nto the loop in the create_whonix_debian_packages function\n\nand started a test build. The package itself builds fine but it does not end up in the local apt repo in the whonix_binary folder and hence also not in the final filesystem image.\nIn contrast to the other packages the Makefile is different to what whonix expects, additionally some commands are missing like reprepo-add etc, but I guess they wont work anyways. \nIs there an easy way to add the package to the repo or has the structure of the package to be adapted so it looks like the other whonix packages?"},{"author":"Patrick","date_created":1510158279,"date_modified":1510158279,"content":">>! In T714#14763, @Algernon wrote:\n> I'm currently trying to add a custom dracut build to the whonix temporary repository.\n> I cloned the dracut repository at https://anonscm.debian.org/gitweb/?p=collab-maint/dracut.git and added the changes we need for the live systems.\n> Then added the folder to the packages directory of the whonix source, renamed it to dracut-whonix and also changed the control file so that packages with the name dracut-whonix-* are created.\n\nThat could be a problem. When users try to install dracut while dracut-whonix is installed, dpkg will break since the same file may not be owned by two packages at once. So dracut-whonix would need `Conflicts: dracut` and probably also `Provides: dracut`. I hope we can avoid forking the whole package and just config-package-dev replace a few files where changes are needed.\n\n> added the changes we need for the live systems\n\nWhat's the diff?\n\n> In 1200_create-debian-packages I added:\n> \n> if [ \"$base_name\" = \"dracut-whonix\" ]; then\n> debuild -b -us -uc\n> popd\n> continue\n> fi\n> \n> to the loop in the create_whonix_debian_packages function\n> \n> and started a test build. The package itself builds fine but it does not end up in the local apt repo in the whonix_binary folder and hence also not in the final filesystem image.\n> In contrast to the other packages the Makefile is different to what whonix expects, additionally some commands are missing like reprepo-add etc, but I guess they wont work anyways. \n\nThe build script is also running...\n\n    sudo $SUDO_OPTS make -f \"$make_file\" reprepro-add\n\nOr somehow do what reprepro-add of the makefile does integrated into 1200_create-debian-packages, i.e. the reprepro-add command.\n\n    sudo $SUDO_OPTS \"$whonix_dev_meta_files_folder/debug-steps/reprepro-wrapper\" includedeb \"$WHONIX_BUILD_APT_CODENAME\" \"$package_absolute_path\"\n\n> Is there an easy way to add the package to the repo or has the structure of the package to be adapted so it looks like the other whonix packages?\n\nThis hasn't been designed yet."},{"author":"Algernon","date_created":1510432957,"date_modified":1510432957,"content":"I switched to config-package-dev instead of forking so no worries.\nNext I'm going to try an update from Whonix 13 to 14 and see if something breaks.\nI guess the official Whonix repo will be used when users would upgrade to the live version.\nFrom looking at the aptrepo_local which gets created during building it seems to be more or less the same as the online repo? So I could use the local repo for the update tests or is there anything else to look out for?"},{"author":"Patrick","date_created":1510437330,"date_modified":1510437330,"content":"Algernon (Algernon):\n> Algernon added a comment.\n> \n> \n>   I switched to config-package-dev instead of forking so no worries.\n>   Next I'm going to try an update from Whonix 13 to 14 and see if something breaks.\n\nAlright.\n\n>   I guess the official Whonix repo will be used when users would upgrade to the live version.\n\nYes.\n\n>   From looking at the aptrepo_local which gets created during building it seems to be more or less the same as the online repo?\n\nYes.\n\n(Just that the aptrepo_remote is versioned for stable,\nstable-proposed-updates, testers and developers, but none of this\nmatters for the sake of this ticket.)\n\n> So I could use the local repo for the update tests or is there anything else to look out for?\n\nYes.\n\n( There are even some developer scripts:\n\n-\nhttps://github.com/Whonix/whonix-developer-meta-files/blob/master/debug-steps/locally-upgrade-whonix-debian-packages\n-\nhttps://github.com/Whonix/whonix-developer-meta-files/blob/master/debug-steps/qubes-repo-temp\n\nBut maybe these could be even simpler.\n\n)\n\nPerhaps try `/etc/apt/sources.list.d/whonix_local.list`?\n\n    deb [trusted=yes] file:/home/user/whonix_binary/aptrepo_local local main"},{"author":"Algernon","date_created":1510598753,"date_modified":1510598753,"content":"Just figured out Whonix 13 is still i386 and I only tested builds for amd64 up to now. Therefore I also couldn't make any tests upgrading from 13 to 14.\nBut I was wondering if upgrading Whonix 13 will be supported or work  at all.\nReading this : \nhttps://phabricator.whonix.org/T688#13700\nhttps://www.whonix.org/wiki/Upgrading_Whonix_13_to_Whonix_14\nhttps://forums.whonix.org/t/state-of-offical-64-bit-builds/399/16\n\nthe answer looks like \"maybe\".\nHas there been any final decision or tests?"},{"author":"Patrick","date_created":1510602823,"date_modified":1510602823,"content":"As it looks now, it will be easily possible to upgrade Whonix 13 i386 to\nWhonix 14 i386. New Whonix 14 builds will be amd64. Looks pretty final.\nI don't think it will change for Whonix 14. (That is for\nNon-Qubes-Whonix.) (For Qubes-Whonix none of this matters, it always has\nbeen amd64.)"},{"author":"Algernon","date_created":1511203609,"date_modified":1511206239,"content":"{F1925452}\n\nAttached is the more or less final patch with only minor changes mostly related to apparmor profiles.\nThe bindp package was also missing for i386, this is required when upgrading from 13 to 14 and reinstalling non-qubes-whonix-workstation. Therefore the architecture in the control file was changed from \"any\" to \"all. I'll add the new instructions to the wiki and submit a pull request.\nA minor issue might be the swap file creator. At the moment it runs at each boot, creates a new swap file and shreds it at shutdown. This takes of course some seconds more. The other option would be to keep the old swap-file-generator but this will always occupy 512MB RAM more when you boot the live system which could be spend for more useful things. Both cases are not optimal but I don't see any other options.\n\nSome other observations:\nIn case of the upgrade from 13 to 14 there is also a problem with virtualbox guest additions which don't get installed. I guess it is due to missing backports from the sources.list. Also the background changes to the (not so shiny) debian default and the desktop icons are missing on the desktop. When I go to /home/user/Desktop the icons are present, however. The same thing happens with a Whonix 14 build, even without dracut + patches iirc."},{"author":"Patrick","date_created":1511285761,"date_modified":1511285761,"content":">>! In T714#14789, @Algernon wrote:\n> {F1925452}\n> \n> Attached is the more or less final patch with only minor changes mostly related to apparmor profiles.\n\nIt's hard to follow any changes with the patches style. Cannot really review this fully in that format.\n\nCould you please merge the non-controversial stuff little by little i.e. creating pull requests for the changes in the apparmor profiles or \"swap-file-creator behaves differently in live mode\"?\n\n> The bindp package was also missing for i386, this is required when upgrading from 13 to 14 and reinstalling non-qubes-whonix-workstation. Therefore the architecture in the control file was changed from \"any\" to \"all. I'll add the new instructions to the wiki and submit a pull request.\n\nIndeed... https://github.com/Whonix/bindp/commit/d7052e58d57b2d8a5f54dab2e6da836d3fb61ce8\n\nbindp is now (with a hack) an architecture independent package. This was done in T688. But the updated package hasn't been uploaded yet.\n\n> Some other observations:\n> In case of the upgrade from 13 to 14 there is also a problem with virtualbox guest additions which don't get installed. I guess it is due to missing backports from the sources.list.\n\nVirtualBox guest additions will be downloaded from stretch-backports and uploaded to Whonix repository. This is done in build scripts but not uploaded to Whonix repository.\n\n- https://github.com/Whonix/Whonix/blob/master/build_sources/debian_stable_current_clearnet.list\n- https://github.com/Whonix/Whonix/blob/master/build-steps.d/1200_create-debian-packages\n\n> I'll add the new instructions to the wiki and submit a pull request.\n\nEnabling `deb http://ftp.us.debian.org/debian testing main contrib non-free` is a bad idea. In any case please use specific code names (such as stretch, buster) rather than generic ones (such as stable, testing). We shouldn't use this anyhow (elaborated below). Please remove from the wiki.\n\nUsing apt pinning by Whonix default is a big no.\n\n* https://www.whonix.org/wiki/Dev/APT_Pinning\n* these are tricky and risky\n * our electrum instructions using apt-pinning broke apt-get for all who followed these instructions\n\ndracut\n\n* Moving all of Whonix 14 (stretch based) to dracut (stretch version) for Whonix 14 is alright as per https://forums.whonix.org/t/replacing-initramfs-tools-with-dracut-for-live-systems.\n* However, mixing stretch with buster is too risky for Whonix 14 official download version. It's dependencies are too complex so this could break the apt-get dependency resolution in hard to fix ways. If there was a stretch-backport of dracut, that would be alright.\n* Sorry if I miscommunicated this earlier!\n\nWe can and should still merge everything else.\n\nFor Whonix buster based version we could then make live boot work by default or at least more easily without mixing with testing / apt-pinning.\n\nWondering, isn't this `optimal live-mode boot` better implemented as a generic (Whonix independent) package? One that could be merged into dracut upstream and then just apt-get pulled by Whonix?"},{"author":"Algernon","date_created":1512066711,"date_modified":1512066711,"content":"I changed the patches so the dracut version from stretch is now used and therefore no apt pinning and changes to the sources.list is required.\nIt also seems like the stretch version, in contrast to same version from upstream, can use overlayfs since the debian package maintainer added some (undocumented) parameters.\nAppending \"rootovl\" to the kernel commandline and using root=UUID=...  (so without the \"live:\") will mount an overlayfs filesystem over / . So not too much loss compared to the version in testing.\n\nAll changes can now be found here:\nhttps://github.com/Whonix/Whonix/commit/f30b5dba1513d96be4d33febffc813a293b2309b\n\nI'm still trying to accommodate myself to git so at the moment a pull request for the main repo including the relevant submodules is not possible. \nTheoretically this one : https://github.com/Whonix/Whonix/compare/master...Algernon-01:master\nis mergeable but it is lacking some submodules and some others have missing commits. I probably forgot some important command somewhere ..., or should have started from the master branch ... (testing was done on the 14.0.0.5.2 tag)\n\nAnyways, I can open pull requests for the submodules. For the main repo maybe it is possible to pull and git hopefully won't complain or maybe copy the files manually. Otherwise I'll have to take a look at this again."},{"author":"Patrick","date_created":1512081326,"date_modified":1512081326,"content":"For reference:\n\nhttps://github.com/Whonix/whonix-developer-meta-files/pull/1\nhttps://github.com/Whonix/anon-meta-packages/pull/6\nhttps://github.com/Whonix/whonixcheck/pull/7\nhttps://github.com/Whonix/apparmor-profile-gwenview/pull/1\nhttps://github.com/Whonix/whonix-ws-network-conf/pull/1\nhttps://github.com/Whonix/whonix-gw-network-conf/pull/1\nhttps://github.com/Whonix/sdwdate/pull/20\nhttps://github.com/Whonix/apparmor-profile-xchat/pull/1\nhttps://github.com/Whonix/apparmor-profile-virtualbox/pull/1\nhttps://github.com/Whonix/apparmor-profile-torbrowser/pull/2\nhttps://github.com/Whonix/apparmor-profile-okular/pull/1\nhttps://github.com/Whonix/Whonix/pull/414\n\nAll non-controversial stuff (apparmor) already merged.\n\n-----\n\nRegarding https://github.com/Whonix/swap-file-creator/pull/1/files#diff-6c1d39efd028d1720802ce91a56e03a1R90 could you please simplify\n\n```\nif [ -z \"$(cat /proc/cmdline | grep \"root=live:\")\" ]; then\n do_start\nelse\necho \"Live mode detected. Swap file creation skipped. \"\nexit 0\nfi\n```\n\nto\n\n```\nif cat /proc/cmdline | grep \"root=live:\" ; then\n   echo \"Live mode detected. Swap file creation skipped.\"\n   exit 0\nfi\n\ndo_start\n```\n\nDoes that work?\n\n-----\n\n> https://github.com/Whonix/swap-file-creator/pull/1/files#diff-69a86e5b8d5258247d8379d3c3006ccfR28\n\nWhy do you set `SHRED_ON_STOP=\"yes\"` unconditionally for non-live Whonix?\n\nIs that an unrelated suggestion / fix?\n\n> https://github.com/Whonix/swap-file-creator/pull/1/files#diff-6e34858265bdddadd0e03eac60ab58f0R100\n\nWhy do you add `--remove` to `SHRED_OPTS`?\n\nIs that an unrelated suggestion / fix?\n\n-----\n\nhttps://github.com/Whonix/Whonix/pull/414 is wrong. packages/dracut-live-patches must not be a pull request against Whonix/Whonix. dracut-live-patches has to go into its own git repository, ideally https://github.com/Algernon-01/dracut-live-patches. You could do that by creating a github repository `dracut-live-patches`.\n\n> https://github.com/Algernon-01/Whonix/blob/09e18cd48b0c5f069f028c6c59db466b13ecf5c5/packages/dracut-live-patches/debian/dracut-live-patches.postinst#L62\n\nWhy is `dracut /boot/initrd.img-$i $i` required? Shouldn't the dracut package by Debian already do that?\n\n> https://github.com/Algernon-01/Whonix/blob/09e18cd48b0c5f069f028c6c59db466b13ecf5c5/packages/dracut-live-patches/debian/dracut-live-patches.postinst#L73\n\nSame for `update-grub`.\n\n-----\n\n`packages/dracut-live-patches/debian/dracut-live-patches.preinst` does nothing so can and should be safely removed.\n\n> https://github.com/Whonix/Whonix/pull/414/files#diff-03db39ec0efb2a7676d8fb370a47a075R14\n\nSince you have no man pages, this can be removed:\n\n```\n+override_dh_install:\n+\tmake manpages\n+\tdh_installman $(CURDIR)/debian/tmp-man/*\n```\n\n-----\n\n> `packages/dracut-live-patches/etc/apparmor.d/tunables/alias.anondist`\n\nI doubt a  `.anondist` file / config-package-dev is needed here. And should be avoided at all cost if possible.\n\nI guess a file `dracut-live-patches/etc/apparmor.d/tunables/dracut-live-patches` with the same contents would do?\n\n-----\n\n> `packages/dracut-live-patches/etc/apparmor.d/tunables/home.d/whonix`\n\nA generic package `dracut-live-patches` shouldn't have a file named `whonix`, since not a Whonix specific package.\n\n\n-----\n\n`packages/dracut-live-patches/man/dracut_live_patches.8.ronn` should be deleted - if there is no user facing tool started from the command line, we don't need a man page, right?\n\n-----\n\nThese files contain a lot code:\n\n* dracut-live-patches/etc/grub.d/11_linux_live\n* dracut-live-patches/usr/lib/dracut/modules.d/90dmsquash-live/dmsquash-live-root.sh.anondist \n* dracut-live-patches/usr/lib/dracut/modules.d/90dmsquash-live/module-setup.sh.anondist\n\nI don't understand that code very well. Would take me a long time to learn. Cannot simply merge on a \"non-malicious just works\" basis since that could lead to a lot pressure and headache later when it breaks.\n\ninitramfs currently is something that \"Debian does\", \"that just works\", \"that is used by very many people and unlikely to break\". So that requires very little thought, maintenance and time from me.\n\nThe suggested code by you is complex so I try to figure out if my time to learn it is well justified and the-clean-way(tm) to do things.\n\nCorrect me if I am wrong, but I understand, the majority of the file has been written by third parties. (Indicated by the copyright of the file.)\n\nWhat's the original source of dracut-live-patches/etc/grub.d/11_linux_live so I can see the diff? I couldn't find it.\n\nLooking at the diff for the two dracut modified files... Using the dracut version from stretch...\n\n    diff /usr/lib/dracut/modules.d/90dmsquash-live/dmsquash-live-root.sh yours\n \n```\n31c31\n< [ -z \"$overlay_size\" ] && overlay_size=512\n---\n> [ -z \"$overlay_size\" ] && overlay_size=32768\n266a267,271\n>     else\n>       BASE_LOOPDEV=$( losetup -f )\n>       umount /run/initramfs/live\n>       losetup -r $BASE_LOOPDEV $livedev\n>         do_live_from_base_loop\n290a296\n> \n```\n\n`[ -z \"$overlay_size\" ]` indicates, that this can be configured somewhere. Please:\n\n* try to find out the configuration file (so we can just ship a config snippet rather than config-package-dev divert the whole script\n* ask upstream if you are unable to find it\n* if there is no config file, please submit a patch to upstream to make that configureable\n* only as very last resort, if upstream refuses to cooperate we consider to fork this file and carry a patch\n\nThe part after the `else` looks strange. The intend style confused me. Please fix intend style. I guess you meant like this?\n\n```\nif [ -n \"$FSIMG\" ] ; then\n...\nelse\n    BASE_LOOPDEV=$( losetup -f )\n    umount /run/initramfs/live\n    losetup -r $BASE_LOOPDEV $livedev\n    do_live_from_base_loop\nfi\n```\n\nSame as above. Please work with upstream dracut to get this merged.\n\n\n    diff /usr/lib/dracut/modules.d/90dmsquash-live/module-setup.sh new \n\n```\n20c20\n<     instmods squashfs loop iso9660\n---\n>     instmods squashfs loop iso9660 overlay\n25c25\n<     inst_multiple umount dmsetup blkid dd losetup grep blockdev find\n---\n>     inst_multiple umount dmsetup blkid dd losetup grep blockdev find df tail\n39a40\n>\n```\n\nI don't understand the diff.\n\nSame. Could you work with upstream please to make this the default or easily configurable? (The ideal configurability would be a `.d` drop-in folder for config files.)"},{"author":"Algernon","date_created":1512171569,"date_modified":1512171569,"content":"As stated here: https://forums.whonix.org/t/replacing-initramfs-tools-with-dracut-for-live-systems/4487\nthere is still option 5 if you feel uncomfortable with dracut in general. \nA \"normal\" live system with overlayfs should be possible without patches. We would mostly need to pull in some debian live packages.\nCopying the whole filesystem to RAM would not work without patches. Of course there is no possibility to use device mapper though maybe most end users won't care about that.\nSome minor edits to the grub config file and apparmor stuff would be required."},{"author":"Patrick","date_created":1512242273,"date_modified":1512242273,"content":">>! In T714#14808, @Algernon wrote:\n> As stated here: https://forums.whonix.org/t/replacing-initramfs-tools-with-dracut-for-live-systems/4487\n> there is still option 5 if you feel uncomfortable with dracut in general. \n\nMight be better.\n\n> A \"normal\" live system with overlayfs should be possible without patches. We would mostly need to pull in some debian live packages.\n\nWhich ones?\n\n> Copying the whole filesystem to RAM would not work without patches. Of course there is no possibility to use device mapper though maybe most end users won't care about that.\n> Some minor edits to the grub config file and apparmor stuff would be required.\n\nSounds good."},{"author":"Algernon","date_created":1512334214,"date_modified":1512334214,"content":"Packages would be: live-boot, live-config-systemd, live-config-initramfs-tools, live-tools.\nI'm wondering if then there really needs to be an extra package for the other files. Currently only the apparmor config for the new home and alias as well as the grub config file would be in there. I think the apparmor related edits could also be merged with the files in the apparmor-profile-anondist. There are some packages for grub but they all have a quite specific name. So either make a dedicated grub-live package or make the live patch package as before or merge the grub config file somewhere else."},{"author":"Patrick","date_created":1512376560,"date_modified":1512376560,"content":"Algernon (Algernon):> Packages would be: live-boot, live-config-systemd,\n> live-config-initramfs-tools, live-tools.\n\nMost of them don't seem to interact with the normal boot process, right?\n\nHowever, live-tools `dpkg-divert`'s /usr/sbin/update-initramfs with\n/bin/live-update-initramfs.\n\n`man update-initramfs` shows `live-update-initramfs` man page.\n`live-update-initramfs`. Will that interfere with normal boot?\n\n> I'm wondering if then there\n> really needs to be an extra package for the other files. Currently\n> only the apparmor config for the new home and alias as well as the\n> grub config file would be in there. I think the apparmor related\n> edits could also be merged with the files in the\n> apparmor-profile-anondist.\n\nI think apparmor-profile-anondist is not the best place - since this is\nnot an anonymity related configuration.\n\n> So either make a dedicated grub-live\n> package or make the live patch package as before or merge the grub\n> config file somewhere else.\n\nThink about it that way: how would the package be called if it were\nready to be uploaded to / downloaded from packages.debian.org?\n\nPerhaps a grub-live package with all changes for apparmor and grub live?\n\nCan the apparmor changes be contributed upstream?\n\nIs the functionalist you are inventing here known to the Debian live\nproject as a missing feature / feature request? Could you contact them\nplease? Could you try to contribute that missing feature upstream please?"},{"author":"Algernon","date_created":1512420756,"date_modified":1512420897,"content":"> Most of them don't seem to interact with the normal boot process, right?\n\nNone of them does anything unless you write \"boot=live\" on the kernel command line. \n\n> Will that interfere with normal boot?\n\nNo, normal boot boots as always. Same with updating initramfs. The live-update-initramfs script calls the original command anyways during building.\n\n>Can the apparmor changes be contributed upstream?\n\nMaybe, but there is probably a reason they are not already there or they will be there soon(`TM`) since Tails needs the same changes once they go from aufs to overlayfs (\nhttps://labs.riseup.net/code/issues/9045 ) and they are usually quite fond of merging stuff upstream. Also intrigeri recently made a proposal to make apparmor enabled by default on debian and hence the package maintainers also have to integrate/test profiles.\n\n\n>Is the functionalist you are inventing here known to the Debian live\n>project as a missing feature / feature request?\n\nNot really, since I'm using only the stuff already integrated into Debian and not inventing anything new.\n\n"},{"author":"Algernon","date_created":1512777551,"date_modified":1512777551,"content":"Changes for initramfs-tools based live system:\n\nhttps://github.com/Whonix/anon-meta-packages/pull/7\nhttps://github.com/Whonix/swap-file-creator/pull/2\n\ngrub-live is modified version of the default Debian version /etc/grub/10_linux\nThe apparmor profile is the default Debian version + the attach_disconnected flag\n\nhttps://github.com/Algernon-01/grub-live\nhttps://github.com/Algernon-01/apparmor-profile-thunderbird"},{"author":"Patrick","date_created":1512854363,"date_modified":1512854363,"content":">>! In T714#14861, @Algernon wrote:\n> Changes for initramfs-tools based live system:\n> \n> https://github.com/Whonix/anon-meta-packages/pull/7\n\n> https://github.com/Whonix/swap-file-creator/pull/2\n\nMerged.\n\n> grub-live is modified version of the default Debian version /etc/grub/10_linux\n> The apparmor profile is the default Debian version + the attach_disconnected flag\n> \n> https://github.com/Algernon-01/grub-live\n\nForked to my personal github account name.\n\nhttps://github.com/adrelanos/grub-live\n\nAnd made the diff visible.\n\nhttps://github.com/adrelanos/grub-live/commit/733a5cc3512d6061542f28343cb431c508ea2cda\n\nLook reasonable, small, maintainable. If it breaks, and you vanish (no offense), and if I wouldn't know how to fix it, I could just remove the file for the next major release of Debian.\n\nMaintenance effort: `diff` `/etc/grub.d/10_linux` `/etc/grub.d/11_linux_live` at every major Debian release upgrade and rebase.\n\nDo you think you could add this feature by submitting a patch to upstream `/etc/grub.d/10_linux`, so this could be enabled from a single line, a setting in `/etc/default/grub.d/*.cfg` (configuration snippet)?\n\n-----\n\nhttps://github.com/Algernon-01/grub-live/blob/master/debian/control#L20 - Why `Do not remove.`? That's quite definitive. After discussing this, please elaborate or remove it.\n\n> https://github.com/Algernon-01/apparmor-profile-thunderbird\n\nPlease submit a bug report and/or patch to upstream. (Debian and/or Thunderbird - depending on who invented the apparmor profile.)\n\nNo new package please, because we have https://github.com/Whonix/apparmor-profile-icedove. The package hasn't been renamed yet because that is some work for little benefit but the package is supposed to make the thunderbird apparmor profile compatible with Non-Qubes-Whonix and Qubes-Whonix.\n\nI was happy that in Whonix 14 we only need to drop a snipped `/etc/apparmor.d/local/usr.bin.thunderbird` and no longer need to modify `/etc/apparmor.d/usr.bin.thunderbird` but for live mode looks like a config-package-dev diversion cannot be prevented."},{"author":"Patrick","date_created":1512855586,"date_modified":1512855586,"content":"Should `boot=live union=overlay plainroot` be injected at line https://github.com/adrelanos/grub-live/blob/master/etc/grub.d/11_linux_live#L353 as well?"},{"author":"Patrick","date_created":1512858350,"date_modified":1512858350,"content":"`/etc/grub.d/11_linux_live` is still a lot code duplication.\n\nCouldn't `/etc/grub.d/11_linux_live` just call `/etc/grub.d/10_linux`?\n\n-----\n\n`/etc/grub.d/11_linux_live` would just do a few things in this order:\n\n* inject `boot=live union=overlay plainroot` into `${GRUB_CMDLINE_LINUX}`\n\n```\nGRUB_CMDLINE_LINUX=\"$GRUB_CMDLINE_LINUX boot=live union=overlay plainroot\"\n```\n\n-----\n\n* inject `Live-mode` into `GRUB_DISTRIBUTOR`\n\n```\nGRUB_DISTRIBUTOR=\"${GRUB_DISTRIBUTOR} Live-mode\"\n```\n\n(This results in variable `OS` being set to `Live -mode GNU/Linux`.)\n\n-----\n\n* influence variable `LINUX_ROOT_DEVICE`\n\nThis is the only thing I couldn't think of. [1]\n\n-----\n\n* check if `/etc/grub.d/10_linux` is executable\n* run `/etc/grub.d/10_linux`\n\n```\nif test -x /etc/grub.d/10_linux ; then\n    /etc/grub.d/10_linux\nfi\n```\n\n-----\n\n[1]  You changed from\n\n`LINUX_ROOT_DEVICE=UUID=${GRUB_DEVICE_UUID}`\n\nto\n\n`LINUX_ROOT_DEVICE=/dev/disk/by-uuid/${GRUB_DEVICE_UUID}`.\n\nIs this absolutely required?\n\nThe default  (Which is what? Which is `LINUX_ROOT_DEVICE=UUID=xxx-uid-here-xxx`?) won't work?\n\nIsn't the kernel clever enough to know `UUID=${GRUB_DEVICE_UUID}` means `/dev/disk/by-uuid/${GRUB_DEVICE_UUID}`?\n\nIf that's the only missing thing, could you please post a feature request against upstream `/etc/grub.d/10_linux`?"},{"author":"Algernon","date_created":1512939771,"date_modified":1512939771,"content":"Made the file somewhat smaller:\nhttps://github.com/Algernon-01/grub-live/commit/c8f8a24dbac305cdbbff0d2d53d14b699cc4a2b4"},{"author":"Patrick","date_created":1513000622,"date_modified":1513000622,"content":"Perfect!"},{"author":"Patrick","date_created":1513010416,"date_modified":1513010416,"content":">>! In T714#14865, @Algernon wrote:\n> Made the file somewhat smaller:\n> https://github.com/Algernon-01/grub-live/commit/c8f8a24dbac305cdbbff0d2d53d14b699cc4a2b4\n\nI compared `### BEGIN /etc/grub.d/10_linux ###` with `### BEGIN /etc/grub.d/11_linux_live ###`.\n\n> #! /bin/sh\n> set -e\n> \n> GRUB_DEVICE=\"/dev/disk/by-uuid/${GRUB_DEVICE_UUID}\"\n> unset GRUB_DEVICE_UUID\n\nFunctional, using disk by uuid.\n\n> GRUB_CMDLINE_LINUX=\"$GRUB_CMDLINE_LINUX boot=live plainroot union=overlay\"\n\nBroken, no command line options added.\n\n> GRUB_DISTRIBUTOR=\"${GRUB_DISTRIBUTOR} Live-mode\"\n\nBroken, not included.\n\n> if test -x /etc/grub.d/10_linux ; then\n> /etc/grub.d/10_linux\n> fi\n> \n\nFunctional. New grub menu entry (`### BEGIN /etc/grub.d/10_linux ###`) gets added.\n\n"},{"author":"Patrick","date_created":1513010963,"date_modified":1513010963,"content":"Fixed.\n\nhttps://github.com/adrelanos/grub-live/commit/e108ad3af55fc193dd854f8c948b20630716b37f"},{"author":"Algernon","date_created":1513035278,"date_modified":1513035278,"content":"Hmm, odd it did not work for you. I tested it with the whonix build script and also the upgrade from 13 to 14 with the local packages repo. Both produced the correct GRUB menu with all options.\nWhat did you do, just copying 11_linux to /etc/grub.d/ and running update-grub I guess?"},{"author":"Patrick","date_created":1513088514,"date_modified":1513088514,"content":"Test wise installed the package.\n\nIt didn't work because I was testing it in a Debian TemplateBased AppVM\non Qubes, which didn't have /etc/default/grub. Which results in:\n- the variables you are trying to modify not being set\n- therefore grub-mkconfig cannot export them\n- therefore when /etc/grub.d/11_linux_live modifies them, it will stay\nlocal to the script, these are lost when it calls /etc/grub.d/10_linux\n- the solution to make it work without existing /etc/default/grub (or\nwithout these variables set) was to unconditionally export the variables.\nNot a big deal."},{"author":"Patrick","date_created":1513369582,"date_modified":1513369582,"content":"Added to https://github.com/Whonix/Whonix/tree/master/packages, build, and uploaded to Whonix (14) developers repository.\n\nWould you mind if we don't install grub-live by default in Whonix 14, and you encourage some people to install and test?"},{"author":"Algernon","date_created":1513512708,"date_modified":1513512708,"content":"Sure, I'll add instructions for the installation and some general remarks around live mode to the Whonix live wiki entry."},{"author":"Algernon","date_created":1515267305,"date_modified":1515267305,"content":"ip=frommedia needs to be added to the kernel command line otherwise the network interfaces won't be configured in live mode. I uploaded the changes to the repo."},{"author":"Patrick","date_created":1515326384,"date_modified":1515326384,"content":"Merged."},{"author":"Patrick","date_created":1515509018,"date_modified":1515509018,"content":"What would be useful is some sort of indication on the desktop that system is running in live mode vs persistent mode.\n\nThis is to inform the user about the mode and not having confused the wrong startup option and believing to have booted another boot option. Would be bad if someone thought it is persistent, but accidentally chosen live and then loosing data. Or chosen persistent but wanting to choose live and then persisting data not wanting to persist."},{"author":"Algernon","date_created":1515765045,"date_modified":1515765045,"content":"It will still depend on the user looking out for this indicator. Easiest is probably something like notify-send with a high duration time so a user will see it and click it away. Could be made part of whonixcheck or maybe use whonixcheck itself instead."},{"author":"Algernon","date_created":1531862958,"date_modified":1531862958,"content":"I opened a small pull request for grub-live. Also the alternative version ro-mode-init lives at https://github.com/Algernon-01/ro-mode-init"},{"author":"Patrick","date_created":1533716848,"date_modified":1533716848,"content":">>! In T714#15381, @Algernon wrote:\n> It will still depend on the user looking out for this indicator. Easiest is probably something like notify-send with a high duration time so a user will see it and click it away. Could be made part of whonixcheck or maybe use whonixcheck itself instead.\n\nOne might forget this after a long session.\n\nCreated T819 for it.\n\nThis ticket is fully implemented. Closing."}]},"PHID-TASK-qae5xxkrolqujolbifut":{"id":"713","title":"Mail OTF for Security Audit / Review #2","status":"open","priority":"Normal","author":"Patrick","description":"A follow up task of T62.\n\nOTF is now ready to discuss scoping of the security audit. Once we are ready...\n\ne-mail to:\n\n    chad at opentechfund dot org\n\nOpenPGP\n\n    FAEE 7659 73E0 AAEB DA61 DDA8 1C97 3623 BB9B 4216","comments":[]},"PHID-TASK-wh57jor7a4yitlx7rbbr":{"id":"712","title":"Improve  /usr/share/sdwdate/unit_test","status":"resolved","priority":"Normal","author":"joysn1980","description":"Modify  /usr/share/sdwdate/unit_test\n1) Make it simpler (to split urls into chunks of 3)\n2) Generate average, total etc for each pool\n3) add curl command for the failures (timeouts)\n\nRefer T647 for the o/p expected from unit_test\n","comments":[{"author":"joysn1980","date_created":1504330591,"date_modified":1504330591,"content":"Kindly review\nhttps://github.com/joysn/sdwdate/commit/d6f9492bef7dbdf8bda237c0669de2c0b86b76a7#diff-e68acbfa3dee096d2c84e3cfe6773f30\n\nThe modified onion_tester output looks likes\n\n```\nuser@host:~/sdwdate/usr/share/sdwdate$ ./onion_tester \nCurrent Time Stamp: 1504284400\nStarting remotes check...\nTesting the URL Chunk: \n['secrdrop5wyphb5x.onion', 'zdf4nikyuswdzbt6.onion', '3expgpdnrrzezf7r.onion']\npool 1 url secrdrop5wyphb5x.onion: Time: 1504284405 Difference: 2\npool 1 url zdf4nikyuswdzbt6.onion: Time: 1504284407 Difference: 0\npool 1 url 3expgpdnrrzezf7r.onion: Time: 1504284407 Difference: 0\n:\n:\nTesting the URL Chunk: \n['v6gdwmm7ed4oifvd.onion', 'poulsensqiv6ocq4.onion', 'mprt35sjunnxfa76.onion']\npool 1 url v6gdwmm7ed4oifvd.onion: Time: 1504284812 Difference: 9\npool 1 url poulsensqiv6ocq4.onion: Time: 1504284850 Difference: 1\npool 1 url mprt35sjunnxfa76.onion: Time: 1504284810 Difference: 1\nTesting the URL Chunk: \n['propub3r6espa33w.onion', 'tigas3l7uusztiqu.onion', 'nrktipspgpsyoqwo.onion']\npool 1 url propub3r6espa33w.onion: Time: 1504284858 Difference: 0\npool 1 url tigas3l7uusztiqu.onion: Time: 1504284858 Difference: 0\npool 1 url nrktipspgpsyoqwo.onion: Time: 1504284857 Difference: 1\nTesting the URL Chunk: \n['lijbt6ju7m6opkzb.onion', 'rkphrici4u5ffhhm.onion']\npool 1 url lijbt6ju7m6opkzb.onion: Time: 1504284864 Difference: 1\npool 1 url rkphrici4u5ffhhm.onion: Time: 1504284864 Difference: 1\n##############################\nAvg of Pool :1 having URLs #:32 is 4.53125\n##############################\nTesting the URL Chunk: \n['evz2fbu64s3lzhsi.onion', '754hkfmiyumu5xlc.onion', 'owmx2uvjkmdgsap2.onion']\npool 2 url evz2fbu64s3lzhsi.onion: Time: 1504284871 Difference: 0\npool 2 url 754hkfmiyumu5xlc.onion: Time: 1504284870 Difference: 1\npool 2 url owmx2uvjkmdgsap2.onion: Time: 1504284874 Difference: -3\n:\n:\nTesting the URL Chunk: \n['wooprzddebtxfhnq.onion', 'xogxzfyhwmgfvmlr.onion', 'kbbqa63mo7cchzut.onion']\npool 2 url wooprzddebtxfhnq.onion: Time: 1504285357 Difference: 4\npool 2 url xogxzfyhwmgfvmlr.onion: Time: 1504285361 Difference: 0\npool 2 url kbbqa63mo7cchzut.onion: Time: 1504285359 Difference: 2\nTesting the URL Chunk: \n['ai3dvhjytrgice5h.onion', 'nhzgrlwhukwtajz4.onion', '47hbff4rtpwfpwlr.onion']\npool 2 url ai3dvhjytrgice5h.onion: Time: 1504285366 Difference: 2\npool 2 url nhzgrlwhukwtajz4.onion: Time: 1504285368 Difference: 0\npool 2 url 47hbff4rtpwfpwlr.onion: Time: 1504285366 Difference: 2\nTesting the URL Chunk: \n['pgpkeysximvxiazm.onion']\npool 2 url pgpkeysximvxiazm.onion: Time: 1504285372 Difference: 0\n##############################\nAvg of Pool :2 having URLs #:43 is 4.093023255813954\n##############################\nTesting the URL Chunk: \n['intelexi7yo7mj7j.onion', 'earthqfvaeuv5bla.onion', 'cheettyiapsyciew.onion']\npool 3 url intelexi7yo7mj7j.onion: Time: 1504285380 Difference: 1\npool 3 url earthqfvaeuv5bla.onion: Time: 1504285377 Difference: 4\npool 3 url cheettyiapsyciew.onion: Time: 1504285377 Difference: 4\nTesting the URL Chunk: \n['7tm2lzezyjwtpn2s.onion', 'deepdot35wvmeyd5.onion', '3kyl4i7bfdgwelmf.onion']\npool 3 url 7tm2lzezyjwtpn2s.onion: Time: 1504285382 Difference: 9\npool 3 url deepdot35wvmeyd5.onion: Timeout (Curl --head is OK)\npool 3 url 3kyl4i7bfdgwelmf.onion: Time: 1504285387 Difference: 3\n:\n:\nTesting the URL Chunk: \n['gnvweaoe2xzjqldu.onion', 'ex4gh7cig5ssn2xm.onion', 'ynvs3km32u33agwq.onion']\npool 3 url gnvweaoe2xzjqldu.onion: Time: 1504285826 Difference: 8\npool 3 url ex4gh7cig5ssn2xm.onion: Time: 1504285833 Difference: 1\npool 3 url ynvs3km32u33agwq.onion: Time: 1504285826 Difference: 8\nTesting the URL Chunk: \n['sgvtcaew4bxjd7ln.onion', 'qqvyib4j3fz66nuc.onion', '2qlvvvnhqyda2ahd.onion']\npool 3 url sgvtcaew4bxjd7ln.onion: Time: 1504285844 Difference: 1\npool 3 url qqvyib4j3fz66nuc.onion: Time: 1504285841 Difference: 4\npool 3 url 2qlvvvnhqyda2ahd.onion: Time: 1504285843 Difference: 2\nTesting the URL Chunk: \n['gl3n4wtekbfaubye.onion', 'sejnfjrq6szgca7v.onion', 'lljrzrimek6if67j.onion']\npool 3 url gl3n4wtekbfaubye.onion: Time: 1504285850 Difference: 3\npool 3 url sejnfjrq6szgca7v.onion: Time: 1504285851 Difference: 2\npool 3 url lljrzrimek6if67j.onion: Time: 1504285853 Difference: 0\n##############################\nAvg of Pool :3 having URLs #:132 is 3.1893939393939394\n##############################\n```"},{"author":"Patrick","date_created":1504366089,"date_modified":1504366089,"content":"> add curl command for the failures (timeouts)\n\nThis meant to echo\n\n`curl --head url.onion`\n\nso it can be copied and pasted for manual testing."},{"author":"Patrick","date_created":1555249066,"date_modified":1555249066,"content":"Good enough."}]},"PHID-TASK-nk6n32lhdkedsygtq4e6":{"id":"711","title":"version of enigmail incompatible with thunderbird","status":"resolved","priority":"Needs Triage","author":"whonixuser388","description":"The current version of the enigmail package (1.8.2-4~deb8u1) doesn't work with the current version of thunderbird (52.2.1). I upgraded enigmail to the latest version (1.9.7) and it's working fine.","comments":[{"author":"whonixuser388","date_created":1501634823,"date_modified":1501634823,"content":"The enigmail package has been updated and it's fixed now."}]},"PHID-TASK-espagekcugavsefirmzk":{"id":"710","title":"qubes-whonix build failure","status":"resolved","priority":"High","author":"marmarek","description":"Build of Whonix templates for upcoming Qubes 4.0 fails on downloading torbrowser. And interestingly, this applies also to Qubes 3.2 templates, which previously worked fine. So, probably it isn't related to 3.2/4.0 difference at all.\n\nFull build logs:\n\n    https://travis-ci.org/marmarek/qubes-template-whonix/builds/258845862\n\nSpecific message:\n\n    https://dist.torproject.org/torbrowser could not be reached.\n\n    Possible reasons:\n    - https://dist.torproject.org/torbrowser is down\n    - download location changed\n\n    Please check: Start menu -> System -> Whonix Check\n                  or in Terminal: whonixcheck\n                  or in Terminal with debugging: whonixcheck -v\n\n    If whonixcheck reports no problems with internet activity and downloading Tor Browser keeps failing, please report a bug!\n\n    (Debugging information: curl_status_message: [6] - [Couldn't resolve host. The given remote host was not resolved.])\n\n","comments":[{"author":"Patrick","date_created":1501342839,"date_modified":1501342839,"content":"The build was done using `jessie-proposed-updates`, which is still at `tbb_hardcoded_version=\"7.0.0\"`, that download version was removed from torproject's download server. `tbb_hardcoded_version` wasn't updated to prevent more breakage due unresolved T671."},{"author":"marmarek","date_created":1501366809,"date_modified":1501366809,"content":"What does it mean in practice?\nAlso \"Couldn't resolve host\" doesn't look like file removed from torproject's download server..."},{"author":"Patrick","date_created":1501498207,"date_modified":1501498207,"content":">>! In T710#14256, @marmarek wrote:\n> What does it mean in practice?\n\nNot having a deb package for Tor Browser while at the same time wanting preinstallation of Tor Browser and deterministic builds continues to create a mess. Builds will break as Torproject keeps deleting old versions and/or changing file locations.\n\nSolution:\n\n* workaround: Template build should set `export tbb_hardcoded_version=\"7.0.3\"` and hope it makes all the way down to [`/usr/bin/update-torbrowser`](https://github.com/Whonix/tb-updater/blob/master/usr/bin/update-torbrowser).\n* Whonix 13 stable tb-updater package upgrade\n** update to 7.0.3 - https://github.com/Whonix/tb-updater/blob/Whonix13/usr/share/tb-updater/tbb_hardcoded_version \n** but somehow also find a solution for T671\n*** Whonix 13 short solution: turn off for Whonix 13\n*** Whonix 14: real fix for T671\n\n> Also \"Couldn't resolve host\" doesn't look like file removed from torproject's download server...\n\nProbably transient issue... Because...\n\nFrom https://s3.amazonaws.com/archive.travis-ci.org/jobs/258845866/log.txt?X-Amz-Expires=29&X-Amz-Date=20170731T103501Z&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAJRYRXRSVGNKPKO5A/20170731/us-east-1/s3/aws4_request&X-Amz-SignedHeaders=host&X-Amz-Signature=701eed06909cdcc0ebb19521abd90cce2491a0c55a1b03c518a498a778d2b8c0\n\nThis worked:\n\n`+++ /usr/lib/curl-scripts/curl-prgrs --fail --fail --tlsv1.2 --proto =https --max-time 180 --output /var/cache/tb-binary/.cache/tb/temp/tbb_remote_folder https://dist.torproject.org/torbrowser`\n\nThis failed:\n\n`+++ /usr/lib/curl-scripts/curl-prgrs --fail --fail --tlsv1.2 --proto =https --max-time 180 --output /var/cache/tb-binary/.cache/tb/files/sha256sums.txt.asc https://dist.torproject.org/torbrowser/7.0/sha256sums.txt.asc`\n`+++ curl_exit_code=22`\n\n(Because of T710#14252.)"},{"author":"SimonSelg","date_created":1501977985,"date_modified":1607529901,"content":""},{"author":"Patrick","date_created":1502052848,"date_modified":1502052848,"content":"True.\n\ntb-updater should not be installed on Whonix-Gateway anyhow. That's\nstrange. That's the root cause to be fixed.\n\nThanks for looking into it! Development help very much needed at this\npoint. Please keep digging."},{"author":"SimonSelg","date_created":1502234650,"date_modified":1502235984,"content":"I tested the build whonix-gw and whonix-ws templates I build using my patch to [[https://github.com/SimonSelg/qubes-template-whonix/blob/SimonSelg-fix-tb-updater/whonix-gateway/04_install_qubes_post.sh#L65-L79 | qubes-template-whonix ]] and my [[ https://github.com/QubesOS/qubes-builder/pull/24 | patch to qubes-builder ]] and everything works just fine (on 4.0 RC1).\n\nWhich means whonix-gw and whonix-ws could be included in Qubes 4.0. \n\nMy patch doesn't solve the core issue (tb-updater gets installed while anon-gw-dns-conf is already in effect), it does the following two things:\n\n- Work around connectivity issue by installing tb-updater before installing the pack of packages containing anon-gw-dns-conf \n- It patches tbb_hardcoded_version in tb-updater to 7.0.3 since the package hasn't been pushed to the repo (T690)\n\nI could create a PR to qubes-template-whonix if there is any interest. "},{"author":"marmarek","date_created":1502235771,"date_modified":1502235771,"content":"I prefer the proper fix, which is a chain of three tickets in total: https://phabricator.whonix.org/T671#14310\nIndependently (not a blocker), it would be good to find out why tb-updater is installed in whonix-gw."},{"author":"SimonSelg","date_created":1502235944,"date_modified":1607529938,"content":""},{"author":"marmarek","date_created":1502236585,"date_modified":1502236585,"content":"Ah, you're right. So the second line in my comment _is_ a blocker too."},{"author":"SimonSelg","date_created":1502236777,"date_modified":1607529926,"content":""},{"author":"marmarek","date_created":1502237274,"date_modified":1502237274,"content":"Are you sure about that? According to build log, the issue with whonix-ws is missing 7.0.0 version on server. anon-gw-dns-conf is not installed in whonix-ws"},{"author":"SimonSelg","date_created":1502237497,"date_modified":1502237559,"content":"In whonix-ws the package is called anon-ws-dns-conf . Yes I'm sure about that. The build log explicitly says \"Couldn't resolve host\".\n\nAlso, if you watch the build log you can see that in both whonix-gw and whonix-ws tb-updater and anon-{ws|gw}-dns-conf gets installed at the same time.\n\nI verified that by stopping the build process, chrooting into the image and tested it there myself. \n\nI'll start a new build and verify it again tho. "},{"author":"marmarek","date_created":1502238225,"date_modified":1502238225,"content":"In above linked travis job, workstation build (17.6) fails with:\n```\n(Debugging information: curl_status_message: [22] - [HTTP page not retrieved. The requested url was not found or returned another error with the HTTP error code being 400 or above. This return code only appears if -f, --fail is used.])\n```\nProbably package installation order is non-deterministic here..."},{"author":"marmarek","date_created":1502238511,"date_modified":1502238511,"content":"Also, it worked before (when tor browser 7.0 was still downloadable)... See builds history on travis (https://travis-ci.org/marmarek/qubes-template-whonix/builds). "},{"author":"SimonSelg","date_created":1502238987,"date_modified":1607529872,"content":""},{"author":"Patrick","date_created":1502265259,"date_modified":1502265259,"content":"tb-updater must not be installed on Whonix-Gateway at all cost. It's a blocker, since that messes up a carefully selected and package selection.\n\nFrom https://s3.amazonaws.com/archive.travis-ci.org/jobs/258845867/log.txt?X-Amz-Expires=29&X-Amz-Date=20170809T074523Z&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAJRYRXRSVGNKPKO5A/20170809/us-east-1/s3/aws4_request&X-Amz-SignedHeaders=host&X-Amz-Signature=36184d2b752e87e36457a6ba48b1ca279482e37e1c2558cdd6345601ceda11bf .... This is might be the cause:\n\n    + /usr/sbin/chroot mnt eatmydata apt-get -o Dpkg::Options::=--force-confnew --yes -o Acquire::Retries=3 -o Dpkg::Options::=--force-unsafe-io install qubes-whonix-gateway\n\nWhonix used to be build using  `builder.conf`:\n\n    TEMPLATE_ALIAS += whonix-gateway:jessie+whonix-gateway+minimal+no-recommends\n\nThis results in Qubes builder using `apt-get` with `--no-install-recommends`. Looks like this is what's missing in this build?"},{"author":"marmarek","date_created":1502363811,"date_modified":1502363811,"content":"Indeed, TEMPLATE_OPTIONS variable wasn't properly propagated. Fixing this fixes whonix-gateway build:\nhttps://travis-ci.org/marmarek/qubes-template-whonix/builds/263033866"},{"author":"Patrick","date_created":1503587863,"date_modified":1503587863,"content":"tb-updater with updated hardcoded Tor Browser version is now available in Whonix `jessie-proposed-updates` repository. Could you try a build please? Quite likely it will go past that issue now."},{"author":"marmarek","date_created":1503704316,"date_modified":1503704316,"content":"Yes, it works now: https://travis-ci.org/marmarek/qubes-template-whonix/builds/263033873"},{"author":"marmarek","date_created":1507383584,"date_modified":1507383584,"content":"The problem is back again, 7.0.4 is no longer available at https://dist.torproject.org/torbrowser/\nWhat is the easiest/elegant way to choose different version, without modifying tb-updater package? Some env variable? Some config file? I don't consider https://github.com/SimonSelg/qubes-template-whonix/blob/SimonSelg-fix-tb-updater/whonix-gateway/04_install_qubes_post.sh#L65-L79 elegant..."},{"author":"Patrick","date_created":1507417970,"date_modified":1507417970,"content":"marmarek (Marek Marczykowski-Górecki):\n> marmarek added a comment.\n> \n> \n>   The problem is back again, 7.0.4 is no longer available at https://dist.torproject.org/torbrowser/\n>   What is the easiest/elegant way to choose different version, without modifying tb-updater package? Some env variable? Some config file? I don't consider https://github.com/SimonSelg/qubes-template-whonix/blob/SimonSelg-fix-tb-updater/whonix-gateway/04_install_qubes_post.sh#L65-L79 elegant...\n\nAgreed.\n\ntb-updater (update-torbrowser script) as is should already support\nenvironment variables for example `tbb_hardcoded_version=\"7.0.6\"`.\n\nSo\n\n`export tbb_hardcoded_version=\"7.0.6\"`\n\nshould do. Long time untested. Might have worked when Qubes-Whonix was\nnew if I remember right. Could you try that please?\n\nThe question is if that environment variable flows down from\nqubes-template-whonix through sudo (?), through apt-get, through\ntb-updater's debian/postinst to the actual update-torbrowser script?"},{"author":"marmarek","date_created":1507452992,"date_modified":1507452992,"content":"https://github.com/Whonix/qubes-template-whonix/pull/1\n> Just setting `tbb_version` or `tbb_hardcoded_version` variable isn't enough, because it isn't propagated through all the layers to postinst of tb-updater. But creating temporarily a configuration file works (in /etc/torbrowser.d).\n> Use `tbb_version` there, because `tbb_hardcoded_version` is unconditionally overridden by `/usr/share/tb-updater/tbb_hardcoded_version`. But later is ignored if `tbb_version` is already set."},{"author":"Patrick","date_created":1507456342,"date_modified":1507456342,"content":">   > Just setting `tbb_version` or `tbb_hardcoded_version` variable isn't enough, because it isn't propagated through all the layers to postinst of tb-updater.\n\nThat's unfortunate. I wonder why that is.\n\n(Yes, `tbb_version` already set works and then `tbb_hardcoded_version`\nis ignored.)"}]},"PHID-TASK-xmlqbnogfgjjdoawzbm4":{"id":"709","title":"port Whonix package build process to Qubes package build process","status":"open","priority":"Normal","author":"Patrick","description":"That would help with automation. More frequent updates. Then git tag signing, deterministic builds and release quality assurance would be sorted out.\n\n-----\n\nMotivation:\n\nAll packages not coming from Debian like Tor Browser (not packaged at all) and Tor ([newer versions from deb.torproject.org](https://www.whonix.org/wiki/Dev/Tor#Tor_Version)) is a major non-fun hassle maintenance burden.\n\n* watch upstream package updates\n* upload to developers repository\n* test\n* upload to testers repository\n* have testers test it\n* upload to proposed-stable repository\n* have testers test it\n* upload to stable repository\n\nSince all of this needs mental resources, time, remembering things, and cannot be done in connected working hours (since time has to pass), it's a major hassle.\n\nMost of the time, no issues are caught. But if there was an issue, it could be huge, such as:\n\n* Tor no longer connecting, requesting all users to apply manual steps to solve it\n* apt-get package management is broken dependency state","comments":[{"author":"marmarek","date_created":1550186408,"date_modified":1550186408,"content":"To build a package with qubes-builder, you need to add `Makefile.builder` file with just one line: `DEBIAN_BUILD_DIRS := debian`. This will tell qubes-builder that given repository contains Debian package.\nAlternatively, if that would be too much of a problem, it should be easy to add an option that do auto detection (probably just looks for `debian` directory)."}]},"PHID-TASK-ewi23pdpsfj5whamidtg":{"id":"708","title":"sdwdate in console can't be cleanly dismissed","status":"open","priority":"Low","author":"JasonJAyalaP","description":"Run Whonix-Workstation and control-C to prevent KDE booting. Run sdwdate. It successfully runs and reports \"sleeping for...\" The command line isn't returned. Control-C is ineffective. I hit control-d as well and got \"sclockadj exiting\" and a command line. The second time, I only hit control-c, waiting, and got an out of memory error and some kind of memory/process dump. WS had to be powered down.\n\nControl-C on GW gives a traceback and returns me to the command line.\n\nIs sdwdate& (and deal with messages) or another terminal the only sane way to run sdwdate on the command line?","comments":[{"author":"Patrick","date_created":1499990500,"date_modified":1499990500,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP created this task. Herald added subscribers: entr0py,\n> WhonixQubes, Patrick. Herald added a project: Whonix.\n> \n> TASK DESCRIPTION Run Whonix-Workstation and control-C to prevent KDE\n> booting. Run sdwdate. It successfully runs and reports \"sleeping\n> for...\" The command line isn't returned.\n\nIt shouldn't return to command line when it's sleeping. It's a daemon,\nnot a oneshot application. Perhaps one day there should be two programs.\nA long running daemon and a oneshot time setter. That may also help for\nQubes integration - there once was a `--oneshot` idea. But now that I\nthink about it, two separate programs daemon and time setter may be better.\n\n> Control-C is ineffective. I\n> hit control-d as well and got \"sclockadj exiting\" and a command line.\n> The second time, I only hit control-c, waiting, and\n\nPlease grep Whonix code for `KeyboardInterrupt` and see if these\nexamples can be replicated.\n\nI didn't think it's important - what I am always doing during developing\nis making changes, and then restarting the systemd service.\n\n    sudo make install && sudo systemctl restart sdwdate\n\n(`make install` works for \"simple\" changes which are unrelated to\nsystemd / debian packaging. I.e. if just changing sdwdate code logic,\nthat is most times good enough (faster than `make deb-icup`).\n\nIn another window.\n\n    sudo tail -f -u sdwdate\n\n(Because signal sigterm / sigint handling works.)\n\n> got an out of\n> memory error and some kind of memory/process dump.\n\nTry increase RAM?\n\nPerhaps the sdwdate systemd daemons needs memory and another instance in\ncli is pushing it too far?"}]},"PHID-TASK-utet7iawqylzy6umxpkd":{"id":"707","title":"wiki instructions for shared folders in whonix 14","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"Shared folder instructions is different in 14. Default shared folders tools work. Mentioned /media desktop shortcut and dolphin pin if successful","comments":[{"author":"JasonJAyalaP","date_created":1504725561,"date_modified":1504725561,"content":"Not going to wait for dolphin and desktop icons.\n\nhttps://www.whonix.org/w/index.php?title=VirtualBox/Guest_Additions&stable=0#For_Whonix_14_and_above\n\nThose tasks can edit the wiki when they're completed."}]},"PHID-TASK-pvyqjwl3bxjlkiod5vdf":{"id":"706","title":"Add /media to pinned places in dolphin","status":"wontfix","priority":"Normal","author":"JasonJAyalaP","description":"14 if possible, 15 if not\n\nedit \nhttps://www.whonix.org/w/index.php?title=VirtualBox/Guest_Additions&stable=0#For_Whonix_14_and_above\nwhen completed","comments":[{"author":"JasonJAyalaP","date_created":1504210846,"date_modified":1504210846,"content":"This should be simple. Dolphin \"Places\" are this file:\n\n~/.local/share/user-places.xbel\n\nsimply adding the following xml adds /media:\n```\n <bookmark href=\"file:///media\">\n  <title>media</title>\n  <info>\n   <metadata owner=\"http://freedesktop.org\">\n    <bookmark:icon name=\"inode-directory\"/>\n   </metadata>\n   <metadata owner=\"http://www.kde.org\">\n    <ID>1504210388/0 (V2)</ID>\n    <IsHidden>false</IsHidden>\n   </metadata>\n  </info>\n </bookmark>\n```"},{"author":"JasonJAyalaP","date_created":1504211164,"date_modified":1504211164,"content":"```\n <title>media</title>\n```\ncan be changed to  <title>Media and Shares</title> or whatever.\n\n  - For KVM, should shared folder helper put shares into /media to match vbox? Is /media a better place than /mnt/ anyway? Being consistent is a positive, in any case.\n  - This can be part of the shared folder package\n  - What's the best way to edit/add this file? I propose we simply overwrite the default file with ours, which would be a copy of the default one plus our additions.\n  - Any other places we should add?\n\n"},{"author":"Patrick","date_created":1504211261,"date_modified":1504211261,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   This should be simple. Dolphin \"Places\" are this file:\n>   \n>   ~/.local/share/user-places.xbel\n\nWe must not write to that file. Packages are not allowed to write there.\nCauses all sorts of issues."},{"author":"Patrick","date_created":1504211649,"date_modified":1504211649,"content":"Patrick (Patrick Schleizer):\n> Patrick added a comment.\n> \n> \n>   JasonJAyalaP (Jason J. Ayala P.):\n>   \n>   > JasonJAyalaP added a comment.\n>   > \n>   >   This should be simple. Dolphin \"Places\" are this file:\n>   >   \n>   >   ~/.local/share/user-places.xbel\n>   \n>   We must not write to that file. Packages are not allowed to write there.\n>   Causes all sorts of issues.\n\nGenerally: writing into home is an absolute exception.\n\nIt's possible to configure KDE without writing into home folders, but\nit's not easy. There are some examples in Whonix."},{"author":"JasonJAyalaP","date_created":1504211964,"date_modified":1504211964,"content":"It could do more than nuke their current settings? We would have to check each time dolphin upgrades to make sure the format is right, of course.\n\nBut can't we safely assume that shared folder helper will be used while building, and not by users with a functioning desktop? I don't see how we can make very useful changes without touching ~/.local at least at build."},{"author":"Patrick","date_created":1504213304,"date_modified":1504213304,"content":"Packages as per Debian policy must not write into /home or /root. It\ncauses an interactive dpkg conflict resolution during upgrades. It\ncauses a lintian warning. It makes the package unfit for inclusion into\nDebian. It conflicts with users settings, can leave the file in a messy\nstate and break the desktop. Hard to upgrade/change without breaking the\ndesktop on major Debian upgrades. It's a very unprofessional bad solution.\n\nFor example https://github.com/Whonix/kde-sounds-off changes sound\nsettings without writing into home.\n\nT636#13960 is another solution for such a setting.\n\nOther packages implement other settings.\n\nhttps://github.com/Whonix?utf8=%E2%9C%93&q=kde&type=&language=\n\nAll without touching /home or /root.\n\n`@hein` might help. (drop the code tags to really highlight) Formulate a\ngood summarized question, then highlight.\n\nIt's not straight forward or documented but often it can be sorted out\nby looking at how other distributions sorted it out.\n\nHard to debug:\n\nhttps://marc.info/?l=kde&m=141130406809446&w=2\n\nRelated:\n\nhttps://www.whonix.org/wiki/Dev/KDE"},{"author":"HulaHoop","date_created":1504755033,"date_modified":1504755065,"content":">>! In T706#14433, @JasonJAyalaP wrote:\n>   - For KVM, should shared folder helper put shares into /media to match vbox? Is /media a better place than /mnt/ anyway? Being consistent is a positive, in any case.\n\n\n\nIf it makes life easier please go ahead. I originally chose mount to avoid unforseen permissions problems with root but I guess its not a thing?"},{"author":"Patrick","date_created":1508770206,"date_modified":1508770206,"content":"Implementation advice:\n\n* Manually add a favorite.\n* Have a look at `./.local/share/user-places.xbel` to see how it's done (but this must not be the solution we implement.\n* Environment variable XDG something. (Probably got that in package anon-apps-config.)\n* File: `user-places.xbel`\n* As a general advice, I was told, if the local file is `./.local/share/user-places.xbel` then the file in the XDG folder should use the same structure, i.e...\n* We might be getting away dropping that file here:\n`/usr/share/anon-apps-config/` / https://github.com/Whonix/anon-apps-config/tree/master/usr/share/anon-apps-config/share\n"},{"author":"Patrick","date_created":1542729556,"date_modified":1542729556,"content":"https://forums.whonix.org/t/user-poll-xfce-vs-kde-kde-deprecation-considered/6235"}]},"PHID-TASK-42l26hfiowltzzhcq5ut":{"id":"705","title":"Add /media to desktop icons","status":"wontfix","priority":"Normal","author":"JasonJAyalaP","description":"Add shortcut folder to /media on the desktop of WS and GW.\n\ntry for 14, if not, change to 15\n\nEdit https://www.whonix.org/w/index.php?title=VirtualBox/Guest_Additions&stable=0#For_Whonix_14_and_above\nwhen completed","comments":[{"author":"Patrick","date_created":1542729569,"date_modified":1542729569,"content":"https://forums.whonix.org/t/user-poll-xfce-vs-kde-kde-deprecation-considered/6235"}]},"PHID-TASK-rqqfdgqvbcxec5zucm3h":{"id":"704","title":"VB (5.1.22 mac) drag and drop file doesn't work","status":"wontfix","priority":"Normal","author":"JasonJAyalaP","description":"VB drag and drop doesn't work in either direction. Host to VM allows the mouse to move into dolphin, but nothing is copied. Dragging from VM to Host either never seems to recognize moving outside the screen or pops open a \"dropping\" dialog that never finishes. More attempts results in system freezing.","comments":[{"author":"JasonJAyalaP","date_created":1499458421,"date_modified":1499458421,"content":"Going to debug with https://www.virtualbox.org/wiki/DnDDebug"},{"author":"JasonJAyalaP","date_created":1499459268,"date_modified":1499459268,"content":"Dragging my onion-grater folder from my home directory in dolphin to my host file explorer:\n```\n00:01:58.152409 DnD: Guest is using protocol v3, rc=VINF_SUCCESS\n00:01:58.252750 DnD: Default action is: 0x0\n00:01:58.252775 DnD: Number of supported guest actions: 0\n00:01:58.252780 DnD: Number of supported guest formats: 0\n00:01:58.260996 DnD: Guest is using protocol v3, rc=VINF_SUCCESS\n00:01:58.278863 DnD: Host offered the following formats:\n00:01:58.278881 DnD:\tFormat #0: text/uri-list\n00:01:58.278886 DnD:\tFormat #1: text/plain\n00:01:58.278907 DnD: Default action is: 0x1\n00:01:58.278912 DnD: Number of supported guest actions: 1\n00:01:58.278915 DnD: \tAction 0: 0x1\n00:01:58.278918 DnD: Number of supported guest formats: 2\n00:01:58.278923 DnD: \tFormat 0: text/uri-list\n00:01:58.278926 DnD: \tFormat 1: text/plain\n00:01:58.279066 DnD: Retrieved data state is 0 (action=0x0), rc=VINF_SUCCESS\n00:01:58.279066 DnD: Retrieving data from guest as 'text/plain' (1)\n00:01:58.279066 DnD: Requesting data from guest in format: text/plain\n00:01:58.279066 DnD: Requested data in format 'text/plain', receiving in intermediate format 'text/uri-list' now\n00:01:58.383201 DnD: Error creating guest directory '\\var\\folders\\6_\\0x0qbsbd5mb4pslrd4kbj1c40000gn\\T\\VirtualBox Dropped Files\\2017-07-07T20:16:47.484134000Z\\onion-grater' on host, rc=VERR_ACCESS_DENIED\n00:01:58.383244 DnD: Error VERR_ACCESS_DENIED occurred, aborting file transfer to host\n```\nDragging (my vbox.log file) from host to guest reports:\n\n```\n00:02:57.912072 DnD: Guest is using protocol v3, rc=VINF_SUCCESS\n00:02:57.912825 DnD: Offered formats to guest:\n00:02:57.912834 DnD: \ttext/uri-list\n00:02:58.679049 DnD: Host is sending 63 bytes of data as 'text/uri-list'\n00:02:58.690862 DnD: Processing: srcPath=/Users/j/VirtualBox VMs/Whonix-Gateway/Logs/VBox.log, dstPath=VBox.log, fMode=0x808180, cbSize=86225, fIsDir=false, fIsFile=true \n00:02:58.690888 DnD: Transferring host file to guest: /Users/j/VirtualBox VMs/Whonix-Gateway/Logs/VBox.log (86225 bytes, mode 0x808180)\n00:02:58.691266 DnD: Processing: srcPath=/Users/j/VirtualBox VMs/Whonix-Gateway/Logs/VBox.log, dstPath=VBox.log, fMode=0x808180, cbSize=86225, fIsDir=false, fIsFile=true \n```\nThat last lined in spammed hundreds of times (while I held the mouse over dolphin, I presume).\n\n"},{"author":"JasonJAyalaP","date_created":1499459487,"date_modified":1499459487,"content":"The guide goes on to ask for the log in the guest. It wants me to modify the logging by changing the file /usr/bin/VBoxClient-all, but this doesn't exist. Neither does /tmp/VBoxClient.log"},{"author":"JasonJAyalaP","date_created":1499459611,"date_modified":1499459713,"content":"Is Whonix blocking VB from writing to '\\var\\folders\\'?"},{"author":"Patrick","date_created":1499509635,"date_modified":1499509635,"content":"No idea.\n\n> I can create a bug report\n> (https://www.virtualbox.org/wiki/Bugtracker), but maybe @Patrick has\n> some insight (or knows where the guest log file is). If I post a bug\n> now they may believe it's whonix specific.\n\nYou need to reproduce the same issue on Debian stretch. Otherwise they\ncan always say it's Whonix specific."},{"author":"Patrick","date_created":1554575110,"date_modified":1554575110,"content":"To solve this:\n\n* reproduce on Debian buster\n* report this to Debian and/or VirtualBox"}]},"PHID-TASK-i7m6i62doj5khzgpyvsy":{"id":"703","title":"Include Kscreen","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"Kscreen allows DPI scaling and other basic desktop features of Plasma 5. We currently don't include it, but I think this is a usability and accessibility mistake. Is there any particular security reason why it's better to not have it installed by default (leaving users confused or searching the wiki/forums about how to scale their desktop)?","comments":[{"author":"Patrick","date_created":1499344660,"date_modified":1499344660,"content":"Should fit into anon-shared-applications-kde https://github.com/Whonix/anon-meta-packages/blob/master/debian/control#L146?"},{"author":"JasonJAyalaP","date_created":1499356892,"date_modified":1499356892,"content":"Is there an easy way to compare default plasma 5 packages with the ones we're including? "},{"author":"Patrick","date_created":1499358368,"date_modified":1499358368,"content":"No easy one. Only a hard one.\n\n- Install Debian with KDE (one time as minimal as possible, one time not).\n- Create Whonix as minimal as possible (only installing the related\nWhonix KDE packages.)\n- `dpkg -l` in both.\n- Use a diff viewer to compare those files.\n\nMaybe not that hard. But rather time intense.\n\nThat work was already done by me. That package slipped through. Whatever\nelse is missing should be figured out by $someone figuring out\n$something like you did."},{"author":"JasonJAyalaP","date_created":1499447393,"date_modified":1499447393,"content":"I added kscreen to that list:\nhttps://github.com/Whonix/anon-meta-packages/blob/master/debian/control#L148\n\nI found a (limited) list of related packages:\nhttps://packages.debian.org/stretch/plasma-desktop\n\nBut I agree that we should add things as-needed when we/people mention needing them."}]},"PHID-TASK-2zrkpnemnxayxwccjcpr":{"id":"702","title":"VB not automounting shares (remove shared-folder from 14)","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"I have a share that works when I manually run\n                       \nsudo mount -t vboxsf -o uid=1000,gid=1000 shared /mnt/shared       \n\nBut it never connects on boot. I have to run the command.\n\nmnt-shared-vbox status is good. Is there something inside its service file (uh, where is it?) that I should look at?","comments":[{"author":"Patrick","date_created":1499343611,"date_modified":1499343611,"content":"https://github.com/Whonix/shared-folder-help\n\nhttps://github.com/Whonix/shared-folder-help/blob/master/lib/systemd/system/mnt-shared-vbox.service\n\n    sudo journalctl -u mnt-shared-vbox | cat"},{"author":"JasonJAyalaP","date_created":1499450384,"date_modified":1499450448,"content":"the journalctl command just says \"starting\" and \"started\", but looking at the log doing bootup, I found out that the folder is being successfully automounted to /media/sf_shared\n\nIn fact, all shares set up to automount inside VBox (whatever the name) are being successfully mounted at boot to /media/sf_$sharename "},{"author":"JasonJAyalaP","date_created":1499457213,"date_modified":1499457213,"content":"Was VB not mounting before? Do we no longer need the service?"},{"author":"Patrick","date_created":1499509506,"date_modified":1499509506,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n> Was VB not mounting before?\n\nIn Whonix 13 / Debian jessie based Whonix the mount command was not\nautomatic.\n\n> Do we no longer need the service?\n\nIf it works without the service, then we no longer need it. I would\nappreciate that."},{"author":"JasonJAyalaP","date_created":1499552030,"date_modified":1499552030,"content":"Something in debian 9 is allowing VB to automatically mount shares (marked as automount) at /media/\n\nGood news for us.\n\nI masked mnt-shared-vbox (I couldnt purge the shared folder package because basic packages depend on it). Everything is mounting in /media/sf_$vb_mount_name\n\nSuggestions:\n# Remove shared-folder as dependency of other packages\n# Remove shared-folder from whonix 14\n# Update the wiki instructions for whonix 14\n# Add /media to pinned places in dolphin (is this possible)?\n# Add /media to desktop icons\n"},{"author":"Patrick","date_created":1499601938,"date_modified":1499601938,"content":">>! In T702#14087, @JasonJAyalaP wrote:\n> Suggestions:\n> # Remove shared-folder as dependency of other packages\n> # Remove shared-folder from whonix 14\n\nIt's still required for #KVM @HulaHoop?\n\nIn that case only remove the VirtualBox #shared-folder-help systemd unit file.\n\n> # Update the wiki instructions for whonix 14\n\nYes. (With a note that it apply to Whonix 14 only because Whonix 14 release will take a while.)\n\n> # Add /media to pinned places in dolphin (is this possible)?\n\nCertainly possible, but not easy, if we don't know how. -> separate ticket for Whonix 15.\n\n> # Add /media to desktop icons\n\nSounds cool. If not easy -> separate ticket for Whonix 15."},{"author":"Patrick","date_created":1499603976,"date_modified":1499603976,"content":"JasonJAyalaP (Jason J. Ayala P.):\n>   In fact, all shares set up to automount inside VBox are being successfully mounted at boot to /media/ (named \"shared\" or not).\n\nThis is great news indeed."},{"author":"HulaHoop","date_created":1500082052,"date_modified":1500082052,"content":"AFAICT VBox can do the auto-mounting because its guest additions DKMS module enables it. I am not aware of Libvirt/KVM doing anything similar so its best to stick with the service."},{"author":"JasonJAyalaP","date_created":1504115603,"date_modified":1504115639,"content":"Then it's a matter of removing the virtual box service file from shared-folder-help, correct?\n\nCan I simply delete?\nhttps://github.com/Whonix/shared-folder-help/blob/master/lib/systemd/system/mnt-shared-vbox.service\n\nThen remove the adduser stuff from .postinst (but keep mkdir mnt/shared because kvm needs it)\nhttps://github.com/Whonix/shared-folder-help/blob/master/debian/shared-folder-help.postinst#L30\n\nAnd fix the readme (which doesn't even mention kvm right now)."},{"author":"Patrick","date_created":1504125220,"date_modified":1504125220,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n> Then it's a matter of removing the virtual box service file from\n> shared-folder-help, correct?\n> \n> Can I simply delete \n> https://github.com/Whonix/shared-folder-help/blob/master/lib/systemd/system/mnt-shared-vbox.service\n\nYes.\n\n>  Then remove the adduser stuff from .postinst (but keep mkdir\n> mnt/shared because kvm needs it) \n> https://github.com/Whonix/shared-folder-help/blob/master/debian/shared-folder-help.postinst#L30\n\nYes... The following can probably be removed...\n\n    addgroup vboxsf || true\n    addgroup user vboxsf || true\n\nPlease test in a new build if it still works out of the box.\n\n>  And fix the readme (which doesn't even mention kvm right now).\n\nYes. Fix debian/control instead since readme gets autogenerated."},{"author":"JasonJAyalaP","date_created":1504211306,"date_modified":1504211306,"content":"Notes:\n\nAdding /media to places and desktop.\nhttps://phabricator.whonix.org/T705\nhttps://phabricator.whonix.org/T706\n\nI might be able to add them both to shared folder helper in 14"},{"author":"JasonJAyalaP","date_created":1505004906,"date_modified":1505004929,"content":"```\nPlease test in a new build if it still works out of the box.\n```\n```\naddgroup user vboxsf || true\n```\nWithout the user being added to the group, my WS image gives a permission denied error. I have to do addgroup user vboxsf. I didn't have to create the group. \n\n(1) Is virtualbox additions creating the group but not adding the user? (and can that be changed to add the user too?\n(2) Or just leave the above line (both lines so that it's clearer?) in?\n\n"},{"author":"Patrick","date_created":1505133042,"date_modified":1505133042,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n> addgroup user vboxsf || true\n> \n> Without the user being added to the group, my WS image gives a\n> permission denied error. I have to do addgroup user vboxsf. I didn't\n> have to create the group.\n> \n> (1) Is virtualbox additions creating the group but not adding the\n> user? (and can that be changed to add the user too?\n\nQuite likely. The virtualbox guest additions most likely won't do\n`addgroup user vboxsf`, in other words most likely won't add group\n`vboxs` to user `user`. Usually Debian packages as per Debian policy are\nnot allowed to do that.\n\nIf \"add group `vboxs` to user `user`\" is sti9ll required, we'd still do\nthat in Whonix has a convenience/usability feature. Debian won't pick\nthat up.\n\n> (2) Or just leave\n> the above line (both lines so that it's clearer?) in?\n\nNormally I would say, remove redundant code and add comments if\nexplanation is needed. But this time you need to keep it.\n\nTwo things here.\nCreate group\nAdd group\n\nAdd group depends on create group. But group creation is not guaranteed\nsince then shared-folder-help would have to depend on\nvirtualbox-guest-additions, which it doesn't, because it's not only a\nvirtualbox specific package.\n\nAlso then it would depend on the order of packages being installed.\n(guest additions followed by shared-folder-help would work but not vice\nversa.)\n\nUnless I miss something, probably best add a comment and keep."},{"author":"JasonJAyalaP","date_created":1505421742,"date_modified":1505421902,"content":"I removed the service\nhttps://github.com/Whonix/shared-folder-help/commit/d47f0071cd279504790eccfdc9aae27136e76b10\n\nand adding a comment in postint\nhttps://github.com/Whonix/shared-folder-help/commit/5320a689d24f6b646f5ef37c021caaf103385dfd"},{"author":"Patrick","date_created":1505477743,"date_modified":1505477743,"content":"Good.\n\nLet's set this to `Review` which is slightly confusing. I am using this status to imply \"test this in the next image build\" - and if it's still working, close as resolved. This indeed could use a better phabricator status name, which is somehow possible.\n\nhttps://secure.phabricator.com/Q40\n"},{"author":"Patrick","date_created":1520525161,"date_modified":1520525161,"content":"https://forums.whonix.org/t/whonix-virtualbox-14-0-0-6-8-release-candidate-testers-wanted/4904/14 by @unman\n"}]},"PHID-TASK-2vazqaxscrtzct3flujk":{"id":"701","title":"ZeroNet in 14","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"I got distracted with zeronet while messing with foxyproxy...\n\nThe zeronet instructions have some problems:\n\n  - Retrieving the gpg key in workstation gives an error abour missing dirmngr. You then have to apt-get install it.\n  - The best \"verifying\" we can do is git log, which is confusing output for a user not accustomed to git.\n  - Downloading via git (instead of wget the zip) and \"verifying\" requires a 36meg apt-get install of git.\n  - @Patrick any objection to making the download instructions use wget and tar x, and putting the verify instructions after that?\n  - Our instructions include \"apt-get install python-stem\" (is this necessary?)\n  - This is done inside WS and never GS, correct?\n\n\n\n","comments":[{"author":"Patrick","date_created":1498820073,"date_modified":1498820073,"content":"> Retrieving the gpg key in workstation gives an error abour missing dirmngr. You then have to apt-get install it.\n\nAlready fixed in git master. (grep for dirmngr)\n\n    ~/Whonix $ grep --exclude=README.md --exclude=GPLv2 --exclude=GPLv3 --exclude=COPYING --exclude=changelog.upstream-old1 --exclude-dir=mnt --exclude-dir=qubes-src/linux-template-builder/mnt --exclude=changelog.upstream --exclude-dir=.git --exclude-dir=chroot-debian --exclude-dir=chroot-jessie -r dirmngr\n\n(Of course using a shortcut for that grep command the excludes everything like the git folder.)\n\ndirmngr will be installed in next dev version.\n\n> The best \"verifying\" we can do is git log, which is confusing output for a user not accustomed to git.\n\nYes.\n\n> @Patrick any objection to making the download instructions use wget and tar x, and putting the verify instructions after that?\n\nwget is evil since it does not allow ssl verification. (See other usage examples of `curl` in Whonix wiki.)\n\n> Our instructions include \"apt-get install python-stem\" (is this necessary?)\n\nLast time it was since ZeroNet used python-stem. Once they port to python3, they'll be using python3-stem.\n\n> This is done inside WS and never GS, correct?\n\nNo. Will be similar to onionshare, where the onion-grater profile needs to be enabled on Whonix-Gateway.\n\n https://www.whonix.org/wiki/Next#onionshare"},{"author":"JasonJAyalaP","date_created":1499206109,"date_modified":1499206109,"content":"I decided against installing via curl. That makes it impossible to verify with git.\n\nI added onion grater instructions:\n```\nsudo cp /usr/share/onion-grater-merger/examples/40_onionshare.yml /etc/onion-grater-merger.d/\nsudo service onion-grater restart\n```\n"},{"author":"JasonJAyalaP","date_created":1499206492,"date_modified":1499206492,"content":"https://www.whonix.org/w/index.php?title=ZeroNet"},{"author":"Patrick","date_created":1499343341,"date_modified":1499343341,"content":">>! In T701#14001, @JasonJAyalaP wrote:\n> https://www.whonix.org/w/index.php?title=ZeroNet\n\nPlease regard this:\nhttps://www.whonix.org/wiki/Forum_Best_Practices#Mediawiki_Clean_Links"}]},"PHID-TASK-wbjbhz3vrqpmoxwdi7en":{"id":"700","title":"Build instructions, exim4 errors","status":"resolved","priority":"High","author":"JasonJAyalaP","description":"exim4 causes errors when installing genmkfile. You get into a bunch of error messages saying X is not installed because Y isn't configured. If you go one-by-one dpkg --configure, it eventually installs. Am I the only one getting this?","comments":[{"author":"Patrick","date_created":1498933727,"date_modified":1498933727,"content":"Works for me. Please post error messages.\n\nInstall build dependencies.\n\n    cd Whonix\n\n    sudo -E ./build-steps.d/1100_prepare-build-machine --internalrun --build --target virtualbox\n\n-----\n\nIt's a good chance to use a Build Configuration and use cowbuilder package build method.\n\nhttps://www.whonix.org/wiki/Dev/Source_Code_Intro#Build_Configuration\n\n     export make_use_cowbuilder=true\n"},{"author":"JasonJAyalaP","date_created":1499565471,"date_modified":1499565515,"content":"To compile and install in Whonix 14 workstation or GW, I have to install genmkfile...\n\n$ sudo apt-get install genmkfile\n\n\nExtracting templates from packages: 100%\nPreconfiguring packages ...\nSelecting previously unselected package exim4-config.\n(Reading database ... 144052 files and directories currently installed.)\nPreparing to unpack .../000-exim4-config_4.89-2+deb9u1_all.deb ...\nUnpacking exim4-config (4.89-2+deb9u1) ...\nSelecting previously unselected package exim4-base.\nPreparing to unpack .../001-exim4-base_4.89-2+deb9u1_amd64.deb ...\nUnpacking exim4-base (4.89-2+deb9u1) ...\nSelecting previously unselected package exim4-daemon-light.\nPreparing to unpack .../002-exim4-daemon-light_4.89-2+deb9u1_amd64.deb ...\nUnpacking exim4-daemon-light (4.89-2+deb9u1) ...\nSelecting previously unselected package libgc1c2:amd64.\nPreparing to unpack .../003-libgc1c2_1%3a7.4.2-8_amd64.deb ...\nUnpacking libgc1c2:amd64 (1:7.4.2-8) ...\nSelecting previously unselected package at.\nPreparing to unpack .../004-at_3.1.20-3_amd64.deb ...\nUnpacking at (3.1.20-3) ...\nSelecting previously unselected package libsigsegv2:amd64.\n[...]\nSetting up python-apt-common (1.4.0~beta3) ...\nSetting up libpath-tiny-perl (0.100-1) ...\nSetting up libnet-domain-tld-perl (1.75-1) ...\nSetting up libsub-install-perl (0.928-1) ...\nSetting up debian-keyring (2017.05.28) ...\nSetting up libio-stringy-perl (2.111-2) ...\nSetting up libsub-exporter-progressive-perl (0.001013-1) ...\nSetting up libtry-tiny-perl (0.28-1) ...\nSetting up libclass-method-modifiers-perl (2.12-1) ...\nSetting up python-gpg (1.8.0-3+b2) ...\nSetting up python3-apt (1.4.0~beta3) ...\nSetting up python-chardet (2.3.0-2) ...\nSetting up libarchive-zip-perl (1.59-1) ...\nSetting up exim4-config (4.89-2+deb9u1) ...\nAdding system-user for exim (v4)\n/usr/sbin/update-exim4.conf: 467: /usr/sbin/update-exim4.conf: /usr/sbin/exim4: Operation not permitted\nInvalid new configfile /var/lib/exim4/config.autogenerated.tmp, not installing \n/var/lib/exim4/config.autogenerated.tmp to /var/lib/exim4/config.autogenerated\ndpkg: error processing package exim4-config (--configure):\n subprocess installed post-installation script returned error exit status 1\nSetting up libltdl-dev:amd64 (2.4.6-2) ...\nSetting up libdistro-info-perl (0.14) ...\nSetting up libio-pty-perl (1:1.08-1.1+b2) ...\nSetting up libfile-which-perl (1.21-1) ...\nSetting up libperlio-gzip-perl (0.19-1+b2) ...\nSetting up libtext-levenshtein-perl (0.13-1) ...\nSetting up gettext (0.19.8.1-2) ...\nSetting up libvariable-magic-perl (0.61-1) ...\nSetting up libnet-ip-perl (1.26-1) ...\nSetting up libsigsegv2:amd64 (2.10-5) ...\nSetting up librole-tiny-perl (2.000005-1) ...\nSetting up libfile-homedir-perl (1.00-1) ...\nSetting up libipc-system-simple-perl (1.25-3) ...\nSetting up libfile-basedir-perl (0.07-1) ...\nSetting up libstring-escape-perl (2010.002-1) ...\nSetting up mysql-common (5.8+1.0.2) ...\nupdate-alternatives: using /etc/mysql/my.cnf.fallback to provide /etc/mysql/my.cnf (my.cnf) in auto mode\nSetting up python3-magic (1:5.30-1) ...\nSetting up libossp-uuid16:amd64 (1.6.2-1.5+b4) ...\nSetting up libossp-uuid-perl (1.6.2-1.5+b4) ...\nSetting up libgc1c2:amd64 (1:7.4.2-8) ...\nSetting up libnumber-range-perl (0.12-1) ...\nSetting up liblist-compare-perl (0.53-1) ...\nSetting up dctrl-tools (2.24-2+b1) ...\nSetting up libhttp-daemon-perl (6.01-1) ...\nSetting up libmariadbclient18:amd64 (10.1.23-9+deb9u1) ...\nSetting up devscripts (2.17.6) ...\nSetting up m4 (1.4.18-1) ...\ndpkg: dependency problems prevent configuration of exim4-base:\n exim4-base depends on exim4-config (>= 4.82) | exim4-config-2; however:\n  Package exim4-config is not configured yet.\n  Package exim4-config-2 is not installed.\n  Package exim4-config which provides exim4-config-2 is not configured yet.\n\ndpkg: error processing package exim4-base (--configure):\n dependency problems - leaving unconfigured\nSetting up at (3.1.20-3) ...\nCreated symlink /etc/systemd/system/multi-user.target.wants/atd.service → /lib/systemd/system/atd.service.\nSetting up libsub-identify-perl (0.12-2+b1) ...\nSetting up libpod-constants-perl (0.19-1) ...\nSetting up libsort-versions-perl (1.62-1) ...\nSetting up libfile-chdir-perl (0.1008-1) ...\nSetting up libsys-hostname-long-perl (1.5-1) ...\nSetting up python-debian (0.1.30) ...\nSetting up libtext-glob-perl (0.10-1) ...\nSetting up intltool-debian (0.35.0+20060710.4) ...\nSetting up libpackage-stash-xs-perl (0.28-3+b1) ...\nSetting up libstrictures-perl (2.000003-1) ...\nSetting up libntlm0:amd64 (1.4-8) ...\nSetting up libmail-sendmail-perl (0.79.16-2) ...\nProcessing triggers for libc-bin (2.24-11+deb9u1) ...\nSetting up libsocket6-perl (0.27-1+b1) ...\nSetting up patchutils (0.3.4-2) ...\nSetting up autotools-dev (20161112.1) ...\nSetting up python3-chardet (2.3.0-2) ...\nSetting up t1utils (1.39-2) ...\nSetting up dput (0.12.1) ...\nSetting up libfakeroot:amd64 (1.21-3.1) ...\nSetting up guile-2.0-libs:amd64 (2.0.13+1-4) ...\nSetting up libscalar-list-utils-perl (1:1.47-1) ...\nProcessing triggers for systemd (232-25) ...\nSetting up libstring-copyright-perl (0.003005-1) ...\nSetting up libxml-parser-perl (2.44-2+b1) ...\nSetting up libipc-run-perl (0.94-1) ...\nSetting up libcgi-pm-perl (4.35-1) ...\nSetting up libdevel-globaldestruction-perl (0.14-1) ...\nSetting up libdigest-hmac-perl (1.03+dfsg-1) ...\nSetting up libio-string-perl (1.08-3) ...\nSetting up libclone-perl (0.38-2+b1) ...\nSetting up wdiff (1.2.2-2) ...\nSetting up libclass-xsaccessor-perl (1.19-2+b7) ...\nProcessing triggers for man-db (2.7.6.1-2) ...\nSetting up libnumber-compare-perl (0.03-1) ...\ndpkg: dependency problems prevent configuration of exim4-daemon-light:\n exim4-daemon-light depends on exim4-base (>= 4.89); however:\n  Package exim4-base is not configured yet.\n\ndpkg: error processing package exim4-daemon-light (--configure):\n dependency problems - leaving unconfigured\nSetting up libunicode-utf8-perl (0.60-1+b3) ...\nSetting up libconvert-binhex-perl (1.125-1) ...\nSetting up libio-sessiondata-perl (1.03-1) ...\nSetting up libparams-util-perl (1.07-3+b1) ...\nSetting up python-apt (1.4.0~beta3) ...\nSetting up libsub-name-perl (0.21-1) ...\nSetting up libyaml-libyaml-perl (0.63-2) ...\nSetting up libparams-classify-perl (0.013-6+b1) ...\nSetting up libkyotocabinet16v5:amd64 (1.2.76-4.2+b1) ...\nSetting up libfcgi-perl (0.78-2) ...\nSetting up python3-debian (0.1.30) ...\nSetting up diffstat (1.61-1+b1) ...\nSetting up autopoint (0.19.8.1-2) ...\nSetting up libclass-accessor-perl (0.34-1) ...\nSetting up libsort-key-perl (1.33-1+b3) ...\nSetting up libclass-inspector-perl (1.31-1) ...\nSetting up mailutils-common (1:3.1.1-1) ...\nSetting up libmime-tools-perl (5.508-1) ...\nSetting up libtask-weaken-perl (1.04-1) ...\nSetting up libfile-stripnondeterminism-perl (0.034-1) ...\nSetting up libtool (2.4.6-2) ...\nSetting up libgsasl7 (1.8.0-8+b2) ...\nSetting up libmailutils5:amd64 (1:3.1.1-1) ...\nSetting up libdata-optlist-perl (0.110-1) ...\nSetting up libgit-wrapper-perl (0.047-1) ...\nSetting up strip-nondeterminism (0.034-1) ...\nSetting up po-debconf (1.0.20) ...\nSetting up libio-socket-inet6-perl (2.72-2) ...\nSetting up libsoap-lite-perl (1.20-1) ...\nSetting up libmodule-runtime-perl (0.014-2) ...\nSetting up autoconf (2.69-10) ...\nSetting up libpath-iterator-rule-perl (1.009-1) ...\nSetting up libnet-dns-perl (1.07-1) ...\ndpkg: dependency problems prevent configuration of mailutils:\n mailutils depends on default-mta | mail-transport-agent; however:\n  Package default-mta is not installed.\n  Package exim4-daemon-light which provides default-mta is not configured yet.\n  Package mail-transport-agent is not installed.\n  Package exim4-daemon-light which provides mail-transport-agent is not configured yet.\n\ndpkg: error processing package mailutils (--configure):\n dependency problems - leaving unconfigured\nSetting up fakeroot (1.21-3.1) ...\nupdate-alternatives: using /usr/bin/fakeroot-sysv to provide /usr/bin/fakeroot (fakeroot) in auto mode\nSetting up libcgi-fast-perl (1:2.12-1) ...\nSetting up libsub-exporter-perl (0.986-1) ...\nSetting up libxmlrpc-lite-perl (0.717-1) ...\nSetting up automake (1:1.15-6) ...\nupdate-alternatives: using /usr/bin/automake-1.15 to provide /usr/bin/automake (automake) in auto mode\nSetting up libparse-debianchangelog-perl (1.2.0-12) ...\nSetting up libemail-valid-perl (1.202-1) ...\nSetting up libimport-into-perl (1.002005-1) ...\nSetting up libmodule-implementation-perl (0.09-1) ...\nSetting up libparams-validate-perl (1.26-1) ...\nSetting up lintian (2.5.50.4) ...\nSetting up libmoo-perl (2.002005-1) ...\nSetting up libb-hooks-endofscope-perl (0.21-1) ...\nSetting up libpackage-stash-perl (0.37-1) ...\nSetting up libgetopt-long-descriptive-perl (0.100-1) ...\nSetting up libnamespace-clean-perl (0.27-1) ...\nSetting up licensecheck (3.0.29-1) ...\nSetting up dh-autoreconf (14) ...\nSetting up debhelper (10.2.5) ...\nSetting up equivs (2.0.9+nmu1) ...\nSetting up dh-strip-nondeterminism (0.034-1) ...\nSetting up genmkfile (3:4.4-1) ...\nProcessing triggers for libc-bin (2.24-11+deb9u1) ...\nErrors were encountered while processing:\n exim4-config\n exim4-base\n exim4-daemon-light\n mailutils\nE: Sub-process /usr/bin/dpkg returned an error code (1)\n\n\n$ sudo dpkg --configure exim4-config\nThis is successful. I think do install mailutils (not sure if that's necessary). I then do sudo make deb-all-dep, but that doesnt install build essentials, and so I install that.\n\nThen I can do make deb-icup"},{"author":"Patrick","date_created":1499601319,"date_modified":1499601319,"content":"JasonJAyalaP (Jason J. Ayala P.):\n>   $ sudo apt-get install genmkfile\n\nYou missed to post the part which shows the confirmation yes/no. It's an\nessential part, because it makes somewhat clearer which packages get\npulled in.\n\nIt looks like a Debian bug. A bug in some postinst script. The same\nprobably happens when you manually install `exim4-daemon-light`?\n\nDoes it happen only on Whonix 14? Or does it also happen on plain Debian\nstretch?\n\nQuite possibly some package added exim4 as `Recommends:`. Try installing\nwithout `Recommends:`.\n\n    sudo apt-get install --no-install-recommends genmkfile\n\n(That's also what the build script does. We only use explicit\ndependencies. No `Recommends:`, because these are messy, because these\ndon't get updated when the package gets upgraded."},{"author":"Patrick","date_created":1499601684,"date_modified":1499601684,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> I think do\n> install mailutils (not sure if that's necessary).\n\nUnless you prefer that file manage, while would that be required?\n\n> but that doesnt install build essentials, and so I\n> install that.\n\nNot a bug btw. Debian doesn't want `Build-Depends: build-essential` somehow.\n\nhttps://lintian.debian.org/tags/build-depends-on-build-essential.html\n\n    apt-cache show build-essential"},{"author":"JasonJAyalaP","date_created":1499813141,"date_modified":1499813141,"content":"```\nuser@host:~/whonix-ws-desktop-shortcuts$ sudo apt-get install genmkfile\nReading package lists... Done\nBuilding dependency tree       \nReading state information... Done\nThe following packages were automatically installed and are no longer required:\n  alsa-base pidgin-improved-privacy\nUse 'sudo apt autoremove' to remove them.\nThe following additional packages will be installed:\n  at autoconf automake autopoint autotools-dev dctrl-tools debhelper\n  debian-keyring devscripts dh-autoreconf dh-strip-nondeterminism diffstat\n  dput equivs exim4-base exim4-config exim4-daemon-light fakeroot gettext\n  guile-2.0-libs intltool-debian libarchive-zip-perl\n  libb-hooks-endofscope-perl libcgi-fast-perl libcgi-pm-perl\n  libclass-accessor-perl libclass-inspector-perl\n  libclass-method-modifiers-perl libclass-xsaccessor-perl libclone-perl\n  libconvert-binhex-perl libdata-optlist-perl\n  libdevel-globaldestruction-perl libdigest-hmac-perl libdistro-info-perl\n  libemail-valid-perl libfakeroot libfcgi-perl libfile-basedir-perl\n  libfile-chdir-perl libfile-homedir-perl libfile-stripnondeterminism-perl\n  libfile-which-perl libgc1c2 libgetopt-long-descriptive-perl\n  libgit-wrapper-perl libgsasl7 libhttp-daemon-perl libimport-into-perl\n  libio-pty-perl libio-sessiondata-perl libio-socket-inet6-perl\n  libio-string-perl libio-stringy-perl libipc-run-perl\n  libipc-system-simple-perl libkyotocabinet16v5 liblist-compare-perl\n  libltdl-dev libmail-sendmail-perl libmailutils5 libmariadbclient18\n  libmime-tools-perl libmodule-implementation-perl libmodule-runtime-perl\n  libmoo-perl libnamespace-clean-perl libnet-dns-perl libnet-domain-tld-perl\n  libnet-ip-perl libntlm0 libnumber-compare-perl libnumber-range-perl\n  libossp-uuid-perl libossp-uuid16 libpackage-stash-perl\n  libpackage-stash-xs-perl libparams-classify-perl libparams-util-perl\n  libparams-validate-perl libparse-debianchangelog-perl\n  libpath-iterator-rule-perl libpath-tiny-perl libperlio-gzip-perl\n  libpod-constants-perl librole-tiny-perl libscalar-list-utils-perl\n  libsigsegv2 libsoap-lite-perl libsocket6-perl libsort-key-perl\n  libsort-versions-perl libstrictures-perl libstring-copyright-perl\n  libstring-escape-perl libsub-exporter-perl\n  libsub-exporter-progressive-perl libsub-identify-perl libsub-install-perl\n  libsub-name-perl libsys-hostname-long-perl libtask-weaken-perl\n  libtext-glob-perl libtext-levenshtein-perl libtool libtry-tiny-perl\n  libunicode-utf8-perl libvariable-magic-perl libxml-parser-perl\n  libxmlrpc-lite-perl libyaml-libyaml-perl licensecheck lintian m4 mailutils\n  mailutils-common mysql-common patchutils po-debconf python-apt\n  python-apt-common python-chardet python-debian python-gpg python3-apt\n  python3-chardet python3-debian python3-magic strip-nondeterminism t1utils\n  wdiff\nSuggested packages:\n  autoconf-archive gnu-standards autoconf-doc debtags dh-make adequate\n  autopkgtest bls-standalone build-essential check-all-the-things\n  cvs-buildpackage devscripts-el diffoscope disorderfs dose-extra duck\n  gnuplot how-can-i-help libauthen-sasl-perl libfile-desktopentry-perl\n  libnet-smtps-perl libterm-size-perl libyaml-syck-perl mozilla-devscripts\n  mutt piuparts ratt reprotest svn-buildpackage w3m mini-dinstall eximon4\n  exim4-doc-html | exim4-doc-info spf-tools-perl swaks gettext-doc\n  libasprintf-dev libgettextpo-dev libtool-doc uuid libscalar-number-perl\n  libhtml-template-perl libxml-simple-perl libapache2-mod-perl2\n  libmime-lite-perl libnet-jabber-perl libbareword-filehandles-perl\n  libindirect-perl libmultidimensional-perl gfortran | fortran95-compiler\n  gcj-jdk binutils-multiarch libtext-template-perl m4-doc mailutils-mh\n  mailutils-doc libmail-box-perl python-apt-dbg python-apt-doc\n  python3-apt-dbg wdiff-doc\nThe following NEW packages will be installed:\n  at autoconf automake autopoint autotools-dev dctrl-tools debhelper\n  debian-keyring devscripts dh-autoreconf dh-strip-nondeterminism diffstat\n  dput equivs exim4-base exim4-config exim4-daemon-light fakeroot genmkfile\n  gettext guile-2.0-libs intltool-debian libarchive-zip-perl\n  libb-hooks-endofscope-perl libcgi-fast-perl libcgi-pm-perl\n  libclass-accessor-perl libclass-inspector-perl\n  libclass-method-modifiers-perl libclass-xsaccessor-perl libclone-perl\n  libconvert-binhex-perl libdata-optlist-perl\n  libdevel-globaldestruction-perl libdigest-hmac-perl libdistro-info-perl\n  libemail-valid-perl libfakeroot libfcgi-perl libfile-basedir-perl\n  libfile-chdir-perl libfile-homedir-perl libfile-stripnondeterminism-perl\n  libfile-which-perl libgc1c2 libgetopt-long-descriptive-perl\n  libgit-wrapper-perl libgsasl7 libhttp-daemon-perl libimport-into-perl\n  libio-pty-perl libio-sessiondata-perl libio-socket-inet6-perl\n  libio-string-perl libio-stringy-perl libipc-run-perl\n  libipc-system-simple-perl libkyotocabinet16v5 liblist-compare-perl\n  libltdl-dev libmail-sendmail-perl libmailutils5 libmariadbclient18\n  libmime-tools-perl libmodule-implementation-perl libmodule-runtime-perl\n  libmoo-perl libnamespace-clean-perl libnet-dns-perl libnet-domain-tld-perl\n  libnet-ip-perl libntlm0 libnumber-compare-perl libnumber-range-perl\n  libossp-uuid-perl libossp-uuid16 libpackage-stash-perl\n  libpackage-stash-xs-perl libparams-classify-perl libparams-util-perl\n  libparams-validate-perl libparse-debianchangelog-perl\n  libpath-iterator-rule-perl libpath-tiny-perl libperlio-gzip-perl\n  libpod-constants-perl librole-tiny-perl libscalar-list-utils-perl\n  libsigsegv2 libsoap-lite-perl libsocket6-perl libsort-key-perl\n  libsort-versions-perl libstrictures-perl libstring-copyright-perl\n  libstring-escape-perl libsub-exporter-perl\n  libsub-exporter-progressive-perl libsub-identify-perl libsub-install-perl\n  libsub-name-perl libsys-hostname-long-perl libtask-weaken-perl\n  libtext-glob-perl libtext-levenshtein-perl libtool libtry-tiny-perl\n  libunicode-utf8-perl libvariable-magic-perl libxml-parser-perl\n  libxmlrpc-lite-perl libyaml-libyaml-perl licensecheck lintian m4 mailutils\n  mailutils-common mysql-common patchutils po-debconf python-apt\n  python-apt-common python-chardet python-debian python-gpg python3-apt\n  python3-chardet python3-debian python3-magic strip-nondeterminism t1utils\n  wdiff\n0 upgraded, 132 newly installed, 0 to remove and 0 not upgraded.\nNeed to get 53.3 MB of archives.\nAfter this operation, 101 MB of additional disk space will be used.\n```"},{"author":"JasonJAyalaP","date_created":1499813216,"date_modified":1499813216,"content":"I installed genmkfile on plain debian 9 (adding the whonix jessie repo) and it installed quickly, without that huge list."},{"author":"JasonJAyalaP","date_created":1499813500,"date_modified":1499813500,"content":"I removed genmkfile, autoremoved that huge list that came with it, did apt-get install genmkfile, it recommended the huge list, I did it again with no-recommends and it showed a multi-part list (with suggested, recommends) but only 4 requirements. It installed and worked fine (make deb-icup inside a package) "},{"author":"JasonJAyalaP","date_created":1499813566,"date_modified":1499813566,"content":"Exim 4 is a MTA? oh dear. Yeah. That wasn't right at all."},{"author":"JasonJAyalaP","date_created":1499901600,"date_modified":1499901600,"content":"@Patrick \nIt didn't happen to me in pure debian 9. What does that tell you? Where should I look for the bug? "},{"author":"Patrick","date_created":1499950544,"date_modified":1499950544,"content":"Look into the postinst script. /var/lib/dpkg/exim something .postinst.\n(Or another extension but probably .postinst.) See what that maintainer\nscript is doing and what might fail."},{"author":"JasonJAyalaP","date_created":1499969695,"date_modified":1499969695,"content":"How did install genmkfile lead to installing a mail program like exim?"},{"author":"Patrick","date_created":1499982743,"date_modified":1499982743,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   How did install genmkfile lead to installing a mail program like exim?\n\nI suspect some package #genmkfile depends lists some package that\n`Depends:` or `Recommends:` on some package that depends on mta and/or exim.\n\n    apt-cache show genmkfile\n\n.\n\n    reverse-depends pkg-name\n\nOtherwise please try asking the apt-get developers for what could be the\ncause or what kind of debugging tools (to draw a `Recommends:` tree or\nso) are available.\n\nhttps://lists.debian.org/deity/"},{"author":"Algernon","date_created":1503658411,"date_modified":1503658411,"content":"I can't reproduce this issue on my side. Tested it with the gateway and workstation 14.0.0.2.6 and with a self build gateway on 14.0.0.4.1. Installing genmkfile works in each case. \nHowever, it depends on the version of genmkfile if exim + a lot of other packages are installed. There are two versions of genmkfile, the latest one is only present in the whonix developers repo. This version requires several packages (see Depends in the control file). One of those packages is devscripts which has the package \"at\" as recommends which again has some mta like exim as recommends.\nThe version of genmkfile in jessie, jessie-proposed-updates and testers does not depend on any package. This is also the reason why JasonJAyalaP saw no exim being installed on debian stretch with the whonix jessie repository.\nSo if you don't want exim etc. to be installed AND you want to use the latest genmkfile version then: use --no-install-recommends.\nOtherwise use the whonix jessie repo. Not sure about the differences between the genmkfile versions though.\nAs already said, for me it also works with the recommended packages and whatever repo, no exim errors.\n@JasonJAyalaP can you still reproduce this error on your side?"},{"author":"JasonJAyalaP","date_created":1504122040,"date_modified":1504122099,"content":"Whonix gateway 14.0.2.6 upgraded with developers repo:\n\ninstall genmkfile -> 140 MB including lib-sendmail-perl, etc\ninstall genmkfile --no-install-recommends -> 14 mb\n\nThe new genmkfile wants devscripts, but devscripts recommends 125 mb of packages that aren't necessary (i assume?) for us. Even if it did install MTAs without problems, genmkfile shouldn't put all that on our system, right?\n\nIt's painful that \"recommended\" cascades down into every dependency, but since genmkfile is a developer tool, we can simply always say in the wiki \"use --no-install-recommends\".\n\n\n"},{"author":"Patrick","date_created":1504125741,"date_modified":1504125741,"content":"Whonix's build script (as well as Qubes-Whonix build) always assumes `--no-install-recommends`. If something was missing, it would be a missing dependency bug. So using `--no-install-recommends` when installing genmkfile should be fine."},{"author":"JasonJAyalaP","date_created":1504131754,"date_modified":1504131754,"content":"Ok. If there's no objection, I'll close this issue and wherever I find \"apt-get install genmkfile\" in our documentation I will add no install recommends."}]},"PHID-TASK-y7t44rzteudkdoe3afnz":{"id":"699","title":"review and merge anon-connection-wizard pull request by iry","status":"resolved","priority":"High","author":"Patrick","description":"* https://forums.whonix.org/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/271\n* https://github.com/Whonix/anon-connection-wizard/pull/5\n\nPriority high because the GSoC students needs feedback to not block progress.","comments":[{"author":"JasonJAyalaP","date_created":1498779771,"date_modified":1498779771,"content":"I pulled his changes, compiling now, then I install and run this new connection wizard and look for what? That each button has its intended effect? Or something more formal?"},{"author":"JasonJAyalaP","date_created":1498782240,"date_modified":1498782272,"content":"@iry\n\nThere are complaints while making about not using standard python folders. I don't know if that's important.\n\nrunning /usr/bin/anon-connection-wizard gives me an import error. I don't know how python looks up it's modules. Why can't it find /usr/lib/python3.4/dist-packages/anon_connection_wizard ?\n\nrunning sudo python3 anon_connection_wizard.py loads the gui, and the options seem to modify torrc successfully, but then I get some sort of tor control port communication message in the terminal (\"unable to connect to tor. Maybe it's running without a controlport?\") Is this because of something in whonix 14 developers / onion_grater ?\n\nAbout the UI:\nDo we need the advanced button? It only shows one option. I think we planned on putting more there, but right it's kinda silly. And \"disable tor\" doesn't seem that advanced\n\nCan we have a \"cancel\" button on all pages that aborts at any time? Or can we move the cancel button to the left so that the back and next buttons stay in the same position?\n\nThe final \"next >\" button should be \"Done\" or \"Finished\"\n"},{"author":"iry","date_created":1498792782,"date_modified":1498792846,"content":"Hi @JasonJAyalaP  !\n\nThank you so much for offering me feedback! I really appreciate your help!\n \nThe first thing is I just did another pull request which implemented the torrc.d approach and fixed some other issues like \"having a conceal button on every page\".\n \nI actually have no idea on how to compile the anon-connection-wizard. I always setup the dependencies by coping/downloading them manually (http://forums.kkkkkkkkkk63ava6.onion/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/273). Could you please share some instructions on how to compile it? Thank you very much!\n\n\n\n> About the UI:\n> Do we need the advanced button? It only shows one option. I think we planned on putting more there, but right it's kinda silly. And \"disable tor\" doesn't seem that advanced\n> \nAgree. I will remove the button.\n\n> Can we have a \"cancel\" button on all pages that aborts at any time? \nGood idea. I have implemented this in the new pull request.\n\n> Or can we move the cancel button to the left so that the back and next buttons stay in the same position?\nLet me try this. This can be a good idea because it will reduce the chance that a user accidentally click the canceal button.\n\n> The final \"next >\" button should be \"Done\" or \"Finished\"\nAgree.\n\nAgain, thank you so much for your feedback! "},{"author":"Patrick","date_created":1498818413,"date_modified":1498818413,"content":">>! In T699#13927, @JasonJAyalaP wrote:\n> I pulled his changes, compiling now, then I install and run this new connection wizard and look for what? That each button has its intended effect?\n\nYes.\n\nAlso logic. Such as backing up torrc. Restoring it. And thinking about any corner cases with upgrading where unexpected stuff happens or stuff breaks. Migration to torrc.d and whatnot.\n\nAs for usability... Not so much. We have a plan in place already. That is \"same as torbrowser-launcher\" and/or \"as per usability research papers\" and/or \"as per usability research\".\n\nGenerally, we should merge most. For simplicity. Because fixes can be added on top.\n\n> Or something more formal?\n\nNo."},{"author":"JasonJAyalaP","date_created":1498877606,"date_modified":1498877870,"content":"I'd like to settle what /etc/tor/tor* looks like.\nWe have torrc, torrc orig, anondist, anondist-orig... I'm confused.\n\n@Patrick can you refresh my memory about torrc.d? Is it in issue tracker hell?\n\n@iry \nTODOs:\n# Better error message when not running as sudo. Is it possible to make a dialog box pop up asking for root password, like many desktop apps?\n# Please disagree with me if you know better (as I am not a pythonista), but: Change your hash bang in /usr/bin/anon-c to python3 -u; put your dist-packages in python3/dist-packages, not python3.4. Checkout /usr/bin/whonix-setup-wizard. Switch your import tor_status to the commented out line (from anon_ import tor status). This is how whonix-setup-wizard does it at least, and that should solve two problems (not finding the module, module placement error while building).\n# the signal handling in whonix-setup-wizard might be useful to you too. I dunno.\n# RE: packaging (I'm learning this myself.) I do sudo make deb-icup in the anon_con folder. It builds and installs.\n# The whole torrc, torrc.tmp etc thing once we figure it out. I noticed that it fails if torrc.orig is missing. In my opinion, it should survive a total rm -rf of /etc/tor/. Instead of using torrc.tmp inside /etc/tor (hacky), consider using python's temporary directory features (which should automatically nuke the .tmp file when done).\n"},{"author":"Patrick","date_created":1498906061,"date_modified":1498906061,"content":"Debian default (non-Whonix!):\n\n* /etc/tor/torrc owned by package `tor`\n\n* /usr/share/tor/tor-service-defaults-torrc owned by package `tor`\n\nWhonix 13:\n\n* We are using Debian package `config-package-dev` action `displace`. #anon-gw-anonyminizer uses file `debian/anon-gw-anonymizer-config.displace-extension` `.anondist`.\n\n* /etc/tor/torrc.anondist-orig is the original by Debian\n* /etc/tor/torrc.anondist is owned by Whonix's #anon-gw-anonyminizer\n* /etc/tor/torrc is a symlink\n\n* This is necessary because #anon-gw-anonyminizer cannot take over ownership of /etc/tor/torrc. apt-get won't allow that. Manual `dpkg-divert` are fragile. `config-package-dev` is a stable solution.\n* We shouldn't use `sed` etc. to edit /etc/tor/torrc because when a script by Whonix modified a file and then Debian's `tor` package pushed an upgrade, the user would run into a dpkg interactive conflict resolution dialog ( https://www.whonix.org/wiki/Whonix_Configuration_Files#dpkg_interactive_conflict_resolution_dialog ) which is bad for usability.\n\n* Same for:\n** /usr/share/tor/tor-service-defaults-torrc.anondist-orig\n** /usr/share/tor/tor-service-defaults-torrc.anondist\n** /usr/share/tor/tor-service-defaults-torrc\n\n* Whonix's Tor config was implemented in /usr/share/tor/tor-service-defaults-torrc.anondist becuase there was no torrc.d drop-in folder.\n\nWhonix 14:\n\n* If torrc.d drop-in folder is available, we should config-package-dev action `undisplace` (undo!) previous config-package-dev `displace` actions. (10 minutes to explain, 1 minute to do, I can do that one.)\n* (From perspective of a new build, `/usr/share/tor/tor-service-defaults-torrc.anondist` and `/etc/tor/torrc.anondist` will have never existed.)\n* Should avoid modification of `/etc/tor/torrc`.\n* Should avoid modification of `/usr/share/tor/tor-service-defaults-torrc`.\n* Perhaps we must still keep `/usr/share/tor/tor-service-defaults-torrc` displaced if Debian is slow to add `include`. \n\n* It's not clear to me yet in which order configuration files will be parsed. Details: https://forums.whonix.org/t/torrc-d-is-comming/4041/9\n\n* Before https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=866187 is settled, it's probably hard to implement.\n\n* As per https://trac.torproject.org/projects/tor/ticket/1922#comment:55\n** there will be `services-available` and `instances-available` folders\n** and `services-enabled` and `/etc/tor/instances-enabled` folders.\n** If that's true, Whonix's Tor configuration should be in the appropriate \"`available`\" folder, and then symlinked by default in the approrpiate \"`enabled`\" folder.\n** Probably the same for anon-connection-wizard.\n\n* It's not clear to me yet where we put `DisableNetwork 1`.\n\n* Perhaps /etc/torrc.d/30_anon-gw-anonyminizer.torrc (all of Whonix's config and `DisableNetwork 1`)\n* Perhaps /etc/torrc.d/40_anon-connection-wizard-autogenerated.torrc (with `DisableNetwork 0` and bridges if chosen by user)\n\n* torrc_orig was just recently invented by @iry used by anon-connection-wizard. We should avoid that file by using /etc/torrc.d.\n"},{"author":"Patrick","date_created":1498906599,"date_modified":1498906599,"content":">>! In T699#13975, @JasonJAyalaP wrote:\n> I'd like to settle what /etc/tor/tor* looks like.\n> We have torrc, torrc orig, anondist, anondist-orig... I'm confused.\n> \n> @Patrick can you refresh my memory about torrc.d? Is it in issue tracker hell?\n> \n> @iry \n> TODOs:\n> # Better error message when not running as sudo. Is it possible to make a dialog box pop up asking for root password, like many desktop apps?\n\nDon't run gui applications with sudo anyhow.\n\nhttps://www.whonix.org/wiki/Install_Software#GUI_Applications_with_Root_Rights\n\nUsers should run anon-connection-wizard will auto start. Or will start it from start menu or perhaps a desktop shortcut. Then it shouldn't ask for a sudo password. Should be passwordless on Whonix-Gateway. Like whonix-setup-wizard is.\n\nWhen starting whonix-setup-wizard from console, it says:\nrun\n\n    kdesudo whonix-setup-wizard repository\n\nSo anon-connection-wizard should say\n\n    kdesudo anon-connection-wizard\n\n?\n\n> like many desktop apps?\n\nDo you know any examples on Whonix?\n\n> # RE: packaging (I'm learning this myself.) I do sudo make deb-icup in the anon_con folder. It builds and installs.\n\nDon't use `sudo make deb-icup`. Just `make deb-icup`. Only the package installation command needs to run as root.\n\n     make help"},{"author":"iry","date_created":1499048437,"date_modified":1499048437,"content":"> It's not clear to me yet in which order configuration files will be parsed.\nDaniel answered this: http://forums.kkkkkkkkkk63ava6.onion/t/torrc-d-is-comming/4041/10\n\n> It's not clear to me yet where we put DisableNetwork 1.\nAccording to Daniel's answer, /etc/tor/torrc has the highest priority in the parsing sequence, which means command lines here will overwrite another lines in other Tor config files. Patirck said \n\n> Should avoid modification of /etc/tor/torrc.\n\nBut does it make sense to put `DisableNetwork 0` in it? Because we know what states in /etc/tor/torrc will be the \"final result\". tor_status module currently used by whonix-setup-wizard and will be used by anon-connection-wizard is also modifying  `DisableNetwork 0`  /etc/tor/torrc .\n\nanon-connection-wizard itself will not modify  `DisableNetwork 0` , instead, it calls tor_status module to do so.\n\n\n"},{"author":"iry","date_created":1499049643,"date_modified":1499049643,"content":"I have a concern that:\n1.  if we put `40_anon-connection-wizard-autogenerated.torrc `in `/etc/torrc.d/`\n2.  the `%include /etc/torrc.d` line is in `/usr/share/tor/tor-service-defaults-torrc`\n\nThen if the user used anon-connection-wizard to generate a file with a proxy config, let's say. And after a while, the proxy setting is no longer needed/valid, there is no obvious way to find previous settings. As a normal user, he/she may examine `/etc/tor/torrc`, but there will be no proxy settings, which may cause a confusing and frustrating debugging process.\n\nOne solution (just a first thought) is to add `%include /path/to/anon-connection-wizard.torrc` in `/etc/tor/torrc`:\nBenifits:\n1. it may give user a hint that some other configurations are in `/path/to/anon-connection-wizard.torrc`\n2. since configs generated by anon-connection-wizard is user's own options, it deserves the same priority as `/etc/tor/torrc`?\nDisadvantage:\n1. `/etc/tor/torrc` is modified by Whonix"},{"author":"iry","date_created":1499090578,"date_modified":1499090578,"content":"Hi @JasonJAyalaP !\n\nI have fixed some bugs you mentioned in the todo list. And I encountered the following problem now:\n>Switch your import tor_status to the commented out line (from anon_ import tor status). This is how whonix-setup-wizard does it at least, and that should solve two problems (not finding the module, module placement error while building).\nI did this, switching from `import tor_status` to `from anon_connection_wizard import tor_status`, however, I got the following error:\n>ImportError: cannot import name 'tor_status'\nI also tried to run the `whonix-setup-wizard` cloned from the current Whonix repository and got the same error. Could you please tell me what I did wrong? Thank you very much!\n\nI also tried to run `make deb-icup` in `anon-connection-wizard` directory, however, I got the following error:\n>E: anon-connection-wizard source: missing-build-dependency-for-dh-addon python2 => \n\n> python | python-all | python-dev | python-all-dev\n> \n> ## BEGIN ERROR in /usr/share/genmkfile/make-helper.bsh detected!\n> ##\n> ## ERROR LOG:\n> ## See above.\n> ##\n> ## BASH_COMMAND: sudo dpkg -i \"$package\"\n> ## EXIT_CODE: 1\n> ##\n> ## END ERROR in /usr/share/genmkfile/make-helper.bsh detected!\n> ## Please report this bug!\n> \nCould you please instruct me on how to build it successfully, or could you please tell me some keywords that I can use to search educational resources online? Thank you very much! \n"},{"author":"Patrick","date_created":1499129365,"date_modified":1499129365,"content":"iry (iry):\n> iry added a comment.\n> \n> \n> I have a concern that:\n> \n> 1. if we put `40_anon-connection-wizard-autogenerated.torrc `in\n> `/etc/torrc.d/` 2. the `%include /etc/torrc.d` line is in\n> `/usr/share/tor/tor-service-defaults-torrc`\n> \n> Then if the user used anon-connection-wizard to generate a file with\n> a proxy config, let's say. And after a while, the proxy setting is no\n> longer needed/valid, there is no obvious way to find previous\n> settings. As a normal user, he/she may examine `/etc/tor/torrc`, but\n> there will be no proxy settings, which may cause a confusing and\n> frustrating debugging process.\n\nIt's a valid concern. But... This goes not only for changes by\nanon-connection-wizard but any configuration that is using `.d`. So not\nreally an issue that can be solved at the level of Whonix /\nanon-connection-wizard?\n\n> One solution (just a first thought) is to add `%include\n> /path/to/anon-connection-wizard.torrc` in `/etc/tor/torrc`: \n\nThis defeats the very purpose for Tor's `.d` support.\n\nThe issue with `%include /path/to/anon-connection-wizard.torrc` in\n`/etc/tor/torrc` is, that it would be non-standard, surprising.\n\n- an `%include` by Debian's `/usr/share/tor/tor-service-defaults-torrc`\n- an `%include` by Whonix's `/etc/tor/torrc`\n\nSolution? Perhaps this...?\n\n- At the very top (?) of `/etc/tor/torrc` as per Debian's default should\nexplain the `.d` folder set up by Debian\n(/usr/share/tor/tor-service-defaults-torrc`).\n- `/etc/tor/torrc` as per Debian's default should discourage users\nmodification of /etc/tor/torrc? And advice users to use `/etc/torrc.d`\n(or whatever folder(s) Debian will set up) since that won't throw dpkg\ninteractive conflict resolution dialogs when `/etc/tor/torrc` gets\nmodified by Debian?\n\nIf that sounds good, could you suggest that in the Debian ticket please?"},{"author":"iry","date_created":1499139257,"date_modified":1499139268,"content":"> If that sounds good, could you suggest that in the Debian ticket please?\n\nSounds like a good plan to me. \nDone: https://trac.torproject.org/projects/tor/ticket/22391#comment:4"},{"author":"Patrick","date_created":1499170368,"date_modified":1499170368,"content":"Wrong ticket.\n\nTor Project Ticket:\nhttps://trac.torproject.org/projects/tor/ticket/2239\n\nDebian Ticket:\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=866187"},{"author":"JasonJAyalaP","date_created":1499207236,"date_modified":1499207236,"content":"@iry\n{F647224}"},{"author":"iry","date_created":1499515549,"date_modified":1499515549,"content":"Hi, Patrick and JasonJAyalaP !\n\nI have made some exciting changes:\n\n- switched from /usr/lib/python3.4 to /usr/lib/python3/dist-packages\n- default settings will be adjusted according to .torrc (anon-con will \"remember\" user's last choices)\n- switch from self-made .tmp file to python tmpfile\n- better instructions and UI\n\n> torrc_orig was just recently invented by @iry used by anon-connection-wizard. We should avoid that file by using /etc/torrc.d.\n\nAgree. torrc.orig is no longer needed.\n\nWith the new change, the only file will be used is `/etc/torrc.d/anon-connection-wizard.torrc`. \n\nMy pull request is here: https://github.com/Whonix/anon-connection-wizard/pull/7\n\nCould you please help me to review it, @JasonJAyalaP ? There is no need to hurry, btw.\n\nThank you very much! I really appreciate your effort and time!"},{"author":"iry","date_created":1499592756,"date_modified":1499592756,"content":"Hi @JasonJAyalaP !\n\nCurrent anon-connection-wizard will complain \"no tor control connected!!!\" and strangely open an application called kde accessible.\n\nThis is because Tor ControlPort 9051 on Whonix-Gateway will not be opened in Whonix14.\nDetails of the change can be found here: https://github.com/Whonix/anon-gw-anonymizer-config/commit/49ce21f97965609e4fe06af20005637878324fcc , which is made by @Patrick .\n\nMy understanding is that no Tor control port by default will reduce the attack surface a little bit. I am not sure how important this reduction is, but if it does help, I am going to let anon-connection-wizard support Tor cookie file authentication to work around the problem. \nCould you please share your opinion on this, Patrick?\n\nCurrently, for testing other features in anon-connection-wizard, one can work around by adding the following control port settings back to ` usr/share/tor/tor-service-defaults-torrc.anondist`:\n\n```\nControlPort 9051\nControlListenAddress 127.0.0.1\n\n```\n\nOther related questions:\n1. do you have any idea on why an application called kde accessible will be open?\n2. do you think it will be a good design to let anon-connection-wziard repair missing control port or other \"dependencies\" ?\n\nThank you very much! I really appreciate your help and feedback!"},{"author":"Patrick","date_created":1499600726,"date_modified":1499600726,"content":"iry (iry):\n> I am going to let anon-connection-wizard support Tor cookie file authentication to work around the problem. \n>   Could you please share your opinion on this, Patrick?\n\nIt's not a workaround. This is the fix. :)\n\n> 1. do you have any idea on why an application called kde accessible\nwill be open?\n\nNo idea.\n\n> 2. do you think it will be a good design to let anon-connection-wziard\nrepair missing control port or other \"dependencies\" ?\n\nNot repair. But kinda. It should bring all it needs.\n\nLet's imagine someone using Debian doing `sudo apt-get install\ntor-connection-wizard`. Or having some distribution that installs\ntor-connection-wizard by default. In that case, it should ship the\nrequired torrc.d snippet.\n\nBut that shouldn't be needed since plain Debian stretch (non-Whonix) by\ndefault adds a Tor `ControlSocket`.\n\nThe issue with plain Debian stretch is, that the user (non-root) account\nis by default not part of the group `debian-tor`, hence will not be able\nto access the Tor `ControlSocket`. This is a usability issue. Adding the\nuser's user account (non-root) to group `debian-tor` will probably not\nbe allowed by Debian policy.\n\nHow to solve this? Start tor-connection-wizard with root rights?\n\nEasy in Whonix - have some anon-meta-package depend on kdesudo. Then\nhardcode kdesudo in tor-connection-wizard's `.desktop` file. But how to\nsolve this in Debian? Not easy due to:\n\n* T22\n* T85\n\nPerhaps ask on the tor-dev mailing list / #tor-dev / contact Debian?"},{"author":"iry","date_created":1499796709,"date_modified":1499796709,"content":">>! In T699#14098, @Patrick wrote:\n> iry (iry):\n>> I am going to let anon-connection-wizard support Tor cookie file authentication to work around the problem. \n>>   Could you please share your opinion on this, Patrick?\n> \n> It's not a workaround. This is the fix. :)\n> \n\nI encountered a bug when trying to fix the issue. I tried to debug it for a long time, but failed. Could you please share some hints on the problem?\n\n@Patrick , @JasonJAyalaP \n\nI tried to add the following line to TorBootstrap Class, the commit is [here](https://github.com/irykoon/anon-connection-wizard/commit/58b43a06ae970da341a0e1065f1163ba02d63ca1):\n(`tor_controller` should be `self.tor_controller`, but the problem is still not fixed)\n```\n\n+        import stem\n+        import stem.control\n+        import stem.socket\n+        from stem.connection import connect\n+\n+        #self.control_cookie_path = '/run/tor/control.authcookie'\n+        #self.control_socket_path = '/run/tor/control'\n+\n+        # Provides a Controller based on a socket file connection\n+        tor_controller = stem.control.Controller.from_socket_file('/run/tor/control')\n+\n+        # Does authentication using cookie\n+        with open('/run/tor/control.authcookie', \"rb\") as f:\n+            cookie = f.read()\n+        tor_controller.authenticate(cookie)\n+\n+        print(tor_controller.get_info(\"status/bootstrap-phase\"))\n+        print(\"Tor is running version {0}\".format(tor_controller.get_version()))\n```\n\nHowever, it complains:\n\n```\nTraceback (most recent call last):\n  File \"/usr/lib/python3/dist-packages/stem/socket.py\", line 442, in _make_socket\n    control_socket.connect(self._socket_path)\nFileNotFoundError: [Errno 2] No such file or directory\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/usr/lib/python3/dist-packages/anon_connection_wizard/anon_connection_wizard.py\", line 1233, in run\n    self.tor_controller = self.connect_to_control_port()\n  File \"/usr/lib/python3/dist-packages/anon_connection_wizard/anon_connection_wizard.py\", line 1219, in connect_to_control_port\n    tor_controller = stem.control.Controller.from_socket_file('/run/tor/control')\n  File \"/usr/lib/python3/dist-packages/stem/control.py\", line 1014, in from_socket_file\n    control_socket = stem.socket.ControlSocketFile(path)\n  File \"/usr/lib/python3/dist-packages/stem/socket.py\", line 425, in __init__\n    self.connect()\n  File \"/usr/lib/python3/dist-packages/stem/socket.py\", line 243, in connect\n    self._socket = self._make_socket()\n  File \"/usr/lib/python3/dist-packages/stem/socket.py\", line 445, in _make_socket\n    raise stem.SocketError(exc)\nstem.SocketError: [Errno 2] No such file or directory\n```\n\n\n\nI tried to run the following script in the same whonix-gateway and it worked fine:\n```\n#!/usr/bin/python3 -u\n# -*- coding: utf-8 -*-\n\nimport os\nimport stem\nimport stem.control\nimport stem.socket\nfrom stem.connection import connect\n\ncontrol_cookie_path = '/run/tor/control.authcookie'\ncontrol_socket_path = '/run/tor/control'\n\nif not os.path.exists(control_cookie_path):\n    print(control_cookie_path + ' not found!!!')            \n\n\n# Provides a Controller based on a socket file connection\ntor_controller = stem.control.Controller.from_socket_file(control_socket_path)\n\n# Does authentication using cookie\nwith open(control_cookie_path, \"rb\") as f:\n    cookie = f.read()\ntor_controller.authenticate(cookie)\n\nprint(tor_controller.get_info(\"status/bootstrap-phase\"))\nprint(\"Tor is running version {0}\".format(tor_controller.get_version()))\n\n```\n\nI also tried to add the code above to the Common Class in anon-connection-wizard.py, and it also worked fine.\n\nMy guess is that I did something wrong related to python Class relationship, however, I am not able to figure out what it was. Could you please help me with that? Thank you very much!\n\n>>! In T699#14098, @Patrick wrote:\n> How to solve this? Start tor-connection-wizard with root rights?\n> \n> Easy in Whonix - have some anon-meta-package depend on kdesudo. Then\n> hardcode kdesudo in tor-connection-wizard's `.desktop` file. But how to\n> solve this in Debian? Not easy due to:\n> \n> * T22\n> * T85\n> \n> Perhaps ask on the tor-dev mailing list / #tor-dev / contact Debian?\nSure! I will be working on this :)\n"},{"author":"iry","date_created":1499944566,"date_modified":1499944566,"content":"> I encountered a bug when trying to fix the issue.\n\nFinally I figured out the problem :)\nIt turns out that: every time tor_status restart the Tor, it takes sometime for Tor to generate the socket which is `/run/tor/control`, therefore, we have to wait for a while until '/run/tor/control' exists and then connect to it.\n\n> I am going to let anon-connection-wizard support Tor cookie file authentication to work around the problem.\n\nDone. Related commit: https://github.com/Whonix/anon-connection-wizard/pull/7/commits/1472d5c5e6e6211f3f3919fbe2305695786eb6fe"},{"author":"iry","date_created":1499945270,"date_modified":1499945499,"content":"tor_status.py module will be in anon-connection-wizard package, instead of whonix-setup-wizard (which will be aborted?).\n\nIn [tor_status.py](https://github.com/irykoon/anon-connection-wizard/blob/1472d5c5e6e6211f3f3919fbe2305695786eb6fe/usr/lib/python3/dist-packages/anon_connection_wizard/tor_status.py), two of the situations are `/etc/tor/torrc` does not exist and `DisableNetwork 0` line does not exist.\n\nMy question is whether we should fix these two situation, instead of just complaining `bad torrc`? Fixing these situations can be fairly easy, the question we should ask is if we should fix these.\n\nNormally, the absent of  `DisableNetwork 0` line or `/etc/tor/torrc` is strange. Therefore, we may inform the user we have helped to fixed the `torrc` because the previous one is missing/broken, however, the one we fixed may not be the one they intended to use.\n\nIf `DisableNetwork 0` line is missing:\n\n1. append `#DisableNetwork 0` or `DisableNetwork 0` to `/etc/tor/torrc`, depending on it is in `set_enabled()` or `set_diabled()`\n\n`/etc/tor/torrc` is missing:\n\n1. create `/etc/tor/torrc`\n2. append `#DisableNetwork 0` to `/etc/tor/torrc`\n\nDo you have any thoughts on this? Thank you very much!"},{"author":"iry","date_created":1499945837,"date_modified":1499945837,"content":"TODO:\n\n1. investigate on why `KDE Accessible` will be open when `kdesudo anon-connection-wizard`\n\nlog:\n\n```\nuser@host:~$ kdesudo anon-connection-wizard\nkdesudo(7566) KDESu::KDESuPrivate::KCookie::getXCookie: No X authentication info set for display  \":0\" \n\nkdesudo(7566) Bridge::setRootObject: \"KAccessibleBridge: setRootObject object=\" \"kdesudo (KApplication)\"\n```\n\nAnd after the expected output from anon-connection-wizard:\n\n```\nkdesudo(7566) Bridge::Private::app: Connected with the org.kde.kaccessibleapp dbus-service\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \" (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \" (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \" (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"prompt (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \" (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \" (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \" (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \" (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"errorMessage (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"anonymousRadioButton (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"usePasswordButton (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"userNameLabel (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"userEdit (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"domainLabel (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"domainEdit (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"passwordLabel (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"passEdit (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"keepCheckBox (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \" (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \" (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"credentialsGroup (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \" (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"KPasswordDialog (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \" (QWidget)\" \"name=\" \"Password  KdeSudo\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"internal clipboard owner (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \"internal clipboard requestor (QWidget)\" \"name=\" \"\"\nkdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \" (QWidget)\" \"name=\" \"\"\n\n```"},{"author":"Patrick","date_created":1499960626,"date_modified":1499960626,"content":"> TODO: can we let Tor generate a cookie to fix this situation?\n\nI doubt that. It should be done by Debian torrc-defaults config already.\nIf the user deactivated that, we shouldn't try to repair such corner cases."},{"author":"Patrick","date_created":1499960923,"date_modified":1499960923,"content":"iry (iry):\n> iry added a comment.\n> \n> \n> tor_status.py module will be in anon-connection-wizard package,\n> instead of whonix-setup-wizard (which will be aborted?).\n> \n> In tor_status.py\n> <https://github.com/irykoon/anon-connection-wizard/blob/1472d5c5e6e6211f3f3919fbe2305695786eb6fe/usr/lib/python3/dist-packages/anon_connection_wizard/tor_status.py>,\n> two of the situations are `/etc/tor/torrc` does not exist and\n> `DisableNetwork 0` line does not exist.\n> \n> My problem is whether we should fix these two situation, instead of\n> just complaining `bad torrc`. Fixing these situations can be fairly\n> easy, the question we should ask is if we should fix these.\n\nUsability wise, I doubt it is useful to ask. A user who messed that up\nlikely does no longer remember and will be confused by the question. And\nall that tor-connection-wizard is doing, is honestly explained to the\nuser. (Enable vs disable Tor vs bridges vs no bridges.)\n\n> Normally, the absent of  `DisableNetwork 0` line or `/etc/tor/torrc`\n> is strange. Therefore, we may inform the user we have helped to fixed\n> the `torrc` because the previous one is missing/broken, however, the\n> one we fixed may not be the one they intended to use.\n\nInformation could be done as a comment within the anon-connection-wizard\nedit markers.\n\n> If `DisableNetwork 0` line is missing:\n> \n> 1. append `DisableNetwork 0` to `/etc/tor/torrc`\n> \n> `/etc/tor/torrc` is missing:\n> \n> 1. create `/etc/tor/torrc` 2. append `DisableNetwork 0` to\n> `/etc/tor/torrc`\n> \n> Do you have any thoughts on this?\n\nYes. Sounds good.\n\n(All of that is, as long we don't learn how exactly torrc.d will be\nworking and when deb.torproject.org will start shipping a stable package\nwith torrc.d enabled by default.)"},{"author":"Patrick","date_created":1499961059,"date_modified":1499961059,"content":"Perhaps removing kde-accessible test wise (create a snapshot so you can\nrevert that) would help to debug this. Because then perhaps another\nthing happens which makes it easier to identify why this is happening.\n\niry (iry):\n>     kdesudo(7566) Bridge::notifyAccessibilityUpdate: \"ObjectDestroyed\" \"object=\" \" (QWidget)\" \"name=\" \"\"\n\nSuch useless messages are often shown when starting KDE apps from the\ncommand line. No matter if you start `kate` or `kdesudo something-else`\nfrom the command line. Probably unrelated and best ignored."},{"author":"iry","date_created":1500025588,"date_modified":1500025588,"content":"> Yes. Sounds good.\n> \n> (All of that is, as long we don't learn how exactly torrc.d will be\n> working and when deb.torproject.org will start shipping a stable package\n> with torrc.d enabled by default.)\n\nI created a new module call [repair_torrc.py](https://github.com/irykoon/anon-connection-wizard/blob/master/usr/lib/python3/dist-packages/anon_connection_wizard/repair_torrc.py) under the anon-connection-wizard packages.\n\nHere is a description from the comments:\n\n\n> repair_torrc() function will be called when we want to gurantee there will be \n> a /etc/tor/torrc file with a \"#DisableNetwork 0\" and \"%include /etc/torrc.d\" line.\n> It will also gurantee there is an existing /etc/torrc.d/ directory\n\nSo far, anon-connection-wizard.py and tor_status.py will use that module. However, user can also use it to fix torrc related issue manually. \n\nThe repair is based on the assumption that:\n`%include /etc/torrc.d` will go to tor `.deb package`.\nIf that is not ture enventually, I can adjust the code to fit the real torrc situiation."},{"author":"iry","date_created":1501513821,"date_modified":1501513899,"content":"Hi @JasonJAyalaP !\n\nCould you  help me review my new [pull request](https://github.com/Whonix/anon-connection-wizard/pull/7) please ?\n\nIt seems anon-connectioin-wizard itself is mature enough to work as a standalone application. However, I am not sure if it will be a better idea to integrate it with or replace it to whonix-setup-wizard before merging my pull request. Could you please share your idea on this? Thank you very much for your time and efforts!\n\nNew features:\n\n- create a censorship circumvention help button with detailed instructions\n- check invalid input and make warnings\n- add instructions to proxy help button\n- redesign the torrc page based on Linda's [paper](https://petsymposium.org/2017/papers/issue3/paper2-2017-3-source.pdf)\n\nOther improvement:\n\n- adjust label positions\n- use bigger and more general fonts"},{"author":"Patrick","date_created":1501521407,"date_modified":1501521407,"content":"Review is in progress."},{"author":"joysn1980","date_created":1501646074,"date_modified":1501646074,"content":"@iry  Can you please let me know how to run your scripts in whonix13? The steps which I require to run/test your modified scripts. I could pull your changes to my local branch. But how do I run them?"},{"author":"Patrick","date_created":1501668773,"date_modified":1501668773,"content":"Forget about Whonix 13."},{"author":"iry","date_created":1501680068,"date_modified":1501680068,"content":"Hi @joysn1980 !\n\nI wish you had not started viewing my previous code. Because a huge amount of changes have been made to anon-connection-wizard, especially in terms of UX:\n\n- hide username and password input when SOCKS4 is selected\n- different bridge settings will not show up at the same time\n- merge the proxy_wizard_page_1 into proxy_wizard_page_2\n- redesign the proxy_page_2\n- merge the bridge_wizard_page_1 into bridge_wizard_page_2\n- redesign the bridge_page_2\n- set fixed size window\n- change the default summary info\n\nOther improvement includes:\n\n- fix several logic flaws in showing warning message\n- fix bug that /etc/tor/torrc accumulates '\\n'\n\nHere is my [pull request](https://github.com/Whonix/anon-connection-wizard/pull/7) and you probably need to pull it again if you did that before. I apologize if there is any inconvenience I caused.\n\n> Can you please let me know how to run your scripts in whonix13?\n\nHere is the Whonix wiki that you may find helpful when trying to upgrade to Whonix14: http://www.kkkkkkkkkk63ava6.onion/wiki/Upgrading_Whonix_13_to_Whonix_14\n\n> The steps which I require to run/test your modified scripts. I could pull your changes to my local branch. But how do I run them?\n\nGood question! Here is the steps worked for me:\n\n1. [upgrade](http://www.kkkkkkkkkk63ava6.onion/wiki/Upgrading_Whonix_13_to_Whonix_14) to Whonix14\n2. out commented the `#deb http://deb.torproject.org/torproject.org tor-nightly-master-jessie main` in `/etc/apt/sources.list.d/torproject.list`\n3. `sudo apt-get update` to update Tor to nightly version\n4. `tor --version` : Tor version > 0.3.1.1-alpha-dev\n5. `git clone https://github.com/irykoon/anon-connection-wizard.git`\n6. `cd anon-connection-wizard`\n7. copy all the `./directory` to `/directory`, for example, `cp ./usr/lib/python3/dist-packages/anon_connection_wizard /usr/lib/python3/dist-packages/anon_connection_wizard`\n8. `sudo anon-connection-wizard` to run it\n\nThank you very much for spending your time and effort in reviewing my code, @joysn1980 !\n\nI really appreciate your help!\n\nPlease let me know if there is anything else that I can help with! :)"},{"author":"iry","date_created":1501680343,"date_modified":1501680343,"content":"> copy all the ./directory to /directory, for example, cp ./usr/lib/python3/dist-packages/anon_connection_wizard /usr/lib/python3/dist-packages/anon_connection_wizard\n\nThis is probably not the proper way to install it. But I have not figured out how to package it as .deb"},{"author":"joysn1980","date_created":1501682214,"date_modified":1501682230,"content":"Thanks @iry \n\n> This is probably not the proper way to install it. But I have not figured out how to package it as .deb\nmake deb-icup\n\nI will get back to you if I need anything. First run looked awesome!!\n"},{"author":"Patrick","date_created":1501687092,"date_modified":1501687092,"content":"Packaging is sorted out.\n\n* requires Debian stretch based Debian or Whonix 14\n* https://github.com/Whonix/genmkfile needs to be installed\n* `make deb-pkg` builds a package\n* `make deb-icup` builds a package, installs it and cleans up\n* see also `make help`"},{"author":"joysn1980","date_created":1501867643,"date_modified":1501867643,"content":"@iry - Is there any reason why the all windows doesn't have \"X\" at the top right corner even though they have \"cancel\" button?\nThere are some windows with \"X\" at the top and some doesn't.\nIs it fine to have a \"X\" button for all windows which can be either \"Cancel\"led or \"OK\"ayed?\n> Does not have \"X\"\n{F696137}\n\n> have \"X\" at the top right corner\n{F696138}"},{"author":"iry","date_created":1501955225,"date_modified":1501955276,"content":"Hi @joysn1980 !\n\nI have enabled the \"X\" button and fixed some quit-program related issues.\n\n> Is there any reason why the all windows doesn't have \"X\" at the top right corner even though they have \"cancel\" button?\n\nNot anymore. In the past we disabled/hide the close button as a work around that forced user to use cancel button. However, since now clicking cancel button and clicking close button share the same result, we can enable close button. This also gives user a feeling of control.\n\nThank you very much for your feedback!"},{"author":"joysn1980","date_created":1502254845,"date_modified":1502254888,"content":"Thanks @iry \n\n@iry  and @Patrick \n\n3 screen shots here - one after another\n\n**Screen 1**\n{F821468}\n\n**Screen 2**\n{F821471}\n\n**Screen 3**\n{F821474}\n\nThe question is\nIn **Screen 3**, should we have a back button? \nI think \"No, we shouldn't\". \n\nRight now. if we click on \"Back\" it goes to **Screen 2**, I think that is also not correct\n\nSuggestion:- Instead, we can have something like \"Home\", when clicked it should go to the **Screen **1.\n\nAlso, we need to update the text accordingly. Right now it says - \"Press the Back button and select another option\"\n\n\n\n\n"},{"author":"iry","date_created":1502292644,"date_modified":1502292644,"content":"Hi @joysn1980 !\n\nThank you very much for your feedback.\n\nI agree with you that there was something wrong with the process when disable_tor is selected. Since Screen2 did not really provide any useful information, I have let anon-connection-wizard skip the torrc_page (Screen2) when disable_tor option is selected. This fix will simplify the configuration which increase the usability.\n\nI appreciate your valuable feedback!\n\nBtw, from the screenshot, the close button problem seems to be unfixed. Is it true, or it is just because you were not using the latest anon-connection-wizard? I am using Qubes OS which will provide a window-wrapper with close button, therefore, I have no idea whether the bug is really fixed."},{"author":"iry","date_created":1502292667,"date_modified":1502292667,"content":"Several termination-related problems have been fixed or improved:\n\n- make the consequences of clicking close button same with clicking the cancel button\n- enable close button\n- recover Tor to the initial tor status when quiting or canceling\n- fix \"Thread termination error\n\nOther improvement include:\n\n- eliminate outdated code that may cause IO error\n- skip torrc_page when disable_tor option is selected\n"},{"author":"joysn1980","date_created":1502362356,"date_modified":1502362888,"content":"@iry \n\nThanks for all the updates\n\nYes I was using old one. That is why my comments were no more on the same issue.\n\nI got your new code now. I see following issues\n1) Close Button is now enabled. So this issue is now **resolved**\n2) No error checking done for Ip Address and Port fields. It is expected that \na) port field should be between 1-65535 only whole numbers, Right now everything entered is accepted\nb) ipaddress - some checks on the format would be useful too.\n{F840217}\n\n3) Do you know why are we seeing Unsupported types when we enter custom bridge?\n{F840222}\n\n4) https://bridges.torproject.com/ is not accessible. Is it correct website?\n\nThanks\nJoy"},{"author":"joysn1980","date_created":1502363391,"date_modified":1502363391,"content":"@iry \n\nOne more issue\n1) Click on configure\n2) Choose obfs4\n3) Next (do not choose proxy)\n4) Next - Here we get the summary showing \"Bridges\" Provided Pbfs4\"\n5) Now go \"Back\", \"back\" twice and now choose \"enter custom bridges\".\n6) Next, Next. Now see the summary pages. \"Bridges:\" info is not refreshed. It is still showing the old value. \n\n"},{"author":"iry","date_created":1502385031,"date_modified":1502385031,"content":"Hi @joysn1980 !\n\nThank you very much for your detailed feedback!\n\n> No error checking done for Ip Address and Port fields. It is expected that \n> a) port field should be between 1-65535 only whole numbers, Right now everything entered is accepted\n> b) ipaddress - some checks on the format would be useful too.\n\nAgreed. Since it is the same issue with the above one, I will explain them together.\n\n> Do you know why are we seeing Unsupported types when we enter custom bridge?\n\n> Next, Next. Now see the summary pages. \"Bridges:\" info is not refreshed. It is still showing the old value.\n\nThese two problems were actually the same issue, which were also related to the input validation check. This happened when you were using a custom bridge but failed to provide a valid one. Specifically, this happened when the input started without \"obfs3\" or \"obfs4\". I have fixed the \"still showing the old value\" problem, now it will show `\"ERROR: Unsupported bridge type\"`.\n\nHowever, it is not the final fix. The eventual solution will be preventing user who has entered an invalid bridge from going to the next page. This solution needs a well-written regular expression to check the validation of the input.\n\n1. For Port number and custom bridges, it won't be too hard.\n2. For valid IP address input check, the difficulty is that it also allows hostname, causing a valid can be almost anything.\n\nTor launcher solved the problem by not checking the input validation by Tor launcher. Instead, Tor launcher will listen to the Tor log. If the following complains happen, Tor launcher will pop up a warning and redirect the users to related setting pages:\n\n\n```\n[WARN] Too few items to Bridge line. \n[WARN] Controller gave us config lines that didn't validate: Bridge line did not parse. See logs for details. \n[WARN] Error parsing Bridge address 'fdsgsdhghr' \n```\nor\n\n```\n\n[WARN] Controller gave us config lines that didn't validate: HTTPSProxy failed to parse or resolve. Please fix. \n[WARN] Controller gave us config lines that didn't validate: Socks4Proxy failed to parse or resolve. Please fix. \n[WARN] Controller gave us config lines that didn't validate: Socks5Proxy failed to parse or resolve. Please fix. \n\n```\n\nI will try to find out the best solution to this problem :)"},{"author":"iry","date_created":1502385827,"date_modified":1502385827,"content":"I am thinking about integrating three pages into one, which are the main connection page, bridge setting page and proxy page. It seems that this is also the design by TPO UX team.\n\nBy doing so, it brings a great number of benefits:\n\n1. simplify the configuration process, leading to better UX. For example, if the user realize a reconfigure in bridge setting, he/she does not need to go back to the previous page to reconfigure it.\n2. code is much simpler to extend and maintain because of much less code amount and simpler logic. For example, the input invalidation check problem above can be easily handled by Tor log complain without worrying about the check before going to next page .  \n3. summary page may be removed since all the settings are presented in one page, a summary seems to be redundant? However, show torrc file function will be also removed.\n\nAny thoughts and insights on this will be much appreciated!"},{"author":"joysn1980","date_created":1502429608,"date_modified":1502429704,"content":"Thanks @iry  for the detail explanation.\n\nThat is correct. This is how it was showed by the UX team. I think this will be good. All in same page, so validation and other stuff will be quite easy to handle\n\n{F840283}\n{F840287}\n\nAlso I see that here we have something like B4 - i.e. requesting from a bridge. I didn't notice it in your UI. Is it implemented?\n\nOne more question, is this part not in your code [from the UX team screen shots]?\n{F840285}\n"},{"author":"iry","date_created":1502476565,"date_modified":1502476565,"content":"Hi @joysn1980 !\n\n> That is correct. This is how it was showed by the UX team. I think this will be good. All in same page, so validation and other stuff will be quite easy to handle\n\nAgreed!\n\n> Also I see that here we have something like B4 - i.e. requesting from a bridge. I didn't notice it in your UI. Is it implemented?\n> \n> One more question, is this part not in your code [from the UX team screen shots]?\n> {F840285}\n\nIt seems that they are the same question. So far, I have not implemented the feature. Here is a discussion on the implementation of this feature: http://forums.kkkkkkkkkk63ava6.onion/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/291\n\n(I am sorry for my cross-posting that caused you did not notice it.)\n\n\n> https://bridges.torproject.com/ is not accessible. Is it correct website?\n\nThe URL should be: https://bridges.torproject.org/\n\nDid you find the `.com` URL anywhere in the anon-connection-wizard? Because I did an overhaul which indicated all the related URL did appear to be `.org`.\n\nAgain, thank you very much for your feedback, @joysn1980 !\nI understand that testing out all the hard-to-notice bugs can be very time and effort consuming! So I really appreciate your help!"},{"author":"joysn1980","date_created":1502600949,"date_modified":1502600949,"content":"Thanks @iry \n\nMy mistake, it was indeed .org. \nbtw, I now see the url as https://bridges.torproject.org/options, which seems perfect\n\nOne small request - is it possible to make the first 4 characters of the bridge case insensitive?\nExample:\n> obfs4 109.109.202.103:44514 C52DA34113488533340ECDDBEA7DA4FABEEE7A39 cert=FzzNqEIGM39D3Zb2SdVZFA8K//xx4N82zkmfiWM8MceuChlsNZ9eOSN0jRAjiYR801sAFQ iat-mode=0\n> \nas well as\n\n> OBFS4 109.109.202.103:44514 C52DA34113488533340ECDDBEA7DA4FABEEE7A39 cert=FzzNqEIGM39D3Zb2SdVZFA8K//xx4N82zkmfiWM8MceuChlsNZ9eOSN0jRAjiYR801sAFQ iat-mode=0\n\nshould work. You can handle this in your code by making the first 4 character case insensitive.\nIf you think that is really not the case, let me know.\n\nLet me know when you consolidate the pages and implement some basic error checks - the ones which are feasible - like port #s etc.\nI will give your code another try\n\n"},{"author":"iry","date_created":1502995397,"date_modified":1502995397,"content":"> One small request - is it possible to make the first 4 characters of the bridge case insensitive?\n> Example:\n>> obfs4 109.109.202.103:44514 C52DA34113488533340ECDDBEA7DA4FABEEE7A39 cert=FzzNqEIGM39D3Zb2SdVZFA8K//xx4N82zkmfiWM8MceuChlsNZ9eOSN0jRAjiYR801sAFQ iat-mode=0\n>> \n> as well as\n> \n>> OBFS4 109.109.202.103:44514 C52DA34113488533340ECDDBEA7DA4FABEEE7A39 cert=FzzNqEIGM39D3Zb2SdVZFA8K//xx4N82zkmfiWM8MceuChlsNZ9eOSN0jRAjiYR801sAFQ iat-mode=0\n> \n> should work. You can handle this in your code by making the first 4 character case insensitive.\n\nThank you very much for your careful examination! I have fixed this bug :)\n\n> Let me know when you consolidate the pages and implement some basic error checks - the ones which are feasible - like port #s etc.\n> I will give your code another try\n\nThank you! I have made several [changes](https://github.com/Whonix/anon-connection-wizard/pull/7), however, you do not need to review them right now since all of them are minor changes :)\n\nChanges details:\n\nSeveral bridge and bridge type related changes have been made:\n\n- Warn unsupported bridge type in summary page\n- Update unsupported bridge type warning in summary page\n- Make bridge types case insensitive\n- Update custom bridge help instructions\n- Update default bridges\n\nOther changes include:\n- Update the initial comments for anon-connection-wizard.torrc"},{"author":"joysn1980","date_created":1503406154,"date_modified":1503406165,"content":"sorry @iry  I have been busy lately, will get back to you very soon on this"},{"author":"joysn1980","date_created":1503559646,"date_modified":1503559646,"content":"Hi @iry \nDid you by any chance forgot to add verifications for the port#? I still see non-numbers, -ve numbers etc are accepted\n\n{F844039}\n\nThanks"},{"author":"joysn1980","date_created":1503560197,"date_modified":1503560197,"content":"Hi @iry \n\nTwo screen shots below to disable Tor. \n**Screen 1**\n{F844041}\n\n**Screen 2**\n{F844043}\n\n**Suggestions**\n1) Do you think it is good to have a warning message from screen 1 to screen 2?\n2) Do you think it will good to rename the \"back\" button in screen 2 to \"Reconfigure\" and probably \"Finish\" to \"Exit\"? Trying to make them more intuitive.\n\nThanks"},{"author":"iry","date_created":1503723368,"date_modified":1503723368,"content":"Hi @joysn1980 !\n\nThank you very much for your feedback!\n\n>  Did you by any chance forgot to add verifications for the port#? I still see non-numbers, -ve numbers etc are accepted\n\nThank you for your testing! It should have been fixed now!\n\n> 1. Do you think it is good to have a warning message from screen 1 to screen 2?\n\nDo you think it is needed because users need a transitional stage to think about it twice? I personally think it is better not to do so for efficiency. Additionally, accidentally choosing this option causing Tor disabled seems not to be a big deal? Because the user can simply press \"Back\" to go back?\n\n> 2. Do you think it will good to rename the \"back\" button in screen 2 to \"Reconfigure\" and probably \"Finish\" to \"Exit\"? Trying to make them more intuitive.\n\nI am not sure if it is because I am too familiar with these two button, but I personally find `Back` and `Finish` more intuitive.:\n`Back` will let users know they will go back to previous page;\n `Exit`, to me, gives a potential doubt on whether my decision will be taken or will be canceled.  \nWhat do you think? Does my argument make sense?\n\nThank you very much!"},{"author":"iry","date_created":1503724359,"date_modified":1503724359,"content":"TODO:\n\n- when parsingTorrc() parses a corrupt file, it will get an out-of-bound error, causing anon-connection-wizard can not be started. We need to give up parsing.\n\n- RE to check input validation (Current implementation is not using regular expression, which means it is not the perfect validation check. However, it is good enough to prevent most common input mistakes.)"},{"author":"iry","date_created":1503867732,"date_modified":1503867732,"content":"Hi @joysn1980 and @Patrick !\n\nI was trying to complete the final evaluation of GSoC, which requires:\n> a short description of what work was done, what code got merged, what code didn't get merged, and what's left to do\n\nIt seems no code written in the summer has been merged into Whonix repository.\n\nDo you think it will be okay to merge my pull request ? I will still be working on anon-connection-wizard.\n\nThank you very much for your time and effort!"},{"author":"Patrick","date_created":1503910467,"date_modified":1503910467,"content":"Consider it all merged, if possible.\n\nDo we have some deadline for it?"},{"author":"joysn1980","date_created":1503933388,"date_modified":1503933388,"content":"https://github.com/Whonix/anon-connection-wizard/pull/7\nmerged"},{"author":"iry","date_created":1503935360,"date_modified":1503935360,"content":"> https://github.com/Whonix/anon-connection-wizard/pull/7 merged\n\nThank you very much for your work, @joysn1980 !\n\n> Do we have some deadline for it?\n\nThe due of the final evaluation of GSoC is within 24 hours. But since it has been merged, case resolved :)"},{"author":"Patrick","date_created":1503961258,"date_modified":1503961258,"content":"Great! Please create new tickets for follow-ups or future work."}]},"PHID-TASK-auiigwwuph2vzeutzamd":{"id":"698","title":"check Qubes-Whonix compatilbity with Qubes 4.0","status":"resolved","priority":"Normal","author":"Patrick","description":"TODO:\n\n* test wise upgrade to Qubes R4.0\n* see if upgrading Whonix whonix-gw and whonix-ws TemplateVMs is still functional\n* see if apt-get package installation in sys-whonix / anon-whonix is still functional\n* run whonixcheck\n* check Tor Browser connectivity\n\nSee also:\nhttps://github.com/QubesOS/qubes-issues/issues/1854#issuecomment-304536463\n","comments":[{"author":"cendragon","date_created":1506242607,"date_modified":1506242607,"content":"Well, after a lot of work, its ALIVE!\nI can update the whonix-gw and whonix-ws templates through sys-whonix proxy\nwhonixcheck works in sys-whonix and anon-whonix\nTor browser works in anon-whonix\n\nThe biggest problem was getting the templateVMs to update due to changes (and bugs) in Qubes R4.0\n\n  - All Template Updates in Qubes R4.0 are hardcoded to go to sys-net.  See https://github.com/QubesOS/qubes-issues/issues/3118  \n  - Dom0 policy needs to be updated to send to sys-whonix. Note ALL template VM updates will now go through tor (except dom0 updates)\n  - torified-updates-proxy-check is incorrect. Needs to be:\n> curl_output=\"$(UWT_DEV_PASSTHROUGH=\"1\" curl --silent --connect-timeout 10 -x \"${PROXY_SERVER}\" http://10.137.255.254/)\" || true\n  - This gets overwritten every time qubes-whonix is updated\n  - After edit, restart `qubes-whonix-torified-updates-proxy-check.service`\n  "},{"author":"Patrick","date_created":1506257112,"date_modified":1506257112,"content":"Did you see the pull requests to the `qubes-whonix` package that Marek recently submitted which I then merged and uploaded to Whonix `jessie-proposed-updates` repository?\n\nhttps://github.com/Whonix/qubes-whonix/commits/Whonix13\n\nCould you try these please? I guess soon it's time to migrate that package into the stable `jessie` repository."},{"author":"marmarek","date_created":1506263705,"date_modified":1506263705,"content":"As for policy for updates proxy, see this: https://github.com/QubesOS/qubes-mgmt-salt-dom0-virtual-machines/commit/977362ee27ccc116512fc428c0807063600655cc\n\nIt's done automatically on fresh install (rc2+), but if you update from rc1, you need to launch it manually: `qubesctl state.sls qvm.whonix-gw` (and same for whonix-ws)."},{"author":"cendragon","date_created":1506376050,"date_modified":1506376050,"content":"@marmarek The salt stuff helped a lot.  It does force a strict naming convention though. And becomes more difficult to add my own cloned template of whonix-ws.  But I figured out how to create my salt files and it worked out. \n\nOut of curiosity, where is the R4.0 rc2 download for fresh install?\n\n\n@Patrick I was working with jessie-proposed-updates, but was getting an empty response with the curl command in the default scripts.  However, either with the salt configurations above or rebooting several times, the default scripts now work without modification\n\nEven if you don't move them to the jessie repository, it might be good to regenerate the whonix-templates with that script. "},{"author":"marmarek","date_created":1506381368,"date_modified":1506381368,"content":">>! In T698#14580, @cendragon wrote:\n> Out of curiosity, where is the R4.0 rc2 download for fresh install?\n\nThere is none yet. You can build it yourself for now...\n\n> Even if you don't move them to the jessie repository, it might be good to regenerate the whonix-templates with that script. \n\nWill do."},{"author":"Patrick","date_created":1506519180,"date_modified":1506519180,"content":"jessie-proposed-updates repository merged into jessie repository and uploaded."},{"author":"Patrick","date_created":1513627053,"date_modified":1513627053,"content":"`apt-get apt-transport-tor broken in Qubes R4 non-networked TemplateVMs #3403`\nhttps://github.com/QubesOS/qubes-issues/issues/3403\n\nBesides, all other issues are sorted."}]},"PHID-TASK-3yrtbbxdopol6abzwfgu":{"id":"697","title":"sort out meta packages compatiblity with Qubes 3.2 and Qubes R4.0","status":"resolved","priority":"Normal","author":"Patrick","description":"references:\n\n* https://github.com/QubesOS/qubes-issues/issues/2572\n* https://github.com/QubesOS/qubes-issues/issues/2572#event-1137442401\n* https://github.com/marmarek/qubes-builder-debian/commit/b18358e19eda0eba8ae14f79a278df2f5cf198fc","comments":[{"author":"marmarek","date_created":1505089516,"date_modified":1505089516,"content":"https://github.com/Whonix/qubes-whonix/pull/4"},{"author":"Patrick","date_created":1505134385,"date_modified":1505134385,"content":"From part `(<< 4.0.0-1)` what does `<<` do?\n\nThe `qubes-core-agent (>= 2.1.60),` a few lines earlier can and should be kept for compatibility?"},{"author":"marmarek","date_created":1505134744,"date_modified":1505134744,"content":"According to [debian policy](https://www.debian.org/doc/debian-policy/ch-relationships.html), `<<` is the syntax for \"strictly older than\". \n\nAs for qubes-core-agent >= 2.1.60 - Qubes 2 is EOL, but technically this dependency isn't implied by any other here. So yes, I'd keep it."},{"author":"Patrick","date_created":1505148135,"date_modified":1505148135,"content":">>! In T697#14519, @marmarek wrote:\n> https://github.com/Whonix/qubes-whonix/pull/4\n\nMerged.\n\nPlease see comment:\nhttps://github.com/Whonix/qubes-whonix/pull/4#issuecomment-328585445\n\nI guess once ^ is sorted, I gotta upload the new package."},{"author":"marmarek","date_created":1505159143,"date_modified":1505159162,"content":"Done: https://github.com/Whonix/qubes-whonix/pull/5\nNote that I've created PR against Whonix13 branch instead of master intentionally. While it should be mergeable to master too, it would be good to have it in Whonix13. The current version from master branch is already incompatible with Whonix 13."},{"author":"Patrick","date_created":1505177873,"date_modified":1505177873,"content":">>! In T697#14524, @marmarek wrote:\n> Done: https://github.com/Whonix/qubes-whonix/pull/5\n\nMerged.\n\n> Note that I've created PR against Whonix13 branch instead of master intentionally. While it should be mergeable to master too, it would be good to have it in Whonix13. The current version from master branch is already incompatible with Whonix 13.\n\nI couldn't merge / cherry-pick it. Manually emulated.\n\nhttps://github.com/Whonix/qubes-whonix/commit/9a8d4b94865efceec7928d5498260a44241d96b2\n\nCould you check please the master branch has it all? (Because that will go into Whonix 14.)\n\n`Whonix13` branch i.e. `qubes-whonix` `5.7.2.1-1` uploaded to Whonix `jessie-proposed-updates` repository."},{"author":"Patrick","date_created":1505177919,"date_modified":1505177919,"content":">>! In T697#14525, @Patrick wrote:\n> `Whonix13` branch i.e. `qubes-whonix` `5.7.2.1-1` uploaded to Whonix `jessie-proposed-updates` repository.\n\nDoes this sort out this Qubes 4.0 Qubes-Whonix blocker?"},{"author":"marmarek","date_created":1505178774,"date_modified":1505178774,"content":">>! In T697#14525, @Patrick wrote:\n>>>! In T697#14524, @marmarek wrote:\n>> Done: https://github.com/Whonix/qubes-whonix/pull/5\n> \n> Merged.\n> \n>> Note that I've created PR against Whonix13 branch instead of master intentionally. While it should be mergeable to master too, it would be good to have it in Whonix13. The current version from master branch is already incompatible with Whonix 13.\n> \n> I couldn't merge / cherry-pick it. Manually emulated.\n> \n> https://github.com/Whonix/qubes-whonix/commit/9a8d4b94865efceec7928d5498260a44241d96b2\n> \n> Could you check please the master branch has it all? (Because that will go into Whonix 14.)\n> \n> `Whonix13` branch i.e. `qubes-whonix` `5.7.2.1-1` uploaded to Whonix `jessie-proposed-updates` repository.\n\nLooks good.\n\n\n\n>>! In T697#14526, @Patrick wrote:\n>>>! In T697#14525, @Patrick wrote:\n>> `Whonix13` branch i.e. `qubes-whonix` `5.7.2.1-1` uploaded to Whonix `jessie-proposed-updates` repository.\n> \n> Does this sort out this Qubes 4.0 Qubes-Whonix blocker?\n\nI'll build a new template and test again. But from my testing of my local build before making PR, it should."}]},"PHID-TASK-3ay6bl6yto3ps6iiffj3":{"id":"696","title":"32-bit OpenJDK on 64-bit Stretch","status":"wontfix","priority":"Normal","author":"HulaHoop","description":"According to a user report 64-bit OpenJDK requires the clflush instruction to work. clflush is removed to make rowhammer and sidechannel attacks more difficult. Whonix 14 will be 64-bit and so a workaround like running 32bit OpenJDK is needed as a workaround to preserve this protection.\n\nTO-DO: Test instructions forinstalling 32-bit OpenJDK on a 64-bit Debian when an RC image is available.\n\n[0] https://forums.whonix.org/t/64-bit-openjdk-fails-to-run/3514/9\n\n\nIf the following succeeds, change all OpenJDK installation documentation on the wiki to reflect it:\n\nsudo dpkg --add-architecture i386\nsudo apt-get update\nsudo apt-get install openjdk-8-jre-headless:i386\nsudo /usr/sbin/update-java-alternatives -s java-1.8.0-openjdk-i386","comments":[{"author":"HulaHoop","date_created":1518419308,"date_modified":1518419308,"content":"Tested it on Whonix 14. It works after updating the binary paths to use i386.\nThis is a viable workaround considering Debian won't remove i386 archives. @Patrick How close is this event in your opinion? Do you think this fix is worth  keeping over time?\n\n\nhttps://serverfault.com/a/835273\n\nsudo /usr/sbin/update-java-alternatives -s java-1.8.0-openjdk-i386"},{"author":"Patrick","date_created":1518426603,"date_modified":1518426603,"content":">>! In T696#15475, @HulaHoop wrote:\n> This is a viable workaround considering Debian won't remove i386 archives. @Patrick How close is this event in your opinion?\n\nI have no idea.\n\n> Do you think this fix is worth  keeping over time?\n\nIf users asks about it, maybe.\n\nAlso not really a Whonix specific issue."},{"author":"HulaHoop","date_created":1518451755,"date_modified":1518451755,"content":"\n\n\n\n> Also not really a Whonix specific issue.\n\n\n\nTrue but if its a hassle I can just white-list clflush again and forget about the whole thing."},{"author":"Patrick","date_created":1518872202,"date_modified":1518872202,"content":"I have no idea what's best here."},{"author":"HulaHoop","date_created":1526472069,"date_modified":1526472069,"content":"I went ahead and reverted clflush restrictions to open the way for I2P by default without extra fiddling needed."}]},"PHID-TASK-4mgoyiickjv37iyydpvg":{"id":"695","title":"Whonix running as Qubes DispVM uses saved clock","status":"wontfix","priority":"High","author":"anon5577","description":"Description:\n\nWhen running as Qubes DispVM, whonix-ws sometimes (often) does not set the clock correctly, but instead seems to restore the date/time from when the DispVM savefile was created.\n\nI have seen this often, over a very long period, but always assumed it had to do with my DispVM customisation. This time, I set up a clean Qubes R3.2, updated whonix-gw template and created a DispVM without customisation. The problem still occurs.\n\nI usually don't find out until I start getting OCSP errors due signatures being in the future. But this means that most likely a lot of earlier browsing has been correlateable since it all had the same wrong clock, therefore I set the priority of this ticket to high since it is a possible anonymity leak.\n\nRecreating the DispVM savefile gets a more up-to-date clock in DispVMs launched afterwards.\n\nSteps to reproduce:\n* Install Whonix templateVM on Qubes\n* Update the template (through qubes manager GUI action) and shut it down\n* qvm-create-default-dvm whonix-ws\n* Wait a couple of days\n* Launch DispVM, start getting OCSP time errors on browsing. Note that system time is wrong.\n\n","comments":[{"author":"Patrick","date_created":1498755366,"date_modified":1498755366,"content":"@marmarek this is probably due to Qubes current DispVM savefile implementation? It should fix itself in Qubes R4.0 since DispVM implementation changed there?"},{"author":"anon5577","date_created":1499437714,"date_modified":1499437714,"content":"This does not seem to happen every time, strangely enough. It seems sdwdate should call qubes.GetRandomizedTime as a post-suspend action if I read this correctly. So I guess under some circumstances that step does not run.\n\nI am currently investigating this issue further, running a loop on dom0 that creates DVMs, checks time and leaves it running if the time is outside acceptable range.\n\nI'll comment here if something comes of it."},{"author":"marmarek","date_created":1499451236,"date_modified":1499451236,"content":"Yes to both of you:\n - should just work on Qubes 4.0 (savefiles are not used there anymore)\n - calling qubes.GetRandomizedTime as post-suspend action would fix that too"},{"author":"Patrick","date_created":1500825973,"date_modified":1500825973,"content":"Unless someone else will be taking this one...\n\nTime wise only possible solution currently: wait for Qubes 4.0.\n"},{"author":"awokd","date_created":1509469519,"date_modified":1509469519,"content":"I didn't notice this bug earlier but caught a reference in one of the Qubes mailing list discussions. For what it's worth, I got this to function under Qubes 3.2 by deleting the sdwdate systemd unit files. It has been a while but I think I did that in the whonix-ws template. The dispvm appears to call bootclockrandomization on every start so time correlation is avoided and I no longer encounter times off by 2+ weeks.\n\nWould it be helpful if I started from a fresh whonix-ws template and documented the exact steps I followed for 3.2? It's possible there's some attack I haven't thought of."},{"author":"Patrick","date_created":1509481797,"date_modified":1509481797,"content":"Qubes-Whonix DispVMs won't get any more development attention in Qubes\nR3.2 because so much has changed. Please look into Qubes R4."}]},"PHID-TASK-vu6pszeftsvzmtq7ykbp":{"id":"694","title":"Gajim as default messenger","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"It would be a huge advance in usability if Whonix had a pre-installed IM client. Gajim, though not perfect, is by far the best choice.\n\nNotes on our wiki https://www.whonix.org/wiki/Dev/Gajim\n\nIt seems that stream isolation is the only blocker to including it. We can discuss that here or on the forums (https://forums.whonix.org/t/should-strict-stream-isolation-by-a-requirement-in-whonixs-default-appliation-policy/3940), but I'm thinking that \"stream isolation as a requirement\" keeps our hands clean in the event of a highly sophisticated attack, while letting our users fumble in in the dark (such as installing pidgin, or installing gajim but not configuring it) or giving up.\n\n    gajim python-nbxmpp gajim-omemo gajim-httpupload\n\nhttps://forums.whonix.org/t/gajim-messenger","comments":[{"author":"Patrick","date_created":1529821687,"date_modified":1529821687,"content":"https://github.com/Whonix/anon-apps-config/commit/55901b6e45fe6dc818c03e3264bcfd4f3e08325d\n"}]},"PHID-TASK-qjewuk223mmml4lf3sgt":{"id":"693","title":"apt-get wants to autoremove everything","status":"invalid","priority":"Normal","author":"JasonJAyalaP","description":"On GW and WS, apt-get wants to autoremove unneeded packages, which is.... EVERYTHING.\n\nWhat's going on here?","comments":[{"author":"Patrick","date_created":1497642126,"date_modified":1497642126,"content":"Exact apt-get command required.\n\nSee also:\n\nhttps://www.whonix.org/wiki/Whonix_Debian_Packages"},{"author":"JasonJAyalaP","date_created":1497655995,"date_modified":1497655995,"content":"False alarm. I thought the \"autoremove\" \"no longer necessary\" message was not tied to the current command (When I was looking at removing baloo).\n\nHmm but apt-get upgrade shows that alsa-base isn't required. "}]},"PHID-TASK-o2v7obtb6xaewgn23rum":{"id":"692","title":"[Discuss] 128MB ram gateway no longer works. 256 new minimum?","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"I just ran a fresh copy of gateway 14 with 128 ram in console mode (which is suggested by the ova warning for systems under 2GB). There were memory errors and crashes during the first whonixcheck. Works with 256MB.\n\nDo we need to go through the warnings/docs/wiki etc and make 256MB the minimum?","comments":[{"author":"JasonJAyalaP","date_created":1497570764,"date_modified":1497570764,"content":"I just noticed that the bootup message for gateway says \"196 MB\"."},{"author":"HulaHoop","date_created":1497577976,"date_modified":1497577976,"content":"IIRC Whonixcheck will be optional in Whonix 14. Do you know what processes take the extra ram and trigger an OOM?\n\n"},{"author":"JasonJAyalaP","date_created":1497582982,"date_modified":1497582982,"content":"It was during sdwdate checking for time, so I think it's necessary. I didn't grab a screenshot. I can double check, but even if optional, whonixcheck should run on any supported config.\n\nAre any users left out if we support no lower than 256 memory? I can't imagine investing the time optimizing/rewriting whonixcheck/sdwdate for people who want < 256. Hmm, unless we're talking about hardware isolation on... what modern device? RasPi 3 has 1 GB, for example."},{"author":"Patrick","date_created":1497609109,"date_modified":1497609109,"content":"There is no traction for physical isolation at this point. Let's not optimize at this point.\n\nPlease search the wiki for 192, 196, 128 and update to 256. Please do the same with Whonix's source code.\n"},{"author":"JasonJAyalaP","date_created":1497629161,"date_modified":1497629161,"content":"Done.\n\nhttps://github.com/search?utf8=%E2%9C%93&q=%22128mb%22+OR+%22128+mb%22+OR+%22192mb%22+OR+%22192+mb%22+OR+%22196mb%22+OR+%22196+mb%22+org%3AWhonix&type=Code"}]},"PHID-TASK-vmidlkqnbjnc6lw6rgvo":{"id":"691","title":"sdwdate sclockadj change time without spamming logs","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"libc functions that set the time also report the time change in the system log. Making many small changes via sclockadj (which uses clock_settime) spams the logs. NTP subtly changes the time by adjusting the clock frequency with the ntp_adjtime function call.\n\n1) Is there a way to use functions like clock_settime without reporting to the log?\n\n2) Could we install ntpd, but only use it locally and manually? (Sdwdate calculates the date, but then tells ntpd what to do)\n\n3) Is it possible to reimplement what ntp does (which is use ntp_adjtime and related functions and monitor their progress, I think. It's beyond my C skills). How much would it cost to hire a programmer to do this?","comments":[{"author":"s.sh","date_created":1497622053,"date_modified":1497622053,"content":"> Is there a way to use functions like clock_settime without reporting to the log\n\nThere are generally three ways:\n1. Hook into the related library call and prevent the syscall function from being called.\n2. Immediately after writing to system logs following a call to clock_settime() make the appended logs removed.\n3. During the time of calling clock_settime(), disable the syslog at system level, after returning from the aforementioned function re-enable logging.\n\nFirst solution:\nAfter some reverse engineering I noticed the logging is done AFTER invoking the corresponding system call (i.e in the kernel space) and not explicitly by calling the syslog library function. So implementing this solution is not straightforward for the case.\n\nSecond solution:\nYou can do this by simply running some bash commands after the call to clock_settime(). But this kind of solution is a little bit dirty however it works. If you want I can prepare a demo code for you to see. \n \nThird solution:\nThis would cause a race condition and during the short time the function is running some other logs from other sources may fail to be written properly into the log files. However the probability is low."},{"author":"Patrick","date_created":1497625700,"date_modified":1497626156,"content":"s.sh (ssh):\n> s.sh added a comment.\n> \n> \n>> Is there a way to use functions like clock_settime without\n>> reporting to the log\n> \n> There are generally three ways:\n> \n> 1. Hook into the related library call and prevent the syscall\n> function from being called. 2. Immediately after writing to system\n> logs following a call to clock_settime() make the appended logs\n> removed. 3. During the time of calling clock_settime(), disable the\n> syslog at system level, after returning from the aforementioned\n> function re-enable logging.\n\nThat's all too hacky.\n\nAlso for anti-fingerprinting solutions it would be better to avoid\nclock_settime which no other time synchronization software (ntpd,\nchrony, systemd-timesyncd) is using and rather emulate a popular one.\n\n>    Is there a way to use functions like clock_settime without reporting to the log?\n\nProbably not.\n\n>    Could we install ntpd, but only use it locally and manually? (Sdwdate calculates the date, but then tells ntpd what to do)\n\nThis would be a very good solution but not sure it's possible.\n\n> Is it possible to reimplement what ntp does (which is use ntp_adjtime and related functions and monitor their progress, I think.\n\nThis would be the next best solution.\n\nLet's see. There might be someone capable to implement this."},{"author":"JasonJAyalaP","date_created":1497651658,"date_modified":1497651658,"content":"http://www.ntp.org/ntpfaq/NTP-s-algo.htm#Q-CLOCK-DISCIPLINE\n\nWhen ntp needs to adjust more than 128ms, it uses settimeofday to make one big jump.\n\nUnder 128ms, it uses adjtimex for small adjustments. Then ntp_adjtime for tuning the kernel's clock.\n\nIf attacks can't fingerprint us under 128ms, we could just change the time with one big jump. No different from ntpd.\n\nSNTP (simple ntp, part of the ntp package) can be set (forced?) (according to the manpage) to only use the big jump (settimeofday) or adjtimex.\n\nhttp://manpages.ubuntu.com/manpages/xenial/man1/sntp.1.html\n\nOptions:\n\n1: If no fingerprinting, just make sdwdate set the date via sudo bash\n\n2: Hire some guy to rip out the code in sntp\n\n3: LOL -> Make sdwdate run a fake ntp server locally, run sntp manually (sntp -Ss localhost:666), turn off server.\n"},{"author":"Patrick","date_created":1497655809,"date_modified":1497655809,"content":">>! In T691#13739, @JasonJAyalaP wrote:\n> http://www.ntp.org/ntpfaq/NTP-s-algo.htm#Q-CLOCK-DISCIPLINE\n\nThat sounds rather complicated, no?\n\n> When ntp needs to adjust more than 128ms, it uses settimeofday to make one big jump.\n\nIs NTP on Debian really doing that? Says `Different operating systems provide different means, but the most popular ones are listed below.` Never saw this on Debian. Needs empiric research.\n\n> If attacks can't fingerprint us under 128ms\n\nThat's not clear.\n\n> 2: Hire some guy to rip out the code in sntp\n\nsntp isn't popular (not the default anywhere). How popular is NTP vs chrony vs systemd-timesyncd? Is systemd-timesyncd the new Default in Debian stretch? That code might be a lot simpler? Perhaps we could interface with that?\n\n> 3: LOL -> Make sdwdate run a fake ntp server locally, run sntp manually (sntp -Ss localhost:666), turn off server.\n\nIt's not a bad idea. I guess simulating a NTP server could be quite difficult as well. Perhaps run a regular NTP server but modify it to take not a atomic clock, but sdwdate as time source? I.e. simulate an atomic clock instead (or something else that a NTP server accepts as time source)?"},{"author":"JasonJAyalaP","date_created":1497989762,"date_modified":1497989762,"content":"Removing Whonix 14 tag. It's not necessary to block 14."},{"author":"Patrick","date_created":1498127638,"date_modified":1498127638,"content":"For now, I remain positive this can and should be sorted out for Whonix 14."},{"author":"Patrick","date_created":1532500767,"date_modified":1532500767,"content":"This is sorted in a later version of systemd.\n\nhttps://github.com/systemd/systemd/issues/5207"},{"author":"marmarek","date_created":1537235754,"date_modified":1537235754,"content":"Actually, the \"apt-daily.timer: Adding 1h 17min 24.927437s random time\" message have real impact, not only noise. Each time sdwdate change time, systemd adds a random delay to those timers. which means the timer will never expire (unless that random delay will happen to be very close to 0 - i.e. below the time until sdwdate change the time, which looks to be 1s)."}]},"PHID-TASK-7tw4adjq4ruefomxcxwb":{"id":"690","title":"Qubes-Whonix tb-updater 7.0.1 stable upgrade","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[]},"PHID-TASK-4uqipjtevh7rbduo4rsz":{"id":"689","title":"use whonixcheck Whonix News to count Whonix users","status":"resolved","priority":"Normal","author":"Patrick","description":"Counting https://download.whonix.org/whonixdevelopermetafiles/internal/news_v4/ file downloads isn't great, since multiple Whonix-Workstations on the same computer downloading that file will mess up counting.\n\nWe need a file that is only downloaded by Whonix-Gateway. And only downloaded at most once per day so we can count daily users.\n\nhttps://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_news.bsh\n\n-----\n\nDesign:\n\n* no private info transferred at all\n* adds no additional risk other than that of apt-get communicating with Whonix servers which users are doing anyway to their systems [updated](https://www.whonix.org/wiki/Update).\n* only on Whonix-Gateway\n* no unique identifiers of any kind\n* all transmissions go through Tor\n* all transmissions are using Whonix's Tor onion v3 service\n* so we will never collect any IP addresses\n* submissions happen at randomized times\n* only one submission within 24 hours\n* [can be easily disabled](https://www.whonix.org/wiki/Advanced_Security_Guide#Prevent_Downloading_Whonix_News_and_Whonix_User_Census_Counting)\n\n----\n\nforum discussion:\nhttps://forums.whonix.org/t/whonix-census-counter-the-number-of-whonix-users/7620\n\n----\n\nThis ticket was implemented and probably won't be updated any further. This functionality is documented here:\nhttps://www.whonix.org/wiki/Whonixcheck_Hardening#Prevent_Downloading_Whonix_.E2.84.A2_News_and_Whonix_.E2.84.A2_User_Census_Counting","comments":[{"author":"JasonJAyalaP","date_created":1497399399,"date_modified":1497399593,"content":"The standard-practice way to do this is that the gateway sends an http put request to an API (http://whonix.org/api/v1/gateway-check-in), and all the logic (is this the same machine? have they reported in today already?) is on the server. With basic logging, it's a trivial project for any backend programmer (that is, even I could do it :P)"},{"author":"Patrick","date_created":1497447691,"date_modified":1497447691,"content":"The logic inside whonixcheck:\n\n* not download the file more often than once in 24 hours\n* run at bootup if we need to fetch the file\n* don't fetch again if the user runs whonixcheck manually\n* run at randomized times (already implemented in whonixcheck)\n** partially implemented already https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/autostart.bsh\n* maybe whonixcheck is not the right place to run this (since autorun vs not autorun discussion https://forums.whonix.org/t/whonixcheck-whonix-14-ideas)\n\nWe need something lightweight to code and to run on the server.\n\nCan we count how many times a file was downloaded for a specific file on the server? @fortasse (Given our setup with nginx, varnish and apache)"},{"author":"fortasse","date_created":1497480589,"date_modified":1497480589,"content":"We can definitely do this, especially if that's the way the client works.\n\nWe can just grep it from the logs every 24 hours, and do whatever with the line count. I don't know how fancy we want to get with it, but we can just email it or something?"},{"author":"Patrick","date_created":1497481057,"date_modified":1497481057,"content":"Great! We don't need publication yet. Viewing it manually on the server\nwould suffice."},{"author":"JasonJAyalaP","date_created":1497555189,"date_modified":1497555251,"content":"> run at bootup if we need to fetch the file\nCan you clarify that? By \"fetch the file\" you mean \"report in\", correct? What is the logic at bootup? Do you mean: \"Check at bootup if we've reported in today. If not, do it now.\" ?"},{"author":"JasonJAyalaP","date_created":1497556008,"date_modified":1497556105,"content":"Would the simplest code be something like...\n\nInside whonixcheck autostart:\n```\nread a text file with a time stamp (/etc/whonixcheck/lastreport.cfg or wutever) , handle errors.\nIf time stamp is greater than 24 hours  from now then \nwget --method=PUT https://usercount.whonix.org/api/1/countme (or curl -X PUT)\necho $current_time > /etc/whonixcheck/lastreport.cfg\n```"},{"author":"Patrick","date_created":1497608005,"date_modified":1497608005,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   > run at bootup if we need to fetch the file\n>   \n>   Can you clarify that? By \"fetch the file\" you mean \"report in\", correct?\n\nfetch the file = download the file\n\ndownload the file = counter as \"report in\" on the server\n\n> What is the logic at bootup? Do you mean: \"Check at bootup if we've\nreported in today. If not, do it now.\" ?\n\nYes."},{"author":"Patrick","date_created":1497608247,"date_modified":1497608247,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   Would the simplest code be something like...\n\nSomething like this, yes.\n\n>   Inside whonixcheck autostart:\n>   \n>     read a text file with a time stamp (/etc/whonixcheck/lastreport.cfg or wutever) , handle errors.\n\n/var/cache/whonixcheck/user_counter.txt\n\n>     If time stamp is greater than 24 hours then \n>     wget --method=PUT https://usercount.whonix.org/api/1/countme\n\nUse curl. (See whonixcheck for other invocations of curl and see which\ncommand line options make sense.)\n\nDownload from Whonix onion.\n\nWe place the file on a download.whonix.org sub folder (so we don't have\nto maintain a new sub domain).\n\nhttps://download.whonix.org/whonixdevelopermetafiles/internal/gateway_counter\nor so? Would that work? @fortasse\n\n>     echo $current_time > /etc/whonixcheck/lastreport.cfg\n\nAccess rights need to be sorted out. (Check if we are already using\n/var/cache/whonixcheck/ and if it's owned by user `whonixcheck`)."},{"author":"fortasse","date_created":1497648497,"date_modified":1497648497,"content":"That should be a perfectly fine file path. Do we need to separate out .onion downloads vs .org downloads?"},{"author":"Patrick","date_created":1497654155,"date_modified":1497654155,"content":"fortasse (fortasse):\n> Do we need to separate out .onion downloads vs .org downloads?\n\nIf that is doable without too much effort... Then this would spare us a\nfew curious manual downloads and thereby needlessly increasing the counter.\n\nPerhaps the file location should be even more obscure to prevent that?"},{"author":"JasonJAyalaP","date_created":1497669614,"date_modified":1497669642,"content":"> Download from Whonix onion.\n\nNo need to download a blank file. Just \"pinging\" server with a put request is all that's needed to appear on the log. Correct, @fortasse?"},{"author":"JasonJAyalaP","date_created":1497669883,"date_modified":1497669883,"content":"> /var/cache/whonixcheck/user_counter.txt\n> echo $current_time > /etc/whonixcheck/lastreport.cfg\n\n@Patrick Do you want the last check to be /var/cache/whonixcheck or /etc/whonixcheck ? I think /var/lib/whonixcheck is the correct FHS location (http://www.pathname.com/fhs/2.2/fhs-5.8.html)"},{"author":"Patrick","date_created":1497696773,"date_modified":1497696773,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   > /var/cache/whonixcheck/user_counter.txt\n>   >  echo $current_time > /etc/whonixcheck/lastreport.cfg\n>   \n>   @Patrick Do you want the last check to be /var/cache/whonixcheck or /etc/whonixcheck ? I think /var/lib/whonixcheck is the correct FHS location (http://www.pathname.com/fhs/2.2/fhs-5.8.html)\n\nYes, /var/lib/whonixcheck folder seems better suited."},{"author":"Patrick","date_created":1497696899,"date_modified":1497696899,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   > Use curl. (See whonixcheck for other invocations of curl and see which\n>   \n>   command line options make sense.)\n>   \n>   > Download from Whonix onion.\n>   \n>   No need to download a blank file. Just \"pinging\" server with a put request is all that's needed to appear on the log. Correct, @fortasse?\n\nYes, if downloading a blank file could be avoided that would be cool.\nThat would prevent messing up the log by curious users downloading that\nempty file when scrutinizing download.whonix.org.\n\n(Might also be easier to prevent varnish from caching the request?)\n\n(Still use the onion.)"},{"author":"HulaHoop","date_created":1497828168,"date_modified":1497828168,"content":"OK so I asked upstream if there is a way they can collect the type ofstats we want but unfortunately Tor clients do not and likely never will be able to collect this type of data safely.\n\nhttps://lists.torproject.org/pipermail/tor-dev/2017-June/012327.html\n\nThe important thing I'm getting is that to do this in a privacy preserving way these criteria need to be covered:\n\n\n\n> Any client protocol would need to have the following properties:\n> 1. avoid client tracking, and\n> 2. secure aggregation of counts for each type of client, so counts could\n>    not be linked to individual guards.\n\n\n\nI think you have this covered since no individual clients have identifying IDs or anything similar."},{"author":"JasonJAyalaP","date_created":1498084941,"date_modified":1498096978,"content":"Here's some ruby:\n```\nfile = \"checkin.log\"\nif File.owned? file then # Deleting the log file or changing the owner will disable the check\n    now = Time.now\n    if File.mtime(file) + 86400 < now then # Always wait at least a day after the last modification of the log file\n        require 'net/http'\n        require 'uri'\n        begin\n            uri = URI('http://whonix.org/api/1/checkin') # API address\n            params = {system: \"gateway\"} # uri?system=gateway\n            response = Net::HTTP.post_form(uri, params)\n        rescue SocketError\n            STDERR.puts \"Connection error while checking in\"\n            exit 1\n        rescue StandardError # Handles all forms of errors, inelegantly.\n            STDERR.puts \"Error while checking in\"\n            exit 1\n        end\n        File.open(file, 'a+') do |f| # Appends to file\n            f.puts(now.to_s + \" -> \" + response.to_s)\n        end\n    end\nend\n```\n\n\nDesign decisions:\n  # There's no need to read the file to see last check time. Just read the modification time.\n  # Delete the file is a hacky (but easy) way to disable the check.\n  # The file can be used as a log. Each line is \"Time : Response\". Right now, response is simply \"moved\" since there isn't a proper response set up. I can remove the response or just leave.\n  # file = checkin.log will be file = /var/lib/whonixcheck/checking.log\n\nProblems or possible changes:\n  # /api/1/ is just me dreaming. It can just be whonix.org. With the system=gateway params, the log can be searched for that. It's up to fortasse.\n  # !!! Ruby is being blocked from making the tcp connection to resolve the address on gateway\n  # Should this check just clearnet, onion, or both?\n  # This could be quickly translated to bash (with curl -X POST -d system=gateway https://whonix.org/), Patrick, if that's easier than piping out to ruby.\n  # If the file was deleted (presumably on purpose to disable the check), checkin.rb will still $? as 0. This can be changed\n\n"},{"author":"Patrick","date_created":1498133233,"date_modified":1498133233,"content":">>! In T689#13771, @JasonJAyalaP wrote:\n>   # Delete the file is a hacky (but easy) way to disable the check.\n\nIf we implement it into whonixcheck, use `whonixcheck_skip_functions` mechanism.\n\n    whonixcheck_skip_functions+=\" function_name \"\n\nIf we implement it into whonixcheck:\n\n* we must keep autorun whonixcheck at boot on Whonix-Gateway\n* we must keep autorun whonixcheck (at least in user counting mode) every 24 hours\n** https://github.com/Whonix/whonixcheck/blob/master/lib/systemd/system/whonixcheck.service\n** https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheckdaemon\n** https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/autostart.bsh\n\nSince that mechanism is kinda complex, and since we wanted (long term) to get rid of whonixcheck autostart anyhow... Might be better to have a separate systemd unit file / daemon for this purpose. Disabling could be done by using `sudo systemctl mask whonix-user-counting` or so.\n\nOn the other hand, whonixcheck already is covered with apparmor and systemd hardening.\n\n>   # /api/1/ is just me dreaming. It can just be whonix.org. With the system=gateway params, the log can be searched for that. It's up to fortasse.\n\nPlease use the onion. Perhaps `api.onion/...`?\n\n>   # !!! Ruby is being blocked from making the tcp connection to resolve the address on gateway\n\nBecause Whonix-Gateway has intentionally no system default networking.\n\n( https://www.whonix.org/wiki/Whonix-Gateways_Own_Traffic_Transparent_Proxy )\n\nTherefore probably better to use curl, as per below.\n\n>   # Should this check just clearnet, onion, or both?\n\nJust onion.\n\n>   # This could be quickly translated to bash (with curl -X POST -d system=gateway https://whonix.org/), Patrick, if that's easier than piping out to ruby.\n\nYes, because then stream isolation gets easier. Also then because invocation of `curl` can remain standardized. Example usage of `curl` in whonixcheck.\n\n    curl.anondist-orig --fail --proxy socks5h://user:password@127.0.0.1:9110 --tlsv1 --proto =https --max-time 180 --output /tmp/tmp.Bg7xq574AW/check_tpo_tor_socksport.html https://check.torproject.org\n\n* using `curl.anondist-orig` so we're not using the user's default stream isolated instance\n* `--fail` so `curl` will exit non-zero in case of issues for better error handling\n* using `--proxy socks5h://user:password@127.0.0.1:9110` to make connectivity even work and use use a separate Tor SocksPort (we can use 9110 because connections to onions are stream isolated anyhow and the gateway otherwise won't connect to Whonix onion on that socks port)\n* `--tlsv1 --proto =https` should be omitted, since we will be using the onion\n* `--max-time 180` so it won't hang forever\n* `--output` may not be required since we won't download anything, however, we might want to keep it anyhow to store server responses for debugging\n\nAs for `$CURL `invocation, please compare with how it's done here:\n\n* usr/lib/whonixcheck/check_news.bsh\n* usr/lib/whonixcheck/check_tor_socks_port_reachability.bsh\n\nI mean, please also use `timeout`. Alternatively, not sure if `curl`'s `--connect-timeout` and `--max-time` alone would be reliable enough to never hang. Would require testing against a prepared server. Replicating `timeout` method is probably easier.\n\n>   # If the file was deleted (presumably on purpose to disable the check), checkin.rb will still $? as 0. This can be changed\n\nDeleting a file to disable a check does not sound right. That sounds rather surprising."},{"author":"JasonJAyalaP","date_created":1498169823,"date_modified":1498169973,"content":"1. Keep most of it as ruby\n2. Change the native ruby http commands instead to pipe out to curl\n3. return 1 if curl returns 1\n4. make the ruby file a daemon/service\n5. create log file if doesn't exist, return 1 if not writeable.\n\nI've never done the daemon thing before. Any tips? I might need you to create the basic bash setup. Dunno. I just need some way for checkin.rb to fire every X hours. Or maybe on bootup and day change?"},{"author":"Patrick","date_created":1498212811,"date_modified":1498212811,"content":"I don't see why we need ruby for this. There is another issue. Running this after boot will likely fail, because we also need to wait until Tor is enabled, Tor is fully bootstrapped, clock is sane, and in absence of other system issues. Thereby reinventing whonixcheck. Also no need to reinvent the daemon mechanism. Your lock file mechanism makes sense. Let me implement this one in bash."},{"author":"Patrick","date_created":1498213248,"date_modified":1498213248,"content":"@fortasse could you please use the following test command.\n\n    curl --fail --proxy socks5h://user:password@127.0.0.1:9050 --location --max-time 180 --output ./whonix_census.txt --request PUT --data gateway-sign-in http://api.kkkkkkkkkk63ava6.onion/whonix_census\n\nCurrent server reply is:\n\n    curl: (22) The requested URL returned error: 405 Method Not Allowed\n\nAny idea how to make the server reply something sensible such as `ok`?"},{"author":"Patrick","date_created":1498596101,"date_modified":1498596101,"content":"Mostly done.\n\nhttps://github.com/Whonix/whonixcheck/commit/3da614e8a02e3606de93618bea3f32075aa354c4\n\nNeeds more work. Let's give @fortasse time to do the server part."},{"author":"Patrick","date_created":1508511372,"date_modified":1508511372,"content":">>! In T689#13857, @Patrick wrote:\n> Mostly done.\n> \n> https://github.com/Whonix/whonixcheck/commit/3da614e8a02e3606de93618bea3f32075aa354c4\n> \n> Needs more work. Let's give @fortasse time to do the server part.\n\nUp to me since 06/27/2017 getting this done."},{"author":"Patrick","date_created":1519248550,"date_modified":1519248550,"content":"https://github.com/Whonix/whonixcheck/commit/0776288fb5fa027998fb4a187e10881389582ded\nhttps://github.com/Whonix/whonixcheck/commit/0776288fb5fa027998fb4a187e10881389582ded\nhttps://github.com/Whonix/whonixcheck/commit/1b9ef87b29546e929185dbce9403a0d86d31955e\nhttps://github.com/Whonix/whonixcheck/commit/5845a3f35f4e93ddcf9986e16e82284ca848e91b\nhttps://github.com/Whonix/whonixcheck/commit/90209d68f8297b83c7a05e82d23051e7ace00863\n"},{"author":"Patrick","date_created":1603745606,"date_modified":1603745606,"content":"documented here:\nhttps://www.whonix.org/wiki/Whonixcheck_Hardening#Prevent_Downloading_Whonix_.E2.84.A2_News_and_Whonix_.E2.84.A2_User_Census_Counting"}]},"PHID-TASK-gp57qichrfcnab66l3q4":{"id":"688","title":"Change bindp compile to postinstall","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"bindp currently compiles for its debian package.\n\nCompiling during postinstall has its disadvantages (root, not standard in debian), but offers the advantage of making it crossplatform (qubes, 64, 86).","comments":[{"author":"JasonJAyalaP","date_created":1497558402,"date_modified":1497558402,"content":"For reference, the (relevant, i think) flags that bindp make currently uses:\n\n```\n-ldl -D_GNU_SOURCE -Wdate-time -D_FORTIFY_SOURCE=2 -g -O2 -fstack-protector-strong -Wformat -Werror=format-security -Wl,-z,relro -Wl,-z,now\n \n```"},{"author":"Patrick","date_created":1497627785,"date_modified":1497627785,"content":"Due to T599#13695...\n\n    gcc -nostartfiles -fpic -shared --entry main bindp.c -o libindp.so -ldl -D_GNU_SOURCE -pie -Wdate-time -D_FORTIFY_SOURCE=2 -g -O2 -fdebug-prefix-map=/build/bindp-0.3=. -fstack-protector-strong -Wformat -Werror=format-security -Wl,-z,relro -Wl,-z,now\n\nTo check everything is fine:\n\n    checksec --file /usr/lib/bindp/libindp.so\n\n( https://github.com/slimm609/checksec.sh )\n\n```\nRELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE\nFull RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   /usr/lib/bindp/libindp.so\n```\n"},{"author":"Patrick","date_created":1497628117,"date_modified":1497628117,"content":"Btw this ticket will probably result in users of Non-Qubes-Whonix 13 (i686) being able to upgrade to Non-Qubes-Whonix 14. @HulaHoop\n\nIt's because compilation will be done at package installation (upgrade) time for the platform the user is currently using.\n\nSuch Non-Qubes-Whonix 13 -> Non-Qubes-Whonix 14 upgraded systems will stay i686 forever. Probably no free resources to think about how to upgrade from i686 to amd64. (Probably same as Debian if that possible at all.)\n\nDownloadable Non-Qubes-Whonix 14 builds will be amd64 only. (Yes, these also run on Intel.)"},{"author":"HulaHoop","date_created":1497640509,"date_modified":1497640509,"content":"Agreed. If they really want to stick to i686 then they can if they know what they are doing. Otherwise I don't think its a good use of time to support this officially. especially with the recent changes for the KVM version where its just easier to delete and start over."},{"author":"JasonJAyalaP","date_created":1499478877,"date_modified":1499479065,"content":"https://github.com/Whonix/bindppost\n\n\n```\ngit clone git@github.com:Whonix/bindppost.git\ncd bindppost\nmake deb-icup\n\n```\nIt places bindp.c in /usr/lib and compiles it to a .so file. It doesn't remove the .c file.\n\nRunning the compile command manually will show a compiler warning, but it doesn't show during package install.\n\nI tried to make the most minimal package possible so we can convert it to a template later.\n\nThere was a dh-helper warning. Something about #dh-helper# token not being in bindp.postinst. I'm not what to do there."},{"author":"Patrick","date_created":1499509877,"date_modified":1499509877,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   https://github.com/Whonix/bindppost\n\nPlease don't create a new package for that. The existing `bindp` package\nshould be ported.\n\nIf you are unsure about to commit to master, a separate git branch would\nbe better."},{"author":"Patrick","date_created":1499535265,"date_modified":1499535265,"content":">   There was a dh-helper warning. Something about #dh-helper# token not being in bindp.postinst. I'm not what to do there.\n\nExample:\n https://github.com/Whonix/sdwdate/blob/master/debian/sdwdate.postinst#L64\n\nIt will be replaced by code from debhelper during package build. Such as\nfor packages using systemd it will add the necessary code."},{"author":"Patrick","date_created":1499535313,"date_modified":1499535313,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> It doesn't remove the .c file.\n\nThat's good. It shouldn't remove the source file."},{"author":"JasonJAyalaP","date_created":1499551361,"date_modified":1499551376,"content":"```\ngit clone git@github.com:Whonix/bindp.git\ncd bindp\ngit checkout bindppost\nmake deb-icup\n```\nIf the goal is simply put the libindp.so file into /usr/lib, I think I was successful. @Patrick If it tests fine for you, please merge to master and close this ticket."},{"author":"Patrick","date_created":1499603500,"date_modified":1499603500,"content":"The diff looked very weird. Somehow you reverted to an earlier version of `bindp.c`. Fixed in master."},{"author":"Patrick","date_created":1511284678,"date_modified":1511284678,"content":"https://github.com/Whonix/bindp/commit/d7052e58d57b2d8a5f54dab2e6da836d3fb61ce8"}]},"PHID-TASK-5g2u6g5dtcrzf2sfqivv":{"id":"687","title":"Supress VB error messages.","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"Upon boot of the OVAs, VB starts spamming messages about how it can't capture mouse (because you're in the terminal) then how you can capture mouse (cuz the gui booted). There are other messages about fullscreen, etc. If you hit X, it appears next boot. If you hit the strangle /bubble icon, it's permanent (I just found that out).\n\nNew users are already being bombared by confusing but important messages. These low-importance VB warnings do more harm than good.\n\nI found this forum post:\n\n```\nUse the VBoxManage command line to add extra information to the global xml file of the user. \nYou should be able to use the internalcommands setextradata parameter for this. \n\nThis is what I see in my xml file:\n```\n```\n    <ExtraDataItem name=\"GUI/SuppressMessages\" value=\"remindAboutAutoCapture,remindAboutMouseIntegrationOn,showRuntimeError.warning.HostAudioNotResponding,remindAboutGoingSeamless,remindAboutInputCapture,remindAboutGoingFullscreen,remindAboutMouseIntegrationOff,confirmGoingSeamless,confirmInputCapture,remindAboutPausedVMInput,confirmVMReset,confirmGoingFullscreen,remindAboutWrongColorDepth\"/>\n```\n\nPatrick: Is there an XML file during the boot process that I can put this in? After it's generated? Or do we run the command line tool via bash?\n\n","comments":[{"author":"Patrick","date_created":1496667599,"date_modified":1496667599,"content":"No xml modifications required, most likely. (And hacky as well.)\n\nShould be done here:\n\nhttps://github.com/Whonix/Whonix/blob/master/build-steps.d/2600_create-vbox-vm\n"}]},"PHID-TASK-dcrdbiobb3b6dch4szix":{"id":"686","title":"Port to sclockadj3","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"I've rewritten sclockadj in C\nhttps://github.com/JasonJAyalaP/sclockadj/blob/master/sclockadj.c\n\n  # Unless there's something else using them, we no longer need the ruby packages (compiler, libraries).\n  # Update the sdwdate package to compile sclockadj (gcc sclockadj -o sclockadj) (look at https://github.com/Whonix/bindp for an example on how to package simple compiled code for Whonix)\n  # Sdwdate's invocation of sclockadj needs to be changed to\n\n```\ncmd = [\n    \"sudo\",\n    \"/usr/lib/sdwdate/sclockadj\",\n    str(self.newdiff_nanoseconds)]\n```\n(plus the inline and --noninteractive lines if still necessary)\n","comments":[{"author":"Patrick","date_created":1496665343,"date_modified":1496691489,"content":"Could you please commit sclockadj.c to the root folder of https://github.com/Whonix/sdwdate so we can account your authorship in the git history? @JasonJAyalaP \n\nPlease also add the copy right.\n\n> Copyright (C) 2016 Patrick Schleizer <adrelanos@riseup.net>\n> See the file COPYING for copying conditions.\n\n(As per https://github.com/Whonix/Whonix/blob/master/CONTRIBUTING.md.)"},{"author":"JasonJAyalaP","date_created":1496689343,"date_modified":1496689343,"content":"Done."},{"author":"JasonJAyalaP","date_created":1496783693,"date_modified":1496783715,"content":"Ported (in sdwdate master) and currently testing."},{"author":"JasonJAyalaP","date_created":1497649078,"date_modified":1497649078,"content":"@Patrick \nis it working for you?"},{"author":"Patrick","date_created":1497654252,"date_modified":1497654252,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   @Patrick \n>   is it working for you?\n\nYes."}]},"PHID-TASK-fjbw2ao4f4sr266fewv4":{"id":"685","title":"Consider including uBlock Origin","status":"wontfix","priority":"Wishlist","author":"JasonJAyalaP","description":"uBlock origin is a blocker/filter that is highly respected and greatly improves bandwidth, security, and privacy. I install it right away, even in TBB.\n\nIt is possible to install uBlock origin system-wide via apt-get\nhttps://packages.debian.org/search?keywords=xul-ext-ublock-origin\n\nBut tbb doesn't normally pick up system-wide addons.\nhttps://tor.stackexchange.com/questions/14911/can-torbrowser-recognize-system-wide-addons-installed-via-apt-get\n\nAddons do not (directly) add to fingerprint (firefox does not reveal the count or existance of any addons).\n\nIf we find a way to make tbb detect system-wide addons, we'd be taking a stronger stance against ads/malware/malicious servers than the TPO. I'm comfortable with that and consider it an important help to our users.\n\nStatus -> Researching how to get TBB to detect system-wide addons","comments":[{"author":"JasonJAyalaP","date_created":1496614720,"date_modified":1496614720,"content":"According to a comment on my stackexchange comment, Tails is already doing this via TBB hacks!\nhttps://tor.stackexchange.com/questions/14911/can-torbrowser-recognize-system-wide-addons-installed-via-apt-get?noredirect=1#comment16728_14911\n\nCan anyone confirm this? Doesn't their TBB break upon update? Shall we ask tails for the patches?"},{"author":"anonymous1","date_created":1496698401,"date_modified":1496698401,"content":"This is only helpful for non-anonymous browsers. It harms anonymity if you intend to include it with Tor Browser"},{"author":"anonymous1","date_created":1496698837,"date_modified":1496698837,"content":"Tails' decision shows their focus on privacy rather than real anonymity"},{"author":"JasonJAyalaP","date_created":1496706529,"date_modified":1496706529,"content":"By what measure does it harm anonymity?"},{"author":"anonymous1","date_created":1496719178,"date_modified":1496721389,"content":"https://www.torproject.org/projects/torbrowser/design/\n\nAt the end of section \"No filters\":\n\n\"Users are free to install these addons if they wish, but doing so is not recommended, as it will alter the browser request fingerprint. \"\n\nYou will at the very least reduce your anonymity set from Tor Browser users to Tor Browser users who installed adblocker/uBlock Origin\n\nDepending on the uniqueness of your filter selection, your traffic pattern could become completely unique to be easily trackable\n\nFrom the same section:\n\n\"Worse still, the unique filter sets that each user creates or installs will provide a wealth of fingerprinting targets. \""},{"author":"anonymous1","date_created":1496720315,"date_modified":1496720315,"content":"Some people on internet suggest that looking like a Tails user you can still keep a reasonable anonymity set but I disagree\n\nCompare Tails' 21698 boots a day on average with 2.5 million daily Tor users. Less than 1%"}]},"PHID-TASK-wo36qiekjtbx2g6v5p4o":{"id":"684","title":"Better instructions for adding bridges","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"whonixsetup, when selecting \"tor is censored in my area\" says \"Go add bridges to torrc and come back\".  The advice \" Start -> Applications -> torrc\" needs to be changed to Start -> Applications -> System -> torrc\n\ntorrc.examples shows how to add bridges (but should obfs4 have the \"managed\" line?). It gives a link, but there is a better link:\nhttps://bridges.torproject.org/options\n\nHowever, once you have those bridges, it looks like you can copy and paste them into your torrc. A careful reading of torrc.examples shows that you need to put \"bridge\" before each line.\n\nI can't remember: is host -> guest clipboard sharing enabled by default in the gateway ova? \n\nRight now it's tough for a new user to connect via bridges. I'm thinking about how to make it easier.\n","comments":[{"author":"Patrick","date_created":1496488907,"date_modified":1496488907,"content":"There is a lot great news going on with anon-connection-wizard recently. iry is our GSoC student working on anon-connection-wizard. Pointed iry to this ticket.\n\nhttps://forums.whonix.org/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/247"},{"author":"Patrick","date_created":1496493008,"date_modified":1496493008,"content":"> I can't remember: is host -> guest clipboard sharing enabled by default in the gateway ova?\n\nYes.\n\n( Documented here: https://www.whonix.org/wiki/VirtualBox/Guest_Additions#Clipboard_Sharing )"},{"author":"iry","date_created":1496545043,"date_modified":1496545043,"content":"> whonixsetup, when selecting \"tor is censored in my area\" says \"Go add bridges to torrc and come back\". The advice \" Start -> Applications -> torrc\" needs to be changed to Start -> Applications -> System -> torrc\n\nThank you so much for bring up this problem, JasonJAyalaP! \nI just fixed that: https://github.com/Whonix/whonix-setup-wizard/pull/1"},{"author":"iry","date_created":1496546479,"date_modified":1496546479,"content":"> It gives a link, but there is a better link: https://bridges.torproject.org/options\n\nAgree!\n\nMy pull request: https://github.com/Whonix/anon-gw-anonymizer-config/pull/5"},{"author":"iry","date_created":1496547778,"date_modified":1496547778,"content":"> (but should obfs4 have the \"managed\" line?).\n\nGood question! I am curious about the answer, too.\n\nI posted the question to the Whonix Forum \nhope someone who is familiar with that could answer it: https://forums.whonix.org/t/should-obfs4-have-the-managed-line/3991\n"},{"author":"Patrick","date_created":1496838352,"date_modified":1496838352,"content":"Anything left to do here?"},{"author":"JasonJAyalaP","date_created":1496870197,"date_modified":1496870197,"content":"Yes.\n\niry is handling the changing the the whonixsetup text. I'm hoping he can put in better text about how to edit the torrc file for bridges (instead of \"go do it\")."},{"author":"iry","date_created":1496887863,"date_modified":1496887863,"content":"> I'm hoping he can put in better text about how to edit the torrc file for bridges (instead of \"go do it\").\n\n\nHow do you like the following instructions?\n<p>A detailed instructions on how to do this can be found in /etc/tor/torrc.example file's Bridges section</p>\n<blockquote>Start Menu -> Applications -> System -> Torrc.example</blockquote>\n\nNotice that I have no idea how to find the path to torrc.example in graphical gateway. Could anyone help me to check if the information in block quote is correct or not please?\n\nBTW, the instruction is not perfect, but hopefully we will not use it any more when the anon-connection-wizard replace whonix-setup-wizard.\n\n"},{"author":"JasonJAyalaP","date_created":1496943408,"date_modified":1496943408,"content":"@Iry I'm fine with those instructions. You're right to point out that replacing the whole thing (and making it automated as possible) is the right answer. To open torrc.example in graphical gateway, it  is indeed how you wrote it."},{"author":"Patrick","date_created":1496968674,"date_modified":1496968674,"content":"iry (iry):\n>   Notice that I have no idea how to find the path to torrc.example in graphical gateway. Could anyone help me to check if the information in block quote is correct or not please?\n\ncd /etc/tor\nls -la\n\nThere it is."},{"author":"iry","date_created":1496979798,"date_modified":1496979798,"content":"Thank you so mcuh for your feedback and instructions!\n\nHere is my pull request:\nhttps://github.com/Whonix/whonix-setup-wizard/pull/2"},{"author":"Patrick","date_created":1497007154,"date_modified":1497007154,"content":"Merged."},{"author":"iry","date_created":1498793338,"date_modified":1498793338,"content":"Is there anything left to do?"}]},"PHID-TASK-uaqd577i6nwo3xdc6cgo":{"id":"683","title":"TBB warns about canvas privacy when visiting whonix blog","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"TBB gives a privacy warning concerning canvas. Is this an addon we're using? What triggers the warning? TBB bug?","comments":[{"author":"fortasse","date_created":1496501066,"date_modified":1496501066,"content":"From the console log:\n`Blocked http://kkkkkkkkkk63ava6.onion/blog/ in page http://kkkkkkkkkk63ava6.onion/blog/ from extracting canvas data. http://kkkkkkkkkk63ava6.onion/blog/:51.`\nLine 51 is related to Wordpress' emoji-rendering code, which is done with the HTML5 canvas.\n\nFollowing the advice outlined on http://www.denisbouquet.com/remove-wordpress-emoji-code/, this prompt no longer appears.\n\nOf course, we no longer have the Wordpress emojis, but that may be a good thing depending on how you feel about them :)\n"},{"author":"Patrick","date_created":1496504061,"date_modified":1496504061,"content":"Great!"}]},"PHID-TASK-vpb3q6ym5d6x62bdmbwt":{"id":"682","title":"Check curl for latests tls support (--tlsv1.3)","status":"resolved","priority":"Low","author":"JasonJAyalaP","description":"For Debian 10 Buster\nConfirm version of curl frozen\n\nCheck to see if there is a newer version of tls supported in curl manpage\nhttps://curl.haxx.se/docs/manpage.html\n\nIf so:\n\ngrep Whonix code for `--tlsv1.2`\nhttps://github.com/Whonix\n\n\nupdate \nhttps://www.whonix.org/wiki/Template:Curl_Secure\n\nDuplicate/Re-tag/Close&Create ticket for next Debian version.","comments":[]},"PHID-TASK-jtsrpko5j4kwkcfgcgdh":{"id":"681","title":"Warning messages of whonix setup in German","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"On first boot, the \"i understand\" warning messages are in German and English. However, one of the warnings is \"Whonix is English. An excellenet command of the English language is necessary\". Writing that in German too (or any other language) is a mixed message, no? ","comments":[{"author":"Patrick","date_created":1496489327,"date_modified":1496489327,"content":"* https://github.com/Whonix/whonix-setup-wizard/blob/master/usr/share/translations/whonix_setup.yaml\n* https://raw.githubusercontent.com/Whonix/whonix-setup-wizard/master/usr/share/translations/whonix_setup.yaml\n\n> ENG. Whonix is in English. Do not use Whonix without excellent knowledge of the English language. Misunderstandings have consequences.\n\nTranslation is:\n\n> GER. Ohne exzellentes Verstaendnis der Englischen Sprache wird davon abgeraten Whonix zu benutzen, weil Uebersetzngen nur zum Teil verfuegbar sind und Missverstaendnisse Konsequenzen haben koennen.\n\nRe-translated to ENG: `WIthout excellent understanding of the English language it is recommended against to use Whonix, because translations are only partially available and because misunderstandings can have consequences.`\n\nTranslation is correct. Translation is already within the source file.\n\nDoes that translation not show?\n\nI don't understand your question."},{"author":"JasonJAyalaP","date_created":1496508673,"date_modified":1496508758,"content":"The \"mixed message\" is: \"You should know English, but maybe we'll help you in your native language. At least for now. Maybe not later.\"\n\nOr should we provide a multi-language warning that says \"You need to know English\"? In that case, German would be just one of many translations we could provide.\n\nEnglish: You must know English. Security is hard.\nEspañol: Hay que saber Ingles. La seguridad es difícil.\nDeutch: Ach! Mein leben!\nItaliano: Ha bisogno di conoscere...\n...etc"},{"author":"Patrick","date_created":1496666493,"date_modified":1496666493,"content":"No, because justification is unfortunately still tied to Germany, explaining the disclaimer in German layman's terms in detail is my best guess on how to make it legally effective."}]},"PHID-TASK-ukl5vd3w53db5cnm6wwl":{"id":"680","title":"Change video ram for gateway VB ova","status":"resolved","priority":"Needs Triage","author":"JasonJAyalaP","description":"Gateway vb ova has 8 gb of video ram. This causes an error message (and possible video problems) when going full screen with the gateway. There isn't any reason to make this 16mb","comments":[{"author":"JasonJAyalaP","date_created":1496423567,"date_modified":1496423567,"content":"Done\n\nhttps://github.com/Whonix/Whonix/commit/7dce743a426c600ee270068c685c11624340c59d#diff-6901a61788ea5a9fad675c57e60afddd\nhttps://github.com/Whonix/Whonix/commit/7cbc035509254cdb35a1e07e2f12153fccc670ab#diff-0f37815ce2f48de7499839ea12ff89ae"}]},"PHID-TASK-7mrvil2aa6jthoirtxh2":{"id":"679","title":"Document problem with firefox on mac renaming the .ova files","status":"resolved","priority":"Low","author":"JasonJAyalaP","description":"Firefox on macOS renames .ova downloads to .ovf, causing VB to crash. I reported the bug:\nhttps://bugzilla.mozilla.org/show_bug.cgi?id=1369576\n\nWaiting to see what they say.","comments":[]},"PHID-TASK-ltyxiqf6eofcnb3cvihf":{"id":"678","title":"tb-updater onion mirros downloads support","status":"resolved","priority":"Normal","author":"HulaHoop","description":"With TPO infrastructure using onions, its now a good idea to switch tb-updater to check for version info and downloads to these more secure mirrors. \n\n***\n\nExtra and unnecessary consideration:\n\nIf its ever planned to have tb-updater used as an alternative to Micah's TBB downloader on Debian hosts, it needs to be able to revert to using clearnet addresses depending on output of something like virt-what.\n\n","comments":[{"author":"Patrick","date_created":1548141406,"date_modified":1548141406,"content":"> With TPO infrastructure using onions, its now a good idea to switch tb-updater to check for version info and downloads to these more secure mirrors.\n\nImplemented optional `--onion`.\n\nCan also be set through environment variable.\n\n    export tb_onion=true\n\nOr through config `/etc/torbrowser.d/50_user.conf`.\n\n    tb_onion=true\n\nhttps://github.com/Whonix/tb-updater/commit/9f758e241d1a699de96de0784a9e6cf93fe0d440\n\n> If its ever planned to have tb-updater used as an alternative to Micah's TBB downloader on Debian hosts, it needs to be able to revert to using clearnet addresses depending on output of something like virt-what.\n\nNot implemented."}]},"PHID-TASK-2fdlzg6r62mcmijnr7zi":{"id":"677","title":"research and document secure downloads using Tor Browser","status":"resolved","priority":"Normal","author":"Patrick","description":"* assume some example download link\n** https://www.torproject.org/dist/torbrowser/6.5.2/tor-browser-linux64-6.5.2_en-US.tar.xz\n** could be any\n** forget that it's on torproject.org\n\n* assume the user has only a single open tab\n* assume the user knows he is pasting an https link into the url bar\n* assume https everywhere is not effective for that website\n* assume the website does not use HSTS\n* assume the website does not use HSTS preloading\n* assume the website does not use HTTP Public Key Pinning (HPKP)\n\nIn this situation there was a bug. The user has no way to know if the file is being downloaded over https over if sslstrip made the user download over plain http. It's because one cannot see a padlock. It's just empty. I have no bug report for reference handy.\n\nCould you research please if this is still the case? And reference a bug report? @HulaHoop\n","comments":[{"author":"HulaHoop","date_created":1495256376,"date_modified":1495256376,"content":"\nI think I found the topic you're paraphrasing which explains the limitations of HSTS:\n\n\"HSTS is designed to FORCE the use of https, this is a good thing in most cases. However, HSTS is problematic in that it incorrectly assumes that all users trust the default list of CAs and makes the adding of exceptions impossible even by advanced users.\n\ntorprojec.org [sic] is just an example, this effects every HSTS site. You can reproduce this problem yourself in version 17 or later if you temporary disable \"DigiCert High Assurance EV Root CA\" in your certificate store and then visit torproject.org. You will notice the ability to add exceptions has been removed and that the cert_override.txt file found in the user's profile is also ignored.\"\n\n\nhttps://support.mozilla.org/en-US/questions/942924\n\n\n***\n\nHPKP limits trust from all CAs to just a few. Its an improvement over the status quo but unless keys are managed vigilantly, sites risk breaking connections of all their users. So many sites especially major ones decide against taking this risk.\n\nhttps://news.netcraft.com/archives/2016/03/22/secure-websites-shun-http-public-key-pinning.html\n\n\n***\n\nWithout HSTS a site that has non-encrypted resources/subdomains or pages is vulnerable to sslstrip.\n\nhttps://security.stackexchange.com/questions/91092/how-does-bypassing-hsts-with-sslstrip-work-exactly"},{"author":"marmarek","date_created":1495275411,"date_modified":1495275411,"content":"Well, if you explicitly type/paste \"https://\" in the url, sslstrip and\nsimilar do not apply. But very few people do that, most follow some\nlink, or type just \"www.torproject.org\" instead of\n\"https://www.torproject.org\"."},{"author":"Patrick","date_created":1495460879,"date_modified":1495460879,"content":"I see, so if a link to a file download with https:// is pasted into a browser, we can be sure that ssl will be used (at least without the browser showing a warning about an attempted sslstrip attack). The issue is only, that the ssl certificate button / padlock is invisible. That's something we can document.\n\n* https://www.whonix.org/wiki/Secure_Downloads\n* https://forums.whonix.org/t/long-wiki-edits-thread/3477/221\n"},{"author":"Patrick","date_created":1495660244,"date_modified":1495660244,"content":"torjunkie has documented it.\n\nhttps://www.whonix.org/wiki/Secure_Downloads"}]},"PHID-TASK-3n2avfoicpx5xavp7h73":{"id":"676","title":"fix obfs4proxy AppArmor issue in Whonix 14","status":"resolved","priority":"Normal","author":"Patrick","description":"It might be broken due to #AppArmor profile related changes by Tor / obfs4proxy in #debian_stretch.\n\nChanges to https://github.com/Whonix/apparmor-profile-anondist might be required.\n\nRelated upstream bug report:\nhttps://trac.torproject.org/projects/tor/ticket/9460\n","comments":[{"author":"JasonJAyalaP","date_created":1496446305,"date_modified":1496446305,"content":"I was trying obfs4proxy in whonix-gateway. I editted the torrc to UseBridges 1 and added the Client Transport line (note, torrc.examples says to add \"managed\" at the end; https://github.com/Yawning/obfs4 does not). I then added bridges from tpo (bridge obfs4 ip ... ).\nWhonixcheck reports WARNING can't connect to bridge REASON=PT_MISSING\nPT_Missing is an error from stem: \"no pluggable transport was available\"\n\nWhat did I do wrong here?"},{"author":"Patrick","date_created":1496495973,"date_modified":1496495973,"content":"Is the `obfs4proxy` package installed? Probably yes.\n\n> What did I do wrong here?\n\nFrom a users pov, probably nothing. Then the ticket description might contain the right guess why this is happening. Tor probably thinks the pluggable transport is not available, because AppArmor prevents execution. TODO: somehow sort out the apparmor mess.\n\n> Whonixcheck reports \n\nOr jump right to Tor:\n\nhttps://www.whonix.org/wiki/Tor#Log_Analysis\n"},{"author":"JasonJAyalaP","date_created":1496510251,"date_modified":1496510365,"content":"You're right. /var/run/tor/log reports\n\"Could not launch managed proxy executable /usr/bin/obfs4proxy Operation not permitted\""},{"author":"JasonJAyalaP","date_created":1498091334,"date_modified":1498091334,"content":"Tor's own app armor profile breaks needed features (obs4). The ticket is 4 years old with no progress. Even they complained about needed to resolve or remove it (years ago)."},{"author":"Patrick","date_created":1498126182,"date_modified":1498126182,"content":"That's why we need to sort it out in https://github.com/Whonix/apparmor-profile-anondist/blob/master/etc/apparmor.d/abstractions/base.anondist somehow."},{"author":"JasonJAyalaP","date_created":1498465979,"date_modified":1498465979,"content":"Which app armor profile is blocking obfs4? Something from us or an apparmor profile that comes from tpo? "},{"author":"Patrick","date_created":1498467212,"date_modified":1498467212,"content":">>! In T676#13825, @JasonJAyalaP wrote:\n> Which app armor profile is blocking obfs4?\n\n`/etc/apparmor.d/system_tor`\n\nTo figure this out, keep watching logs:\n\nhttps://forums.whonix.org/t/whonix-14-debian-stretch-apparmor-related-changes\n\n> Something from us or an apparmor profile that comes from tpo? \n\n```\ndpkg -S /etc/apparmor.d/system_tor\n```\n\n> `tor: /etc/apparmor.d/system_tor`"},{"author":"Patrick","date_created":1498467492,"date_modified":1498467492,"content":"`/etc/apparmor.d/system_tor` is unmodified, owned by Debian `tor` packabe. `/etc/apparmor.d/system_tor` Will `#include <local/system_tor>`.\n\n`/etc/apparmor.d/local/system_tor` (`/etc/apparmor.d/local/system_tor.anondist`) has been taken over by Whonix using config-package-dev displace. Actually \n`/etc/apparmor.d/local/system_tor` is where the fix belongs.\n\nhttps://github.com/Whonix/anon-gw-anonymizer-config/blob/master/etc/apparmor.d/local/system_tor.anondist\n\n(https://github.com/Whonix/anon-gw-anonymizer-config/blob/master/etc/apparmor.d/local/usr.bin.obfsproxy.anondist is unrelated, because it is obfsproxy, not obfs4proxy.)"},{"author":"JasonJAyalaP","date_created":1498470049,"date_modified":1498470143,"content":"To be clear: \nTor ships a broken apparmor profile (for the last 5 years? Suggested nuke of the profile 3 years ago), and we're trying to unbreak obfs4, correct? "},{"author":"Patrick","date_created":1498477021,"date_modified":1498477021,"content":"Yes. Because the other solution \"not use AppArmor for Tor\" is not a great one. It worked in Whonix 13, just needs to be fixed for Whonix 14.\n\nPlease either fix it in Whonix and/or by submitting the appropriate patches to Debian."},{"author":"JasonJAyalaP","date_created":1498686946,"date_modified":1498686964,"content":"AA doesn't report a denied message when tor tries to launch obfs4. However:\n\nthe line \n\n```\n/usr/bin/obfs4proxy PUx, \n```\nin \n/etc/apparmor.d/abstractions/tor\nwhen changed to \n```\n/usr/bin/obfs4proxy rix, \n```\nmakes obfs4 work again. Maybe it should Ux or ix. I'm not sure. But what I really don't know is how system_tor interacts with abstractions/ "},{"author":"Patrick","date_created":1498697748,"date_modified":1498697748,"content":"> But what I really don't know is how system_tor interacts with abstractions/\n\n```\ncat /etc/apparmor.d/system_tor\n# vim:syntax=apparmor\n#include <tunables/global>\n\nprofile system_tor flags=(attach_disconnected) {\n  #include <abstractions/tor>\n```\n\nAnd by the way... Also does...\n\n```\n  # Site-specific additions and overrides. See local/README for details.\n  #include <local/system_tor>\n}\n```"},{"author":"Patrick","date_created":1498698108,"date_modified":1498698108,"content":"`/etc/apparmor.d/system_tor` after `#include <abstractions/tor>` and `#include <local/system_tor>` will be interpreted like the following, I think: \n\n```\n# vim:syntax=apparmor\n#include <tunables/global>\n\nprofile system_tor flags=(attach_disconnected) {\n  #include <abstractions/base>\n  #include <abstractions/nameservice>\n\n  network tcp,\n  network udp,\n\n  capability chown,\n  capability dac_override,\n  capability fowner,\n  capability fsetid,\n  capability setgid,\n  capability setuid,\n\n  /usr/bin/tor r,\n  /usr/sbin/tor r,\n\n  /proc/sys/kernel/random/uuid r,\n  /sys/devices/system/cpu/ r,\n  /sys/devices/system/cpu/** r,\n\n  /etc/tor/* r,\n  /usr/share/tor/** r,\n\n  /usr/bin/obfsproxy PUx,\n  /usr/bin/obfs4proxy PUx,\n\n  owner /var/lib/tor/** rwk,\n  owner /var/lib/tor/ r,\n  owner /var/log/tor/* w,\n\n  # During startup, tor (as root) tries to open various things such as\n  # directories via check_private_dir().  Let it.\n  /var/lib/tor/** r,\n\n  /{,var/}run/tor/ r,\n  /{,var/}run/tor/control w,\n  /{,var/}run/tor/socks w,\n  /{,var/}run/tor/tor.pid w,\n  /{,var/}run/tor/control.authcookie w,\n  /{,var/}run/tor/control.authcookie.tmp rw,\n  /{,var/}run/systemd/notify w,\n\n  ## Anonymity Distributions\n  /etc/hosts.anondist r,\n  /etc/resolv.conf.anondist r,\n  /run/tor r,\n  /run/tor/log rwk,\n\n## Add permissions for obfsproxy and flashproxy.\n## AUDIT:\n## These profile rules may be too permissive. Needs audit and someone dedicated\n## to work on AppArmor profiles. It's not a serious security issue in any case,\n## because AppArmor isn't enabled by default in Debian stretch yet and little\n## work is being done on it at time of writing. So it's a lax AppArmor profile\n## versus no AppArmor at all.\n\n  ## obfsproxy\n  /usr/local/lib/python*/** r,\n  /var/log/tor/log rw,\n  /dev/urandom r,\n  /dev/random r,\n  /usr/** r,\n  /etc/python*/sitecustomize.py r,\n  ## https://forums.whonix.org/t/after-last-apt-get-upgrade-gateway-doesnt-connect-to-tor-anymore\n  #/usr/bin/obfsproxy rix,\n\n  ## flashproxy\n  @{HOME}/.tb/tor-browser/App/flashproxy-client rix,\n  @{HOME}/.tb/tor-browser/App/flashproxy-reg-appspot rix,\n  @{HOME}/.tb/tor-browser/App/flashproxy-reg-url rix,\n  @{HOME}/.tb/tor-browser/App/flashproxy-reg-http rix,\n  @{HOME}/.tb/tor-browser/App/flashproxy-reg-email rix,\n  @{HOME}/.tb/tor-browser/App/** rm,\n  /usr/bin/python* rix,\n  /usr/lib/python*/dist-packages/** m,\n  /usr/lib/python*/lib-dynload/** m,\n  /usr/lib/pyshared/python*/OpenSSL/** m,\n  /usr/lib/python*/lib-dynload/** m,\n  /usr/lib/pyshared/python*/numpy/** m,\n  /proc/*/mounts r,\n}\n```\n"},{"author":"JasonJAyalaP","date_created":1498699596,"date_modified":1498699697,"content":"Ah. I didn't see the include. Makes sense.\n\nPUx + those obfsproxy specific rules work fine.\nChanging obfs4 to rix works fine.\n\nQuestions:\n\n# Is \"include abstractions/tor\" normal and desirable behavour? Is that something tor does or we do? Shouldn't all our changes be in .anondist?\n# I don't fully understand apparmors execution persions (http://wiki.apparmor.net/index.php/QuickProfileLanguage#Execute_permissions). But if obfsproxy is being executed as \"unconfined\" (PUx), are those  obfsproxy specific permissions (under AUDIT) even doing anything? They were with rix, I believe, but not currently. Actually, the P means it will look for a obfsproxy specific profile. So we certainly don't need both.\n# I didn't fully understand the problem people were getting with obfsproxy rix. I wonder if it can be fixed (or if we should just run it unconfined.\n# I have *no clue* why a more restrictive exection permission (rix) would allow tor to run obfs4proxy, but a less restrictive one (PUx) would not.\n# That apparmor page isn't clear if capital PU is prefered for productive and not only development (I'm not sure what \"scrub the environment\" means)\n"},{"author":"Patrick","date_created":1498738482,"date_modified":1498738482,"content":">>! In T676#13872, @JasonJAyalaP wrote:\n> Ah. I didn't see the include. Makes sense.\n\nI mentioned it in T676#13830.\n\n> # Is \"include abstractions/tor\" normal and desirable behavour?\n\nYes, many profiles do that.\n\n> Is that something tor does or we do?\n\nTor should do.\n\n> Shouldn't all our changes be in .anondist?\n\nIdeally, yes in local/name.anondist. Seems most appropriate where distributions should add their overrides in absence of something better.\n\n> # I don't fully understand apparmors execution persions (http://wiki.apparmor.net/index.php/QuickProfileLanguage#Execute_permissions). But if obfsproxy is being executed as \"unconfined\" (PUx), are those  obfsproxy specific permissions (under AUDIT) even doing anything? They were with rix, I believe, but not currently. Actually, the P means it will look for a obfsproxy specific profile. So we certainly don't need both.\n> # I didn't fully understand the problem people were getting with obfsproxy rix. I wonder if it can be fixed (or if we should just run it unconfined.\n\nRunning obs(4)proxy unconfined should be good enough for now until an obfs4proxy profiles is provided. We could contribute this as an enhancement later.\n\n> # That apparmor page isn't clear if capital PU is prefered for productive and not only development (I'm not sure what \"scrub the environment\" means)\n\nEnvironment variables. Should be preferred if possible, although environment should be clean anyhow since started by systemd."},{"author":"Patrick","date_created":1498739435,"date_modified":1498739453,"content":"In this case, a `/local` file can probably not do the trick.\n\nIf we run unconfined, the following is probably alright to remove.\n\n```\n  ## obfsproxy\n  /usr/local/lib/python*/** r,\n  /var/log/tor/log rw,\n  /dev/urandom r,\n  /dev/random r,\n  /usr/** r,\n  /etc/python*/sitecustomize.py r,\n  ## https://forums.whonix.org/t/after-last-apt-get-upgrade-gateway-doesnt-connect-to-tor-anymore\n  #/usr/bin/obfsproxy rix,\n```\n\nSince `/usr/bin/obfs4proxy PUx,` is included by Debian `tor`s `/etc/apparmor.d/abstractions/tor`, upstream has probably attempted to fix the apparmor profile thing. Since you don't get any apparmor warnings, the issue is not apparmor, but systemd seccomp whitelist.\n\n-----\n\nYes. Something in `/lib/systemd/system/tor@default.service` is causing this.\n\n```\n#NoNewPrivileges=yes\n#PrivateTmp=yes\n#PrivateDevices=yes\n#ProtectHome=yes\n#ProtectSystem=full\n#ReadOnlyDirectories=/\n#ReadWriteDirectories=-/proc\n#ReadWriteDirectories=-/var/lib/tor\n#ReadWriteDirectories=-/var/log/tor\n#ReadWriteDirectories=-/var/run\n#CapabilityBoundingSet=CAP_SETUID CAP_SETGID CAP_NET_BIND_SERVICE CAP_DAC_OVERRIDE\n```\n\nNext steps. Please:\n\n* figure out which one\n* reproduce this on plain non-Whonix Debian\n* report a bug against Debian's `tor` package (if there isn't already one)\n* add a systemd drop-in `.d` file for tor's systemd unit as our Whonix specific override (to be included in package #anon-gw-anonymizer-config)\n"},{"author":"Patrick","date_created":1498739641,"date_modified":1498739641,"content":"To save you from somehow learning about systemd overrides the hard way...\n\nIf for example in line `CapabilityBoundingSet=CAP_SETUID CAP_SETGID CAP_NET_BIND_SERVICE CAP_DAC_OVERRIDE` the `CAP_DAC_OVERRIDE` is the issue... Create a file...\n\n`/lib/systemd/system/tor@default.service.d/40_obfs4proxy-workaround.conf`\n\n```\n[Service]\nCapabilityBoundingSet=CAP_SETUID CAP_SETGID CAP_NET_BIND_SERVICE\n```\n\nThis *could* be the solution then. Just to show the general syntax of systemd override files."},{"author":"JasonJAyalaP","date_created":1498786737,"date_modified":1498787991,"content":"It's \n\n> nonewprivileges=yes \n\nComment that and obfs4proxy can run as PUx (instead of needing ix)\n\nfrom: https://www.freedesktop.org/software/systemd/man/systemd.exec.html#NoNewPrivileges=\n\nNoNewPrivileges=\n\nTakes a boolean argument. If true, ensures that the service process and all its children can never gain new privileges through execve() (e.g. via setuid or setgid bits, or filesystem capabilities). This is the simplest and most effective way to ensure that a process and its children can never elevate privileges again.\n\nIs it the nature of obfs4 to require \"gaining new privileges\"? If so, we have to remove this line or change the execution permissions of obfs4 in apparmor. (btw, I haven't been able to debug tor without apparmor. If I aa-disable the tor profile, tor fails to load.)"},{"author":"JasonJAyalaP","date_created":1498787846,"date_modified":1498787846,"content":"I commented out the lines in local/system_tor about obfsproxy. This caused obfsproxy to fail. Changing obfsproxy to rix didn't work. But I'm confused at what I'm seeing, and so I'm still looking at it."},{"author":"Patrick","date_created":1498819477,"date_modified":1498819477,"content":"`Pux` (already Tor's default) is alright.\n\n>>! In T676#13940, @JasonJAyalaP wrote:\n> Is it the nature of obfs4 to require \"gaining new privileges\"?\n\nI have no idea.\n\nIf so, we have to remove this line or change the execution permissions of obfs4 in apparmor.\n\n> (btw, I haven't been able to debug tor without apparmor. If I aa-disable the tor profile, tor fails to load.)\n\naa-disable does not apply to Tor's systemd service, because it's systemd unit file enforces apparmor independent from aa-disable / aa-enforce command line tools.\n\n`/lib/systemd/system/tor@default.service`:\n\n```\nAppArmorProfile=system_tor\n```\n"},{"author":"JasonJAyalaP","date_created":1498869723,"date_modified":1498869723,"content":"Two things work:\n\n1. Changing obfs4 execution permission in system_tor apparmor profile (abstractions/tor) from PUx to ix.\n\n2. Keeping PUx but removing \"NoNewPrivileges\" from tor@default systemd service (/lib/systemd/system)\n\nI have no idea why PUx fails without an AA message with NNP enabled, but works with ix with NNP enabled. I don't know how they interact. I'm not even sure who to ask? Obfs4 for a patch? AA guys for an explanation about how PUx interacts with NNP? Systemd guys for debugging NNP? How much does it matter? Debian people about why they have NNP in their tor service?\n\nWhat do you want me to do next?\n\n"},{"author":"Patrick","date_created":1498903043,"date_modified":1498903043,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n> Two things work:\n> \n> 1. Changing obfs4 execution permission in system_tor apparmor profile\n> (abstractions/tor) from PUx to ix.\n> \n> 2. Keeping PUx but removing \"NoNewPrivileges\" from tor@default\n> systemd service (/lib/systemd/system)\n\nPlease report this analysis at the Debian tracker for the tor package.\nThat's the right place and the right maintainer to figure out. Debian\nbug reporting policy even recommends to report bugs against Debian,\nbecause then maintainers will contact upstream of Debian.\n\n(Sometimes we ignore this - when Debian maintainers don't do it, are\nslow, or somehow it does not matter. For example, why should one request\na new add-on api for firefox from Debian if that can be requested at\nMozilla's tracker. But in this case, the apparmor profile and systemd\nunit file is by Debian, not by Tor Project, I think.)\n\nMeanwhile, until upstream sorts this out, please add a systemd `.d`\n*drop-in* as mentioned above as temporary workaround disabling it.\n\n```\n[Service]\nNoNewPrivileges=\n```\n\nPlus with `##` a short comment and a link to this ticket to justify the\nchange (even to ourselves if we look into it again in future).\n\n(If that does not work: Try `NoNewPrivileges=No`.)\n\nI prefer this solution, because it's the most lightweight and least\nintrusive workaround, most likely stable one as well. We can use a\ndrop-in and don't need to modify any files owned by upstream/third party\npackages.\n\nOnce upstream has sorted that, we need to remove our workaround."},{"author":"JasonJAyalaP","date_created":1499290617,"date_modified":1499290928,"content":"Ok I created the workaround as you described:\nhttps://github.com/Whonix/anon-gw-anonymizer-config/blob/master/lib/systemd/system/tor@default.service.d/40_obfs4proxy-workaround.conf"},{"author":"JasonJAyalaP","date_created":1499293515,"date_modified":1499293515,"content":"Debian bug report:\n\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=867342"},{"author":"Patrick","date_created":1499344110,"date_modified":1499344110,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   Ok I created the workaround as you described:\n>   \n>   https://github.com/Whonix/anon-gw-anonymizer-config/commit/bfe28e340d03cc4d77e4f49e24bcc0a9da42da06\n\nPlease add also a link to this ticket so further discussion can be\ndirected to this ticket rather than having it all over the place."},{"author":"Patrick","date_created":1499344507,"date_modified":1499344507,"content":"Please keep the #Whonix_14 tag. I guess this can be closed, resolved?\n\nThe idea is to keep tracking this as part of a list of tasks that were done for Whonix 14.\n\nThe thing is, without any version tag for any future Whonix version, the ticket gets kinda lost in the deepness of the task tracker and unlikely being worked again in future.\n\nThe only remaining TODO is to keep answering https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=867342. But for that I am not sure we should leave this ticket open? Or rewrite the ticket? Or open a new one?\n\nI usually closed it, because I'll get e-mail notifications for for replies from upstream tickets anyhow."},{"author":"Patrick","date_created":1504440747,"date_modified":1504440747,"content":">>! In T676#14015, @JasonJAyalaP wrote:\n> Ok I created the workaround as you described:\n> https://github.com/Whonix/anon-gw-anonymizer-config/blob/master/lib/systemd/system/tor@default.service.d/40_obfs4proxy-workaround.conf\n\nIt's broken. systemd journal reports:\n\n`Sep 03 11:52:33 host systemd[1]: [/lib/systemd/system/tor@default.service.d/40_obfs4proxy-workaround.conf:4] Failed to parse boolean value, ignoring:`\n\nSince https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=867342 was fixed but torproject's stretch repository [1] does not contain tor_0.3.1.5 yet.\n\nPlease fix and test.\n\n[1] https://deb.torproject.org/torproject.org/dists/stretch/main/binary-amd64/Packages\n"},{"author":"JasonJAyalaP","date_created":1504559491,"date_modified":1504559491,"content":"I changed it to\nNoNewPrivileges=No\nThat's the only thing I can imagine that would be causing that parsing error. Testing now\n\n> torproject's stretch repository [1] does not contain tor_0.3.1.5 yet.\n\nOnce TPOs stretch repo contains the latest, this workaround will no longer be needed, correct?\n\nAny ETA on the repo including the latest?\n\n"},{"author":"JasonJAyalaP","date_created":1504560551,"date_modified":1504560551,"content":"with =no, I'm no longer getting the parsing error\n\n```\nsudo journalctl | grep workaround\n```\n\nbut /lib/systemd/system/tor@default.service is unaffected\n\n```\n# Hardening\nAppArmorProfile=system_tor\nNoNewPrivileges=yes\nPrivateTmp=yes\nPrivateDevices=yes\nProtectHome=yes\n...\n```"},{"author":"Patrick","date_created":1504605406,"date_modified":1504605406,"content":">>! In T676#14449, @JasonJAyalaP wrote:\n> with =no, I'm no longer getting the parsing error\n> \n> ```\n> sudo journalctl | grep workaround\n> ```\n> \n> but /lib/systemd/system/tor@default.service is unaffected\n> \n> ```\n> # Hardening\n> AppArmorProfile=system_tor\n> NoNewPrivileges=yes\n> PrivateTmp=yes\n> PrivateDevices=yes\n> ProtectHome=yes\n> ...\n> ```\n\nExpected so it is. `systemctl cat tor@default` (should be same as `systemctl cat tor@default.service`) should show it.\n\nAnd does obfs4proxy actually work then?"},{"author":"Patrick","date_created":1504605853,"date_modified":1504605853,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   I changed it to\n>   NoNewPrivileges=No\n>   That's the only thing I can imagine that would be causing that parsing error. Testing now\n>   \n>   > torproject's stretch repository [1] does not contain tor_0.3.1.5 yet.\n>   \n>   Once TPOs stretch repo contains the latest, this workaround will no longer be needed, correct?\n\nThat's what one could conclude from the bug report that you wrote\nearlier in this ticket which is now resolved on the Debian bug tracker.\n\n>   Any ETA on the repo including the latest?\n\nFor a different subject, iry has figured out the Tor life cycle here.\n\nhttp://forums.whonix.org/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/335"},{"author":"JasonJAyalaP","date_created":1504722193,"date_modified":1504722193,"content":"Ah I see.\n\n```\nuser@host:~$ systemctl cat tor@default\n# /lib/systemd/system/tor@default.service\n[Unit]\nDescription=Anonymizing overlay network for TCP\nAfter=network.target nss-lookup.target\nPartOf=tor.service\nReloadPropagatedFrom=tor.service\n\n[Service]\nType=notify\nNotifyAccess=all\nPIDFile=/var/run/tor/tor.pid\nPermissionsStartOnly=yes\nExecStartPre=/usr/bin/install -Z -m 02755 -o debian-tor -g debian-tor -d /var/run/tor\nExecStartPre=/usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-torrc -f /etc/tor/torrc --RunAsDaemon 0 --verify-config\nExecStart=/usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-torrc -f /etc/tor/torrc --RunAsDaemon 0\nExecReload=/bin/kill -HUP ${MAINPID}\nKillSignal=SIGINT\nTimeoutStartSec=300\nTimeoutStopSec=60\nRestart=on-failure\nLimitNOFILE=65536\n\n# Hardening\nAppArmorProfile=system_tor\nNoNewPrivileges=yes\nPrivateTmp=yes\nPrivateDevices=yes\nProtectHome=yes\nProtectSystem=full\nReadOnlyDirectories=/\nReadWriteDirectories=-/proc\nReadWriteDirectories=-/var/lib/tor\nReadWriteDirectories=-/var/log/tor\nReadWriteDirectories=-/var/run\nCapabilityBoundingSet=CAP_SETUID CAP_SETGID CAP_NET_BIND_SERVICE CAP_DAC_READ_SEARCH\n\n# /lib/systemd/system/tor@default.service.d/40_obfs4proxy-workaround.conf\n## The hardening option NoNewPrvileges=Yes in the Debian tor@default.service file breaks loading of obfs4proxy in combination with Debian's apparmor profile which uses PUx. (ix ex\n## https://phabricator.whonix.org/T676\n[Service]\nNoNewPrivileges=no\n```\n\nTested with bridges obfs4 from TPO. Connects.\n\n"}]},"PHID-TASK-oiedfqq2nzpjognw7zy7":{"id":"675","title":"fix whonixcheck whonix-firewall check race condition","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_services.bsh\n\n    systemctl --no-pager --no-block status whonix-firewall\n\nNeeds to be more lenient.\n\nMore like https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_control_port_filter.bsh, waiting, testing this multiple times in a loop.\n","comments":[{"author":"Patrick","date_created":1512244676,"date_modified":1512244676,"content":"https://github.com/Whonix/whonixcheck/commit/22e19e975fb12566504720a81ef1f106be76d62c"}]},"PHID-TASK-awglbydft5uso7vtmlzo":{"id":"674","title":"phabricator replies by e-mail issue coming from noreply@phabricator.whonix.org","status":"invalid","priority":"Normal","author":"Patrick","description":"@dau had some issues. See T659#13168.\n\nI am getting mails from:\n\n> phabricator+T659+randomstring+randomstring@phabricator.whonix.org\n\nphabricator e-mail replies work for me.\n\n@dau is getting mails from:\n\n> noreply@phabricator.whonix.org\n\nTherefore replies by e-mail don't work.\n\nAny idea? @fortasse\n","comments":[{"author":"fortasse","date_created":1494169106,"date_modified":1494169535,"content":"The `From:` and `Reply-to:` headers should be different. The `From: noreply@phabricator.whonix.org` is expected. @dau, what does your `Reply-to:` header say?\n\nI suspect this is a mail client issue, I haven't made any changes to phabricator's mail configuration."},{"author":"dau","date_created":1494300123,"date_modified":1494300123,"content":"Correct, I receive notifications from `noreply@phabricator.whonix.org`. The reply was indeed sent\n\n`To: phabricator+T659+randomstring+randomstring@phabricator.whonix.org`\n\nand\n\n`In-Reply-To: 86597b9685976b1e05d10fc75f89ed83@localhost.localdomain`\n\nAlso, my mail client is mutt.\n\nThanks!"},{"author":"fortasse","date_created":1494331806,"date_modified":1494331806,"content":"I think it's because you started with a quoted line. I'm testing this\ntheory now."},{"author":"fortasse","date_created":1494331861,"date_modified":1494331861,"content":"> This is an email reply with a \"quoted\" first line\n\nAnd here is a regular line"},{"author":"fortasse","date_created":1494332458,"date_modified":1494332458,"content":"How very odd. This is apparently a known issue upstream: https://secure.phabricator.com/T5181.\n\nApparently my fake quoted line doesn't break it since it's not an actual quote? I'm very confused, but I guess it's not very high priority for upstream to fix."},{"author":"dau","date_created":1494679340,"date_modified":1494679340,"content":"Was the text you sent exactly the following?\n\n```\n> This is an email reply with a \"quoted\" first line\n\nAnd here is a regular line\n```\n\nWell, at least personally I do not think it's a high priority issue as well. I'm fine by using the web interface. Should we schedule a reminder to ask them about it or something like that?"},{"author":"Patrick","date_created":1544334907,"date_modified":1544334907,"content":"Please reopen if still an issue."}]},"PHID-TASK-ag7e242onamjwq2xidqq":{"id":"673","title":"document https downgrade sslstrip defenses - wget vs curl vs scurl","status":"resolved","priority":"Normal","author":"Patrick","description":"We sometimes need commands such as the following in the wiki.\n\n     wget https://www.torproject.org/dist/torbrowser/7.0a3/sandbox-0.0.6-linux64.zip.asc\n\nwget is more usable than plain `curl` in command line. But is wget secure?\n\nThere was a pretty strange bug. Not sure it was ever fixed.\n\nhttps://lists.gnu.org/archive/html/bug-wget/2012-07/msg00015.html\n\nIs wget vulnerable to sslstrip?\n\n-----\n\n> Simple wrapper called scurl, that adds \"--tlsv1 --proto =https\" in front of all invocations of \"curl\" when running \"scurl\".\n\nhttps://github.com/Whonix/scurl/blob/master/usr/bin/scurl\n\nscurl makes things simpler than typing `--tlsv1.2 --proto =https`. But it's still inconvenient.\n\nI used to use like...\n\n    scurl https://www.torproject.org/dist/torbrowser/7.0a3/sandbox-0.0.6-linux64.zip.asc > sandbox-0.0.6-linux64.zip.asc\n\nWhich is cumbersome.\n\nPerhaps `scurl` should also prepend `--remote-name`? Then we could simply use:\n\n     scurl https://www.torproject.org/dist/torbrowser/7.0a3/sandbox-0.0.6-linux64.zip.asc\n\n(Which would result in:)\n\n    curl --tlsv1.2 --proto =https --remote-name https://www.torproject.org/dist/torbrowser/7.0a3/sandbox-0.0.6-linux64.zip.asc\n\nscurl isn't the answer either, since it's mostly only available in Whonix so it does not work for instructions generally everywhere.\n\nIs curl with `--proto =https` required? Is curl otherwise vulnerable to sslstrip?\n\n-----\n\nTODO:\n\n* ask if curl is vulnerable to sslstrip / https downgrade attacks\n* ask if wget is vulnerable to sslstrip / https downgrade attacks\n","comments":[{"author":"Patrick","date_created":1494163378,"date_modified":1494163378,"content":"Could you work on this one please? @HulaHoop "},{"author":"Patrick","date_created":1494247921,"date_modified":1494247921,"content":"`add --remote-name so scurl can be used as wget replacement`\nhttps://github.com/Whonix/scurl/commit/9006429ff7f9f39ff4dc367848ff45b690957881"},{"author":"HulaHoop","date_created":1494345158,"date_modified":1494345158,"content":"> Could you work on this one please? @HulaHoop\n\nI'm on it."},{"author":"HulaHoop","date_created":1494348296,"date_modified":1494348296,"content":"\n\nHSTS is a server side opt-in standard meaning it can fail silently if the user does not force a request to use SSL. So its useless by itself.\n\nhttps://stackoverflow.com/a/38835162\n\n***\n\nCurl does not detect or warn against protocol changes during redirect. No one has stepped up to add patches. Users run \"--proto-redir =https\" instead which protects against downgrade but has the side effect of making things harder.\n\nhttps://github.com/curl/curl/issues/226\nhttps://github.com/curl/curl/issues/1026\nhttps://curl.haxx.se/docs/todo.html#Refuse_downgrade_redirects\n\n\n***\n\n\nWget can force ssl but without it, its vulnerable. As for the buggy behavior you mentioned - it seems to check server certs against installed root CAs by default. To stop this use \"--no-check-certificate\" in combination with one of the commands that point to a PEM file of choice to fail closed.\n\nhttps://www.gnu.org/software/wget/manual/html_node/HTTPS-_0028SSL_002fTLS_0029-Options.html\n\n***\n\n>scurl isn't the answer either, since it's mostly only available in Whonix so it does not work for instructions generally everywhere.\n\nHopefully this can change if its accepted upstream by privacy maintainers."},{"author":"Patrick","date_created":1494948632,"date_modified":1494948632,"content":"Great research! Now this needs to be documented.\n\nhttps://forums.whonix.org/t/long-wiki-edits-thread/3477/193"},{"author":"Patrick","date_created":1495660345,"date_modified":1495660345,"content":"torjunkie has documented it.\n\n* https://www.whonix.org/wiki/Secure_Downloads\n* https://www.whonix.org/wiki/Template:Scurl\n"},{"author":"Patrick","date_created":1676631135,"date_modified":1676631135,"content":"https://forums.whonix.org/t/whonix-linux-installer-development-discussion/15917/20"}]},"PHID-TASK-4pr6wvo7lgpxtouhp362":{"id":"672","title":"Tor Browser 7.0a3 apparmor fixes","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/7-0a3-tor-browser-series-defunct-in-whonix","comments":[{"author":"Patrick","date_created":1493993736,"date_modified":1493993736,"content":"https://github.com/Whonix/apparmor-profile-torbrowser/commit/9032e909c2b10e20ecf104d4eb1acc120df167d1"}]},"PHID-TASK-3b2vj67ec7cvowbpu2h2":{"id":"671","title":"old Tor Browser versions in /var/cache/tb-binary/.tb/ accumulate in Qubes-Whonix, users run into full up disk error issues","status":"resolved","priority":"Normal","author":"Patrick","description":"As reported by @torjunkie.\n\n    ls -la /var/cache/tb-binary/.tb/\n\n> `tor-browser.old.*`\n\nHow do we solve it?\n\nSay user customizations in `/var/cache/tb-binary/.tb/` are discouraged? Just delete all `/var/cache/tb-binary/.tb/tor-browser.old.*` in #Whonix_14?\n\nforum discussion:\nhttps://forums.whonix.org/t/7-0a3-tor-browser-series-defunct-in-whonix/3786/17\n","comments":[{"author":"JasonJAyalaP","date_created":1496513699,"date_modified":1496513699,"content":"What is the purpose of this folder? Qubes specific?\nWhy would user customizations ever be put in any /cache/ folder?\nHow does this relate to ~/.tb/ ?"},{"author":"Patrick","date_created":1496668518,"date_modified":1496668518,"content":"Yes, Qubes specific. Background:\n\n* T417\n* https://www.whonix.org/wiki/Tor_Browser/Advanced_Users#tb-updater_in_Qubes_TemplateVM\n\n> Why would user customizations ever be put in any /cache/ folder?\n\nSo these propagate from the TemplateVM to all TemplateBasedAppVMs.\n\n> How does this relate to ~/.tb/ ?\n\nhttps://github.com/Whonix/tb-updater/blob/master/usr/lib/tb-updater/first-boot-home-population\n\n(Running in in TemplateBasedAppVMs only.)\n\n-----\n\nhttps://unix.stackexchange.com/questions/35832/how-do-i-get-the-md5-sum-of-a-directorys-contents-as-one-sum\n"},{"author":"marmarek","date_created":1502138500,"date_modified":1502138500,"content":"What exactly is the use case when removing old `/var/cache/tb-binary/.tb/tor-browser.old.*` is bad?\nIIUC this ticket is blocking tb-updater stable upgrade (T690), which would fix qubes-whonix build failure (T710). Which is a blocker for having Whonix templates for Qubes 4.0."},{"author":"Patrick","date_created":1502193893,"date_modified":1502193893,"content":"marmarek (Marek Marczykowski-Górecki):\n> marmarek added a comment.\n> \n> \n>   What exactly is the use case when removing old `/var/cache/tb-binary/.tb/tor-browser.old.*` is bad?\n\nUsers who customized would have data loss. Probably a rare case. If\nthat's acceptable for you, at this point, I don't mind either. It's the\neasiest solution that is doable.\n\n>   IIUC this ticket is blocking tb-updater stable upgrade (https://phabricator.whonix.org/T690), which would fix qubes-whonix build failure (https://phabricator.whonix.org/T710). Which is a blocker for having Whonix templates for Qubes 4.0.\n\nYes."},{"author":"marmarek","date_created":1502534990,"date_modified":1502534990,"content":"Proposed fix here: https://github.com/Whonix/tb-updater/pull/1"},{"author":"Patrick","date_created":1502818280,"date_modified":1502818280,"content":"Thank you very much for the PR!\n\nDoesn't work.\n\nDo we need `ls`? Glob (`*`) alone should do?\n\n    ls -r /var/cache/tb-binary/.tb/tor-browser.old.*\n\n```\n/var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:40:\nstart-tor-browser.desktop  Browser\n\n/var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:39:\nstart-tor-browser.desktop  Browser\n\n/var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:38:\nstart-tor-browser.desktop  Browser\n\n/var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:37:\nstart-tor-browser.desktop  Browser\n```\n\nShows the inside of the folder.\n\nxtrace:\n\n```\n+++ tb_move_old_version\n+++ shopt -s nullglob\n+++ local keep_counter\n+++ '[' '' = true ']'\n+++ '[' -d /var/cache/tb-binary/.tb/tor-browser ']'\n+++ '[' -z '' ']'\n+++ TB_KEEP_OLD_VERSIONS_COUNT=3\n+++ '[' 3 = all ']'\n+++ keep_count=3\n++++ ls -r /var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:37 /var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:38 /var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:39 /var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:40\n+++ for old_folder in '$(ls -r \"$tb_browser_folder.old.\"*)'\n+++ '[' -d /var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:40: ']'\n+++ continue\n+++ for old_folder in '$(ls -r \"$tb_browser_folder.old.\"*)'\n+++ '[' -d start-tor-browser.desktop ']'\n+++ continue\n+++ for old_folder in '$(ls -r \"$tb_browser_folder.old.\"*)'\n+++ '[' -d Browser ']'\n+++ continue\n+++ for old_folder in '$(ls -r \"$tb_browser_folder.old.\"*)'\n+++ '[' -d /var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:39: ']'\n+++ continue\n+++ for old_folder in '$(ls -r \"$tb_browser_folder.old.\"*)'\n+++ '[' -d start-tor-browser.desktop ']'\n+++ continue\n+++ for old_folder in '$(ls -r \"$tb_browser_folder.old.\"*)'\n+++ '[' -d Browser ']'\n+++ continue\n+++ for old_folder in '$(ls -r \"$tb_browser_folder.old.\"*)'\n+++ '[' -d /var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:38: ']'\n+++ continue\n+++ for old_folder in '$(ls -r \"$tb_browser_folder.old.\"*)'\n+++ '[' -d start-tor-browser.desktop ']'\n+++ continue\n+++ for old_folder in '$(ls -r \"$tb_browser_folder.old.\"*)'\n+++ '[' -d Browser ']'\n+++ continue\n+++ for old_folder in '$(ls -r \"$tb_browser_folder.old.\"*)'\n+++ '[' -d /var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:37: ']'\n+++ continue\n+++ for old_folder in '$(ls -r \"$tb_browser_folder.old.\"*)'\n+++ '[' -d start-tor-browser.desktop ']'\n+++ continue\n+++ for old_folder in '$(ls -r \"$tb_browser_folder.old.\"*)'\n+++ '[' -d Browser ']'\n+++ continue\n++ tb_run_function tb_install\n```\n"},{"author":"marmarek","date_created":1502820192,"date_modified":1502820192,"content":"I've tried glob, but I need reversed order and failed to do that with glob. `ls -dr` should do. Unless `$tb_browser_folder` itself contains spaces..."},{"author":"Patrick","date_created":1503566238,"date_modified":1503566238,"content":"That works better. But still not sufficient. It's in the wrong order.\n\n    for x in $(ls -dr /var/cache/tb-binary/.tb/tor-browser.old*) ; do echo $x ; done\n```\n/var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:40\n/var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:39\n/var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:38\n/var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:37\n```\n\n-----\n\n    for x in $(ls -tdr /var/cache/tb-binary/.tb/tor-browser.old*) ; do echo $x ; done\n\n```\n/var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:37\n/var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:38\n/var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:39\n/var/cache/tb-binary/.tb/tor-browser.old.2017-05-05-13:45:40\n```\n\nShould do?"},{"author":"Patrick","date_created":1503587704,"date_modified":1503587704,"content":"The version with that fix is now available from `jessie-proposed-updates`."},{"author":"marmarek","date_created":1503683161,"date_modified":1503683161,"content":"The idea was to keep X newest entries. not oldest, right? So the first order is right (the code skip X \"first\" directories). Also, I'd trust more file names, not modification time - the later is easy to mess up (and a consequence will be removing wrong directory - possibly containing just modified data)."},{"author":"Patrick","date_created":1503921143,"date_modified":1503921143,"content":"True.\n\nFixed package uploaded to jessie-proposed-updates."}]},"PHID-TASK-l4gmuy3cuov3icsa3hqv":{"id":"670","title":"Activating Lockdown","status":"open","priority":"Normal","author":"HulaHoop","description":"Consider activating \"Lockdown\" a mainlined patch that does some hardening measures that including some grsec formerly did. Package currently available only in Sid.\n\nWhat it does:\n* disables loading/removing kernel modules after boot\n* disables live kernel patching (kexec)\n* disables Berkeley packet filter (BPF)\n\n (*) No unsigned modules and no modules for which can’t validate the signature.\n\n (*) No use of ioperm(), iopl() and no writing to /dev/port.\n\n (*) No writing to /dev/mem or /dev/kmem.\n\n (*) No hibernation.\n\n (*) Restrict PCI BAR access.\n\n (*) Restrict MSR access.\n\n (*) No kexec_load().\n\n (*) Certain ACPI restrictions.\n\n (*) Restrict debugfs interface to ASUS WMI.\n\n\n***\n\nWhile idsabling modules might interfere with non buil-in devices, they can be whitelisted on demand or an extended timeout specified so the needed components are loaded during boot.\n\n***\n\n\nhttps://www.phoronix.com/scan.php?page=news_item&px=Linux-Kernel-Lockdown-Patches\n\nhttps://lwn.net/Articles/719035/\n\nhttps://packages.debian.org/sid/lockdown\n\nhttps://gitlab.com/taggart/lockdown\n\n----\n\nhttps://forums.whonix.org/t/kernel-hardening/7296\n\nhttps://forums.whonix.org/t/linux-lockdown-kernel-parameter/8671\n","comments":[{"author":"HulaHoop","date_created":1553830761,"date_modified":1553830761,"content":"\n\nLikely part of 5.2. We won't see it until the version after Buster unless we use backports.\n\nhttps://www.phoronix.com/scan.php?page=news_item&px=LOCKDOWN-PR-For-Linux-5.2"},{"author":"Patrick","date_created":1554401697,"date_modified":1554401697,"content":"Any opinion? @marmarek "},{"author":"marmarek","date_created":1554403908,"date_modified":1554403908,"content":"This looks like focused on kernel protection from attacker having full user (or even root) access already. Something very desirable on server/multi user systems, but not so much meaningful in a single-user AppVM.\nAlso, disabling modules loading at all may break attaching devices (block, usb etc).\nOther than modules loading, it shouldn't harm, though."},{"author":"HulaHoop","date_created":1556900041,"date_modified":1556900041,"content":"Related thread on general kernel hardening:\n\nhttps://forums.whonix.org/t/kernel-hardening/7296/9"},{"author":"Patrick","date_created":1557091680,"date_modified":1557091680,"content":"`More kernel hardening`:\nhttps://github.com/Whonix/security-misc/pull/5"},{"author":"Patrick","date_created":1562136335,"date_modified":1562136335,"content":"Could you test this please by installing in VM and/or host please? @madaidan "},{"author":"madaidan","date_created":1562165936,"date_modified":1562165936,"content":"I can test it but I doubt lockdown will help at all.\n\nCopy/paste from what I said on the forums:\n\nI’ve looked at the lockdown code and all it does is change 3 sysctl settings, two of which we already use (in security-misc) and the third one just prevents modules from being loaded after boot which isn’t that much of a security gain.\n\nEither, I’m missing something massive or lockdown is mostly useless for us."},{"author":"madaidan","date_created":1570214266,"date_modified":1570214266,"content":"It turns out, what I said only applies to the Debian package. The kernel patch and the package are actually two different things.\n\nMany of the things in the kernel patch are already enabled by default or are enabled in security-misc. There's very little advantage.\n\nAlso, Daniel Micay has interesting things to say about lockdown.\n\nhttps://twitter.com/DanielMicay/status/1180072339112898562\n\n> Almost entirely security theater with no real impact. Not relevant in any way to solving these kinds of problems or mitigating kernel vulnerabilities. It's based around providing a bogus, incomplete form of secure boot not actually providing any real security value to end users.\n\n> It's a marketing-focused, incomplete and useless approach to secure boot. The total value of it is negligible and it's very unfortunate that it's all grouped together as part of something that's almost completely nonsense with no real threat model or use case thought out for it."}]},"PHID-TASK-xskglidw2ywzhnxlbeya":{"id":"669","title":"Open a Debian ticket for the \"Listen Port Convention\"","status":"open","priority":"Normal","author":"dau","description":"The [[ https://github.com/Whonix/proposals/blob/master/635-listen-port-convention.txt | Listen Port Convention proposal ]] is finished, received some feedback and seems ready to be published as an actual convention.\n\nWe should open a ticket on Debian's tracker after stretch is released so they will have time to take a look into it.","comments":[{"author":"Patrick","date_created":1493600791,"date_modified":1493600791,"content":"Adding some project tags (sometimes I call them components) that act as reminder to do this when time is due."}]},"PHID-TASK-vrojzkqrqodewof3rr4h":{"id":"668","title":"Create a spec for composing proposals/specs","status":"open","priority":"Normal","author":"dau","description":"@Patrick and I had an idea to organize proposals/specifications to help the community propose, improve and follow some \"ideas/standards\". The [[ https://github.com/Whonix/proposals | proposals repo ]] is currently hosting these documents and we should write a spec to explain to other people how this works and how they can be composed.\n\nHere is the initial draft I have in mind:\n\n```\nXXX Add a better introduction than the one above ^\n\n# Quicksteps:\n\n1. Create a ticket [2] describing the idea you have for a rule or\n   standard you think other people might find useful (if you already\n   have written a draft, add it to the ticket too)\n\n2. Discuss with others and collect feedback\n\n3. Once you have enough information to compose the document, create a text\n   file with the following headers:\n\n    # <Name of the proposal> (Proposal <Number assigned to the ticket you created>)\n\n    - Ticket: https://phabricator.whonix.org/T<Number>\n    - File: https://github.com/Whonix/proposals/blob/master/<Number>-<name-of-the-proposal>.txt\n    - Authors: XXX Should we use the usernames from Phabricator?\n    - [Supersedes:] <Number of the proposal/spec to be superseded, if applies>\n    - Status: Work in progress | Needs review | Accepted\n\n    <If needed, you may add other headers such as \"Assignees\",\n     \"Priority\", \"Impact\", etc>\n\n4. Add a description section:\n\n    # Description\n\n    <Actual contents of the proposal>\n\n    <You may prefix certain parts of the document with \"XXX\" which is\n     unfinished or you need help with>\n\n    <Depending on the places you wish to share this document, you may\n     (or may not) use text formatting (e.g., markdown) and limit the\n     line length>\n\n5. If needed, add a \"TODO\" section:\n\n    # TODO\n\n    <Tasks which still must be done>\n\n6. Add the feedback paragraph and the references:\n\n    <References 0 and 1 are a bit redundant but are useful because we\n     remove the headers section at the top when posting to other\n     places that are not familiar to this workflow>\n\n    Feedback on the ticket [0] and pull requests on the repository [1]\n    are welcome.\n\n    [0]: https://phabricator.whonix.org/T<Number>\n    [1]: https://github.com/Whonix/proposals/blob/master/<Number>-<name-of-the-proposal>.txt\n    ...\n    [N]: <Other references>\n\n7. You may want to take a look at the proposals repo [3] for ideas on\n   how current proposals were written\n\n8. Name this file in the format: `<Number>-<name-of-the-proposal>.txt`\n\n9. Send a Pull Request (PR) with the file to the proposals repo [3] or\n   ask someone to do that for you if not familiar with git/GitHub\n\n10. Update the ticket with the link once the PR is merged (you may\n    want to replace the draft in the ticket with the link so that you\n    do not have to update both places)\n\n11. Feel free to continue discussing the proposal in the initial\n    ticket you opened and update the GitHub PR or create new ones to\n    improve it\n\n[2]: https://phabricator.whonix.org/maniphest/task/edit/form/default/\n[3]: https://github.com/Whonix/proposals\n```\n\nI noticed the Phabricator UI calls these \"tasks\". Do you call them tasks or tickets?\n\nDo you think the \"TODO\" section should be at the end of the document or right after the headers?\n\nWhat do you think?","comments":[{"author":"Patrick","date_created":1493600635,"date_modified":1493600635,"content":"> XXX Should we use the usernames from Phabricator?\n\nProbably not. But with higher priority, I'd leave that decision to the contributor.\n\n> - Assignees: <Name of who is currently working in the proposal>\n\nNot sure if useful but also not sure if it matters to leave/add/not add.\n\n> - [Priority:] XXX How does Whonix currently handle this?\n\nI use it to track time pressure. Such as hypothetic case: If a new version of Tor Browser that is going to be blessed stable in 2 weeks would not work in Whonix, then this would get the highest priority.\n\nI don't use it for \"this is more important than this\".\n\n> - [Impact:] XXX How does Whonix currently handle this?\n\nSuch as hypothetic case: If a new version of Tor Browser that is going to be blessed stable in 2 weeks would not work in Whonix, then the impact would be high.\n\nRemoving trailing spaces from source files has a low impact. Fixing a rare bug, normal impact. Adding a new anonymity protection feature, high impact.\n\nNot too consistently used and not too important a field.\n\nWhat gets assigned to the milestone of the next version of Whonix is not so much related on what's most important, but what's realistic and doable.\n\nI don't think we need priority / impact on the proposal headers unless you find that useful. Changing priority / impact usually does not help to make someone else or me work on something sooner.\n\n> - Status: Work in progress | Needs review | Accepted (XXX What else?)\n\nOk.\n\n> <(XXX Use markdown?)>\n\nIt's a case by case decision, maybe. Perhaps plain text works best most of the time. Markdown is okay if it's just for internal use at Whonix, but not great if we want to copy it over to third party (such as Debian) mailinglist or tracker that does not support markdown.\n\n> <(XXX Limit lines to 70 characters?)>\n\nNo hard line breaks. When to break lines should be up to browsers / mail clients / editors. But perhaps I am wrong about that.\n\n> Do you call them tasks or tickets?\n\nSynonym, mostly tickets. Not sure about that.\n\n> Do you think the \"TODO\" section should be at the end of the document or right after the headers?\n\nIt's okay either way. I like to keep things simple and welcoming. With too strict rules about formalities, new contributors get discouraged for little to no gain.\n\n> What do you think?\n\nInitial draft was very good already."},{"author":"dau","date_created":1493659064,"date_modified":1493659064,"content":"On Mon, May 01, 2017 at 01:03:57AM +0000, Patrick (Patrick Schleizer) wrote:\n>> XXX Should we use the usernames from Phabricator?\n> \n> Probably not. But with higher priority, I'd leave that decision to the contributor.\n\nAlright.\n\n>> - Assignees: <Name of who is currently working in the proposal>\n> \n> Not sure if useful but also not sure if it matters to leave/add/not add.\n\nI am not sure either. May be useful if someone wants to talk to someone\nabout this? Maybe make it optional too?\n\n>> - [Priority:] XXX How does Whonix currently handle this?\n> \n> I use it to track time pressure. Such as hypothetic case: If a new version of Tor Browser that is going to be blessed stable in 2 weeks would not work in Whonix, then this would get the highest priority.\n> \n> I don't use it for \"this is more important than this\".\n> \n>> - [Impact:] XXX How does Whonix currently handle this?\n> \n> Such as hypothetic case: If a new version of Tor Browser that is going to be blessed stable in 2 weeks would not work in Whonix, then the impact would be high.\n> \n> Removing trailing spaces from source files has a low impact. Fixing a rare bug, normal impact. Adding a new anonymity protection feature, high impact.\n> \n> Not too consistently used and not too important a field.\n> \n> What gets assigned to the milestone of the next version of Whonix is not so much related on what's most important, but what's realistic and doable.\n> \n> I don't think we need priority / impact on the proposal headers unless you find that useful. Changing priority / impact usually does not help to make someone else or me work on something sooner.\n\nThanks for the explanation! Well, they might not indeed be useful\nbecause we do not have a system like Phabricator/Maniphest to manage\nthem. So using them only on the tickets should be fine because then\nwe can filter/sort/etc, right?\n\n>> <(XXX Use markdown?)>\n> \n> It's a case by case decision, maybe. Perhaps plain text works best most of the time. Markdown is okay if it's just for internal use at Whonix, but not great if we want to copy it over to third party (such as Debian) mailinglist or tracker that does not support markdown.\n\nI suggested markdown because it is reasonably popular and even if not\nsupported, its syntax does not impact the reading too much when\ndisplayed as just plain text.\n\n>> <(XXX Limit lines to 70 characters?)>\n> \n> No hard line breaks. When to break lines should be up to browsers / mail clients / editors. But perhaps I am wrong about that.\n\nThe only reason I think that might be useful is when posting to\nmailing lists because, personally, when reading mailman posts with\nlong lines (either on a browser or mail client) is not very\ncomfortable, but that is the experience I've had.\n\n>> Do you call them tasks or tickets?\n> \n> Synonym, mostly tickets. Not sure about that.\n\nI think I will call them tickets too.\n\n>> Do you think the \"TODO\" section should be at the end of the document or right after the headers?\n> \n> It's okay either way. I like to keep things simple and welcoming. With too strict rules about formalities, new contributors get discouraged for little to no gain.\n\nI agree! Maybe we should make all these suggestions instead of rules?\n\n>> What do you think?\n> \n> Initial draft was very good already.\n\nThanks!"},{"author":"Patrick","date_created":1493664572,"date_modified":1493664572,"content":"dau (Felipe Dau):\n> dau added a comment.\n> \n>"},{"author":"dau","date_created":1493766540,"date_modified":1493766540,"content":"I just updated the text a bit with your feedback.\n\n>>! In T668#13170, @Patrick wrote:\n> dau (Felipe Dau):\n>> dau added a comment.\n>>\n\nLooks like your message got lost?\n\n\n"},{"author":"Patrick","date_created":1493810935,"date_modified":1493810935,"content":"> Looks like your message got lost?\n\nYes. Somehow...\n\ndau (Felipe Dau):\n> dau added a comment.\n> \n> \n> On Mon, May 01, 2017 at 01:03:57AM +0000, Patrick (Patrick Schleizer)\n> wrote:\n> \n>>> XXX Should we use the usernames from Phabricator?\n>> \n>> Probably not. But with higher priority, I'd leave that decision to\n>> the contributor.\n> \n> Alright.\n> \n>>> - Assignees: <Name of who is currently working in the proposal>\n>> \n>> Not sure if useful but also not sure if it matters to leave/add/not\n>> add.\n> \n> I am not sure either. May be useful if someone wants to talk to\n> someone about this? Maybe make it optional too?\n\nWell, you have the git history and ticket discussion.\n\nYes, optional sounds good.\n\n>>> - [Priority:] XXX How does Whonix currently handle this?\n>> \n>> I use it to track time pressure. Such as hypothetic case: If a new\n>> version of Tor Browser that is going to be blessed stable in 2\n>> weeks would not work in Whonix, then this would get the highest\n>> priority.\n>> \n>> I don't use it for \"this is more important than this\".\n>> \n>>> - [Impact:] XXX How does Whonix currently handle this?\n>> \n>> Such as hypothetic case: If a new version of Tor Browser that is\n>> going to be blessed stable in 2 weeks would not work in Whonix,\n>> then the impact would be high.\n>> \n>> Removing trailing spaces from source files has a low impact. Fixing\n>> a rare bug, normal impact. Adding a new anonymity protection\n>> feature, high impact.\n>> \n>> Not too consistently used and not too important a field.\n>> \n>> What gets assigned to the milestone of the next version of Whonix\n>> is not so much related on what's most important, but what's\n>> realistic and doable.\n>> \n>> I don't think we need priority / impact on the proposal headers\n>> unless you find that useful. Changing priority / impact usually\n>> does not help to make someone else or me work on something sooner.\n> \n> Thanks for the explanation! Well, they might not indeed be useful \n> because we do not have a system like Phabricator/Maniphest to manage \n> them. So using them only on the tickets should be fine because then \n> we can filter/sort/etc, right?\n\nRight.\n\n>>> Do you think the \"TODO\" section should be at the end of the\n>>> document or right after the headers?\n>> \n>> It's okay either way. I like to keep things simple and welcoming.\n>> With too strict rules about formalities, new contributors get\n>> discouraged for little to no gain.\n> \n> I agree! Maybe we should make all these suggestions instead of\n> rules?\n\nYes.\n"}]},"PHID-TASK-mos5bnsrx2jqfh5qotqd":{"id":"667","title":"Tor Browser 7.0a3 defunct in Qubes-Whonix?","status":"invalid","priority":"High","author":"Patrick","description":"https://forums.whonix.org/t/7-0a3-tor-browser-series-defunct-in-whonix/3786/7\n","comments":[{"author":"Patrick","date_created":1493503658,"date_modified":1493503658,"content":"https://forums.whonix.org/t/tor-browser-7-0a3-apparmor/3824"}]},"PHID-TASK-4ayty7caaanjlz3cuo5b":{"id":"666","title":"Tor Browser 6.5.2 tb-updater update","status":"resolved","priority":"Unbreak Now!","author":"Patrick","description":"https://github.com/Whonix/tb-updater/blob/Whonix13/usr/lib/tbbversion_parser\n\nRequired for T417 / #Qubes.","comments":[{"author":"HulaHoop","date_created":1493831567,"date_modified":1493831567,"content":"I sense some evil breakage going on :P"},{"author":"Patrick","date_created":1493992589,"date_modified":1493992589,"content":"Unlikely. I've been doing these stable upgrades all the time."}]},"PHID-TASK-zua3swwrk434rfztmvak":{"id":"665","title":"upload Tor 0.3.0.8 to Whonix 13 repository","status":"wontfix","priority":"High","author":"Patrick","description":"","comments":[]},"PHID-TASK-haf3xzkwirzdmyeuavpq":{"id":"664","title":"The two www repos on github/whonix","status":"invalid","priority":"Normal","author":"JasonJAyalaP","description":"There are two repos on github that seem to be for the website.\nhttps://github.com/Whonix/www\nhttps://github.com/Whonix/Whonix-Website\n\nIs www the old repo and whonix-website the new? Do we still need the old one?","comments":[{"author":"Patrick","date_created":1493422905,"date_modified":1493422905,"content":"Yes, there is some duplication, but not sure if we should resolve it.\n\n>   https://github.com/Whonix/www\n\nIt's a git backup from the server's /var/www folder. We currently only\nuse server backup -> github. No merging from github back to the server.\n\nRather an \"unclean\" repository. Contains code by others (mediawiki and\nwordpress). Supposed to help others to exactly replicate our setup.\n\n>   https://github.com/Whonix/Whonix-Website\n\nThat's the new Whonix homepage website created by @Ego. Code by Whonix only."}]},"PHID-TASK-rfiq2ubibwnotqep25yq":{"id":"663","title":"Broken links on homepage","status":"resolved","priority":"Unbreak Now!","author":"JasonJAyalaP","description":"The FAQ and Newsletter links on the webpage are broken on the homepage missing on the other pages.\n\nCan someone update me on the workflow for changing the website?\n","comments":[{"author":"Patrick","date_created":1493627133,"date_modified":1493627133,"content":"> Can someone update me on the workflow for changing the website?\n\nSomehow I missed that question.\n\nSend a pull request to:\nhttps://github.com/Whonix/Whonix-Website\n\n(Ideally pull from https://github.com/EgoBits1/Whonix-Website beforehand as well so we don't have merge conflicts.)\n\nPerhaps discuss beforehand:\nhttps://forums.whonix.org/t/whonix-website-change-suggestions/3797/8\n"}]},"PHID-TASK-fzu4hm5huqdi66rihrcn":{"id":"662","title":"AppArmor & FoxyProxy denied message","status":"resolved","priority":"Low","author":"Patrick","description":"https://forums.whonix.org/t/apparmor-foxyproxy\n\nFoxyProxy works fine with Tor Browser 7.0a2 hardened, but the AppArmor message appears as follows:\n\n    apparmor=\"DENIED\" operation=\"open\"\n    profile=\"/home/**/tor-browser*/Browser/firefox\"\n    name=\"/run/user/1000/dconf/user\" pid=XXXX comm=\"firefox\"\n    requested_mask=\"rwc\" denied_mask=\"rwc\" fsuid=1000 ouid=1000","comments":[{"author":"JasonJAyalaP","date_created":1498584880,"date_modified":1498584880,"content":"I'll talk with torjunkie in the forum. I'll close this ticket because it's not a whonix 14 blocker, and every AA fix can't have its own ticket"},{"author":"Patrick","date_created":1498602894,"date_modified":1498602894,"content":"Probably hasn't solved itself. This bug report presupposes quite a lot knowledge, isn't well described. Reproduction isn't obvious since it has two prerequisites. To explain what this is about and required for reproduction:\n\n* `sudo apt-get install apparmor-browser-profile` (plus newer version from https://github.com/Whonix/apparmor-profile-torbrowser)\n* foxy proxy in use as per https://www.whonix.org/wiki/Template:FoxyProxy\n** (used here: https://www.whonix.org/wiki/Special:WhatLinksHere/Template:FoxyProxy)\n\n> very AA fix can't have its own ticket\n\nWhy not? How else would we keep track of which ones are fixed?"},{"author":"JasonJAyalaP","date_created":1498687209,"date_modified":1498687264,"content":"> Probably hasn't solved itself. \nYou told him it wasn't a problem. But if you think it's worth it, alright.\n\n> Why not? How else would we keep track of which ones are fixed?\nWe have a \"no unknown denied\" policy with AA? Alright.\n\n> Patrick reopened this task as \"Open\".\nAnd they're blockers? Fine with me.\n\n> To explain what this is about and required for reproduction\n\nOK i'm investigating."},{"author":"JasonJAyalaP","date_created":1498690842,"date_modified":1498690842,"content":"I opened a ticket on the FoxyProxy system:\n\n\n> \n> Hi. I'm debugging an app armor profile for the tor browser bundle. A user noticed a denied message while using foxy proxy. The file the browser wants to access was /run/user/1000/dconf/user. (/run/user/1000 is the user-specific tmp directory)\n> \n> I'm trying to replicate it with the latests version of FP standard and TBB/firefox\n> \n> I noticed that the dconf folder and user file is created when FP is installed. I'm vaguely aware that dconf is a backend to GSettings (used to store settings, particularly for Gnome apps?). I'm guessing that FP uses this to store temporary values? I grepped the FP src for dconf/gsettings, but I'm unsure when exactly this file is read and written to. (I fiddled around with FP, but dconf/user is still empty).\n> \n> Thanks for your time!\n\n"},{"author":"JasonJAyalaP","date_created":1498691313,"date_modified":1498691313,"content":"What do the other AA profiles do with the /run/user/1000? We give them access to 1000/APPNAME only?\n\nAhh. I see icedove has:\n\n```\nowner /run/user/[0-9]*/dconf/user rw\n\n```\nFP unfortunately uses dconf/user, which looks pretty generic and is shared by icedove, for example. I bet more apps use it. I don't see how these apps can have access to dconf/user (which I assume is necessary for their function) without the above line, therefore being able to see each other's tmp settings (while running)"},{"author":"Patrick","date_created":1498695271,"date_modified":1498695271,"content":">     owner /run/user/[0-9]*/dconf/user rw\n\nIf it works... Perhaps add it as comment.\n\nOr does it work when denied?"},{"author":"JasonJAyalaP","date_created":1498695584,"date_modified":1498695618,"content":"FP replied\n> Sorry, but we have no idea what dconf/settings is. FoxyProxy does not read or write to such a file\n\n\n> Or does it work when denied?\nFP is certainly creating it. Or maybe firefox when it interacts with certain plugin features?\nI cant get latest FP on latest TB to actually use that file (and generate an error). I'm not sure what torjunkie does to trigger it."},{"author":"Patrick","date_created":1498697153,"date_modified":1498697153,"content":">   I cant get latest FP on latest TB to actually use that file (and generate an error). I'm not sure what torjunkie does to trigger it.\n\nActually use foxyproxy?"},{"author":"JasonJAyalaP","date_created":1498699088,"date_modified":1498699088,"content":"Do you got a proxy I can configure it to use? Still waiting for him to reply."},{"author":"Patrick","date_created":1498738094,"date_modified":1498738094,"content":"A local proxy should do. Use any of these guides.\n\n> * foxy proxy in use as per https://www.whonix.org/wiki/Template:FoxyProxy\n> ** (used here: https://www.whonix.org/wiki/Special:WhatLinksHere/Template:FoxyProxy) \n\n(any from this list)\n\nI doubt the proxy has to be functional for this apparmor warning to pop up."},{"author":"JasonJAyalaP","date_created":1498793289,"date_modified":1498793439,"content":"Ahh I see. I can setup i2p/freenet/zeronet and use FP to go through that.\n\nI got zeronet working and browsing around. Latest aa profiles, aa-notify -p, journctl -f\n\nNo denied messages.\n\n>     owner /run/user/[0-9]*/dconf/user rw\n> If it works... Perhaps add it as comment.\nIt would need to be added to tor browser aa profile. Are you willing to accept that? It seems some extensions save temporary info here and firefox creates it and uses it for them.\n\n> Or does it work when denied?\nTorjunkie didn't say that FP stopped working. Or we can add the line to tor browser aa since sooner or later some extension will need access to it?\n\n> Actually use foxyproxy?\n> I doubt the proxy has to be functional for this apparmor warning to pop up.\n\nThe hell? Lol. I install FP, force a missing proxy, and get no message. You tell me to \"actually use it\" and setup it up with i2p/freenet/zeronet/etc. Then you say it doesn't make a difference? Ha. No matter. I did both things and can't get the denied message."},{"author":"Patrick","date_created":1498817745,"date_modified":1498817745,"content":">>! In T662#13958, @JasonJAyalaP wrote:\n> Ahh I see. I can setup i2p/freenet/zeronet and use FP to go through that.\n> \n> I got zeronet working and browsing around. Latest aa profiles, aa-notify -p, journctl -f\n> \n> No denied messages.\n\nGreat, so this can be closed until we hear back from anyone any instructions on how to reproduce this.\n\n>>     owner /run/user/[0-9]*/dconf/user rw\n>> If it works... Perhaps add it as comment.\n> It would need to be added to tor browser aa profile. Are you willing to accept that? It seems some extensions save temporary info here and firefox creates it and uses it for them.\n\nWhy would I oppose `a comment`. A commented out command. It does nothing. It only helps users who need this. Who'd manually add it to the /etc/apparmor.d/local folder.\n\n>> Or does it work when denied?\n> Torjunkie didn't say that FP stopped working. Or we can add the line to tor browser aa since sooner or later some extension will need access to it?\n\nNo.\n\n>> Actually use foxyproxy?\n>> I doubt the proxy has to be functional for this apparmor warning to pop up.\n> \n> The hell? Lol. I install FP, force a missing proxy, and get no message. You tell me to \"actually use it\" and setup it up with i2p/freenet/zeronet/etc. Then you say it doesn't make a difference? Ha. No matter. I did both things and can't get the denied message.\n\nWell, I am using various degrees of uncertainty words."},{"author":"JasonJAyalaP","date_created":1498870591,"date_modified":1498873305,"content":"Ok. I added the commented line to home.tor-browser.firefox\n\nI also noted that /run/user isn't in abstractions/user-tmp, which is out of date (only includes *tmp* directories and not the more modern /run/usr. Oh well). "},{"author":"JasonJAyalaP","date_created":1498872459,"date_modified":1498872459,"content":"I get the message after a reboot. \n\naudit: type=1400 audit(1498871907.064:25): apparmor=\"DENIED\" operation=\"mkdir\" profile=\"/home/**/tor-browser*/Browser/firefox\" name=\"/run/user/1000/dconf/\" pid=6407 comm=\"firefox\" requested_mask=\"c\" denied_mask=\"c\" fsuid=1000 ouid=1000\nJul  1 01:18:27 host kernel: [  348.994506] audit: type=1400 audit(1498871907.076:26): apparmor=\"DENIED\" operation=\"mkdir\" profile=\"/home/**/tor-browser*/Browser/firefox\" name=\"/run/user/1000/dconf/\" pid=6407 comm=64636F6E6620776F726B6572 requested_mask=\"c\" denied_mask=\"c\" fsuid=1000 ouid=1000\n\ndebugging now"},{"author":"JasonJAyalaP","date_created":1498873698,"date_modified":1498873698,"content":"Ok, the line should be:\n\nowner /run/user/[0-9]*/** rwkl,\n\n(I don't see why we need the * after 0-9, since it's supposed to be the user id, but icedove has it. Dunno.)\n\nAdded:\n\nhttps://github.com/Whonix/apparmor-profile-torbrowser/blob/master/etc/apparmor.d/home.tor-browser.firefox#L105\n\nAs far as I can tell, firefox doesn't normally use /run/user for its tmp directory (which would be more modern). However, with certain extensions, it wants to use dconf inside /run/user.\n\nowner /run/user/[0-9]*/** rwkl,\n\nreally should be part of abstractions/user-tmp, but that file is very old."},{"author":"JasonJAyalaP","date_created":1498873908,"date_modified":1498873908,"content":"I really think that \"access to the temp folder\" should be a basic AA allowance. In fact, it is right now with #include user-tmp. However, user-tmp is so old (I'm guessing) it doesn't have /run/user/[0-9]/**\n\nIt's added as comment to the firefox profile, and I think it should be uncommented. You decide Patrick.\n\nBut it should be apart of abstractions/user-tmp. Are you comfortable doing this, Patrick? Who do I need to talk to in order to discuss updating user-tmp?"},{"author":"Patrick","date_created":1498898562,"date_modified":1498898562,"content":"JasonJAyalaP (Jason J. Ayala P.):\n>   But it should be apart of abstractions/user-tmp. Are you comfortable doing this, Patrick?\n\nNo.\n\n> Who do I need to talk to in order to discuss updating user-tmp?\n\ndpkg -S /full/path/to/file/name\n\nPlease contact the maintainer of that package on their public bug tracker."},{"author":"JasonJAyalaP","date_created":1499202669,"date_modified":1499202669,"content":"Reported but to app armor:\nhttps://bugs.launchpad.net/apparmor/+bug/1702360\n\nI will also add to the FP template information about uncommenting the # /run/user line."},{"author":"JasonJAyalaP","date_created":1499202840,"date_modified":1499202840,"content":"@Patrick \nthe FP template says \"Tor Browser will soon ship with sandboxing on an opt-in basis.\" Wasn't this rejected?"},{"author":"Patrick","date_created":1499342992,"date_modified":1499342992,"content":"JasonJAyalaP (Jason J. Ayala P.):\n>   the FP template says \"Tor Browser will soon ship with sandboxing on an opt-in basis.\" Wasn't this rejected?\n\nNot that I know."},{"author":"Patrick","date_created":1499343131,"date_modified":1499343131,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   @Patrick \n>   the FP template says \"Tor Browser will soon ship with sandboxing on an opt-in basis.\" Wasn't this rejected?\n\nThe problem is, that `sandboxing` isn't a hyperlink. Please make it one.\nIt's not referring to apparmor. It's referring to :\n\n*\nhttps://www.whonix.org/wiki/Tor_Browser/Advanced_Users#Sandboxed_Tor_Browser\n* https://trac.torproject.org/projects/tor/wiki/doc/TorBrowser/Sandbox/Linux"},{"author":"Patrick","date_created":1499343219,"date_modified":1499343219,"content":"> After FoxyProxy is installed, you may see an app-armory warning you\nabout the denied creation of dconf/user. The current Debian profile for\nFirefox does not yet include the modern temporary file location /run/user.\n\nPlease add a footnote with the link to the bug report. Otherwise it's\nreally hard to substantiate that claim in a year from now."},{"author":"JasonJAyalaP","date_created":1499357346,"date_modified":1499357645,"content":"According to their wiki that you linked to: \"Active development is on indefinite hiatus.\" Do you still want FP to talk about and link to that?"},{"author":"Patrick","date_created":1499358099,"date_modified":1499358099,"content":"Thanks for updating me! No, then this needs to be removed. And the sandboxed tor browser chanter moved to https://www.whonix.org/wiki/Deprecated."}]},"PHID-TASK-7w6xmwr5qkkajazooty3":{"id":"661","title":"Implement a config parser","status":"open","priority":"Normal","author":"dau","description":"The [[ https://github.com/Whonix/proposals/blob/master/635-listen-port-convention.txt | Listen Port Convention proposal ]] depends on the parsing of specific files within specific directories. A config parser with the following features should be implemented:\n\n- Provide a Python package\n- Provide a command-line interface for non-Python apps\n- Provide json and eval serializers\n- Allow different parts of it to be customized\n\nI will create a repo and post it here once I start working on this. Here is the initial code:\n\n```\nimport argparse\n\n\nclass Parser:\n    @classmethod\n    def parse_global(cls, filepath):\n        \"\"\"Read `filepath`, parse it and return all directory paths found.\n\n        The directories in the list are in the order they are intended to be\n        read.\n        \"\"\"\n\n    @classmethod\n    def is_config_file(cls, filename):\n        \"\"\"Return `True` if `filename` is a config file. `False` otherwise.\"\"\"\n\n    @classmethod\n    def find_config_files(cls, dirpath):\n        \"\"\"Walk through the directory and return all file paths found.\n\n        Depending on `is_config_file`, each file is prepended by the\n        directory's path and added to the list. The files in the list are in\n        the order they are intended to be read.\n        \"\"\"\n\n    @classmethod\n    def parse_file(cls, filepath, configs=None):\n        \"\"\"Read `filepath`, parse it and return a `config: value` dict.\n\n        If no configs are provided, a new dict is created. As the file is read,\n        values are added to the configs with\n        `add_config(configs, config, value)`.\"\"\"\n\n    @classmethod\n    def add_config(cls, configs, config, value):\n        \"\"\"Add `config: value` to the configs dict and return it.\n\n        In case the config did not exist, it is added to the dict. Otherwise,\n        it replaces or merges to the existing one.\n        \"\"\"\n\n    @classmethod\n    def parse(cls, name):\n        \"\"\"Read the name of the config and return a `config: value` dict.\n\n        The name defaults to a `/etc/<name>.conf` file path but can optionally\n        specify a different path and extension. Its format should be something\n        like `[/custom/path/]name[.custom]`.\n        \"\"\"\n        cfgs = dict()\n\n        for dirpath in cls.parse_global(name):\n            for filepath in cls.find_config_files(dirpath):\n                cfgs = cls.parse_file(filepath, cfgs)\n\n        return cfgs\n\n    @classmethod\n    def serialize(cls, configs):\n        \"\"\"Serialize the configs dict into a convenient format.\"\"\"\n\n    @classmethod\n    def parse_to_serialized(cls, name):\n        \"\"\"Parse configs and return them serialized.\"\"\"\n        return cls.serialize(cls.parse(name))\n\n\ndef call_parse():\n    \"\"\"Read a config name and print the serialized configs.\n\n    This function should be accessed through an entry point. The name is passed\n    via a command-line call and returns the configs in a format that\n    applications are able to read in the language they use.\n    \"\"\"\n    argparser = argparse.ArgumentParser()\n    argparser.add_argument('name')\n    args = argparser.parse_args()\n\n    print Parser.parse_to_serialized(args.name)\n```\n\nA Python app would use the parser to retrieve the `listen_ip` config of the `listen` convention with the following code:\n\n```\nimport Parser\n\ncfgs = Parser.parse('listen')\nlisten_ip = cfgs['listen_ip']\n\n# bind on `listen_ip`\n```\n\nA non-Python app would receive the serialized configs with the following call:\n\n```\n$ configparser listen\n```\n\nP.S. We need a good name for this.\n\n---\nThis is a follow-up ticket to T635","comments":[]},"PHID-TASK-yflaqehdklcbqaqp4uvs":{"id":"660","title":"Implement \"Listen Port Convention\" on Whonix","status":"open","priority":"Normal","author":"dau","description":"The [[ https://github.com/Whonix/proposals/blob/master/635-listen-port-convention.txt | Listen Port Convention proposal ]] should be implemented on Whonix so that server applications can easily find the proper interface to use.\n\n- This will require a `/etc/listen.conf` file pointing to at least one `listen.d` directory with a `.conf` file setting the `listen_ip` config\n- I assume we will need different files for Qubes and non-Qubes Whonix systems\n- The convention is very straightforward, but I think we would still need  to document how to customize those for the user's Whonix, in case they need to\n\n---\nThis is a follow-up ticket to T635","comments":[]},"PHID-TASK-zjn74i3qs7k65a5diku7":{"id":"659","title":"Publish \"Listen Port Convention\"","status":"open","priority":"Normal","author":"dau","description":"The [[ https://github.com/Whonix/proposals/blob/master/635-listen-port-convention.txt | Listen Port Convention proposal ]] is finished, received some feedback and seems ready to be published as an actual convention.\n\n- Should this be moved out of `proposals/`?\n- It should have an official place to be hosted (on GitHub and/or on Whonix' docs/wiki)\n- Places I think it should be announced:\n  - whonix.org/blog\n  - debian-devel\n\n---\nThis is a follow-up ticket to T635","comments":[{"author":"Patrick","date_created":1493390173,"date_modified":1493390173,"content":"> Should this be moved out of proposals/?\n\nI am neutral. If you like, go for it.\n\n(In comparison, RFC - they keep calling them RFCs.)\n\n> It should have an official place to be hosted (on GitHub and/or on Whonix' docs/wiki)\n\nYes.\n\n> Places I think it should be announced:\n> whonix.org/blog\n\nYes. Would you like to create a Whonix blog account?\n\n> debian-devel\n\nI don't know. I guess we're missing one ticket \"wait for Debian stretch to become Debian stable and then suggest this convention to Debian\"?"},{"author":"dau","date_created":1493488490,"date_modified":1493488490,"content":">>! In T659#13045, @Patrick wrote:\n>> Should this be moved out of proposals/?\n> \n> I am neutral. If you like, go for it.\n> \n> (In comparison, RFC - they keep calling them RFCs.)\n\nI have never done anything like this before, so I honestly do not know what the best choice is. I think it would be good to use an approach that already works for others too, like you mentioned RFCs. Or how Tor manages theirs (I think they have \"specs\" and \"spec proposals\").\n\nI am just unsure if in the future it will be useful to separate them to know what is stable/accepted/etc and what is not. Should we worry about that later?\n\n> Yes. Would you like to create a Whonix blog account?\n\nI just suggested that should be done, so anyone could do it. I have never done that either but if you think it is a good idea, I will be happy to do so.\n\n> I don't know. I guess we're missing one ticket \"wait for Debian stretch to become Debian stable and then suggest this convention to Debian\"?\n\nWe are! Were we supposed to create a ticker on their tracker (or something like that) too?\n"},{"author":"Patrick","date_created":1493502913,"date_modified":1493502913,"content":"dau (Felipe Dau):\n> dau added a comment.\n> \n> \n> In https://phabricator.whonix.org/T659#13045, @Patrick wrote:\n> \n>>> Should this be moved out of proposals/?\n>> \n>> I am neutral. If you like, go for it.\n>> \n>> (In comparison, RFC - they keep calling them RFCs.)\n> \n> \n> I have never done anything like this before, so I honestly do not\n> know what the best choice is.\n\nI doubt there is a best practices for that one.\n\n> I think it would be good to use an\n> approach that already works for others too, like you mentioned RFCs.\n> Or how Tor manages theirs (I think they have \"specs\" and \"spec\n> proposals\").\n\nRight. From that perspective, we should probably rename the repository\nto specs with a sub folder proposals.\n\nexample:\nhttps://gitweb.torproject.org/torspec.git/tree/proposals/115-two-hop-paths.txt\n\n```\nFilename: 115-two-hop-paths.txt\nTitle: Two Hop Paths\nAuthor: Mike Perry\nCreated:\nStatus: Dead\nSupersedes: 112\n```\n\nOr we don't use sub folders - then the file name would stay the same.\nAnd just use a header to document the status and remaining to do.\n\n> I am just unsure if in the future it will be useful to separate them\n> to know what is stable/accepted/etc and what is not. Should we worry\n> about that later?\n\nLet's just take our best guess. There is a lot of freedom in these options.\n\n>> Yes. Would you like to create a Whonix blog account?\n> \n> I just suggested that should be done, so anyone could do it. I have\n> never done that either \n\nYes, you generally are on a very good track, so I have high confidence.\n\n> but if you think it is a good idea, I will be\n> happy to do so.\n\nDefinitely please go ahead.\n\n>> I don't know. I guess we're missing one ticket \"wait for Debian\n>> stretch to become Debian stable and then suggest this convention to\n>> Debian\"?\n> \n> We are! Were we supposed to create a ticker on their tracker (or\n> something like that) too?\n\nYes. It's a bit strange. We now need a ticket here to remind to create a\nticket at their tracker since he said \"it's not the best time to discuss\nthis now at Debian\"."},{"author":"dau","date_created":1493531968,"date_modified":1493531968,"content":">>! In T659#13130, @Patrick wrote:\n> Right. From that perspective, we should probably rename the repository\n> to specs with a sub folder proposals.\n> \n> example:\n> https://gitweb.torproject.org/torspec.git/tree/proposals/115-two-hop-paths.txt\n> \n> ```\n> Filename: 115-two-hop-paths.txt\n> Title: Two Hop Paths\n> Author: Mike Perry\n> Created:\n> Status: Dead\n> Supersedes: 112\n> ```\n> \n> Or we don't use sub folders - then the file name would stay the same.\n> And just use a header to document the status and remaining to do.\n> \n>> I am just unsure if in the future it will be useful to separate them\n>> to know what is stable/accepted/etc and what is not. Should we worry\n>> about that later?\n> \n> Let's just take our best guess. There is a lot of freedom in these options.\n\nGreat idea! The proposals kind of have a two-line header containing the links. What else should we add? Should we copy a few things from the format used in phabricator's tickets too? Idea:\n\n- Ticket:\n- File:\n- Authors:\n- Assignees:\n- [Supersedes:]\n- [Priority:]\n- [Impact:]\n- Status:\n\n`[items]` could be optional and I think \"TODO\" could be a separate section because it might have a long content.\n\nWhat do you think?\n\n(Should this be discussed in another ticket?)\n\n\n>>> Yes. Would you like to create a Whonix blog account?\n>> \n>> I just suggested that should be done, so anyone could do it. I have\n>> never done that either \n> \n> Yes, you generally are on a very good track, so I have high confidence.\n> \n>> but if you think it is a good idea, I will be\n>> happy to do so.\n> \n> Definitely please go ahead.\n\nCool, thanks! Can you guide me on how to create the account?\n\nI hope to compose a draft and post here within the week.\n\n> Yes. It's a bit strange. We now need a ticket here to remind to create a\n> ticket at their tracker since he said \"it's not the best time to discuss\n> this now at Debian\".\n\nAhh, right. Should we coordinate the blog post and the Debian ticket? Post at the same time or maybe wait for feedback from the ticket and then make the announcement on Whonix's blog and debian-devel? \n\nThanks!"},{"author":"Patrick","date_created":1493547657,"date_modified":1493547657,"content":"dau (Felipe Dau):\n>   Great idea! The proposals kind of have a two-line header containing the links. What else should we add? Should we copy a few things from the format used in phabricator's tickets too? Idea:\n>   \n>   - Ticket:\n>   - File:\n>   - Authors:\n>   - Assignees:\n>   - [Supersedes:]\n>   - [Priority:]\n>   - [Impact:]\n>   - Status:\n>   \n>   `[items]` could be optional and I think \"TODO\" could be a separate section because it might have a long content.\n>   \n>   What do you think?\n\nPerfect!\n\n>   (Should this be discussed in another ticket?)\n\nYou can if there are additional questions, sure.\n\n>   >>> Yes. Would you like to create a Whonix blog account?\n>   >> \n>   >> I just suggested that should be done, so anyone could do it. I have\n>   >>  never done that either\n>   > \n>   > Yes, you generally are on a very good track, so I have high confidence.\n>   > \n>   >> but if you think it is a good idea, I will be\n>   >>  happy to do so.\n>   > \n>   > Definitely please go ahead.\n>   \n>   Cool, thanks! Can you guide me on how to create the account?\n\nOh, I forgot that the link is for some reason (bug) not obvious on our\nwordpress installation. Sign up can be done here:\n\nhttps://www.whonix.org/blog/wp-admin/\n\n>   I hope to compose a draft and post here within the week.\n\nGreat!\n\n>   > Yes. It's a bit strange. We now need a ticket here to remind to create a\n>   >  ticket at their tracker since he said \"it's not the best time to discuss\n>   >  this now at Debian\".\n>   \n>   Ahh, right. Should we coordinate the blog post and the Debian ticket? Post at the same time or maybe wait for feedback from the ticket and then make the announcement on Whonix's blog and debian-devel?\n\nNo, I don't think progress should be blocked by Debian since I find the\nrequest to wait to create the ticket quite strange. Tickets should help\nto postpone and organize work in the future, but if we must wait for the\nright time to create a ticket (and forget until then, then we need\nanother tracker and a ticket to make notes about when to create a ticket. :)"},{"author":"dau","date_created":1493585787,"date_modified":1493585787,"content":">>! In T659#13135, @Patrick wrote:\n> dau (Felipe Dau):\n>>   (Should this be discussed in another ticket?)\n> \n> You can if there are additional questions, sure.\n\nAlright, opened T668.\n\n> Oh, I forgot that the link is for some reason (bug) not obvious on our\n> wordpress installation. Sign up can be done here:\n> \n> https://www.whonix.org/blog/wp-admin/\n\nAh, got it! Just created it :)\n\n> No, I don't think progress should be blocked by Debian since I find the\n> request to wait to create the ticket quite strange. Tickets should help\n> to postpone and organize work in the future, but if we must wait for the\n> right time to create a ticket (and forget until then, then we need\n> another tracker and a ticket to make notes about when to create a ticket. :)\n\nSounds good. Opened T669 too.\n\nUnrelated: Is it possible to reply to the email notifications to post replies here? Because the sender is `noreply@phabricator.whonix.org`.\n\nThanks!"},{"author":"Patrick","date_created":1493599664,"date_modified":1493599664,"content":"dau (Felipe Dau):\n>> Oh, I forgot that the link is for some reason (bug) not obvious on\n>> our wordpress installation. Sign up can be done here:\n>> \n>> https://www.whonix.org/blog/wp-admin/\n> \n> Ah, got it! Just created it :)\n\nJust now added rights to your account so you can write and post. :)\n\n> Unrelated: Is it possible to reply to the email notifications to post\n> replies here? Because the sender is\n> `noreply@phabricator.whonix.org`.\n\nActually, reply by e-mail works. I use it quite often. Such as now.\nIndeed `noreply` is not great as sender. Although I every now and then\ncheck if my reply really reached the tracker. Everything below `-----`\nor so is eaten, because phabricator thinks that's a mail signature to be\nbetter cut off."},{"author":"dau","date_created":1493658891,"date_modified":1493658891,"content":"I tried to reply, but here is what I got:\n\n```\nYour email to Phabricator was not processed, because an error occurred while\ntrying to handle it:\n\nYour message does not contain any body text or attachments, so Phabricator can\nnot do anything useful with it. Make sure comment text appears at the top of\nyour message: quoted replies, inline text, and signatures are discarded and\nignored.\n\n-- Original Message Body -----------------------------------------------------\n\nOn Mon, May 01, 2017 at 12:47:47AM +0000, Patrick (Patrick Schleizer) wrote:\n> Just now added rights to your account so you can write and post. :)\n\nCool!\n\n> Actually, reply by e-mail works. I use it quite often. Such as now.\n> Indeed `noreply` is not great as sender. Although I every now and then\n> check if my reply really reached the tracker. Everything below `-----`\n> or so is eaten, because phabricator thinks that's a mail signature to be\n> better cut off.\n\nOh, good to know. I am replying to this one. Let's see if it is\ndelivered.\n\nThanks :)\n```\n\nI think my comment is basically \"quoted replies\" and \"inline text\". How exactly do I use this? :P"},{"author":"Patrick","date_created":1494168168,"date_modified":1494168168,"content":"May I assign this to you?"},{"author":"dau","date_created":1494638356,"date_modified":1494638356,"content":">>! In T659#13246, @Patrick wrote:\n> May I assign this to you?\n\nSure!\n\nI modified the initial part of the proposal a bit for the blogpost, but should be the same idea.\n\n---\n\n# Listen Port Convention\n\nServer applications using Tor ephemeral onion services such as ricochet-im, onionshare, ZeroNet and unMessage usually listen on localhost only, as Tor usually runs on the same system and is able to map them. However, due to Whonix's split design, Tor runs on the gateway and the application runs on the workstation, requiring the application to listen on the workstation's external interface in order to allow the mapping from the gateway.\n\nAt the moment, it looks like there is no convention to configure where these applications listen by default (localhost vs. all interfaces) and deciding that seems to be up to the upstream author of the software as well as the packager. Then it's up to the system administrator to decide on where the server application should listen, and currently there is not a great place for derivatives to globally modify this setting.\n\nWe believe that a solution to this problem is having a convention where listen config files for server applications are added to `listen.d` folders. Applications would then use a parser to read these configs in order to find, for example, which interface to listen on. This approach would prevent redundancy of application configs, support multiple systems, simplify applications development/packaging, as well as the system administration.\n\nWe would like to present the [[ https://github.com/Whonix/proposals/blob/master/635-listen-port-convention.txt | specification ]] of such a convention we have written, after incorporating feedback from users of [[ https://lists.debian.org/debian-devel/ | debian-devel ]]. What do you think? Would you use it? Can it be improved? Lets us know your opinion.\n\n---\n\nIs it too long?\n\nIs it okay to link to the file on GitHub? It was going to be hosted somewhere at whonix.org as well, right?\n\nThe \"New Post\" page has lots of options. Can you tell me which I should change and which I shouldn't?\n\nLet me know what you think.\n\nThanks! (And sorry for the delay :/ )"},{"author":"Patrick","date_created":1494946811,"date_modified":1494946811,"content":"> Is it too long?\n\nNo.\n\n> Is it okay to link to the file on GitHub?\n\nYes.\n\n> It was going to be hosted somewhere at whonix.org as well, right?\n\nNo.\n\n> The \"New Post\" page has lots of options. Can you tell me which I should change and which I shouldn't?\n\nFeel free flip button whatever seem useful. I don't think there is much room for critical mess up. Then store it as draft. I'll give it a look before we'll post it to make sure none of the buttons is wrong.\n\n> Let me know what you think.\n\nSo far so great! :)\n\n> Thanks! (And sorry for the delay :/ )\n\nAh, no problem. I've became quite slow these days as well. No worries."},{"author":"dau","date_created":1494960828,"date_modified":1494960828,"content":"Alright, thanks :)\n\nI just checked some options and saved a draft. Let me know if you need a link or something to find it.\n\nAlso, do I need a Discourse account?\n\nThanks!"},{"author":"Patrick","date_created":1494961828,"date_modified":1494961828,"content":"https://www.whonix.org/blog/wp-admin/post.php?post=2296&action=edit could you have a look please. @torjunkie\n\n>>! In T659#13288, @dau wrote:\n> Also, do I need a Discourse account?\n\nNot required for this very task, however very much welcome for your Whonix interest generally.\n\n> I just checked some options and saved a draft. Let me know if you need a link or something to find it.\n\nLooks good. Switched some minor buttons. (Enabled posting to discourse, our forums, because comments then can be posted there. We use discourse for comments, not wordpress due to usability.)"},{"author":"dau","date_created":1494963617,"date_modified":1494963617,"content":">>! In T659#13289, @Patrick wrote:\n> Not required for this very task, however very much welcome for your Whonix interest generally.\n\nAlright. Wait, is the forum account a Discourse account? Or I must register somewhere?\n\n> Looks good. Switched some minor buttons. (Enabled posting to discourse, our forums, because comments then can be posted there. We use discourse for comments, not wordpress due to usability.)\n\nThanks!\n"},{"author":"Patrick","date_created":1494967786,"date_modified":1494967786,"content":"dau (Felipe Dau):\n> dau added a comment.\n> \n> \n>   In https://phabricator.whonix.org/T659#13289, @Patrick wrote:\n>   \n>   > Not required for this very task, however very much welcome for your Whonix interest generally.\n>   \n>   \n>   Alright. Wait, is the forum account a Discourse account?\n\nYes. Our forum is using discourse (Libre Software forum software)."},{"author":"dau","date_created":1494978973,"date_modified":1494978973,"content":">>! In T659#13291, @Patrick wrote:\n> Yes. Our forum is using discourse (Libre Software forum software).\n\nAhh, cool. Okay, added that to my blog profile.\n\nLet me know if you need anything :)\n\nThanks!"},{"author":"Patrick","date_created":1495023905,"date_modified":1495023905,"content":"Please have a look:\n\nhttps://forums.whonix.org/t/long-wiki-edits-thread/3477/194"}]},"PHID-TASK-y6rvemug5ajhjxdlc3wb":{"id":"658","title":"Qubes-Whonix 14 timesync vs usabilty decision","status":"invalid","priority":"Normal","author":"Patrick","description":"#Whonix_14 will come with major time related deanonymization attack defenses. The only networking allowed is Tor and sdwdate until sdwdate succeeded, i.e. until the clock is unlinked from all other VMs. (T533)\n\nOn the Qubes-Whonix side this does not work well yet #usability wise.\n\nThe real solution would be T534, but that is hard to implement. Needs tons of time that I currently do not have. I doubt I can implement it in time for #Whonix_14.\n\nOptions are:\n\n* 1) disable this new feature in Qubes-Whonix [1]\n* 2) leave it enabled, but then users would have really bad usability [2]\n* 3) somehow magically find a contributor who implements T534 [3]\n\nWhich option do you suggest? @marmarek \n\n-----\n\n[1] Enabling / disabling this feature is as simple as an `/etc/whonix_firewall.d/` config snippet drop-in.\n[2] Tor Browser might already be started, but with broken connectivity, since time synchronization is not done yet. And if time synchronization was to fail, then this issue would not be communicated to the user.\n[3] I could ask iry to work on the gui part, but at the moment iry has its hands full with anon-connection-wizard.","comments":[{"author":"marmarek","date_created":1492088013,"date_modified":1492088013,"content":"I'm not sure about sdwdate-gui details, but could it be started in a mode without tray icon and only show notifications? Maybe also make sure that notifications do not expire until sdwdate succeed. Or maybe hide tray icon when time is synchronized?\nThose should be much easier to do than full T534."},{"author":"Patrick","date_created":1492090956,"date_modified":1492090956,"content":"I forgot about one option.\n\n4) Accepting that there will be X tray icons for X number of\nWhonix-Workstation VMs until T534 gets implemented. For example:\n\n* a) sys-whonix + anon-whonix -> 2 sdwdate-gui systrays; or another example\n\n* b) sys-whonix + anon-web + anon-mail + anon-chat -> 4 sdwdate-gui systrays\n\nWhat do you think about option 4)?\n\nmarmarek (Marek Marczykowski-Górecki):\n> I'm not sure about sdwdate-gui details,\n\nCode wise at the moment it's rather simple. Below 200 lines of python3 code.\n\nhttps://github.com/Whonix/sdwdate-gui/blob/master/usr/lib/python3/dist-packages/sdwdate_gui/sdwdate_gui.py\n\n> but could it be started in a\n> mode without tray icon and only show notifications?\n\nLet's call this option 5).\n\nPerhaps. Still too much work.\n\n* Not having notifications that never be closed. (Just now got one with\n`notify-send --expire-time=0 test` where the `X` button does nothing.)\n* Close the no longer needed notifications.\n* Have a concept of persistent-because-in-progress types of\nnotifications vs short-lived-notifications-on-success. (At the moment,\nsdwdate-gui is rather simple. It shows whatever sdwdate wrote into a\nfile and file changes to that.)\n\nAnd I speculate Joanna would hate to see a user auto starting like 4\nWhonix VMs and then 4 persistent notifications that don't go away let's\nsay for example in case of network issues.\n\nI guess usability wise 5) could be worse than 4)?"},{"author":"marmarek","date_created":1492091860,"date_modified":1492091860,"content":"What about hiding sdwdate-gui icon when time is synchronized? So, have an icon only when there is some problem or sdwdate is still bootstrapping? This isn't ideal as actions like restart/stop will be unavailable, but maybe good enough for now?"},{"author":"Patrick","date_created":1492105161,"date_modified":1492105161,"content":"Another issue at the moment with sdwdate-gui in Qubes is, that users\ncannot really know which sdwdate-gui belong to which VM. The coloring of\nthe sys-tray works, but you could not distinguish them if both used the\nsame color.\n\nThat's more of a general Qubes issue. Should I try to work around it by\nadding the Qubes VM name to the sdwdate-gui right click menu?\n\nSame is true for the hover over passive tooltips. Should I add the Qubes\nVM name there as well?\n\nmarmarek (Marek Marczykowski-Górecki):\n> marmarek added a comment.\n> \n> \n> What about hiding sdwdate-gui icon when time is synchronized? So,\n> have an icon only when there is some problem or sdwdate is still\n> bootstrapping? This isn't ideal as actions like restart/stop will be\n> unavailable, but maybe good enough for now?\n\nLet's see.\n\n- a) a mode where sdwdate-gui terminates itself or shows no systray\nafter time synchronization is done\n- b) another mode where sdwdate-gui works normally\n- or just deprecate mode b)?\n- sdwdate-gui would need a concept of \"timesync done\". At the moment\nit's just reading from a file that sdwdate maintains.\n\nMay also seem a bit strange, systrays that come and vanishes? After\nbooting a VM, it shows a yellow systray, which is gone after a while? Do\nyou think that is usability wise still better than multiple persistent\nsystrays?"},{"author":"marmarek","date_created":1492193343,"date_modified":1492193343,"content":">>! In T658#12969, @Patrick wrote:\n> Another issue at the moment with sdwdate-gui in Qubes is, that users\n> cannot really know which sdwdate-gui belong to which VM. The coloring of\n> the sys-tray works, but you could not distinguish them if both used the\n> same color.\n> \n> That's more of a general Qubes issue. Should I try to work around it by\n> adding the Qubes VM name to the sdwdate-gui right click menu?\n> \n> Same is true for the hover over passive tooltips. Should I add the Qubes\n> VM name there as well?\n\nThis is indeed valid issue. In general case adding VM name inside tooltip isn't good, because VM can spoof it. But since we don't have anything better now (there is very little space around tray icons), IMO it would be ok here.\n\n> - sdwdate-gui would need a concept of \"timesync done\". At the moment\n> it's just reading from a file that sdwdate maintains.\n\nExistence of `/var/run/sdwdate/success`?\n\nIndeed this may be a bit strange, but not so unusual - for example some graphical package managers shows an icon only when updates are pending. Yes, IMO it would be better than multiple persistent systrays - if for nothing else, for saving space in notification area. I'd add it as a separate mode, and deprecate it after implementing proper solution (T534)."},{"author":"anonymous1","date_created":1492344545,"date_modified":1492344545,"content":"What about having a single sdwdate for all Qubes which will add/substract some random skew for each VM?"},{"author":"Patrick","date_created":1492359963,"date_modified":1492359963,"content":">>! In T658#12975, @anonymous1 wrote:\n> What about having a single sdwdate for all Qubes which will add/substract some random skew for each VM?\n\nI'd like that, however the design for that is not done. The implications on anonymity may prevent advise against that. Recently raised here:\nT387#12552"},{"author":"anonymous1","date_created":1492363954,"date_modified":1492363954,"content":"With the recent work on the time sources the results would be very close to NTP accuracy and setting offsets to no more than 1 or 2 seconds, I think it is not such a bad idea to have just a single sdwdate"},{"author":"Patrick","date_created":1493316262,"date_modified":1493316262,"content":"anonymous1 (anonymous1):\n> With the recent work on the time sources the results would be very\n> close to NTP accuracy and setting offsets to no more than 1 or 2\n> seconds, I think it is not such a bad idea to have just a single\n> sdwdate\n\nThis seems very risky. Once by chance two servers are off too much, it\nwould mess up all VMs."},{"author":"anonymous1","date_created":1493773944,"date_modified":1493774386,"content":"I think we can ignore the results when three of them are not very close. It should still be more efficient than multiple instances.\n\nIn this case all three sources would need to be off to similar degree to mess up VMs"},{"author":"Patrick","date_created":1500825813,"date_modified":1500825813,"content":"Whonix #Whonix_14 let's go with:\n\n> 1) disable this new feature in Qubes-Whonix [1]\n\n(Until T534 is implemented.)\n"},{"author":"Patrick","date_created":1512242795,"date_modified":1512242795,"content":"\"Solution\": for now, not enabling timesync fail closed neither in Qubes-Whonix nor Non-Qubes-Whonix since neither T636 nor T534 were finished in time."}]},"PHID-TASK-5vaucv6qrakhm6kmtgma":{"id":"657","title":"consider to remove /usr/lib/anon-ws-disable-stacked-tor/controlportfilt.sh","status":"resolved","priority":"Normal","author":"Patrick","description":"* https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/usr/lib/anon-ws-disable-stacked-tor/controlportfilt.sh\n* https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/etc/X11/Xsession.d/20controlportfilt\n* https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/etc/profile.d/20_controlportfilt.sh\n\nmay not be required anymore:\n\n   export TOR_CONTROL_HOST=\"127.0.0.1\"\n\n   export TOR_CONTROL_PORT=\"9151\"\n\ntest if still required:\n\n   export TOR_CONTROL_PASSWD='\"password\"'","comments":[{"author":"JasonJAyalaP","date_created":1496435225,"date_modified":1496435225,"content":"I commented out the three lines and rebooted. Both stable and alpha connect fine.\n\n{F588249}\n\n{F588250}\n\nDo I simply remove the whole block of code:\n\n```\nif [ ! \"$CONTROL_PORT_FILTER_PROXY\" = \"0\" ]; then\n\n   export TOR_CONTROL_HOST=\"127.0.0.1\"\n\n   export TOR_CONTROL_PORT=\"9151\"\n\n   ## this is to satisfy Tor Button just filled up with anything\n   export TOR_CONTROL_PASSWD='\"password\"'\nfi\n```\n\nor ## comment the export lines?\n\nI'm assuming that\n```\nif [ ! \"$CONTROL_PORT_FILTER_PROXY\" = \"0\" ]; then\n\n   export TOR_CONTROL_HOST=\"127.0.0.1\"\n\n   export TOR_CONTROL_PORT=\"9151\"\n\n   ## this is to satisfy Tor Button just filled up with anything\n   export TOR_CONTROL_PASSWD='\"password\"'\nfi\n```\nis still useful."},{"author":"Patrick","date_created":1496492387,"date_modified":1496492387,"content":">>! In T657#13429, @JasonJAyalaP wrote:\n> I commented out the three lines and rebooted. Both stable and alpha connect fine.\n\nDid you try new identity? Does it work?\n\nhttps://www.whonix.org/wiki/Tor_Browser#New_Identity_Function\n\nPlease also `Verify New Identity`.\n\nhttps://www.whonix.org/wiki/Tor_Browser/Advanced_Users#Verify_New_Identity\n\n> I'm assuming that ... is still useful.\n\nTry to remove as much as possible.\n\n`TOR_CONTROL_PASSWD` might still be required. Please make a separate test if that is still needed.\n"},{"author":"JasonJAyalaP","date_created":1496509883,"date_modified":1496509937,"content":"> Try to remove as much as possible.\nI pasted the wrong code, I meant to say that I'm assuming we still need:\n```\nfor i in /etc/controlportfilt.d/*.conf /rw/config/controlportfilt.d/*.conf; do\n   if [ -f \"$i\" ]; then\n      . \"$i\"\n   fi\ndone\n```\n> Did you try new identity? Does it work?\n\nYes.\n\n> Please also Verify New Identity.\n\nCheck.TPO reveals a new IP.\nThe two commands\n```\nsudo journalctl -f -u control-port-filter-proxy\nsudo journalctl -f -u onion-grater\n```\ndon't show anything, however.\n\n> `TOR_CONTROL_PASSWD` might still be required. Please make a separate test if that is still needed.\n\nI don't understand. If PASSWD is blank and it still works, how do I test more? Needed for what?"},{"author":"Patrick","date_created":1496666701,"date_modified":1496666701,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   > Try to remove as much as possible.\n>   \n>   I pasted the wrong code, I meant to say that I'm assuming we still need:\n>   \n>     for i in /etc/controlportfilt.d/*.conf /rw/config/controlportfilt.d/*.conf; do\n>        if [ -f \"$i\" ]; then\n>           . \"$i\"\n>        fi\n>     done\n\nYes, remove that.\n\n>   > Did you try new identity? Does it work?\n>   \n>   Yes.\n>   \n>   > Please also Verify New Identity.\n>   \n>   Check.TPO reveals a new IP.\n>   The two commands\n>   \n>     sudo journalctl -f -u control-port-filter-proxy\n>     sudo journalctl -f -u onion-grater\n>   \n>   don't show anything, however.\n\nThis one.\n\n    sudo journalctl -f -u tor-controlport-filter\n\nWill change to onion-grater in next development version of Whonix.\n\n>   > `TOR_CONTROL_PASSWD` might still be required. Please make a separate test if that is still needed.\n>   \n>   I don't understand. If PASSWD is blank and it still works, how do I test more?\n\nIf password is unset and it still works, no more testing required. (Just\nwatching `sudo journalctl -f -u tor-controlport-filter` while running\nTor Browser New Idenity is required to be sure it's really working.)"},{"author":"JasonJAyalaP","date_created":1496687716,"date_modified":1496687716,"content":"Done and closed.\n\nnew identity looks fine:\n{F594639}\n\nIf we don't need to source the control port filter.d, we don't the the file at all. Then, we don't need the two other files that simply source this unneeded file. I will remove all 3 files."}]},"PHID-TASK-cdmdfscgsogtzzo4qykb":{"id":"656","title":"abolish qubes-whonix alert script /port to whonixcheck","status":"open","priority":"Normal","author":"Patrick","description":"#qubes-whonix alert script....\n\n* https://github.com/Whonix/qubes-whonix/blob/master/usr/lib/qubes-whonix/alert\n* https://github.com/Whonix/qubes-whonix/blob/master/usr/lib/qubes-whonix/messages.yaml\n* https://github.com/Whonix/qubes-whonix/blob/master/usr/lib/qubes-whonix/qubes-whonixsetup\n\nshould be ported to #whonixcheck because it does not really belong there. Leftover from the initial Qubes-Whonix implementation.","comments":[]},"PHID-TASK-ipp73fhgk4fqilndbb7m":{"id":"655","title":"review and merge vpn-firewall pull reqeust - 'Using capabilities instead of sudoers'","status":"open","priority":"Normal","author":"Patrick","description":"https://github.com/adrelanos/vpn-firewall/issues/24#issuecomment-290462723","comments":[]},"PHID-TASK-k4l65qnk26t62qzotuyc":{"id":"654","title":"create an unMessage onion-grater profile","status":"invalid","priority":"Normal","author":"Patrick","description":"Should be added here:\n\nhttps://github.com/Whonix/onion-grater/tree/master/usr/share/onion-grater/examples\n\nfile name: `40_unmessage.yml`\n\nThe following profile is a guess from https://github.com/meejah/txtorcon/issues/215#issuecomment-290079835 which may be useful for developer testing so a production profile can be provided. Untested.\n\n\n```\n---\n- exe-paths:\n    - '*'\n  users:\n    - '*'\n  hosts:\n    - '*'\n  commands\n    GETCONF:\n    ## Just added to have something in GETCONF.\n    ## TODO: Try to remove or add something that is actually required.\n    - SocksPort\n    GETINFO:\n    - events/names\n    - signal/names\n    - config/names\n    GETCONF:\n      - 'DisableNetwork'\n    ADD_ONION:\n    ## TODO: Needs to be locked down like other profiles.\n    - '.*'\n    DEL_ONION:\n      - '.+'\n    USEFEATURE:\n    - EXTENDED_EVENTS\n  events:\n    STATUS_CLIENT:\n      suppress: true\n    HS_DESC:\n      suppress: false\n```\n","comments":[{"author":"dau","date_created":1495993243,"date_modified":1495993243,"content":"Here is an update, based on the profile you provided and Ricochet's:\n\n```\n---\n- exe-paths:\n    - '*'\n  users:\n    - '*'\n  hosts:\n    - '*'\n  commands:\n    GETCONF:\n      - DisableNetwork\n      - SocksPort\n    GETINFO:\n      - events/names\n      - signal/names\n      - config/names\n    ADD_ONION:\n      - pattern:     'NEW:(\\S+) Port=11887,\\S+:(\\S+)'\n        replacement: 'NEW:{} Port=11887,{client-address}:{}'\n      - pattern:     '(\\S+):(\\S+) Port=11887,\\S+:(\\S+)'\n        replacement: '{}:{} Port=11887,{client-address}:{}'\n    DEL_ONION:\n      - '.+'\n    USEFEATURE:\n      - EXTENDED_EVENTS\n  events:\n    STATUS_CLIENT:\n      suppress: true\n    HS_DESC:\n      suppress: false\n```\n\nI logged the commands that txtorcon send while starting/stopping unMessage creating a new peer:\n\n```\nPROTOCOLINFO 1\nAUTHENTICATE\nGETINFO signal/names\nGETINFO version\nGETINFO events/names\nUSEFEATURE EXTENDED_EVENTS\nSETEVENTS CONF_CHANGED\nGETINFO config/names\nGETCONF DisableNetwork\nADD_ONION NEW:BEST Port=11887,10.137.3.28:11887\nSETEVENTS HS_DESC CONF_CHANGED\nSETEVENTS CONF_CHANGED\nDEL_ONION <onion>\n```\n\nAs well as when starting/stopping using an existing user:\n\n```\nPROTOCOLINFO 1\nAUTHENTICATE\nGETINFO signal/names\nGETINFO version\nGETINFO events/names\nUSEFEATURE EXTENDED_EVENTS\nSETEVENTS CONF_CHANGED\nGETINFO config/names\nGETCONF DisableNetwork\nADD_ONION <alg>:<key> Port=11887,10.137.3.28:11887\nSETEVENTS HS_DESC CONF_CHANGED\nSETEVENTS CONF_CHANGED\nDEL_ONION <onion>\n```\n\n(I talked to rxcomm and we picked `11887` as the new port instead of `50000`.  I looked in the [[ https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers | page ]] you had linked and searched on the internet and did not find other services using it.)\n\nI am going to ask meejah if `SocksPort` is really needed because it does not seem to be used. I am not sure if it should, but it does not send any command to connect to other peers.\n\nThis profile works: I was able to send/receive requests as well as regular messages. Is there anything else that should be removed from it?\n\nThanks!\n"},{"author":"dau","date_created":1496176356,"date_modified":1496176356,"content":"I talked to meejah and `GETCONF SOCKSPort` is only issued when it fails to use the port that was provided or the default ones. I think we could allow that and leave it up to txtorcon to query the process the right SOCKS port. That will make it easier for us to implement the automatic Tor process handling (one less thing to ask the user)."},{"author":"Patrick","date_created":1496180666,"date_modified":1532427077,"content":"Looks good!\n\nI would have to see a log of communication of onion-grater. As well as Tor's reply to `GETCONF SOCKSPort`. Just to be able to see if the output contains anything the workstation should better not know.\n\nCould you add it here please? https://github.com/Whonix/onion-grater/tree/master/usr/share/onion-grater-merger/examples\n"},{"author":"Patrick","date_created":1532427092,"date_modified":1532427092,"content":"Ping @dau."},{"author":"Patrick","date_created":1562408903,"date_modified":1562408903,"content":"Dead upstream."}]},"PHID-TASK-m3pknxabwcyu757fzbjd":{"id":"653","title":"update /etc/whonix_version","status":"open","priority":"Low","author":"Patrick","description":"`/etc/whonix_version` was introduced in #Whonix_14.\n\nThis ticket serves as reminder to keep updating it from major version to major version.\n\nhttps://github.com/Whonix/whonix-base-files/blob/master/etc/whonix_version\n\n#Whonix_14 done\n#Whonix_15 done\n#Whonix_16 todo","comments":[]},"PHID-TASK-rfneize7bq6pj3bz6fvb":{"id":"652","title":"test Thunderbird with Torbirdy / anon-gpg-tweaks changes required?","status":"resolved","priority":"Normal","author":"Patrick","description":"Relevant recent changes:\n\n* Whonix 14 will ship `gpg2`\n* https://gitweb.torproject.org/torbirdy.git/commit/?id=09acfd09c465ba9cb50b6a4d03f155f02a081391\n* https://trac.torproject.org/projects/tor/ticket/19971\n* https://trac.torproject.org/projects/tor/ticket/16935\n* https://trac.torproject.org/projects/tor/ticket/17533\n\nTODO:\n\n* Install `dirmngr` by default? (Since `gpg2`, `dirmngr` is required for `gpg --recv-keys`.)\n* see if any changes to https://github.com/Whonix/anon-gpg-tweaks/blob/master/etc/skel/.gnupg/gpg.conf should be done\n* consider ship `/etc/icedove/pref/30_whonix.js`\n * `pref(\"extensions.torbirdy.gpg_already_torified\", true);`\n* consider ship `/etc/skel/.gnupg/dirmngr.conf` with\n * `use-tor`\n * see `/usr/share/gnupg/dirmngr-conf.skel`\n * what else?\n* try torbirdy version from torbirdy git master, see if it still works in #debian_stretch based Whonix 14\n* see if keyserver communication is now fixed, should be as per above torbirdy changes\n","comments":[{"author":"Patrick","date_created":1490888151,"date_modified":1520776651,"content":"This was done. Commit link?\n\n* https://github.com/Whonix/anon-gpg-tweaks/commit/d7ecded06ae038e160fe132c7eee1e01f3adcd21\n* https://github.com/Whonix/anon-gpg-tweaks/commit/305555b41d9472b9329acb4f13dd4420738f7ddc\n\nTODO:\n\n* test\n* `gpg2 --recv-keys ...` [functional]\n* test TorBirdy 0.2.1 [todo test]\n* test TorBirdy 0.2.3 [functional]\n* test TorBirdy git master [todo test]\n* reply to trac.torproject.org tickets [todo]\n"},{"author":"unman","date_created":1522851246,"date_modified":1522851246,"content":"Tested in VirtualBox and Qubes-Whonix using 13-14 upgraded templates.\nConfirmed ships with dirmsgr and /etc/thunderbird/pref/30_whonix.js and /etc/skel/.gnupg/dirmngr.conf as per spec.\n\ngpg2 works as expected, including --recv-keys.\n\nTorBirdy - 0.21 functional testing is fine - tested POP3 and IMAP, and confirmed Tor transport at server side.\n\nNot yet tested -0.2.3 or git master\n\n\n"},{"author":"Patrick","date_created":1674125836,"date_modified":1674125836,"content":"https://forums.whonix.org/t/torbirdy-replacement/8782"}]},"PHID-TASK-pbkxmz4qwbekadsh63xw":{"id":"651","title":" Tor Browser 7.0a2 broken in stretch based Whonix 14 - <jemalloc>: Corrupt redzone 0 bytes after 0x7f0503ede9d0 (size 80), byte=0x0","status":"resolved","priority":"High","author":"Patrick","description":"Happening with stretch based Qubes-Whonix 14 development version.\n\nNot happening with Qubes Debian stretch based AppVM.\n\nReported a bug upstream at:\nhttps://trac.torproject.org/projects/tor/ticket/21804\n","comments":[{"author":"JasonJAyalaP","date_created":1496444133,"date_modified":1496444133,"content":"Still happening with 7.0a4"},{"author":"JasonJAyalaP","date_created":1498581338,"date_modified":1498583185,"content":"> We won't ship Tor Browser with jemalloc4 anymore\nhttps://trac.torproject.org/projects/tor/ticket/21804#comment:8\n\nUh. Does that mean they're taking it out? In the next alpha, and we can close this?\n\nMy WS TBB updated itself to 7.0.1 and it is running fine."},{"author":"Patrick","date_created":1498601520,"date_modified":1498601520,"content":"No, we must understand which part exactly of Whonix is triggering such a strange bug."},{"author":"matvey","date_created":1498749573,"date_modified":1498749573,"content":"\nThe main problem at the level of software errors is that the \"simplification of memory allocation\" undertaken by the developers of the browser in version 6.56a seems to give the error of the memory leaks during the integrity check procedure on the bug tracker, they will indicate \"memory hardening\" - as additional memory protection mechanisms Including interference with environment variables LD_PRELOAD and LD_LIBRARY_PATH)\n\nJemalloc allocates memory not as standard C-based malloc (or based on bust-based) - the standard distributed memory scheme assumes the usual allocation of pages and the display of process images in them, almost as well as in windows.\nJemalloc makes a break from the memory of the areas called \"arenas\". This is done in order to collect all the libraries at different times in order to avoid any errors in the flow, for example, the threads that execute plug-ins into memory, for example, the rendering engine.\n\nWhen I collected the debugging symbols and turned off the code optimization for versions 7.04a (firefox 51.1.1), it turned out that error messages in the redzone integrity begin to flow in the arenas validation procedure.\nIn this procedure, only messages, segfolt, which makes the debugger hangs later and is called from the process of infecting the SIGENV kernel, to avoid code variants in the wrong memory.\n\nI have a very long time in the history of the bugtracker Firefox and when they solved the problem with jemalloc 3 (now used in 4 countries of the world) - there there is several times a similar situation where on different platforms the calculation of allocated memory ends with an error due to different values ​​of some constants for Different platforms. And then they were manually distributed by hand, and then most likely forgot about it with the release of the new version. In the jamalloc bugtracker, everything is very sad, and so they decided to remove it from FireFox. And of course TorBrowser project immediately followed suit.\nThat's when they closed this bug with a mark of WONTFIX.\n\nI went the other way and noticed that the validation of FireFox itself is wrong, and because of this it falls with an error. But it's ok to validate the redzone validation in jemalloc in the FireFox assembly options and everything works. But of course all the advantages of \"memory hardening\" disappear\n\nI also assumed that the error consists of the problems associated with the failure of redzone in jemalloc - then this is a gross error of the concrete version of jemalloc, which can not be returned back. New versions of Firefox are no longer compatible with the old jemalloc3.\n\nThen I started to rebuild myself Whonix, it was possible to compile on Travis. There were a lot of mistakes that had to be eliminated and wasted time for understanding in the availability of undocumented details. As a result, I collected incorrectly, as a result of which the variable XDG_CONFIG_DIRS remained almost empty. The distribution remained almost in the state of pure debian. In this state, I started the browser and it worked.\nI compared the environment of Whonix and the surroundings of what I had collected. I came to the conclusion that the difference is only in this variable. Checked it - it turned out that this is true.\nThe environment variable XDG_CONFIG_DIRS to different additional directories of the Whonix configuration files.\nI started to produce a lot of testing, which wasted my time. As a result, I came to the conclusion that 7 kinds of any catalogs, even nonexistent, do not affect the launch of the browser, adding the eighth directory results in a memory leak.\nBusiness in the very number.\nIt turned out that this is a common software problem in C - going beyond the boundaries of variables / arrays.\n\n\nIt does not affect TorBrowser itself. This affects the processing of the jemalloc4 function variables.\nBecause if you disable jemalloc4 during compilation - TorBrowser is compiled without it and starts.\nBut the very idea is to protect the memory of the browser using jemalloc4.\n\nThis problem is also relevant on pure Debian. If there are more than 7 directories in the variable XDG_CONFIG_DIRS, then the browser will fall with this error, because jemalloc can not process it.\n\nYou can check it as follows.\n\nOpen terminal, write\nEcho $ XDG_CONFIG_DIRS\nThe current value is displayed - a list of folders is displayed, the divided symbol :.\nNext we introduce\nXDG_CONFIG_DIRS = /etc/XDG\nResets the variable to the default value\nDownload the problem version of TorBrowser\nWget https://archive.torproject.org/tor-package-archive/torbrowser/7.0a2/tor-browser-linux64-7.0a2_en-US.tar.xz\nUnpack it\nTar xf tor-browser-linux64-7.0a2_en-US.tar.xz\nGo to the browser directory\nCd tor-browser_en-US\nLaunch\n./start-tor-browser.desktop --debug\n\nThe browser should start.\n\nNext, we set 7 directories, the values ​​can be randomized\nXDG_CONFIG_DIRS = /etc/XDG:/etc/XDG:/etc/XDG:/etc/XDG:/etc/XDG:/etc/XDG:/etc/ XDG\nLaunch\n./start-tor-browser.desktop --debug\n\nAgain I have to start\nNext, we set 8 directories\nXDG_CONFIG_DIRS = /etc/xdg:/etc/xdg:/etc/xdg:/etc/xdg:/etc/xdg:/etc/xdg:/etc/xdg:/etc/xdg\nLaunch\n./start-tor-browser.desktop --debug\n\nWe get the same error as in the case with the usual value for Whonix 14.\n\nDistressed versions have all been removed from the repositories, make version 7.5 without these problems. , So this problem version can not be used.\n\nNow with the new versions of jemalloc 4 - this problem is no longer relevant."},{"author":"Patrick","date_created":1498750287,"date_modified":1498750287,"content":"Great work!"},{"author":"JasonJAyalaP","date_created":1498756722,"date_modified":1498756722,"content":"Thanks @matvey. It's nice to see this resolved."}]},"PHID-TASK-cpi62fh2kfgpshomcmga":{"id":"650","title":"review 30 lines of sclockadj inline C code","status":"resolved","priority":"Normal","author":"Patrick","description":"sclockadj has a strange 100% CPU bug after suspend and resume. That is tracked as T50.\n\nPerhaps the issue lies in the 30 lines of inline #c_code that #sclockadj is being using?\n\nTODO:\n\n* review https://github.com/Whonix/sdwdate/blob/master/usr/lib/sdwdate/sclockadj#L189-L224\n* see if there is anything that could trigger the 100% CPU usage bug\n* see if there are other potential issues\n","comments":[{"author":"marmarek","date_created":1489678550,"date_modified":1489678550,"content":"I don't see any loop there and only very simple function calls, so I don't see how that would trigger such bug...\n\nHave you tried attaching gdb that that process when it consume 100% CPU? If you have python-dbg installed, you should see python code in backtrace (`bt` command there)."},{"author":"Patrick","date_created":1489678903,"date_modified":1489678903,"content":"Thanks for having a look!\n\nsclockadj is written in ruby. Would python-dbg still work there?"},{"author":"marmarek","date_created":1489679475,"date_modified":1489679475,"content":"Ah, it's ruby... So, python-dbg is irrelevant, but trying gdb may still be a good idea."},{"author":"marmarek","date_created":1489679561,"date_modified":1489679561,"content":"Can't find what debian package ship debug symbols, there is no -dbg package there: https://packages.debian.org/source/stretch/ruby2.3"},{"author":"s.sh","date_created":1489685352,"date_modified":1489685352,"content":"The C code itself doesn't have any CPU intensive instruction, if the problem is really what is written as inline C, I suspect the issue is either with \n```\nclock_gettime(0, &tps)\n```\nor \n\n\n```\nclock_settime(0, &tps)\n```\n\nplease report to me the output of this:\n\n```\nbash: echo $TZ\n```"},{"author":"Patrick","date_created":1489689072,"date_modified":1489689072,"content":"TZ is unset since it's started as a systemd unit file."},{"author":"s.sh","date_created":1489689449,"date_modified":1489690145,"content":"the  clock_gettime and clock_settime functions are passing zero as their first parameters and that means CLOCK_REALTIME. Firstly the process needs root privilege to touch real time clock, secondly you need to somehow run it by strace like:\n\n```\n#strace <command>\n```\nto see when it makes CPU run at 100% what's exactly happening (i.e which system calls are repeatedly called at that time). \nAnd at last check whether you can set TZ=:/etc/localtime or not."},{"author":"Patrick","date_created":1489754908,"date_modified":1489754908,"content":"Yes, sclockadj runs as root. Usually sclockadj is functional.\n\nJust after suspend it takes 100% CPU. But not forever. If the suspend was short, the 100% CPU usage will not take forever. That's the only bug.\n\nPerhaps it's more likely some bug in the ruby loop? Looks like it tries to catch up with all loop iterations it missed during the suspend.\n\nWill take me a few days until I get to debug this."},{"author":"JasonJAyalaP","date_created":1496443437,"date_modified":1496510473,"content":"I've rewritten the whole thing in C. It was a simple matter since we no longer need the random interval algorithm. Patrick prefers that it imitates ntpd instead of trying to hide. \n\nhttps://github.com/JasonJAyalaP/sclockadj/blob/master/sclockadj.c\n\nI compiled it (gcc sclockadj) and replaced the ruby script (/usr/lib/sdwdate/sclockadj) with it. Inside sdwdate, I changed the invocation to:\n```\n        cmd = [\n            \"sudo\",\n            \"/usr/lib/sdwdate/sclockadj\",\n            str(self.newdiff_nanoseconds)]\n```\nI tested it (sudo ./sclockadj 5000000000 and sudo ./sclockadj -35253463463464634 a few times, then ./usr/bin/sdwdate) and my desktop clock jumps back and forth as expected. (Comment out the sleep(1); line for faster testing).\n\nI suspect that this will fix the hanging"},{"author":"JasonJAyalaP","date_created":1496512822,"date_modified":1496512822,"content":"@marmarek Would you be willing to review the C? It's under 75 total lines."},{"author":"marmarek","date_created":1496695456,"date_modified":1496695456,"content":"What about using adjtime() syscall instead of all this? It would avoid trashing logs with `Time has been changed` every single second, and possibly other side effects."},{"author":"marmarek","date_created":1496696060,"date_modified":1496696060,"content":"I've left you some minor comments here: https://github.com/JasonJAyalaP/sclockadj/commit/e9bf84e3a400f7a8ef01e5f00dcefc013d0a9efe"},{"author":"Patrick","date_created":1496705564,"date_modified":1496705564,"content":">>! In T650#13569, @marmarek wrote:\n> It would avoid trashing logs with `Time has been changed` every single second, and possibly other side effects.\n\nThis btw will be done in debian version 10 codename buster (stretch + 1). Still a long time and worth fixing before that.\n\n> What about using adjtime() syscall instead of all this?\n\nYes, that would be awesome!\n\nWe would like to change the time as similar to an existing popular time synchronization mechanism as possible to avoid being fingerprinted as sdwdate (therefore most likely Whonix).\n\nThere is (also)...\n\n* adjtime - http://man7.org/linux/man-pages/man3/adjtime.3.html\n* adjtimex - http://man7.org/linux/man-pages/man2/adjtimex.2.html\n* and ntp_adjtime (GNU C Library function, not dependent on NTP as far as I understand) - http://www.delorie.com/gnu/docs/glibc/libc_436.html\n\nWhich one of these (or are there even others) is best suited for this task?"},{"author":"marmarek","date_created":1496788972,"date_modified":1496788972,"content":"adjtimex/ntp_adjtime looks quite complex, but also allow precise control on how time should be adjusted. From those two, according to manual page ntp_adjtime is preferred."},{"author":"JasonJAyalaP","date_created":1496870648,"date_modified":1496870648,"content":"Do we need precise control? The only requirement (other than working) is that it imitate an existing linux tool. "},{"author":"Patrick","date_created":1496870731,"date_modified":1496870731,"content":"A popular existing linux tool."},{"author":"JasonJAyalaP","date_created":1496872937,"date_modified":1496876362,"content":"Using adjtime would be a simple matter (of programming), but only has microsecond precision.\n\nEDIT: I think it maxes out at 30 minutes too."},{"author":"Patrick","date_created":1496877744,"date_modified":1496877744,"content":"Where is adjtime being used in existing time sync applications? NTP?\nchrony? systemd-timesyncd?"},{"author":"marmarek","date_created":1496878200,"date_modified":1496878200,"content":"Looks like at least NTP and chrony use ntp_adjtime/adjtimex"},{"author":"JasonJAyalaP","date_created":1496941788,"date_modified":1496941788,"content":"OK. It might strain my limited C knowledge, but I'll give it shot."},{"author":"JasonJAyalaP","date_created":1497402879,"date_modified":1497402879,"content":"adjtimex, as far as I can tell, is for tuning the clock to stay accurate. It's not directly for setting a new time. I assume it's used by ntp to speed up and slow down the clock, with more code that checks on it and stops it when it reaches the right time. Reimplementing this is beyond my skill. \n\nFor example, if you know your machine is a little fast or a little slow, you can change the \"tick\" and \"frequency\" of the OS.\n\nI'm just not sure how to change time without spamming the logs or reimplementing ntp."},{"author":"Patrick","date_created":1497435482,"date_modified":1497435482,"content":"Please create a new ticket for porting to some better C function."}]},"PHID-TASK-3lpzeexoye2oifawicxt":{"id":"649","title":"port curl-prgrs to pipeviewer pv","status":"open","priority":"Normal","author":"Patrick","description":"Using `pv` would solve T644.\n\nWIP:\nhttps://github.com/Whonix/curl-scripts/blob/pipeviewer/usr/lib/curl-scripts/curl-prgrs\n\nNot simple, because `pv` needs to know the size beforehand, otherwise it cannot know what the progress is.","comments":[]},"PHID-TASK-ss5ebczapsqrlpv6g3lk":{"id":"648","title":"sdwdate onions checker enhancements required","status":"resolved","priority":"Normal","author":"Patrick","description":"To be able to review T647, #sdwdate's unit test needs to be improved.\n\nhttps://github.com/Whonix/sdwdate/blob/master/usr/share/sdwdate/unit_test\n\n* ~~don't fetch all onions at once (because now we have so many that the connection might not succeeded due to overloading Tor or the local internet connection)~~\n* ~~add human readable date to the output or diff to local clock (to check if they are within +/- 1 second accuracy)~~\n* ~~add url comment to output (to be able to easily verify all the proofs)~~\n* ~~rename onion tester~~\n* ~~check for duplicates~~\n* parse urls with # in url\n","comments":[{"author":"anonymous1","date_created":1489623396,"date_modified":1489623396,"content":"maybe curl and grep the addresses in comments for a quick scan of onion address?"},{"author":"JasonJAyalaP","date_created":1497405812,"date_modified":1497405812,"content":"> don't fetch all onions at once (because now we have so many that the connection might not succeeded due to overloading Tor or the local internet connection)\n\nYou want this to always be true (and not just with the test), correct? The code for that is here:\nhttps://github.com/Whonix/sdwdate/blob/master/usr/lib/python3/dist-packages/sdwdate/remote_times.py\nI don't know python well, but it appears that all processes for each url are started at the same time. \n\n> add human readable date to the output or diff to local clock (to check if they are within +/- 1 second accuracy)\nYou want the unix epoch timestamp (1470432423) to be changed everywhere or just the test? Both times or just utc? I believe the code is here:\nhttps://github.com/Whonix/sdwdate/blob/master/usr/lib/python3/dist-packages/sdwdate/remote_times.py#L59\nIf you want UTC time stamps:\n```\nimport datetime\n```\nAnd changing that line I linked to:\n```\ntime_stamp = datetime.datetime.utcfromtimestamp(int(reply.strip())).strftime('%Y-%m-%d %H:%M:%S')\nunix_times.append.time_stamp\n```\nUsing seconds is also trivial. Just tell me what you want it to look like.\n\n> add url comment to output (to be able to easily verify all the proofs)\nDoesn't the output say \"url blahablahblah.onion\" ?"},{"author":"Patrick","date_created":1497440550,"date_modified":1497440550,"content":">>! In T648#13615, @JasonJAyalaP wrote:\n>> don't fetch all onions at once (because now we have so many that the connection might not succeeded due to overloading Tor or the local internet connection)\n> \n> You want this to always be true (and not just with the test), correct? \n\nNo, not correct.\n\n> The code for that is here:\n> https://github.com/Whonix/sdwdate/blob/master/usr/lib/python3/dist-packages/sdwdate/remote_times.py\n> I don't know python well, but it appears that all processes for each url are started at the same time. \n\nThat's good as is.\n\nFetching 3 at one in sdwdate is fine.\n\nFetching 50+ at once in sdwdate unit test is a broken test.\n\nThis test is supposed to be called sdwdate onion checker.\n\n>> add human readable date to the output or diff to local clock (to check if they are within +/- 1 second accuracy)\n> You want the unix epoch timestamp (1470432423) to be changed everywhere or just the test?\n\nThe test needs to output UTC time stamps as well. Otherwise the human eye cannot parse the test.\n\n> Both times or just utc?\n\nGood question. Probably unixtime don't hurt. Good to have. Does not need too much space in the unit test output either.\n\n> Just tell me what you want it to look like.\n\nThe current output of sdwdate (when I write sdwdate singular I mean like sdwdate running on users systems) is good as is. Any improvement suggestions should go to separate tickets.\n\n>> add url comment to output (to be able to easily verify all the proofs)\n> Doesn't the output say \"url blahablahblah.onion\" ?\n\nIt shows blahablahblah.onion but it does not show the clearnet url. Should show it. Probably the only/main file to be modified:\n\nhttps://github.com/Whonix/sdwdate/blob/master/usr/share/sdwdate/unit_test\n"},{"author":"JasonJAyalaP","date_created":1497574882,"date_modified":1497574882,"content":"> Fetching 50+ at once in sdwdate unit test is a broken test.\n\nFixed. https://github.com/Whonix/sdwdate/commit/d76d95ecf8713be09ee68753c47b9529fe45a56d\nThe proper solution would be to change the get_remote method to throttle itself. But my cludge works fine for the test.\n\n>The test needs to output UTC time stamps\nDone. https://github.com/Whonix/sdwdate/commit/b52e260187829480cc8c317785ac9c6bfab10347\n\n> does not show the clearnet url. Should show it.\n\nIf I understand it right, first config.py needs to be changed to return not just the onion string, but a tuple (or two item list) with the clearnet and onion. Then remote_times.py/get_remote needs to change \"remotes[i]\" to \"remotes[i[0]]\" (or something like that) when it needs the onion address. (The remotes[i] lines that are used to display the text of the url can stay the same or maybe need to be formatted to look better)."},{"author":"Patrick","date_created":1497627061,"date_modified":1497627061,"content":"Please undo https://github.com/Whonix/sdwdate/commit/b52e260187829480cc8c317785ac9c6bfab10347. `datetime` doesn't belong there. Likely causes a python exception for invalid responses from remote servers.\n\nTo review T647 we also need to show the full url comment. But maybe it's better to have a different small script to aid/semi-automate checking that."},{"author":"JasonJAyalaP","date_created":1497642850,"date_modified":1497647472,"content":"Damnit. Sorry. I missed a closing )\n\nOh i see. There's an abort when socks returns a weird message. The response can't be formatted. Ok let me work on it.\n\nI *think* I fixed it, but it's hard to replicate the error (I've been running unit test over and over).\n\nhttps://github.com/Whonix/sdwdate/commit/cd2234332234a33a396afcb81a264124acd521ad"},{"author":"JasonJAyalaP","date_created":1497643273,"date_modified":1497646873,"content":"Added comments\n\nhttps://github.com/Whonix/sdwdate/commit/e4cfe95497110a895a8fe4555114164cb1fe96bb\n\n{F634888}"},{"author":"JasonJAyalaP","date_created":1497648280,"date_modified":1497648280,"content":"Do you want me to rename the file to \"onions_tester\" or something like that? "},{"author":"Patrick","date_created":1497653977,"date_modified":1497653977,"content":"No.\n\n(T648#13693 still applies.)"},{"author":"JasonJAyalaP","date_created":1497654899,"date_modified":1497654899,"content":"Using the newer 30_default, I found a parsing error that causes the error I was looking for.\n\nhttps://github.com/anonmos1/sdwdate/blob/94c3ff5e5cdd7393501d3ddb7ce9905400dd92d9/etc/sdwdate.d/30_default.conf#L73\n\nThe comment has a # in it (because the url is using a #), which makes sdwdate think it's part of the url.\n\nNow properly handled by the tester:\nhttps://github.com/Whonix/sdwdate/blob/master/usr/lib/python3/dist-packages/sdwdate/remote_times.py#L60\n "},{"author":"anonymous1","date_created":1497765460,"date_modified":1497765740,"content":"The list should be checked for duplicate addresses too\n\nThere were 2 duplicates in the current list:\n\nw6csjytbrl273che.onion#Ljost\nw6csjytbrl273che.onion#Filtrala\n\n5r4bjnjug3apqdii.onion#Irpileaks\n5r4bjnjug3apqdii.onion#ExpoLeaks"},{"author":"JasonJAyalaP","date_created":1497926694,"date_modified":1497926694,"content":"> +/- difference\n\nhttps://github.com/Whonix/sdwdate/commit/e04099d76af709900983d09e7097809846d86603\n\n> onion_tester\n\nhttps://github.com/Whonix/sdwdate/commit/f099c069e12618422622d49a5a7ba05f9959e91d\n\n> The comment has a # in it (because the url is using a #), which makes sdwdate think it's part of the url.\n\nI need your experience here, Patrick. The problem appears to be with your regex here:\nhttps://github.com/Whonix/sdwdate/blob/master/usr/lib/python3/dist-packages/sdwdate/config.py#L31\nI think you're including everything on the line up to the last first #. Instead, search from the the end (^ i think) to the first # encountered\n\n> The list should be checked for duplicate addresses too\nDone.\n"},{"author":"JasonJAyalaP","date_created":1497933806,"date_modified":1497933864,"content":"At the end of onion_tester, it will report all errors (duplicates, timeouts, bad responses):\nhttps://github.com/Whonix/sdwdate/commit/cad2c1b7d1b5476a55619865b4f25bb588875a2e#diff-e68acbfa3dee096d2c84e3cfe6773f30R59"},{"author":"JasonJAyalaP","date_created":1497936062,"date_modified":1497936090,"content":"> I think you're including everything on the line up to the last first #. Instead, search from the the end (^ i think) to the first # encountered\n\nNo. From end of the line to the *last* # encountered.\n\nOr we can just manually remove all #s from comments.  In that case, I think you (Patrick) can close this ticket. They *might* be necessary in some onion urls, but not in any we've used so far (i think)."},{"author":"Patrick","date_created":1498129324,"date_modified":1498129324,"content":"Please undo modifications to `remote_times.py`. It doesn't belong there. And some input values could lead to python exceptions (think: malicious servers).\n\nThe full parsing of `get_time_from_servers` happens in `check_remote`.\n\nhttps://github.com/Whonix/sdwdate/blob/ca3ffa3d8559bcfaf35f5d294bd933cea20ecaef/usr/bin/sdwdate#L130-L215\n\nIt should not be done in `remote_times.py` because the full checking is done in `check_remote` so it can be properly logged in live sdwdate on user's machines.\n\nAlso linguistically / clean code wise `get_time_from_servers` should not do checking for remote server replies.\n\nThe `try` / `except` is crucial, otherwise python exceptions could happen (which might crash sdwdate or at least that iteration without any useful log output, which then is a nightmare with incoming bug reports).\n\nPerhaps `check_remote` has to be refactored / moved elsewhere so it can be reused from the unit test.\n\nThe problem is, we don't have unit testing yet. One needed unit test would be feeding sdwdate with replies from very bad servers. Or at least simulate that by feeding the functions in question with these values. Things such as excessive string length, spaces, special characters, very small numbers, astronomically big numbers and so forth. These tests were done manually by me in past. So until we have unit testing coverage I don't want to mess with `remote_times.py` in major ways (such as doing the checking there) because it could lead to python exceptions.\n"},{"author":"Patrick","date_created":1498130001,"date_modified":1498130001,"content":"Currently the pool syntax is simple:\n\n```\n\"url.onion[:port]#comment\"\n```\n\nOr for grouped ones:\n\n```\n[\n\"url.onion[:port]#comment\"\n\"[url.onion[:port]#comment]\"\n\"[url.onion[:port]#comment]\"\n[...]\n]\n```\n\nSo currently we are using the first `#` we encounter in a line a the separator of the `url.onion:port` from the url comment. So you could python `split()` with split char `#` and then use the first item of the resulting list. Then assign all but the first item as comment."},{"author":"Patrick","date_created":1498130240,"date_modified":1498130240,"content":"There is a syntax error. `if error` -> `if error:`."},{"author":"Patrick","date_created":1498130981,"date_modified":1498130981,"content":"sdwdate in current git master as of `e9733e1d0f0257c4e2ddab05fd16f856419ecfb1` is broken. sdwdate no longer sets the time because `check_remote` always thinks the remote is `False`."},{"author":"JasonJAyalaP","date_created":1498149941,"date_modified":1498149941,"content":"> Please undo modifications to `remote_times.py`. It doesn't belong there. \n\nWait. The extra message info doesn't belong there?\n\n\n```\ntimestamp = int(msg)\nnow       = int(time.time())\ndiff      = timestamp - now\ndate      = datetime.datetime.utcfromtimestamp(timestamp).strftime('%Y-%m-%d %H:%M:%S')\noutput = date + \" / \" + str(timestamp) + \" difference: \" + str(diff)\n```\n\nAnd when do we check time.now to compare it to the received time? Seconds later in another function?\n\n> And some input values could lead to python exceptions (think: malicious servers).\n> The full parsing of `get_time_from_servers` happens in `check_remote`.\n\n> check_remote always thinks the remote is False.\n\nBecause it only expects the server response without my wonderfully formatted output.\n\nI have to at least return (remote_timestamp, now_timestamp) from get_time_from_servers unless you want the diff to be always wrong by some small amount.  \n\n```\nif self.check_remote(self.urls[i], self.returned_values[i], self.get_comment(self.urls[i]), i): \n```\n\nwould be something like\n\n```\n if self.check_remote(self.urls[i], self.returned_values[i[0]], self.get_comment(self.urls[i]), i): \n```\n\nAnd the output formatting has to happen somewhere else.\n \n> Perhaps `check_remote` has to be refactored / moved elsewhere so it can be reused from the unit test.\n\nI think it can work as it is. We just need to pass an accurate time.now through it, and copy+paste my formatting somewhere else.\n\nIs my formatting only needed in unit test? Then I can put it there.\n\n> There is a syntax error. if error -> if error:.\nUgh. I have problems getting my setup right. Still fooling around with seamless filetransfer between my gateway test and my dev machine.\n\n\n> The problem is, we don't have unit testing yet.\n\nI'd love to implement this and a whole lot more. I'd like to do some major refactoring of sdwdate. Right now we're passing around separate lists and reconstructing them as needed, hoping they're in sync. It's a large bash script. If we asked someone to audit it, they'd kick me in the nuts. We need objects and data structures that model (native to python) what we're working with. Maybe we can do this next time I'm in the EU? We'll worry about it later. Just dreaming."},{"author":"JasonJAyalaP","date_created":1498341091,"date_modified":1498341091,"content":"Ok. Everything fixed. Onion_checker diff time will be off by a number of sections, but good enough for now. All the enhancements are there."}]},"PHID-TASK-t4psmgwnbvaxa573ziis":{"id":"647","title":"review sdwdate pool member revamp by anonymous1","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/sdwdate/pull/19\n\ndiscussion:\nhttps://forums.whonix.org/t/suggest-trustworthy-tor-hidden-services-as-time-sources-for-sdwdate","comments":[{"author":"JasonJAyalaP","date_created":1496514069,"date_modified":1496514069,"content":"What are the criteria for reviewing?\n\nIt seems like adding/remove time sources is a huge manual headache. Is there a way to automate this?"},{"author":"Patrick","date_created":1496667271,"date_modified":1496667271,"content":">>! In T647#13502, @JasonJAyalaP wrote:\n> What are the criteria for reviewing?\n\n* Make sure the proof url mentions the onion (context!).\n* Make sure the onion is even working.\n* Make sure the onion is +/- 2 seconds correct.\n* Make sure only onions / proofs of onions submitted confirmed by @HulaHoop in https://forums.whonix.org/t/suggest-trustworthy-tor-hidden-services-as-time-sources-for-sdwdate or by me in https://github.com/Whonix/sdwdate/pull/19 discussion are added.\n\nNewer discussion if we want specific onions at all is done in: https://forums.whonix.org/t/suggest-trustworthy-tor-hidden-services-as-time-sources-for-sdwdate. (I guess work by @anonymous1 is all fine, but we ought to audit it.)\n\n> It seems like adding/remove time sources is a huge manual headache. Is there a way to automate this?\n\nYes, partially.\n\n(See this ticket's `Blocked By`.\nT648 sdwdate onions checker enhancements required )\n"},{"author":"anonymous1","date_created":1496696214,"date_modified":1496698112,"content":"To help with the 4th criteria,\n\nIf I remember correctly, I didn't ask when adding xmr.to's address, it is a trusted service by the Monero community\n\nI didn't ask c4ss.org's address as well\n\nPatrick said no for pgpkeys.urown.net (http://forums.kkkkkkkkkk63ava6.onion/t/suggest-trustworthy-tor-hidden-services-as-time-sources-for-sdwdate/856/65), which was part of a list, perhaps it was a mistake or he didn't see it fit as a standalone addition, I still included it as part of sks-keyservers list\n\nFrom the same post, Patrick said \"No. (clearnet domain broken)\" for pgp.ohai.su, but I added it to sks-keyservers list because it works for me?\n\nI didn't ask when adding securedrop-globaleaks addresses"},{"author":"JasonJAyalaP","date_created":1497407534,"date_modified":1497407534,"content":"The process is confusing to me right now. We pull the new file and run sdwdate unit test and see which ones fail and check which ones are new and which ones are old... or remove all failing result?\n\nThe workflow could be something like...\n1) People suggest an onion, with necessary details ( in a gist or some online text file ?)\n2) Patrick or whoever quickly rejects or accepts\n3) Automatic checker is feed the text file, does a check on the times, and outputs which ones work or don't\n\nBut even that is not so great. We need a program that maintains a database of servers. It checks it every-so-often, records how many failures and successes, and can be asked to output a list of working servers.\n\n"},{"author":"Patrick","date_created":1497440102,"date_modified":1497440102,"content":"Your questions are more part of T648.\n\n>>! In T647#13617, @JasonJAyalaP wrote:\n> The process is confusing to me right now. We pull the new file and run sdwdate unit test and see which ones fail and check which ones are new and which ones are old... or remove all failing result?\n\n> The workflow could be something like...\n> 1) People suggest an onion, with necessary details ( in a gist or some online text file ?)\n\nsuggest here:\n\nhttps://forums.whonix.org/t/suggest-trustworthy-tor-hidden-services-as-time-sources-for-sdwdate\n\n> 2) Patrick or whoever quickly rejects or accepts\n\nCurrently assigned to @HulaHoop.\n\n> 3) Automatic checker is feed the text file,\n\nNo, it's feed sdwdate's config.\n\n> does a check on the times, and outputs which ones work or don't\n\nYes.\n\n> But even that is not so great. We need a program that maintains a database of servers. It checks it every-so-often, records how many failures and successes, and can be asked to output a list of working servers.\n\nWe manually run the unit test T648 before each release.\n\n-----\n\nThis very task T647:\n\nSee comment T647#13538... Most importantly:\n\n* Make sure the proof url mentions the onion (context!).\n* Make sure only onions / proofs of onions submitted confirmed by @HulaHoop in https://forums.whonix.org/t/suggest-trustworthy-tor-hidden-services-as-time-sources-for-sdwdate or by me in https://github.com/Whonix/sdwdate/pull/19 discussion are added.\n\nEverything else will be sorted out in T648 anyhow. T648 needs to be implemented first."},{"author":"JasonJAyalaP","date_created":1497649015,"date_modified":1497649015,"content":"Can I simply download the changes to 30_default.conf\nhttps://github.com/anonmos1/sdwdate/blob/94c3ff5e5cdd7393501d3ddb7ce9905400dd92d9/etc/sdwdate.d/30_default.conf\n\nrun the tester and make sure nothing is consistently timing out? Or is there more to it?"},{"author":"Patrick","date_created":1497654854,"date_modified":1497654854,"content":">>! In T647#13737, @JasonJAyalaP wrote:\n> Can I simply download the changes to 30_default.conf\n> https://github.com/anonmos1/sdwdate/blob/94c3ff5e5cdd7393501d3ddb7ce9905400dd92d9/etc/sdwdate.d/30_default.conf\n\nMerge https://github.com/Whonix/sdwdate/pull/19 locally.\n\n> run the tester and make sure nothing is consistently timing out?\n\nYes. The onion_tester (yes, that name is better after all) should also show the diff. I.e. the onion tester should also show +/- seconds diff. (To make it easier to see which ones are off too much.)\n\n> Or is there more to it?\n\nAs explained above."},{"author":"JasonJAyalaP","date_created":1497935733,"date_modified":1497935880,"content":"10 timeouts and a parsing error with pull/19's 30 default (https://github.com/anonmos1/sdwdate/blob/94c3ff5e5cdd7393501d3ddb7ce9905400dd92d9/etc/sdwdate.d/30_default.conf)\n\n{F635290}\n\nover a minute diff:\npad.riseup.net slow by 295 seconds\njoindisaspora ahead by 177\ndebdeltas ahead by 130\n\nabout the parsing error: just remove the two #'s from the comment to fix for now"},{"author":"joysn1980","date_created":1501335698,"date_modified":1501339224,"content":"Please review\nhttps://github.com/joysn/sdwdate/commit/16aedea1a9c93fffb35fe8e5716ff6ad866bc634#diff-289c8954e7cc8349c7632e4ace0564ec\n\nand merge\n\n[Please ignore my earlier review\nhttps://github.com/joysn/sdwdate/commit/f0af0a3a700633c170926d75370d152034335053#diff-289c8954e7cc8349c7632e4ace0564ec]\n\n\nAll new onions are added courtesy -   anonymous1\nAll onions were approved by Patrick in his response\n\n################\nChanges Made\n################\nDeleted Due to Host unreachable\nPool 1\n\n```\nll6edwtpfl3zdwoi.onion\npubdrop4dw6rk3aq.onion\ngawker5oxtsc6fa7.onion\n```\n\nPool 2\n\n```\natlas777hhh7mcs7.onion\ncompass6vpxj32p3.onion\nglobe223ezvh6bps.onion\nacabtd4btrxjjrvr.onion\n```\n\nPool 3\n\n```\ndju2peblv7upfz3q.onion\nuj3wazyk5u4hnvtk.onion\ncwoiopiifrlzcuos.onion\nlibraryxobbrbj33.onion\ntoristinkirir4xj.onion\ntgnv2pssfumdedyw.onion\nzdfsyv3rubuhpql3.onion\nsgvtcaew4bxjd7ln.onion\n```\n\nDeleted due to Huge Time difference\nPool 2\n\n```\nw6csjytbrl273che.onion\nppdz5djzpo3w5k2z.onion\nw6csjytbrl273che.onion\n```\nPool 3\n\n```\nmsydqstlz2kzerdg.onion\nbitmailendavkbec.onion\n```\n\nAfter Deletion and Addition of new URLs\nAvg of Pool :1 having URLs #:24 is 2\nAvg of Pool :2 having URLs #:20 is 1\nAvg of Pool :3 having URLs #:75 is 2\n\nThere are still some issues with some onions in Pool 3 (where the time difference sometimes crosses +/-5. We can relook at the pool 3 after some time again.\n\nbefore modifications Avg was quite bad\nAvg of Pool 1 is in the range of 5-10\nAvg of Pool 2 is in the range of -91 to 78\nAvg of Pool 3 is 5- 9"},{"author":"joysn1980","date_created":1501335913,"date_modified":1501339142,"content":"Output of Modified unit_test which picks up set of 3 urls at a time, finds the difference, calculates the avg of difference too.\n\n>user@host:~$ python /usr/share/sdwdate/unit_test1\n>Current Time: 1501337975\n>Starting remotes check...\n>Testing the URL Chunk: \n>['znig4bc5rlwyj4mz.onion', 'y6xjgkgwj47us5ca.onion', 'strngbxhwyuu37a3.onion']\n>pool 1 url znig4bc5rlwyj4mz.onion: Time: 1501337982 Difference: -1\n>pool 1 url y6xjgkgwj47us5ca.onion: Time: 1501337981 Difference: 0\n>pool 1 url strngbxhwyuu37a3.onion: Time: 1501337982 Difference: -1\n>Testing the URL Chunk: \n>['nrktipspgpsyoqwo.onion', 'dqeasamlf3jld2kz.onion', 'v6gdwmm7ed4oifvd.onion']\n>pool 1 url nrktipspgpsyoqwo.onion: Time: 1501337986 Difference: 3\n>pool 1 url dqeasamlf3jld2kz.onion: Time: 1501337984 Difference: 5\n>pool 1 url v6gdwmm7ed4oifvd.onion: Time: 1501337989 Difference: 0\n>Testing the URL Chunk: \n>['vbmwh445kf3fs2v4.onion', 'poulsensqiv6ocq4.onion', 'tigas3l7uusztiqu.onion']\n>pool 1 url vbmwh445kf3fs2v4.onion: Time: 1501337996 Difference: -1\n>pool 1 url poulsensqiv6ocq4.onion: Time: 1501337993 Difference: 2\n>pool 1 url tigas3l7uusztiqu.onion: Time: 1501337994 Difference: 1\n>Testing the URL Chunk: \n>['n572ltkg4nld3bsz.onion', 'udrciweihl4qe63p.onion', 'dashorg64cjvj4s3.onion']\n>pool 1 url n572ltkg4nld3bsz.onion: Time: 1501337999 Difference: 3\n>pool 1 url udrciweihl4qe63p.onion: Time: 1501338000 Difference: 2\n>pool 1 url dashorg64cjvj4s3.onion: Time: 1501338003 Difference: -1\n>Testing the URL Chunk: \n>['coinpaymtstgtibr.onion', 'bptfp7py2wclht26.onion', '2h3xkc7wmxthijqb.onion']\n>pool 1 url coinpaymtstgtibr.onion: Time: 1501338009 Difference: 0\n>pool 1 url bptfp7py2wclht26.onion: Time: 1501338010 Difference: -1\n>pool 1 url 2h3xkc7wmxthijqb.onion: Time: 1501338011 Difference: -2\n>Testing the URL Chunk: \n>['qcdbc7vspedojrr7.onion', 'mprt35sjunnxfa76.onion', '6zwctlqtpilbkl47.onion']\n>pool 1 url qcdbc7vspedojrr7.onion: Time: 1501338018 Difference: 1\n>pool 1 url mprt35sjunnxfa76.onion: Time: 1501338016 Difference: 3\n>pool 1 url 6zwctlqtpilbkl47.onion: Time: 1501338020 Difference: -1\n>Testing the URL Chunk: \n>['bylu6d6nx3og7shy.onion', 'n3txnhg64swyjlty.onion', 'wi7qkxyrdpu5cmvr.onion']\n>pool 1 url bylu6d6nx3og7shy.onion: Timeout (Curl --head is OK)\n>pool 1 url n3txnhg64swyjlty.onion: Time: 1501338025 Difference: 9\n>pool 1 url wi7qkxyrdpu5cmvr.onion: Time: 1501338027 Difference: 7\n>Testing the URL Chunk: \n>['clgs64523yi2bkhz.onion', 'privacyintyqcroe.onion', 'wlupld3ptjvsgwqw.onion']\n>pool 1 url clgs64523yi2bkhz.onion: Time: 1501338042 Difference: 0\n>pool 1 url privacyintyqcroe.onion: Time: 1501338042 Difference: 0\n>pool 1 url wlupld3ptjvsgwqw.onion: Time: 1501338036 Difference: 6\n>##############################\n>Avg of Pool :1 having URLs #:24 is 2\n>##############################\n>Testing the URL Chunk: \n>['ak2uqfavwgmjrvtu.onion', '5r4bjnjug3apqdii.onion', '5r4bjnjug3apqdii.onion']\n>pool 2 url ak2uqfavwgmjrvtu.onion: Time: 1501338047 Difference: -1\n>pool 2 url 5r4bjnjug3apqdii.onion: Time: 1501338045 Difference: 1\n>pool 2 url 5r4bjnjug3apqdii.onion: Time: 1501338046 Difference: 0\n>Testing the URL Chunk: \n>['fkut2p37apcg6l7f.onion', 'bqs3dobnazs7h4u4.onion', 'bitlox2twvzwbzpk.onion']\n>pool 2 url fkut2p37apcg6l7f.onion: Time: 1501338049 Difference: 6\n>pool 2 url bqs3dobnazs7h4u4.onion: Time: 1501338055 Difference: 0\n>pool 2 url bitlox2twvzwbzpk.onion: Time: 1501338053 Difference: 2\n>Testing the URL Chunk: \n>['obrrsrw6b3rjuibx.onion', 'nfkrkvghv75xsf26.onion', 'tsc64wi45alh6rkq.onion']\n>pool 2 url obrrsrw6b3rjuibx.onion: Time: 1501338064 Difference: -1\n>pool 2 url nfkrkvghv75xsf26.onion: Time: 1501338062 Difference: 1\n>pool 2 url tsc64wi45alh6rkq.onion: Time: 1501338062 Difference: 1\n>Testing the URL Chunk: \n>['wooprzddebtxfhnq.onion', 'xogxzfyhwmgfvmlr.onion', '47hbff4rtpwfpwlr.onion']\n>pool 2 url wooprzddebtxfhnq.onion: Time: 1501338072 Difference: -1\n>pool 2 url xogxzfyhwmgfvmlr.onion: Time: 1501338070 Difference: 1\n>pool 2 url 47hbff4rtpwfpwlr.onion: Time: 1501338071 Difference: 0\n>Testing the URL Chunk: \n>['kbbqa63mo7cchzut.onion', 'ai3dvhjytrgice5h.onion', 'nhzgrlwhukwtajz4.onion']\n>pool 2 url kbbqa63mo7cchzut.onion: Time: 1501338077 Difference: 5\n>pool 2 url ai3dvhjytrgice5h.onion: Time: 1501338079 Difference: 3\n>pool 2 url nhzgrlwhukwtajz4.onion: Time: 1501338082 Difference: 0\n>Testing the URL Chunk: \n>['diasporaaqmjixh5.onion', 'fd6dqrupy3af4xwb.onion', 'crypty22ijtotell.onion']\n>pool 2 url diasporaaqmjixh5.onion: Time: 1501338087 Difference: 1\n>pool 2 url fd6dqrupy3af4xwb.onion: Time: 1501338089 Difference: -1\n>pool 2 url crypty22ijtotell.onion: Time: 1501338089 Difference: -1\n>Testing the URL Chunk: \n>['cryjabkbdljzohnp.onion', 'deepdot35wvmeyd5.onion']\n>pool 2 url cryjabkbdljzohnp.onion: Time: 1501338094 Difference: 5\n>pool 2 url deepdot35wvmeyd5.onion: Time: 1501338094 Difference:5\n>##############################\n>Avg of Pool :2 having URLs #:20 is 1\n>##############################\n>Testing the URL Chunk: \n>['3g2upl4pq6kufc4m.onion', 'wi7qkxyrdpu5cmvr.onion', 'ic6au7wa3f6naxjq.onion']\n>pool 3 url 3g2upl4pq6kufc4m.onion: Time: 1501338114 Difference: -1\n>pool 3 url wi7qkxyrdpu5cmvr.onion: Time: 1501338111 Difference: 2\n>pool 3 url ic6au7wa3f6naxjq.onion: Time: 1501338112 Difference: 1\n>Testing the URL Chunk: \n>['zcashph5mxqjjby2.onion', 'archivecrfip2lpi.onion', 'nzh3fv6jc6jskki3.onion']\n>pool 3 url zcashph5mxqjjby2.onion: Time: 1501338119 Difference: 1\n>pool 3 url archivecrfip2lpi.onion: Time: 1501338095 Difference: 5\n>pool 3 url nzh3fv6jc6jskki3.onion: Time: 1501338120 Difference: 0\n>Testing the URL Chunk: \n>['xpgylzydxykgdqyg.onion', '5jp7xtmox6jyoqd5.onion', 'j6uhdvbhz74oefxf.onion']\n>pool 3 url xpgylzydxykgdqyg.onion: Time: 1501338124 Difference: 1\n>pool 3 url 5jp7xtmox6jyoqd5.onion: Time: 1501338125 Difference: 0\n>pool 3 url j6uhdvbhz74oefxf.onion: Time: 1501338126 Difference: -1\n>Testing the URL Chunk: \n>['7lvd7fa5yfbdqaii.onion', 'timaq4ygg2iegci7.onion', 'fncuwbiisyh6ak3i.onion']\n>pool 3 url 7lvd7fa5yfbdqaii.onion: Time: 1501338131 Difference: -1\n>pool 3 url timaq4ygg2iegci7.onion: Time: 1501338130 Difference: 0\n>pool 3 url fncuwbiisyh6ak3i.onion: Time: 1501338130 Difference: 0\n>Testing the URL Chunk: \n>['wlchatc3pjwpli5r.onion', 'qubesosmamapaxpa.onion', 'intelexi7yo7mj7j.onion']\n>pool 3 url wlchatc3pjwpli5r.onion: Time: 1501338135 Difference: 0\n>pool 3 url qubesosmamapaxpa.onion: Time: 1501338135 Difference: 0\n>pool 3 url intelexi7yo7mj7j.onion: Time: 1501338134 Difference: 1\n>Testing the URL Chunk: \n>['earthqfvaeuv5bla.onion', 'j7652k4sod2azfu6.onion', 'infotombjhy7tcrg.onion']\n>pool 3 url earthqfvaeuv5bla.onion: Time: 1501338135 Difference: 4\n>pool 3 url j7652k4sod2azfu6.onion: Time: 1501338134 Difference: 6\n>pool 3 url infotombjhy7tcrg.onion:  Time: 1501338134 Difference: 6\n>Testing the URL Chunk: \n>['cheettyiapsyciew.onion', '52g5y5karruvc7bz.onion', 'x3nelbld33llasqv.onion']\n>pool 3 url cheettyiapsyciew.onion: Time: 1501338161 Difference: 0\n>pool 3 url 52g5y5karruvc7bz.onion: Time: 1501338157 Difference: 3\n>pool 3 url x3nelbld33llasqv.onion: Time: 1501338157 Difference: 3\n>Testing the URL Chunk: \n>['z5tfsnikzulwicxs.onion', 'icxe4yp32mq6gm6n.onion', 'qigcb4g4xxbh5ho6.onion']\n>pool 3 url z5tfsnikzulwicxs.onion: Time: 1501338165 Difference: 1\n>pool 3 url icxe4yp32mq6gm6n.onion: Time: 1501338166 Difference: 0\n>pool 3 url qigcb4g4xxbh5ho6.onion: Time: 1501338164 Difference: 2\n>Testing the URL Chunk: \n>['sdscoq7snqtznauu.onion', 'rqef5a5mebgq46y5.onion', 'klbl4glo2btuwyok.onion']\n>pool 3 url sdscoq7snqtznauu.onion: Time: 1501338170 Difference: -1\n>pool 3 url rqef5a5mebgq46y5.onion: Time: 1501338170 Difference: -1\n>pool 3 url klbl4glo2btuwyok.onion: Time: 1501338170 Difference: -1\n>Testing the URL Chunk: \n>['tngjm3owsslo3wgo.onion', '54nujbl4qohb5qdp.onion', 'ebxqgaz3dwywcoxl.onion']\n>pool 3 url tngjm3owsslo3wgo.onion: Time: 1501338174 Difference: 1\n>pool 3 url 54nujbl4qohb5qdp.onion: Time: 1501338173 Difference: 2\n>pool 3 url ebxqgaz3dwywcoxl.onion: Time: 1501338176 Difference: -1\n>Testing the URL Chunk: \n>['yz7lpwfhhzcdyc5y.onion', 'fqnqc7zix2wblwex.onion', 'wcgqzqyfi7a6iu62.onion']\n>pool 3 url yz7lpwfhhzcdyc5y.onion: Time: 1501338180 Difference: 4\n>pool 3 url fqnqc7zix2wblwex.onion: Time: 1501338179 Difference: 5\n>pool 3 url wcgqzqyfi7a6iu62.onion: Time: 1501338187 Difference: -1\n>Testing the URL Chunk: \n>['vt5hknv6sblkgf22.onion', 'dgvdmophvhunawds.onion', 'gbinixxw7gnsh5jr.onion']\n>pool 3 url vt5hknv6sblkgf22.onion: Time: 1501338192 Difference: -1\n>pool 3 url dgvdmophvhunawds.onion: Time: 1501338191 Difference: 0\n>pool 3 url gbinixxw7gnsh5jr.onion: Time: 1501338192 Difference: -1\n>Testing the URL Chunk: \n>['krkzagd5yo4bvypt.onion', 'hzmun3rnnxjhkyhg.onion', 'expyuzz4wqqyqhjn.onion']\n>pool 3 url krkzagd5yo4bvypt.onion: Time: 1501338197 Difference: 0\n>pool 3 url hzmun3rnnxjhkyhg.onion: Time: 1501338198 Difference: -1\n>pool 3 url expyuzz4wqqyqhjn.onion: Time: 1501338195 Difference: 2\n>Testing the URL Chunk: \n>['b5tearqs4v4nvbup.onion', '5j7saze5byfqccf3.onion', '6f6ejaiiixypfqaf.onion']\n>pool 3 url b5tearqs4v4nvbup.onion: Time: 1501338203 Difference: 2\n>pool 3 url 5j7saze5byfqccf3.onion: Time: 1501338205 Difference: 0\n>pool 3 url 6f6ejaiiixypfqaf.onion: Time: 1501338202 Difference: 3\n>Testing the URL Chunk: \n>['4ypuji3wwrg5zoxm.onion', 'bcwpy5wca456u7tz.onion', 'f6syxyjdgzbeacry.onion']\n>pool 3 url 4ypuji3wwrg5zoxm.onion: Time: 1501338210 Difference: 4\n>pool 3 url bcwpy5wca456u7tz.onion: Time: 1501338210 Difference: 4\n>pool 3 url f6syxyjdgzbeacry.onion: Time: 1501338211 Difference: 3\n>Testing the URL Chunk: \n>['ammd7ytxcpeavif2.onion', 'ynr7muu3263jikep.onion', '4do6yq4iwstidagh.onion']\n>pool 3 url ammd7ytxcpeavif2.onion: Time: 1501338222 Difference: 5\n>pool 3 url ynr7muu3263jikep.onion: Time: 1501338222 Difference: 5\n>pool 3 url 4do6yq4iwstidagh.onion: : Time: 1501338220 Difference: 3\n>Testing the URL Chunk: \n>['ugw3zjsayleoamaz.onion', 'eeblrw5eh2is36az.onion', '3m2tlhjsoxws2akz.onion']\n>pool 3 url ugw3zjsayleoamaz.onion: Timeout (Curl --head is OK)\n>pool 3 url eeblrw5eh2is36az.onion: Time: 1501338240 Difference: 4\n>pool 3 url 3m2tlhjsoxws2akz.onion: Time: 1501338241 Difference: 3\n>Testing the URL Chunk: \n>['gmi5gld3uk5ozvrv.onion', '465rf3c2oskkqc24.onion', 'vral2uljb3ndhhxr.onion']\n>pool 3 url gmi5gld3uk5ozvrv.onion: Time: 1501338252 Difference: 2\n>pool 3 url 465rf3c2oskkqc24.onion: Time: 1501338252 Difference: 2\n>pool 3 url vral2uljb3ndhhxr.onion: Time: 1501338255 Difference: -1\n>Testing the URL Chunk: \n>['ktqxbqrhg5ai2c7f.onion', 'f7bphdxlqca3sevt.onion', 'nwvk3svshonwqfjs.onion']\n>pool 3 url ktqxbqrhg5ai2c7f.onion: Time: 1501338259 Difference: 3\n>pool 3 url f7bphdxlqca3sevt.onion: Time: 1501338258 Difference: 4\n>pool 3 url nwvk3svshonwqfjs.onion: Time: 1501338263 Difference: -1\n>Testing the URL Chunk: \n>['ythg247lqkx2gpgx.onion', 'vwakviie2ienjx6t.onion', 'nbybwh4atabu6xq3.onion']\n>pool 3 url ythg247lqkx2gpgx.onion: Time: 1501338268 Difference: 0\n>pool 3 url vwakviie2ienjx6t.onion: Time: 1501338266 Difference: 2\n>pool 3 url nbybwh4atabu6xq3.onion: Time: 1501338269 Difference: -1\n>Testing the URL Chunk: \n>['oscbw3h7wrfxqi4m.onion', 'vyrxto4jsgoxvilf.onion', 'ohusanrieoxsxlmh.onion']\n>pool 3 url oscbw3h7wrfxqi4m.onion: Time: 1501338275 Difference: 2\n>pool 3 url vyrxto4jsgoxvilf.onion: Time: 1501338278 Difference: -1\n>pool 3 url ohusanrieoxsxlmh.onion: Time: 1501338275 Difference: 2\n>Testing the URL Chunk: \n>['cmgvqnxjoiqthvrc.onion', 'tpez4zz5a4civ6ew.onion', 'fkbjngvraoici6k7.onion']\n>pool 3 url cmgvqnxjoiqthvrc.onion: Time: 1501338281 Difference: 3\n>pool 3 url tpez4zz5a4civ6ew.onion: Time: 1501338285 Difference: -1\n>pool 3 url fkbjngvraoici6k7.onion: Time: 1501338283 Difference: 1\n>Testing the URL Chunk: \n>['tz4732fxpkehod36.onion', '5nca3wxl33tzlzj5.onion', 'gnvweaoe2xzjqldu.onion']\n>pool 3 url tz4732fxpkehod36.onion: Time: 1501338289 Difference: 0\n>pool 3 url 5nca3wxl33tzlzj5.onion: Time: 1501338290 Difference: -1\n>pool 3 url gnvweaoe2xzjqldu.onion: Time: 1501338289 Difference: 0\n>Testing the URL Chunk: \n>['6nvqpgx7bih375fx.onion', 'ynvs3km32u33agwq.onion', 'qqvyib4j3fz66nuc.onion']\n>pool 3 url 6nvqpgx7bih375fx.onion: Time: 1501338293 Difference: 2\n>pool 3 url ynvs3km32u33agwq.onion: Time: 1501338295 Difference: 0\n>pool 3 url qqvyib4j3fz66nuc.onion: Time: 1501338293 Difference: 2\n>Testing the URL Chunk: \n>['gl3n4wtekbfaubye.onion', 'sejnfjrq6szgca7v.onion', 'lljrzrimek6if67j.onion']\n>pool 3 url gl3n4wtekbfaubye.onion: Time: 1501338300 Difference: 3\n>pool 3 url sejnfjrq6szgca7v.onion: Time: 1501338303 Difference: 0\n>pool 3 url lljrzrimek6if67j.onion: Time: 1501338299 Difference: 4\n>##############################\n>Avg of Pool :3 having URLs #:75 is 2\n>##############################\n>user@host:~$ \n>\n\n"},{"author":"Patrick","date_created":1501365923,"date_modified":1501365923,"content":"Merged.\n\nCould you please add the url comments?\n\nhttps://github.com/Whonix/sdwdate/blob/master/etc/sdwdate.d/30_default.conf#L69-L72"},{"author":"Patrick","date_created":1501366649,"date_modified":1501366649,"content":"Looks like some slipped through somehow?\n\nFor example `jxm5d6emw5rknovg`.\n\n* Confirmed in https://github.com/Whonix/sdwdate/pull/19#issuecomment-285526492. \n* Part of https://github.com/Whonix/sdwdate/pull/19/files.\n* Not accounted for in T647#14247.\n\nSame for `subgraphqov3womk`.\n\nOr `xmrto2bturnore26` which was confirmed here https://forums.whonix.org/t/suggest-trustworthy-tor-hidden-services-as-time-sources-for-sdwdate/856/65.\n\nAnd probably others."},{"author":"joysn1980","date_created":1501388071,"date_modified":1501388071,"content":"Many of these didn't work for me so did not add then, EXAMPLE\n> jxm5d6emw5rknovg.onion - out of 6 times 4 times I got a timeout\n>yuxv6qujajqvmypv.onion: Timeout (Curl --head also Not OK)\n>u75jkrt3umu2c7pn.onion: Timeout (Curl --head also Not OK)\n>qssio5fppcrojdh3.onion: Timeout (Curl --head also Not OK)\n\nAdded few more urls and comments\nhttps://github.com/joysn/sdwdate/commit/4effb43c54874b5968dd59da89632bea1b598786#diff-289c8954e7cc8349c7632e4ace0564ec\n\nAdded other files from the https://github.com/Whonix/sdwdate/pull/19/files\nhttps://github.com/joysn/sdwdate/commit/8b70a2e0eabcc5bdaf9277259bdba368d401ab30#diff-04c6e90faac2675aa89e2176d2eec7d8\n\n\n\n\n"},{"author":"joysn1980","date_created":1501390773,"date_modified":1501390773,"content":"Couple of more onions added (Suggested by anonymous1 and approved by Hulahoop\n         \"nxhhwbbxc4khvvlw.onion#https://seacrX.fossencdi.org\"\n         \"searx.cwuzdtzlubq5uual.onion#https://searx.fossencdi.org\"\n\n> lqdnwwwmaouokzmg.onion: Timeout \nIs not working.\n\nhttps://github.com/joysn/sdwdate/commit/c06ffea318db1e9b66b361653e343fb98cc6054f#diff-289c8954e7cc8349c7632e4ace0564ec"},{"author":"Patrick","date_created":1501431873,"date_modified":1501431873,"content":"There is still a big diff.\n\n    git diff anonmos1/patch-1 etc/sdwdate.d/30_default.conf\n\nCould you please also cleanup the `##` comments?\n\nThe sources like  `##    SecureDrop List` is probably worth keeping?\n\nStuff like\n\n```\n##       info:\n##          Last updated Thu Oct 23 16:15:00 PDT 2014\n```\n\nand lists like\n\n> `##       removed because down:`\n\n> `##       removed due to incorrect time:`\n\nmight be too much work to maintain?"},{"author":"joysn1980","date_created":1501480487,"date_modified":1501480552,"content":"I copied the whole conf file form the https://github.com/Whonix/sdwdate/pull/19\nRemoved the link which is not working or big time difference \nand here it is.\nhttps://github.com/joysn/sdwdate/commit/729122e12b99cc4f0dbe2ce023fde61750002e64#diff-289c8954e7cc8349c7632e4ace0564ec\n\nLet me know if this is ok. Once that is done, we can clean up other things like comments or any onions which you think is not OK/secured.\n\n"},{"author":"Patrick","date_created":1501496341,"date_modified":1501496341,"content":"Looks good."},{"author":"joysn1980","date_created":1501515802,"date_modified":1501515802,"content":"https://github.com/joysn/sdwdate/commit/ffc03b1de46ee049bae6fac562dfb2b637d30186#diff-289c8954e7cc8349c7632e4ace0564ec\n\nRemoved the comments. Let me know if any more clean up is required"}]},"PHID-TASK-3l2gptvstsc6ouoreads":{"id":"646","title":"sdwdate-server ALPaCA anti-website fingerprinting Defense","status":"open","priority":"Normal","author":"HulaHoop","description":"In a future sdwdate-server component it would be a neat idea to add the ALPaCA defense to its output when it detects its running as an onion service,\n\nhttps://forums.whonix.org/t/website-fingerprinting-defenses-at-the-application-layer/3679","comments":[]},"PHID-TASK-basrspsevum7xrpxcyyc":{"id":"645","title":"Codecrypt in Whonix 14","status":"resolved","priority":"Normal","author":"HulaHoop","description":"I nominate codecrypt for inclusion in Whonix 14. Please let me know where I should include the package name.","comments":[{"author":"Patrick","date_created":1489451018,"date_modified":1489451018,"content":"anon-workstation-packages-recommended"},{"author":"HulaHoop","date_created":1489599906,"date_modified":1489599906,"content":"Done.\nhttps://github.com/Whonix/anon-meta-packages/pull/4/commits/d3234b989c0c6b72e9bae04e61e4cad5107e8b9e"}]},"PHID-TASK-gqswmrle4fryb2mgwkfs":{"id":"644","title":"replace tb-updater / curl-prgrs","status":"resolved","priority":"Normal","author":"Patrick","description":"[`curl-prgrs`](https://github.com/Whonix/curl-scripts/blob/master/usr/lib/curl-scripts/curl-prgrs) causes high CPU and even may slow down downloads because of this.\n\nPossible approaches to fix this:\n\n* 1) find a replacement for curl-prgrs in bash, or\n* 2) re-implement curl-prgrs in python, or\n* 3) [make torbrowser-launcher work with (Qubes-)Whonix](https://forums.whonix.org/t/using-torbrowser-launcher-instead-of-tb-updater-in-whonix)\n* 4) find a way to deprecate #tb-updater by [using](https://www.whonix.org/wiki/Dev/Default_Application_Policy#guix) guix (T600) or so. Or not. [1]\n* 5) fix curl-prgrs, perhaps port it to pipeviewer `pv` (T649)\n\n----\n\na) Emulate curl options in python:\n\n    --fail --tlsv1.2 --proto =https --max-time 180\n\nb) Emulate endless data attack protection. \n\n```\nif [ \"$bytes\" -gt \"$CURL_PRGRS_MAX_FILE_SIZE_BYTES\" ]; then\n   exit 81\nfi\n```\n\nc) Emulate environment variable `CURL_PRGRS_EXEC` processing.\n\n(This is required to update the #tb-updater #msgcollector zenity progress bar.)\n\n```\n  if [ \"$CURL_PRGRS_EXEC\" = \"\" ]; then\n    true\n  else\n    if [ \"$percent_last\" = \"$percent\" ]; then\n      true\n    else\n      percent_last=\"$percent\"\n      eval $CURL_PRGRS_EXEC $percent\n    fi\n  fi\n```\n\n-----\n\n[1] Keeping #tb-updater has the advantage that it could relatively easily(*) transformed into a tpo-downloader, that can also fetch other software from torproject.org such as Tor Messenger.\n(*) Time is an issue.","comments":[{"author":"HulaHoop","date_created":1493824014,"date_modified":1493824014,"content":"A python download progress bar class. Works with Python 3. Author has since moved to golang.\n\nhttps://github.com/teintuc/deprecated-downloader"},{"author":"Patrick","date_created":1700627044,"date_modified":1700627044,"content":"This was implemented."}]},"PHID-TASK-aiuaq45hfttaor52dlxt":{"id":"643","title":"fix debian/control parsing - make_deb_build_dependencies /  make_deb_runtime_dependencies","status":"resolved","priority":"Normal","author":"Patrick","description":"Related code:\n\nhttps://github.com/Whonix/genmkfile/blob/254f9ea2527e846dd9430e6f4700878419b86c8b/usr/share/genmkfile/make-helper.bsh#L368-L388\n\nParsing debian/control files. For example:\n\nhttps://github.com/Whonix/sdwdate/blob/master/debian/control#L18\n\nthe end result should be:\n\n    make_deb_build_dependencies=\"debhelper genmkfile ruby-ronn dh-systemd dh-apparmor\"\n\nand\n\n    make_deb_runtime_dependencies=\"sudo logrotate bc ruby ruby-inline ruby-dev ruby-all-dev gcc libc6-dev python3-dateutil python3-gevent  python3-socks python3-guimessages python3 tor\"\n\nDoes that make sense?\n","comments":[{"author":"Patrick","date_created":1488818184,"date_modified":1488818184,"content":"Or perhaps utilize https://packages.debian.org/stretch/python3-debian for that task?"},{"author":"olemd","date_created":1488923253,"date_modified":1488923253,"content":"Apparently debian control-files aren't ment to be parsed, or something. My google-fu seems to be stronger than my multiline-regexp-fu, so this http://unix.stackexchange.com/a/215919/11930 seems like a workable solution.\n\n\n```\nperl -ne 'next if /^#/; $p=(s/^Build-Depends:\\s*/ / or (/^ / and $p)); s/,|\\n|\\([^)]+\\)//mg; print if $p' < debian/control \n```\nfor Build-Depends and\n\n```\nperl -ne 'next if /^#/; $p=(s/^Depends:\\s*/ / or (/^ / and $p)); s/,|\\n|\\([^)]+\\)//mg; print if $p'  < debian/control | sed 's/${.*}//' | tr -d '|' \n```\nfor runtime depends.\n\nI had a quick look at python3-debian as well, but it seems more geared towards doing things with ready-made .debs and already installed packages.\n\nThis certainly isn't very pretty, but it does work."},{"author":"Patrick","date_created":1488926987,"date_modified":1488926987,"content":"This helps a lot. I almost have a working solution."},{"author":"olemd","date_created":1488971510,"date_modified":1488971510,"content":"I'm sure I could whip up a pull-request as well if you'd like."},{"author":"Patrick","date_created":1488983663,"date_modified":1488983663,"content":"Next time, that would be welcome.\n\nThis time I did not know you'd like to do that and was already done implementing it. (Just needed to sort out attribution.)\n\nDone:\n\nhttps://github.com/Whonix/genmkfile/commit/8d17a9d7c74f565a81707e703f318b9c98528c6b"}]},"PHID-TASK-qjt26zonr3hvuavxldha":{"id":"642","title":"add sdwdate unit tests","status":"open","priority":"Normal","author":"Patrick","description":"(Related unit test discussion: T566)","comments":[{"author":"Patrick","date_created":1488809325,"date_modified":1488809325,"content":"Perhaps using https://packages.debian.org/de/wheezy/python3-pytest?"}]},"PHID-TASK-3ayklvtqnz7heykwxjkw":{"id":"641","title":"Qubes R4: install pulseaudio-qubes in Whonix 14 for audio support / pulseaudio and vlc should not be installed in sys-whonix","status":"resolved","priority":"Normal","author":"Patrick","description":"As reported at https://github.com/QubesOS/qubes-issues/issues/2650 by Holger Levsen.\n\n> **Qubes OS version (e.g., `R3.2`):**\n> \n> R3.2\n> \n> **Affected TemplateVMs (e.g., fedora-23, if applicable):**\n> \n> whonix-gw\n> \n> **Expected behavior:**\n> \n> pulseaudio and vlc should not be installed in sys-whonix.\n> \n> **Actual behavior:**\n> \n> [#2648](https://github.com/QubesOS/qubes-issues/issues/2648) is the issue suggesting to split out a qubes-gui-agent-pulseaudio package out of qubes-gui-agent.\n> \n> once this has been done the whonix-workstation package should depend on qubes-gui-agent-pulseaudio\n> and the whonix-gateway package should not (and then vlc and pulseaudio wouldnt be installed in sys-whonix.)\n> \n\nSee also:\nhttps://github.com/QubesOS/qubes-issues/issues/2648\n\nWe need a Whonix-Workstation meta package (existing or new?) to depend on `pulseaudio-qubes`.\n\nhttps://forums.whonix.org/t/need-to-add-pulse-audio-for-tor-browser-7-0-1/4032/6\n","comments":[{"author":"Patrick","date_created":1509202250,"date_modified":1509202250,"content":"It fits well into package `qubes-whonix-workstation-packages-recommended`.\n\nhttps://github.com/Whonix/qubes-whonix/blob/master/debian/control#L69\n\nSo I'll add to `Depends:`...?\n\n    pulseaudio-qubes | qubes-gui-agent,\n\nThe first part `pulseaudio-qubes` is for Qubes R4 support and the latter part `| qubes-gui-agent` is for Qubes R3.2 compatibly.\n\nDoes that look alright to you? @marmarek "},{"author":"marmarek","date_created":1509202371,"date_modified":1509202371,"content":"Will that really works for 4.0? There is also `qubes-gui-agent` package, so it isn't clear to me that `pulseaudio-qubes` will really be installed. Perhaps `pulseaudio-qubes | qubes-gui-agent (<< 4.0.0)`?"},{"author":"Patrick","date_created":1509286911,"date_modified":1509286911,"content":"True, my suggested solution might work for new builds but might not work\nfor R3.2 -> R4 upgrades.\n\n> Perhaps `pulseaudio-qubes | qubes-gui-agent (<< 4.0.0)`?\n\nThat wouldn't work for Qubes R3.2, since there is neither\n`qubes-gui-agent (<< 4.0.0)` (highest available version is\n`3.2.18-1+deb9u1`) nor `pulseaudio-qubes`.\n\nDo you see any solution?"},{"author":"marmarek","date_created":1509295981,"date_modified":1509295981,"content":"> (highest available version is 3.2.18-1+deb9u1) \n\nExactly, this do meet `qubes-gui-agent (<< 4.0.0)` criteria - version is lower than 4.0.0.\nNot sure how to force installing `pulseaudio-qubes` on 3.2->4.0 upgrade (instead of keeping old `qubes-gui-agent`)."},{"author":"Patrick","date_created":1512307296,"date_modified":1512307296,"content":">>! In T641#14707, @marmarek wrote:\n> Not sure how to force installing `pulseaudio-qubes` on 3.2->4.0 upgrade (instead of keeping old `qubes-gui-agent`).\n\nIt's a manual, documented process anyhow. Can be listed here:\n\nhttps://www.whonix.org/wiki/Upgrading_Whonix_13_to_Whonix_14\n"},{"author":"Patrick","date_created":1512308097,"date_modified":1512308097,"content":"https://github.com/Whonix/qubes-whonix/commit/dac56daeb0fd607a57c0e8e0b85970d31ef6dcee"},{"author":"unman","date_created":1522855668,"date_modified":1522855668,"content":"@Patrick\nInstallation of pulseaudio-qubes is now included in the 13-14 upgrade guide under Qubes-Whonix instructions.\n\nThe current Whonix-14 templates from Qubes unstable correctly have no vlc in whonix-ws, although vlc libraries, vlc-data and vlc-plugins //are// still included.\nWhonix-ws has the vlc binaries and browser-plugins, as expected.\n\nI think that's enough to close this, unless all traces of vlc should be purged from the gw? If it was necessary to remove the vlc backend, it would be possible to replace it with phonon4qt5-backend-null"},{"author":"Patrick","date_created":1522996458,"date_modified":1522996458,"content":">>! In T641#15836, @unman wrote:\n> Installation of pulseaudio-qubes is now included in the 13-14 upgrade guide under Qubes-Whonix instructions.\n\nVery good.\n\n> I think that's enough to close this, unless all traces of vlc should be purged from the gw?\n\nThat would be good for feasible (dependency hell). Can be covered in T786.\n\n> If it was necessary to remove the vlc backend, it would be possible to replace it with phonon4qt5-backend-null\n\nCreated T786 for it."}]},"PHID-TASK-d77boxvi4k3bqsey34aw":{"id":"640","title":"whonix-setup-wizard autostart broken on Whonix-Gateway 14","status":"resolved","priority":"Normal","author":"Patrick","description":"python exception. To reproduce, run on Whonix-Gateway.\n\n    /usr/lib/whonix-setup-wizard/whonixsetup_check_for_start\n\n(This is what `/etc/xdg/autostart/whonix-setup-wizard.desktop` would be auto starting.)\n\n    /usr/lib/whonix-setup-wizard/whonixsetup_check_for_start \n\n```\nTraceback (most recent call last):\n  File \"/usr/lib/whonix-setup-wizard/whonixsetup_check_for_start\", line 15, in <module>\n    tor_status = tor_status()\nTypeError: 'module' object is not callable\n```","comments":[{"author":"joysn1980","date_created":1488100130,"date_modified":1488100130,"content":"https://github.com/joysn/whonix-setup-wizard/commit/4864784435e5da96369167ed7e8f214ceceb3fc3"},{"author":"Patrick","date_created":1488138972,"date_modified":1488138972,"content":"Thanks! Merged. Works for me."}]},"PHID-TASK-q6xtntaw2mkan2tr25fz":{"id":"639","title":"implement sdwdate sd_notify systemd watchdog","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1487739109,"date_modified":1487739109,"content":"https://github.com/Whonix/sdwdate/commit/94cbff3d987894143e7f61a18e186012e431d641"}]},"PHID-TASK-avvkv22bpbwhcjmxy4mb":{"id":"638","title":"sdwdate-gui systray does not properly register in kde systray","status":"resolved","priority":"Normal","author":"Patrick","description":"In this screenshot of the kde systray you can see it well.\n\n{F169957}\n\nsdwdate-gui has a gap in the `Entry` column.\n\nDo you know how to fix this? Otherwise I could ask on the kde mailing list.","comments":[{"author":"joysn1980","date_created":1487752042,"date_modified":1487752187,"content":"https://github.com/joysn/sdwdate-gui/commit/aeb2f03a1e26a027e778213bc10aafcc14aa391c\n\nshould fix it. I am setting it to \"Sdwdate\".\n\nbtw, this is not new to KDE5, it is present in older whonix too"},{"author":"Patrick","date_created":1487754560,"date_modified":1487754560,"content":"Awesome! Merged. Doesn't break it. Will test it in my next developers build."}]},"PHID-TASK-ds5pshp5p3lf6kwmnfmm":{"id":"637","title":"port from service to systemctl add --no-pager / --no-block","status":"resolved","priority":"Normal","author":"Patrick","description":"Actually `/usr/sbin/service` isn't add init system generic tool as I thought. Even thought it redirects to systemctl for compatibility.\n\nNeed to switch to `systemctl`, even though that is #systemd specific, because `systemctl` runs non-interactively since #debian_stretch if the log output is too long. `--no-pager` has to be added as parameter. Sometimes `--no-block` might make sense as well.","comments":[{"author":"Patrick","date_created":1487716396,"date_modified":1487716396,"content":"Done.\n\nhttps://github.com/Whonix/Whonix/commit/481df7c9569d3b87fd5079c9af3e1a03d4c97b12\n\nThis unfortunately has quite a chance to have messed up an argument an introduce a regression."},{"author":"Patrick","date_created":1487716788,"date_modified":1487716788,"content":"One mistake fixed.\n\nhttps://github.com/Whonix/whonix-setup-wizard/commit/fb8886781ebb1e8565b4038758659cdc6b33817a"}]},"PHID-TASK-kxiyanxn4d4sqqc4gdal":{"id":"636","title":"enable sdwdate-gui systray by default","status":"resolved","priority":"Normal","author":"Patrick","description":"See T598#12287 for some discussion.\n\nThis issue is introduced by porting to #debian_stretch and KDE plasma 5.\n\n    /usr/share/plasma/plasmoids/org.kde.plasma.systemtray/","comments":[{"author":"Patrick","date_created":1493385535,"date_modified":1493385535,"content":"* `ServiceTypes=Plasma/LayoutTemplate`\n* https://github.com/OpenMandrivaAssociation/distro-plasma-config\n* https://github.com/OpenMandrivaAssociation/distro-plasma-config/blob/master/distro-plasma-config.spec\n* https://github.com/OpenMandrivaAssociation/distro-plasma-config/blob/master/org.kde.plasma.desktop-layout.js\n* https://github.com/netrunner-core/netrunner-core-plasma5-panels/blob/master/usr/share/default-settings/plasma5-profile/plasma/layout-templates/org.kde.plasma.desktop.defaultPanel/contents/layout.js"},{"author":"Patrick","date_created":1498478737,"date_modified":1498478737,"content":"https://github.com/Whonix/sdwdate-gui/pull/1"},{"author":"Patrick","date_created":1498495042,"date_modified":1498495042,"content":"@matvey90 It does not work yet.\n\nThis is what I did for testing.\n\n- install newer version of sdwdate-gui (confirmed to see the updated files)\n- switched to a different virtual console (tty1)\n- used the following script for testing, i.e. stop kde, delete all kde config files and restart kde\n\n```\n#!/bin/bash\nset -x\nsudo service sddm stop\nrm -r .kde\nrm -r .local\nrm -r .config\nsudo service sddm restart\n```\n\nsdwdate-gui systray is still hidden by default."},{"author":"hein","date_created":1498811891,"date_modified":1498811922,"content":"Hi folks,\n\nI was told to help you out with preconfiguring the systray plasmoid to set a particular tray icon to always shown?\n\nThis is done by adding an init script (run every time the systray widget is added to somewhere) to the look and feel package, like so:\n\nhttps://github.com/netrunner-artwork/artwork-lnf-netrunner-core/blob/master/usr/share/plasma/look-and-feel/org.kde.netrunner-core.desktop/contents/plasmoidsetupscripts/org.kde.plasma.private.systemtray.js\n\nThe relevant key there is \"shownItems\".\n\nLet me know if you have more questions!"},{"author":"Patrick","date_created":1498820307,"date_modified":1498820307,"content":"Thanks @hein! We don't have to use `org.kde.netrunner-core.desktop` in path name? Can be anything?"},{"author":"hein","date_created":1499076474,"date_modified":1499076474,"content":"Yep, you can name your own LnF package anything. You could also patch/extend the default one in packaging if you prefer."},{"author":"Patrick","date_created":1499420017,"date_modified":1499420017,"content":"What command do you use to build https://github.com/netrunner-artwork/artwork-lnf-netrunner-core?"},{"author":"hein","date_created":1499420432,"date_modified":1499420432,"content":"There's no build commands, LookNFeel packages are just directory structures that can be packaged as compressed archives and get put into the right paths to be picked up by the system."},{"author":"Patrick","date_created":1499509087,"date_modified":1499509087,"content":"I mean, how do you build the `deb` package?"},{"author":"Patrick","date_created":1581594548,"date_modified":1581594548,"content":"We're not using KDE anymore and sdwdate-gui is enabled by default."}]},"PHID-TASK-lk5dm27dnk3w3opis3cg":{"id":"635","title":"write draft for local listener standard on debian-devel","status":"resolved","priority":"Normal","author":"Patrick","description":"subjects\n\n    convention on listen port local or all network interfaces etc.\n\n----\n\ndraft:\n\n----\n\nhttps://github.com/Whonix/proposals\n\n----\n\nTODO:\n\n* ~~improve draft~~ (done)\n* ~~send to debian-devel mailing list~~ (done)\n** https://lists.debian.org/debian-devel/2017/02/msg00431.html\n** https://lists.debian.org/debian-devel/2017/03/msg00348.html\n* discuss on debian-devel\n","comments":[{"author":"HulaHoop","date_created":1487556762,"date_modified":1487556762,"content":"Great as always. I did a few minor edits. Good to go."},{"author":"dau","date_created":1487583632,"date_modified":1487583632,"content":"I agree, this looks great! The only thing I noticed is that the dpkg conflict resolution reference is probably missing a `:`. Maybe that's why it looks like a checked check box? (`[x]` instead of `[x]:`?)"},{"author":"Patrick","date_created":1487601028,"date_modified":1487601028,"content":">>! In T635#12389, @dau wrote:\n> I agree, this looks great! The only thing I noticed is that the dpkg conflict resolution reference is probably missing a `:`. Maybe that's why it looks like a checked check box? (`[x]` instead of `[x]:`?)\n\nRight. Fixed. It was a checkbox because the phabricator interpreted it as markup. I am not putting the whole thing into a code box since then long lines would not be auto wrapped in your browser, which would make this a lot harder to read. Anyhow. `[x]:`indeed looks better in phabricator and will look better on the mailing list."},{"author":"Patrick","date_created":1487602941,"date_modified":1487602941,"content":"One thing is still too vague.\n\nDoes\n```\n# /etc/server-config.d/30_default.conf\nlisten_ip=0.0.0.0\n\n# /etc/server-config.d/50_user.conf\nlisten_ip=127.0.0.1\n```\nmean\n\n* a) listen on `0.0.0.0` as well as on `127.0.0.1`?\n* b) Or does the latter `listen_ip=127.0.0.1` deactivate `listen_ip=0.0.0.0`? \n\na) is how systemd parses systemd unit files. In that case one would have to use `listen_ip=` to disable listeners by lower priority configuration files.\n\n```\n# /etc/server-config.d/30_default.conf\nlisten_ip=0.0.0.0\n\n# /etc/server-config.d/50_user.conf\nlisten_ip=\nlisten_ip=127.0.0.1\n```\n\nb) is easier understand and easy to parse with `bash` (just use `source` as per the pseudo code in the draft). `bash` however is not so important here. A python parser could easily translate this for bash and most daemons will not be written in bash and not be using bash startup wrappers.\n\nIn other words... How to listen on multiple instances?\n\nLike this...\n\n    listen_ip=127.0.0.1,10.152.152.10,UNIX-LISTEN:/path/to/<application-name>.sock\n\n...?\n\nPlease take into consideration the difficulty of adhering this at the python implementation level. I mean, nothing is won if a superb convention is formulated that is then ignored by applications developers like you @dau because it looks too difficult to implement. We might want to bend the convention to suit python implementation difficulty.\n\nYet another style would be \"lower priority configuration files are ignored, only highest priority configuration file is adhered\".\n\nAnd if we don't know the answer, we'll just integrate these questions into the draft."},{"author":"dau","date_created":1487620506,"date_modified":1487620506,"content":">>! In T635#12393, @Patrick wrote:\n> a) is how systemd parses systemd unit files. In that case one would have to use listen_ip= to disable listeners by lower priority configuration files.\n\nThat's interesting. I did think that all files would be read and interpreted, but in cases where multiple `listen_ip=` would be found, the last one would override the previous. So indeed, it seems they would have to disabled. \n\n> In other words... How to listen on multiple instances?\n> \n> Like this...\n> \n>     listen_ip=127.0.0.1,10.152.152.10,UNIX-LISTEN:/path/to/<application-name>.sock\n> \n> ...?\n\nI like it and seems easy to parse.\n \n> Please take into consideration the difficulty of adhering this at the python implementation level. I mean, nothing is won if a superb convention is formulated that is then ignored by applications developers like you @dau because it looks too difficult to implement. We might want to bend the convention to suit python implementation difficulty.\n> \n\nAs a python developer it would be great to easily get the ip that should be used. However, I do not agree with you on this point because a *nix standard is being proposed. I think that it should be consistent with how systems interpret these configurations and then it is up to each app to access them. That might actually be decisive if the proposal is accepted or not.\n\nI am sure that if it is really hard to read the configs, let's say in python, some package could be developed to parse the  files and offer them in a very convenient way. I would just import it, tell which file to read or which specific config to get and do whatever I have to do with this object/dict/string returned. If the settings became environment variables I assume it would be pretty easy to use in any language, but if the file is too long then the environment might get polluted (?).\n\n> And if we don't know the answer, we'll just integrate these questions into the draft.\n\nI agree. I think we could give them all the options we have and all questions that came up. The more information, the better.\n\nThanks!"},{"author":"Patrick","date_created":1487633147,"date_modified":1487633147,"content":"Thank you for your feedback!\n\nI don't dare to call this a standard, because then this could take ages and face lots of resistance. A volunteer convention seems nicer.\n\nThere is no standard on configuration file parsing. Many applications have many very different configuration languages. I personally like the way systemd goes about it. It allowed Whonix specific overrides to be implemented with a very few lines and cleanly."},{"author":"Patrick","date_created":1487633413,"date_modified":1487633413,"content":"Two more edits. It's now all included based on your feedback which I hopefully interpreted correctly (btw being not a native English speaker).\n\nPlease have a look if it's ready to go."},{"author":"dau","date_created":1487635864,"date_modified":1487635864,"content":">>! In T635#12405, @Patrick wrote:\n> Thank you for your feedback!\n\nNo problem. As I said, I do not have much experience/knowledge about this, so I am just giving opinions/ideas (not sure which ones make sense or are relevant).\n\n> I don't dare to call this a standard, because then this could take ages and face lots of resistance. A volunteer convention seems nicer.\n\nHmm you are right, that's true! At this point I think that Whonix will implement it regardless if it is adopted or not, right?\n\n> There is no standard on configuration file parsing. Many applications have many very different configuration languages. I personally like the way systemd goes about it. It allowed Whonix specific overrides to be implemented with a very few lines and cleanly.\n\nSounds good. If you are familiar with that and things work, then I'd say it's probably the way to go.\n\n>>! In T635#12406, @Patrick wrote:\n> Two more edits. It's now all included based on your feedback which I hopefully interpreted correctly (btw being not a native English speaker).\n> \n> Please have a look if it's ready to go.\n\nCool! I cannot help you with that because I am not a native speaker as well :P\n\nIn my opinion it looks great, I think it is ready."},{"author":"Patrick","date_created":1487638713,"date_modified":1487638738,"content":"Great! Sent.\n\nNot yet on the mailing list archive. I'll share the link once available here.\n\nhttps://lists.debian.org/debian-devel/2017/02/threads.html\n\n>>! In T635#12409, @dau wrote:\n>>>! In T635#12405, @Patrick wrote:\n>> Thank you for your feedback!\n> \n> No problem. As I said, I do not have much experience/knowledge about this, so I am just giving opinions/ideas (not sure which ones make sense or are relevant).\n\nSure. That's all I am looking for. Much appreciated! :)\n\n>> I don't dare to call this a standard, because then this could take ages and face lots of resistance. A volunteer convention seems nicer.\n> \n> Hmm you are right, that's true! At this point I think that Whonix will implement it regardless if it is adopted or not, right?\n\nIt is my hope to get some good feedback on debian-devel. One never knows what could have been overlooked. Lots of people reading there. The more developers following this convention, the better.\n\nBut yes. Even if only you representing unMessage like this convention, by all means, Whonix should go for it. I am however very positive that also onionshare, ricochet and ZeroNet would be open to it. Even if just the Tor ephemeral hidden services software packages adhere this convention that would be a huge win.\n"},{"author":"Patrick","date_created":1487639352,"date_modified":1487639352,"content":"https://lists.debian.org/debian-devel/2017/02/msg00431.html"},{"author":"Patrick","date_created":1487696493,"date_modified":1487696493,"content":"Replies so far:\n\n- https://lists.debian.org/debian-devel/2017/02/msg00442.html\n- https://lists.debian.org/debian-devel/2017/02/msg00448.html"},{"author":"dau","date_created":1489972446,"date_modified":1489972446,"content":"As we discussed in [0], I am updating the draft.\n\nBased on Tomas Pospisek's posts [1] and [2], I made the following changes (it's attached). Following your reply [3] to Marco d'Itri's post [4], I agree and think he did not fully understand our intentions, so I did not take that into consideration.\n\nFrom my understanding, Tomas Pospisek would like to have additional configuration `include`s explicit and manually added to the main file so that it is clear what is supposed to happen instead of thinking \"apparently placing customizations in `/home/.config/server-config.d/` just work\". I do not fully agree as I am usually in favor of \"convention over configuration\" and either just adding configurations to some of the `server-config.d` dirs or customizing `main.config` still require you \"to have a priory knowledge\" (you need to know what you are doing and what files to change), but I do like the solution he presented by using `include`, which makes the file a lot \"cleaner\".\n\nFrom your reply [5] to his post:\n\n> Would you suggest just a single file /etc/server/main.config?\n> \n> Or should there be also:\n> \n> - /usr/lib/server/main.config\n> - /etc/server/main.config\n> - /home/.config/server/main.config\n\nI think that by naming that file `main`, he intended to have just a single file so that not much knowledge is required (otherwise you would have know about not only all the `.config` files, but also the `.conf` ones). Also, from his comments in [2] it would be a good idea to use multiple `.config` files and multiple `.d` subdirs for complex configs, but I do think it is the case here. I agree with that but one problem that we might face is having that single `.config` file \"restored\" from the template when using Qubes. What do you think? Maybe having a directory in `main.config` that is not restored solves that? (i.e., all customizations should be in that dir)\n\n> Should main.config file[s] only contain `include` statements and\n> comments and nothing else?\n\nI am pasting `/etc/logrotate.conf` below, which contains more than `include` statements. I think that there is no need for that as this convention is very clear about what the related `.conf` files should be and their contents are consistent to each other. I do like that the other content in `/etc/logrotate.conf` is consistent to the content of the other files in `/etc/logrotate.d/`.\n\n\n```\n# see \"man logrotate\" for details\n# rotate log files weekly\nweekly\n\n# keep 4 weeks worth of backlogs\nrotate 4\n\n# create new (empty) log files after rotating old ones\ncreate\n\n# uncomment this if you want your log files compressed\n#compress\n\n# packages drop log rotation information into this directory\ninclude /etc/logrotate.d\n\n# no packages own wtmp, or btmp -- we'll rotate them here\n/var/log/wtmp {\n    missingok\n    monthly\n    create 0664 root utmp\n    rotate 1\n}\n\n/var/log/btmp {\n    missingok\n    monthly\n    create 0660 root utmp\n    rotate 1\n}\n\n# system-specific logs may be configured here\n```\n\nThis new approach would not change the way the `.conf` files work when dealing with configurations from the previous files, right? If it is needed, they are able to  to ignore the previous statements with, for example, `listen_ip=`. I am saying that because it looks like now `main.config` is allowed to change and just having `include` statements suggests that prefixing them with `#` is enough to ignore. That could work for non-Qubes systems, but as I mentioned above having `main.config` restored can be a problem.\n\nLet me know what you think. Thanks!\n\n[0]: https://github.com/AnemoneLabs/unmessage/pull/24\n[1]: https://lists.debian.org/debian-devel/2017/02/msg00442.html\n[2]: https://lists.debian.org/debian-devel/2017/02/msg00581.html\n[3]: https://lists.debian.org/debian-devel/2017/02/msg00448.html\n[4]: https://lists.debian.org/debian-devel/2017/02/msg00562.html\n[5]: https://lists.debian.org/debian-devel/2017/02/msg00561.html\n\n{F283910}"},{"author":"Patrick","date_created":1490019219,"date_modified":1490019219,"content":"If you are using git anyhow to generate the diff, could you please fork https://github.com/adrelanos/listen-port-convention and commit? That would make the diff a lot easier to apply and read for me.\n\nFrom your diff...\n\nI think I agree for the most part.\n\n> `+include /home/.config/server-config.d/*.conf`\n\nLooks like a user name is missing. There is no user `.config`.\n\nDo you mean it would automatically interpreted as from\n\n* .. `/home/.config/server-config.d/*.conf`\n* to `/home/user1/.config/server-config.d/*.conf`\n* to `/home/user2/.config/server-config.d/*.conf`\n* etc.? (Depending on the user under which the application is running?)\n\n`include` vs home folder is not obvious yet in the draft? Perhaps the config should contain a variable` `$HOME` or so? And only be adhered by applications running as user such as unMessage? And ignored by applications run by the init system (such a web servers)?\n\n>>! In T635#12783, @dau wrote:\n> As we discussed in [0], I am updating the draft.\n\nThanks!\n\n> Based on Tomas Pospisek's posts [1] and [2], I made the following changes (it's attached).\n\n> Following your reply [3] to Marco d'Itri's post [4], I agree and think he did not fully understand our intentions, so I did not take that into consideration.\n\nOk.\n\n> From my understanding, Tomas Pospisek would like to have additional configuration `include`s explicit and manually added to the main file so that it is clear what is supposed to happen instead of thinking \"apparently placing customizations in `/home/.config/server-config.d/` just work\". I do not fully agree as I am usually in favor of \"convention over configuration\" and either just adding configurations to some of the `server-config.d` dirs or customizing `main.config` still require you \"to have a priory knowledge\" (you need to know what you are doing and what files to change), but I do like the solution he presented by using `include`, which makes the file a lot \"cleaner\".\n\nOk.\n\n> From your reply [5] to his post:\n> \n>> Would you suggest just a single file /etc/server/main.config?\n>> \n>> Or should there be also:\n>> \n>> - /usr/lib/server/main.config\n>> - /etc/server/main.config\n>> - /home/.config/server/main.config\n\nFrom my current self, my question was a bit pointless. Of course only `/etc/server/main.config` and not `/usr/lib/server/main.config` etc. No need to make it overly complex.\n\n> I think that by naming that file `main`, he intended to have just a single file so that not much knowledge is required (otherwise you would have know about not only all the `.config` files, but also the `.conf` ones).\n\nYes.\n\n> Also, from his comments in [2] it would be a good idea to use multiple `.config` files and multiple `.d` subdirs for complex configs, but I do think it is the case here.\n\nYes.\n\n> I agree with that but one problem that we might face is having that single `.config` file \"restored\" from the template when using Qubes. What do you think? Maybe having a directory in `main.config` that is not restored solves that? (i.e., all customizations should be in that dir)\n\nNot sure I understand. I guess you are referring to Qubes template implementation (and Qubes bind-dirs and such)? Yes, indeed! How could I forget about this.\n\nSo let's sneak into the proposal....?\n\n```\ninclude /usr/local/etc/server-config.d/*.conf\n```\n\n`/usr/local` is persistent in Qubes TemplateBasedVMs. Then users would not have to modify their template, but could for example also persistently change settings in their TemplateBased AppVMs.\n\n>> Should main.config file[s] only contain `include` statements and\n>> comments and nothing else?\n> \n> I am pasting `/etc/logrotate.conf` below, which contains more than `include` statements. I think that there is no need for that as this convention is very clear about what the related `.conf` files should be and their contents are consistent to each other. I do like that the other content in `/etc/logrotate.conf` is consistent to the content of the other files in `/etc/logrotate.d/`.\n> \n> \n> ```\n> # see \"man logrotate\" for details\n> # rotate log files weekly\n> weekly\n> \n> # keep 4 weeks worth of backlogs\n> rotate 4\n> \n> # create new (empty) log files after rotating old ones\n> create\n> \n> # uncomment this if you want your log files compressed\n> #compress\n> \n> # packages drop log rotation information into this directory\n> include /etc/logrotate.d\n> \n> # no packages own wtmp, or btmp -- we'll rotate them here\n> /var/log/wtmp {\n>     missingok\n>     monthly\n>     create 0664 root utmp\n>     rotate 1\n> }\n> \n> /var/log/btmp {\n>     missingok\n>     monthly\n>     create 0660 root utmp\n>     rotate 1\n> }\n> \n> # system-specific logs may be configured here\n> ```\n\nI like that.\n\n> This new approach would not change the way the `.conf` files work when dealing with configurations from the previous files, right? If it is needed, they are able to  to ignore the previous statements with, for example, `listen_ip=`.\n\nYes.\n\n> I am saying that because it looks like now `main.config` is allowed to change and just having `include` statements suggests that prefixing them with `#` is enough to ignore.\n\nYes.\n\n> That could work for non-Qubes systems, but as I mentioned above having `main.config` restored can be a problem.\n\nYes. Let's see if you like my suggestion to cover this using `/usr/local/etc/server-config.d/*.conf` as mentioned above."},{"author":"dau","date_created":1490056955,"date_modified":1490056955,"content":">>! In T635#12787, @Patrick wrote:\n> If you are using git anyhow to generate the diff, could you please fork https://github.com/adrelanos/listen-port-convention and commit? That would make the diff a lot easier to apply and read for me.\n\nGreat, there is a repo! I'll send a PR then.\n\n> Looks like a user name is missing. There is no user `.config`.\n\nIndeed `/home/.config/` is wrong. I believe I did not copy that properly from the draft. Sorry!\n\n> `include` vs home folder is not obvious yet in the draft? Perhaps the config should contain a variable` `$HOME` or so?\n\nThat would be a good idea. Is that how other conventions reference `~`?\n\n> And only be adhered by applications running as user such as unMessage? And ignored by applications run by the init system (such a web servers)?\n\nThat's also a good idea. Configs in `~` are probably the most specific we can get. I am not sure though if in the end that will be useful/used. For example, `listen_ip` is customized likely due to some network/system scenario (in our case, Whonix' workstation/gateway setup), but do you think that would change for different users of the same network and system? Maybe it's useful when you do not have privileges to change the other files?\n\n> Not sure I understand. I guess you are referring to Qubes template implementation (and Qubes bind-dirs and such)? Yes, indeed! How could I forget about this.\n> \n> So let's sneak into the proposal....?\n> \n> ```\n> include /usr/local/etc/server-config.d/*.conf\n> ```\n> \n> `/usr/local` is persistent in Qubes TemplateBasedVMs. Then users would not have to modify their template, but could for example also persistently change settings in their TemplateBased AppVMs.\n\nThat certainly solves the problem!\n\n> Yes. Let's see if you like my suggestion to cover this using `/usr/local/etc/server-config.d/*.conf` as mentioned above.\n\nCompletely agree with that.\n\nI can send the changes. The only thing I wanted to clarify before that is whether we are going to have `~/.config/server-config.d/` by default or not, and how we are going to reference `~` in `main.config` if so.\n\nThanks!"},{"author":"Patrick","date_created":1490099844,"date_modified":1490099844,"content":">> `include` vs home folder is not obvious yet in the draft? Perhaps the config should contain a variable` `$HOME` or so?\n> \n> That would be a good idea. Is that how other conventions reference `~`?\n\nI am not aware of any other conventions using `$HOME`. `~` might be shell specific. `$HOME` is being used in `/etc` a few times. I think `$HOME` is a good choice, because it's a very common environment variable in user's environments. (Not sure stuff even breaks without it.)\n\n>> And only be adhered by applications running as user such as unMessage? And ignored by applications run by the init system (such a web servers)?\n> \n> That's also a good idea. Configs in `~` are probably the most specific we can get. I am not sure though if in the end that will be useful/used. For example, `listen_ip` is customized likely due to some network/system scenario (in our case, Whonix' workstation/gateway setup), but do you think that would change for different users of the same network and system? Maybe it's useful when you do not have privileges to change the other files?\n\nWith parsing config files in `$HOME` we may over complicate the proposal with a rule like this... When using `include $HOME/server-config.d/*.conf`,\n\n* if `$HOME` is set, actually do `include $HOME/server-config.d/*.conf` (this is when applications runs under a user account, not run by the init system)\n* if `$HOME` is unset, `include $HOME/server-config.d/*.conf` has no effect (happens most likely when applications are run by the init system)\n\nI am also getting uncertain of the usefulness of parsing config files in `$HOME`.\n\nPerhaps there are cases where they don't have privileges to change `/etc` but install as user? But why at the same time they want to run a server software on a system they don't have write access to `/etc`? Strange case.\n\nThe Whonix use case which started with \"let's make applications usually listening on 127.0.0.1 such as onionshare, ricochet, unMessage and ZeroNet actually listen on eth0 without having all these applications having to provide individual config files and parse these\". For Whonix use case, parsing of config files in `$HOME` is not required.\n\n* we'd pre-configure that for the user by shipping a config file with Whonix\n* other changes could be done by the user (perhaps VPN users should change it)\n\nIf we don't find a convincing argument for `$HOME` config file parsing for this proposal, I guess we better leave it out. We can listen for feedback and if a compelling use case is provided at a later time, we could still upgrade to a higher version of the proposal at a later point.\n\n>> Not sure I understand. I guess you are referring to Qubes template implementation (and Qubes bind-dirs and such)? Yes, indeed! How could I forget about this.\n>> \n>> So let's sneak into the proposal....?\n>> \n>> ```\n>> include /usr/local/etc/server-config.d/*.conf\n>> ```\n>> \n>> `/usr/local` is persistent in Qubes TemplateBasedVMs. Then users would not have to modify their template, but could for example also persistently change settings in their TemplateBased AppVMs.\n> \n> That certainly solves the problem!\n\nGreat!\n\n>> Yes. Let's see if you like my suggestion to cover this using `/usr/local/etc/server-config.d/*.conf` as mentioned above.\n> \n> Completely agree with that.\n> \n> I can send the changes. The only thing I wanted to clarify before that is whether we are going to have `~/.config/server-config.d/` by default or not, and how we are going to reference `~` in `main.config` if so.\n\nSure thing. Please go ahead. :-)"},{"author":"dau","date_created":1490127489,"date_modified":1490127489,"content":"Alright, I just made the PR with the changes we discussed. Also made minor changes to make it a bit more friendlier.\n\n>>! In T635#12791, @Patrick wrote:\n> With parsing config files in `$HOME` we may over complicate the proposal with a rule like this... When using `include $HOME/server-config.d/*.conf`,\n> \n> * if `$HOME` is set, actually do `include $HOME/server-config.d/*.conf` (this is when applications runs under a user account, not run by the init system)\n> * if `$HOME` is unset, `include $HOME/server-config.d/*.conf` has no effect (happens most likely when applications are run by the init system)\n> \n> I am also getting uncertain of the usefulness of parsing config files in `$HOME`.\n> \n> Perhaps there are cases where they don't have privileges to change `/etc` but install as user? But why at the same time they want to run a server software on a system they don't have write access to `/etc`? Strange case.\n> \n> The Whonix use case which started with \"let's make applications usually listening on 127.0.0.1 such as onionshare, ricochet, unMessage and ZeroNet actually listen on eth0 without having all these applications having to provide individual config files and parse these\". For Whonix use case, parsing of config files in `$HOME` is not required.\n> \n> * we'd pre-configure that for the user by shipping a config file with Whonix\n> * other changes could be done by the user (perhaps VPN users should change it)\n> \n> If we don't find a convincing argument for `$HOME` config file parsing for this proposal, I guess we better leave it out. We can listen for feedback and if a compelling use case is provided at a later time, we could still upgrade to a higher version of the proposal at a later point.\n\nCompletely agree. Removed the `~` entry but added a note about using home for the configurations.\n\nOne thing I noticed: Tomas' suggestions used `/etc/server/main.config` for the main file and `server/config.d/` for the directories. I think that makes sense and makes things more consistent. I'm just not sure if `server` is the best name because that might be too generic. What do you think?\n\n\nBy the way, I think it is a good idea to use VCS for this. Would it be possible to create a `proposals` repository? Similar to the one Tor uses."},{"author":"Patrick","date_created":1490134082,"date_modified":1490134082,"content":"dau (Felipe Dau):\n> dau added a comment.\n> \n> \n>   Alright, I just made the PR with the changes we discussed. Also made minor changes to make it a bit more friendlier.\n\nThanks, merged!\n\n>   In https://phabricator.whonix.org/T635#12791, @Patrick wrote:\n>   \n>   > With parsing config files in `$HOME` we may over complicate the proposal with a rule like this... When using `include $HOME/server-config.d/*.conf`,\n>   >\n>   > - if `$HOME` is set, actually do `include $HOME/server-config.d/*.conf` (this is when applications runs under a user account, not run by the init system)\n>   > - if `$HOME` is unset, `include $HOME/server-config.d/*.conf` has no effect (happens most likely when applications are run by the init system)\n>   >\n>   >   I am also getting uncertain of the usefulness of parsing config files in `$HOME`.\n>   >\n>   >   Perhaps there are cases where they don't have privileges to change `/etc` but install as user? But why at the same time they want to run a server software on a system they don't have write access to `/etc`? Strange case.\n>   >\n>   >   The Whonix use case which started with \"let's make applications usually listening on 127.0.0.1 such as onionshare, ricochet, unMessage and ZeroNet actually listen on eth0 without having all these applications having to provide individual config files and parse these\". For Whonix use case, parsing of config files in `$HOME` is not required.\n>   > - we'd pre-configure that for the user by shipping a config file with Whonix\n>   > - other changes could be done by the user (perhaps VPN users should change it)\n>   >\n>   >   If we don't find a convincing argument for `$HOME` config file parsing for this proposal, I guess we better leave it out. We can listen for feedback and if a compelling use case is provided at a later time, we could still upgrade to a higher version of the proposal at a later point.\n>   \n>   \n>   Completely agree. Removed the `~` entry but added a note about using home for the configurations.\n\nGreat!\n\n>   One thing I noticed: Tomas' suggestions used `/etc/server/main.config` for the main file and `server/config.d/` for the directories. I think that makes sense and makes things more consistent. I'm just not sure if `server` is the best name because that might be too generic. What do you think?\n\nNeither `/etc/server-config.d` nor `/etc/server` look like ideal choices\nfor folder names to me. I was hoping for better suggestions. =)\n\n`/etc/server/main.config` is not so pretty. A folder with a single\nconfig file. Why a folder then.\n\n(I also had in mind `/etc/listen/main.conf` as well as\n`/etc/listen/conf.d/*.conf`. That would be similar to `/etc/dpkg`. But\n`/etc/listen/conf.d/` would be less consistent with `/usr/lib/listen.d/`.)\n\nWhat about as name, `listen`? Is this specific enough only on the topic\nof `listen` or will it likely expand to also covering \"`server`\"?\n\nLet's go with the following?\n\n* `/etc/listen.conf`\n* `/etc/listen.d/*.conf`\n* `/usr/local/etc/listen.d/*.conf`\n* `/usr/lib/listen.d/*.conf`\n\n>   By the way, I think it is a good idea to use VCS for this. Would it be possible to create a `proposals` repository? Similar to the one Tor uses.\n\nGood idea!"},{"author":"Patrick","date_created":1490134389,"date_modified":1490134389,"content":"Renamed repository from https://github.com/adrelanos/listen-port-convention to https://github.com/adrelanos/proposals."},{"author":"Patrick","date_created":1490135659,"date_modified":1490135659,"content":"Maybe a bit late, but perhaps now that the proposal is available in git, we could even mention something like this...?\n\n> This proposal is available in git [xx], pull requests are welcome.\n\n> [xx] https://github.com/Whonix/proposals/blob/master/listen-port-convention.txt\n\nI think sometimes a shorter comment plus pull request would be less ambiguous, quicker to implement fixes, and if someone is up for that, more power to them.\n\nWhat do you think? If that is good as is or modified, could you add it please in your next pull request?"},{"author":"dau","date_created":1490140748,"date_modified":1490140748,"content":">>! In T635#12809, @Patrick wrote:\n> Neither `/etc/server-config.d` nor `/etc/server` look like ideal choices\n> for folder names to me. I was hoping for better suggestions. =)\n> \n> `/etc/server/main.config` is not so pretty. A folder with a single\n> config file. Why a folder then.\n> \n> (I also had in mind `/etc/listen/main.conf` as well as\n> `/etc/listen/conf.d/*.conf`. That would be similar to `/etc/dpkg`. But\n> `/etc/listen/conf.d/` would be less consistent with `/usr/lib/listen.d/`.)\n> \n> What about as name, `listen`? Is this specific enough only on the topic\n> of `listen` or will it likely expand to also covering \"`server`\"?\n> \n> Let's go with the following?\n> \n> * `/etc/listen.conf`\n> * `/etc/listen.d/*.conf`\n> * `/usr/local/etc/listen.d/*.conf`\n> * `/usr/lib/listen.d/*.conf`\n\nSure, sounds good. I am really bad at names (specially in English), so I think it looks good  and if this thing starts to grow  with more general server content and people start to support it, they will either change to a better name or just get used to it.\n\n>>! In T635#12816, @Patrick wrote:\n> Maybe a bit late, but perhaps now that the proposal is available in git, we could even mention something like this...?\n> \n>> This proposal is available in git [xx], pull requests are welcome.\n> \n>> [xx] https://github.com/Whonix/proposals/blob/master/listen-port-convention.txt\n\nGood idea!\n\nBtw, can I use numbers to index the references instead of `x`, `xx`, etc?\n\n \n> I think sometimes a shorter comment plus pull request would be less ambiguous, quicker to implement fixes, and if someone is up for that, more power to them.\n\nI agree. I just really hope the discussions do not get split between github and phabricator. Hopefully one day github adds support to other trackers?\n\n> What do you think? If that is good as is or modified, could you add it please in your next pull request?\n\nSure, I will. But before that, can I make another suggestion?\n\nI think that once the proposals start to be created we might get confused to reference all of them, so what if we prefixed them just like Tor does, but using the ticket numbers instead? That way we not only have an ID for each one of them, but which is related to a ticket and can be easily found/referenced/etc.\n\nThat means the current proposals would become:\n\n- `634-stackable-wrappers.txt`\n- `635-listen-port-convention.txt`\n\nWhat do you think?"},{"author":"Patrick","date_created":1490145590,"date_modified":1490145590,"content":">   > Maybe a bit late, but perhaps now that the proposal is available in git, we could even mention something like this...?\n>   >\n>   > > This proposal is available in git [xx], pull requests are welcome.\n>   >\n>   >\n>   >\n>   > > [xx] https://github.com/Whonix/proposals/blob/master/listen-port-convention.txt\n>   \n>   \n>   Good idea!\n>   \n>   Btw, can I use numbers to index the references instead of `x`, `xx`, etc?\n\nSure.\n\n>   > I think sometimes a shorter comment plus pull request would be less ambiguous, quicker to implement fixes, and if someone is up for that, more power to them.\n>   \n>   I agree. I just really hope the discussions do not get split between github and phabricator.\n\nIndeed an issue.\n\n> Hopefully one day github adds support to other trackers?\n\nI'd hope so. Sadly I have little hope for that. Too closed / commercial.\nMore likely that some open source github clone takes off.\n\n>   > What do you think? If that is good as is or modified, could you add it please in your next pull request?\n>   \n>   Sure, I will. But before that, can I make another suggestion?\n\nSure! :)\n\n>   I think that once the proposals start to be created we might get confused to reference all of them, so what if we prefixed them just like Tor does, but using the ticket numbers instead? That way we not only have an ID for each one of them, but which is related to a ticket and can be easily found/referenced/etc.\n>   \n>   That means the current proposals would become:\n>   \n>   - `634-stackable-wrappers.txt`\n>   - `635-listen-port-convention.txt`\n>   \n>   What do you think?\n\nGood idea. Please add. And if you find it useful, perhaps the subject\nand link to the ticket would be useful for each proposal / draft as well."},{"author":"dau","date_created":1490150408,"date_modified":1490150408,"content":"Let me know what you think of the new PR.\n\nShould we add \"(Proposal X)\" (or something like that) to the title of the documents as well?\n\n>>! In T635#12809, @Patrick wrote:\n> Let's go with the following?\n> \n> * `/etc/listen.conf`\n> * `/etc/listen.d/*.conf`\n> * `/usr/local/etc/listen.d/*.conf`\n> * `/usr/lib/listen.d/*.conf`\n\nAfter making the changes, I am not sure if with the above you actually meant to set a new order to the parsing of these. Was that the case? Because I changed the order to that.\n\nOtherwise I can move back to how they were such as :\n\n* `/usr/lib/listen.d/*.conf`\n* `/usr/local/etc/listen.d/*.conf`\n* `/etc/listen.d/*.conf`\n\nThanks!"},{"author":"Patrick","date_created":1490153155,"date_modified":1490153155,"content":">>! In T635#12820, @dau wrote:\n> Let me know what you think of the new PR.\n> \n> Should we add \"(Proposal X)\" (or something like that) to the title of the documents as well?\n\nCan do.\n\nPerhaps like this. A dividing marker... (To keep things simple for copy and paste, not to mess that up when posting it to the final posting destination.)\n\n```\nsubject here\n\n##################################################\n\ntext here\n```\n\n>>>! In T635#12809, @Patrick wrote:\n>> Let's go with the following?\n>> \n>> * `/etc/listen.conf`\n>> * `/etc/listen.d/*.conf`\n>> * `/usr/local/etc/listen.d/*.conf`\n>> * `/usr/lib/listen.d/*.conf`\n> \n> After making the changes, I am not sure if with the above you actually meant to set a new order to the parsing of these. Was that the case? Because I changed the order to that.\n> \n> Otherwise I can move back to how they were such as :\n> \n> * `/usr/lib/listen.d/*.conf`\n> * `/usr/local/etc/listen.d/*.conf`\n> * `/etc/listen.d/*.conf`\n> \n> Thanks!\n\nThe latter is better. (Similar on how systemd does it.)\n\n(I messed that up. Wanted to show how `/etc/listen.conf` looks nice vs `/etc/listen.d/*.conf`.)"},{"author":"Patrick","date_created":1490153357,"date_modified":1490153357,"content":"`# Description` is clearly visible as well. No `##################################################` required."},{"author":"Patrick","date_created":1490153641,"date_modified":1490153641,"content":"> `Feedback on the ticket and pull requests on the repository are welcome.`\n\nRight. Could you please add that text the `Description` part? I mean, the `Description` part is the part that gets actually copied over to the Debian mailing list in this case.\n\nI'd suggest to add the link to the ticket and repo rather as a bonus. To be added somewhere at the end. We are mainly addressing the people on the mailing list. Beginning the text with two external links, I mean with...\n\n> - Ticket: https://phabricator.whonix.org/T635\n> - File: https://github.com/Whonix/proposals/blob/master/635-listen-port-convention.txt\n\nmight deter readers? Or am I over thinking this? I don't want to start painting the proverbial bikeshed."},{"author":"dau","date_created":1490177472,"date_modified":1490177472,"content":">>! In T635#12823, @Patrick wrote:\n> Right. Could you please add that text the `Description` part? I mean, the `Description` part is the part that gets actually copied over to the Debian mailing list in this case.\n> \n> I'd suggest to add the link to the ticket and repo rather as a bonus. To be added somewhere at the end. We are mainly addressing the people on the mailing list. Beginning the text with two external links, I mean with...\n> \n>> - Ticket: https://phabricator.whonix.org/T635\n>> - File: https://github.com/Whonix/proposals/blob/master/635-listen-port-convention.txt\n> \n> might deter readers? Or am I over thinking this? I don't want to start painting the proverbial bikeshed.\n\nRight, that's much better. That first section is important just for the ones familiar with Whonix' proposals and that feedback note would not make sense there. I moved to the very end of the documents.\n\nJust made another update. Let me know what you think!\n\nThanks!\n"},{"author":"Patrick","date_created":1490267630,"date_modified":1490267630,"content":"Looks great!"},{"author":"Patrick","date_created":1490267675,"date_modified":1490267675,"content":"Should I copy/paste and post it or would you like to do that?"},{"author":"dau","date_created":1490297704,"date_modified":1490297704,"content":">>! In T635#12825, @Patrick wrote:\n> Looks great!\n\nCool! I'm happy with the changes we made.\n\n>>! In T635#12826, @Patrick wrote:\n> Should I copy/paste and post it or would you like to do that?\n\nSure. If you can, please do that!\n\nThanks!"},{"author":"Patrick","date_created":1490527399,"date_modified":1490527399,"content":"Sent."},{"author":"dau","date_created":1490548341,"date_modified":1490548341,"content":">>! In T635#12834, @Patrick wrote:\n> Sent.\n\nGreat!"},{"author":"Patrick","date_created":1490550151,"date_modified":1490550151,"content":"https://lists.debian.org/debian-devel/2017/03/msg00348.html"},{"author":"dau","date_created":1490661039,"date_modified":1490661039,"content":"https://lists.debian.org/debian-devel/2017/03/msg00352.html\n\n```\nHi Patrick,\n\nOn Sun, Mar 26, 2017 at 11:22:00AM +0000, Patrick Schleizer wrote:\n> A convention on listen port local or all network interfaces etc. would\n> be desirable.\n\nI agree, though I'm not sure we can get consensus on this…\n\nHowever, I also think that you should restart this discussion once stretch has\nbeen released. Now it's not the best time to have such discussions…\n\n> Any questions? Any suggestions? What do you think?\n> \n> Feedback on the ticket [0] and pull requests on the repository [1] are\n> welcome.\n \n(I haven't looked at neither…) but I'd suggest you file a bug against the\n\"general\" pseudo-package in the Debian BTS as that's a more proper place to\ndiscuss changes in Debian.\n\nThanks!\n\n\n-- \ncheers,\n\tHolger\n```\n\nNow that I am thinking about it, there is something that is not clear to me: is this convention a change to Debian or a \"good practice\" that any *nix system could/should do?\n\nI am asking that because requesting a change to Debian seems to take a really long time, but proposing it like a \"suggestion\" which some (Debian) people agree to might not. Does that make sense?"},{"author":"Patrick","date_created":1490700594,"date_modified":1490700594,"content":"Holger Levsen:\n\n> [...]\n\n> However, I also think that you should restart this discussion once stretch has been released.\n\n> [...]\n\n> suggest you file a bug against the \"general\" pseudo-package in the Debian BTS\n\n> [...]\n\n`[zzz]` Well, why not. For the fun and learning experience by it, let's wait until #debian_stretch gets released and then open a bug against `general` on Debian BTS.\n\n>>! In T635#12846, @dau wrote:\n> https://lists.debian.org/debian-devel/2017/03/msg00352.html\n\nThank you for monitoring for replies!\n\n> Now that I am thinking about it, there is something that is not clear to me: is this convention a change to Debian or a \"good practice\" that any *nix system could/should do?\n\nI did not dare to suggest a change to Debian. Did not have this in mind originally.\n\n> I am asking that because requesting a change to Debian seems to take a really long time, but proposing it like a \"suggestion\" which some (Debian) people agree to might not. Does that make sense?\n\nRight. That's what I had in mind.\n\nI think `[zzz]` is a bonus. No need to wait for it or to let it block our progress here. We got some great suggestions for our initial draft which we then implemented. I think in this case it's fair to interpret the absence of criticism and praise as an okay signal to move forward. This is probably also how things work. Some people create some convention, then just do it. If it then proves to be useful and working, it might become an official Debian standard. Neither Debian nor freedesktop want to be the gatekeepers of innovation.\n\n( This is similar to https://bugs.linuxfoundation.org/show_bug.cgi?id=1367. )\n\n( If you like to go further down into the rabbit hole on that one... See https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=675008. )\n\nMeaning, if you'd like to develop a python lib for parsing this convention and/or adhered this convention in unMessage, that'd be awesome! I would also be suggesting other application developers to implement this convention.\n\nWhat do you think?"},{"author":"dau","date_created":1490728333,"date_modified":1490728333,"content":">>! In T635#12847, @Patrick wrote:\n> I think `[zzz]` is a bonus. No need to wait for it or to let it block our progress here. We got some great suggestions for our initial draft which we then implemented. I think in this case it's fair to interpret the absence of criticism and praise as an okay signal to move forward. This is probably also how things work. Some people create some convention, then just do it. If it then proves to be useful and working, it might become an official Debian standard. Neither Debian nor freedesktop want to be the gatekeepers of innovation.\n\nCool!\n\n> ( This is similar to https://bugs.linuxfoundation.org/show_bug.cgi?id=1367. )\n> \n> ( If you like to go further down into the rabbit hole on that one... See https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=675008. )\n>\n> Meaning, if you'd like to develop a python lib for parsing this convention and/or adhered this convention in unMessage, that'd be awesome! I would also be suggesting other application developers to implement this convention.\n> \n> What do you think?\n\nAlright, I should be able to take a look into that earlier next week.\n\nIt would be great to have a generic tool that parses these directories. For example `parse('listen')` would go through all those directories, merging the configs.\n\nCould we make some kind of Python binding for an existing solution?"},{"author":"Patrick","date_created":1490730665,"date_modified":1490730665,"content":"I have no idea if something like this exists. Might not as I don't know python applications doing this."},{"author":"dau","date_created":1490731878,"date_modified":1490731878,"content":">>! In T635#12865, @Patrick wrote:\n> I have no idea if something like this exists. Might not as I don't know python applications doing this.\n\nWell, what I meant was using something written in another language (for example, systemd) that would then be called by this Python package we would create. Users would use it like any other Python package, but in fact it is calling something else underneath. I honestly do not know if there is any kind of API or some way to read the final config though. Do you think that's possible?"},{"author":"Patrick","date_created":1490741903,"date_modified":1490741903,"content":"Well, there is `run-parts`. Example:\n\n    run-parts --list /etc/grub.d/\n\nBut I doubt it would be of big help here."},{"author":"dau","date_created":1490747549,"date_modified":1490747549,"content":"I see. I will let you know how that goes."},{"author":"dau","date_created":1491693939,"date_modified":1491693939,"content":"This class is reasonably flexible so that people are able to customize how files are found and parsed. I pretty much just wrote the API, but here is what I have in mind:\n\n```\nimport argparse\n\n\nclass Parser:\n    @classmethod\n    def parse_global(cls, filepath):\n        \"\"\"Read `filepath`, parse it and return all directory paths found.\n\n        The directories in the list are in the order they are intended to be\n        read.\n        \"\"\"\n\n    @classmethod\n    def check_filename(cls, filename):\n        \"\"\"Return `True` if `filename` is a config file. `False` otherwise.\"\"\"\n\n    @classmethod\n    def find_files(cls, dirpath):\n        \"\"\"Walk through the directory and return all file paths found.\n\n        Depending on `check_filename`, each file is prepended by the\n        directory's path and added to the list. The files in the list are in\n        the order they are intended to be read.\n        \"\"\"\n\n    @classmethod\n    def parse_file(cls, filepath, configs=None):\n        \"\"\"Read `filepath`, parse it and return a `config: value` dict.\n\n        If no configs are provided, a new dict is created. As the file is read,\n        values are added to the configs with\n        `add_config(configs, config, value)`.\"\"\"\n\n    @classmethod\n    def add_config(cls, configs, config, value):\n        \"\"\"Add `config: value` to the configs dict and return it.\n\n        In case the config did not exist, it is added to the dict. Otherwise,\n        it replaces or merges to the existing one.\n        \"\"\"\n\n    @classmethod\n    def parse(cls, name):\n        \"\"\"Read the name of the config and return a `config: value` dict.\n\n        The name defaults to a `/etc/<name>.conf` file path but can optionally\n        specify a different path and extension. Its format should be something\n        like `[/custom/path/]name[.custom]`.\n        \"\"\"\n        cfgs = dict()\n\n        for dirpath in cls.parse_global(name):\n            for filepath in cls.find_files(dirpath):\n                cfgs = cls.parse_file(filepath, cfgs)\n\n        return cfgs\n\n    @classmethod\n    def serialize(cls, configs):\n        \"\"\"Serialize the configs dict into a convenient format.\"\"\"\n\n    @classmethod\n    def parse_to_serialized(cls, name):\n        \"\"\"Parse configs and return them serialized.\"\"\"\n        return cls.serialize(cls.parse(name))\n\n\ndef call_parse():\n    \"\"\"Read a config name and print the serialized configs.\n\n    This function should be accessed through an entry point. The name is passed\n    via a command-line call and returns the configs in a format that\n    applications are able to read in the language they use.\n    \"\"\"\n    argparser = argparse.ArgumentParser()\n    argparser.add_argument('name')\n    args = argparser.parse_args()\n\n    print Parser.parse_to_serialized(args.name)\n\n```\nIt could be used with:\n\n```\nimport Parser\n\ncfgs = Parser.parse('listen')\nlisten_ip = cfgs['listen_ip']\n\n# bind on `listen_ip`\n```\n\nBased on `man systemd.unit` \"The syntax is inspired by XDG Desktop Entry Specification[1].desktop files, which are in turn inspired by Microsoft Windows .ini files.\", which also inspired Python's [ConfigParser](https://docs.python.org/2/library/configparser.html). I am going to take a look into [systemd's code](https://github.com/systemd/systemd), but I think using Python's own config parser might be a better idea.\n\nOnce this is implemented, any non-Python app can make a command-line call to get a config parsed and serialized (maybe to json?).\n\nIf this becomes used by other people, they may implement their own file parser for their own syntax and override its methods. If other parsers become popular, we can implement them as well so that users can specify which parser they would like to use. Depending on all the customizations we allow and provide in this package, it might be easier to move from class methods to instance methods.\n\nI chose to update the configs dict for every config parsing, for every file parsing. The processing increases but memory usage decreases. Then you do not have to merge multiple (possibly big) config dictionaries in the end as they are merged during the process.\n\nWe need to pick another name other than `Parser` or `ConfigParser`.\n\nWhat do you think?\n\nP.S. I noticed the link in the description needs to be updated. Would you change to https://github.com/Whonix/proposals/blob/master/635-listen-port-convention.txt?"},{"author":"Patrick","date_created":1491999323,"date_modified":1491999323,"content":"Perhaps\ncheck_filename -> is_config_file\nfind_files -> find_config_files\n?\n\nOn the other hand... I personally prefer the very at the end and to have some consistency, i.e. config_read, config_check and so forth. Do you know how other popular libraries do it? Perhaps there is even a convention on that?\n\njson is not trivially parsed in shell scripts. For shell scripts, something that can be simply `eval`uated would be nice. (Just `echo listen_ip=xxx`, so `listen_ip=xxx` gets set.)\n\nI may not be the best person to comment on that. Could you ask your mentor or otherwise please for more input on this one?"},{"author":"Patrick","date_created":1491999487,"date_modified":1491999487,"content":">>! In T635#12915, @dau wrote:\n> P.S. I noticed the link in the description needs to be updated. Would you change to https://github.com/Whonix/proposals/blob/master/635-listen-port-convention.txt?\n\nSorry, I cannot find the mistake. Could you send a PR please?"},{"author":"dau","date_created":1492030384,"date_modified":1492030556,"content":">>! In T635#12941, @Patrick wrote:\n> Perhaps\n> check_filename -> is_config_file\n> find_files -> find_config_files\n> ?\n> \n> On the other hand... I personally prefer the very at the end and to have some consistency, i.e. config_read, config_check and so forth.\n\nI like your suggestions. Especially `is_config_file` - It makes much more sense. Thanks!\n\n> Do you know how other popular libraries do it? Perhaps there is even a convention on that?\n\nI do not know and I am not aware of  such convention, but it's worth to check.\n\n> json is not trivially parsed in shell scripts. For shell scripts, something that can be simply `eval`uated would be nice. (Just `echo listen_ip=xxx`, so `listen_ip=xxx` gets set.)\n\nHmm, maybe I was not very clear on the explanation. I did not suggest changing the configs format (the `.conf` files). They should still look like something `eval`uable.\n\nWhat I suggested was the use of json to return the *parsed* configs to applications. As a Python user (and as this would be a Python package) I would expect to get a `dict` with the configs to use on my application. For non-Python applications, that `dict` would be serialized to json because I believe that is one of the most popular formats these days with support from many languages. Also, we can offer multiple \"serializers\" if needed.\n\nWas that your concern?\n\n> I may not be the best person to comment on that. Could you ask your mentor or otherwise please for more input on this one?\n\nSure, I will talk to him. And can you clarify what exactly you are unsure about?\n\n>>! In T635#12942, @Patrick wrote:\n> Sorry, I cannot find the mistake. Could you send a PR please?\n\nCan I send PRs to phabricator? The error is in the description of this ticket (at the top of the page):\n\n> [...]\n> draft:\n> ---\n> https://github.com/adrelanos/proposals\n> ---\n> TODO:\n> [...]\n\nThanks!"},{"author":"Patrick","date_created":1492072517,"date_modified":1492072517,"content":">> json is not trivially parsed in shell scripts. For shell scripts, something that can be simply `eval`uated would be nice. (Just `echo listen_ip=xxx`, so `listen_ip=xxx` gets set.)\n> \n> Hmm, maybe I was not very clear on the explanation. I did not suggest changing the configs format (the `.conf` files). They should still look like something `eval`uable.\n\nI did not interpret your suggestion as a change in the conf files.\n\n> What I suggested was the use of json to return the *parsed* configs to applications.\n\nYes, got that. That's why I wanted to point out, that json is hard to parse in shell scripts.\n\n> As a Python user (and as this would be a Python package) I would expect to get a `dict` with the configs to use on my application. For non-Python applications, that `dict` would be serialized to json because I believe that is one of the most popular formats these days with support from many languages. Also, we can offer multiple \"serializers\" if needed.\n\nYes, something that works for shell scripts would be nice.\n\n> Was that your concern?\n\nYes.\n\n>> I may not be the best person to comment on that. Could you ask your mentor or otherwise please for more input on this one?\n> \n> Sure, I will talk to him. And can you clarify what exactly you are unsure about?\n\nJust generally.\n\n>>>! In T635#12942, @Patrick wrote:\n>> Sorry, I cannot find the mistake. Could you send a PR please?\n> \n> Can I send PRs to phabricator?\n\nNo.\n\n> The error is in the description of this ticket (at the top of the page):\n\nAh, now fixed. :)"},{"author":"dau","date_created":1492076211,"date_modified":1492076211,"content":">>! In T635#12944, @Patrick wrote:\n>>> json is not trivially parsed in shell scripts. For shell scripts, something that can be simply `eval`uated would be nice. (Just `echo listen_ip=xxx`, so `listen_ip=xxx` gets set.)\n>> \n>> Hmm, maybe I was not very clear on the explanation. I did not suggest changing the configs format (the `.conf` files). They should still look like something `eval`uable.\n> \n> I did not interpret your suggestion as a change in the conf files.\n> \n>> What I suggested was the use of json to return the *parsed* configs to applications.\n> \n> Yes, got that. That's why I wanted to point out, that json is hard to parse in shell scripts.\n> \n>> As a Python user (and as this would be a Python package) I would expect to get a `dict` with the configs to use on my application. For non-Python applications, that `dict` would be serialized to json because I believe that is one of the most popular formats these days with support from many languages. Also, we can offer multiple \"serializers\" if needed.\n> \n> Yes, something that works for shell scripts would be nice.\n> \n>> Was that your concern?\n> \n> Yes.\n\nOhh, now I got it! Sure, it should be possible to offer multiple serializers and also allow users to implement their own.\n\n>>> I may not be the best person to comment on that. Could you ask your mentor or otherwise please for more input on this one?\n>> \n>> Sure, I will talk to him. And can you clarify what exactly you are unsure about?\n> \n> Just generally.\n\nAlright!\n\n>>>>! In T635#12942, @Patrick wrote:\n>>> Sorry, I cannot find the mistake. Could you send a PR please?\n>> \n>> Can I send PRs to phabricator?\n> \n> No.\n> \n>> The error is in the description of this ticket (at the top of the page):\n> \n> Ah, now fixed. :)\n\nThanks!"},{"author":"Patrick","date_created":1492249192,"date_modified":1492249192,"content":"The original `write draft for local listener standard on debian-devel` seems done.\n\nCould you please kindly close this ticket / create follow up ticket(s)?"},{"author":"dau","date_created":1492468507,"date_modified":1492468507,"content":">>! In T635#12974, @Patrick wrote:\n> The original `write draft for local listener standard on debian-devel` seems done.\n> \n> Could you please kindly close this ticket / create follow up ticket(s)?\n\nSure! What do you think these should be?\n\n- Implement the convention on Whonix (one just needs to create files following the structure described by it and find a way to parse it, right?)\n- Implement the config parser\n\nP.S. I don't think I have permission to close/edit this ticket."},{"author":"dau","date_created":1492468763,"date_modified":1492468763,"content":"Also:\n\n- Find a place to \"officially\" publish the convention (has it moved from \"proposal\" to \"convention\"?)"},{"author":"Patrick","date_created":1492470182,"date_modified":1492470182,"content":"Right. That's it. :)"},{"author":"dau","date_created":1493004754,"date_modified":1493004754,"content":"Hi @Patrick,\n\nSorry for taking a long time to open these:\n\n- [[ https://phabricator.whonix.org/T659 | Publish \"Listen Port Convention\" ]]\n- [[ https://phabricator.whonix.org/T660 | Implement \"Listen Port Convention\" on Whonix ]]\n- [[ https://phabricator.whonix.org/T661 | Implement a config parser ]]\n\nLet me know what you think.\n\nThanks!"},{"author":"Patrick","date_created":1493389978,"date_modified":1493389978,"content":"Looks great!"}]},"PHID-TASK-wusarvu2cuj63v67kpy4":{"id":"634","title":"write draft for stackable wrappers on debian-devel","status":"open","priority":"Normal","author":"Patrick","description":"Subject:\n\n    stackable wrappers\n\n-----\n\nDraft:\n\n-----\n\nhttps://github.com/Whonix/proposals/blob/master/634-stackable-wrappers.txt\n\n-----\n\nTODO:\n\n* improve draft\n* send to debian-devel mailing list\n* discuss on debian-devel\n","comments":[{"author":"Patrick","date_created":1487269863,"date_modified":1487269863,"content":"I am done editing for now. Any things in the draft unclear? Any suggestions. Please post them here or edit the ticket."},{"author":"HulaHoop","date_created":1487375733,"date_modified":1487375733,"content":"Well written. I made a small change to make it clear that none of the options we have now are any good."},{"author":"Patrick","date_created":1487437729,"date_modified":1487437729,"content":"`amend PATH environment variable by package` would be a good solution from my point of view.\n\nThey did not like my `/etc/environment.d` feature request.\n\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=704054\n\nAnd this might require modifying similar packages and long standing implementations.\n\nCan you think of good general use cases / combinations as show cases?"},{"author":"HulaHoop","date_created":1487556051,"date_modified":1487556051,"content":"Your real-world example is a good one. Also your scurl script to enforce HTTPS (good selling point even if effectiveness debatable) also apt wrapper scripts for special purposes?"},{"author":"Patrick","date_created":1487600712,"date_modified":1487600712,"content":"scurl is a separate command because enforcing that always would break things. A wrapper but not one of the kind like the uwt/torsocks wrappers that get used on every invocation.\n\napt-get wrappers are also separate scripts. apt-get-wrapper currently only supports apt-get update. It's not applied on every manual invocation by the user (or system). That could break some things."},{"author":"dau","date_created":1489976481,"date_modified":1489976481,"content":"This is a great idea!\n\nOne thought I had that is not too related to the actual \"wrapping\", but might be important: my concern here is how this will be presented/documented to Tor users which gives the idea that \"wrapping\" an app with, for example, `torsocks` makes it \"Tor-ready\". As it is discussed in the Torify HOWTO [0], there are quite a few aspects to be taken into account in order to torify an application. One silly example would be having an app that for some reason adds your real IP to its headers and once it is wrapped it now anonymously transmits your real IP.\n\n(I know you guys know this and there are certainly lots of references to this in Whonix' docs, but thought it wouldn't hurt to mention)\n\nThanks!\n\n[0]: https://trac.torproject.org/projects/tor/wiki/doc/TorifyHOWTO\n"},{"author":"Patrick","date_created":1490016950,"date_modified":1490016950,"content":"dau (Felipe Dau):\n> dau added a comment.\n> \n> \n>   This is a great idea!\n\nThanks for the feedback!\n\n>   One thought I had that is not too related to the actual \"wrapping\", but might be important: my concern here is how this will be presented/documented to Tor users which gives the idea that \"wrapping\" an app with, for example, `torsocks` makes it \"Tor-ready\". As it is discussed in the Torify HOWTO [0], there are quite a few aspects to be taken into account in order to torify an application. One silly example would be having an app that for some reason adds your real IP to its headers and once it is wrapped it now anonymously transmits your real IP.\n\nI'd say it's out of scope here. torsocks only serves as one example\namong others here on how one might like to use multiple wrappers at once\nby stacking them. The decision to use/not use torsocks on a non-Whonix\nsystem is up the user. Any and torsocks leak issues are torsocks' bugs.\nI'd like to focus this proposal on stackable wrappers generally and\navoid anything Tor specific with the goal for getter better feedback on\nthe proposal.\n\nActually, if there was a good answer to this, then there would be much\nless need for Whonix. In Whonix we use torsocks only on a best effort\nbasis for stream isolation. However, in Whonix, if torsocks leaks\nsomething, it's not catastrophic, since it leaks through Tor, not clear.net"},{"author":"dau","date_created":1490059597,"date_modified":1490059597,"content":">>! In T634#12786, @Patrick wrote:\n> Any and torsocks leak issues are torsocks' bugs.\n\nI believe it is not torsocks' fault, but the app's for \"not knowing how to be anonymous\". In the end, it is really the user's fault for not knowing what they were doing.\n\n> Actually, if there was a good answer to this, then there would be much\n> less need for Whonix. In Whonix we use torsocks only on a best effort\n> basis for stream isolation. However, in Whonix, if torsocks leaks\n> something, it's not catastrophic, since it leaks through Tor, not clear.net\n\nRight. Although I think that leaking identifying information through Tor is just as bad.\n\nGoing a bit more off-topic:\n\n- It's surprising that there is not a single warning in torsocks' docs/manual about how dangerous it can be to torify an app when you don't know how it works\n- Is there documentation on \"how to torify/make apps Whonix friendly/compliant\"?\n\n> I'd like to focus this proposal on stackable wrappers generally and\n> avoid anything Tor specific with the goal for getter better feedback on\n> the proposal.\n\nWhoops.\n\nRegarding the proposal:\n\nIt is not clear to me how to actually specify the wrapping. For example:\n\n- What should be the contents of `/etc/wrapper.d/30_usr.bin.gpg_torsocks.conf`? Something like `torsocks *` ?\n\n- What about `/etc/wrapper.d/30_usr.bin.zeronet_tor.conf`? `* --tor`?\n\nThanks!"},{"author":"Patrick","date_created":1490100814,"date_modified":1490100814,"content":">>! In T634#12790, @dau wrote:\n>>>! In T634#12786, @Patrick wrote:\n>> Any and torsocks leak issues are torsocks' bugs.\n> \n> I believe it is not torsocks' fault, but the app's for \"not knowing how to be anonymous\". In the end, it is really the user's fault for not knowing what they were doing.\n\nRight. torsocks is somewhere in between. It's useful for experts who know what they are doing or for users where it does not matter so much if DNS leaks or so. By simply prepending torsocks one can never get the same quality and assurances compared to more and more Tor/privacy-aware-by-default applications nowadays.\n\n> Going a bit more off-topic:\n> \n> - It's surprising that there is not a single warning in torsocks' docs/manual about how dangerous it can be to torify an app when you don't know how it works\n\nRight. (Feel free to report a bug against http://trac.torproject.org torsocks component.)\n\n> - Is there documentation on \"how to torify/make apps Whonix friendly/compliant\"?\n\nJust now created a discussion https://forums.whonix.org/t/best-practices-on-how-to-make-your-application-anonymity-privacy-whonix-friendly for it.\n\n> Regarding the proposal:\n> \n> It is not clear to me how to actually specify the wrapping. For example:\n> \n> - What should be the contents of `/etc/wrapper.d/30_usr.bin.gpg_torsocks.conf`? Something like `torsocks *` ?\n> \n> - What about `/etc/wrapper.d/30_usr.bin.zeronet_tor.conf`? `* --tor`?\n\nGood question. Undecided. Indeed, this draft is not as well specified as the convention in T635. Perhaps similar to T635 wrt `include` and config folder locations. The goal I had in mind when posting this is to have an open discussion on debian-devel and get some pointers which of the multiple suggested implementation paths are favored."},{"author":"dau","date_created":1490127754,"date_modified":1490127754,"content":">>! In T634#12793, @Patrick wrote:\n> Right. (Feel free to report a bug against http://trac.torproject.org torsocks component.)\n\nGood idea. Thanks!\n\n> Just now created a discussion https://forums.whonix.org/t/best-practices-on-how-to-make-your-application-anonymity-privacy-whonix-friendly for it.\n\nGreat!\n\n> Good question. Undecided. Indeed, this draft is not as well specified as the convention in T635. Perhaps similar to T635 wrt `include` and config folder locations. The goal I had in mind when posting this is to have an open discussion on debian-devel and get some pointers which of the multiple suggested implementation paths are favored.\n\nI see. Then I think it would be useful to have a note there asking \"how exactly should the wrapping be specified by the `.conf` files?\" or something like that. What do you think?\n\nThanks!"},{"author":"Patrick","date_created":1490134229,"date_modified":1490134229,"content":"Added `How the wrappers would be specified in the config language is yet to be invented, which will be done if this implementation path looks favorable.` does that sound alright to you?"},{"author":"Patrick","date_created":1490135192,"date_modified":1566025003,"content":"draft moved here:\nhttps://github.com/Whonix/proposals/blob/master/634-stackable-wrappers.txt\n"},{"author":"dau","date_created":1490139397,"date_modified":1490139397,"content":">>! In T634#12810, @Patrick wrote:\n> Added `How the wrappers would be specified in the config language is yet to be invented, which will be done if this implementation path looks favorable.` does that sound alright to you?\n\nPerfect!"},{"author":"dau","date_created":1491694110,"date_modified":1491694110,"content":"I noticed the link in the description needs to be updated. Would you change to https://github.com/Whonix/proposals/blob/master/634-stackable-wrappers.txt?"},{"author":"Patrick","date_created":1582974529,"date_modified":1582974585,"content":"* https://github.com/netblue30/firejail/issues/3257\n* https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=822693\n* https://www.whonix.org/pipermail/whonix-devel/2020-February/001519.html\n* https://forums.whonix.org/t/stacked-wrappers/7944\n* https://www.whonix.org/pipermail/whonix-devel/2019-August/001423.html\n* https://www.whonix.org/pipermail/whonix-devel/2019-August/001424.html"}]},"PHID-TASK-flpwr72myuwazdj5tldq":{"id":"633","title":"Non-Qubes-Whonix KDE plasma 5 fixes","status":"wontfix","priority":"Normal","author":"Patrick","description":"https://www.whonix.org/wiki/Dev/KDE#TODO","comments":[{"author":"Patrick","date_created":1487192265,"date_modified":1487192265,"content":"    echo \"$XDG_CONFIG_DIRS\"\n\n    kf5-config --path config\n\nhttps://userbase.kde.org/KDE_System_Administration/Environment_Variables#XDG_CONFIG_DIRS\n\nMight have found a fix for the config packages.\n\n* https://github.com/Whonix/Whonix/commit/ad22dbe703870f385d5a55e3fde5369d7b017d9e\n* https://github.com/Whonix/kde-apper-no-autoupdate/commit/b82e5b6281a13b290bd8338eaa3affcb2075c81c\n* ..."},{"author":"Patrick","date_created":1487545254,"date_modified":1487545254,"content":"https://github.com/Whonix/anon-meta-packages/commit/173bac9f22b6bc0e63aecd774cfc3c776ce27497\n\nDoesn't work. Breaks the desktop."},{"author":"marmarek","date_created":1487548776,"date_modified":1487548776,"content":"Try adding the default value too (`/etc/xdg`)."},{"author":"Patrick","date_created":1487550469,"date_modified":1487550469,"content":"Yay! That fixed it.\n\nAlso more path changes will be required. Similar to the following commit.\n\nhttps://github.com/Whonix/kde-dolphin-menubar-enable/commit/0dd6508f998e7df6df34e2d40a04247bbe1eaf20\n\nDo you think the following /etc/X11/Xsession.d drop-in looks alright?\n\n```\nif [ -z \"$XDG_CONFIG_DIRS\" ]; then\n   export XDG_CONFIG_DIRS=/usr/share/kde-dolphin-menubar-enable/:/etc/xdg\nelse\n   export XDG_CONFIG_DIRS=/usr/share/kde-dolphin-menubar-enable/:$XDG_CONFIG_DIRS\nfi\n```\n"},{"author":"marmarek","date_created":1487551104,"date_modified":1487551104,"content":"Slightly reduced duplication:\n```\nif [ -z \"$XDG_CONFIG_DIRS\" ]; then\n    XDG_CONFIG_DIRS=/etc/xdg\nfi\nexport XDG_CONFIG_DIRS=/usr/share/kde-dolphin-menubar-enable/:$XDG_CONFIG_DIRS\n```"},{"author":"Patrick","date_created":1487712750,"date_modified":1487712750,"content":"Great! Used that.\n\n- https://github.com/Whonix/Whonix/commit/2cfc740b27de865b1c4485990379fa0d05ea63e1\n- https://github.com/Whonix/Whonix/commit/4b2c76d6f5dde5c7d66b07ad2b76f03a8d89bbbe"},{"author":"Patrick","date_created":1487721123,"date_modified":1487721123,"content":"https://github.com/Whonix/kde-apper-no-autoupdate/commit/fd3a81baae7926f3e5f4fd11e7759f941ae1dec0"},{"author":"JasonJAyalaP","date_created":1499565607,"date_modified":1499565607,"content":"> disable screen saver - implemented in https://github.com/Whonix/power-savings-disable-in-vms - TODO test\n \nAfter install of Whonix 14, energy savings is disabled and screen lock is off.\n\nI turned on screen lock and installed the package, but the screen lock stays on. I'm not sure how to load powerdevil from the command line."},{"author":"JasonJAyalaP","date_created":1499565645,"date_modified":1499565645,"content":"> fix desktop shortcuts - TODO test\n\n> https://github.com/Whonix/whonix-gw-desktop-shortcuts\n\nDeleted desktop shortcuts, installed package, shortcuts returned.   \n\n> https://github.com/Whonix/whonix-ws-desktop-shortcuts\n\nSame in WS."},{"author":"Patrick","date_created":1499597024,"date_modified":1499597024,"content":"These `TODO test` require a new build of Whonix 14. No testing required\nfor Whonix `14.0.0.2.6`.\n\n`TODO test` fixes were added after `14.0.0.2.6` but to really test\nthese, a newer version has to be build and tested."},{"author":"Patrick","date_created":1499597244,"date_modified":1499597244,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>> disable screen saver - implemented in\n>> https://github.com/Whonix/power-savings-disable-in-vms - TODO test\n> \n> After install of Whonix 14, energy savings is disabled and screen\n> lock is off.\n\nA new build or Whonix `14.0.0.2.6`?\n\n> I turned on screen lock and installed the package, but the screen\n> lock stays on. I'm not sure how to load powerdevil from the command\n> line.\n\nInstalling the package won't make a difference for already created (and\npreviously booted) user accounts. This is rather tedious to debug. See:\n\nhttps://marc.info/?l=kde&m=141130406809446&w=2\n\nShould add for that KDE config package (which other packages have) to\n`debian/control` package description:\n\n> This package only takes effect for newly created user accounts. Not\nfor existing user accounts. This package is most useful to help Linux\ndistribution maintainers setting divergent defaults."},{"author":"Patrick","date_created":1499597415,"date_modified":1499597415,"content":"`TODO test` is currently used for the same as phabircator status `review` is most times used. It means, when there is a new Whonix build, it needs to be tested if it works there. Perhaps also if it works for upgraded systems."},{"author":"JasonJAyalaP","date_created":1499808790,"date_modified":1499808790,"content":"@Patrick can you confirm what in that list is for the next build? I can edit that list and remove everything with a strikethrough... or moved it to another section (why the strikethrough?). Only the items with the extra words \"TODO test\", correct?"},{"author":"Patrick","date_created":1499810414,"date_modified":1499810414,"content":"On https://www.whonix.org/wiki/Dev/KDE#Whonix_14_TODO ...\n\nGenerally up to date.\n\nWhat says\n\n* `done` - is already done in and tested in `14.0.0.2.6`\n* `TODO test` - is done in latest git master, should work, but needs to be tested in next Whonix build\n* other comments should be self-explanatory\n\n> fix https://github.com/Whonix/kde-konsole-unlim-scrollback broken TODO\n\nMeans: No solution for  #kde-konsole-unlim-scrollback found yet.\n\n> fix \"KDE Desktop Settings for Whonix-Workstation. Enables KDE folderview (allows desktop shortcuts) and sets Whonix specific wallpaper.\"\n\n> https://github.com/Whonix/whonix-gw-kde-desktop-conf\n> https://github.com/Whonix/whonix-ws-kde-desktop-conf\n\nMeans: No solution for  #whonix-ws-kde-desktop-conf and #whonix-gw-kde-desktop-conf was found yet."},{"author":"Patrick","date_created":1499810513,"date_modified":1499810513,"content":">>! In T633#14155, @JasonJAyalaP wrote:\n> I can edit that list and remove everything with a strikethrough... or moved it to another section (why the strikethrough?).\n\nYes, since that is confusing... Feel free to move all that is done (striked through) to a section saying done. (It's to keep track what was already done.)\n"},{"author":"JasonJAyalaP","date_created":1499817593,"date_modified":1499817629,"content":"> https://github.com/Whonix/knetattach-hide - still working? still needed?\n\nIn deb 9, /usr/share/applications/kde4/knetattach.desktop still exists, but the updated file is now\n/usr/share/applications/org.kde.knetattach.desktop\n\nThis package was only meant to hide a link to it from the k menu? Both files have \"NoDisplay=True\", and I don't see it in the menu. You have to run it manually or through Dolphin -> Network -> Add -> Execute (Why there's a warning asking you if want to cancel or open the file to view its text... is a reason why it still ain't the year of the Linux desktop /rant)"},{"author":"Patrick","date_created":1499853596,"date_modified":1499853596,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> This package was only meant to hide a link to it from the k menu?\n\nNo, to hide knetattach from the start menu."},{"author":"JasonJAyalaP","date_created":1499901866,"date_modified":1499901866,"content":"Sorry, that's what I meant. \n\nBut knetattach isn't in the start menu of debian 9. It's new (and old) .desktop file in /usr/share/applications both have \"NoDisplay=true\". No need for manipulating the file, correct?"},{"author":"Patrick","date_created":1499950772,"date_modified":1499950772,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n> Sorry, that's what I meant.\n> \n> But knetattach isn't in the start menu of debian 9.\n\nDebian 9 with KDE?\n\n> It's new (and\n> old) .desktop file in /usr/share/applications both have\n> \"NoDisplay=true\". No need for manipulating the file, correct?\n\nShould be right. As a final test, remove knetattach-hide from\nanon-meta-packages for now. Then in the next Whonix build, check if\nthere are any unwanted start menu entries."},{"author":"JasonJAyalaP","date_created":1499969593,"date_modified":1499969593,"content":"> Debian 9 with KDE?\n\nOk I removed knetattach hide from anon-meta-packages and marked it as TODO test in the wiki."},{"author":"JasonJAyalaP","date_created":1505929714,"date_modified":1505929714,"content":"I ask on kde forums about how to display and confirm settings changed via XDG_CONFIG_DIR\n\nhttps://forum.kde.org/viewtopic.php?f=305&t=141846"},{"author":"JasonJAyalaP","date_created":1506116227,"date_modified":1506117899,"content":"our gtkrc sets the Oxygen theme for gtk applications in plasma 5. However, plasma 5 switched from oxygen to breeze.\n\nShould gtkrc and gtkrc-2.0:\n```\ninclude \"/usr/share/themes/oxygen-gtk/gtk-2.0/gtkrc\"\ngtk-theme-name=\"oxygen-gtk\"\n```\nBe changed to?:\n```\ninclude \"/usr/share/themes/Breeze/gtk-2.0/gtkrc\"\ngtk-theme-name=\"Breeze\"\n```\n\nEdit:\n\nI see that \nhttps://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/kdeglobals\n\nIs attempting to change the widget (but not desktop) theme to oxygen (and failing -> `kcmshell5 style`).\n\nWhy not change gtk widget to breeze (gtk) and keep both default plasma 5 widget and desktop themes?"},{"author":"JasonJAyalaP","date_created":1506119126,"date_modified":1506119126,"content":"krunnerrc (https://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/krunnerrc) is broken, and all plugins are loaded for krunner. Our config is set to disable a handful of plugins.\n\nUsability: What is the security benefit of disabling these features? There's no additional protection against forensics. Are we worried about the user being shoulder surfed with a camera?"},{"author":"Patrick","date_created":1506170401,"date_modified":1506170401,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   our gtkrc\n\nWe currently don't modify gtkrc.\n\n>   Should gtkrc and gtkrc-2.0:\n\n>   Be changed to?:\n\nMaybe.\n\nBut certainly not by writing into /home/user/. There must be a solution\nfor Linux distributions. It's a good question for slayer on IRC as well."},{"author":"Patrick","date_created":1506170581,"date_modified":1506170581,"content":"JasonJAyalaP (Jason J. Ayala P.):\n>   Usability: What is the security benefit of disabling these features?\nlowfat refers to to speed up the VM / have more free RAM by disabling\nstuff that isn't useful inside VMs."},{"author":"JasonJAyalaP","date_created":1506382648,"date_modified":1506382648,"content":"Our package kde low fat does more than freeing ram. It includes XGD config files like gtkrc which change the widget styles for gtk programs running in kde. It also turns sounds off for privacy. The kded options that disable background service can't possibly provide a signficant change in performance. At least not enough to be worth the maintenance burden. Is it more about attack surface, then?\n\nhttps://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/gtkrc\nhttps://www.whonix.org/w/index.php?title=Dev/KDE&stable=0#knotifyrc\n\nFixing the files inside low fat is on the Whonix 14 KDE TODO, which I've been working extensively on.\n\nhttps://www.whonix.org/w/index.php?title=Dev/KDE&stable=0#Whonix_14\n\nShall I remove the files and settings in low fat not related to performance? gtkrc and gtkrc2 count. Inside kdeglobals there's something for change the widgets too. All needless in my opinion. And broken anyways. And certainly not lowfat.\n\nShould the no-sounds configuration and kdedrc configurations be part of a disable-non-essential-services package?\n\n\nFor kdelowfat, I suggest \n\n(1) remove the theme/widget (kde defaults are fine) files+configurations. \n(2) remove the broken krunner stuff (I don't see the privacy argument for it).\n(3) break out the privacy/security stuff into a separate (or move to another?) package\n\n"},{"author":"Patrick","date_created":1506410653,"date_modified":1506410653,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n> Our package kde low fat does more than freeing ram. It includes XGD\n> config files like gtkrc which change the widget styles for gtk\n> programs running in kde.\n\nMaybe that's not important anymore in KDE plasma (stretch version we're\nusing in developers-only version of Whonix 14). Probably not worth\nloosing sleep for.\n\n> It also turns sounds off for privacy.\n\nThat's actually up to a different package\nhttps://github.com/Whonix/kde-sounds-off.\n\n> The\n> kded options that disable background service can't possibly provide a\n> signficant change in performance. At least not enough to be worth the\n> maintenance burden. Is it more about attack surface, then?\n\nForget about performance for simplicity if too hard. (performance)\n\nPlease check attack surface. (security)\n\nPlease check if it confuses users. (usability)\n\nPlease check if it causes any unnecessary network traffic by reading\nhttps://api.kde.org/frameworks/kded/html/index.html and some search\nengine reading about these services. (privacy)\n\n> https://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/gtkrc\n>\n> \nhttps://www.whonix.org/w/index.php?title=Dev/KDE&stable=0#knotifyrc\n> \n> Fixing the files inside low fat is on the Whonix 14 KDE TODO, which\n> I've been working extensively on.\n> \n> https://www.whonix.org/w/index.php?title=Dev/KDE&stable=0#Whonix_14\n\n\n> Shall I remove the files and settings in low fat not related to\n> performance? gtkrc and gtkrc2 count.\n\nYes.\n\n> Inside kdeglobals there's\n> something for change the widgets too. All needless in my opinion. And\n> broken anyways. And certainly not lowfat.\n\nOk.\n\n> Should the no-sounds configuration and kdedrc configurations be part\n> of a disable-non-essential-services package?\n\nNo, too much work yet another package.\n\n> For kdelowfat, I suggest\n> \n> (1) remove the theme/widget (kde defaults are fine)\n> files+configurations.\n\nOk.\n\n> (2) remove the broken krunner stuff (I don't\n> see the privacy argument for it).\n\nPossibly depending on above list, yes.\n\n> (3) break out the privacy/security\n> stuff into a separate (or move to another?) package\n\nPlease tell me what's left after this exchange in this message."},{"author":"JasonJAyalaP","date_created":1506496555,"date_modified":1506496555,"content":"Removing the useless stuff in kdelowfat, here's what's left:\n\n* https://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/kdeglobals\n** Turns off graphics effects\n* https://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/kdedrc\n** Turns off some background services for kde/plasma.\n** Someone at some point needs to go through the services loaded on stretch/plasma 5.8 and decide what should be turned off. Whonix 15?\n* https://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/ksmserverrc\n** Turns of desktop resuming feature\n** Vaguely a performance thing (forces you to reopen only what you need?)\n** Usability issue: We're going against KDE's usability decision (default is resume session)\n\nI committed the changes to master. "},{"author":"Patrick","date_created":1506498474,"date_modified":1506498474,"content":">>! In T633#14584, @JasonJAyalaP wrote:\n> Removing the useless stuff in kdelowfat, here's what's left:\n> \n> * https://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/kdeglobals\n> ** Turns off graphics effects\n\nUseful indeed.\n\n> * https://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/kdedrc\n> ** Turns off some background services for kde/plasma.\n> ** Someone at some point needs to go through the services loaded on stretch/plasma 5.8 and decide what should be turned off. Whonix 15?\n\nPretty essential we don't have privacy violating stuff there or security worsening. So this should be part of this ticket and Whonix 14.\n\n> * https://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/ksmserverrc\n> ** Turns of desktop resuming feature\n> ** Vaguely a performance thing (forces you to reopen only what you need?)\n> ** Usability issue: We're going against KDE's usability decision (default is resume session)\n\nAlright. Resuming the session sounds good.\n"},{"author":"JasonJAyalaP","date_created":1506498785,"date_modified":1506498970,"content":"the kgpgrc file simply has no effect. (https://github.com/Whonix/kde-kgpg-tweaks/blob/master/usr/share/kde-kgpg-tweaks/kgpgrc) \n\nAnd I don't see what tools I have to debug it.\n\nI wonder:\nWe currently don't make use of /etc/skel/. Any files here are copied to a new user's account upon creation. (Our configs are only expect to work on new user accounts as well).\n\nHow does using /etc/skel to place files like kgpgrc, kdeglobals, ..., compare to XDG_DIR? I think the biggest difference: Multiple snippets from multiple packages for the same rc file can be used by XDG. Modularity and cleaner code.\n\nBut in the case of kgpgrc? Doesn't even work with XDG. Can we use skel here? We'd have to make sure it was the only package that adds a kgpgrc file to /etc/skel, correct? There would have to be a monolithic \"whonix-ws-skel\" package that includes \"every config that can't be done via XDG snippets\". Better than nothing.\n\n\n\n"},{"author":"JasonJAyalaP","date_created":1506498900,"date_modified":1506498900,"content":"Another thought. In https://marc.info/?l=kde&m=141130406809446&w=2 you mentioned the limitation:\n\n```\nThis package only takes\neffect for newly created user accounts. Not for existing user accounts.\nThis package is most useful to help Linux distribution maintainers\nsetting divergent defaults.\n```\n\nand wondered if there were a way to override current user settings upon install. My guess: Only via kwriteconfig commands via postinst."},{"author":"Patrick","date_created":1506514106,"date_modified":1506514106,"content":"JasonJAyalaP (Jason J. Ayala P.):\n>   Another thought. In https://marc.info/?l=kde&m=141130406809446&w=2\nyou mentioned the limitation:\n>\n>     This package only takes\n>     effect for newly created user accounts. Not for existing user\naccounts.\n>     This package is most useful to help Linux distribution maintainers\n>     setting divergent defaults.\n\nThis is a bad enough limitation. Even worse would be \"only works for\nuser 'user'\".\n\n>   the kgpgrc file simply has no effect. (https://github.com/Whonix/kde-kgpg-tweaks/blob/master/usr/share/kde-kgpg-tweaks/kgpgrc)\n>   \n>   And I don't see what tools I have to debug it.\n\nNot sure what you mean. It's about `kgpg`. Keep changing kde xdg\nsettings, restart kde, restart kgpg with no config at all until\npre-configuration changes materialize.\n\nOther options:\n\n- contact slayer on irc\n- contact the kgpg developer\n- see how other linux distributions do similar stuff\n-- (T636#13037 or elsewhere)\n\nLinux Mint used to pre-configure kgpg.\n\nhttps://bugs.launchpad.net/linuxmint/+bug/1531505\n\nDunno if they still do that. If so... How are they doing it in their\ncurrent Debian stretch based version?\n\n>   I wonder:\n>   We currently don't make use of /etc/skel/. Any files here are copied to a new user's account upon creation. (Our configs are only expect to work on new user accounts as well).\n\n/etc/skel/ is not suitable. We just change a few settings and leave the\nrest implicit up to KDE defaults. If we ship an explicit config file, we\nrun into follow-up issues such as missing config entries (that KDE by\ndefault had added by default otherwise). Harder to maintain. (Before KDE\nswitched to xdg this required virtually no maintenance after the initial\ndevelopment.) Also violates Debian policy since /etc/skel/ is for local\nsystem administrators, not distributions/packages.\n\n>   and wondered if there were a way to override current user settings\nupon install. My guess: Only via kwriteconfig commands via postinst.\n\nHard.\n\n- Has to run as user to change the user settings, not as root.\n- Limits to user `user`.\n- Since stretch, apt-get complains (and even aborts if I remember right)\nwhen `sudo -u user something` is being used.\n- Debian hates it. Such packages have never a chance to be accepted in\nDebian. This is still a long term goal to reduce maintenance work.\n\n- It could run at first boot as user `user` (to be not part of Debian\nmaintainer scripts) but that's still not a canonical/clean solution\nsince it breaks the xdg hierarchy."},{"author":"JasonJAyalaP","date_created":1506983275,"date_modified":1506983352,"content":"RE: KGPG\nAs far as I can tell, from examing how kubuntu does it and asking both in kde forums (https://forum.kde.org/viewtopic.php?f=225&t=141955&p=381843#p381843) and kde-devel, Kgpg is not affected by XDG (plasma 5), only /etc/kde4rc (KDE4)\n\nWe would need a package that change's /etc/kde4rc and adds kgpg-tweaks/ there\n\nIt would be a \"kde4 apps/config\" package that changes kde4rc for all kde4 apps (if there are more than kgpg). \n\nNot modular like xdg and shareable, unfortunately."},{"author":"JasonJAyalaP","date_created":1506983920,"date_modified":1506983920,"content":"@Patrick \nI've come to a suggestion for all but 2 items in the whonix 14 list. Please review:\nhttps://www.whonix.org/w/index.php?title=Dev/KDE&stable=0#TODO"},{"author":"JasonJAyalaP","date_created":1506984003,"date_modified":1506984003,"content":"RE: unlim scrollback\nDid it ever work?"},{"author":"Patrick","date_created":1507032216,"date_modified":1507032216,"content":">>! In T633#14594, @JasonJAyalaP wrote:\n> RE: unlim scrollback\n> Did it ever work?\n\nYes in Whonix 13 for sure."},{"author":"Patrick","date_created":1507033029,"date_modified":1507033029,"content":">>! In T633#14592, @JasonJAyalaP wrote:\n> RE: KGPG\n> As far as I can tell, from examing how kubuntu does it and asking both in kde forums (https://forum.kde.org/viewtopic.php?f=225&t=141955&p=381843#p381843) and kde-devel, Kgpg is not affected by XDG (plasma 5), only /etc/kde4rc (KDE4)\n> \n> We would need a package that change's /etc/kde4rc and adds kgpg-tweaks/ there\n> \n> It would be a \"kde4 apps/config\" package that changes kde4rc for all kde4 apps (if there are more than kgpg). \n> \n> Not modular like xdg and shareable, unfortunately.\n\nAlright. It's the only doable solution then. Please go ahead and use `/etc/kde4rc`.\n\nIf we only need this on the workstation, then https://github.com/Whonix/whonix-ws-kde-desktop-conf would be the best fit. But I guess we'll need it sooner or later on the gateway as well. Not for kgpg but for other stuff. In that case we would have to duplicate that file in https://github.com/Whonix/whonix-gw-kde-desktop-conf. If it's not a complex file... Not a big problem.\n\nAlternatively add that file to https://github.com/Whonix/whonix-base-files if the same one should be installed on the workstation and gateway at the same time.\n\nSo far about `/etc/kde4rc`.\n\n-----\n\nIf config file is required to be placed in folder `/usr/share/anon-kde/kde4-profile/default/share/config/` that however should go into the https://github.com/Whonix/kde-kgpg-tweaks package.\n\n-----\n\nNetrunner is using that method as well.\n\n* https://github.com/netrunner-kubuntu/netrunner-default-settings/blob/master/etc/kde4rc\n* https://github.com/netrunner-kubuntu/netrunner-default-settings/tree/master/usr/share/netrunner-default-settings/kde4-profile/default/share/config"},{"author":"Patrick","date_created":1507033640,"date_modified":1507033640,"content":">>! In T633#14593, @JasonJAyalaP wrote:\n> @Patrick \n> I've come to a suggestion for all but 2 items in the whonix 14 list. Please review:\n> https://www.whonix.org/w/index.php?title=Dev/KDE&stable=0#TODO\n\n-----\n\n> [Suggest: Can't fix] How to tell KDE to use no arrows and no italic font for symlinked desktop icons? [Suggest: Can't fix] How to tell KDE to use no arrows and no italic font for symlinked desktop icons?\n\nYes.\n\n> arrow -> hackish -> rename all the emblem-symbolic-link.* files (inside theme?) .bak or replace with transparent image.\n\nToo hackish.\n\n>    italics -> no leads. Need kde dev to confirm.\n\nYes.\n\n-----\n\n> [Suggest: Review in 15] https://github.com/Whonix/kde-lowfat/tree/master/usr/share/kde-lowfat\n\nReview in next build.\n\n>    (Works) kdeglobals (https://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/kdeglobals)\n>    (Works) kdedrc (https://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/kdedrc)\n>        No module set to \"false\" is loaded in in Whonix 14.0.0.5.0\n>        TODO: Review which modules we want loaded\n\nOk\n\n>    (Works) ksmserverrc (https://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/ksmserverrc)\n>        Default stretch will \"Restore previous session\" \"on login\" under Desktop Session system settings module\n>        Whonix will \"Start with empty session\"\n>        (TODO Usability) Does KDE's usability decision not apply to us? Will \"accidentally\" restoring sensitive applications and files hurt security? Not any protection against forensics.\n\nWe can go with stretch default \"Restore previous session\" \"on login\". No change required (besides removing the old broken code).\n\n> [Suggest: KDE4RC package for 14 or 15] fix https://github.com/Whonix/kde-kgpg-tweaks \n\nAnswered in my previous comment T633#14596.\n\n\n\n> [Suggest: Find plasma 5 script-person?] fix \"KDE Desktop Settings for Whonix-Workstation (TODO: not GS?). Enables KDE folderview (allows desktop shortcuts) and sets Whonix specific wallpaper.\" \n\nFind plasma 5 script person is fine.  But contents/default also doesn't sound bad. It's working with XDG? Just a drop-in folder? Why not?\n\n> [Works if \"multi user\" isn't supported in Whonix] Desktop shortcuts \n\nOk."},{"author":"JasonJAyalaP","date_created":1507088063,"date_modified":1507088098,"content":"> [Suggest: Review in 15] https://github.com/Whonix/kde-lowfat/tree/master/usr/share/kde-lowfat\n> review in next build\n\nThe review questions are:\n(1) Are all the modules we're disabling giving us performance in return for possible usability and support problems?\n(2) Are there any modules that are loaded by plasma 5 right now that should be disabled for performance?\n\nI don't know how to answer those questions. That's why I suggested \"dealing with it later\". You can view \"background services\" with:\n`kcmshell5 kcmkded`\n\n> Find plasma 5 script person is fine. But contents/default also doesn't sound bad. It's working with XDG? Just a drop-in folder? Why not?\n\ncontents/default is a non-XDG way. Not a folder. `default` is a config file and is part of plasma 5, which (we) might break or could change.\n"},{"author":"JasonJAyalaP","date_created":1507089446,"date_modified":1507090825,"content":">  /etc/kde4rc\n\nBrainstorming:\nws-desktop-conf places/overwrites /etc/kde4rc with:\n```\n[Directories-default]\nprefixes=/usr/share/anon-ws-kde4-defaults/\n```\nAnd in kde-kgpg-tweaks (and for any kde4 apps), the app-rc file is placed at\n`/usr/share/anon-ws-kde4-defaults/share/config/`\n\n(It seems that `kde4-profile/default/` isn't magical but `share/config` is)\n\nBut one thing: Are you sure you'd rather have a separate .deb for every kde4 setting instead of one package that has all rc files in? (Instead of kgpg-tweaks, just kde4-defaults). Wouldn't it be easier, for our own use, to have one .deb file (with both kde4rc and apprc files)? \n\nEven easier: Just put it all in whonix-ws-desktop-conf\n\nSeparating the apps lets other distros install the .deb... but only if they setup kde4rc first, either manually or automatically if they install... well, we'd have to make a `kde4rc` package (instead of ws-desktop-conf, which I assume other people wouldn't want just to setup kde4rc). But in the case of kde4rc.deb + app1.deb + appN.deb, it really wouldn't be shareable anyway because it work nuke their existing kde4rc.\n\nConclusion:\nIf it's just for whonix, I suggest a \"whonix-ws-kde4-settings\" package with both kde4rc and all appfiles. Or put it all in the current whonix-ws/gw-desktop-conf packages. Or if you want to avoid duplication of kde4rc, put that in base and whonix-ws/gw-desktop-conf will depend on that.\n\nIf you think other people will install our app1-rc.deb package and then manually edit their /etc/kde4rc, we can put our kde4rc in ws-desktop and separate packages for each app.\n\n(I hate to be pessimistic, but I think option 2 would be another case of \"whonix doing it better than every one else, but no one caring\").\n\nOh, maybe: Separate debs also avoids code duplication if some apps overlap ws and gw and you don't want unused app-rc files in either:\n\nkde4rc in base\nand then ws and gw can include the apprc files they want.\n\nLots of (pre-mature) optimization there. We will have a huge list of kde4 packages if we every change as many defaults of those other distros do."},{"author":"Patrick","date_created":1507138207,"date_modified":1507138207,"content":">>! In T633#14598, @JasonJAyalaP wrote:\n>> [Suggest: Review in 15] https://github.com/Whonix/kde-lowfat/tree/master/usr/share/kde-lowfat\n>> review in next build\n> \n> The review questions are:\n> (1) Are all the modules we're disabling giving us performance in return for possible usability and support problems?\n> (2) Are there any modules that are loaded by plasma 5 right now that should be disabled for performance?\n\nAlright. Please list which modules after next build.\n\n> I don't know how to answer those questions. That's why I suggested \"dealing with it later\". You can view \"background services\" with:\n> `kcmshell5 kcmkded`\n> \n>> Find plasma 5 script person is fine. But contents/default also doesn't sound bad. It's working with XDG? Just a drop-in folder? Why not?\n> \n> contents/default is a non-XDG way. Not a folder. `default` is a config file and is part of plasma 5, which (we) might break or could change.\n\nWhat's exactly the file location?"},{"author":"Patrick","date_created":1507138558,"date_modified":1507138558,"content":">>! In T633#14599, @JasonJAyalaP wrote:\n>>  /etc/kde4rc\n> \n> Brainstorming:\n> ws-desktop-conf places/overwrites /etc/kde4rc with:\n> ```\n> [Directories-default]\n> prefixes=/usr/share/anon-ws-kde4-defaults/\n> ```\n> And in kde-kgpg-tweaks (and for any kde4 apps), the app-rc file is placed at\n> `/usr/share/anon-ws-kde4-defaults/share/config/`\n> \n> (It seems that `kde4-profile/default/` isn't magical but `share/config` is)\n> \n> But one thing: Are you sure you'd rather have a separate .deb for every kde4 setting instead of one package that has all rc files in? (Instead of kgpg-tweaks, just kde4-defaults). Wouldn't it be easier, for our own use, to have one .deb file (with both kde4rc and apprc files)? \n\nNew package `anon-kde-config` that deprecates all our packages starting with `kde-*`. In Whonix 15 or 16.\n\n> Even easier: Just put it all in whonix-ws-desktop-conf\n\nOnly stuff that is Whonix specific there. Still good enough. Can reduce many packages to three or so.\n\n> Separating the apps lets other distros install the .deb... but only if they setup kde4rc first, either manually or automatically if they install... well, we'd have to make a `kde4rc` package (instead of ws-desktop-conf, which I assume other people wouldn't want just to setup kde4rc). But in the case of kde4rc.deb + app1.deb + appN.deb, it really wouldn't be shareable anyway because it work nuke their existing kde4rc.\n\nIt's true. Looks like sharing such packages doesn't easily fly anyhow. At this point I doubt anyone would reuse it or upload to Debian. So we can as well as pack all the KDE stuff together into one package.\n\n> Conclusion:\n> If it's just for whonix, I suggest a \"whonix-ws-kde4-settings\" package with both kde4rc and all appfiles.\n\ncall it anon-kde-config\n\n> If you think other people will install our app1-rc.deb package and then manually edit their /etc/kde4rc, we can put our kde4rc in ws-desktop and separate packages for each app.\n\nUnlikely indeed.\n\n> Oh, maybe: Separate debs also avoids code duplication if some apps overlap ws and gw and you don't want unused app-rc files in either:\n\nThe unused is not so bad. Lets say unused kgpg config on the gateway wouldn't hurt if it came from anon-kde-config package.\n\n> Lots of (pre-mature) optimization there. We will have a huge list of kde4 packages if we every change as many defaults of those other distros do.\n\nYes. To split it into that many packages originally wasn't a too good design decision."},{"author":"Patrick","date_created":1507138626,"date_modified":1507138626,"content":"Im sumary:\n\n* Whonix 15 / 16: anon-kde-config plus whonix-(gw|ws)-kde-config\n* Whonix 14: kderc file in whonix-(gw|ws)-kde-config plus the existing kde config packages"},{"author":"JasonJAyalaP","date_created":1507149183,"date_modified":1507149183,"content":"> contents/default is a non-XDG way. Not a folder. default is a config file and is part of plasma 5, which (we) might break or could change.\n /usr/share/plasma/shells/org.kde.plasma.desktop/contents/defaults \n\n> Whonix 14: kderc file in whonix-(gw|ws)-kde-config plus the existing kde config packages\nDo you mean https://github.com/Whonix/whonix-ws-kde-desktop-conf ? (Which is currently broken)\n\nOr do you want to create a new package? We might as well create anon-kde-config now then.\n\nI suggest \"anon-kde4-config\", btw. Since it's only for kde4 apps.\n\n\n\n"},{"author":"Patrick","date_created":1507158041,"date_modified":1507158041,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   > contents/default is a non-XDG way. Not a folder. default is a config file and is part of plasma 5, which (we) might break or could change.\n>   \n>   /usr/share/plasma/shells/org.kde.plasma.desktop/contents/defaults\n>   \n>   > Whonix 14: kderc file in whonix-(gw|ws)-kde-config plus the existing kde config packages\n>   \n>   Do you mean https://github.com/Whonix/whonix-ws-kde-desktop-conf ? (Which is currently broken)\n\nI meant whonix-ws-kde-desktop-conf, yes. (And whonix-gw-kde-desktop-conf\nwhen needed.)\n\n>   Or do you want to create a new package? We might as well create anon-kde-config now then.\n\nI was going to say, too much work, Whonix 15 / 16... On the other hand,\nhanding /etc/kderc from whonix-ws-kde-desktop-conf to anon-kde-config\ncould be cumbersome later on. This is because the two packages may not\nown the same file or apt-get will break. And anon-kde-config also\ncouldn't say `Replaces: whonix-ws-kde-desktop-conf`, because that\npackage isn't to be totally deprecated.\n\n`anon-kde-config`... Actually... Why not `anon-apps-config`.\n\nWhy? Like anon-gpg-conf... Such small packages have no chance to make it\ninto Debian. They say the effort/overhead is too big.\n\nSo yes, please for #Whonix_14:\n\n* move all files from all packages starting with `kde-*` and\n`anon-kde-streamiso` to a new package anon-apps-config\n * add a commit message - migrating from ... and link to this ticket\n* migrate all debian/control files descriptions, build dependencies,\ndependencies, recommends and whatnot from `kde-*` packages and create a\ncombined debian/control file\n* add etc/kderc to anon-apps-config\n* remove all `kde-*` packages from #anon-meta-packages 's debian/control.\n* in separate commit, add anon-apps-config to #anon-meta-packages 's\ndebian/control\n* finally `git rm` the `kde-*` from the Whonix/Whonix folder `packages`\n\n>   I suggest \"anon-kde4-config\", btw. Since it's only for kde4 apps.\n\nI don't like too specific package names. It's a lot hassle to rename a\npackage and not breaking the packaging system on major upgrades. I\nwouldn't want a separate anon-kde5-config package."},{"author":"JasonJAyalaP","date_created":1507325277,"date_modified":1507325307,"content":"I instinctively started adding whonix-ws-desktop-shortcuts. But should that package, and similar ones like whonix-ws-start-menu-additions, which depend on the desktop manager (KDE) be part of this package? Oh only the *kde* ones?"},{"author":"JasonJAyalaP","date_created":1507328768,"date_modified":1507329964,"content":"Ignore this comment. I forgot about the magic directory. I'll try putting kde4 rc-files in /usr/share/anon-apps-config/share/config. I'm going to assume that XDG won't recursively search (or that it won't matter).\n\n<s>\nShould kde4 rc-files (kgpgrc) share the same directory (/usr/share/anon-apps-config) as XDG snippets (dolphinrc)? I'm assuming they just ignore each other. It would be nice to have one folder (not /anon-apps-config-kde4 and /anon-apps-config-xdg), with both xsession.d/50anon-apps-config and /etc/kderc pointing to it.\n</s>"},{"author":"Patrick","date_created":1507387708,"date_modified":1507387708,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n> I instinctively started adding whonix-ws-desktop-shortcuts. But\n> should that package, and similar ones like\n> whonix-ws-start-menu-additions,\n\nThese no, since Whonix specific.\n\n> which depend on the desktop manager\n> (KDE) be part of this package? Oh only those kde* ones?\n\nOnly listed ones. But if I forgot any, feel free to suggest while we are\nat it."},{"author":"JasonJAyalaP","date_created":1507430066,"date_modified":1507430066,"content":"kde-privacy \"Deactivates klipper autostart\", in inside klipperrc is\n```\n[General]\nKeepClipboardContents=false\n#AutoStart=false\n\n#[Notification Messages]\n#StartAutomatically=false\n```\nWhy was it commented out? Broken? Did it ever work? Does disabling clipboard history improve privacy/forensics enough to be worth the usability loss?"},{"author":"Patrick","date_created":1507453515,"date_modified":1507453515,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   kde-privacy \"Deactivates klipper autostart\", in inside klipperrc is\n>   \n>     [General]\n>     KeepClipboardContents=false\n>     #AutoStart=false\n>     \n>     #[Notification Messages]\n>     #StartAutomatically=false\n>   \n>   Why was it commented out? Broken?\n\nWas decided to keep the default to autostart it. Otherwise the clipboard\nis deleted once an application it was copied from has been closed.\n\n> Did it ever work?\n\nClipboard history disabling is functional in Whonix 13.\n\n> Does disabling clipboard history improve privacy/forensics enough to be worth the usability loss?\n\nThere was a discussion about this. Long time ago. Somewhere. It stores\npasswords to the disk that otherwise not necessarily would have been stored."},{"author":"JasonJAyalaP","date_created":1508371476,"date_modified":1508371768,"content":"RE: kde-konsole-unlim scrollback\n\nThe big problem was in the Xsessions file:\nhttps://github.com/Whonix/kde-konsole-unlim-scrollback/commit/36492df59602f2e4a0fd714b7f8e05fb3e2b5ba2\n> #export XDG_DATA_HOME=/usr/share/kde-konsole-unlim-scrollback/share:$XDG_DATA_HOME\nYou can NOT add to xdg_data_home. It has to one single directory, and there's no practical reason to change it. The \"multi-folder\"-search-path is `XDG_DATA_DIRS`, which is used after xdg_data_home is searched. (note: `$XDG_CONFIG_DIRS` is the multi-folder search path after `$XDG_CONFIG_HOME`)\n\nhttps://specifications.freedesktop.org/basedir-spec/basedir-spec-0.6.html#basics\n\nWith the above commit, it works. Our konsole/ folder is searched, and Shell.profile is found and used, since there is no other profile.\n\n...*Except* for a bug in konsole:\nAfter not finding konsolerc in XDG_CONFIG_HOME, it *should* search XDG_CONFIG_DIRS for konsolerc. It does not. Instead, it *creates* a default konsolerc in XDG_CONFIG_HOME.\n\n...*However*, our konsolerc does nothing except say \"use shell.profile as default\". This isn't necessary because konsole will find shell.profile and use it since it's the only profile it finds on a default install.\n\nSuggestion:\n* Simply git rm konsolerc. Package works with the above fixes.\n* File a bug report against konsole to be nice. Maybe.\n* Rename Shell.profile to \"UnlimitedScrollback.profile\" ?"},{"author":"Patrick","date_created":1508396605,"date_modified":1508396605,"content":">>! In T633#14636, @JasonJAyalaP wrote:\n> Suggestion:\n> * Simply git rm konsolerc. Package works with the above fixes.\n\nYes.\n\n> * File a bug report against konsole to be nice. Maybe.\n\nYes.\n\n> * Rename Shell.profile to \"UnlimitedScrollback.profile\" ?\n\nVary.\n\nShell.profile is the default.... Having UnlimitedScrollback.profile could lead to having the default Shell.profile created?\n\nShould be fine since it's in sub folder /usr/share/kde-konsole-unlim-scrollback/[...]?\n\nMight not work since default is Shell.profile, not UnlimitedScrollback.profile, so we might have to configure default to be UnlimitedScrollback.profile? That would be weird.\n\nI guess if it works as is now without disadvantage just call it done."},{"author":"Patrick","date_created":1508770936,"date_modified":1508770936,"content":"What I could gather from the KDE meetup...\n\n* there is no repository of KDE plasma 5 that targets maintenance of Debian stretch, so we're stuck with the version currently in Debian stretch or asking for trouble\n\n* /etc/kde4rc - there is really no `.d` folder\n* /etc/kde4rc - deprecated in plasma 5\n* /etc/kde4rc - no one of KDE can help with this since they're all full plasma 5 now\n\n* how to know what rc files for kde/plasma are valid in xdg and kde4rc?\n** In plasma 5 everything is XDG.\n** For kde4 there is no answer.\n\n* How to view current applied settings?\n** use `kreadconfig`\n\n* Is there in-memory caching of configuration files?\n* There is no in-memory configuration files memory caching without running application.\n\nis there a joint config file? how to view it? is it only in memory?\n\n\n* How to quickly/easily debug? Kill app, new user account?\n** Just restart the application.\n\n\n\n* How to use arrows in `.desktop` files?\n** Use `Type=application` in desktop files.\n\n\n\n* plasma 5 scripting to set desktop image and enable folderview (for desktop shortcuts)\n* https://github.com/Whonix/whonix-ws-kde-desktop-conf\n* folderview is the default once KDE 5.10\n\n* enable sdwdate-gui systray in KDE plasma 5 by default T636\n* requires a look and feel packages\n** look an feel packages support inheritance\n** we only need one look and feel package (we use anon-apps-config for that?)\n**** How to know what to write into that? Change the setting manually. Look how the initialization script looks inside the home folder. Copy it and use it as the look and feel package's initialization script.\n**** see example here https://github.com/netrunner-artwork/artwork-lnf-netrunner-core/tree/master/usr/share/plasma/look-and-feel\n** for questions e-mail kde-devel and cc `hein@kde.org`\n\n* clock widget should show seconds by default\n** may or may not have a ticket yet\n** was and old idea to show users that the clock differs in gateway, workstation and host\n** requires a look and feel package\n*** requires an initialization script\n\n\n\n"},{"author":"JasonJAyalaP","date_created":1508980716,"date_modified":1508980837,"content":"I'm having success with kde4rc. Kgpg settings were sucessfully applied, for example, and user modifications to kgpg settings are written to $HOME\n\nBut, with Kgpg, I ran into a wall:\n\n* If the gpg.conf specified in kgpgrc doesn't exist, kgpg refuses to start. We wish it would create a blank file, but it doesn't.\n* If I remove the line `gpg_config_path[$e]=$HOME/.gnupg/gpg.conf` from our kgpgrc, kgpg will complain to the user and confuse the user, asking to run the first-run assistant to fix the problem.\n\n* In other words:\n** if kgpgrc exists, expect `gpg_config_path` ...or complain and offer first run assistant.\n** if kgpgrc and `gpg_config_path` exist, confirm that gpg.conf exists ..or fail."},{"author":"Patrick","date_created":1509030017,"date_modified":1509030017,"content":"Why doesn't gpg.conf not exist? It's here:\n\nhttps://github.com/Whonix/anon-gpg-tweaks/blob/master/etc/skel/.gnupg/gpg.conf"},{"author":"JasonJAyalaP","date_created":1509065338,"date_modified":1509065386,"content":"oh! Ok shouldn't be problem then.\n\nanon-apps-config should have anon-gpg-tweaks as a dependency then. Or maybe not. I dunno. Your call."},{"author":"Patrick","date_created":1509105867,"date_modified":1509105867,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n>   oh! \n>   anon-apps-config should have anon-gpg-tweaks as a dependency then.\n\nNot great, but yes, and in Whonix 15, merge anon-gpg-tweaks into\nanon-apps-config?"},{"author":"JasonJAyalaP","date_created":1510362714,"date_modified":1510362831,"content":"https://forum.kde.org/viewtopic.php?f=227&t=142821\n\n\n> [Bug] Konsole doesn't search $XDG_CONFIG_DIRS for konsolerc \n>\n> Konsole successfully searches $XDG_DATA_HOME (~/.local/) then $XDG_DATA_DIRS (~/usr/share/my-distro-package/) for its konsole/ data directory, finding my `Shell.profile`, which is for my distro's users (Whonix).\n> \n> The problem is `.konsolerc`. Konsole searches $XDG_CONFIG_HOME (~/.config/) for .konsolerc. If it doesn't find it there (which it won't upon first use), it *should* then search $XDG_CONFIG_DIRS. However, it does not. Instead it creates a default `.konsolerc` in $XDG_CONFIG_HOME. I even did `chmod -rw .konsolerc`. This makes Konsole complain, but it will never find my distro's .konsolerc via $XDG_CONFIG_DIRS.\n> \n> There's more strangeness: There seems to be a \"hidden\" config file somewhere for Konsole. If I go into Konsole settings, I can see that Shell.profile is listed. Despite being the only profile, it is not used by default. Instead, some hardcoded profile named \"Default\" is used. The weirdness? If I set Shell.profile to be the active and default profile, I can see that this change is written to `~/.config/konsolerc`. If I then delete `~/.config/konsolerc` and restart Konsole, `Shell.profile` is still active! (Quite misleading for me while debugging)!\n> \n> Note: `Shell.profile` simply enables unlimited scrollback. I want this to be the default upon bootup for our users, configured via XDG and not /etc/skel or by changing files in ~. \n\n"},{"author":"Patrick","date_created":1510397365,"date_modified":1510397365,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> Instead, some hardcoded profile named \"Default\" is used.\n\nWe could also provide `Default` or `Default.profile` (or all lower case)\n- whatever works. No need to keep `shell.profile`."},{"author":"Patrick","date_created":1542729469,"date_modified":1542729469,"content":"https://forums.whonix.org/t/user-poll-xfce-vs-kde-kde-deprecation-considered/6235"}]},"PHID-TASK-4yxw3djopqjk6iaoyhpj":{"id":"632","title":"port msgcollector to python3 and python3-pyqt5","status":"resolved","priority":"Normal","author":"Patrick","description":"Partially done. See python3 branch of #msgcollector.\n\nhttps://github.com/Whonix/msgcollector/tree/python3\n\nfiles:\n\n* https://github.com/Whonix/msgcollector/blob/python3/usr/lib/msgcollector/msgdispatcher_dispatch_x\n* https://github.com/Whonix/msgcollector/blob/python3/usr/lib/msgcollector/generic_gui_message\n* https://github.com/Whonix/msgcollector/blob/python3/usr/lib/msgcollector/tb_updater_gui\n\nTODO:\n\n* fix the favicon\n** the favicon (the icon in the very left top in the window title) is no longer shown in any of these scripts\n\n-----\n\n[`msgdispatcher_dispatch_x`](https://github.com/Whonix/msgcollector/blob/python3/usr/lib/msgcollector/msgdispatcher_dispatch_x) TODO:\n\n* fix the `itype`\n** For example `warning` should result in an exclamation mark such as can be seen in the following [image](https://phabricator.whonix.org/file/data/a6rbjtiah3mq2gbaueuq/PHID-FILE-t4mimm654rgjl4wkr3zy/whonixcheck-qubes-whonix-updates.png).\n* port the `QtCore.QObject.connect` part?\n\n```\n        QtCore.QObject.connect(self.buttonBox, QtCore.SIGNAL(_fromUtf8(\"accepted()\")), Dialog.accept)\n        QtCore.QObject.connect(self.buttonBox, QtCore.SIGNAL(_fromUtf8(\"rejected()\")), Dialog.reject)\n```\n\n-----\n\n[tb_updater_gui](https://github.com/Whonix/msgcollector/blob/python3/usr/lib/msgcollector/tb_updater_gui) TODO:\n\n* the window is too long (exceeds the screen) but not very wide\n** should be made wider\n\n-----\n\ntest script:\n\n(Comment in/out msgdispatcher_dispatch_x / generic_gui_message / tb_updater_gui.)\n\n```\n#!/bin/bash\n\nset -e\n\ntestfunction() {\n   who_ami=user\n\n   local MSG=\"<p>Time Synchronization Result:\n<br></br><b>Whonixcheck gave up waiting.</b>\n<br></br>\n<br></br>Time synchronization status: $time_synchronization_status_word\n<br></br>sdwdate reports: $time_synchronization_msg\n<br></br>\n<br></br>Possible issues:\n<br></br>- sdwdate will need a few more moments for fetching the time.\n<br></br>- sdwdate time sources might be dysfunctional.\n<br></br>\n<br></br>Recommendations:\n<br></br>\n<br></br><b>A)</b> <u>Rerun whonixcheck</u>:\n<blockquote>$start_menu_instructions_system_first_part Whonix Check</blockquote>\nor in Terminal: <code>whonixcheck</code>\n<br></br>or in Terminal with debugging: <code>whonixcheck --debug --verbose --gui --cli</code>\n<br></br>\n<br></br><b>B)</b> <u>Restart sdwdate.</u>\n<blockquote>$start_menu_instructions_system_first_part sdwdate-gui -> right click on sdwdate-gui systray -> Restart sdwate - instantly adjust the time</blockquote>\nor in Terminal: <code>sudo service sdwdate restart</code>\n<br></br>\n<br></br><b>C)</b> <u>Manually set the time.</u>\n<br></br>\n<br></br>As last resort...\n<br></br>\n<br></br>1. Open a terminal. ($start_menu_instructions_system_first_part Terminal)\n<br></br>2. Set the clock to the correct time in UTC. (Example.) <blockquote><code>sudo date --set \\\"$anondate_suggested_date\\\"</blockquote>\n3. Simulate sdwdate success. <blockquote><code>sudo touch /var/run/sdwdate/first_success</code></blockquote>\n4. Rerun whonixcheck.</p>\"\n\n   if [ \"$MSG\" = \"\" ]; then\n      MSG=\"$msg\"\n   fi\n   if [ \"$msg\" = \"\" ]; then\n      msg=\"$MSG\"\n   fi\n\n   #../Whonix/packages/msgcollector/usr/lib/msgcollector/msgdispatcher_dispatch_x \"info\" \"test title\" \"$MSG\" 0 \"\"\n\n    #./Whonix/packages/msgcollector/usr/lib/msgcollector/generic_gui_message \"$icon\" \"$title\" \"$msg\" \"What to do?\" \"yesno\"\n\n    ./Whonix/packages/msgcollector/usr/lib/msgcollector/tb_updater_gui \"info\" \"test title\" \"none installed\" \"3,5,10.5\" \"$msg\" \"What to do?\" \"yesno\"\n\n   #MSG=\"$(./Whonix/packages/msgcollector/usr/lib/msgcollector/striphtml \"$MSG\")\"\n\n   #echo \"$MSG\"\n\n}\n\ntestfunction\n```\n","comments":[{"author":"joysn1980","date_created":1487083070,"date_modified":1487083070,"content":"https://github.com/Whonix/msgcollector/pull/2/files\n\nshould fix the issues\n\n#1 \n../Whonix/packages/msgcollector/usr/lib/msgcollector/msgdispatcher_dispatch_x \"info\" \"test title\" \"$MSG\" 0 \"\"\n\nThe last argument is for icon. So if you specify \"\", it will not show any icon.\nIf you skip the argument, icon will appear.\n\n#2 There are two commits involving 3 files.\n\n"},{"author":"Patrick","date_created":1487085799,"date_modified":1487085799,"content":"Good quality, could merge into git master and ready for Whonix 14 already.\n\nOne remaining issue. With all of them. But just a simple example for reproduction. With the package installed...\n\n    /usr/lib/msgcollector/tb_updater_gui \"info\" \"test title\" \"none installed\" \"3,5,10.5\" \"$msg\" \"What to do?\" \"yesno\"\n\nAlso having https://github.com/Whonix/anon-icon-pack installed (on a Debian stretch system)...  So `/usr/share/icons/anon-icon-pack/whonix.ico` does exist. Yet, the favicon is not showed in the window title bar."},{"author":"joysn1980","date_created":1487086801,"date_modified":1487086801,"content":"Something strange. I can see it in my VM\n\n{F155039}\n\nCan you share your screen shot?"},{"author":"Patrick","date_created":1487087823,"date_modified":1487087823,"content":"Looks good on your side. Possibly a #Qubes bug. I'll look into it in the next developers build."}]},"PHID-TASK-v2u73doj6tua7zbwcljn":{"id":"631","title":"re-enable tor-controlport-filter.service systemd hardening","status":"resolved","priority":"Normal","author":"Patrick","description":"* https://github.com/Whonix/onion-grater/blob/master/lib/systemd/system/onion-grater.service\n* ( upstream: https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/lib/systemd/system/onion-grater.service )\n\nRelated:\nT362","comments":[{"author":"Patrick","date_created":1487008252,"date_modified":1487008252,"content":"Since you originally added this, do you think you could re-invent it? @HulaHoop "},{"author":"HulaHoop","date_created":1487014184,"date_modified":1487014184,"content":"As in the seccomp stuff? I think I can but can you help me find the original topic so I can re-create the testing environment I used back then?"},{"author":"Patrick","date_created":1487014947,"date_modified":1487014947,"content":">>! In T631#12242, @HulaHoop wrote:\n> As in the seccomp stuff?\n\nYes.\n\n> I think I can but can you help me find the original topic so I can re-create the testing environment I used back then?\n\nhttps://forums.whonix.org/t/cpfpd-data-options-control-port-filter-python-hardening / T128?\n"},{"author":"HulaHoop","date_created":1487032897,"date_modified":1487032897,"content":"As soon as the next dev release (with the working KDE menus) is out I'll build it and start working."},{"author":"Patrick","date_created":1487034824,"date_modified":1487034824,"content":"Yes, that would be great and there is still time until the final release."},{"author":"JasonJAyalaP","date_created":1497989929,"date_modified":1497989929,"content":"@Patrick \nWhat do we need for the next dev release for hula?\n\nAre the kde menus things one of the open v14 tickets?"},{"author":"Patrick","date_created":1498126042,"date_modified":1498126042,"content":">>! In T631#13769, @JasonJAyalaP wrote:\n> @Patrick \n> What do we need for the next dev release for hula?\n\nI guess 14.0.0.2.6 should work.\n\nCan you use https://forums.whonix.org/t/whonix-14-0-0-2-6-developers-only @HulaHoop?\n\n> Are the kde menus things one of the open v14 tickets?\n\nThe \"no KDE start menu at all\" bug was solved in 14.0.0.2.6.\n\nRemaining KDE work T636 and T633 aren't blockers to implement this ticket."},{"author":"HulaHoop","date_created":1498349130,"date_modified":1498349130,"content":"I haven't tested it yet and unfortunately I'm very busy these days, so cpfp apparmor work is up for grabs."},{"author":"JasonJAyalaP","date_created":1498466699,"date_modified":1498467434,"content":"@Patrick \n\nUsing the hardening broke Tails? What do you mean?\n\n*EDIT*\n\nDo you mean we ported it from Tails to Whonix?\n\nMy understanding:\n\n\n  # Using SystemCallFilter enables a whitelist. The current whitelist isn't inclusive enough (that's the funny thing about whitelists!). And so all the lines with SystemCallFilter are commented out.\n  # I'm not sure what the other commented out lines are for.\n  # We need to find all the system calls that onion grater needs and add them with SystemCallFilter.\n\n"},{"author":"Patrick","date_created":1498476821,"date_modified":1498476821,"content":">>! In T631#13827, @JasonJAyalaP wrote:\n> Do you mean we ported it from Tails to Whonix?\n\n- control-port-filter-python (Whonix 13 version, will be obsoleted/not used(legacy in Whonix 14) was written by @troubadour.\n- onion-grater was written by @anonym of Tails.\n- Whonix 14 will be using onion-grater which works great.\n\n> My understanding:\n> \n> \n>   # Using SystemCallFilter enables a whitelist. The current whitelist isn't inclusive enough (that's the funny thing about whitelists!). And so all the lines with SystemCallFilter are commented out.\n\nCorrect. I did this as a quick fix so onion-grater integration of Whonix could be finished (done).\n\n>   # I'm not sure what the other commented out lines are for.\n\nThey are all related to hardening.\n\n>   # We need to find all the system calls that onion grater needs and add them with SystemCallFilter.\n\nYes."},{"author":"JasonJAyalaP","date_created":1498581490,"date_modified":1498581508,"content":"Tails didn't feel the need to use system call filtering?"},{"author":"Patrick","date_created":1498601472,"date_modified":1498601472,"content":"They happily take it if we contribute it."},{"author":"JasonJAyalaP","date_created":1498870834,"date_modified":1498870834,"content":"Question: To install OG in whonix 14 dev, so I simply pull the repo, make deb-icup, stop the old tor control port filter proxy, and start onion grater?"},{"author":"Patrick","date_created":1498903532,"date_modified":1498903532,"content":"Should be even easier since onion-grater `debian/control` contains\n`Replaces: control-port-filter-python`. So just installing onion-grater\nshould do."},{"author":"JasonJAyalaP","date_created":1499295136,"date_modified":1499295136,"content":"sudo service onion-grater status just tells me that it failed to load. Any clues about how to debug this?"},{"author":"Patrick","date_created":1499355509,"date_modified":1499355509,"content":"See:\n\n    sudo journalctl -u onion-grater\n\nOr watch it while it's happening.\n\n    sudo journalctl -f -u onion-grater\n\nAnd in another tab.\n\n    sudo systemctl restart onion-grater\n\nDoes that show something useful?\n\nTwo network interfaces are available? eth0 and eh1?\n\nReplicate what\nhttps://github.com/Whonix/onion-grater/blob/master/lib/systemd/system/onion-grater.service\ndoes.\n\n    sudo -u onion-grater /usr/lib/onion-grater\n\nDoes that show something useful?"},{"author":"JasonJAyalaP","date_created":1499453129,"date_modified":1499459885,"content":"Python is choking on the line:\nserver = FilteredControlPortProxy(address, FilteredControlPortProxyHandler)\n\n```\nJul 07 18:32:17 host systemd[1]: Starting Tor control port filter proxy...\nJul 07 18:32:18 host onion-grater[8129]: Traceback (most recent call last):\nJul 07 18:32:18 host onion-grater[8129]:   File \"/usr/lib/onion-grater\", line 770, in <module>\nJul 07 18:32:18 host onion-grater[8129]:     main()\nJul 07 18:32:18 host onion-grater[8129]:   File \"/usr/lib/onion-grater\", line 759, in main\nJul 07 18:32:18 host onion-grater[8129]:     server = FilteredControlPortProxy(address, FilteredControlPortProxyHandler)\nJul 07 18:32:18 host onion-grater[8129]:   File \"/usr/lib/python3.5/socketserver.py\", line 440, in __init__\nJul 07 18:32:18 host onion-grater[8129]:     self.server_bind()\nJul 07 18:32:18 host onion-grater[8129]:   File \"/usr/lib/python3.5/socketserver.py\", line 454, in server_bind\nJul 07 18:32:18 host onion-grater[8129]:     self.socket.bind(self.server_address)\nJul 07 18:32:18 host onion-grater[8129]: socket.gaierror: [Errno -3] Temporary failure in name resolution\nJul 07 18:32:18 host systemd[1]: onion-grater.service: Main process exited, code=exited, status=1/FAILURE\nJul 07 18:32:18 host systemd[1]: Failed to start Tor control port filter proxy.\nJul 07 18:32:18 host systemd[1]: onion-grater.service: Unit entered failed state.\nJul 07 18:32:18 host systemd[1]: onion-grater.service: Failed with result 'exit-code'.\n```\n\nI noticed that the serive tor-control-port-filter is running (stopping it doesnt make a difference). This is normal?"},{"author":"Patrick","date_created":1499603928,"date_modified":1499603928,"content":"Probably tor-controlport-filter systemd unit file (the old one) still\nrunning and blocking the onion-grater systemd unit file.\n\nJasonJAyalaP (Jason J. Ayala P.):\n> I noticed that the serive tor-control-port-filter is running\n> (stopping it doesnt make a difference). This is normal?\n\nNot normal. That should be removed during the upgrade.\n\n`onino-grater`'s `debian/control` uses `Replaces:\ncontrol-port-filter-python`. That should do. That should remove the\ncontrol-port-filter-python package, stops the old tor-controlport-filter\nsystemd unit file. But I don't remember if I tested this."},{"author":"JasonJAyalaP","date_created":1499807465,"date_modified":1499807465,"content":"sudo service tor-controlport-filter stop\nsudo service onion-grater start\nsame failure\nif i try \nsudo apt-get remove control-port-filter-python\nIt wants to remove everything. I don't think 'Replaces' worked."},{"author":"Patrick","date_created":1499811237,"date_modified":1499811237,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n>   sudo apt-get remove control-port-filter-python\n>   It wants to remove everything. I don't think 'Replaces' worked.\n\nMigration issue.\n\nSelective upgrading of individual packages without using `apt-get`, by\nonly using `dpkg` is hard.\n\ncontrol-port-filter-python cannot be removed because some\nanon-meta-package still depends on it - you probably didn't update\n`anon-meta-packages`.\n\nIt would probably work if you updated from rebuild local or remote\nrepository.\n\n>   sudo service tor-controlport-filter stop\n>   sudo service onion-grater start\n\nPossibly also a migration issue. Not clear to my why that isn't working.\nPossibly due to anon-gw-anonyminizer changes. So many things have\nchanged since.\n\nStill something listening on that local port? Check `sudo netstal -tulpen`.\n\nMaybe not a great idea to attempt selective package upgrades from this\nstate. All packages that changed in meanwhile should be rebuild and\nreinstalled getting to a newer developers-only state. Either using the\nlocal or a remote repository. A local one certainly goes faster during\ndebugging."},{"author":"JasonJAyalaP","date_created":1499815543,"date_modified":1499815543,"content":"> sudo netstal -tulpen\n\nPort 9051 right? It's listening with python running, and nothing is listening when it's stopped\n\n> It would probably work if you updated from rebuild local or remote repository.\n\nThe whole system update thing you're writing about on the wiki? Maybe it's time for another Whonix Developers 14 version?"},{"author":"Patrick","date_created":1499815963,"date_modified":1499815963,"content":"All yes."},{"author":"Patrick","date_created":1561278464,"date_modified":1561278464,"content":"https://github.com/Whonix/onion-grater/compare/master...madaidan:patch-1\n\nhttps://raw.githubusercontent.com/madaidan/onion-grater/aecc6035490fb3b6cd5f1bb768e892344e12dff8/lib/systemd/system/onion-grater.service\n\nDoes not work yet. @madaidan\n\n    sudo systemctl daemon-reload\n\n    sudo systemctl restart onion-grater.service\n\n> Job for onion-grater.service failed because a fatal signal was delivered to the control process.\n> See \"systemctl status onion-grater.service\" and \"journalctl -xe\" for details.\n\n    sudo journalctl -f\n\n```\nJun 23 08:19:16 host systemd[1]: Starting Tor control port filter proxy...\nJun 23 08:19:16 host audit[5071]: SECCOMP auid=4294967295 uid=107 gid=113 ses=4294967295 subj==/usr/lib/onion-grater (enforce) pid=5071 comm=\"onion-grater\" exe=\"/usr/bin/python3.7\" sig=31 arch=c000003e syscall=257 compat=0 ip=0x744b70eb64fd code=0x0\nJun 23 08:19:16 host audit[5071]: ANOM_ABEND auid=4294967295 uid=107 gid=113 ses=4294967295 subj==/usr/lib/onion-grater (enforce) pid=5071 comm=\"onion-grater\" exe=\"/usr/bin/python3.7\" sig=31 res=1\nJun 23 08:19:16 host systemd[1]: onion-grater.service: Main process exited, code=killed, status=31/SYS\nJun 23 08:19:16 host systemd[1]: onion-grater.service: Failed with result 'signal'.\nJun 23 08:19:16 host systemd[1]: Failed to start Tor control port filter proxy.\n```"},{"author":"madaidan","date_created":1561300268,"date_modified":1561300268,"content":"Does it work using [this](https://raw.githubusercontent.com/madaidan/onion-grater/patch-1/lib/systemd/system/onion-grater.service)? It looks like it needs the openat syscall which it now allows.\n\nWeirdly, I didn't get an error with it on a fresh install of Whonix."},{"author":"Patrick","date_created":1561312422,"date_modified":1561312422,"content":"Unfortunately not. On Qubes-Whonix. Could be Non-Qubes-Whonix vs\nQubes-Whonix?\n\n```\nJun 23 17:51:58 host systemd[1]: Starting Tor control port filter proxy...\nJun 23 17:51:58 host systemd[9899]: onion-grater.service: Failed to set\nup mount namespacing: No such file or directory\nJun 23 17:51:58 host systemd[9899]: onion-grater.service: Failed at step\nNAMESPACE spawning /usr/lib/onion-grater-merger: No such file or directory\nJun 23 17:51:58 host systemd[1]: onion-grater.service: Control process\nexited, code=exited, status=226/NAMESPACE\nJun 23 17:51:58 host systemd[1]: onion-grater.service: Failed with\nresult 'exit-code'.\nJun 23 17:51:58 host systemd[1]: Failed to start Tor control port filter\nproxy.\nJun 23 17:51:58 host audit[1]: SERVICE_START pid=1 uid=0 auid=4294967295\nses=4294967295 subj==unconfined msg='unit=onion-grater comm=\"systemd\"\nexe=\"/usr/lib/systemd/systemd\" hostname=? addr=? terminal=? res=failed'\nJun 23 17:51:58 host sudo[9894]: pam_unix(sudo:session): session closed\nfor user root\nJun 23 17:51:58 host audit[9894]: USER_END pid=9894 uid=0\nauid=4294967295 ses=4294967295 subj==unconfined\nmsg='op=PAM:session_close grantors=pam_permit,pam_unix acct=\"root\"\nexe=\"/usr/bin/sudo\" hostname=? addr=? terminal=/dev/pts/1 res=success'\nJun 23 17:51:58 host audit[9894]: CRED_DISP pid=9894 uid=0\nauid=4294967295 ses=4294967295 subj==unconfined msg='op=PAM:setcred\ngrantors=pam_permit acct=\"root\" exe=\"/usr/bin/sudo\" hostname=? addr=?\nterminal=/dev/pts/1 res=success'\nJun 23 17:51:59 host audit[1]: SERVICE_START pid=1 uid=0 auid=4294967295\nses=4294967295 subj==unconfined msg='unit=onion-grater comm=\"systemd\"\nexe=\"/usr/lib/systemd/systemd\" hostname=? addr=? terminal=? res=success'\nJun 23 17:51:59 host audit[1]: SERVICE_STOP pid=1 uid=0 auid=4294967295\nses=4294967295 subj==unconfined msg='unit=onion-grater comm=\"systemd\"\nexe=\"/usr/lib/systemd/systemd\" hostname=? addr=? terminal=? res=success'\nJun 23 17:51:59 host systemd[1]: onion-grater.service: Service\nRestartSec=100ms expired, scheduling restart.\nJun 23 17:51:59 host systemd[1]: onion-grater.service: Scheduled restart\njob, restart counter is at 1.\nJun 23 17:51:59 host systemd[1]: Stopped Tor control port filter proxy.\n```"},{"author":"madaidan","date_created":1561314299,"date_modified":1561314299,"content":"Does it work after you comment `ProtectSystem=strict` and `ReadWriteDirectories=`? I think on Qubes-Whonix it is trying to write to a directory in /var/run (probably /var/run/qubes-service). I can't test as I don't use Qubes.\n\nIf it does work, try adding /var/run/qubes-service to the end of the `ReadWriteDirectories=` string and restarting it with those options uncommented.\n\nIf that doesn't work, try commenting `SystemCallFilter=`."},{"author":"Patrick","date_created":1561968703,"date_modified":1561968703,"content":"Merged your changes.\n\nhttps://github.com/Whonix/onion-grater/pull/3\n\nhttps://github.com/Whonix/onion-grater/blob/master/lib/systemd/system/onion-grater.service\n\nHad to add some syscalls.\n\nHad to comment out ProtectSystem=strict and ReadWriteDirectories= indeed.\n\nhttps://github.com/Whonix/onion-grater/commit/df49bbe15ef0a0589eb83a9a16592644a31b955f\n\nOtherwise it would fail with the following:\n\n> Jul 01 07:59:59 host systemd[3378]: onion-grater.service: Failed to set up mount namespacing: No such file or directory\n> Jul 01 07:59:59 host systemd[3378]: onion-grater.service: Failed at step NAMESPACE spawning /usr/lib/onion-grater-merger: No such file or directory\n\n----\n\n>>! In T631#18621, @madaidan wrote:\n> I think on Qubes-Whonix it is trying to write to a directory in /var/run (probably /var/run/qubes-service). I can't test as I don't use Qubes.\n\nNothing that onion-grater is doing writes to either.\n\nIt needs to read:\n\n```\nDEFAULT_COOKIE_PATH = '/run/tor/control.authcookie'\nDEFAULT_CONTROL_SOCKET_PATH = '/run/tor/control'\n```\n"},{"author":"madaidan","date_created":1562165787,"date_modified":1562165787,"content":"That's  weird. Onion-grater is trying to write to somewhere that's being mounted read-only by systemd.\n\nDoes `ProtectSystem=full` work? If so, we can use that to mount some areas of the filesystem read-only. It isn't as complete as `ProtectSystem=strict` would be though."},{"author":"madaidan","date_created":1562166634,"date_modified":1562166634,"content":"I just re-read the error message. Try adding\n\n```\nProtectSystem=strict\nReadWriteDirectories=/usr/lib/onion-grater-merger\n```"},{"author":"Patrick","date_created":1562218900,"date_modified":1562218900,"content":"madaidan (madaidan):\n>     ReadWriteDirectories=/usr/lib/onion-grater-merger\n\n\nIt's a file, not a folder. Nothing in the code of\n/usr/lib/onion-grater-merger writes to /usr/lib/onion-grater-merger."},{"author":"Patrick","date_created":1562219939,"date_modified":1562219939,"content":"https://github.com/Whonix/onion-grater/commit/8480cff304ea019b25dc49d91672e7c3f8599a07"},{"author":"madaidan","date_created":1562252974,"date_modified":1562252974,"content":"> It's a file, not a folder.\n\nThen use `ReadWritePaths=/usr/lib/onion-grater-merger` instead.\n\n> Nothing in the code of /usr/lib/onion-grater-merger writes to /usr/lib/onion-grater-merger.\n\nIt probably tries to create it which is counted as writing."},{"author":"Patrick","date_created":1562410981,"date_modified":1562410981,"content":"https://github.com/Whonix/onion-grater/blob/master/lib/systemd/system/onion-grater.service currently works without `ReadWritePaths`. So let's not add?\n\nAlso while /usr/lib/onion-grater-merger is executed, there is no source code in /usr/lib/onion-grater-merger that would write to /usr/lib/onion-grater-merger. \n\nEven there is no source code to read /usr/lib/onion-grater-merger except if execution by systemd itself also required read permission."},{"author":"madaidan","date_created":1562423036,"date_modified":1562423036,"content":"> https://github.com/Whonix/onion-grater/blob/master/lib/systemd/system/onion-grater.service currently works without ReadWritePaths. So let's not add?\n\nIt uses `ProtectSystem=full` which only mounts /usr, /boot and /etc as read-only. Using `ProtectSystem=strict` will mount the entire filesystem as read-only except API filesystems.\n\nIt would be better to use `strict` and find out which files exactly it needs and make only those read-write."},{"author":"Patrick","date_created":1562536239,"date_modified":1562536239,"content":"Error back after reboot.\n\n```\nJul 07 21:32:22 host systemd[23920]: onion-grater.service: Failed to set up mount namespacing: No such file or directory\nJul 07 21:32:22 host systemd[23920]: onion-grater.service: Failed at step NAMESPACE spawning /usr/lib/onion-grater-merger: No such file or directory\n```\n\nThe reason why I can reproduce this might be because Qubes starts with clean root image /run, /etc and so forth. Each start of onion-grater is like starting onion-grater for the first time. (Since onion-grater in AppVM which has only persistent /home [...] while onion-grater never starts in TemplateVM.\n\n`ReadWriteDirectories=/etc/onion-grater.d/` is bad anyhow.\nNot onion-grater (the network daemon) is writing there.\nOnly the `ExecStartPre=/usr/lib/onion-grater-merger` (which generates from onion-grater-merger.d config folders the `/etc/onion-grater.d/30_autogenerated.yml` config file). onion-grater-merger is an offline tool.\n\nCan we exclude `ExecStartPre=/usr/lib/onion-grater-merger` from systemd hardening?"},{"author":"Patrick","date_created":1562539993,"date_modified":1562539993,"content":"> Can we exclude ExecStartPre=/usr/lib/onion-grater-merger from systemd hardening?\n\nYes.\n\nhttps://github.com/Whonix/whonix-gw-network-conf/commit/95198d2d8916b6e34675876320404bb970720cb1\nhttps://github.com/Whonix/whonix-gw-network-conf/commit/dfdf6c776bb153f4f529277287d131449d3775dc\n\nThat helps.\n\n----\n\nIt's really hard to debug if systemd does not say that actual folder which is missing. Someone reported a bug for this issue:\n\nhttps://github.com/systemd/systemd/issues/12974"},{"author":"Patrick","date_created":1562540807,"date_modified":1562540807,"content":"Yay, we have `ProtectSystem=strict` now.\n\nhttps://github.com/Whonix/onion-grater/blob/master/lib/systemd/system/onion-grater.service\n\nCould you please \"reboot\" `SystemCallFilter`? Empty it and repopulate from scratch? Now that onion-grater-merger is unconfined, onion-grater will need a lot less syscalls."},{"author":"madaidan","date_created":1562610618,"date_modified":1562610618,"content":"> Yay, we have ProtectSystem=strict now.\n\nGreat!\n\n> Could you please \"reboot\" SystemCallFilter? Empty it and repopulate from scratch? Now that onion-grater-merger is unconfined, onion-grater will need a lot less syscalls.\n\nThe original list was gotten via `strace -cf /usr/lib/onion-grater` which didn't include syscalls for onion-grater-merger anyway. Removing the syscalls added with this [commit](https://github.com/Whonix/onion-grater/commit/df49bbe15ef0a0589eb83a9a16592644a31b955f) and the `openat` syscall should be all we need. We probably won't need to remove anything anyway."},{"author":"Patrick","date_created":1562615357,"date_modified":1562615357,"content":"Removed a few. Would not start without `openat`, so kept.\n\nhttps://github.com/Whonix/onion-grater/commit/630e6bd0a2423cdf6a430439b538d88cac9da155"}]},"PHID-TASK-5ypghlijurqrjpnp26fl":{"id":"630","title":"Disabling Baloo file indexer","status":"wontfix","priority":"Low","author":"HulaHoop","description":"Repost:\n\nAutomated browser downloads + bug ridden FS indexing parsers like KDE Baloo are a serious threat to systems and a really easy way to mount RCEs on desktops.\n\nAFAIK Baloo is disabled by default but I'm not sure. Can you confirm that it is if its not the case? and of course we need to keep an eye out for it on Whonix Stretch.\n\nhttps://phoronix.com/scan.php?page=news_item&px=Linux-Desktop-Win10-Security1\nhttps://fosdem.org/2017/schedule/event/linux_desktop_versus_windows10/attachments/slides/1730/export/events/attachments/linux_desktop_versus_windows10/slides/1730/fosdem_linux_desktop_security.pdf","comments":[{"author":"HulaHoop","date_created":1492111409,"date_modified":1492111409,"content":"https://community.kde.org/Baloo/Configuration"},{"author":"JasonJAyalaP","date_created":1497641658,"date_modified":1497641810,"content":"It appears that baloo is disabled by default. On a fresh WS:\n```\nbalooctl status\n```\nit says disabled.\n\n\nBaloo is installed by default in both GW and WS\n\nIf baloo shouldn't be on by default in Whonix, then lets not include the baloo package (and 2 dependencies?) at all.\n\n```\ndpkg -l | baloo\n```\n\nHmm but apt-get remove shows that dolphin and some whonix packages (??) depend on it."},{"author":"Patrick","date_created":1497642061,"date_modified":1497642071,"content":"Whonix does not depend on `baloo` directly. It's a dependency of `dolphin`. Therefore cannot be avoided.\n\n```\nreverse-depends baloo-kf5\n```\n\nTODO:\n\n* add a new whonixcheck test that tests if baloo is disabled and warns if it is enabled (now or later)\n* or lazy reassign the ticket to #debian_version_10_codename_buster so we manually recheck then\n"},{"author":"JasonJAyalaP","date_created":1497648587,"date_modified":1497648587,"content":"It's off by default. If someone enables it by choice, should we warn them to turn it off? Warn them that it's another attack vector? Is it a big enough security risk? whonixcheck shouldn't be in charge of checking and warning the user about most modifications they make that may be attack vectors.\n\nCompromise: Kick the problem to deb 10 and see if they've turned it on by default. Worry about it then."},{"author":"Patrick","date_created":1497655067,"date_modified":1497655067,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> JasonJAyalaP added a comment.\n> \n> \n> It's off by default. If someone enables it by choice, should we warn\n> them to turn it off? Warn them that it's another attack vector? Is it\n> a big enough security risk?\n\nGood question. My idea was to make sure it stays disabled in Debian 10\nbased Whonix later on. Perhaps that doesn't belong into whonixcheck but\nwould more be part of an automated test suite.\n\n> Compromise: Kick the problem to deb 10 and see if they've turned it\n> on by default. Worry about it then.\n\nRight."},{"author":"Patrick","date_created":1542729587,"date_modified":1542729587,"content":"https://forums.whonix.org/t/user-poll-xfce-vs-kde-kde-deprecation-considered/6235"}]},"PHID-TASK-srp7d6ckduruuyel7ciq":{"id":"629","title":"fix sdwdate sigterm handling during remote_times.py get_time_from_servers","status":"open","priority":"Normal","author":"Patrick","description":"When sdwdate is inside the threads loop in function `get_time_from_servers` from file `remote_times.py`, signal sigterm does not lead to sdwdate terminating.\n\nhttps://github.com/Whonix/sdwdate/blob/master/usr/lib/python3/dist-packages/sdwdate/remote_times.py\n\n`signal_sigterm_handler` is triggered, but `sys.exit(143)` is without effect.\n\nApparently that is to be expected.\n\nhttp://stackoverflow.com/questions/905189/why-does-sys-exit-not-exit-when-called-inside-a-thread-in-python\n\nTODO:\n\n* Shut terminate all eventually running threads and exit.\n\n\nHow to reproduce? \n\n```\n#!/bin/bash\nset -x\n\ncd ~/Whonix/packages/sdwdate\nsudo make install\nsudo -u sdwdate sdwdate &\n\nsdwdate_pid=\"$!\"\n\nsleep 1\n\nsudo kill -sigterm \"$sdwdate_pid\"\n\nwait \"$sdwdate_pid\"\ntrue $?\n```\n\nThe signal must send during.\n\n> Requested urls ['x.onion', 'y.onion', 'z.onion']\n\nI.e. signal must send during gevent.wait().","comments":[{"author":"Patrick","date_created":1486995887,"date_modified":1486995887,"content":"https://github.com/Whonix/sdwdate/commit/429b0156c8242e2353f5c1d64406f829f90c4168 by @joysn1980 helped a lot. Showed be the correct place where to implement this.\n\nhttps://github.com/Whonix/sdwdate/commit/66341d6b3232f3f812b0ac3ebd6f49a7928c543f\n\nMaybe not the cleanest implementation. Help welcome.\n\nCan we call `/usr/bin/sdwdate`'s `exit_handler()` directly from `remotes.py`?"},{"author":"Patrick","date_created":1488402646,"date_modified":1488402646,"content":"A python coding question. These two code blocks.\n\n- `/usr/lib/python3/dist-packages/sdwdate/remote_times.py` excerpt: https://github.com/Whonix/sdwdate/blob/46118bba0096a2691c016f7a2f69ac60c7ece21d/usr/bin/sdwdate#L153-L154\n- `/usr/bin/sdwdate` function `check_remote` excerpt: https://github.com/Whonix/sdwdate/blob/f80f39dad6da3829b01f1b5e3c668f5d26e47a3e/usr/lib/python3/dist-packages/sdwdate/remote_times.py#L33-L53\n\nMy implementation is a bit weird. Can we call `/usr/bin/sdwdate`'s `exit_handler()` directly from `remotes.py`? @marmarek "},{"author":"marmarek","date_created":1488405888,"date_modified":1488405888,"content":"Where the other thread is created? For me it looks like `get_time_from_servers` is running in the main thread, so simply not catching `SystemExit` should be enough. At the point where it was raised, you already called `sys.exit` (which is how `SystemExit` is raised), so `exit_handler` was already called.\n\nIf I'm mistaken about this, and it's running in non-main thread, you may want to use https://docs.python.org/3/library/threading.html#event-objects instead, and check it in main loop. Something like:\n\n```\nexit_event = threading.Event()\n\n...\n\nif exit_event.is_set():\n  sys.exit(143)\n\n```\nAnd from the other thread:\n\n```\nexit_event.set()\n```"},{"author":"marmarek","date_created":1488406182,"date_modified":1488406182,"content":"Also, Python >= 3.4 comes with great API for concurrent execution - asyncio - much more powerful version of asyncore. In this case it could be used to avoid threads at all. But I'm still learning how to use it... You may want to read/watch this: https://fosdem.org/2017/schedule/event/python_coroutines/ if you want quick intro."}]},"PHID-TASK-77itzdo7m6w5ybs3uq2h":{"id":"628","title":"port whonix-setup-wizard to python3","status":"resolved","priority":"Normal","author":"Patrick","description":"Now that #python-guimessages was ported to python3, https://github.com/Whonix/whonix-setup-wizard also needs to be ported since it is currently broken due to python-guimessages changes.","comments":[{"author":"joysn1980","date_created":1486706601,"date_modified":1486706601,"content":"https://github.com/joysn/whonix-setup-wizard/commit/2b0949b850c16bc18c74d8128622ac3adc139027\nhttps://github.com/joysn/whonix-setup-wizard/commit/855e836f80712a6dae078d52862ef2529752b4a1\n\n//Wanted to do all changes in one commit, somehow while doing git add some files were left.//\n\n**Tested using [After taking the latest files from translations.py and guimessage.py]**\n\n\n```\nsudo python3 whonix-setup-wizard -h\nsudo python3 whonix-setup-wizard setup\nsudo python3 whonix-setup-wizard quick\nsudo python3 whonix-setup-wizard repository\nsudo python3 whonix-setup-wizard locale_settings\n\nsudo python3 whonix_setup_wizard.py -h\nsudo python3 whonix_setup_wizard.py setup\nsudo python3 whonix_setup_wizard.py quick\nsudo python3 whonix_setup_wizard.py repository\nsudo python3 whonix_setup_wizard.py locale_settings\n\npython3 tor_status.py\npython3 whonix-setup-wizard-repository\npython3 whonixsetup_check_for_start\npython3 whonix-setup-wizard-setup\n```"},{"author":"Patrick","date_created":1486739633,"date_modified":1486739633,"content":"Great work! Merged and added some packaging / python3 related fixes on top."}]},"PHID-TASK-qtx5ljkfw3rpm36rkpjp":{"id":"627","title":"port python-guimessages to python3","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/python-guimessages","comments":[{"author":"joysn1980","date_created":1486657552,"date_modified":1486657552,"content":"This is done\nhttps://github.com/joysn/python-guimessages/commit/4929f6546e32f7f4279f5166d58832cc95c1a063\n"},{"author":"Patrick","date_created":1486663785,"date_modified":1486663785,"content":"Merged. Added some packaging related fixes on top. Otherwise sdwdate would not start.\n\nPlease merge and install the newer version.\n\nNot sure it's done. It depends finishing T624 and T628."},{"author":"Patrick","date_created":1486679403,"date_modified":1486679403,"content":"https://github.com/Whonix/python-guimessages/commit/bb890789e2bff97999eea7252b6b16e9100aa9c0"}]},"PHID-TASK-m4wruhimy3o7lsl4yuz2":{"id":"626","title":"sdwdate-gui right click menu locks up","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/sdwdate-gui/blob/master/usr/lib/python3/dist-packages/sdwdate_gui/sdwdate_gui.py\n\n(As discussed in T598.)\n\nissue:\nsdwdate-gui -> right click \"restart\" -> right click \"restart\" another time -> right click now ignored\n","comments":[{"author":"joysn1980","date_created":1486646278,"date_modified":1486646278,"content":"Let me give this a try, but probably once I am done with the porting of all the sdwdate/sdwdate-gui scripts to python3"},{"author":"joysn1980","date_created":1486646310,"date_modified":1486646310,"content":"In-between, if anyone, else wants to give this a try, are welcome to do so"},{"author":"joysn1980","date_created":1487154850,"date_modified":1487154850,"content":"https://github.com/joysn/sdwdate-gui/commit/7e047fe294138cc01abde44e287081eccdb240e2\n\nShould fix the right click menu freeze issue"},{"author":"Patrick","date_created":1487168718,"date_modified":1487168718,"content":"Awesome! Works for me. Merged."}]},"PHID-TASK-nxg2hdrll7o66fdyihiz":{"id":"625","title":"python-guimessages guimessage.py breaks on default locales settings LANG=POSIX LANG=C","status":"resolved","priority":"Normal","author":"Patrick","description":"This recently happened to me due to an `update-locales` / `locales` issue.\n\nhttps://github.com/Whonix/python-guimessages/blob/master/usr/share/pyshared/guimessages/guimessage.py has a bug.\n\nHow to reproduce:\n\n```\nsudo LANG=POSIX usr/bin/sdwdate\n```\n\n```\nsdwdate started. PID 922\nTraceback (most recent call last):\n  File \"usr/bin/sdwdate\", line 548, in <module>\n    sdwdate = Sdwdate()\n  File \"usr/bin/sdwdate\", line 108, in __init__\n    translation = _translations(translations_path, 'sdwdate')\n  File \"/usr/lib/python2.7/dist-packages/guimessages/translations.py\", line 17, in __init__\n    language = locale.getdefaultlocale()[0].split('_')[0]\nAttributeError: 'NoneType' object has no attribute 'split'\n```\n\nAlso broken with another legitimate `LANG` value of `C`.\n\n    sudo LANG=C usr/bin/sdwdate\n\nIn these cases it should rather fall back to some sane default, i.e. en/us, i.e. as if running `sudo LANG=en_US.UTF-8 usr/bin/sdwdate`.","comments":[{"author":"joysn1980","date_created":1486568183,"date_modified":1486568183,"content":"https://github.com/joysn/python-guimessages/tree/master/usr/share/pyshared/guimessages\n\nShould fix this issue"},{"author":"Patrick","date_created":1486586763,"date_modified":1486586763,"content":"That one is fixed.\n\nBut guimessage.py is still not very robust.\n\n```\nsudo LANG=de_DE usr/bin/sdwdate\n```\n```\nsdwdate started. PID 17548\nTor socks host: 127.0.0.1  Tor socks port: 9050\nPrerequisite check: ok.\nFetching remote times, start Wed Feb 08 20:27:23 UTC 2017 (unixtime 1486585643.73)\nTraceback (most recent call last):\n  File \"usr/bin/sdwdate\", line 559, in <module>\n    icon, status = sdwdate.sdwdate_loop()\n  File \"usr/bin/sdwdate\", line 327, in sdwdate_loop\n    time_sanity_check = self.time_sanity_check(current_unixtime)\n  File \"usr/bin/sdwdate\", line 171, in time_sanity_check\n    self.message = (self._('tsc_1') + status + self._('tsc_2') + time_one)\n  File \"/usr/lib/python2.7/dist-packages/guimessages/translations.py\", line 36, in gettext\n    return self.language.get(key, None)\nAttributeError: 'str' object has no attribute 'get'\n```\n\nThat results in a chain reaction in Whonix 14 btw. sdwdate does not start, therefore not succeed, therefore the firewall won't allow full network access, therefore networking will be broken.\n\nDo you think you could make this more robust? I.e. in these cases rather than failing default back to `en`?"},{"author":"Patrick","date_created":1486591003,"date_modified":1486591003,"content":"I cooked something up...\n\n* https://github.com/Whonix/python-guimessages/blob/master/usr/share/pyshared/guimessages/translations.py\n* https://github.com/Whonix/python-guimessages/commit/52f21c1846035719396a7360eb1eef9be20c4c84\n\nCan you please check? And sanity / prettify anything I might have messed up?"},{"author":"joysn1980","date_created":1486619648,"date_modified":1486619648,"content":"Thanks Patrick. No comments from my end."}]},"PHID-TASK-3n4osotns5dxuxbcgbwo":{"id":"624","title":"port sdwdate, sdwdate-gui to python3","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"HulaHoop","date_created":1486495241,"date_modified":1486495241,"content":"@joysn1980 You're awesome. "},{"author":"joysn1980","date_created":1486535663,"date_modified":1486535663,"content":"Thanks @HulaHoop \n\nhttps://phabricator.whonix.org/T598 have the changes.\nhttps://github.com/joysn/sdwdate-gui/tree/master/usr/lib/python3.4/dist-packages/sdwdate_gui"},{"author":"joysn1980","date_created":1486634516,"date_modified":1486638436,"content":"I am trying to list down the files that needs conversion\n\n/usr/lib/python3/dist-packages/sdwdate_gui/sdwdate_gui.py\n\n/usr/lib/python3/dist-packages/sdwdate/config.py\n/usr/lib/python3/dist-packages/sdwdate/proxy_settings.py\n/usr/lib/python3/dist-packages/sdwdate/remote_times.py\n/usr/lib/python3/dist-packages/sdwdate/timesanitycheck.py\n\n/usr/share/sdwdate/get_time_from_servers_test\n/usr/share/sdwdate/unit_test\n\n/usr/bin/sdwdate\n/usr/bin/sdwdate-gui\n\n/usr/lib/sdwdate/url_to_unixtime\n\nAre there any other files/path involved here?\n\nI do not think it is correct to take up python-guimessages here in this ticket. It is not related to sdwdate/sdwdate-gui. They should be handled separately.\n"},{"author":"joysn1980","date_created":1486636300,"date_modified":1486636300,"content":"Infact, these files itself needs quite a lot of work to convert into python3. It is probably not just changing the shebang.\nIt requires new modules to be installed, changes in those modules needs to be incorporated too. So modularizing the work will help me."},{"author":"joysn1980","date_created":1486647098,"date_modified":1486647098,"content":"https://github.com/joysn/sdwdate/blob/master/usr/lib/sdwdate/url_to_unixtime\n\nThis is the first one to go. This change requires the following\nsudo apt-get install python3-socksipy\nsudo apt-get install python3-dateutil\n"},{"author":"Patrick","date_created":1486647389,"date_modified":1486647389,"content":">>! In T624#12101, @joysn1980 wrote:\n> Are there any other files/path involved here?\n\nLooks complete.\n\nThere is also sdwdate\n/usr/lib/python2.7/dist-packages/sdwdate/__init__.py\nbut it's empty.\n\nsdwdate-gui python3 port seems already done.\n\n> I do not think it is correct to take up python-guimessages here in this ticket. It is not related to sdwdate/sdwdate-gui. They should be handled separately.\n\nCreated T627 for python-guimessages.\n"},{"author":"Patrick","date_created":1486647720,"date_modified":1486647720,"content":">>! In T624#12127, @joysn1980 wrote:\n> https://github.com/joysn/sdwdate/blob/master/usr/lib/sdwdate/url_to_unixtime\n> \n> This is the first one to go. This change requires the following\n> sudo apt-get install python3-socksipy\n\nThat package is not available in stretch. Currently we are using python-socks. Was possible to port from python3-socksipy to python-socks without code changes. And stretch has python3-socks. Can we use python3-socks (or another package installable from packages.debian.org)?\n\nhttps://packages.debian.org/search?keywords=python3-socks\n\n> sudo apt-get install python3-dateutil\n\nThat is great. I'll update debian/control now.\n\nhttps://packages.debian.org/search?keywords=python3-dateutil\n\nProbably also needed: python3-gevent\n\nhttps://packages.debian.org/search?keywords=python3-gevent"},{"author":"Patrick","date_created":1486647814,"date_modified":1486647814,"content":"`update dependencies to python3`\nhttps://github.com/Whonix/sdwdate/commit/c735652569531b3f6443ae57357612b6ccccca66"},{"author":"joysn1980","date_created":1486653282,"date_modified":1486653282,"content":"https://github.com/joysn/sdwdate/tree/master/usr\n\nThis has couple of commits involving\n/usr/lib/python3/dist-packages/sdwdate/config.py\n/usr/lib/python3/dist-packages/sdwdate/proxy_settings.py\n/usr/lib/python3/dist-packages/sdwdate/remote_times.py\n/usr/lib/python3/dist-packages/sdwdate/timesanitycheck.py\nand\n/usr/bin/sdwdate\n\nFirst commit had few typos which I did not make. So reversing the changes in the next commit.\n\n/usr/bin/sdwdate-gui already done by Patrick"},{"author":"joysn1980","date_created":1486654969,"date_modified":1486654969,"content":"> Probably also needed: python3-gevent\n> \n> https://packages.debian.org/search?keywords=python3-gevent\n\nYes, it is required by /usr/lib/python3/dist-packages/sdwdate/remote_times.py\nsudo apt-get install python3-gevent worked in Whonix14 but in Whonix 13 it did not."},{"author":"Patrick","date_created":1486655096,"date_modified":1486655096,"content":"Merged. And added a few minor fixes on top. Please merge my changes.\n\nTwo issues found.\n\nsdwdate does not start yet.\n```\nsudo -u sdwdate ./usr/bin/sdwdate \nTraceback (most recent call last):\n  File \"./usr/bin/sdwdate\", line 22, in <module>\n    from guimessages.translations import _translations\nImportError: No module named 'guimessages'\n```\n\n`usr/share/sdwdate/unit_test` shows some broken output:\n\n> `pool 1 url znig4bc5rlwyj4mz.onion: b'%s'`"},{"author":"joysn1980","date_created":1486658574,"date_modified":1486658574,"content":"```\nusr/share/sdwdate/unit_test shows some broken output:\n```\nporting to python3 should fix this.\nhttps://github.com/joysn/sdwdate/commit/a25819834c8ed813696f52f003297ec04c40892c\n\n\n```\n    from guimessages.translations import _translations\n```\nhttps://phabricator.whonix.org/T627\nhttps://github.com/joysn/python-guimessages/commit/4929f6546e32f7f4279f5166d58832cc95c1a063\n\nI hope this two should fix the issues. Also, let me know if anything else needs to be done for this ticket.\n\n"},{"author":"joysn1980","date_created":1486659089,"date_modified":1486659089,"content":"One more typo fixed\nhttps://github.com/joysn/sdwdate/commit/27c547c2e84616feb25cc0f0de65f8442e0a83c7"},{"author":"Patrick","date_created":1486663916,"date_modified":1486663916,"content":"Added some fixes on top.\n\nSome issues.\n\n1)\n\n`usr/lib/sdwdate/url_to_unixtime 127.0.0.1 9050 check.torproject.org 80 true`\n\n> `http_time: b'Thu, 09 Feb 2017 18:00:00 GMT'`\n\nI wonder where the `b` is coming from. Can you remove the extraneous `b`?\n\n2) There are a few type errors.\n\nfrom /usr/bin/sdwdate `os.environ[\"TEMP_DIR\"] = temp_dir` did not work\n`os.environ[\"TEMP_DIR\"] = str(temp_dir)` works for me. Is that an okay fix?\n\nI did not manage to test yet if `rmtree(pre_check.temp_dir)` would work due to other issues.\n\n3) An unresolved type error.\n\n```\nsudo -u sdwdate ./usr/bin/sdwdate \n```\n```\nsdwdate started. PID 30352\nself.language is en\nTor socks host: 127.0.0.1  Tor socks port: 9050\nself.language is en\nPrerequisite check:\n b'Tor is not yet fully bootstrapped. Tor circuit: not established.'\nTraceback (most recent call last):\n  File \"./usr/bin/sdwdate\", line 555, in <module>\n    prerequisite_check()\n  File \"./usr/bin/sdwdate\", line 525, in prerequisite_check\n    sdwdate.write_status(icon, message)\n  File \"./usr/bin/sdwdate\", line 308, in write_status\n    msgf.write(args[1])\nTypeError: a bytes-like object is required, not 'str\n```"},{"author":"Patrick","date_created":1486689908,"date_modified":1486689908,"content":"Sorted out 2. and 3. in git master. 1. is todo.\n\nCreated T629 `fix sdwdate sigterm handling during remote_times.py get_time_from_servers` might be a newly introduced bug due to the newer gevent version. "},{"author":"joysn1980","date_created":1486696103,"date_modified":1486696103,"content":"Fixed #1  \nhttps://github.com/joysn/sdwdate/commit/e124e387ad3b2ce3ee91c5a518ae96c7b7ed7483\n\nTested standalone using - python3 url_to_unixtime 127.0.0.1 9050 check.torproject.org 80 true\n\n'b' in front of str means it is Byte. They were ignored in Python2 but not in Python3. "},{"author":"Patrick","date_created":1486697087,"date_modified":1486697087,"content":"Works for me! Merged."}]},"PHID-TASK-izoauzgtrnc5seotwdyh":{"id":"623","title":"port anon-ws-disable-stacked-tor to systemd socket activation","status":"resolved","priority":"Normal","author":"Patrick","description":"Rather than having loads of socat listeners idling around where lots of them don't get used, it may be better to use systemd socket activation.\n\n[systemd-socket-proxyd](https://www.freedesktop.org/software/systemd/man/systemd-socket-proxyd.html) might help.\n\nOtherwise stackexchange [claims](http://unix.stackexchange.com/questions/218407/can-socat-be-started-directly-by-systemd) socat also works with systemd socket activation.\n\nIdeally, we could avoid having one systemd unit file per port redirection. Perhaps [systemd template unit files](https://fedoramagazine.org/systemd-template-unit-files/) can be used.","comments":[{"author":"HulaHoop","date_created":1486339709,"date_modified":1486339709,"content":"Good idea."},{"author":"Patrick","date_created":1486784917,"date_modified":1486784917,"content":"As per https://lists.freedesktop.org/archives/systemd-devel/2017-February/038261.html the package would not be that cleanly implemented. Disadvantage: lots of systemd unit files. One per port. (Also one per unix domain socket file.)"},{"author":"Patrick","date_created":1487631438,"date_modified":1487631438,"content":"systemd feature request:\n`make ListenStream= port number available as ${PORT} for ExecStart`\nhttps://github.com/systemd/systemd/issues/5403"},{"author":"Patrick","date_created":1518307937,"date_modified":1518307937,"content":"Had to be done for Whonix 14 to stop wasting RAM by too many `socat` instances.\n\nhttps://forums.whonix.org/t/port-anon-ws-disable-stacked-tor-to-systemd-socket-activation"},{"author":"Patrick","date_created":1526484802,"date_modified":1526484802,"content":"@HulaHoop in T544#16070\n> How are we doing on RAM use? Is it any more or less efficient than socat after you cut down the number of spawned instances?\n\nI haven't compared\n\n* a) systemd-socket-proxyd in combination with socat\n* vs b) systemd-socket-proxyd in combination with systemd-socket-proxyd.\n\nb) is is implemented since that was more straight forward, already documented and more \"standard\" solution.)\n\nAs long as the socket is not being used, no systemd-socket-proxyd is being spawned, since this is using systemd socket activation, which results in low RAM usage for most use cases.\n\nI would expect systemd socket activation and systemd-socket-proxyd to be the most modern and RAM efficient.\n"}]},"PHID-TASK-2ezjzyktdit5b346xalm":{"id":"622","title":"Run unMessage on Whonix","status":"invalid","priority":"Normal","author":"dau","description":"Hello!\n\n[unMessage](https://github.com/AnemoneLabs/unmessage) is a peer-to-peer instant messenger that uses Onion Services for transport and Double Ratchet for encryption. We are currently testing it to make a release and would like to know what you guys think. I was going to post on the forum but would like to do that once we have tested a bit more (please let me know if this tracker should be used exclusively for Whonix development).\n\nI have opened an [issue](https://github.com/AnemoneLabs/unmessage/issues/2) on GitHub because we have not been able to run it on Whonix. Can you help us?\n\nThanks!","comments":[{"author":"Patrick","date_created":1486071671,"date_modified":1486071671,"content":"Thank you for your interest! Don't worry too much about formalities. I like clean tickets and reorganize them if useful. Anyhow, this ticket is very much fine.\n\nanswered here:\nhttps://github.com/AnemoneLabs/unmessage/issues/2#issuecomment-277091439\n\nalso created `port to ephemeral Tor hidden services / python-stem`:\nhttps://github.com/AnemoneLabs/unmessage/issues/4\n"},{"author":"dau","date_created":1486080063,"date_modified":1486080063,"content":">>! In T622#11988, @Patrick wrote:\n> Thank you for your interest! Don't worry too much about formalities. I like clean tickets and reorganize them if useful. Anyhow, this ticket is very much fine.\n> \n> answered here:\n> https://github.com/AnemoneLabs/unmessage/issues/2#issuecomment-277091439\n> \n> also created `port to ephemeral Tor hidden services / python-stem`:\n> https://github.com/AnemoneLabs/unmessage/issues/4\n\nThank you very much, Patrick!"},{"author":"HulaHoop","date_created":1486088628,"date_modified":1486088628,"content":"@dau That's awesome :) I was waiting for more competition in the Onion messaging space and I like that you guys are using an extra crypto layer as fallback. \n\nThanks for letting us know about it. I'll give it a spin and post feedback on Github.\n\n"},{"author":"dau","date_created":1486101652,"date_modified":1486101652,"content":">>! In T622#11996, @HulaHoop wrote:\n> @dau That's awesome :) I was waiting for more competition in the Onion messaging space and I like that you guys are using an extra crypto layer as fallback. \n> \n> Thanks for letting us know about it. I'll give it a spin and post feedback on Github.\n\nThank **you** @HulaHoop!\n\nI use Whonix daily and I not only want to run unMesssage on it, but I hope it can contribute to Whonix somehow.\n\nThank you very much for you guys' help, feedback, and well, basically all your work :D"},{"author":"HulaHoop","date_created":1486950703,"date_modified":1486950703,"content":"@dau The Tor Project is running a series of blog posts on OS's and programs that make use of their network as part of raising awareness about them in the community. These are short articles that describe what the respective projects are about and their future goals. I want to let them know about unMessage. This will get attention and potentially attract more coders. What do you think? Check with your friend rxcomm and let me know."},{"author":"dau","date_created":1487020588,"date_modified":1487020588,"content":">>! In T622#12219, @HulaHoop wrote:\n> @dau The Tor Project is running a series of blog posts on OS's and programs that make use of their network as part of raising awareness about them in the community. These are short articles that describe what the respective projects are about and their future goals. I want to let them know about unMessage. This will get attention and potentially attract more coders. What do you think? Check with your friend rxcomm and let me know.\n\nThanks @HulaHoop! I talked to rxcomm and we agree, that's a great idea! unMessage is quite a new project and we expect some teething pains, but we're looking forward to regular users providing feedback. Also, while we believe unMessage is very strong against passive adversaries, not much has been done to deal with active adversaries (especially if the attacker is someone you have already established a  conversation with). Suggestions from the community will definitely help with that process as well.\n\nSome good news is that this weekend rxcomm and I were able to work on voice conversations and it went very well. I am currently organizing the code before pushing the changes.\n\nThank you very much!"},{"author":"HulaHoop","date_created":1487167613,"date_modified":1487167613,"content":":) I'll work on writing a draft and post it for your feedback."},{"author":"HulaHoop","date_created":1487214090,"date_modified":1487346593,"content":"unMessage is an anonymous communication messenger that uses Tor to hide metadata of participants. Its still in early development, however a major new feature such as Tor-to-Tor audio chat (the first such implementation we are aware of) has been included. Major additions like file-sharing support, video conferencing and a portable code-base for mobile platforms are planned.  \n\nOur major goal is to provide a better UX and a competitive feature set to move users away from proprietary solutions that don't respect privacy. Though not ready for mass adoption yet, we encourage the more technical audience among you to go ahead try it out. We appreciate any feedback and/or pull requests.\n\nCheck us out on Github:\n\nhttps://github.com/AnemoneLabs/unmessage\n"},{"author":"dau","date_created":1487286690,"date_modified":1487286690,"content":">>! In T622#12304, @HulaHoop wrote:\n> unMessage is an anonymous communication program that uses Tor to hide metadata of participants. Its still in early development, however a major new feature such as Tor-to-Tor audio chat (the first such implementation we are aware of) has been included. Major additions like file-sharing support, video conferencing and a portable code-base mobile platforms are planned.  \n> \n> Our major goal is to provide a better UX and a competitive feature set to move users away from proprietary solutions that don't respect privacy. Though not ready for mass adoption yet, we encourage the more technical audience among you to go ahead try it out. We appreciate any feedback and/or pull requests.\n> \n> Check us out on Github:\n> \n> https://github.com/AnemoneLabs/unmessage\n\nThanks @HulaHoop, it looks great! For people not familiar with it, I think the first sentence might seem a bit vague. I would use \"messenger\" (or something like that) instead of just \"program\". What do you think?\n\nYou wrote a nice description of unMessage and exactly what will draw people's attention. Hopefully they will be interested in contributing :)"},{"author":"HulaHoop","date_created":1487346364,"date_modified":1487346364,"content":"@dau OK great. included your suggestion.\n\n@Patrick Can you please check with Shaari for publishing?"},{"author":"HulaHoop","date_created":1487698244,"date_modified":1487698244,"content":"I waited for the Tor PR guys to get back to me but I'm pretty sure they won't at this point. I went ahead and announced it on our blog and other high traffic mail lists to get more attention.\n\nhttps://www.whonix.org/blog/announcing-unmessage-next-gen-tor-messenger\nhttps://lists.torproject.org/pipermail/tor-talk/2017-February/042954.html\nhttps://mailman.stanford.edu/pipermail/liberationtech/2017-February/016882.html"},{"author":"dau","date_created":1487712965,"date_modified":1487712965,"content":">>! In T622#12421, @HulaHoop wrote:\n> I waited for the Tor PR guys to get back to me but I'm pretty sure they won't at this point. I went ahead and announced it on our blog and other high traffic mail lists to get more attention.\n> \n> https://www.whonix.org/blog/announcing-unmessage-next-gen-tor-messenger\n> https://lists.torproject.org/pipermail/tor-talk/2017-February/042954.html\n> https://mailman.stanford.edu/pipermail/liberationtech/2017-February/016882.html\n\n@HulaHoop, that's great! It looks like a few people already tested it and hopefully the audience will keep growing!\n\nThank you so much :)"},{"author":"Patrick","date_created":1562409275,"date_modified":1562409275,"content":"Dead upstream."}]},"PHID-TASK-5v7b4ws4lxnysvsengme":{"id":"621","title":"Combatting sclockadj's log spam","status":"resolved","priority":"Normal","author":"HulaHoop","description":"One of sclockadj's problems is it causes systemd's journal spam because of time changes. There are some measures that propose decreasing the log spam but it may not be enough:\n\nhttps://serverfault.com/questions/815081/how-to-combat-journal-spam-unit-specific-maxlevel-settings\n\nTODO: research if there is a way that can save us the trouble of submitting upstream systemd patches. Perhaps using an alternative logging system?","comments":[{"author":"Patrick","date_created":1486040187,"date_modified":1486040187,"content":"systemd feature request:\n`option to disable systemd's “Time has been changed” message spam in journal log`\nhttps://github.com/systemd/systemd/issues/5207\n"},{"author":"HulaHoop","date_created":1486087968,"date_modified":1486087968,"content":"Poettering says its already implemented?"},{"author":"Patrick","date_created":1486124537,"date_modified":1486124537,"content":"Yes. Problem is the systemd version in Debian stretch is too old."},{"author":"HulaHoop","date_created":1486135247,"date_modified":1486135247,"content":"Ok so this should be tagged Debian Bullseye.\n\nAs a subset of T50 that ticket needs to be updated when this one here is complete."},{"author":"Patrick","date_created":1486228818,"date_modified":1486228818,"content":"Similar issue not yet fixed in systemd master.\n\nsystemd feature request  - `lower the priority of add random timer message from info to debug`:\nhttps://github.com/systemd/systemd/issues/5228\n\n-----\n\nCodenames are messed up.\n\n* #debian_version_10_codename_buster yes\n* #debian_version_11_codename_bullseye no\n\nTagging the ticket with a Debian codename such as #debian_version_10_codename_buster results in rechecking the ticket when that phabircator component is due.\n\n-----\n\nIn #debian_version_10_codename_buster which will be a long time, this will solve itself without further action required.\n\nShould we do something about this in meanwhile for #Whonix_14 #debian_stretch based release? Does this fill up the disk or are logs truncated to sane sizes?"},{"author":"HulaHoop","date_created":1486339666,"date_modified":1486339666,"content":">Should we do something about this in meanwhile for Whonix 14 Debian Stretch based release? Does this fill up the disk or are logs truncated to sane sizes?\n\nNo need. Kernel logs look ok."},{"author":"Patrick","date_created":1574366083,"date_modified":1574366083,"content":"Not a problem anymore."}]},"PHID-TASK-3wfrperdyzl7z6tcvhr2":{"id":"620","title":"clean up qubes-whonix package dependencies to resolve issues upgrading to stretch","status":"resolved","priority":"Normal","author":"Patrick","description":"Many dependencies of the #qubes-whonix package were still defined by @nrgaway. I like to go through them and remove everything that does not belong there.\n\nIt's actually done in the Whonix developers repository. It was required because otherwise there would been held back packages during the jessie -> stretch upgrade. So it was easier to do a general cleanup rather than finding the offending package.\n\nCommit:\nhttps://github.com/Whonix/qubes-whonix/commit/e7e56555a54244bc6fe97bae50e97dffba2096ee\n\nImproved commit comment:\n\n> clean up dependencies to resolve issues upgrading to stretch \n> xsettingsd\n> gnome-themes-standard\n> xinit (not up to qubes-whonix)\n> removed versioned depends (no longer required)\n> python-guimessages (already implicit dependency of whonix-setup-wizard)\n> network-manager\n> network-manager-gnome\n> gnome-packagekit\n> gnome-terminal\n> locales (anon-shared-packages-dependencies already depends on it)\n> iptables (Whonix firewall already depends on it, all iptables is up to Whonix firewall)\n> initscripts (not up to qubes-whonix)\n> xdg-user-dirs (not used)\n> xen-utils-common (Qubes already depends on it)\n> mate-notification-daemon (maybe re-add later)\n> libnotify-bin (maybe re-add later)\n> notify-osd (maybe re-add later)\n\nAre there any packages you suggest to keep? //cc @marmarek ","comments":[{"author":"marmarek","date_created":1485776404,"date_modified":1485776404,"content":"Related: https://github.com/QubesOS/qubes-issues/issues/2572 (meta-packages for Qubes)\nAs for the above list: \n - drop all notification-related packages - those are not up to qubes-whonix\n - gnome-*, network-manager* - should be moved to some qubes-metapackage (recommended flavor, probably not installed in Whonix)"}]},"PHID-TASK-r4i52ljay7bhcfqvzkcn":{"id":"619","title":"no longer install cups by default in Whonix-Workstation","status":"resolved","priority":"Normal","author":"Patrick","description":"Cups does not get installed by default in Qubes, right?\n\ncups is still a default dependency of the #qubes-whonix package. Was added back then by @nrgaway.\n\nI think it's not all that important to have print by default capabilities in Whonix-Workstation. And would advice to do that from another VM anyhow.\n\nI don't like that it's creating a local TCP listener. When installed, even runs by default in Qubes TemplateVMs.\n\nAny voice against removing cups from default Qubes-Whonix installation? @marmarek ","comments":[{"author":"Patrick","date_created":1485870407,"date_modified":1485870407,"content":"`cups and system-config-printer from qubes-whonix-workstation-packages-recommended`\nhttps://github.com/Whonix/qubes-whonix/commit/fe3a2329739ad78ad2a6c48ed7dfb5a0893006a2"}]},"PHID-TASK-finxwccvgi6i5olj2zku":{"id":"618","title":"kdeconnectd","status":"resolved","priority":"Normal","author":"HulaHoop","description":"This is the Android integration daemon that listens on all interfaces by default in Debian Stretch.\n\nTo minimize GW attack surface it must be removed or somehow disabled. Brief experimenting shows there is no obvious service that can be disabled - Its mentioned that its tied to DBUS. Not much documentation on how to disable it either. What worked was purging the kconnect package.","comments":[{"author":"JasonJAyalaP","date_created":1496369932,"date_modified":1496369954,"content":"Kdeconnect package is installed by default? I just did a fresh image of developers-14 plus upgrade, and I don't see kdeconnect installed or kdeconnectd running."},{"author":"JasonJAyalaP","date_created":1496419769,"date_modified":1496419769,"content":"My mistake. I asked on the kde forums:\n\nhttps://forum.kde.org/viewtopic.php?f=66&t=140535"},{"author":"Patrick","date_created":1496488292,"date_modified":1496488292,"content":"JasonJAyalaP (Jason J. Ayala P.):\n>   My mistake. I asked on the kde forums:\n>   \n>   https://forum.kde.org/viewtopic.php?f=66&t=140535\n\nPlease ask how to do that from command line."},{"author":"JasonJAyalaP","date_created":1497416431,"date_modified":1497416431,"content":"Forum said:\n> I don't know for sure, so I did a little bit of perusing of the dbus API, I dug up \"qdbus org.kde.kde /modules/kdeconnect [start|stop]\" which looks like it should start/stop the kdeconnect module (service?). \n\nI don't have exactly those service names. Through tab completion I found something close with kde5, but no kdeconnect stop/start."},{"author":"Patrick","date_created":1497441085,"date_modified":1497441085,"content":"We shouldn't disable it through qdbus - because that won't persist across reboots. It only disables it for a session, in memory. qdbus isn't great since we want to disable it using a package / by dropping a config snippet into the right place.\n\nThe solution would probably look similar to this:\n\nhttps://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/nepomukserverrc\n\nor this https://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/krunnerrc\n"},{"author":"JasonJAyalaP","date_created":1497584992,"date_modified":1497584992,"content":"@HulaHoop \n\nWait. I don't see this package on GW.\n\ndpkg -l | grep kdeconnect\nkillall -9 kdeconnectd \n/usr/share/dbus-1/services/org.kde.kdeconnect.service\nqdbus org.kde.kde /modules/kdeconnect stop"},{"author":"Patrick","date_created":1497627267,"date_modified":1497627267,"content":"It's also not on the workstation.\n\n> This is the Android integration daemon that listens on all interfaces by default in Debian Stretch.\n\nCheck for unwanted listen ports.\n\n    sudo netstat -anltp\n\nIf that is understood, then this ticket can be probably resolved."}]},"PHID-TASK-cf4rmrvhkice5tpthdin":{"id":"617","title":"implement /usr/lib/tor-controlport-filter-merger","status":"resolved","priority":"Normal","author":"Patrick","description":"As per:\nhttps://mailman.boum.org/pipermail/tails-dev/2017-January/011172.html\n\nTODO:\n\n* take (and review) https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/usr/local/lib/tor-controlport-filter?h=feature/12173-end-whonix-controlport-filter-fork\n* replace https://github.com/Whonix/control-port-filter-python/blob/master/usr/lib/tor-controlport-filter with above\n* invent /usr/lib/tor-controlport-filter-merger\n** parse\n*** /etc/tor-controlport-filter-merger.d and\n*** /usr/local/etc/tor-controlport-filter-merger.d (for Qubes-Whonix)\n** auto generate /etc/tor-controlport-filter.d/30_autogenerated.yml\n\nBonus:\n\n* if possible and easy code wise, add some comments on top of 30_autogenerated.yml such as \"Manual edits will be lost! This file has been auto generated by...\"\n* each merged key gets a comment from which source file it is coming from\n","comments":[{"author":"joysn1980","date_created":1485588820,"date_modified":1485588820,"content":"Patrick,\n\n#1 - \nCan you provide me few real yml files to be placed under \n/etc/tor-controlport-filter-merger.d\nand\n/usr/local/etc/tor-controlport-filter-merger.d\nwhich I can use to write the  /usr/lib/tor-controlport-filter-merger?\n\n#2 - Also let me know how do we prioritise the \na) Directories - /etc/tor-controlport-filter.d/*.yml has higher priority than /usr/local/etc/tor-controlport-filter.d/\nb) Files - lexical order?\n\nThanks"},{"author":"Patrick","date_created":1485618747,"date_modified":1485618747,"content":">>! In T617#11897, @joysn1980 wrote:\n> #1 - \n> Can you provide me few real yml files to be placed under \n> /etc/tor-controlport-filter-merger.d\n> and\n> /usr/local/etc/tor-controlport-filter-merger.d\n> which I can use to write the  /usr/lib/tor-controlport-filter-merger?\n\nhttps://github.com/Whonix/control-port-filter-python/blob/master/etc/tor-controlport-filter.d/30_whonix.yml will go there.\n\nWith an optional (by user) combination of https://github.com/Whonix/control-port-filter-python/tree/master/usr/share/tor-controlport-filter/examples.\n\n> #2 - Also let me know how do we prioritise the \n> a) Directories - /etc/tor-controlport-filter.d/*.yml has higher priority than /usr/local/etc/tor-controlport-filter.d/\n> b) Files - lexical order?\n\nParse /etc/tor-controlport-filter.d/first. Parse /usr/local/etc/tor-controlport-filter.d/ second. Therefore the latter has higher priority."},{"author":"joysn1980","date_created":1485857110,"date_modified":1485857136,"content":"> take (and review) https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/usr/local/lib/tor-controlport-filter?h=feature/12173-end-whonix-controlport-filter-fork\n\nTails changes have \n1) -u option\n2) safe_load\n3) -interface\n\nthe change about merging is not present\n\n\n\n> replace https://github.com/Whonix/control-port-filter-python/blob/master/usr/lib/tor-controlport-filter with above\n\n\nHere it is - \nhttps://github.com/joysn/control-port-filter-python/commit/3da7a49d7b4f43827578f00fc50489a05de4369f#diff-7414879ce81f5586d790820540d0ca05\n\n\n\n> invent /usr/lib/tor-controlport-filter-merger\n\n\nHere it is\nhttps://github.com/joysn/control-port-filter-python/blob/master/usr/lib/tor-controlport-filter-merger\n\n1) This will create  /etc/tor-controlport-filter.d/30_autogenerated.yml\n2) This will add the following three lines at the top\n\n\n```\n## This file is part of Whonix.\n## Manual edits to this file will be lost! \n## This file has been auto generated by...\n\n```\nLet me know if this is ok, or something more/modification is required.\n3) There are couple of merges [typo in the path where this file to be created was fixed in subsequent merge]"},{"author":"Patrick","date_created":1485887728,"date_modified":1485887728,"content":"So far so good.\n\n   filter_files_set1 = glob.glob('/etc/tor-controlport-filter.d/*.yml')\n\n   filter_files_set2 = glob.glob('/usr/local/etc/tor-controlport-filter.d/*.yml')\n\nI think this needs to be `tor-controlport-filter-merger.d`?"},{"author":"Patrick","date_created":1485897853,"date_modified":1485897853,"content":"(Manually overwrote this with tor-controlport-filter-merger.d in my tests.)\n\nIn [/lib/systemd/system/tor-controlport-filter.service.d/30_cpfpy.conf](https://github.com/Whonix/whonix-gw-network-conf/blob/master/lib/systemd/system/tor-controlport-filter.service.d/30_cpfpy.conf) please add above `ExecStart=`:\n\n    ExecStartPre=/usr/lib/tor-controlport-filter-merger\n\nThis needs some debugging. Fails for a unknown reason.\n\n```\nsudo service  tor-controlport-filter restart\n```\n> Job for tor-controlport-filter.service failed because the control process exited with error code.\n> See \"systemctl status tor-controlport-filter.service\" and \"journalctl -xe\" for details.\n\n\n```\nsudo service tor-controlport-filter status\n```\n\n> ● tor-controlport-filter.service - Tor control port filter proxy\n>    Loaded: loaded (/lib/systemd/system/tor-controlport-filter.service; enabled; vendor preset: enabled)\n>   Drop-In: /lib/systemd/system/tor-controlport-filter.service.d\n>            └─30_cpfpy.conf, 30_whonix_cpfpy.conf\n>    Active: failed (Result: exit-code) since Tue 2017-01-31 21:10:56 UTC; 944ms ago\n>      Docs: https://tails.boum.org/contribute/design/\n>   Process: 10297 ExecStartPre=/usr/lib/tor-controlport-filter-merger (code=exited, status=1/FAILURE)\n>  Main PID: 9346 (code=killed, signal=TERM)\n> \n> Jan 31 21:10:56 host systemd[1]: tor-controlport-filter.service: Control process exited, code=exited status=1\n> Jan 31 21:10:56 host systemd[1]: Failed to start Tor control port filter proxy.\n> Jan 31 21:10:56 host systemd[1]: tor-controlport-filter.service: Unit entered failed state.\n> Jan 31 21:10:56 host systemd[1]: tor-controlport-filter.service: Failed with result 'exit-code'.\n> Jan 31 21:10:56 host systemd[1]: tor-controlport-filter.service: Service hold-off time over, scheduling restart.\n> Jan 31 21:10:56 host systemd[1]: Stopped Tor control port filter proxy.\n> Jan 31 21:10:56 host systemd[1]: tor-controlport-filter.service: Start request repeated too quickly.\n> Jan 31 21:10:56 host systemd[1]: Failed to start Tor control port filter proxy.\n> Jan 31 21:10:56 host systemd[1]: tor-controlport-filter.service: Unit entered failed state.\n> Jan 31 21:10:56 host systemd[1]: tor-controlport-filter.service: Failed with result 'exit-code'.\n\n----\n\nDid run the merger and filter manually... Might have found a bug. Added 40_ricochet.yml and 30_whonix.yml. The resulting 30_autogenerated.yml ...\n\n```\ncat /etc/tor-controlport-filter.d/30_autogenerated.yml \n```\n```\n## This file is part of Whonix.\n## Manual edits to this file will be lost! \n## This file has been auto generated by...\n\n\n---\n- commands:\n    ADD_ONION:\n    - pattern: NEW:(\\S+) Port=9878,\\S+:(\\S+)\n      replacement: NEW:{} Port=9878,{client-address}:{}\n    - pattern: (\\S+):(\\S+) Port=9878,\\S+:(\\S+)\n      replacement: '{}:{} Port=9878,{client-address}:{}'\n    DEL_ONION:\n    - .+\n    GETCONF:                                                                                                                                                  \n    - DisableNetwork                                                                                                                                          \n    GETINFO:                                                                                                                                                  \n    - pattern: status/circuit-established status/bootstrap-phase net/listeners/socks                                                                          \n      response:                                                                                                                                               \n      - pattern: 250-status/bootstrap-phase=*                                                                                                                 \n        replacement: 250-status/bootstrap-phase=NOTICE BOOTSTRAP PROGRESS=100 TAG=done\n          SUMMARY=\"Done\"\n      - pattern: 250-net/listeners/socks=\".*\"\n        replacement: 250-net/listeners/socks=\"127.0.0.1:9150\"\n    - status/circuit-established\n    - version\n    - pattern: net/listeners/socks\n      response:\n      - pattern: 250-net/listeners/socks=\".*\"\n        replacement: 250-net/listeners/socks=\"127.0.0.1:9150\"\n    SIGNAL:\n    - NEWNYM\n  confs:\n    __owningcontrollerprocess: null\n  events:\n    CONF_CHANGED:\n      suppress: true\n    SIGNAL:\n      suppress: true\n    STATUS_CLIENT:\n      suppress: true\n  match-exe-paths: '*'\n  match-hosts:\n  - '*'\n  match-users: '*'\n  name: 'merged_filter_files:  40_ricochet.yml 30_whonix.yml'\n```\n\nThe filter does not work with that.\n\n```\nsudo -u tor-controlport-filter /usr/lib/tor-controlport-filter --debug --listen-interface eth1\nIP address for interface eth1 : 10.137.11.1\nTor control port filter started, listening on 10.137.11.1:9051\n\n\n\n\n\n10.137.11.80:42806 (filter: None) connected: loaded filter: None\nFinal rules:\ncommands: {}\nevents: {}\nrestrict-stream-events: false\n```\n"},{"author":"joysn1980","date_created":1485922745,"date_modified":1485922745,"content":"\n\n\n> I think this needs to be tor-controlport-filter-merger.d?\n\nhttps://github.com/joysn/control-port-filter-python/commit/70162e5508e7bca9002beeacf19a8edd9763013d#diff-3bd76e3ee329692a8dd8311964a60264"},{"author":"joysn1980","date_created":1485922893,"date_modified":1485923144,"content":"> The filter does not work with that.\n\n\n\nThis is what I tried\n /etc/tor-controlport-filter.d/\nhas only one file - 30_autogenerated.yml [manually put it there]\nand then\n\n\n```\nsudo service tor-controlport-filter restart\nsudo journalctl -f -u tor-controlport-filter\n```\n\nEverything worked fine. Though I did not put the new tails version of tor-controlport-filter. Did you replace that and then you saw the error/bug?\n\nWhat I am trying to find out is -\nIs the issue with new tor-controlport-filter?\nOR\nIs the issue is with the merged config file - 30_autogenerated.yml"},{"author":"joysn1980","date_created":1485945296,"date_modified":1485945296,"content":"OK, I got this one.\n\nThe issue is with the TAILs version of the tor-controlport-filter which we have originally merged some time back.\n\n/etc/tor-controlport-filter.d/30_autogenerated.yml\nand\nwith tor-controlport-filter \nas in \nhttps://github.com/Whonix/control-port-filter-python/blob/e504cabcdaf159f821f38edd4267112c71a190d7/usr/lib/tor-controlport-filter\n\n[this is the last version before taking up the original tails version].\nThis works fine with this new auto merged config 30_automerged.yml file[generated from tor-controlport-filter-merger]\n\nI fixed the issue with tails version\nhttps://github.com/joysn/control-port-filter-python/commit/6f488c14980e8b5c58a42374649c4d5725c8296e#diff-7414879ce81f5586d790820540d0ca05\n\nThe matchers were spelled incorrectly\n\n```\n-                ('exe-paths', client_exe_path),\n -                ('users',     client_user),\n-                ('hosts', client_host),\n```\nShould be\n```\n +                ('match-exe-paths', client_exe_path),\n +                ('match-users',     client_user),\n +                ('match-hosts', client_host),\n```\nSo with this two fix, all should work fine.\n\n"},{"author":"Patrick","date_created":1486059145,"date_modified":1486059145,"content":"Forwarded your patch https://github.com/joysn/control-port-filter-python/commit/6f488c14980e8b5c58a42374649c4d5725c8296e#diff-7414879ce81f5586d790820540d0ca05 to tails-dev mailing list for inclusion at upstream.\n\nMerged.\n\nAdded a few minor commits on top.\n\n* https://github.com/Whonix/control-port-filter-python/commit/a615611fbbbb3ebf3b6641a187f109d22da3fd51\n* https://github.com/Whonix/control-port-filter-python/commit/5bf372be2708b1b86eff20e861607104597fbb80\n* https://github.com/Whonix/control-port-filter-python/commit/6c78583df9350f47f4ee84531311ecdb5111072d\n* https://github.com/Whonix/control-port-filter-python/commit/d05d1015c460812ae0faa1a699f95f248817d4c7\n\n* https://github.com/Whonix/whonix-gw-network-conf/commit/ac459469b609262fa75df23a0aec85efb8649295\n"},{"author":"Patrick","date_created":1486074638,"date_modified":1486074638,"content":"https://github.com/Whonix/control-port-filter-python/commit/cf0c7afa93de78362236c5dc6539d74ccd1dec56\n\n(That diff on github does not look great, however that diff looks quite sane in a better diff viewer.)\n\nAlso fully tested. Works great!\n\nDo my changes look sane to you? If so, this ticket can be considered resolved."},{"author":"Patrick","date_created":1486075369,"date_modified":1486075369,"content":"https://github.com/Whonix/control-port-filter-python/commit/6fe2d272462ff4bdf7f33fea0d2db551cb232bfe"},{"author":"joysn1980","date_created":1486091956,"date_modified":1486091956,"content":"Perfect Patrick. Thanks."},{"author":"Patrick","date_created":1486123665,"date_modified":1486131726,"content":"One more thing to do here.\n`s/match-//g`\nanonym replied.\n\n* https://mailman.boum.org/pipermail/tails-dev/2017-February/011222.html\n* https://mailman.boum.org/pipermail/tails-dev/2017-February/011224.html\n\nDo you think you could `git revert 6f488c14980e8b5c58a42374649c4d5725c8296e` (so we share the same code with Tails) as well as remove `match-` prefixes in the merger code and configs?"},{"author":"Patrick","date_created":1486131716,"date_modified":1486131716,"content":">>! In T617#11999, @Patrick wrote:\n> Do you think you could `git revert cf0c7afa93de78362236c5dc6539d74ccd1dec56` (so we share the same code with Tails) as well as remove `match-` prefixes in the merger code and configs?\n\nMy mistake. I meant `git revert 6f488c14980e8b5c58a42374649c4d5725c8296e`"},{"author":"joysn1980","date_created":1486132641,"date_modified":1486132641,"content":"\nFixed in \nhttps://github.com/joysn/control-port-filter-python/commit/f430cf3478d430851db3443b2984bc61f69a6605#diff-3bd76e3ee329692a8dd8311964a60264\n\n\nReverting the changes to tor-controlport-filter\nhttps://github.com/joysn/control-port-filter-python/commit/d99eb8c077dd6fc2ec0f479b51e2be043e3f6ea0#diff-700d916dcb6f72233745db056c63f43c\n"},{"author":"Patrick","date_created":1486151100,"date_modified":1486151100,"content":"Merged. Wondering about one thing...\n\n```\n   # Replace matched-exe-paths, matched-hosts and matched-users\n   for i in range(len(merged_filter)):\n      if 'match-exe-paths' in merged_filter[i].keys():\n         merged_filter[i]['exe-paths'] = merged_filter[i].pop('match-exe-paths')\n      if 'match-hosts' in merged_filter[i].keys():\n         merged_filter[i]['hosts'] = merged_filter[i].pop('match-hosts')\n      if 'match-users' in merged_filter[i].keys():\n         merged_filter[i]['users'] = merged_filter[i].pop('match-users')\n```\n\nWhy is that needed? Couldn't we avoid that code block? If we just `s/match-//g` in all our configs, could we avoid that code block?"},{"author":"joysn1980","date_created":1486177214,"date_modified":1486177238,"content":"This is possible when we are reading the file as \"string\" of characters [normally how we read a file]\nBut in this case we are reading our file as yaml which is a \"dictionary\" and each of the \"match\" we have to modified are the keys of the dictionary.\n\nThis is my understanding. \n\nAgain, we do not even need this code, if we modify our config file itself and replace these \"keys\" to the new expected \"keys\"\n"},{"author":"Patrick","date_created":1486212327,"date_modified":1486212327,"content":"joysn1980 (Joy):\n> Again, we do not even need this code, if we modify our config file\n> itself and replace these \"keys\" to the new expected \"keys\"\n\nYes. Why not modify our config file and our merger example profiles?\nSeems much better to me to use the same config file keywords as upstream\n(Tails).\n\nBasically `s/match-//g` for\netc/tor-controlport-filter-merger.d/30_whonix.yml and for\nusr/share/tor-controlport-filter-merger/examples/.\n\nDone that.\n\nI have created a new git branch:\nhttps://github.com/Whonix/control-port-filter-python/tree/keywords-as-tails\n\nJust one commit:\nhttps://github.com/Whonix/control-port-filter-python/commit/7b28225fbe6300631c89047a645a649fbed19208\n\nSeems to work. I might not be fully understanding this.\n\nDoes that look good? If so, I am going to merge it into master."},{"author":"joysn1980","date_created":1486223175,"date_modified":1486223175,"content":"Sure Patrick. Everything looks good (as per my understanding)"},{"author":"Patrick","date_created":1486227646,"date_modified":1486227646,"content":"Merged."}]},"PHID-TASK-rq6qhl6rozzr7ywwnuru":{"id":"616","title":"Anonymouth","status":"invalid","priority":"Normal","author":"HulaHoop","description":"\nThis ticket is for tracking the packaging of the anti-stylommetry tool Anonymouth.","comments":[{"author":"HulaHoop","date_created":1485190161,"date_modified":1485190161,"content":"[[ https://github.com/psal/anonymouth/issues/6#issuecomment-274359287 | Asked ]] Rachael Greenstadt to point to the latest sources for the RFP.\n"},{"author":"HulaHoop","date_created":1485190259,"date_modified":1485223699,"content":"submit@bugs.debian.org\n\nRFP: Anti-stylommetry suite \n\nPackage: wnpp\nX-Debbugs-CC: whonix-devel@whonix.org, pkg-privacy-maintainers@lists.alioth.debian.org\n\n* Package name: Anonymouth\n* Version         : 0.0.2\n* Upstream Author : Rachel Greenstadt <greenie@cs.drexel.edu>\n* URL               : https://psal.cs.drexel.edu/index.php/JStylo-Anonymouth\n* License         : AGPLv3\n* Programming Lang: Java\n* Description  : Anti-stylommetry, Document Anonymization Tool\n\nAnonymouth [1] is part of the JStylo [2] Java-based Authorship Recognition Analysis and Evasion Tools by researchers at Drexel university.[1] It is the only openly available tool of its type. The writing attribution component is forked from JGAAP BY Duquesne university researchers. [3]\n\nWriting style forensics is a very powerful deanonymization technique widely for mass surveillance as reported by Snowden in his exchange with journalist Barton Gellman. Also a study has unmasked deep web forum posters. [4][5]\n\n\n[1] https://github.com/psal/anonymouth\n[2] https://github.com/psal/jstylo\n[3] https://github.com/evllabs/JGAAP\n[4] http://www.b3rn3d.com/blog/2014/01/31/tools-styometrics/\n[5] https://www.washingtonpost.com/world/national-security/code-name-verax-snowden-in-exchanges-with-post-reporter-made-clear-he-knew-risks/2013/06/09/c9a25b54-d14c-11e2-9f1a-1a7cdee20287_story.html"},{"author":"HulaHoop","date_created":1485190368,"date_modified":1485190368,"content":"Draft WIP. Ideally we want to entire suite with both the writing recognition and anti-stylommetry parts included. "},{"author":"Patrick","date_created":1485194686,"date_modified":1485194686,"content":"A newline missing before `Upstream Author`?\n\nIs Anonymouth finished? Still maintained? Last commit was in March 2015."},{"author":"HulaHoop","date_created":1485223848,"date_modified":1485223874,"content":"Fixed formatting.\n\nThey are still presenting PETS papers on it but no recent commits as you pointed out. Last I heard from Rachael on Github was that a python rewrite with the most common features was planned when they secure an NSF grant.\n\nI want to stir things up and see what happened to the project."},{"author":"HulaHoop","date_created":1485913455,"date_modified":1485913645,"content":"Someone who managed to build it and tested it 4-5 months ago ran into showstopping bugs. With no commits past 2013 and no recent feedback on any tickets - its considered dead.\n\nhttps://news.ycombinator.com/item?id=12325985\nhttps://news.ycombinator.com/item?id=12194720"},{"author":"HulaHoop","date_created":1486000536,"date_modified":1486000536,"content":"New research. Adversaries can link authorship based on very small fragments and with as little as 2 samples:\n\nhttps://arxiv.org/abs/1701.05681\n"},{"author":"Patrick","date_created":1513626887,"date_modified":1513626887,"content":"Dead project."}]},"PHID-TASK-g7b5butzq3i36kkzfk5s":{"id":"615","title":"use Reproducible Builds Experimental Toolchain by Debian","status":"open","priority":"Normal","author":"Patrick","description":"Porting Whonix package builds to cowbuilder (T52) was the first step but is insufficient.\n\nTODO: use https://wiki.debian.org/ReproducibleBuilds/ExperimentalToolchain#Usage_example\n","comments":[]},"PHID-TASK-qw33qrahhzwske4i64ls":{"id":"614","title":"make our mediawiki's CodeSelect compatible with |","status":"resolved","priority":"Normal","author":"Patrick","description":"CodeSelect (T93) is causing issues.\n\n{F27}\n\nWhen using `|` inside the wiki markup, it will not show up in the generated wiki html.\n\nWiki usage working:\n\n```\n{{CodeSelect|code=\ntext here\n}}\n```\n\nWiki usage broken:\n\n```\n{{CodeSelect|code=\ntext here | pipe will be lost\n}}\n```\n\nPerhaps while we are at it we can remove the need for `|code=`, somehow make `|` work. Or use another character to escape if that is possible? Or escape `|` somehow?\n\nWiki markup source:\n\n* https://www.whonix.org/wiki/Template:CodeSelect\n* https://www.whonix.org/w/index.php?title=Template:CodeSelect&action=edit\n* https://www.whonix.org/wiki/Widget:CodeSelect\n* https://www.whonix.org/w/index.php?title=Widget:CodeSelect&action=edit\n","comments":[{"author":"fortasse","date_created":1487823149,"date_modified":1487823182,"content":"Replacing the `|` with `{{!}}` will render a `|` as expected. `{{!}}` is a  \"magic word\" to Mediawiki, and it converts it to a pipe character.\n\nFor example:\n```\n{{CodeSelect|code=\ntext here {{!}} pipe will be saved\n}}\n```"},{"author":"Patrick","date_created":1487865823,"date_modified":1487865823,"content":"Great! Updated the wiki and documented here:\n\nhttps://www.whonix.org/wiki/Dev/mediawiki#CodeSelect_with_pipes"}]},"PHID-TASK-unn5rtergjnz4kzryw4k":{"id":"613","title":"fix mediawiki eating leading spaces in <pre> tag","status":"resolved","priority":"Normal","author":"Patrick","description":"```\n<pre>\n   test\n</pre>\n```\n\nIs rendered as.\n\n`test`\n\nShold be rendered as.\n\n`   test`\n\nCould be some mediawiki bug, some bug with our mediawiki skin Strapping or otherwise. TODO: #research\n","comments":[{"author":"fortasse","date_created":1487822558,"date_modified":1487822558,"content":"Try making the opening tag `<pre style=\"white-space: pre-wrap;\">` instead of normal `<pre>`. There are a number of [other wrapping/whitespace options](https://www.w3schools.com/cssref/pr_text_white-space.asp) if that doesn't work for what you need."},{"author":"Patrick","date_created":1487866276,"date_modified":1487866276,"content":"https://www.whonix.org/wiki/Dev/mediawiki#pre_tag_with_white_spaces"}]},"PHID-TASK-fuyun6xbhbpujopdt7ti":{"id":"612","title":"merge tor-control-port-filter changes by Tails into Whonix's tor-control-port-filter fork","status":"resolved","priority":"Normal","author":"Patrick","description":"tor-control-port-filter by Tails changed significantly since Whonix forked it.\n\nMerge https://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/usr/local/lib/tor-controlport-filter?h=feature/7870-include_onionshare into https://github.com/Whonix/control-port-filter-python/blob/master/usr/lib/tor-controlport-filter. (Of course keep the enhancements by Whonix.)\n\nThat way the delta gets smaller. And makes it easier to get Whonix's enhancement merged into Tails' one so both projects can share the very same tor-control-port-filter code.\n\nWhen done: `anonym` of Tails would like to be informed.","comments":[{"author":"joysn1980","date_created":1485354897,"date_modified":1485354924,"content":"\nhttps://github.com/joysn/control-port-filter-python/commits/master/usr/lib\n\nDone in 4 merges\nMerge 1 - Replace the current tor-controlport-filter with\nhttps://git-tails.immerda.ch/tails/tree/config/chroot_local-includes/usr/local/lib/tor-controlport-filter\n\nMerge 2 - Use yml.safe_load and Python exceptions in journalctl \n\nMerge 3 - add -listen_interface option\n\nMerge 4 - add /etc/tor-controlport-filter.d configuration support\n\nI have tested it. Did not find any obvious issue. Would request to test it once more."},{"author":"Patrick","date_created":1485356931,"date_modified":1485356931,"content":"First line, it's using `python -v`?"},{"author":"Patrick","date_created":1485357661,"date_modified":1485357661,"content":"Anyhow. Great work! Notified anonym about it.\n\nhttps://mailman.boum.org/pipermail/tails-dev/2017-January/011193.html"},{"author":"joysn1980","date_created":1485362955,"date_modified":1485362955,"content":"Yes it was a typo.\nFixed it in another commit"},{"author":"Patrick","date_created":1485376974,"date_modified":1485376974,"content":"Merged.\n\nReplies by anonym:\n\n* https://mailman.boum.org/pipermail/tails-dev/2017-January/011191.html\n* https://mailman.boum.org/pipermail/tails-dev/2017-January/011195.html\n* https://mailman.boum.org/pipermail/tails-dev/2017-January/011190.html\n\nTails ticket:\n\n* https://labs.riseup.net/code/issues/12173\n\nAfter anonym's merge:\n\n* https://git-tails.immerda.ch/tails/tree/config/chroot_local-includes/usr/local/lib/tor-controlport-filter?h=feature%2F12173-end-whonix-controlport-filter-fork\n"},{"author":"Patrick","date_created":1485378898,"date_modified":1485378898,"content":"reply by me:\nhttps://mailman.boum.org/pipermail/tails-dev/2017-January/011203.html\n\nFollow up task:\nT617"}]},"PHID-TASK-3t2mvchtrpyfs6acnkpx":{"id":"611","title":"answer anonym's tor-controlport-filter config parser question","status":"resolved","priority":"Normal","author":"Patrick","description":"https://mailman.boum.org/pipermail/tails-dev/2017-January/011164.html","comments":[{"author":"Patrick","date_created":1484845012,"date_modified":1484845012,"content":"https://www.whonix.org/wiki/Dev/Control_Port_Filter_Proxy/tor-controlport-filter/config"},{"author":"Patrick","date_created":1484897899,"date_modified":1484897936,"content":"Draft. I am not sure I am fully understanding it, so I am sharing it here to gather feedback before posting it.\n\n----\n\n> Yay! Let's try to make this fork short-lived!\n\nYes! :)\n\n> Note that Tails' version has changed quite a lot since you forked -- please try to keep your fork delta minimal (i.e. only do what *must* be done)!\n\nOur diff of the filter is quite mergable, I guess. In summary:\n\n- filters = yaml.safe_load(fh.read())\n- #!/usr/bin/python3 -u    so python exceptions end up in journal\n- config parser\n- --listen-interface (which you already said you want to add)\n\n(And the packaging stuff is not all that difficult?)\n\nWe have a ticket for merging Tails' version into Whonix's version so we get your enhancement and so the diff looks simpler. [1]\n\n> So, since all your filters match *everything*, you could actually merge all the filters yourself into a single filter rule file, right? In fact, the only non-sytlistic reason you want merging of multiple matched rules is to allow Whonix users to add their own filters without overwriting yours (which causes issues during Whonix upgrades), correct?\n> \n> If so, I think I have a simpler solution: we introduce a new top-level key called `override` which takes a list of strings. If such a filter is matched together with a filter whose name is listed in `override`, then the `override`-filter is merged into the other one, and has priority whenever there's any ambiguity. So with this, Whonix would ship a single, nicely commented filter called 'whonix', and users that need to modify it simply creates a filter with `override: ['whonix']`.\n> \n> The only drawback I can see is that Whonix cannot organize the filters in separate files this way, but I think that is a small prize to pay for such a simple solution to this problem (which I fear otherwise can make it really hard to reason about filters when they grow in number). I actually think Whonix having a single file is slightly advantageous since you use the same match rules in every filter.\n> \n> Would this work for you?\n\nNo. (However, I am not sure I fully understood your proposal. Technically at the moment all config file snippets are merged into the same merged filter rule.)\n\nHaving the filters split in multiple files is very much desirable. We want to ship a maximally restrictive config by default. And then allow users to make it more permissive as required depending on their use case.\n\nJust two different configs, one for maximum restrictive vs one for custom maximum permissive is probably not right balance here.\n\n(We match everything because of necessity - to keep the code complexity manageable. Matching by IP would be a nice feature, so would be a profile on the gateway that only matches `arm`.)\n\nFor example, adding onionshare is one of the safer applications one can whitelist due to the limited range of listening ports it opens. ricochet is more crazy, since all ports need to be allowed. (Something being discussed with upstream so this may change for Debian buster.) Some applications want to see the onion's private key [ricochet, so it can restore it later], for others we can inject DiscardPK and redact it. I think other applications will require access to further Tor internal states. Ricochet uses STATUS_CLIENT, but fortunately also does not break without it yet.\n\nHaving to use something like \"override: ['whonix']\" and somehow have a hierarchy of files named that way, if they are splittable/stackable, would of course not be an issue.\n\n> Beyond that, I'll add your `--listen-interface` option, and I'll add a `--filters-dir` option that can be used to override the default filters dir, and that can be passed multiple times (so you'll pass `--filters-dir /etc/tor-controlport-filter.d --filters-dir /usr/local/etc/tor-controlport-filter.d/`).\n\nThat's great! (Please don't fail if the folder does not exist - logging that only would be a lot better.)\n\n[1] https://phabricator.whonix.org/T612"},{"author":"joysn1980","date_created":1484901824,"date_modified":1484901824,"content":"Thanks Patrick. Looks good to me"},{"author":"Patrick","date_created":1484907586,"date_modified":1484907586,"content":"Thanks for looking into it!\n\nSent."},{"author":"Patrick","date_created":1484950859,"date_modified":1484950859,"content":"Another answer is desired.\n\nhttps://mailman.boum.org/pipermail/tails-dev/2017-January/011170.html\n\nAny thoughts?"},{"author":"Patrick","date_created":1485189439,"date_modified":1485189526,"content":"Discussed this with @joysn1980 by e-mail. Summing it up and here is a draft.\n\n> [override] will probably work for Whonix. Joy and me drafted a plan.\n> \n> In one sentence: We at Whonix invent a new a separate config folder, parse it with a yml merger python script, and generate another yml file that gets passed to tor-controlport-filter by Tails.\n> \n> In more detail:\n> \n> - We'll at Whonix invent /usr/lib/tor-controlport-filter-merger.\n> - And ship that as opt-in or in a separate package by Whonix.\n> - (If opt-in, we enable it in a separate Whonix package.)\n> \n> - /etc/tor-controlport-filter.d\n> -- We tell Whonix users to ignore it.\n> -- Internally used by /usr/lib/tor-controlport-filter .\n> -- Will contain\n> --- tails-default-profies.yml (for the sake of sharing the package and perhaps we also benefit from a profile for arm/nyx)\n> --- 30_autogenerated.yml\n> \n> - /etc/tor-controlport-filter-merger.d\n> -- Will be used by Whonix and its users\n> -- 30_whonix_default.yml - will by shipped by Whonix by default\n> -- 40_onionshare.yml - user defined\n> -- 40_ricochet.yml - another user defined etc.\n> \n> - /usr/lib/tor-controlport-filter-merger parses both,\n> -- /etc/tor-controlport-filter-merger.d and\n> -- /usr/local/etc/tor-controlport-filter-merger.d (for Qubes-Whonix)\n> -- and creates /etc/tor-controlport-filter.d/30_autogenerated.yml\n> \n> - Our tor-controlport-filter.service systemd service will in essence look like this. \n> -- ExecStartPre=/usr/lib/tor-controlport-filter-merger\n> -- ExecStart=/usr/lib/tor-controlport-filter\n> \n> Does that sound like that could work out?\n\nWhat do you think?"},{"author":"Patrick","date_created":1485194504,"date_modified":1485194504,"content":"Sent."},{"author":"Patrick","date_created":1485254529,"date_modified":1485254529,"content":"Got another answer by `anonym`:\n\nhttps://mailman.boum.org/pipermail/tails-dev/2017-January/011174.html\n\n> Feel free to send a PR with your other changes applied to tor-controlport-filter in Tails Git! Otherwise I'll do it myself later this week.\n\nThat would be T612, but as time permits of course, no pressure.\n\nReply by me:\n\nhttps://mailman.boum.org/pipermail/tails-dev/2017-January/011178.html"}]},"PHID-TASK-7rjclyhav2wybztfybsa":{"id":"610","title":"use tor+http / apt-transport-tor rather than Acquire::BlockDotOnion \"false\";","status":"resolved","priority":"Normal","author":"Patrick","description":"As per https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=754242#54.","comments":[{"author":"Patrick","date_created":1484746982,"date_modified":1484746982,"content":"https://github.com/Whonix/anon-apt-sources-list/commit/9c85a9f2486f8c19ee96ba98e3dc3ce3b5a3ad77\nhttps://github.com/Whonix/whonix-repository/commit/1584d14065cf4f14fcce77e9d387552e21c45711\nhttps://github.com/Whonix/anon-apt-sources-list/commit/48fbc20a43b85dbe18aa07fabb0a93f1ee02fe69\nhttps://github.com/Whonix/anon-meta-packages/commit/7cf8cf4e50b72a570de54fad10f912af73e3cf3d\nhttps://github.com/Whonix/Whonix/commit/f2d5ac58d8c043e94ad10c7470b3a3c89875d35b\nhttps://github.com/Whonix/Whonix/commit/77162abafc2a71ee51817b6c1f574eb6d97ed444\nhttps://github.com/Whonix/Whonix/commit/921fc44efe75d96b18af27cf4f26479e68e259cf\n"},{"author":"Patrick","date_created":1484827628,"date_modified":1484827628,"content":"https://github.com/Whonix/Whonix/commit/2fed0f35b060b12160b1cbb475b3c74cd2075c74"},{"author":"marmarek","date_created":1484828311,"date_modified":1484828311,"content":"What about tor-over-tor issue here? And starting tor in template by having apt-transport-tor installed? Are those issues mitigated somehow else?"},{"author":"Patrick","date_created":1484837425,"date_modified":1484837425,"content":"I am glad I tagged you for this ticket. This can use scrutiny indeed. Haven't thought of that yet.\n\nTor over Tor in Qubes TemplateVM is generally sorted out by:\n\n- https://github.com/Whonix/qubes-whonix/blob/master/lib/systemd/system/tor.service.d/40_qubes.conf\n- https://github.com/Whonix/qubes-whonix/blob/master/lib/systemd/system/tor%40default.service.d/40_qubes.conf\n\nIn Qubes TemplateVM `tor+http` is currently broken.\n\n> Failed to connect to localhost port 9050: Connection refused\n\nPerhaps it should be fixed by running #anon-ws-disable-stacked-tor in Qubes whonix-ws TemplateVM? That would be easy. Will think that through (any adverse effects by running anon-ws-disable-stacked-tor in template.)\n\nWhat about Qubes whonix-gw TemplateVM? There is no anon-ws-disable-stacked-tor. Perhaps anon-ws-disable-stacked-tor should be installed in whonix-ws template also but only be run in whonix-ws template but not in sys-whonix.\n\nI haven't updated `whonix_repository_uri=` in https://github.com/Whonix/qubes-template-whonix/blob/master/whonix-gateway/04_install_qubes_post.sh to onion yet. I guess there we should use onion plus `Acquire::BlockDotOnion \"false\";`?"},{"author":"marmarek","date_created":1484957530,"date_modified":1484957530,"content":">>! In T610#11722, @Patrick wrote:\n> I haven't updated `whonix_repository_uri=` in https://github.com/Whonix/qubes-template-whonix/blob/master/whonix-gateway/04_install_qubes_post.sh to onion yet. I guess there we should use onion plus `Acquire::BlockDotOnion \"false\";`?\n\n\nIn Qubes Whonix case, I think this is the easiest thing to do, for both whonix-ws and whonix-gw. Both have other mechanism to prevent updating over clearnet, so IMHO no real reason for using tor+http. Not sure about not-Qubes cases. #anon-ws-disable-stacked-tor and tor+http may be the answer for whonix-ws (if going that way, IMO it can be also for both Qubes and non-Qubes - to ease maintenance).\nBut then we still need a solution for whonix-gw. Running #anon-ws-disable-stacked-tor in template only? How would that affect non-Qubes case? Can it be done in uniform way to make maintenance reasonably easy?"},{"author":"Patrick","date_created":1484993958,"date_modified":1484993958,"content":">>! In T610#11819, @marmarek wrote:\n>>>! In T610#11722, @Patrick wrote:\n>> I haven't updated `whonix_repository_uri=` in https://github.com/Whonix/qubes-template-whonix/blob/master/whonix-gateway/04_install_qubes_post.sh to onion yet. I guess there we should use onion plus `Acquire::BlockDotOnion \"false\";`?\n> \n> \n> In Qubes Whonix case, I think this is the easiest thing to do, for both whonix-ws and whonix-gw. Both have other mechanism to prevent updating over clearnet, so IMHO no real reason for using tor+http. \n\nThe reason for tor+http was not clearnet leak prevention. Only the recommendation to use it here:\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=754242#54\n\n> Not sure about not-Qubes cases. #anon-ws-disable-stacked-tor and tor+http may be the answer for whonix-ws (if going that way, IMO it can be also for both Qubes and non-Qubes - to ease maintenance).\n> But then we still need a solution for whonix-gw. Running #anon-ws-disable-stacked-tor in template only? How would that affect non-Qubes case? Can it be done in uniform way to make maintenance reasonably easy?\n\nFor #anon-ws-disable-stacked-tor there would have to be some rules when it runs and when not. Perhaps implemented using status files and systemd unit file conditions.\n\n* if workstation is detected -> run it\n\n* if Qubes is detected\n** if gateway is detected\n*** if Template -> run it\n*** otherwise -> do nothing\n\n* if Qubes is not detected\n** if gateway is detected -> do nothing\n\nNot immediately obvious to me how to express that in systemd terms. \n\n----\n\nRunning #anon-ws-disable-stacked-tor in whonix-gw template was perhaps a premature idea of mine anyhow. It prevents installation of Tor after all. So the socat redirection part would have to be factored out into a separate package.\n\nPerhaps it's better to implement this rather minimally inside the #qubes-whonix package? A simple one socat listener port 9050 only redirection from whonix-gw TemplateVM to sys-whonix?"},{"author":"marmarek","date_created":1485036917,"date_modified":1485036917,"content":">   Perhaps it's better to implement this rather minimally inside the https://phabricator.whonix.org/tag/qubes-whonix/ package? A simple one socat listener port 9050 only redirection from whonix-gw TemplateVM to sys-whonix?\n\nYou're talking about whonix-gw template here, right? And still cover\nwhonix-ws with #anon-ws-disable-stacked-tor?\n\nAs for status files - checking for /var/run/qubes/this-is-templatevm\n_and_ some status file signaling whonix-gw should be ok. I'm talking\nabout putting this in #qubes-whonix package."},{"author":"Patrick","date_created":1485088701,"date_modified":1485088701,"content":"marmarek (Marek Marczykowski-Górecki):\n> marmarek added a comment.\n> \n> \n>> Perhaps it's better to implement this rather minimally inside the\n>> https://phabricator.whonix.org/tag/qubes-whonix/ package? A simple\n>> one socat listener port 9050 only redirection from whonix-gw\n>> TemplateVM to sys-whonix?\n> \n> You're talking about whonix-gw template here, right? And still cover \n> whonix-ws with\n> https://phabricator.whonix.org/tag/anon-ws-disable-stacked-tor/?\n\nGood question. Would work either way. I guess simpler for both whonix-gw\nand whonix-ws to have this minimal redirection inside the qubes-whonix\npackage.\n\n> As for status files - checking for /var/run/qubes/this-is-templatevm \n> _and_ some status file signaling whonix-gw should be ok. I'm talking \n> about putting this in\n> https://phabricator.whonix.org/tag/qubes-whonix/ package.\n\nRight."},{"author":"Patrick","date_created":1487711470,"date_modified":1487711470,"content":"We should probably also set a socks user name for better Tor stream isolation. (`IsolateSOCKSAuth`) I am considering to add this to the #uwt package.\n\n    Acquire::tor::proxy \"socks5h://apt-transport-tor@127.0.0.1:9050\";\n\n(From reading `zless /usr/share/doc/apt-transport-tor/README.md.gz`.)\n\nI was considering to change the port from `9050` to another one, but I am vary of this. It might look better but would also make the implementation more complicated. (Another Tor SocksPort. Not redirect 9050 from TemplateVM to gateway but another port.) Without any actual benefit."},{"author":"Patrick","date_created":1488329573,"date_modified":1488329573,"content":">>! In T610#12427, @Patrick wrote:\n> We should probably also set a socks user name for better Tor stream isolation. (`IsolateSOCKSAuth`) I am considering to add this to the #uwt package.\n> \n>     Acquire::tor::proxy \"socks5h://apt-transport-tor@127.0.0.1:9050\";\n> \n> (From reading `zless /usr/share/doc/apt-transport-tor/README.md.gz`.)\n> \n> I was considering to change the port from `9050` to another one, but I am vary of this. It might look better but would also make the implementation more complicated. (Another Tor SocksPort. Not redirect 9050 from TemplateVM to gateway but another port.) Without any actual benefit.\n\nNot needed. Tor control command `SETEVENTS CIRC` revealed that `apt-transport-tor` sets `SOCKS_USERNAME=\"apt-transport-tor\" SOCKS_PASSWORD=\"sgvtcaew4bxjd7lnonion\"` etc. anyhow.\n"},{"author":"Patrick","date_created":1488399781,"date_modified":1488399781,"content":">>! In T610#11827, @Patrick wrote:\n> marmarek (Marek Marczykowski-Górecki):\n>> marmarek added a comment.\n>> \n>> \n>>> Perhaps it's better to implement this rather minimally inside the\n>>> https://phabricator.whonix.org/tag/qubes-whonix/ package? A simple\n>>> one socat listener port 9050 only redirection from whonix-gw\n>>> TemplateVM to sys-whonix?\n>> \n>> You're talking about whonix-gw template here, right? And still cover \n>> whonix-ws with\n>> https://phabricator.whonix.org/tag/anon-ws-disable-stacked-tor/?\n> \n> Good question. Would work either way. I guess simpler for both whonix-gw\n> and whonix-ws to have this minimal redirection inside the qubes-whonix\n> package.\n\nThis is now implemented using systemd socket activation and `/lib/systemd/systemd-socket-proxyd`.\n\nhttps://github.com/Whonix/qubes-whonix/commit/eed4d291769be16c518956eea539e3f0b61954b2\n"},{"author":"Patrick","date_created":1488401400,"date_modified":1488401400,"content":"pkg-systemd-maintainers question - `[Install] for static systemd unit file?`:\nhttp://lists.alioth.debian.org/pipermail/pkg-systemd-maintainers/2017-March/014376.html"},{"author":"Patrick","date_created":1488473086,"date_modified":1488473086,"content":"https://github.com/Whonix/qubes-whonix/commit/afcdbbaa6bc46d06b4dca4a37c60079d1d6305c8"}]},"PHID-TASK-bcsxoocmpmnesipur34c":{"id":"609","title":"check if curl has newer tls options than --tlsv1.3","status":"resolved","priority":"Normal","author":"Patrick","description":"* grep Whonix code for `--tlsv1.3` and upgrade if possible\n* update https://www.whonix.org/wiki/Template:Curl_Secure\n\ncompare with curl manual page","comments":[{"author":"HulaHoop","date_created":1484757021,"date_modified":1484757021,"content":"[[ https://curl.haxx.se/docs/manpage.html#--tlsv13 | --tlsv1.3 ]] added in 7.52.0. Current Stretch version: 7.51.0-1. New version likely won't make the freeze."},{"author":"Patrick","date_created":1495661981,"date_modified":1495661981,"content":"@torjunkie:\n\n> As an aside (all this talk of curl, scurl etc. was a reminder), as per that phabricator item (grep, code change), curl 7.52.1-5 is in stretch, so that should support tls v1.3 as you wanted i.e. as per man pages.\n\n> See here: https://packages.debian.org/stretch/curl\n\n>  Package: curl (7.52.1-5)\n\nLucky we."},{"author":"JasonJAyalaP","date_created":1496421563,"date_modified":1496421721,"content":"I've updated that wiki page with 1.3\n\nA grep of the whonix group page on github \n(https://github.com/Whonix?utf8=%E2%9C%93&q=--tlsv&type=&language=)\n\n only shows one repo, the binary for scurl:\nhttps://github.com/Whonix/scurl/blob/master/usr/bin/scurl\n\nwhich wraps curl with tls1.2\n\nIf 1.3 is suitable for Whonix 14, we can close this ticket. But it seems like we want to check for the latest support tls every new whonix version? I can create a ticket for Whonix 15 if so.\n"}]},"PHID-TASK-2nngztvyj5suln5vgvfq":{"id":"608","title":"make sure sdwdate exceptions end up in journal","status":"resolved","priority":"Normal","author":"joysn1980","description":"Similar to\nhttps://phabricator.whonix.org/T603\n\nadd -u option to python interpreter for sdwdate","comments":[{"author":"joysn1980","date_created":1484638499,"date_modified":1484638499,"content":"https://github.com/joysn/sdwdate/blob/master/usr/bin/sdwdate\n\nhttps://github.com/joysn/sdwdate-gui/blob/master/usr/lib/sdwdate-gui/show_message\nhttps://github.com/joysn/sdwdate-gui/blob/master/usr/bin/sdwdate-gui\n\nChanges made at 3 files. Now the python stderrs are seen in journal logs.\n\n\n"},{"author":"Patrick","date_created":1484639244,"date_modified":1484639244,"content":"Merged, thanks!"}]},"PHID-TASK-sokxhh4izg4zf3mqwtfs":{"id":"607","title":"fix corridor lintian warning systemd Documentation=","status":"resolved","priority":"Normal","author":"Patrick","description":"TODO: fix this pull request as per request\n\nhttps://github.com/rustybird/corridor/pull/38#issuecomment-272704204","comments":[{"author":"Patrick","date_created":1485342677,"date_modified":1485342677,"content":"https://github.com/rustybird/corridor/pull/38#issuecomment-272704204"}]},"PHID-TASK-iuagxdanr4zvxj7xw3op":{"id":"606","title":"merge /etc/apparmor.d/abstractions/base.anondist from Debian bullseye","status":"resolved","priority":"Normal","author":"Patrick","description":"* https://github.com/Whonix/apparmor-profile-anondist\n* https://github.com/Whonix/apparmor-profile-anondist/blob/master/etc/apparmor.d/abstractions/base.anondist\n","comments":[{"author":"Patrick","date_created":1674125377,"date_modified":1674125377,"content":"This will be done when doing T927."}]},"PHID-TASK-rmlmclldrixkknshl67q":{"id":"605","title":"speed up libvirt tarball creation time","status":"open","priority":"Wishlist","author":"Patrick","description":"The current tar.xz compression code is a burden since it literally takes hours. Currently building VBox and KVM images until upload finished therefore takes more than a day.\n\n----\n\n* https://github.com/Whonix/whonix-developer-meta-files/blob/master/release/prepare_release\n* https://github.com/Whonix/whonix-developer-meta-files/blob/c04a5a7ea638e8a60df65c07a26d41423177cc49/release/prepare_release#L35-L91\n\n----\n\nUsing `tar` `--xz` and `--mtime=\"2014-05-06 00:00:00\"` so the archives are deterministic.\n\nUsing `--sparse`...\n\n```\n-S, --sparse\n    handle sparse files efficiently\n```\n\n----\n\nThe replacement requirements:\n\n* faster than current one\n* deterministic\n* handle [sparse files](https://www.whonix.org/wiki/KVM#sparse_files) efficiently\n** currently the result of the compression is reducing the a sparse file with a real size of ~ `4.5` GB (and apparent size `100` GB) workstation qcow2 file to ~ `1.5` GB tar.xz.\n** the new file size should be similarly small\n** (not `100` GB reduced to ~ `30` GB)\n\n-----\n\nThe priority is high, since this reduces my motivation to create Non-Qubes-Whonix images.","comments":[{"author":"HulaHoop","date_created":1484447234,"date_modified":1484447234,"content":"Found this SE thread on the topic. The benchmarks put LZ4 as the fastest option for compression and decompression - by a lot.\n\nhttps://unix.stackexchange.com/questions/108100/why-are-tar-archive-formats-switching-to-xz-compression-to-replace-bzip2-and-wha\n\nhttp://catchchallenger.first-world.info/wiki/Quick_Benchmark:_Gzip_vs_Bzip2_vs_LZMA_vs_XZ_vs_LZ4_vs_LZO"},{"author":"Patrick","date_created":1484456981,"date_modified":1484456981,"content":"[quote](https://forums.whonix.org/t/testing-whonix-installer-for-windows/2987/118?u=patrick) @anonymous1\n\n> I'm not experienced as to how to improve xz compression, assuming you don't want to experience with less known compressors.\n> \n> What I do know is that freearc (with its many unique compression filters and technologies such as srep) and nanozip are the best compressors around in terms of both speed and compression ratio. I don't know the details of the ticket you mentioned but I think srep might be the best tool to speed it up again. But then it is not deterministic, I'm not sure if there is a way to make it so\n\n-----\n\n[quote](https://forums.whonix.org/t/testing-whonix-installer-for-windows/2987/118?u=patrick) @anonymous1\n> Could it help trying tar implementation of other programs like 7zip?\n\n-----\n\n[quote](https://forums.whonix.org/t/testing-whonix-installer-for-windows/2987/118?u=patrick) @anonymous1\n> bsdtar or star didn't help?\n\n> http://unix.stackexchange.com/questions/120091/how-can-i-speed-up-operations-on-sparse-files-with-tar-gzip-rsync"},{"author":"HulaHoop","date_created":1484493217,"date_modified":1484493217,"content":"OK so its reproducibility > speed\n\n***\n\n>Most compression algorithms are deterministic. Being \"adaptive\" in no way contradicts being \"deterministic\": it only means varying behavior based on input, so if the input is the same, so will be the output.\n>You can easily verify this by compressing the same file several times using an algorithm of your choice (zip, gzip, bzip2, 7z, etc.) and comparing the outputs. For example on linux, you can run this command several times to compress the file /etc/fstab and compare if its checksum is the same each time: gzip < /etc/fstab | md5sum -\n\n>though the algorithm itself is indeed deterministic, the implementation will sometimes store additionnal information (file permissions, timestamps etc) which can make it look like the output is not deterministic. adding a touch on the file between the compress and decompress can generate a different zip even though the file's content did not change. That being said, it's still deterministic once all parameters are factored in. \n\nhttps://softwareengineering.stackexchange.com/questions/293941/any-deterministic-compression-algorithms-out-there\n\n***\n\nThe next best algo in speed is gzip and it explicitly supports disabling timestamps with\n\ngzip:!timestamp\n\nhttps://www.freebsd.org/cgi/man.cgi?tar%281%29\n\n***\n\nWith lz4 and tar this may be possible as it is with gzip:\n\nPreserve timestamp when compressing files with lz4 on linux\n\nhttps://stackoverflow.com/questions/33775634/preserve-timestamp-when-compressing-files-with-lz4-on-linux"},{"author":"anonymous1","date_created":1484771492,"date_modified":1484771492,"content":"@Patrick try asking this on encode.ru. You may get the best answers there"},{"author":"anonymous1","date_created":1484814836,"date_modified":1484815089,"content":"http://www.systutorials.com/qa/4/how-to-efficiently-archive-a-very-large-sparse-file\nhttps://stackoverflow.com/questions/13252682/copying-a-1tb-sparse-file\n\nAccording to these, there is a minimum kernel version and bsdtar version required for the efficient use of the sparse file. And if there is still a problem, it may be related to the filesystem. One person said it didn't work on reiserfs filesystem"},{"author":"anonymous1","date_created":1484815017,"date_modified":1484815299,"content":"Perhaps Patrick haven't tried bsdtar yet or perhaps it didn't work at the time he asked this question because the required version of bsdtar or other requirements was not in stable repositories\n\nhttp://unix.stackexchange.com/questions/120091/how-can-i-speed-up-operations-on-sparse-files-with-tar-gzip-rsync"},{"author":"anonymous1","date_created":1484857785,"date_modified":1484857785,"content":"@Patrick good news\n\ntar has finally added support for SEEK_DATA/SEEK_HOLE for sparse file detection in latest version 1.29\n\nhttps://savannah.gnu.org/forum/forum.php?forum_id=8545\n\nUpgrading to this version should speed up your compression without changing any command. Please let me know how it goes"},{"author":"Patrick","date_created":1484917111,"date_modified":1484917111,"content":"I see. That's great news indeed. New Whonix builds for Whonix 14 must be\ncreated on Debian stretch anyhow, so we have tar version 1.29 there.\nWill try soonish."},{"author":"Patrick","date_created":1484917961,"date_modified":1484917961,"content":"related:\nhttps://github.com/Whonix/whonix-developer-meta-files/commit/dd74f986f8a7dbb7582fba12133328ca6cfe7db9\nhttps://github.com/Whonix/whonix-developer-meta-files/commit/0a4f72d0221082b2b79ffa5644d3e510394a4cb8"},{"author":"Patrick","date_created":1484957095,"date_modified":1484957095,"content":"Still takes 70 minutes to compress both images (inside a VM, having an SSD already)."},{"author":"anonymous1","date_created":1484958950,"date_modified":1484969158,"content":"is there any improvement? how long did it take before?\n\nhave you tried any other tool to compare and find out if tar code is the culprit? could you give srep a try just for comparison?\n\nhave you tried lowering the xz compression level? even the lowest level is said to compress better and faster than highest gzip compression\n\nhttps://stackoverflow.com/questions/34464534/use-xz-instead-of-gz-very-slow\n\nlevels 0 1 2 should be much faster than the default 6, starting from 3 it seems to slow down considerably. I think 2 would be optimal but try 0 too\n\nhttps://stephane.lesimple.fr/blog/2010-07-20/lzop-vs-compress-vs-gzip-vs-bzip2-vs-lzma-vs-lzma2xz-benchmark-reloaded.html"},{"author":"HulaHoop","date_created":1485130243,"date_modified":1485130243,"content":"Maybe because the xz version (5.1.1) in Jessie is single threaded? xz 5.2 gains this feature.\n"},{"author":"anonymous1","date_created":1488920344,"date_modified":1488920344,"content":"any improvement?"},{"author":"Patrick","date_created":1489117488,"date_modified":1489117488,"content":"The `xz` command just uses about 10% of CPU and just about 90 MB RAM. `iotop -a` is below 1%.\n\nBuilding on Debian stretch with xz-utils `5.2.2-1.2` / tar `1.29b-1.1`. Using `ext4` as file system.\n\nAny idea why system load is so low? I'd like a much higher load so it goes faster.\n\n`libvirt_compress` function at time of writing:\nhttps://github.com/Whonix/whonix-developer-meta-files/blob/bb1907e319acda314a1c57df200ff1696f979971/release/prepare_release#L35-L98\n\nThe compression command from bash xtrace.\n\n    tar --create --verbose --owner=0 --group=0 --numeric-owner --mode=go=rX,u+rw,a-s --sort=name --sparse '--mtime=2015-10-21 00:00Z' --xz --directory=/home/user/whonix_binary --file Whonix-Gateway-14.0.0.4.0.libvirt.xz Whonix-Gateway-14.0.0.4.0.qcow2 Whonix-Gateway-14.0.0.4.0.xml Whonix_external_network-14.0.0.4.0.xml Whonix_internal_network-14.0.0.4.0.xml\n\nThe whole [`prepare_release`](https://github.com/Whonix/whonix-developer-meta-files/blob/master/release/prepare_release) script now took 21 minutes for Whonix-Gateway. libvirt archive creation is still that part that takes the longest time. Archive size: 1.2 GB.\n\nBy adding environment variable `XZ_OPT=\"-0\"`, time is down to 4:45 min, size is up to 1.4 GB.\n\nBy adding environment variable `XZ_OPT=\"-2\"`, time is down to 7:45 min, size is up to 1.3 GB.\n\n(`XZ_OPT=\"-0 --fail\"` makes it fail as expected. Did that as a test to see if environment variable `XZ_OPT` is honored.)\n\n-----\n\n>>! In T605#11756, @anonymous1 wrote:\n> @Patrick good news\n> \n> tar has finally added support for SEEK_DATA/SEEK_HOLE for sparse file detection in latest version 1.29\n> \n> https://savannah.gnu.org/forum/forum.php?forum_id=8545\n> \n> Upgrading to this version should speed up your compression without changing any command. Please let me know how it goes\n\nAs per https://savannah.gnu.org/forum/forum.php?forum_id=8545 it should be automatically using seek hole detection `on systems that support it`. How do I find out if my system supports it or how to enable it?\n\n-----\n\nIf you have other ideas to speed it up / shrink size while keeping it reproducible, could you suggest changes to the `prepare_release` script please? Perhaps by making a github pull request?"},{"author":"anonymous1","date_created":1489121812,"date_modified":1489121812,"content":"Other than lowering the compression level, maybe tar doesn't support multi threaded compression whereas on 7zip with xz or 7z compression I can utilize all of my cpu cores.\n\nplease try p7zip:\nhttps://packages.debian.org/stretch/p7zip-full\nhttps://sourceforge.net/projects/p7zip/files/p7zip/16.02/"},{"author":"anonymous1","date_created":1489122187,"date_modified":1489122227,"content":"xz doesn't seem to store file names or timestamps so it should be reproducible, you could still use tar with reproducible options to tar the files and maybe combine with p7zip's xz compression"},{"author":"anonymous1","date_created":1489123226,"date_modified":1489123459,"content":"there is some related information here:\nhttp://stackoverflow.com/questions/12313242/utilizing-multi-core-for-targzip-bzip-compression-decompression\n\nyou could also try XZ Utils, it has multi-threaded compression support for some time, perhaps you could do this\n\ntar --use-compress-program=xz\n\nbut it may not be multi-threaded then. the documentation for xz states that:\n\n- Multi-threaded compression can be enabled with the --threads (-T) option.\n\nI'm not sure if you can use this option from inside tar though"},{"author":"anonymous1","date_created":1489123878,"date_modified":1489123878,"content":"you could also try lowering or increasing the compression dictionary size to see how it affects the size and speed, however I don't know the commands"},{"author":"anonymous1","date_created":1489146107,"date_modified":1489146845,"content":"There is another tool called pxz (parallel xz): https://packages.debian.org/stretch/main/pxz\n\nCheck this page:\n\nhttps://www.peterdavehello.org/2015/02/use-multi-threads-to-compress-files-when-taring-something/\n\nOnce you get multi-threading, you could try highest compression levels to see how it goes\n\nAnd make sure that multi-threading doesn't somehow break reproducibility\n\nThere is a good list here: http://askubuntu.com/questions/258202/multi-core-compression-tools"},{"author":"anonymous1","date_created":1489147076,"date_modified":1489148758,"content":"It seems you could use something like this with xz utils:\n\nexport XZ_OPT=\"--threads=0\"\n\n\n```\n -T threads, --threads=threads\nSpecify the number of worker threads to use. Setting threads to a special value 0 makes xz use as many threads as there are CPU cores on the system.\nThe actual number of threads can be less than threads if the input file is not big enough for threading with the given settings or if using more\nthreads would exceed the memory usage limit.\n\nCurrently the only threading method is to split the input into blocks and compress them independently from each other. The default block size\ndepends on the compression level and can be overriden with the --block-size=size option.\n```"},{"author":"Patrick","date_created":1489165583,"date_modified":1489165583,"content":"https://manpages.debian.org/testing/xz-utils/xz.1.en.html\n\n-----\n\n\"--threads=0\" results in 100% CPU usage, yay!\n\n-----\n\nXZ_OPT=\"-0 --threads=0\"\n\n* Time down to 1:35.\n* Size up to 1.4 GB.\n\n-----\n\nXZ_OPT=\"-9 --extreme --threads=0\"\n\n* 6:56\n* 1.2 GB\n\n-----\n\nXZ_OPT=\"-6 --threads=0\"\n\n* 4:28\n* 1.2 GB\n* reproducible: yes\n\n-----\n\nXZ_OPT=\"-6 --threads=0\"\ninstalled pxz\nreplaced --xz with --use-compress-program=pxz\n(really uses pxz and not xz as per ps aux)\n\n* 4:54\n* 1.2 GB\n\n-----\n\nreplaced --xz with --use-compress-program=pxz\n\n* 4:54\n* 1.2 GB\n\n-----\n\nLooks like using tar with --use-compress-program=pxz really is not worth it.\n\nPerhaps worth trying pxz directly without tar? But then we might be back to non-reproducibility. Needs testing. Does pxz support to auto detect how much threads can be used maximum?"},{"author":"Patrick","date_created":1489165966,"date_modified":1489165966,"content":"set and export XZ_OPT=\"--threads=0\" makes sense either way. Therefore added.\n\n```\nset and export XZ_OPT=\"--threads=0\" to speed up libvirt archive creation\n\nThis might also speed up other operations where xz is used internally by\nother packages.\n\nThanks to @anonmos1 for the suggestion!\n\nhttps://phabricator.whonix.org/T605\n```\n\nhttps://github.com/Whonix/Whonix/commit/5d125180051fa55b5ec1ce50e16cdc8db6d6906d"},{"author":"anonymous1","date_created":1489168203,"date_modified":1489168203,"content":"awesome!"},{"author":"anonymous1","date_created":1489168350,"date_modified":1489168438,"content":"But I have a feeling it would produce different archives with different number of threads, single core vs dual core vs quad core vs custom vm cores\n\nyou could test this by setting the threads to 1, 2, 3, 8 and so on"},{"author":"Patrick","date_created":1489169492,"date_modified":1489169492,"content":"anonymous1 (anonymous1):\n> anonymous1 added a comment.\n> \n> \n>   But I have a feeling it would produce different archives with different number of threads, single core vs dual core vs quad core vs custom vm cores\n\nGood point.\n\nJust now tested --threads=1 vs --threads=8. Different checksum.\n\n--threads=8 vs --threads=8 however results in the same checksum.\n\nPerhaps I should change --threads=0 to --threads=8? (Assuming quad core\nwith 2 threads per core?)\n\nMay not be a problem on slower machines. --threads=30 (for testing\npurposes, exceeding available threads) also worked for me."},{"author":"Patrick","date_created":1489170128,"date_modified":1489170128,"content":"anonymous1 (anonymous1):\n> anonymous1 added a comment.\n> \n> \n>   you could also try lowering or increasing the compression dictionary size to see how it affects the size and speed, however I don't know the commands\n\nIs this different from -0 to -9 (--extreme) compression settings?\n\nIn other words... Do you think it is worth to play with various\n\"--dict=\" settings independent from the compression level setting for\nbetter speeds or smaller file sizes?"},{"author":"anonymous1","date_created":1489172578,"date_modified":1489172578,"content":"I think the default settings are optimal\n\n--threads=8 should still work on slower machines, however it would work like --threads=4 or --threads=2 I guess. In that case choosing the default threads is up to you, could you try with 4? it may not be too different from 8"},{"author":"anonymous1","date_created":1489173651,"date_modified":1489174350,"content":"If you have 8 threads and if using more than 8 produces same checksum as 8, then what I said would be true\n\nI would recommend 4 max, but it's your choice\n\nIt's also a good idea to test with same threads on different machines whether there is any variation or not"},{"author":"anonymous1","date_created":1489174728,"date_modified":1489174842,"content":"I think in the worst case you could care less about a perfectly reproducible end archive (tar.xz) and instead focus on the extracted (tar) file being reproducible, for example linux kernel files are compressed either xz or gz but only the tar itself is signed"},{"author":"Patrick","date_created":1489175639,"date_modified":1489175639,"content":">>! In T605#12649, @anonymous1 wrote:\n> I think the default settings are optimal\n\nOkay.\n\n> --threads=8 should still work on slower machines, however it would work like --threads=4 or --threads=2 I guess. In that case choosing the default threads is up to you, could you try with 4? it may not be too different from 8\n\n4 uses only 50% of CPU.\n\nDone, made that 8:\n\nhttps://github.com/Whonix/Whonix/commit/17581ebbd05cc04f5ed52637e675481ddecc0845\n\n>>! In T605#12650, @anonymous1 wrote:\n> If you have 8 threads and if using more than 8 produces same checksum as 8, then what I said would be true\n> \n> I would recommend 4 max, but it's your choice\n> \n> It's also a good idea to test with same threads on different machines whether there is any variation or not\n\nTheoretically lets say a single core machine might produce a different checksum than a quad core due to threads. But I doubt that. It's probably not using physical cpu threads but virtual cpu threads. `top -H` shows easily more than 500 virtual threads on a usual linux system.\n\nA few more threads than physical threads will probably only have a negligible performance penalty. 8 vs 4 should not matter on slow system. (However I speculate 10000 threads would cause significant overhead.)\n\n>>! In T605#12665, @anonymous1 wrote:\n> I think in the worst case you could care less about a perfectly reproducible end archive (tar.xz) and instead focus on the extracted (tar) file being reproducible\n\nHaving the final file reproducible makes verification instructions and automation a lot easier.\n\n* Then it's just \"rebuild the libvirt.xz, and compare the hashes\".\n* Otherwise it's \"rebuild libvirt.qcow2, download libvirt.xz, extract the qcow2, and compare the hashes, of the qcow2 files not libvirt.xz files.\n\nHypothetical the compressed libvirt.xz could contain an exploit against xz that compromises the system during decompression. By having reproducible libvirt.xz we can exclude that.\n\nFor now it does not really matter if libvirt.xz is reproducible. It's very far forward thinking, since Whonix reproducible images are for now far away unfortunately, see:\n\nhttps://forums.whonix.org/t/is-whonix-reproducible-yet-backdoor-protection\n"},{"author":"anonymous1","date_created":1489177615,"date_modified":1489177639,"content":"Could you please check how long it takes with 4 threads, using %50 of cpu is expected, it does not necessarily mean it will take twice as long\n\nWhat I expect is that a PC with 4 threads may not reproduce the same archive even if --threads=8 doesn't give any error, it may produce an archive like if you used --threads=4\n\nIf 4 threads doesn't change the build time much, that would be a safer default"},{"author":"anonymous1","date_created":1489179110,"date_modified":1489179110,"content":"This quoted part indicates physical cpu threads:\n\n\n```\nSetting threads to a special value 0 makes xz use as many threads as there are CPU cores on the system\n```"},{"author":"Patrick","date_created":1489180420,"date_modified":1489180420,"content":"anonymous1 (anonymous1):\n> anonymous1 added a comment.\n> \n> \n> Could you please check how long it takes with 4 threads, using %50 of\n> cpu is expected, it does mean it will take twice as long\n\nTakes 1 minute longer.\n\n> What I expect is that a PC with 4 threads may not reproduce the same\n> archive even if --threads=8 doesn't give any error, it may produce an\n> archive like if you used --threads=4\n\nIt doesn't. I already tried some number that exceeds my physical cores\nmore than twice (30) and had the same checksum each time I used the same\nnumber of threads (30). I am pretty sure it's virtual, not physical\nthreads. At that level at abstraction, it would make little sense to see\n\"wanted 30 threads, but just got 4 physical cores, will reduce threads\nsilently to 8\"."},{"author":"anonymous1","date_created":1489180758,"date_modified":1489180758,"content":"Did you compare your --threads=30 archive with --threads=8 archive?\n\nThey may turn out to be the same, or you can try any number bigger than 8\n\nIf that's the case, 4 is a safer default for reproducibility, with little impact on speed"},{"author":"anonymous1","date_created":1489180927,"date_modified":1489180927,"content":"I mean reproducibility \"between\" computers, not on the same one"},{"author":"anonymous1","date_created":1489181776,"date_modified":1489181776,"content":"I may be wrong, the best way to test this is to maybe create the same archive with half of the available cores in a VM however I can't do this, I don't have debian stretch\n\nBut at least one thing is clear, memory requirement is directly proportional to number of threads and if the machine at hand does not meet those requirements it will lower the number of these threads"},{"author":"anonymous1","date_created":1489182505,"date_modified":1489182505,"content":"I will try this with xz utils binaries first in Windows host and then with half of the available cores in Windows VM"},{"author":"anonymous1","date_created":1489186316,"date_modified":1489186423,"content":"Sorry for all this confusion, I think it is only a difference between whether the program \"tries\" to operate in a single-threaded mode or multi-threaded mode, when we use --threads=1 or don't specify it (default is 1) it compresses the whole file in a single block, however setting --threads 0 or bigger than 1 triggers the multi-threaded mode and the file is split into blocks depending on the compression level and then compressed resulting in a difference in the archive file. how many threads actually used is irrelevant. changing compression level or manually specifying the block sizes will change the outcome.\n\nwith setting --threads 8 instead of 0 we actually enforce the multi-threaded mode (splitting the file into blocks) and prevent at least one cause of non-determinism: when --threads is set to 0 inside a single core machine, xz operates in \"single-threaded mode\" and compresses the file in a single block whereas setting this to anything higher than 1 enforces \"multi-threaded mode\" without being multi-threaded at all but still splits and compresses the file in blocks. You can see this with a VM\n\nso it should be safe to set --threads to 8 or 16 or higher, this option means: \"use at most NUM threads\""},{"author":"anonymous1","date_created":1489245197,"date_modified":1489245197,"content":"If you have time could you check how long it takes with 5 or 6 threads? I think it will be near equal to 8, not for reproducibility reasons just for efficient use of system resources. There is probably no reason to use 16 cores on a machine that supports it which would be overkill"},{"author":"Patrick","date_created":1489405230,"date_modified":1489405230,"content":">>! In T605#12670, @anonymous1 wrote:\n> Did you compare your --threads=30 archive with --threads=8 archive?\n\nDoesn't make a difference in speed.\n\n>>! In T605#12675, @anonymous1 wrote:\n> If you have time could you check how long it takes with 5 or 6 threads? I think it will be near equal to 8, not for reproducibility reasons just for efficient use of system resources. There is probably no reason to use 16 cores on a machine that supports it which would be overkill\n\n6 causes 75% CPU, takes 4:59 minutes.\n\nActually I am for maximum system resource usage as default value. Capping stuff should be user opt-in, custom settings though the operating system by the user. (Run in a VM or use other tools to add caps to the build script.)"},{"author":"Patrick","date_created":1554401878,"date_modified":1554401878,"content":"Please kindly consider jointing the related discussion `improving compression of Whonix image downloads`:\nhttps://forums.whonix.org/t/improving-compression-of-whonix-image-downloads/7086"}]},"PHID-TASK-5u6dme3ixzygq4tquv3e":{"id":"604","title":"tor-controlport-filter security review","status":"resolved","priority":"Normal","author":"Patrick","description":"TODO: Check as far as some connection coming from the workstation talking to cpfpy can do something really bad such as getting a shell on the gateway.\n\nMalicious yml files are not part of the threat model. They are trusted. Because someone with the capability to place malicious yml files already has better options to compromise the system.","comments":[{"author":"joysn1980","date_created":1484632024,"date_modified":1484632024,"content":"https://github.com/joysn/control-port-filter-python/blob/master/usr/lib/tor-controlport-filter\n\nSmall change. I know this is not in the purview of this task, but may be good to have. \n\nload() is very in-secure function to have. It allows creating arbitrary Python objects. \nUsing safe_load(0 instead for loading yaml documents. The function safe_load() limits this to simple Python objects like integers,lists etc. It will prevent yaml document with embedded python/shell code in it."},{"author":"Patrick","date_created":1484654423,"date_modified":1484654423,"content":"Sure. Good to have. Thanks, merged!"},{"author":"joysn1980","date_created":1484746152,"date_modified":1484746152,"content":"Hi Patrick,\n\nI analyzed the file - /usr/lib/tor-controlport-filter\nThere are two \"entry points\"\n1) YML files (which is considered safe here)\n2) The commands which are entered by the workstation like\n- saveconfig\n- SIGNAL NEWNYM\n- could be anything\netc.\n\nWhat I found is that - parsing of commands are tightly bound , i.e. if \nany command is entered,  it is matched against the pre-defined set. If \nit does not match, it is filtered out.\nSo not much chance of security concern in that perspective."}]},"PHID-TASK-7fu367664lj4xwwqof7e":{"id":"603","title":"make sure control-port-filter-python exceptions end up in journal","status":"resolved","priority":"Normal","author":"Patrick","description":"This is an exception I forced by purposely adding a bug for demonstration purposes. (Renaming a `respond` to `espond`.)\n\nWhen running the filter from the command line, once can see any python exception it throws.\n\n```\n----------------------------------------\nException happened during processing of request from ('10.137.11.1', 45690)\nTraceback (most recent call last):\n  File \"/usr/lib/python3.4/socketserver.py\", line 613, in process_request_thread\n    self.finish_request(request, client_address)\n  File \"/usr/lib/python3.4/socketserver.py\", line 344, in finish_request\n    self.RequestHandlerClass(request, client_address, self)\n  File \"/usr/lib/python3.4/socketserver.py\", line 669, in __init__\n    self.handle()\n  File \"/usr/lib/tor-controlport-filter\", line 637, in handle\n    restrict_stream_events\n  File \"/usr/lib/tor-controlport-filter\", line 497, in handle_controlport_session\n    espond(\"250 OK\")\nNameError: name 'espond' is not defined\n---------------------------------------\n```\n\nBut when one is running it as a systemd service and looks into `sudo journalctl -f -u tor-controlport-filter`, then python exceptions do not end up in the journal.","comments":[{"author":"joysn1980","date_created":1484312548,"date_modified":1484312548,"content":"Kindly review\nhttps://github.com/joysn/control-port-filter-python/tree/master/usr/lib\nhttps://github.com/joysn/control-port-filter-python/blob/master/usr/lib/tor-controlport-filter\n\nOne line change will make sure that the python exceptions are logged and seen using sudo journalctl -f -u tor-controlport-filter"},{"author":"Patrick","date_created":1484319453,"date_modified":1484319453,"content":"Works for me! Merged.\n\nDoes `-e` have any disadvantages? If not, we should probably enable this for #sdwdate also."}]},"PHID-TASK-wkohobclwk635jo62qks":{"id":"602","title":"OnionMail","status":"wontfix","priority":"Normal","author":"HulaHoop","description":"\nOnionMail is a project that hasn't gotten its deserved publcity. Its supposed to be a Mixmaster-style service built on Tor. Its an anonymous mail server network which supports exiting messages. It doesn't add high latency guarantees of its own but it has a few benefits over using a mail service HS.\n\nhttp://en.onionmail.info\n\nThe best technical intro I found:\n\nhttps://hacker10.com/internet-anonymity/onionmail-an-anonymous-mail-server-running-on-tor/\n\nPros:\n\n* Makes pseudonymous mail account creation easier and safer than conventional services - in client registration possible.\n* Integrates with Icedove\n* Bi-directional communication possible enitrely inside the Tor network o with clearnet addresses\n* You don't have to trust their crypto implmentations if you use your own GPG key\n* Debian packages available via their repo\n* Written in memory safe Java\n\nCons:\n\n* I tried it out and its designed to only use a local Tor instance\n* Would need OpenJDK (not a big deal as so would I2P)\n\n\n***\n\nI am thinking about contacting them about changes we would like to see to improve compatibility with Whonix and UX. They made a GUI install wizard for TAILS but its outdated.\n\nhttp://en.onionmail.info/contacts.html\n\nAnother interesting software project they have is NTU which transparently directs traffic over SOCKS proxy servers to evade Tor bans. Interesting but haven't tried it yet.\n\nhttp://onionmail.info/ntu.html\nhttps://github.com/onionmail/ntu","comments":[{"author":"Patrick","date_created":1484298737,"date_modified":1484298737,"content":"> I tried it out and its designed to only use a local Tor instance\n\nBut with #anon-ws-disable-stacked-tor, #uwt and #control-port-filter-python would should be all set to make any application use Tor on Whonix-Gateway without any application support needed?"},{"author":"HulaHoop","date_created":1484329821,"date_modified":1484329821,"content":"Right. It should work but Onionmail complains that it can't access torrc on the WS."},{"author":"Patrick","date_created":1484347808,"date_modified":1484347808,"content":"- https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=799079\n- https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=799071\n\n----\n\nLooks rather outdated. Their repo (http://onionmail.info/repo.html) has only packages for wheezy, not jessie or stretch.\n\nIt most likely tries to use /etc/init.d/tor directly. This has always been a bug. The proper way and init system agnostic way is to use `service`. You could perhaps hack around that.\n\n`sudo touch /etc/init.d/tor`\n`sudo chmod +x /etc/init.d/tor`\n\n```\n#!/bin/bash\nset -x\ntrue \"$0 here\"\nexit 0\n```\n\nIf they'd port to python-stem or similar and started using Tor ControlPort to create hidden services, that would make Whonix compatibility a lot easier.\n\nonionmail directly appends /etc/tor/torrc (in the workstation). This btw is a Debian critical policy bug that would prevent the package from entering Debian. One would have to copy these hidden services config to the gateway. And then configure onionshare listen on eth0 (or all interfaces) rather than localhost. Or if that does not work, force it with bindp."},{"author":"HulaHoop","date_created":1484351869,"date_modified":1484351869,"content":"I contacted them lets see what they say:\n\nhttps://www.whonix.org/pipermail/whonix-devel/2017-January/000838.html"},{"author":"HulaHoop","date_created":1484756655,"date_modified":1484756655,"content":"No reply. I guess the project is dead - no releases for stable past Wheezy.\n\nClosing."},{"author":"HulaHoop","date_created":1484848866,"date_modified":1484848866,"content":"Heard back from them at last. They plan to release a newer version for Stretch in February and to rework the mail client GUI wizard."},{"author":"HulaHoop","date_created":1526474508,"date_modified":1526474508,"content":"Project looks dead no recent releases."}]},"PHID-TASK-24w46beh55fpdjk5wyzw":{"id":"601","title":"packages to re-add for Debian stretch","status":"resolved","priority":"Normal","author":"Patrick","description":"Not in Debian stretch, therefore troublesome when trying to upgrade Whonix to stretch. Will remove it for now and perhaps re-add it when it maybe reappears in stretch. Not an essential package.\n\nhttps://packages.debian.org/search?keywords=gtk3-engines-oxygen\n\n-----\n\nhttps://github.com/Whonix/whonix-developer-meta-files/tree/master/package_documentation","comments":[{"author":"Patrick","date_created":1484212855,"date_modified":1484212855,"content":"https://github.com/Whonix/anon-meta-packages/commit/1545b0059b292effac17fc423a76a346b37ebac5"},{"author":"Patrick","date_created":1486325863,"date_modified":1486325863,"content":"Was apparently replaced by gtk3-engines-breeze."}]},"PHID-TASK-ainnc22zrziso3cs2gkh":{"id":"600","title":"Integrating Guix/Nix Package Manager","status":"open","priority":"Normal","author":"HulaHoop","description":"\nNix is a powerful package manager for Linux and other Unix systems that makes package management reliable and reproducible. It provides atomic upgrades and rollbacks, side-by-side installation of multiple versions of a package, multi-user package management and easy setup of build environments. Also makes packaging easier than Debian. It also supports compiler hardening flags.\n\nhttps://nixos.org/nix/\n\nGNU Guix is based on it with some modifications.\n\nhttps://nixos.org/nix/\n\n***\n\nPros:\n\n* Has the potential to solve our problem of including external binaries in a safe reproducible way without the Debian freeze restrictions. \n\n* Does not interfere with apt or the system config in any way.\n\nCons:\n\n* Usability impact of running two package managers to keep the system updated. Wrapper scripts or some other way to notify users may be needed.\n\n***\n\n\nFound the dev thread about GNU Guix's Debian packaging attempts mentioned in:\n\nhttps://unix.stackexchange.com/questions/290423/can-guix-packages-be-delivered-to-other-distros\n\nThere was a GSoC 2016 project to get it into Debian but it didn't happen for many reasons.\n\nThere are good reasons why Guix and Nix do not follow the FHS but that means there will never be a package for them upstream. Attempts to conform to FHS caused Guix functionality to break and would mess up the nice clean install system it has:\n\nhttps://lists.gnu.org/archive/html/guix-devel/2016-02/msg01126.html\n\nInstead the guix project distributes a signed tarball with instructions to compile and install it which is far from optimal for us:\n\nhttps://www.gnu.org/software/guix/manual/guix.html#Binary-Installation\n\n***\n\nInstead of trying to get into Debian, the devs talked about the possibility of providing a .deb via their own repository that does not follow Debian standards but is very convenient for people who want to bootstrap install Guix:\n\nhttps://lists.gnu.org/archive/html/guix-devel/2016-02/msg01144.html\n\n\"Hosting a .deb file on our own server that users could download and\ninstall with dpkg would be perfect for us.\"\n\nThe blocker for this is Ubuntu's build process requirements are different from Debian's and so they shelved the whole thing:\n\nhttps://lists.gnu.org/archive/html/guix-devel/2016-02/msg01205.html\n\n\"Without a fully automated process to build .deb for several distros, I\ndon’t think we can offer to distribute .deb ourselves.  :-/\"\n\n\n***\n\nHere a Guix enthusiast discusses how to run Guix without compiling it. interesting but doesn't make it any easier in our case to distribute:\n\nhttps://dustycloud.org/blog/guix-package-manager-without-make-install/\n\n***\n\nWith this path blocked I decided to look at the Nix manager instead which is what Guix is based on anyway. And fortunately its a better situation. Signed Debian packages for stable are provided! and a script that fetches and validates the .deb. That means with some leg work it can be included in Whonix via our repos:\n\nhttps://nixos.org/wiki/Installing_Nix_on_Debian\n\nI looked at their package selection and it is impressive. Grsecurity, GNUnet and much more:\n\nhttps://nixos.org/nixos/packages.html\n\n\n***\n\nOther interesting reads:\n\nhttps://nixos.org/wiki/Hardened_NixOS#Features_in_development\n\nhttps://www.reddit.com/r/NixOS/comments/4btjnf/fully_setting_up_a_custom_private_nix_repository/\n\n***\n\n\n","comments":[{"author":"HulaHoop","date_created":1484756119,"date_modified":1484756119,"content":"The main and only purpose of getting Nix into Whonix was GNUnet. Now that Nix stopped making new debs, there is no point of considering this task further.\n\nClosing."},{"author":"HulaHoop","date_created":1484929688,"date_modified":1484929688,"content":"GNUnet guys are looking into having the Guix devs provide debs."},{"author":"HulaHoop","date_created":1489445266,"date_modified":1489445266,"content":"https://lists.torproject.org/pipermail/tor-dev/2017-March/011993.html"},{"author":"Deleted Author","date_created":1498417945,"date_modified":1645737120,"content":""},{"author":"HulaHoop","date_created":1498492577,"date_modified":1498492577,"content":"Understood and thanks for chiming in :)\n\n> *e: Just to be sure and to refresh my memory from the email exchanges we had a couple of hundreds of emails ago: this is just about torbrowser, or was there more to it?\n\nThat was the main thing I believe. Its true I was exploring a grsec patched libre-linux kernel via Guix too but with recent developments its an obsolete idea (grsec gone private and KSPP mainlining everything).\n"},{"author":"Deleted Author","date_created":1499070701,"date_modified":1645737111,"content":""},{"author":"HulaHoop","date_created":1500081801,"date_modified":1500081801,"content":"We are preparing for a major point release so nothing on this front is planned from our side in the short to medium term. We are on the lookout for anything coming from your side whenever you feel like it. "},{"author":"Deleted Author","date_created":1509393141,"date_modified":1645737102,"content":""},{"author":"Deleted Author","date_created":1520510413,"date_modified":1645737093,"content":""},{"author":"Deleted Author","date_created":1521197837,"date_modified":1645737080,"content":""},{"author":"HulaHoop","date_created":1521494121,"date_modified":1521494121,"content":"Awesome progress thanks for the updates :) Right, the advantage of Guix is precisely that it doesn't follow FHS. Its worth trying to ask for an exception from upstream no matter how slim the chances - at least there's more of a chance than never asking at all.\n\nDo you know if Gentoo or Arch document their technical implementation of Guix? I would also like your help in writing a proposal outlining the exact details of an exception on Debian that would work for you and Nix potentially. I will focus on Guix because they are Free Software focused but its still good to keep the door open for those who make different choices."},{"author":"Deleted Author","date_created":1521496578,"date_modified":1645737070,"content":""},{"author":"HulaHoop","date_created":1521721994,"date_modified":1521721994,"content":"A switch to /opt/ seems like a great compromise that can shut up the FHS zealots. Is this something the Guix guys can do or is it for the adopting distro to handle?"},{"author":"Deleted Author","date_created":1525005345,"date_modified":1645737062,"content":""},{"author":"HulaHoop","date_created":1526649475,"date_modified":1526649551,"content":"> If you would have read the chat content (which I assume you didn't), you would see some insight into the problems and what possible solutions there are.\n> \n\nI actually did. Some of it may be over my head by I'm getting there:) I think if Debian wants to customize Guix to conform to their \"standard\" they would probably be OK with running their own substitute mirror. Would you see this as a good thing or something that introduces fragmentation?\n\nSorry if this is taking longer than it should. I want to nail down the fine details and find the best solution before writing a proposal. This way I won't have to edit it and lose mind-share in the process."},{"author":"Deleted Author","date_created":1532013171,"date_modified":1645737051,"content":""},{"author":"Deleted Author","date_created":1532013598,"date_modified":1645737028,"content":""},{"author":"HulaHoop","date_created":1532276590,"date_modified":1532276676,"content":"@ng0 I wrote a proposal draft. Feel free to improve it before I post:\n\n\nHello Dear Debian Coders and Maintainers,\n\nI will propose a process for integrating GNU Guix into Debian and working around potential roadblocks that have made the process difficult in the past.\n\nFor those unfamiliar, Guix is a package manager that supports reproducible builds, transactional upgrades and roll-backs, unprivileged package management, per-user profiles and more (please see: https://www.gnu.org/software/guix/manual/html_node/Features.html). \n\nIt uses Guile scheme to define package structure and system configurations. Its unique self-contained package installation allows it to be used seamlessly on any Linux distro while making sure no conflicts between it and the distro's default package manager arises. As an official GNU project it supports nothing but libre software so it should be compatible with DFSG. Also having Guix in Debian will allow access to more recent versions on software that is developed too rapidly to be otherwise practically usable from the official repos (for example GNUnet).\n\n***\n\nPotential problems and the way forward:\n\nThe fact that the default repo path is /gnu/store conflicts with Debian's strict FHS guidelines. A solution is to mount or patch /gnu/store to use /opt/guix. However this would break use of the official binary buildfarms and would require Debian to host its own independent instance that works with our customized paths.\n\nThere are some missing build/runtime dependencies such as guile-git and guile-ssh that would need packaging first but its not possible without more widespread interest:\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=850644\n\nA good starting point for a Guix deb package is this latest effort:\nhttps://github.com/detrout/debian-guix\n\nIf you have any further suggestions or requests please post them and the Guix people would be interested to collaborate on whatever it takes to realize this.\n\nI hope to kick-start a dialogue/interest in this project so please share your thoughts. Thanks.\n\n"},{"author":"Patrick","date_created":1562409607,"date_modified":1562409607,"content":"Any update?\n\nIf there was either,\n\na) signed `deb` of guix, or even better\nb) a signed deb package repository (reprepro) of guix.\n\nThat would allow integrating it into Whonix easily.\n\nRecently a non-controversial way of adding compiled software to Whonix was found:\n\nhttps://forums.whonix.org/t/policy-for-inclusion-of-compiled-software/6635\n\nViolations of FHS aren't great but acceptable, i.e. guix would be added to Whonix anyhow."}]},"PHID-TASK-jwbjbkgnxkowp7oe2wvr":{"id":"599","title":"bindp libindp.so C code fixes","status":"resolved","priority":"Normal","author":"Patrick","description":"Whonix forked [`bindp`](https://github.com/yongboy/bindp). Was required for #uwt (T561) ([bindp.c](https://github.com/Whonix/bindp/blob/master/bindp.c)).\n\n* https://github.com/yongboy/bindp\n* https://github.com/Whonix/bindp\n\n-----\n\nCompilation:\n    gcc -nostartfiles -fpic -shared bindp.c -o libindp.so -ldl -D_GNU_SOURCE -D_FORTIFY_SOURCE=2 -g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -fPIE -pie -Wl,-z,relro -Wl,-z,now\n\n-----\n\nTODO:\n\n* check and fix\n\n>>! In T561#11378, @marmarek wrote:\n> The only issue I see is it replace address in all `bind` calls - even those with different address family than `AF_INET`. In that case, address structure may be different (and also have different size) and strange things may happen. If a particular application use only `AF_INET` binds, it should be ok. You can check with `strace` and `grep`.\n\n----\n\n* Bonus nice to have:\n** Fix the `ld` warning\n*** `/usr/bin/ld.bfd.real: warning: cannot find entry symbol _start; defaulting to 0000000000000660` - https://github.com/yongboy/bindp/issues/2\n\n-----\n\n* Bonus nice to have:\n** Make the stack canary work - https://github.com/yongboy/bindp/issues/3\n\n-----\n\nhttps://github.com/slimm609/checksec.sh\n\n```\n/path/to/checksec.sh --file /path/to/libindp.so\n```\n```\nRELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE\nFull RELRO      No canary found   NX enabled    PIE enabled     No RPATH   No RUNPATH   libindp.so\n```\n\n-----\n\nThis ticket is based on @marmarek's feedback in T561#11378.\n","comments":[{"author":"s.sh","date_created":1487752906,"date_modified":1487752906,"content":"Unfortunately the problem with this code has not been explained clear enough. It says \"The only issue I see is it replace address in all bind calls\" but in file 'https://github.com/Whonix/bindp/blob/master/bindp.c' there is no check for address family in your bind function, instead the check is done in connect function at line 145. Unless the packet which is sent to this connect function is corrupted I don't see a reason that the condition (rsk_in->sin_family == AF_INET) return a wrong result. A little more explanation about the problem would help solve it better."},{"author":"Patrick","date_created":1487754439,"date_modified":1487754439,"content":"Btw not so much \"our\" package. We forked it from https://github.com/yongboy/bindp. Please fix any issues you are seeing with it. Untrusted, corrupted, malicious packages as input should be expected."},{"author":"s.sh","date_created":1487758005,"date_modified":1487758345,"content":""},{"author":"s.sh","date_created":1487758834,"date_modified":1487759334,"content":"What this code is doing is pretty clear but I don't know for what reason someone should use it. It simply binds the socket to a specific local address instead of the address the programmer of the external command probably decided to use. This results the incomming communication receive to that address instead of the default one . Note that this code only changes the LOCAL address whether the external command be client or server. It only does an additional bind() call. I should know how you use it that caused the problem so that I can reproduce the problem and work on it.\nI used protocol families other than AF_INET and didn't observe the problem you reported. "},{"author":"Patrick","date_created":1487770143,"date_modified":1487770143,"content":"The purpose of bindp in Whonix is to force applications listening on localhost to rather listen on eth0 so these are reachable from the gateway. Essentially, it lets us use onionshare, ricochet, unMessage and ZeroNet in Whonix 14.  More details in T561.\n\nThe code where it is being used is this one:\nhttps://github.com/Whonix/uwt/blob/master/usr/lib/uwtwrapper#L238-L247\n\nUsing it manually without all the setup, this should emulate it:\n\n```\n## requires Debian stretch because ifconfig output changed\nBIND_ADDR=\"$(/sbin/ifconfig \"eth0\" | grep -oP 'inet \\K\\S+')\"\nLD_PRELOAD+=\" /path/to//usr/lib/uwt/libindp.so/\nexport BIND_ADDR\nexport LD_PRELOAD\nrun some server application that would listen to 127.0.0.1 as its default)but would now listen on eth0 instead\n```"},{"author":"s.sh","date_created":1487772413,"date_modified":1487772413,"content":"Ok but I still don't know when exactly the problem occurs. The only place where the protocol family is checked is at line 145. This is all the scenario of the program:\n\n1. An external program calls bind or connect\n2. If protocol family of the remote address is AF_INET then bind the socket to another address which we already specified.\n\nFrom the person who reported the issue with this code, all I understand is that for families other than AF_INET still the bind takes place, meaning the condition at line 145 becomes true even while the rsk_in->sin_family is something different than AF_INET. Is this what you say?"},{"author":"Patrick","date_created":1487809703,"date_modified":1487809703,"content":"Could you clarify this please? @marmarek "},{"author":"marmarek","date_created":1487811817,"date_modified":1487811817,"content":"The problem is not in `connect` function, but in `bind`. It assume AF_INET family, casting sk pointer to `struct sockaddr_in`. But if socket family is something different, the structure also may be different (for example `struct sockaddr_un` for AF_UNIX). In practice, besides misusing this library, the problem only applies to applications listening on both locak (AF_UNIX) and network (AF_INET) sockets. Because you don't use this library for AF_UNIX-only applications.\n\nCreated an issue for that: https://github.com/yongboy/bindp/issues/5"},{"author":"s.sh","date_created":1488749162,"date_modified":1488749162,"content":"@marmarek If the problem is only with applications listening on both AF_INET and AF_UNIX, I think the solution should be easy, we can change the bind function in a way that it only changes local address of the sockaddr_storage while the protocol family is AF_INET. For AF_UNIX address family there doesn't seem to be any need to change the address (the pathname of the socket). By applying these changes will the problem get solved? If yes, I will rewrite the bind function for you to test."},{"author":"marmarek","date_created":1488749654,"date_modified":1488749654,"content":">   @marmarek If the problem is only with applications listening on both AF_INET and AF_UNIX, \n\nYes, I think this is the only problematic case in practice. In theory\nthere is also a case when application use only AF_UNIX, but it doesn't\nmake sense to use bindp there.\n\nBTW what about children processes? Those also get LD_PRELOAD variable.\nIt may happen that application listening on AF_INET will eventually\nstart (directly or indirectly) application listening on AF_UNIX. Or\nanother application listening on AF_INET, which we don't want to change\nbind address...\nProbably do not apply to Whonix case, but in general it may happen.\n\n> I think the solution should be easy, we can change the bind function in a way that it only changes local address of the sockaddr_storage while the protocol family is AF_INET. For AF_UNIX address family there doesn't seem to be any need to change the address (the pathname of the socket). By applying these changes will the problem get solved? If yes, I will rewrite the bind function for you to test.\n\nYes, this should work."},{"author":"s.sh","date_created":1488824207,"date_modified":1488824207,"content":"@marmarek I changed bind function and uploaded the code at: http://pastebin.com/dZb4yedz\n\nYou only need to replace this function with the one in the main code. Please test and report the results to me. "},{"author":"Patrick","date_created":1488826096,"date_modified":1488826096,"content":"I created a branch address-family-check to ease review.\n\nhttps://github.com/Whonix/bindp/tree/address-family-check\n\nAdded change by @s.sh:\n\nhttps://github.com/Whonix/bindp/commit/78d4bedad1095f9446442dc5f3d764a50a46704e\n\nFixed intent style (hopefully - I am not a C coder):\n\nhttps://github.com/Whonix/bindp/commit/b683034da9765529f09247917136002b81c93ba3\n\nComparison:\n\nhttps://github.com/Whonix/bindp/compare/master...Whonix:address-family-check?expand=1\n\nCode question...\n\n```\n    switch (_pf){\n        case AF_INET:\n            {\n...\n            }\n            break;\n```\n\nExcuse me asking, but must that `break;` really be outside of the `{` `}`?\n\nCode you please do a static code level review (just looking at the code) (how to call this?)? @marmarek After that I'd do functionality testing."},{"author":"s.sh","date_created":1488826611,"date_modified":1488826611,"content":"@Patrick The reason that I inserted curly braces is that the first line after \"case AF_INET:\" is not syntactically a statement, to work around this you may use a dummy sentence or use braces like what I did. The break keyword can be inside that block; there is no difference. "},{"author":"Patrick","date_created":1488828277,"date_modified":1488828277,"content":"one more stylistic fix:\n\nhttps://github.com/Whonix/bindp/commit/82ab25298e1194570fe9ee1b76941c393bafcf77\n\n>>! In T599#12596, @s.sh wrote:\n> @Patrick The reason that I inserted curly braces is that the first line after \"case AF_INET:\" is not syntactically a statement, to work around this you may use a dummy sentence or use braces like what I did. The break keyword can be inside that block; there is no difference. \n\nGreat, moved the `break;` inside the curly braces.\n\nhttps://github.com/Whonix/bindp/commit/97c07294e558359dae1506be12be02ce4b1c3a45"},{"author":"Patrick","date_created":1488829133,"date_modified":1488829133,"content":"intent:\nhttps://github.com/Whonix/bindp/commit/37a63005354aa007907e04f87fe9ed1ed399e63d\n\n-----\n\nDo you know how to fix these compiler warning?\n\n```\ngcc -nostartfiles -fpic -shared bindp.c -o libindp.so -ldl -D_GNU_SOURCE   \nbindp.c: In function ‘_init’:\nbindp.c:83:27: warning: implicit declaration of function ‘inet_addr’ [-Wimplicit-function-declaration]\n         bind_addr_saddr = inet_addr (bind_addr_env);\n                           ^~~~~~~~~\nbindp.c: In function ‘bind’:\nbindp.c:129:21: warning: implicit declaration of function ‘inet_ntop’ [-Wimplicit-function-declaration]\n                     inet_ntop(AF_INET,&(lsk_in->sin_addr),original_ip,INET_ADDRSTRLEN);\n                     ^~~~~~~~~\n```"},{"author":"s.sh","date_created":1488829315,"date_modified":1488829315,"content":"@Patrick Add \n```\n#include <arpa/inet.h>\n```\n\nat the beginning of the file."},{"author":"Patrick","date_created":1488829604,"date_modified":1488829604,"content":">>! In T599#12599, @s.sh wrote:\n> @Patrick Add \n> ```\n> #include <arpa/inet.h>\n> ```\n> \n> at the beginning of the file.\n\nGreat! That worked. Added:\n\nhttps://github.com/Whonix/bindp/commit/09ea8adad40db9c62d5fe3847e8796796829ed90\n\n-----\n\nDo you know how to fix this `ld` warning?\n\n    gcc -nostartfiles -fpic -shared bindp.c -o libindp.so -ldl -D_GNU_SOURCE -D_FORTIFY_SOURCE=2 -g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -fPIE -pie -Wl,-z,relro -Wl,-z,now\n```\n/usr/bin/ld: warning: cannot find entry symbol _start; defaulting to 00000000000006e0\n```"},{"author":"s.sh","date_created":1488830580,"date_modified":1488830580,"content":"@Patrick You can compile without -fPIE (I think -fPIC is enough):\n\n\n```\ngcc -nostartfiles -fpic -shared bindp.c -o libindp.so -ldl -D_GNU_SOURCE -D_FORTIFY_SOURCE=2 -g -O2 -fstack-protector-strong -Wformat -Werror=format-security  -Wl,-z,relro -Wl,-z,now\n```\n\nBut these warnings are not related to my revisions, they probably existed in original code. "},{"author":"Patrick","date_created":1488832031,"date_modified":1488832031,"content":">>! In T599#12601, @s.sh wrote:\n> But these warnings are not related to my revisions, they probably existed in original code. \n\nYes. That is for sure. These are just part of the original issue description in this ticket at the very top. Was wondering if you'd like to fix those while you are at bindp.\n\n> @Patrick You can compile without -fPIE (I think -fPIC is enough):\n> \n> \n> ```\n> gcc -nostartfiles -fpic -shared bindp.c -o libindp.so -ldl -D_GNU_SOURCE -D_FORTIFY_SOURCE=2 -g -O2 -fstack-protector-strong -Wformat -Werror=format-security  -Wl,-z,relro -Wl,-z,now\n> ```\n\nThat indeed removes the `ld` warning but apparently reduced hardening. We'd like to have all compiler hardening flags enabled for better security. (As long as sensible in this situation.)\n\n`gcc -nostartfiles -fpic -shared bindp.c -o libindp.so -ldl -D_GNU_SOURCE -D_FORTIFY_SOURCE=2 -g -O2 -fstack-protector-strong -Wformat -Werror=format-security  -Wl,-z,relro -Wl,-z,now` results in:\n\n```\nRELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE\nFull RELRO      Canary found      NX enabled    DSO             No RPATH   No RUNPATH   libindp.so\n```\n\n`PIE`, `DSO` is shown as yellow by checksec.sh. What does `DSO` mean? Before it was green `PIE enabled`.\n\nCan we have all hardening with `PIE enabled` as well as without `ld` warning?"},{"author":"s.sh","date_created":1488832604,"date_modified":1488832604,"content":"> Can we have all hardening with `PIE enabled` as well as without `ld` warning?\n\nI don't think so, but I think PIE is more necessary for regular executables not dynamic libraries, since libraries are relocatable by nature. (Of course PIE adds some more optimization for ASLR mechanism, however)\nSo for now I can't say whether it's wise to remove PIE, it needs more research. \nYou can keep compiling with PIE, apparently the warning is about start entry which again I don't believe  is problematic for libraries. "},{"author":"s.sh","date_created":1488833329,"date_modified":1488833329,"content":">  What does `DSO` mean? \n\nMust be Dynamic Shared Object\n"},{"author":"s.sh","date_created":1488892723,"date_modified":1488893180,"content":"@Patrick Add \n\n```\nint main(int argc,char **argv){return 0;}\n```\n\nto the end of bindp.c, now compile with :\n\n```\ngcc -nostartfiles -fpic -shared --entry main bindp.c -o libindp.so -ldl -D_GNU_SOURCE -D_FORTIFY_SOURCE=2 -g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -fPIE -pie -Wl,-z,relro -Wl,-z,now \n```\nThe warning should disappear "},{"author":"Patrick","date_created":1488902100,"date_modified":1488902100,"content":"Did that.\n\nhttps://github.com/Whonix/bindp/commit/5019b6be908a0f7ab66af7cfd109a26bd0926423\n\n    checksec --file /usr/lib/uwt/libindp.so\n\n```\nRELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE\nFull RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   /usr/lib/uwt/libindp.so\n```\n\nPerfect! Now all compilation warnings are fixed and missing hardening features are implemented."},{"author":"s.sh","date_created":1488914067,"date_modified":1488914067,"content":"@Patrick Nice, now regular testing needs to be done from your side, please keep in mind that connect function has to change as well, but before that I must assure that current bind() works properly and as expected. If everything goes well I will write whole code from scratch for you by modifying init and connect functions. "},{"author":"Patrick","date_created":1488922544,"date_modified":1488922544,"content":"That's great! Thank you for your help! Just now tested. Unfortunately it does not work.\n\n```\nuser@host:~$ BIND_ADDR=10.137.11.80\nuser@host:~$ LD_PRELOAD=/usr/lib/bindp/libindp.so\nuser@host:~$ export BIND_ADDR\nuser@host:~$ export LD_PRELOAD\nuser@host:~$ /usr/bin/onionshare.anondist-orig a\n```\n> `Segmentation fault`"},{"author":"Patrick","date_created":1488923484,"date_modified":1488923484,"content":"no segfault:\n\n    gcc -nostartfiles -fpic -shared --entry main bindp.c -o libindp.so -ldl -D_GNU_SOURCE -D_FORTIFY_SOURCE=2 -g -O2 -fstack-protector-strong -Wformat -Werror=format-security -Wl,-z,relro -Wl,-z,now\n\n----\n\nsegfault:\n\n```\ngcc -nostartfiles -fpic -shared --entry main bindp.c -o libindp.so -ldl -D_GNU_SOURCE -fPIE -pie -Wdate-time -D_FORTIFY_SOURCE=2 -g -O2 -fdebug-prefix-map=/home/user/bindp=. -fstack-protector-strong -Wformat -Werror=format-security -Wl,-z,relro -Wl,-z,now\nuser@host:~/bindp$ LD_PRELOAD=/home/user/bindp/libindp.so onionshare.anondist-orig /home/user/a\nSegmentation fault\n```\n\n-----\n\nI think we can safely remove `-fPIE`? That solves the segfault and still shows all hardening flags."},{"author":"Patrick","date_created":1488923924,"date_modified":1488923924,"content":"Did that.\n\nhttps://github.com/Whonix/bindp/commit/725042f5d4865be27a9f2ac45a250219cee6d5cc\n\n```\nremove `-fPIE` to fix segmentation fault (we still use `-pie`)\n\nWe still have all hardening flags.\n\nchecksec --file /usr/lib/bindp/libindp.so\nRELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE\nFull RELRO      Canary found      NX enabled    PIE enabled     No RPATH   No RUNPATH   /usr/lib/bindp/libindp.so\n```\n\nWould it with `-fPIE` be more secure? If so, can this libindp.so be fixed to work with `-fPIE`?\n"},{"author":"Patrick","date_created":1488924034,"date_modified":1488924034,"content":"It's functional! Successfully changes the listener IP.\n\n    /usr/bin/onionshare.anondist-orig a\n```\nOnionshare 0.9.1 | https://onionshare.org/\n[-] LIB received AF_INET bind request\n[!] AF_INET: Leaving request unchanged\n[-] LIB received AF_INET bind request\n[!] AF_INET: Leaving request unchanged\nConnecting to Tor control port to set up onion service on port 17600.\nStaring ephemeral Tor onion service and awaiting publication\nPreparing files to share.\n[-] LIB received AF_INET bind request\n[!] AF_INET: Leaving request unchanged\n[-] LIB received AF_INET bind request\n[!] AF_INET: Leaving request unchanged\n * Running on http://127.0.0.1:17600/ (Press CTRL+C to quit)\nGive this URL to the person you're sending the file to:\nhttp://3i4em3y4rkxbntqj.onion/daley-err\n\nPress Ctrl-C to stop server\n```"},{"author":"s.sh","date_created":1488954166,"date_modified":1488954166,"content":"Well the segfault error is strange here, I must run it locally with your setup to check and debug which is not possible for now, but it's good you made it work finally. Good job Patrick. Still I think PIE related options are not needed for libraries. \nI will modify the code by tonight and send the new revisions."},{"author":"Patrick","date_created":1488984868,"date_modified":1488984868,"content":"Okay, great!\n\nWhy did you add `#ifdef SO_REUSEPORT`?\n\n> `if (l_bind_addr && l_bind_port) {`\n\nAs a minor point, I think the debug messages are slightly broken. It shows `[!] AF_INET: Leaving request unchanged` since we are only setting envrionment variable `BIND_ADDR` and leaving `BIND_PORT` unset."},{"author":"s.sh","date_created":1488997673,"date_modified":1488997673,"content":">>! In T599#12621, @Patrick wrote:\n> \n> Why did you add `#ifdef SO_REUSEPORT`?\n> \n\nIt was in the original code; not added by me. SO_REUSEPORT is defined in asm-generic/socket.h but apparently the original author wanted to make sure it is defined.  \n\n> As a minor point, I think the debug messages are slightly broken. It shows `[!] AF_INET: Leaving request unchanged` since we are only setting envrionment variable `BIND_ADDR` and leaving `BIND_PORT` unset.\n\nYes I know, I will fix it.\n\n"},{"author":"s.sh","date_created":1489001836,"date_modified":1489001836,"content":"@Patrick \nCode fixed. Please check and use this: http://pastebin.com/GvDpuC0f"},{"author":"Patrick","date_created":1489009697,"date_modified":1489009697,"content":"Added that. And added some intent style changes. Please tell me if my C intent style is actually making things non-standard / worse than before.\n\nhttps://github.com/Whonix/bindp/blob/address-family-check/bindp.c\n\nThat version is currently broken. (In comparison git master version is still functional which makes me reasonable sure nothing else in the setup is broken.)\n\n```\nOnionshare 0.9.1 | https://onionshare.org/\n[-] LIB received AF_INET bind request\n[-] Changing 127.0.0.1 to 10.137.11.80\n[-] AF_INET: Leaving port unchanged\n[-] LIB received AF_INET bind request\n[-] Changing 127.0.0.1 to 10.137.11.80\n[-] AF_INET: Leaving port unchanged\n[-] LIB received AF_INET bind request\n[-] Changing 127.0.0.1 to 10.137.11.80\n[-] AF_INET: Leaving port unchanged\n[-] LIB received AF_INET bind request\n[-] Changing 127.0.0.1 to 10.137.11.80\n[-] AF_INET: Leaving port unchanged\nCan't connect to Tor control port on port [9151, 9153, 9051]. OnionShare requires Tor Browser to be running in the background to work. If you don't have it you can get it from https://www.torproject.org/.\n```\n\nMight it perhaps bend a few too many connections, i.e does it bend now connections for 127.0.0.1 that it should not change?"},{"author":"s.sh","date_created":1489010701,"date_modified":1489010701,"content":"@Patrick I need more debug info, I suspect the connect function is causing trouble. \nPlease use this and send the output again: http://pastebin.com/BZqTRBTc"},{"author":"Patrick","date_created":1489012831,"date_modified":1489012831,"content":"```\nOnionshare 0.9.1 | https://onionshare.org/\n[-] LIB received AF_INET bind request\n[-] Changing 127.0.0.1 to 10.137.11.80\n[-] AF_INET: Leaving port unchanged\n[!] connect(): AF_INET connect() call\n[-] LIB received AF_INET bind request\n[-] Changing 127.0.0.1 to 10.137.11.80\n[-] AF_INET: Leaving port unchanged\n[!] connect(): AF_INET connect() call\n[-] LIB received AF_INET bind request\n[-] Changing 127.0.0.1 to 10.137.11.80\n[-] AF_INET: Leaving port unchanged\n[!] connect(): AF_INET connect() call\n[-] LIB received AF_INET bind request\n[-] Changing 127.0.0.1 to 10.137.11.80\n[-] AF_INET: Leaving port unchanged\nCan't connect to Tor control port on port [9151, 9153, 9051]. OnionShare requires Tor Browser to be running in the background to work. If you don't have it you can get it from https://www.torproject.org/.\n```\n\nCould you please base any other changes on top of the current https://github.com/Whonix/bindp/blob/address-family-check/bindp.c so it keeps intent and typo fixes?"},{"author":"s.sh","date_created":1489075125,"date_modified":1489075125,"content":"@Patrick Updated: http://pastebin.com/9XcTZwVG"},{"author":"Patrick","date_created":1489077608,"date_modified":1489077608,"content":"Works for me!\n\n```\n/usr/bin/onionshare.anondist-orig a\nOnionshare 0.9.1 | https://onionshare.org/\n[-] LIB received AF_INET bind request\n[-] Changing 127.0.0.1 to 10.137.11.80\n[-] AF_INET: Leaving port unchanged\n[-] connect(): AF_INET connect() call, binding to local address\n[-] LIB received AF_INET bind request\n[-] Changing 10.137.11.80 to 10.137.11.80\n[-] AF_INET: Leaving port unchanged\nConnecting to Tor control port to set up onion service on port 17600.\nStaring ephemeral Tor onion service and awaiting publication\nPreparing files to share.\n[-] LIB received AF_INET bind request\n[-] Changing 127.0.0.1 to 10.137.11.80\n[-] AF_INET: Leaving port unchanged\n[-] connect(): AF_INET connect() call, binding to local address\n[-] LIB received AF_INET bind request\n[-] Changing 10.137.11.80 to 10.137.11.80\n[-] AF_INET: Leaving port unchanged\n * Running on http://127.0.0.1:17600/ (Press CTRL+C to quit)\nGive this URL to the person you're sending the file to:\n[redacted]\n```\n\n```\nsudo netstat -tulpen | grep python\ntcp        0      0 10.137.11.80:17600      0.0.0.0:*               LISTEN      1000       375953     20647/python3\n```\n\n(The usual operating mode of onionshare [that has nothing to do with bindp] is that it first creates the ephemeral Tor hidden service using Tor control protocol commands add_onion etc. and once is notices that it's ready starts the webserver on 127.0.0.1. [Which #uwt / #bindp bends to `eth0`'s IP in this example `10.137.11.80`.])"},{"author":"s.sh","date_created":1489078191,"date_modified":1489078224,"content":"@Patrick Do you have anything else from this project remained that needs extra working on ? "},{"author":"Patrick","date_created":1489083543,"date_modified":1489083543,"content":"Functionally speaking, as I tested, it works great in Whonix. Pretty much done.\n\nDo you see any things a malicious application could to gain arbitrary code execution through bindp?\n\nIn the final version we need to disable debug mode by default, but that is trivial. (Already tried that and it's working.)\n\nFor now, the only missing thing is a code review for https://github.com/Whonix/bindp/blob/address-family-check/bindp.c. Only @marmarek comes to mind who could do that.\n\nLower priority, but I'd still like to see these changes upstreamed (git pull request to the original author at https://github.com/yongboy/bindp). That would give us another code review, prevent us maintaining a fork at Whonix, and we'd benefit from further development/review by others."},{"author":"Patrick","date_created":1489084546,"date_modified":1489084546,"content":"Notified upstream. Let's see if he replies.\n\nbindp pull request - `security fixes, debian packaging, and more`:\nhttps://github.com/yongboy/bindp/pull/6"},{"author":"s.sh","date_created":1489143347,"date_modified":1489146677,"content":"\n> Do you see any things a malicious application could to gain arbitrary code execution through bindp?\n\nVery unlikely. I used standard socket functions. If a malicious program could use bindp to gain code execution it most probably can do the same with regular socket applications too.  But I will check it more observantly when I got the time to.\n\n\n> Lower priority, but I'd still like to see these changes upstreamed (git pull request to the original author at https://github.com/yongboy/bindp). That would give us another code review, prevent us maintaining a fork at Whonix, and we'd benefit from further development/review by others.\n>Notified upstream. Let's see if he replies.\n\nFrom experience, I can say if the person does not answer within 2 days he won't answer at all. \n"},{"author":"Patrick","date_created":1490525761,"date_modified":1490529216,"content":""},{"author":"Patrick","date_created":1490529208,"date_modified":1490529221,"content":""},{"author":"Patrick","date_created":1497627683,"date_modified":1497627683,"content":"Merged into master."},{"author":"s.sh","date_created":1497629735,"date_modified":1497629735,"content":"@Patrick In the master branch the only difference in comparison to the original version that I can see is the main function at the bottom of the file. Did you not apply the changes? This code is still the previous one."},{"author":"Patrick","date_created":1497632464,"date_modified":1497632464,"content":"Now pushed."},{"author":"s.sh","date_created":1497635218,"date_modified":1497635230,"content":">>! In T599#13705, @Patrick wrote:\n> Now pushed.\n\nI see debug_enabled is '1'; maybe it's better we disable debug messages for final release."},{"author":"Patrick","date_created":1497637016,"date_modified":1497637016,"content":"Thanks! Done.\n\nWhat about...?\n\n```\n    /*\n        FIXME: Be careful when using setsockopt\n        Is it valid to use these options for AF_UNIX?\n        Must be checked\n    */\n```\n\nIs good enough?"},{"author":"s.sh","date_created":1497637269,"date_modified":1497637269,"content":"> What about...?\n\nI believe the answer to the question that I mentioned in the comment, needs more extensive research, maybe at a later time, with having that fact in mind, I think the code would be prettier if this comment block is removed. Now as you wish."},{"author":"Patrick","date_created":1499082768,"date_modified":1499082768,"content":">>! In T599#12631, @Patrick wrote:\n> Notified upstream. Let's see if he replies.\n> \n> bindp pull request - `security fixes, debian packaging, and more`:\n> https://github.com/yongboy/bindp/pull/6\n\n>>! In T599#12640, @s.sh wrote:\n> From experience, I can say if the person does not answer within 2 days he won't answer at all. \n\nA miracle has happened. All of https://github.com/yongboy/bindp/pull/6 was merged by upstream.\n"},{"author":"s.sh","date_created":1499108098,"date_modified":1499108098,"content":"> A miracle has happened. All of https://github.com/yongboy/bindp/pull/6 was merged by upstream.\nVery well. So finally they applied our patch."}]},"PHID-TASK-cmvvljmfyhic5dxa7lsj":{"id":"598","title":"sdwdate-gui tray icon invisible in Debian stretch","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/sdwdate-gui\n\nIt's tray icon is invisible inside #debian_stretch . It's fully functional still, but invisible.\n","comments":[{"author":"Patrick","date_created":1484460213,"date_modified":1484460213,"content":"When [sni-qt](https://packages.debian.org/stretch/sni-qt) is installed:\n\n* passive popups (when hovering over the systray icon) works\n* systray icon is invisible but functional\n\nWhen [sni-qt](https://packages.debian.org/stretch/sni-qt) is not installed:\n\n* passive popups (when hovering over the systray icon) broken\n* systray icon is visible and functional\n"},{"author":"joysn1980","date_created":1486455500,"date_modified":1486455500,"content":"As discussed with Patrick the issue is with the new KDE 5 (Plasma) architecture\n\nhttp://blog.martin-graesslin.com/blog/2014/03/system-tray-in-plasma-next/\nhttps://blog.martin-graesslin.com/blog/2014/06/where-are-my-systray-icons/\n\nPython3 + PyQt5 resolved the issue. \nCurrently the sdwdate_gui uses python2.7 + PyQt4\nWe need to port it to PyQt5 which needs python3 as well.\n\nAfter porting, the new look is like attached\n\nTooltips\n{F111644}\n\n{F111646}\n\nRight Click\n{F111648}\n\n\nLeft Click\n{F111650}\n\n\n"},{"author":"Patrick","date_created":1486488019,"date_modified":1486488019,"content":"Looks great!"},{"author":"Patrick","date_created":1486490290,"date_modified":1486490290,"content":"These screenshots were useful to create a homepage for sdwdate-gui. There is now a homepage for both, sdwdate and sdwdate-gui.\n\n* https://www.whonix.org/wiki/sdwdate\n* https://www.whonix.org/wiki/sdwdate-gui"},{"author":"joysn1980","date_created":1486535461,"date_modified":1486535461,"content":"https://github.com/joysn/sdwdate-gui/tree/master/usr/lib/python3.4/dist-packages/sdwdate_gui\n\nFew things\n1) I am not sure what changes are needed to make sure that we do\n\n```\nsudo apt-get install python3-pyqt5\n```\n\nwhich is necessary for this change to work. Let me know if any files needs to be modified for that.\n\n2) The original sdwdate_gui.py was located at\n/usr/lib/python2.7/dist-packages/sdwdate_gui/sdwdate_gui.py\n\nI created new directory for python3.4\n/usr/lib/python3.4/dist-packages/sdwdate_gui/sdwdate_gui.py\n\n3) In Debian Stretch is works seamlessly, but in Debian Jessie, we see some extra errors [but does not change any functionalities]\n\n```\nlibGL error: pci id for fd 10: 80ee:beef, driver (null)\nlibGL error: core dri or dri2 extension not found\nlibGL error: failed to load driver: vboxvideo\n```\n\nI googled and find the issue to be VM related but no fix as such apart from start using newer versions.\n\n4) I am not sure how do I display the actual changes since this commit is a \"new file\". Do you want me to make another commit, which is on top of existing sdwdate_gui.py so that you can \"view\" the changes? Any other way?\n\n"},{"author":"Patrick","date_created":1486563724,"date_modified":1486565735,"content":"1. These packaging related changes are done in git master. (And can be seen in the git history.)\n\n2. I deleted the python2.7 version to make the diff easier to read and since we no longer need the python2.7 version. Moved from python3.4 files to python3 to fix a lintian warning. I am not too sure about that, perhaps it would have been better to move to python3.5, but it works. On Debian /usr/bin/python3 is a symlink to python3.5.\n\n3. Never mind about jessie. As long as it works on stretch we are well set for the future.\n\n4. It's alright now in git master. By deleting the 2.7 version in a separate branch and then using git diff -C the diff was very easy to review.\n\nI broke https://github.com/Whonix/sdwdate-gui/blob/master/usr/lib/sdwdate-gui/show_message (by changing to python3). Could you please port it to python3 / newer Qt also?"},{"author":"joysn1980","date_created":1486566675,"date_modified":1486566675,"content":"Here it is Patrick. \nhttps://github.com/joysn/sdwdate-gui/commits/master/usr/lib/sdwdate-gui/show_message"},{"author":"Patrick","date_created":1486567116,"date_modified":1486567116,"content":"Great! Merged. show_message (the popup) now functional again.\n\nI see two issues (might be code wise the same issue).\n\n`sdwdate-gui` -> right click \"exit\" ->\n`Segmentation fault`\n\n`sdwdate-gui` -> right click \"restart\" -> right click \"restart\" another time -> right click now ignored\n\nCould you look into it please?"},{"author":"joysn1980","date_created":1486571242,"date_modified":1486571242,"content":"Well this issue is seen only in \"Jessie\" not in \"Stetch\". Still I fixed this.\n\nhttps://github.com/joysn/sdwdate-gui/commits/master/usr/lib/python3/dist-packages/sdwdate_gui/sdwdate_gui.py\n\nThis change should fix the first issue of segmentation fault.\n\nSecond issue \n\n\n> sdwdate-gui -> right click \"restart\" -> right click \"restart\" another time -> right click now ignored\n\n\nI think this is a timing issue. As soon as you press restart, press once more restart, now right click just takes time - probably a good 30 seconds to appear.\n\nPatrick, can you confirm this behavior with the update code?"},{"author":"Patrick","date_created":1486591876,"date_modified":1486591876,"content":"> `sdwdate-gui` -> right click \"exit\" ->\n> `Segmentation fault`\n\nThis is fixed.\n\n> `sdwdate-gui` -> right click \"restart\" -> right click \"restart\" another time -> right click now ignored\n\n>>! In T598#12094, @joysn1980 wrote:\n> I think this is a timing issue. As soon as you press restart, press once more restart, now right click just takes time - probably a good 30 seconds to appear.\n\nRight. It becomes responsive again after a while. But why does it lock up? That's a new bug, that didn't happen in Whonix 13."},{"author":"joysn1980","date_created":1486617920,"date_modified":1486617920,"content":"Patrick,\n\nI see the same issue (repeated right click , restart ) is present even in the older version. Can you verify that once?\nIf so, we can fork \"unresponsive right click\" issue out of this ticket.\n\nThanks"},{"author":"joysn1980","date_created":1486634063,"date_modified":1486634063,"content":"Yes it is indeed by design.\nSome comments in the code\n\n\n```\n        ## When restarted from sdwdate-gui, allow sufficient time between\n        ## status changes. See related comment in sdwdate-gui.\n\n        ## When the file is quickly rewritten by another operation, reading\n        ## would fail. TOCTOU\n\n        ## QFileSystemWatcher may emit the fileChanged signal twice\n        ## or three times, randomly. Filter to allow enough time\n        ## between kill and restart popup in show_message(), and\n        ## prevent os.kill to raise an error and leave a gui open.\n```\n\n\nSo, I think if this needs a fix, this probably needs a re-design. A new ticket is desirable for that."},{"author":"Patrick","date_created":1486644623,"date_modified":1486644623,"content":">>! In T598#12098, @joysn1980 wrote:\n> I see the same issue (repeated right click , restart ) is present even in the older version. Can you verify that once?\n\nWorks for me in Whonix 13. Right click does not lock up.\n\n> Yes it is indeed by design.\n> Some comments in the code\n> \n> \n> ```\n>         ## When the file is quickly rewritten by another operation, reading\n>         ## would fail. TOCTOU\n>         try:\n>             with open(self.status_path, 'rb') as f:\n>                 status = pickle.load(f)\n>         except:\n>             return\n> ```\n\nI do not think this is related. Also possibly nothing can be done about it. It's about showing status messages. When one status is written and then sdwdate quickly progressing in the next moment and another status written. In these situation the one status that did not finish writing to disk is discarded and that later status that was written gets used.\n\n>         ## When restarted from sdwdate-gui, allow sufficient time between\n>         ## status changes. See related comment in sdwdate-gui.\n\nSame as below.\n\n> ```\n>         ## QFileSystemWatcher may emit the fileChanged signal twice\n>         ## or three times, randomly. \n> ```\n\nQFileSystemWatcher does not seem random. That would be a python bug. This was a previous issue which I might have quite some time ago here:\nhttps://github.com/Whonix/sdwdate-gui/commit/0046d2170000449c666fe5f80ec9440505867922\n\nDuring that time `./usr/share/sdwdate-gui/unit-test/fuzzer` was created. It creates tons of messages in a very short time to check if sdwdate-gui has an issue with that. sdwdate-gui then supported super fast file changes and never messed up.\n\n```\n        ## QFileSystemWatcher may emit the fileChanged signal twice\n        ## or three times, randomly. Filter to allow enough time\n        ## between kill and restart popup in show_message(), and\n        ## prevent os.kill to raise an error and leave a gui open.\n        if self.message != self.previous_message:\n            self.setToolTip('%s\\n%s' %(self.title, self.stripped_message))\n            self.update.update_tip.emit()\n        self.previous_message = self.message\n```\nThat comment may be outdated, but that code may be good to keep. If sdwdate gets or some other case it could indeed happen that it issues the same message twice. Protecting from duplicate passive popups seems useful.\n\n> So, I think if this needs a fix, this probably needs a re-design. A new ticket is desirable for that.\n\nCreated T626 for that."},{"author":"Patrick","date_created":1486664035,"date_modified":1486664035,"content":"TODO:\nNeed to check if this is solved once I have a new image working."},{"author":"Patrick","date_created":1486689386,"date_modified":1486689386,"content":"sdwdate-gui generally works, but after installing the `sni-qt` package, sdwdate-gui is invisible."},{"author":"joysn1980","date_created":1486988818,"date_modified":1486988818,"content":"I do not see the issue in my case. I have latest sni-qt installed and the sdwdate icon is also visible.\n\n{F134696}\n\nCan you check if you  see them inside status and notification?\n\n{F134698}"},{"author":"Patrick","date_created":1487082049,"date_modified":1487082049,"content":"I'll check in the next developers-only build."},{"author":"joysn1980","date_created":1487165183,"date_modified":1487165183,"content":"Just an update. \n\nBy default each system tray icon has \"visibility\" value \"Auto\".  Meaning, we have to press \"Up Arrow Key\" in the system tray icon to see the icon.\n{F169957}\n\nIn case, we always want the sdwdate to be always shown then we need to modify\n/home/user/.config/plasma-org.kde.plasma.desktop-appletsrc\nfile to  add the below line at  the end\n\n```\nshownItems=\\\\0\n```\n\nIt should be in the General Containments. The updated section will look like below\n\n```\n\n[Containments][7][General]\nextraItems=org.kde.plasma.notifications,org.kde.plasma.battery,org.kde.plasma.volume,org.kde.plasma.mediacontroller,org.kde.plasma.devicenotifier,org.kde.plasma.clipboard\nknownItems=org.kde.plasma.notifications,org.kde.plasma.battery,org.kde.plasma.volume,org.kde.plasma.mediacontroller,org.kde.plasma.devicenotifier,org.kde.plasma.clipboard\nshownItems=\\\\0\n```\n\n\nThrough UI it is easy, but the above can be updated using script. I am not sure what changes are to be done for this, so thought of posting this here."},{"author":"Patrick","date_created":1487189765,"date_modified":1487189765,"content":"Thanks for reporting!\n\nMaking edits in user's /home kde dirs directly isn't a clean solution. Easily breaks or breaks unrelated things or interferes with user settings.\n\nThe clean solution is dropping a kde configuration snippet. Here is an example, package https://github.com/Whonix/kde-dolphin-menubar-enable...  Essentially two files:\n\n* config file: https://github.com/Whonix/kde-dolphin-menubar-enable/blob/master/usr/share/kde-dolphin-menubar-enable/share/config/dolphinrc\n* environment variable: https://github.com/Whonix/kde-dolphin-menubar-enable/blob/master/etc/X11/Xsession.d/50kde-dolphin-menubar-enable\n* The other files are just for packaging purposes.\n\nThat worked in Debian jessie based Whonix. Currently broken in Debian stretch based Whonix. Apparently the KDEDIRS variable was abolished and hopefully replaced by something else. Still TODO to figure that out and fix.\n\nA similar solution for \"always show all tray icons\" or \"always show sdwate-gui\" might have to be added."},{"author":"Patrick","date_created":1487192308,"date_modified":1487192308,"content":">>! In T598#12298, @Patrick wrote:\n> That worked in Debian jessie based Whonix. Currently broken in Debian stretch based Whonix. Apparently the KDEDIRS variable was abolished and hopefully replaced by something else. Still TODO to figure that out and fix.\n\nMight have found a fix for that. More here: T633#12299"},{"author":"Patrick","date_created":1487545628,"date_modified":1487545628,"content":">>! In T598#12266, @Patrick wrote:\n> I'll check in the next developers-only build.\n\nWorks for me in non-published development build even without sni-qt package installed. After installation of the sni-qt package it's still working."}]},"PHID-TASK-2szhus23d2tfwlu7nula":{"id":"597","title":"ZeroNet Support","status":"resolved","priority":"Normal","author":"Patrick","description":"* https://www.whonix.org/wiki/ZeroNet\n* https://github.com/HelloZeroNet/ZeroNet/issues/756\n* https://github.com/Whonix/control-port-filter-python/commit/cdf1c35b5241396db86e2dc5e17d41f98557c7f3\n* https://github.com/Whonix/control-port-filter-python/blob/master/usr/share/tor-controlport-filter/examples/40_zeronet.yml\n","comments":[{"author":"HulaHoop","date_created":1484186628,"date_modified":1484186628,"content":" GPG signing 4096 bit keys:\n\nhttps://github.com/HelloZeroNet/ZeroNet/issues/759\n\nVideo Streaming Capability:\n\nhttps://github.com/HelloZeroNet/ZeroNet/issues/760\n\nNix Package:\n\nhttps://github.com/HelloZeroNet/ZeroNet/issues/761"},{"author":"Patrick","date_created":1484907433,"date_modified":1484907433,"content":"https://github.com/HelloZeroNet/ZeroNet/issues/756#issuecomment-274029807"},{"author":"Patrick","date_created":1485291574,"date_modified":1485291574,"content":">>! In T597#11786, @Patrick wrote:\n> https://github.com/HelloZeroNet/ZeroNet/issues/756#issuecomment-274029807\n\nThat was sorted out.\n\n-----\n\n- https://github.com/HelloZeroNet/ZeroNet/issues/794\n- https://github.com/HelloZeroNet/ZeroNet/issues/795\n"},{"author":"Patrick","date_created":1485292104,"date_modified":1485292104,"content":"Might work...\n\nQubes-Whonix:\n\n    BIND_ADDR=$(qubesdb-read /qubes-ip) LD_PRELOAD+=' /usr/lib/uwt/libindp.so' /home/user/ZeroNet/zeronet.py --tor always\n\nNon-Qubes-Whonix:\n\n    BIND_ADDR=10.152.152.10 LD_PRELOAD+=' /usr/lib/uwt/libindp.so' /home/user/ZeroNet/zeronet.py --tor always\n\n`sudo netstat -tulpen` shows that it does work, but due to https://github.com/HelloZeroNet/ZeroNet/issues/794 I cannot really know it really works.\n> `sudo netstat -tulpen`\n\n(redacted non-ZeroNet output)\n```\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode       PID/Program name\ntcp        0      0 10.137.11.80:43110      0.0.0.0:*               LISTEN      1000       72525       22927/python2.7 \ntcp        0      0 10.137.11.80:15441      0.0.0.0:*               LISTEN      1000       72531       22927/python2.7\n```\n\nThat is problematic. ZeroNet has two listeners. One for the web interface and one for communication.\n\nThe web interface that should stay at 127.0.0.1 because otherwise we would have to configure Tor Browser to allow local LAN connections. The communications listener however should be bend to to listen on the workstation external network interface, so the incoming Tor hidden services connection will work.\n\n`bindp` bends both of the listener IPs. I haven't found an option in `bindp` to have it listen on localhost in combination with the workstation external network interface.\n\nhttps://github.com/HelloZeroNet/ZeroNet/issues/795 would solve that issue."},{"author":"HulaHoop","date_created":1485397596,"date_modified":1485397596,"content":">bindp bends both of the listener IPs. I haven't found an option in bindp to have it listen on localhost in combination with the workstation external network interface.\n\nDo you find this usecase common enough for a bindp feature request?"},{"author":"Patrick","date_created":1485423848,"date_modified":1485423848,"content":"Certainly good to have. If you find any C people, perhaps suggest it to them?\n\nI doubt a feature request would help given the inactivity and non-reaction on existing tickets, but feel free.\n\nNot even sure it's possible to implement it at that level."},{"author":"Patrick","date_created":1487279353,"date_modified":1487279353,"content":"https://github.com/Whonix/anon-meta-packages/commit/751179b47ae1a78aeebbf6902f5f98c07f56bdb7"},{"author":"unman","date_created":1522762675,"date_modified":1522762675,"content":"Instructions are fine for Whonix and Qubes-Whonix 14.\nI've made some changes to the ZeroNet page to clarify installation.\n\nZero net can be installed and seems to work for loading sites and editing.\n\n"},{"author":"insurgo","date_created":1552518185,"date_modified":1552525618,"content":"@unman @Patrick : \n\nZeroNet inside of Whonix-ws doesn't permit content publishing following actual guide: https://www.whonix.org/wiki/ZeroNet and the proposed code change into ZeroNet https://github.com/HelloZeroNet/ZeroNet/pull/484#issuecomment-472620641 is not working as it is. \n\nCollaboration would be required to make things go forward and help ZeroNet/Whonix/QubesOS/Tor/Reasonably Secure hardware available, promoted and easily usable.\n\nWebsite publishing is not working right now inside QubesOS."}]},"PHID-TASK-jdfhcepbzuqgqzhw3u77":{"id":"596","title":"keep an eye on kloak anti keystroke deanonymization tool","status":"resolved","priority":"Normal","author":"Patrick","description":"kloak should be added to Whonix as soon as possible. This ticket is to keep track on kloak progress.\n\n-----\n\nCurrent status:\n\nWaiting for upstream to sort out various issues.\n\n- https://github.com/vmonaco/kloak/issues/1\n- https://github.com/vmonaco/kloak/issues/4\n\n-----\n\nMisc\n\n* T542\n* T583 contains discussion on where to install kloak by default host/dom0 vs inside Whonix.","comments":[{"author":"HulaHoop","date_created":1484068398,"date_modified":1484068398,"content":"Once Issue 1 is done. I'll update the TAILS ticket and let them know about our progress\n\nhttps://labs.riseup.net/code/issues/11257"},{"author":"Patrick","date_created":1533716924,"date_modified":1533716924,"content":"Dead upstream."},{"author":"HulaHoop","date_created":1533740137,"date_modified":1533740137,"content":"Why not ping him first? Its a waste of good work otherwise."},{"author":"HulaHoop","date_created":1533843432,"date_modified":1533843432,"content":"Ping:\nhttps://github.com/vmonaco/kloak/issues/10"},{"author":"HulaHoop","date_created":1533911822,"date_modified":1533911822,"content":"He was busy those past few months and thought there was no interest. @Patrick Expect a new release this coming week."},{"author":"Patrick","date_created":1551427413,"date_modified":1551427413,"content":"Many code enhancements were recently added by its author."},{"author":"Patrick","date_created":1553730913,"date_modified":1553730913,"content":"release kloak v0.2 \n\nhttps://github.com/vmonaco/kloak/releases/tag/v0.2"},{"author":"Patrick","date_created":1570391655,"date_modified":1570391655,"content":"Implemented for some time now.\n\nhttps://www.whonix.org/wiki/Keystroke_Deanonymization"}]},"PHID-TASK-yu2ydov2na5kv7mh7g6z":{"id":"595","title":"install onionshare by default in Whonix 15","status":"resolved","priority":"Normal","author":"Patrick","description":"[Lots of progress on getting onionshare to work in Whonix has been made.](https://forums.whonix.org/t/feature-request-onionshare-support/300/7?u=patrick)\n\nThere is a very good onionshare it will work in #whonix_14. But it will require a little user command line action.\n\nShould we install onionshare by default?\n\nThe #usability issue will be, that onionshare will not out of the box. We really shouldn't enable the [control-port-filter-python config for onionshare](https://github.com/Whonix/control-port-filter-python/blob/master/usr/share/tor-controlport-filter/examples/40_onionshare.yml) by default, as it enables the workstation to set up Tor hidden services. (And Tor with hidden services is less secure than Tor as client only.)\n\nonionshare in these cases currently fails in a usability wise very bad way. The gui keeps stuck in \"Starting the onionservice...\". (Posted an [onionshare feature request](https://github.com/micahflee/onionshare/issues/344) to improve the error handling. - But it most likely won't make it into #debian_stretch.)\n\nOur options are having it only available in Whonix onionshare documentation or installing it by default on still requiring a user to read and apply the Whonix onionshare documentation.\n\nFor Whonix releases later than Whonix 14, this could be improved usability wise. Most conveniently in Qubes-Whonix there could be on onionshare launch a qrexec call where then a gateway gui explains this and lets the user enable or not enable the required onionshare config.","comments":[{"author":"HulaHoop","date_created":1484062733,"date_modified":1484062733,"content":">Our options are having it only available in Whonix onionshare documentation or installing it by default on still requiring a user to read and apply the Whonix onionshare documentation.\n\nIMO its best to include it even if there is a couple of config steps needed. That would be one less step for an interested user to do. Generally including any upstream Tor apps is the way to go (unless there is a major reason not to)."},{"author":"Patrick","date_created":1484731877,"date_modified":1484731877,"content":"https://github.com/Whonix/anon-meta-packages/commit/bad339b38a23a83f4d1373ac6bfd6e5c4a9799f3"},{"author":"HulaHoop","date_created":1547232393,"date_modified":1547232393,"content":"Onionshare is in Buster. \nhttps://packages.debian.org/buster/onionshare\n\nOnce it is tested and included by default T771 can be closed.\n"},{"author":"Patrick","date_created":1554561397,"date_modified":1554561397,"content":"added\n\nhttps://github.com/Whonix/anon-meta-packages/commit/1d6e7372311995c881b4f556b51573df08d88c1e"}]},"PHID-TASK-rwgstqdtu3zt7ux6jewu":{"id":"594","title":"ship additional example profiles in control-port-filter-python package","status":"resolved","priority":"Low","author":"Patrick","description":"Alright, we won't whitelist onionshare and others by default and planned to document in the wiki to add additional profiles.\n\nNow that @joysn1980 sorted out `add /etc/tor-controlport-filter.d configuration drop-in snippet configuration extension feature` (T576), and now that the onionshare profile has just now been completed by me, I think it is better to ship the profile in `/usr/share/tor-controlport-filter/examples/40_onionshare.yml`. That way the user does not have to copy it from the wiki.\n\nEnabling the profile would boil down to:\n\n    sudo cp /usr/share/tor-controlport-filter/examples/40_onionshare.yml /etc/tor-controlport-filter.d\n\nOr perhaps a symlink would be even better?\n\nWe could even consider simplification of that copy [or symlink] command by providing a script to do that task or in a much later release even a gui to do that?","comments":[{"author":"Patrick","date_created":1483987053,"date_modified":1483987053,"content":"https://github.com/Whonix/control-port-filter-python/commit/008e642c04e099f1807e9766396d1d2ffa063f5a"},{"author":"Patrick","date_created":1483987090,"date_modified":1483987090,"content":"Also great to have this file under git revision control.\n\nhttps://github.com/Whonix/control-port-filter-python/blob/master/usr/share/tor-controlport-filter/40_onionshare.yml"},{"author":"Patrick","date_created":1483991882,"date_modified":1483991882,"content":"* https://github.com/Whonix/control-port-filter-python/commit/d875118428fe7877a14afcc6c5065b807c1cdfe7\n* https://github.com/Whonix/control-port-filter-python/commit/69bffd76788fa2ec2c497fe48083cd072043cb55\n* https://github.com/Whonix/control-port-filter-python/commit/6b51c6cc3e18a1d2c09bcef994b088adeebc1ff7"}]},"PHID-TASK-x2hgn4qmjlytjdg4exws":{"id":"593","title":"document disk image mounting of VirtualBox vmdk disks","status":"resolved","priority":"Normal","author":"Patrick","description":"- https://forums.whonix.org/t/virtualbox-transfer-files-from-whonix-to-host-with-disk-images/2189/4\n- https://www.whonix.org/wiki/File_Transfer#Mount_Disk_Image\n","comments":[{"author":"Patrick","date_created":1484343642,"date_modified":1484343642,"content":"This was done by @TNTBOMBOM:\n\n* https://www.whonix.org/w/index.php?title=File_Transfer&type=revision&diff=27845&oldid=27685\n* https://www.whonix.org/wiki/File_Transfer#Mount_Disk_Image"}]},"PHID-TASK-7r2bq6kb3vfcb4rwnihd":{"id":"592","title":"fix whonix-setup-wizard in Debian stretch","status":"resolved","priority":"Normal","author":"Patrick","description":"The gui does not start.\n\nhttps://github.com/Whonix/whonix-setup-wizard","comments":[{"author":"Patrick","date_created":1486130375,"date_modified":1486130375,"content":"Apparently just a dependency issue. Fixed in 13.0.0.1.4.\n\nhttps://forums.whonix.org/t/whonix-13-0-0-1-4-developers-only"}]},"PHID-TASK-44774ooej6hd4tji35ou":{"id":"591","title":"whonixcheck --clearnet connectivity test","status":"open","priority":"Normal","author":"Patrick","description":"To debug connectivity issues for users claiming to live in uncensored areas a `--clearnet` switch might be helpful for #whonixcheck.\n\nIt would only run on Whonix-Gateway and be run under user `clearnet`. Command here:\nhttps://www.whonix.org/wiki/Troubleshooting#Clearnet_Connectivity_Test\n\nObviously won't ever auto run on regular invocations of `systemcheck`.\n\nMight be fingerprintable. Users running that command might be revealed as Whonix users. Unless we find a test method that does not reveal one being a Whonix user.\n\nCan still discuss if this is a good idea at all.","comments":[]},"PHID-TASK-6apv3l4q6ccyhqtgjd3r":{"id":"590","title":"disable apt timer in Debian stretch","status":"resolved","priority":"Normal","author":"Patrick","description":"Since #debian_stretch there is an apt timer enabled by default by Debian.\n\nConflicts with our [rationale](https://www.whonix.org/wiki/Dev/Automatic_Updates) to not auto update.\n\nTODO\n\n* disable apt timer\n* investigate if any other unattended upgrades mechanisms are enabled by default, `grep -r -i unattended /etc`\n\nTo be added here:\nhttps://github.com/Whonix/pkg-manager-no-autoupdate\n","comments":[{"author":"Patrick","date_created":1483946540,"date_modified":1483946540,"content":"- https://github.com/Whonix/pkg-manager-no-autoupdate/commit/073d60f70ddfb83b88aba557eeb9bd3e74a26c34\n- https://github.com/Whonix/pkg-manager-no-autoupdate/commit/0aaddb5cc9ed23c4ca2c5fc6a2779371f0e9fbc0"}]},"PHID-TASK-dla6ul2xyeg6t5melnlc":{"id":"589","title":"disable timedatectl network time synchronization in Debian stretch","status":"resolved","priority":"Normal","author":"Patrick","description":"`timedatectl` shows its enabled.\n```\ntimedatectl\n```\n\nShould be disabled to prevent conflict with #sdwdate.","comments":[{"author":"Patrick","date_created":1484747441,"date_modified":1484747441,"content":"https://github.com/Whonix/sdwdate/blob/master/lib/systemd/system/systemd-timesyncd.service.d/40_sdwdate.conf"}]},"PHID-TASK-s6q22veen34pqjlmgpxr":{"id":"588","title":"improve Troubleshooting / Test","status":"resolved","priority":"Normal","author":"Patrick","description":"- https://www.whonix.org/wiki/Troubleshooting\n- https://www.whonix.org/wiki/Test\n\nThere is a TODO chapter on these pages.","comments":[{"author":"Patrick","date_created":1574366154,"date_modified":1574366154,"content":"Good enough."}]},"PHID-TASK-lgpke6rjdui7mqy4xx2t":{"id":"587","title":"fix tor-controlport-filter AppArmor profile","status":"resolved","priority":"Normal","author":"Patrick","description":"Since we ported to tor-controlport-filter it needs to be renamed and fixed.\n\nhttps://github.com/Whonix/control-port-filter-python/blob/master/etc/apparmor.d/usr.sbin.cpfpd","comments":[{"author":"joysn1980","date_created":1484214016,"date_modified":1484214016,"content":"Renaming done\nhttps://github.com/joysn/control-port-filter-python/tree/master/etc/apparmor.d\nhttps://github.com/joysn/control-port-filter-python/commit/3685f36aecea638ba2fb73d7daa31423fd396e4e"},{"author":"joysn1980","date_created":1484219171,"date_modified":1484219171,"content":"Changes to the security profile\nhttps://github.com/joysn/control-port-filter-python/blob/master/etc/apparmor.d/usr.lib.tor-controlport-filter\nhttps://github.com/joysn/control-port-filter-python/commit/34070b35c91b7262697dbefec3944b496d0da18d#diff-3aea4b328b5988f1301b6b1ad4d79359\n\nThe changes done in this merge should be harmless (more of a grep and replace), the obvious ones. Tested and nothing broke with these changes.\nMore changes (stricter profile) may be required after more testing. "},{"author":"Patrick","date_created":1484257092,"date_modified":1484257092,"content":"Nice! Tested and merged.\n\nBtw, please also consider...\n\n```\nsudo apt-get install apparmor-notify\n```\n\nand/or\n\n```\ngrep -i denied /var/log/syslog\n```\n"}]},"PHID-TASK-klcfo4przlrs5qyferzl":{"id":"586","title":"look into Sandboxed Tor Browser","status":"resolved","priority":"High","author":"Patrick","description":"* https://blog.torproject.org/blog/q-and-yawning-angel\n* https://forums.whonix.org/t/tor-browser-sandbox-linux-alpha-coming-soon\n* https://trac.torproject.org/projects/tor/ticket/2107\n* https://github.com/QubesOS/qubes-issues/issues/2540\n* https://github.com/projectatomic/bubblewrap/issues/134\n\nTODO:\n\n* ~~check Whonix compatibility (connectivity)~~ ([done](https://forums.whonix.org/t/tor-browser-sandbox-linux-alpha-coming-soon/3060/18?u=patrick))\n* find out why it does not work in Qubes Debian / Qubes-Whonix VMs\n* document","comments":[{"author":"Patrick","date_created":1483922732,"date_modified":1483922732,"content":"Calling this done.\n\n> TODO\n> * document\n\nWas documented by @torjunkie:\nhttps://www.whonix.org/wiki/Tor_Browser#Tor_Browser_Sandboxed\n\n> find out why it does not work in Qubes Debian / Qubes-Whonix VMs\n\nReported upstream and no way to make progress on that at Whonix.\n\n* https://trac.torproject.org/projects/tor/ticket/2107\n* https://github.com/QubesOS/qubes-issues/issues/2540\n* https://github.com/projectatomic/bubblewrap/issues/134\n"}]},"PHID-TASK-vjz2iwji55ja7oxn6rga":{"id":"585","title":"try / review / document qubes-split-browser","status":"open","priority":"Normal","author":"Patrick","description":"* http://forums.whonix.org/t/split-browser-for-qubes/3219/1\n* https://github.com/rustybird/qubes-split-browser","comments":[]},"PHID-TASK-h7oafeaohhmmwlojs7pt":{"id":"584","title":"upload Tor 0.2.9.8","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/testers-wanted-tor-stable-upgrades/3233/11?u=patrick","comments":[{"author":"Patrick","date_created":1483946467,"date_modified":1483946467,"content":"https://forums.whonix.org/t/testers-wanted-tor-stable-upgrades/3233/13?u=patrick"}]},"PHID-TASK-7ar5yivbiglfplrtpbdy":{"id":"583","title":"try kloak anti keystroke deanonymization tool and leave feedback","status":"resolved","priority":"High","author":"Patrick","description":"* https://github.com/vmonaco/keystroke-obfuscation/issues/1#issuecomment-268598887\n* https://github.com/vmonaco/kloak\n\nblockers for production use:\n\n* https://github.com/vmonaco/kloak/issues/1","comments":[{"author":"marmarek","date_created":1482618024,"date_modified":1482618024,"content":"> The above application grabs the input device, randomly delays the key\n> events, and writes the events to a user-level input device via uinput.\n\nFWIW this approach should work on Qubes (i.e. should be compatible with\nqubes-gui-agent)."},{"author":"Patrick","date_created":1483307927,"date_modified":1483307927,"content":"Wondering... Where are we going to install that tool? Wouldn't the anti keystroke deanonymization tool be better installed on the host / dom0 rather than inside Whonix VMs?\n\n* a) Having it installed inside the VM defeats keystroke deanonymization by remote servers (ssh, web, ...). Would be great!\n* b) Having it installed on the host / dom0 defeats a) as well as defeats keystroke deanonymization after VM compromise? Would be even better, no?!\n\nWhy not combine a) and b)? Or would using kloak twice perhaps mess something up?\n\nWondering what your thoughts are and depending on that we may follow up [asking the author of kloak](https://github.com/vmonaco/keystroke-obfuscation/issues/1#issuecomment-268598887) for advice.\n\nRelated:\n[this recent concern on native keyboards vs exploited VMs and keyboard layout based deanonymization](https://forums.whonix.org/t/does-qubes-whonix-still-use-the-dom0-keyboard-layout-as-default/3360)\n\nHaven't tried kloak myself yet. Will do so soon."},{"author":"Patrick","date_created":1483383000,"date_modified":1483383000,"content":"b) however when using clearnet (using non-Whonix connections) would lead to servers (ssh, web, ...) that are doing keystroke fingerprinting, these servers knowing that an anti keystroke fingerprinting tool is being. (For example when using a clearnet VM for banking or so.)\n\n* In the best case we could say - never mind, they can do loads of other fingerprinting techniques anyway when not using Tor Browser / Whonix.\n* In the worst case services that do keystroke fingerprinting for security purposes (such as banks) could trigger a false positive (user unable to log in due to triggering the fraud detection system). How likely is that?"},{"author":"Patrick","date_created":1483384572,"date_modified":1483384572,"content":"Currently trying inside Qubes-Whonix-Workstation using [kloak usage instructions](https://github.com/vmonaco/kloak#usage). However, reached a dead end for now.\n\n```\nsudo ./eventcap /dev/uinput\n```\n\n```\nReading From : /dev/uinput (Unknown)\nread(): No such device\n```\n\nThere is no input device in `/dev/input` folder either. Where is the \"`/dev/input/event4`\" keyboard device file equivalent in Qubes VMs if any? @marmarek \n\n(Compilation of `kloak` was super simple. Just run `make`.)"},{"author":"HulaHoop","date_created":1483387921,"date_modified":1483389461,"content":"> Wouldn't the anti keystroke deanonymization tool be better installed on the host / dom0 rather than inside Whonix VMs?\n\nYes. System wide protection and resistance to being disabled by root malware in a VM.\n\n> Why not combine a) and b)? Or would using kloak twice perhaps mess something up?\n\nCombining them would needlessly introduce longer delays and impact UX. As long as one instance works anything more is redundant.\n\n> https://forums.whonix.org/t/combination-of-custom-native-keyboard-layout-and-whonix-can-get-you-deanonymized-after-vm-exploit/3360\n\n\nNon-English typist fingerprinting:\n\n* A keylogger compromised VM + typing in a rare native language will narrow down the anonymity set.\n\n* non-English words have a higher fingerprinting success rate. [1] But given how efficient it is for English too I wouldn't say it matters also if the comment ends up published on the internet in that language then this threat model doesn't matter and is part of the general problem of Tor adoption.\n\n* According to a non-cited statement on the Wikipedia keystroke biometrics page [2] - The way a person types their native language's common sequences even when they are writing entirely in a different language, is just as revealing as an accent is in spoken English.\n\n* Have not found anything on keyboard layout fingerprinting. What I've seen mentioned as background information is different keyboard (hardware not layout)  do alter an individual's keystroke fingerprint but there are techniques to compensate for this.[3]\n\nConclusion: Picking the virtual hardware keyboard's layout to match the most common one is good practice. Since kloak randomly delays all presses it should be enough to destroy these other characteristics and to muddy the waters.\n\n[1] https://www.comp.nus.edu.sg/~tsim/documents/keystroke-dynamics-published.pdf\n[2] https://en.wikipedia.org/wiki/Keystroke_dynamics\n[3] http://www.ipcbee.com/vol13/32-R007.pdf - sourced from Wikipedia page"},{"author":"HulaHoop","date_created":1483390033,"date_modified":1483390033,"content":"> In the worst case services that do keystroke fingerprinting for security purposes (such as banks) could trigger a false positive (user unable to log in due to triggering the fraud detection system). How likely is that?\n\nGenerally its ok if they know fingerprinting is used. However in situations where you are absolutely compelled to provide a fingerprint for access you would temporarily disable it for banking.\n\nSlightly offtopic: The whole idea of keystroke biometrics for security is retarded because of replay attacks. An adversary can capture and spoof this."},{"author":"Patrick","date_created":1483391726,"date_modified":1483391726,"content":"Commented initial feedback here:\nhttps://github.com/vmonaco/keystroke-obfuscation/issues/1#issuecomment-270020900"},{"author":"Patrick","date_created":1483400050,"date_modified":1483400050,"content":">>! In T583#11246, @HulaHoop wrote:\n>> Wouldn't the anti keystroke deanonymization tool be better installed on the host / dom0 rather than inside Whonix VMs?\n> \n> Yes. System wide protection and resistance to being disabled by root malware in a VM.\n\nYes, that's what I had in mind.\n\n>> Why not combine a) and b)? Or would using kloak twice perhaps mess something up?\n> \n> Combining them would needlessly introduce longer delays and impact UX. As long as one instance works anything more is redundant.\n\nIf one runs on the host, the one in the VM is redundant indeed. However, we need to think through what happens in such cases. Running kloak on host and VM at the same time could actually make keystroke deanonymization easier. So if we go for installation of kloak on the host, perhaps if the package is installed in the VM it should do nothing. (systemd `ConditionVirtualization=false` [untested]) (Forethinking here, if that package ends up in Debian repository and gains popularity and users install it in the VM as a \"want to have\".)\n\nOn the other hand, if kloak is not [easily from distribution package repository] available on the host, having it installed inside the VM would be better than nothing. (Not defeating `b)`, but at least defeating `a)`.)"},{"author":"HulaHoop","date_created":1483462893,"date_modified":1483462893,"content":">So if we go for installation of kloak on the host, perhaps if the package is installed in the VM it should do nothing. (systemd ConditionVirtualization=false [untested]) (Forethinking here, if that package ends up in Debian repository and gains popularity and users install it in the VM as a \"want to have\".)\n\nYes that's the right way to go about this.\n\n>On the other hand, if kloak is not [easily from distribution package repository] available on the host, having it installed inside the VM would be better than nothing. (Not defeating b), but at least defeating a).)\n\nI am counting on it being available in Whonix repo so I can install it on the host. Long term plan is to get it in Debian as this deserves to be used everywhere possible. For Qubes I'm sure you can work out including it in Dom0.\n\nI asked anyway because it would be good to know anyhow. This can be tested too against keytrac."},{"author":"Patrick","date_created":1483561572,"date_modified":1483561572,"content":"Progress on packaging has been made. Will be contacting upstream about this soon.\n\n- https://github.com/Whonix/genmkfile/commit/395875355c5d92b57aae9aee36b1cb7f003d3e7a\n- https://github.com/Whonix/genmkfile/commit/01f4f7e6d47c638ed6162aadfcde559dfd665834\n- https://github.com/adrelanos/kloak/tree/debian\n- https://github.com/adrelanos/kloak/commit/31a017ab0e70a3a3a77f13ab6b0adee79c758d1c\n"},{"author":"marmarek","date_created":1483667458,"date_modified":1483667458,"content":">>! In T583#11241, @Patrick wrote:\n> Wondering... Where are we going to install that tool? Wouldn't the anti keystroke deanonymization tool be better installed on the host / dom0 rather than inside Whonix VMs?\n> \n> * a) Having it installed inside the VM defeats keystroke deanonymization by remote servers (ssh, web, ...). Would be great!\n> * b) Having it installed on the host / dom0 defeats a) as well as defeats keystroke deanonymization after VM compromise? Would be even better, no?!\n\nWhile indeed having it host-wide would be better for anonymity, it will significantly degrade UX. For example it will make interactive games mostly useless. So, if we want it in default configuration - do that only in Whonix VMs. We may include it as an _optional_ dom0 package for system-wide installation - if there is rpm packaging (or can be easily added).\n\n>>! In T583#11245, @Patrick wrote:\n> Currently trying inside Qubes-Whonix-Workstation using [kloak usage instructions](https://github.com/vmonaco/kloak#usage). However, reached a dead end for now.\n> \n> ```\n> sudo ./eventcap /dev/uinput\n> ```\n> \n> ```\n> Reading From : /dev/uinput (Unknown)\n> read(): No such device\n> ```\n>\n> There is no input device in `/dev/input` folder either. Where is the \"`/dev/input/event4`\" keyboard device file equivalent in Qubes VMs if any? @marmarek \n\nHmm, I was under impression it expect X server input device, not not Linux kernel input device. Qubes GUI agent do not expose the later. It shouldn't be hard to change that, but still it is some code change. Namely, rewrite [this function](https://github.com/QubesOS/qubes-gui-agent-linux/blob/master/gui-agent/vmside.c#L1323-L1413) (feed `/dev/uinput` instead of X input device).\n\n>>! In T583#11247, @HulaHoop wrote:\n> Slightly offtopic: The whole idea of keystroke biometrics for security is retarded because of replay attacks. An adversary can capture and spoof this.\n\nI don't agree here - it greatly depends on the threat model. For example I've seen its use for electronic school register (which was deployed as a web application). Students were highly creative to spy on passwords (small mirrors, mobile cameras etc), but it wasn't enough to reply type pattern accurately enough - at least in most cases. The solution was enough for this use case and much easier to use for (mostly non-technical) teachers than most of 2FA solutions."},{"author":"Patrick","date_created":1483726102,"date_modified":1483726102,"content":"\n\n>>! In T583#11253, @Patrick wrote:\n> Progress on packaging has been made. Will be contacting upstream about this soon.\n\nDone.\n\n* https://github.com/adrelanos/kloak/commit/db8aa69d975664080da5fb8fcdb15129c5aee263\n* https://github.com/adrelanos/kloak/commit/ab75d19d5894c4413488d7b82c6752423226b8a3\n* https://github.com/adrelanos/kloak/commit/0815f830ffae193b04cc68a50f2f499889c0c29f\n\n* https://github.com/vmonaco/kloak/issues/1\n* https://github.com/vmonaco/kloak/issues/2\n* https://github.com/vmonaco/kloak/issues/3\n* https://github.com/vmonaco/kloak/issues/4\n\n* https://github.com/vmonaco/kloak/pull/5\n"},{"author":"Patrick","date_created":1483727142,"date_modified":1483727142,"content":">>! In T583#11254, @marmarek wrote:\n>>>! In T583#11241, @Patrick wrote:\n>> Wondering... Where are we going to install that tool? Wouldn't the anti keystroke deanonymization tool be better installed on the host / dom0 rather than inside Whonix VMs?\n>> \n>> * a) Having it installed inside the VM defeats keystroke deanonymization by remote servers (ssh, web, ...). Would be great!\n>> * b) Having it installed on the host / dom0 defeats a) as well as defeats keystroke deanonymization after VM compromise? Would be even better, no?!\n> \n> While indeed having it host-wide would be better for anonymity, it will significantly degrade UX. For example it will make interactive games mostly useless. So, if we want it in default configuration - do that only in Whonix VMs. We may include it as an _optional_ dom0 package for system-wide installation - if there is rpm packaging (or can be easily added).\n\nI see.\n\nPerhaps this can become an option in Qubes installer (next to the other Whonix options). But one step at a time...\n\n(... Sorting out Debian packaging with upstream, waiting for upstream to fix the blockers mentioned in the links from my previous comment, perhaps upstreaming the Debian package to debian.org repository, sorting out rpm packaging, making it available as optional Qubes rpm package.)\n\n>>>! In T583#11245, @Patrick wrote:\n>> Currently trying inside Qubes-Whonix-Workstation using [kloak usage instructions](https://github.com/vmonaco/kloak#usage). However, reached a dead end for now.\n>> \n>> ```\n>> sudo ./eventcap /dev/uinput\n>> ```\n>> \n>> ```\n>> Reading From : /dev/uinput (Unknown)\n>> read(): No such device\n>> ```\n>>\n>> There is no input device in `/dev/input` folder either. Where is the \"`/dev/input/event4`\" keyboard device file equivalent in Qubes VMs if any? @marmarek \n> \n> Hmm, I was under impression it expect X server input device, not not Linux kernel input device. Qubes GUI agent do not expose the later. It shouldn't be hard to change that, but still it is some code change. Namely, rewrite [this function](https://github.com/QubesOS/qubes-gui-agent-linux/blob/master/gui-agent/vmside.c#L1323-L1413) (feed `/dev/uinput` instead of X input device).\n\nCreated [provide Linux kernel input device so kloak (anti keystroke deanonymization tool) can be used in Qubes-Whonix](https://github.com/QubesOS/qubes-issues/issues/2558) for it.\n\n>>>! In T583#11247, @HulaHoop wrote:\n>> Slightly offtopic: The whole idea of keystroke biometrics for security is retarded because of replay attacks. An adversary can capture and spoof this.\n> \n> I don't agree here - it greatly depends on the threat model. For example I've seen its use for electronic school register (which was deployed as a web application). Students were highly creative to spy on passwords (small mirrors, mobile cameras etc), but it wasn't enough to reply type pattern accurately enough - at least in most cases. The solution was enough for this use case and much easier to use for (mostly non-technical) teachers than most of 2FA solutions.\n\nIt's rather about goals. Probably safe to say, HulaHoop is happy with no less than perfect security. Some admins (like banks or universities) decided to be happy using a solution that may only work for a limited amount of time and that only stops most less dedicated abusers since there are not that many dedicated abusers."},{"author":"Patrick","date_created":1484049511,"date_modified":1484049511,"content":"This is done. Follow up task:\nT596"}]},"PHID-TASK-5jh4m7266hal3mv2k2is":{"id":"582","title":"revisit handling of /var/lib/dbus/machine-id","status":"open","priority":"Normal","author":"Patrick","description":"* https://lists.ubuntu.com/archives/apparmor/2016-February/009370.html\n* https://labs.riseup.net/code/issues/7100#change-64065\n","comments":[{"author":"madaidan","date_created":1557509268,"date_modified":1557509268,"content":"Would it cause any issues if the machine-id was just deleted or replaced with a bunch of 0s?\n\nWhat would happen if the permissions for /etc/machine-id and /var/lib/dbus/machine-id were restricted to root only?\n\nWould it be possible to do either of these?"},{"author":"Patrick","date_created":1557561463,"date_modified":1557561463,"content":">>! In T582#18461, @madaidan wrote:\n> Would it cause any issues if the machine-id was just deleted or replaced with a bunch of 0s?\n\nCould be.\n\n> What would happen if the permissions for /etc/machine-id and /var/lib/dbus/machine-id were restricted to root only?\n\nhttps://lists.ubuntu.com/archives/apparmor/2016-February/009371.html says it is used for various things so it might break some things.\n\n> Would it be possible to do either of these?\n\nPossible, yes. Since these files aren't owned by any packages it is easy to ship them."},{"author":"madaidan","date_created":1557595652,"date_modified":1557595652,"content":"> https://lists.ubuntu.com/archives/apparmor/2016-February/009371.html says it is used for various things so it might break some things.\n\nWouldn't using a fake machine-id e.g. a bunch of zeroes fix this? The programs are still able to use a machine-id and it isn't unique."},{"author":"Patrick","date_created":1557624108,"date_modified":1557625301,"content":"madaidan (madaidan):\n> madaidan added a comment.\n> \n> \n>   > https://lists.ubuntu.com/archives/apparmor/2016-February/009371.html says it is used for various things so it might break some things.\n>   \n>   Wouldn't using a fake machine-id e.g. a bunch of zeroes fix this?\n\nUsing something similar. Not using all zeros. A generated\n/var/lib/dbus/machine-id which is shared among all Whonix users.\n\nhttps://github.com/Whonix/anon-base-files/blob/master/var/lib/dbus/machine-id\n\nI don't think using all zeros would be superior to a generated one. Pros\nall zeros: more obvious to reviewer it's non-standard. Cons all zeros:\nmight fail a sanity test of some application? Pros generated: won't fail\nany sanity test. Cons generated: not obvious to reviewer that it's\nshared among all Whonix users.\n\nAll zero vs the current shared one probably makes no big difference.\n\nThe question that Tails asks in their issue tracker:\n\nhttps://redmine.tails.boum.org/code/issues/7100\n\n> Modern GNU/Linux tools (D-Bus, systemd) relies more and more on /etc/machine-id and/or /var/lib/dbus/machine-id (depending on the OS, versions, etc.). In most situations we care about, if not all, this ID should not be leaked to the network. If it is, then:\n>\n> * if we set the same machine-id everywhere, then users are all in the same anonymity set; but this also leaks that they're using Tails\n> * if we set unique machine-id on boot, then we don't leak that users are using Tails, and applications that rely on machine-id working on the LAN work; OTOH, if machine-id leaks on the Internet, then the fact that users are not in the same anonymity set can be a problem\n>\n> We should first evaluate if/how machine-id can be leaked, and then think about this all, and decide something."},{"author":"madaidan","date_created":1557664568,"date_modified":1557664568,"content":"The way it is now looks fine. Why would it need to be changed?"},{"author":"Patrick","date_created":1557675413,"date_modified":1557675413,"content":"Maybe there is no need. It's just when Tails has a ticket, we should\ncheck it at Whonix too. Thank you for looking into this, too!"},{"author":"Patrick","date_created":1561624431,"date_modified":1561624431,"content":"Will keep watching what Tails is doing."}]},"PHID-TASK-z5pfhdie6x6ep5e4oxie":{"id":"581","title":"check if latest onionshare changes still work with tor-controlport-filter","status":"resolved","priority":"Normal","author":"Patrick","description":"These might have broken it:\n\n* Add \"non-anonymous\" mode using Tor's recent 0.2.9.8 - https://github.com/micahflee/onionshare/issues/327\n* Control Port Authentication - https://github.com/micahflee/onionshare/pull/328\n* HidServAuth - https://github.com/micahflee/onionshare/pull/330\n* Support several different Tor configurations - https://github.com/micahflee/onionshare/issues/292\n* Tor config - https://github.com/micahflee/onionshare/pull/336\n\nTODO:\n\n* https://www.whonix.org/wiki/Next#onionshare\n* Install onionshare from git.\n* fix onionshare tor-controlport-filter config file if required\n","comments":[{"author":"Patrick","date_created":1483988562,"date_modified":1483988562,"content":"All done.\n\n> These might have broken it:\n> \n> * Add \"non-anonymous\" mode using Tor's recent 0.2.9.8 - https://github.com/micahflee/onionshare/issues/327\n\nNot yet implemented in onionshare.\n\n> * Control Port Authentication - https://github.com/micahflee/onionshare/pull/328\n\n[1] From the configuration ( https://cloud.githubusercontent.com/assets/156128/21556064/8ead0338-cdd2-11e6-918c-d4ca61724b52.png ) the default auto detected settings work. The other options also all work in all combinations.\n\n> * HidServAuth - https://github.com/micahflee/onionshare/pull/330\n\nSupport for that has been added to https://github.com/Whonix/control-port-filter-python/blob/master/usr/share/tor-controlport-filter/40_onionshare.yml. (T594)\n\n> * Support several different Tor configurations - https://github.com/micahflee/onionshare/issues/292\n\nSame as [1].\n\n> * Tor config - https://github.com/micahflee/onionshare/pull/336\n\nSame as [1].\n"}]},"PHID-TASK-5k7b2eyp7t7t633nofl3":{"id":"580","title":"Document recovery procedure after compromise","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/document-recovery-procedure-after-compromise","comments":[{"author":"HulaHoop","date_created":1482603304,"date_modified":1482603304,"content":"Let me know the title and place and I'll put something up."},{"author":"Patrick","date_created":1548233948,"date_modified":1548233948,"content":">>! In T580#11155, @HulaHoop wrote:\n> Let me know the title and place and I'll put something up.\n\nhttps://www.whonix.org/wiki/Disaster_Recovery"},{"author":"HulaHoop","date_created":1549075163,"date_modified":1549075163,"content":"Ready to close if happy."},{"author":"Patrick","date_created":1549186382,"date_modified":1549186382,"content":"I am slow to review this. Finally got to it. More feedback here:\n\nhttps://forums.whonix.org/t/document-recovery-procedure-after-compromise/3296/22?u=patrick"},{"author":"HulaHoop","date_created":1550512663,"date_modified":1550512676,"content":"Good for the time being, if anyone wants to add more there is an outline of what procedures can be done, to add to."}]},"PHID-TASK-y5wzlaxdupal53dbymwd":{"id":"579","title":"add --listen-interface to tor-controlport-filter","status":"resolved","priority":"Normal","author":"Patrick","description":"Much better than --listen-address (works better with dynamic IP addresses).","comments":[{"author":"joysn1980","date_created":1481872996,"date_modified":1481873019,"content":"https://github.com/joysn/control-port-filter-python/tree/master/usr/lib\n"},{"author":"Patrick","date_created":1482022667,"date_modified":1482022667,"content":"Works great! Merged. Thanks a lot!"}]},"PHID-TASK-552e6drh2ivf2vcn5wbo":{"id":"578","title":"port anon-shared-helper-scripts to using Tor authentication cookie usage","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1481746492,"date_modified":1481746492,"content":"https://github.com/Whonix/anon-shared-helper-scripts/commit/c097035631217617636f130bdfb90a12c774e8ce"}]},"PHID-TASK-2d5wq5qut5vl3zuhdnro":{"id":"577","title":"Accelerating the Build Script","status":"resolved","priority":"Normal","author":"HulaHoop","description":"I've looked at some ways to accelerate the build script to make building Whonix less painful. This is a very long-term item because breaking the script is serious problem and because other priorities but its definitely something worth doing at some point.\n\nLow hanging fruit:\n\n* Download one set of all packages and make a copy for the other image if gnw is selected to avoid downloading the same things twice. This alone would halve the time.\n\n\n* Parallelizing apt downloads using xarg - the older method before GNU Parallel's conception. Code licensed under  [[ https://creativecommons.org/licenses/by-nc-sa/2.5/ | Attribution-NonCommercial-ShareAlike 2.5 Generic  ]] \n\nhttp://tinylittlelife.org/?p=283 (inspired by the post beneath it) \nhttps://johntellsall.blogspot.nl/2009/04/fast-parallel-downloading-for-apt-get.html\n\n* Taking this further the image generation step can be done in parallel too though time savings will be less compared to download time reduction.\n\n***\n\nDisqualified but worth noting:\n\nhttps://johntellsall.blogspot.nl/2009/04/fast-parallel-downloading-for-apt-get.html\n\n> I found the tool \"apt-fast\" which downloads one or two files quickly, by downloading with multiple streams per file. This is somewhat sketchy, as it requires installation of additional software, assumes the file gets spliced together correctly, and doesn't gracefully handle network problems.\n\n* apt-fast - an apt wrapper that downloads package chunks from multiple mirrors in a \"bittorrent-esque\" way. If you are interested in it I could request the author gives it a license.\n\nhttp://xmodulo.com/speed-slow-apt-get-install-debian-ubuntu.html\nhttps://github.com/ilikenwf/apt-fast\n","comments":[{"author":"Patrick","date_created":1481625896,"date_modified":1481625896,"content":"> avoid downloading the same things twice\n\nDid you try using an apt-cache yet as per [build documentation, chapter apt cache](https://www.whonix.org/wiki/Dev/Build_Documentation/12_full#APT_Cache_.28Optional.29)?\n\n-----\n\nIt's not needed to always run the full build script. If you have an [overview](https://www.whonix.org/wiki/Dev/Source_Code_Intro#Introduction) on which build step is doing what, there is no need to always rerun the whole build script, no need to always rerun all build steps."},{"author":"HulaHoop","date_created":1481708878,"date_modified":1481708878,"content":"> Did you try using an apt-cache yet as per build documentation, chapter apt cache?\n\nHadn't noticed before. Is this affecting the host in any way? Can I do this in the VM only?\n\n> sudo -E ./build-steps.d/1100_prepare-build-machine --install-to-root --tor-gateway\n\nCan you please post an example that applies to both ws and gw?\n\nOfftopic:\n\nWhat does \"--install-to-root\" do?"},{"author":"HulaHoop","date_created":1481709631,"date_modified":1481709631,"content":"Looked it up: --install-to-root only relevant if building on the host\n\nhttps://github.com/Whonix/Whonix/blob/master/build-steps.d/1100_prepare-build-machine\n\nIs using \"-E\" only useful then?\n\n\nexport http_proxy=http://192.168.0.1:3142 -> http://10.152.152.11:3142\n"},{"author":"Patrick","date_created":1481736180,"date_modified":1481736180,"content":"--install-to-root is deprecated. That's --target root for a few releases now. For physical isolation.\n\n(So I don't know where you got --install-to-root from. Either outdated build documentation or you got outdated sources.)\n\n(For building KVM images, stay miles away from --target root.)\n\n(Also --tor-gateway is outdated so I guess your sources are outdated.)\n\nTo get an overview of all switches, use the following and scroll up a bit.\n\n```\nsudo ./whonix_build --gnw -- --help\n```\n\nOr look here: https://github.com/Whonix/Whonix/blob/master/help-steps/parse-cmd#L106\n\nAn apt-cache can be used anywhere. When building on the host and also when building inside the VM.\n\nUsing an apt-cache affects the host or VM in as far as using an apt-cache usually does while Whonix is not involved. So in case of apt-cacher-ng the daemon will be running and cache files somewhere in the root filesystem (configurable but usually it works fine out of the box without issues).\n\n`sudo -E` is useful to preserve environment variables. When you do\n\n* 1) export http_proxy=...\n* 2) sudo ./whonix_build\n\nthen whonix_build will not know about http_proxy because sudo clears the environment.\n\n`sudo http_proxy=... ./whonix_build` should also work. Environment variables wrt Whonix build script work the same way as they do on any Linux (at very least on any Debian based operating system).\n\nIt should also alternatively also be possible to set the http_proxy variable through a [build configuration snippet](https://www.whonix.org/wiki/Dev/Source_Code_Intro#Build_Configuration).\n\n> export http_proxy=http://192.168.0.1:3142 -> http://10.152.152.11:3142\n\nProbably neither. It's 127.0.0.1 unless you want to run apt-cacher-ng on a different system/VM over (virtual) LAN.\n\n-----\n\nSome examples:\n\n   sudo ./build-steps.d/1100_prepare-build-machine --build --flavor whonix-gateway --target qcow2\n\n   sudo ./build-steps.d/1150_export-libvirt-xml --build --flavor whonix-gateway --target qcow2\n\n   sudo ./build-steps.d/1700_install-packages --build --flavor whonix-workstation --target qcow2\n"},{"author":"HulaHoop","date_created":1481750059,"date_modified":1481750059,"content":"Thanks. The outdated [[ https://www.whonix.org/wiki/Dev/Build_Documentation/12_full#APT_Cache_.28Optional.29 | section ]] linked to confused me but I got it now.\n"},{"author":"Patrick","date_created":1481761332,"date_modified":1481761332,"content":"Still acceleration required?\n\nI am not sure it's great to add new features to Whonix build script. (parallel stuff, speed up stuff [not creating Debian base image and Whonix packages twice]...)\n\nWhonix build script is already a victim of TLDR. Making it more complex leads to even fewer people seeing through and/or wanting to work on it. It's only used to build Non-Qubes-Whonix.\n\nOn the contary, I have been considering to throw out lots of non-essential Whonix build script features and/or to replace Whonix build script with some other VM image build system.\n\nA list of features that Whonix build script currently features has been created just now. Grouped into essential, non-essential and undecided importance.\n\nhttps://www.whonix.org/wiki/Dev/Source_Code_Intro#Build_Script_Features\n\nFeel free to start a discussion or creating an alternative list (changing group priorities).\n\nFinding a VM build system that can do the minimum we decide essential features is a time consuming task to research, implement and test."},{"author":"HulaHoop","date_created":1481858249,"date_modified":1481858249,"content":">Still acceleration required?\n\nNo. I consider this ticket complete. apt-cacher-ng is a pretty cool addon that satisfies this need without complicating the buildscript itself.\n\n>Whonix build script is already a victim of TLDR. \n\nDon't say that. It was just a matter of RTFM. Its extensive features are a great thing actually.\n\n>Making it more complex leads to even fewer people seeing through and/or wanting to work on it. It's only used to build Non-Qubes-Whonix.\n\nIMO its already feature complete\n\n>Finding a VM build system that can do the minimum we decide essential features is a time consuming task to research, implement and test.\n\nTrue. Seems like waste of time to end up with something doing less than what we already have.\n\n\n"}]},"PHID-TASK-a7oequn5mqph44smfwlv":{"id":"576","title":"add /etc/tor-controlport-filter.d configuration drop-in snippet configuration extension feature","status":"resolved","priority":"Normal","author":"Patrick","description":"`/etc/tor-controlport-filter.d` folder does not work great with Whonix. It allows to drop yml files for [Tails per applications level separation](https://git-tails.immerda.ch/tails/tree/config/chroot_local-includes/etc/tor-controlport-filter.d?h=feature/7870-include_onionshare) but we won't have that level separation in Whonix.\n\nWhat is not possible is extending an existing yml config (without touching that file).\n\nSince porting to tor-controlport-filter by Tails, if multiple configs are matched it only uses one.\n\nWith legacy cpfpy it much more useful to tell users \"drop a new file\" which to extend the default config.\n\nTo give an example... In Whonix 13 with legacy cpfpy `/etc/cpfpy.d/30_default.conf` said\n\n```\nCONTROL_PORT_FILTER_WHITELIST=signal newnym\n```\n\nAnd in Whonix docs we could add:\n\n> create a new file /etc/cpfpy.d/50_user.conf and add\n>\n> ```\n> CONTROL_PORT_FILTER_WHITELIST=something\"\n> ```\n\nThat ability is lost since porting to tor-controlport-filter by Tails. As [control-port-filter-python](https://github.com/Whonix/control-port-filter-python) (now same as tor-controlport-filter by Tails) is implemented right now, we'd have to say open [`/etc/tor-controlport-filter.d/whonix.yml`](https://github.com/Whonix/control-port-filter-python/blob/master/etc/tor-controlport-filter.d/whonix.yml) and fully replace it's content, which is problematic. (hard to combine various configuration extensions, interactive dpkg conflict resolution dialogs during upgrading)\n\nRelated code block:\nhttps://github.com/Whonix/control-port-filter-python/blob/80542aa94dceb09f8d3158aea88a0e1cb7362ea5/usr/lib/tor-controlport-filter#L494-L508\n\nDoes this issue description make sense? EDIT: If it does not but you know what I mean, please edit it to improve it. If it does not, please contact me by e-mail, so I can improve it. (To keep this ticket discussion clean.)","comments":[{"author":"HulaHoop","date_created":1481707171,"date_modified":1481707171,"content":"Crystal."},{"author":"Patrick","date_created":1481904654,"date_modified":1481904654,"content":"proposal on yml config file merging:\nhttps://www.whonix.org/wiki/Dev/Control_Port_Filter_Proxy/tor-controlport-filter/config"},{"author":"joysn1980","date_created":1482409264,"date_modified":1482409283,"content":"https://github.com/joysn/control-port-filter-python/tree/master/usr/lib\n\nhttps://github.com/joysn/control-port-filter-python/commit/22ce6ba6ff6513e45d9166e6004d8748fd407eb0\n\nKindly review"},{"author":"Patrick","date_created":1482519824,"date_modified":1482519824,"content":"Combined with the version from https://www.whonix.org/wiki/Next#Configure_Control_Port_Filter_Proxy it worked. But the \"stripped down\" 40_onionshare.yml it did not work. Threw a python exception.\n\n\n30_whonix.yml:\n```\n---\n- match-exe-paths:\n    - '*'\n  match-users:\n    - '*'\n  match-hosts:\n    - '*'\n  commands:\n    SIGNAL:\n      - 'NEWNYM'\n    GETINFO:\n      - 'status/circuit-established'\n      - 'version'\n      - pattern: 'net/listeners/socks'\n        response:\n        - pattern:     '250-net/listeners/socks=\".*\"'\n          replacement: '250-net/listeners/socks=\"127.0.0.1:9150\"'\n  confs:\n    __owningcontrollerprocess:\n  events:\n    SIGNAL:\n      suppress: true\n    CONF_CHANGED:\n      suppress: true\n```\n\n\"stripped down\" 40_onionshare.yml\n```\n---\n- match-exe-paths:\n    - '*'\n  match-users:\n    - '*'\n  match-hosts:\n    - '*'\n  commands:\n    GETINFO:\n      - 'onions/current'\n    ADD_ONION:\n      - pattern:     'NEW:BEST Port=80,(176[0-5][0-9])'\n        replacement: 'NEW:BEST Port=80,{client-address}:{} Flags=DiscardPK'\n    DEL_ONION:\n      - '.+'\n  confs:\n    __owningcontrollerprocess:\n  events:\n    SIGNAL:\n      suppress: true\n    CONF_CHANGED:\n      suppress: true\n    HS_DESC:\n      response:\n        - pattern:     '650 HS_DESC CREATED (\\S+) (\\S+) (\\S+) \\S+ (.+)'\n          replacement: '650 HS_DESC CREATED {} {} {} redacted {}'\n        - pattern:     '650 HS_DESC UPLOAD (\\S+) (\\S+) .*'\n          replacement: '650 HS_DESC UPLOAD {} {} redacted redacted'\n        - pattern:     '650 HS_DESC UPLOADED (\\S+) (\\S+) .+'\n          replacement: '650 HS_DESC UPLOADED {} {} redacted'\n        - pattern:     '.*'\n          replacement: ''\n```\n\n\nStarted from command line since python exceptions do not end up in journal. Btw is that something that could be fixed?\n\n```\nsudo service tor-controlport-filter stop\nsudo -u debian-tor /usr/lib/tor-controlport-filter --debug --listen-address 10.137.11.1\n```\n\nError.\n\n```\nTor control port filter started, listening on 10.137.11.1:9051\n----------------------------------------\nException happened during processing of request from ('10.137.11.1', 48952)\nTraceback (most recent call last):\n  File \"/usr/lib/python3.4/socketserver.py\", line 613, in process_request_thread\n    self.finish_request(request, client_address)\n  File \"/usr/lib/python3.4/socketserver.py\", line 344, in finish_request\n    self.RequestHandlerClass(request, client_address, self)\n  File \"/usr/lib/python3.4/socketserver.py\", line 667, in __init__\n    self.setup()\n  File \"/usr/lib/tor-controlport-filter\", line 559, in setup\n    merged_filter_dict = merge_yml(merged_filter_dict,filters[i])\n  File \"/usr/lib/tor-controlport-filter\", line 201, in merge_yml\n    final_obj[k] = merge_yml(final_obj[k],v)\n  File \"/usr/lib/tor-controlport-filter\", line 201, in merge_yml\n    final_obj[k] = merge_yml(final_obj[k],v)\n  File \"/usr/lib/tor-controlport-filter\", line 218, in merge_yml\n    if pattern_final_obj['pattern'] == ele['pattern']:\nUnboundLocalError: local variable 'pattern_final_obj' referenced before assignment\n----------------------------------------\n```"},{"author":"joysn1980","date_created":1483966861,"date_modified":1483966861,"content":"Fixed it. Bad error handling. \n\nhttps://github.com/joysn/control-port-filter-python\nhttps://github.com/joysn/control-port-filter-python/blob/master/usr/lib/tor-controlport-filter\n\nKindly review"},{"author":"Patrick","date_created":1483976793,"date_modified":1483976793,"content":"Works for me! Merged."},{"author":"Patrick","date_created":1483987302,"date_modified":1483987302,"content":"`renamed etc/tor-controlport-filter.d/whonix.yml -> etc/tor-controlport-filter.d/30_whonix.yml`:\nhttps://github.com/Whonix/control-port-filter-python/commit/5178234b805ca549f47f25958d67286923eb076d"},{"author":"joysn1980","date_created":1485254686,"date_modified":1485254686,"content":"I this item can be closed now, Patrick?"}]},"PHID-TASK-nur3iolgay5rnaftykle":{"id":"575","title":"KVMify https://www.whonix.org/wiki/Desktop","status":"resolved","priority":"Low","author":"Patrick","description":"https://www.whonix.org/wiki/Desktop does not document KVM","comments":[{"author":"HulaHoop","date_created":1485131104,"date_modified":1485131104,"content":"https://www.whonix.org/w/index.php?title=Desktop&diff=prev&oldid=27954"}]},"PHID-TASK-hgswcrol7ub2gojda5th":{"id":"574","title":"fix control-port-filter-python config to rewrite HS_DESC replies by Tor for onionshare support","status":"resolved","priority":"Normal","author":"Patrick","description":"`/etc/tor-controlport-filter.d/whonix.yml`\n\n```\n---\n- match-exe-paths:\n    - '*'\n  match-users:\n    - '*'\n  match-hosts:\n    - '*'\n  commands:\n    SIGNAL:\n      - 'NEWNYM'\n    GETINFO:\n      - 'circuit-established'\n      - 'status/circuit-established'\n      - pattern: 'net/listeners/socks'\n        response:\n        - pattern:     '250-net/listeners/socks=\".*\"'\n          replacement: '250-net/listeners/socks=\"127.0.0.1:9150\"'\n      - 'version'\n      - 'onions/current'\n    ADD_ONION:\n      - pattern:     'NEW:BEST Port=80,(176[0-5][0-9])'\n        replacement: 'NEW:BEST Port=80,{client-address}:{} Flags=DiscardPK'\n    DEL_ONION:\n      - '.+'\n  confs:\n    __owningcontrollerprocess:\n  events:\n    SIGNAL:\n      suppress: true\n    CONF_CHANGED:\n      suppress: true\n    HS_DESC:\n      - pattern:     '650 HS_DESC CREATED (\\S+) (\\S+) (\\S+) \\S+ (.+)'\n        replacement: '650 HS_DESC CREATED {} {} {} redacted {}'\n      - pattern:     '650 HS_DESC UPLOAD (\\S+) (\\S+) .*'\n        replacement: '650 HS_DESC UPLOAD {} {} redacted redacted'\n      - pattern:     '650 HS_DESC UPLOADED (\\S+) (\\S+) .+'\n        replacement: '650 HS_DESC UPLOADED {} {} redacted'\n      - pattern:     '.*'\n        replacement: ''\n```\n\n-----\n\n```\n./tor-controlport-filter --listen-address 0.0.0.0 --debug\nTor control port filter started, listening on 0.0.0.0:9051\n10.137.11.80:51904 (filter: whonix) connected: loaded filter: whonix\nFinal rules:\ncommands:\n  ADD_ONION:\n  - {pattern: 'NEW:BEST Port=80,(176[0-5][0-9])', replacement: 'NEW:BEST\nPort=80,{client-address}:{}\n      Flags=DiscardPK'}\n  DEL_ONION:\n  - {pattern: .+}\n  GETCONF:\n  - {pattern: (__owningcontrollerprocess)}\n  GETINFO:\n  - {pattern: circuit-established}\n  - {pattern: status/circuit-established}\n  - pattern: net/listeners/socks\n    response:\n    - {pattern: 250-net/listeners/socks=\".*\", replacement:\n'250-net/listeners/socks=\"127.0.0.1:9150\"'}\n  - {pattern: version}\n  - {pattern: onions/current}\n  SIGNAL:\n  - {pattern: NEWNYM}\nevents:\n  CONF_CHANGED: {suppress: true}\n  HS_DESC:\n  - {pattern: 650 HS_DESC CREATED (\\S+) (\\S+) (\\S+) \\S+ (.+),\nreplacement: '650 HS_DESC\n      CREATED {} {} {} redacted {}'}\n  - {pattern: 650 HS_DESC UPLOAD (\\S+) (\\S+) .*, replacement: '650\nHS_DESC UPLOAD\n      {} {} redacted redacted'}\n  - {pattern: 650 HS_DESC UPLOADED (\\S+) (\\S+) .+, replacement: '650\nHS_DESC UPLOADED\n      {} {} redacted'}\n  - {pattern: .*, replacement: ''}\n  SIGNAL: {suppress: true}\nrestrict-stream-events: false\n\n10.137.11.80:51904 (filter: whonix): -> PROTOCOLINFO 1\n10.137.11.80:51904 (filter: whonix): <- 250-PROTOCOLINFO 1\n10.137.11.80:51904 (filter: whonix): <- 250-AUTH METHODS=NULL\n10.137.11.80:51904 (filter: whonix): <- 250-VERSION Tor=\"0.2.8.9\n(git-cabd4ef300c6b3d6)\"\n10.137.11.80:51904 (filter: whonix): <- 250 OK\n10.137.11.80:51904 (filter: whonix): -> AUTHENTICATE\n10.137.11.80:51904 (filter: whonix): <- 250 OK\n10.137.11.80:51904 (filter: whonix): -> SETEVENTS SIGNAL CONF_CHANGED\n10.137.11.80:51904 (filter: whonix): suppressed subscription to event\n'SIGNAL'\n10.137.11.80:51904 (filter: whonix): suppressed subscription to event\n'CONF_CHANGED'\n10.137.11.80:51904 (filter: whonix): <- 250 OK\n10.137.11.80:51904 (filter: whonix): -> GETCONF __owningcontrollerprocess\n10.137.11.80:51904 (filter: whonix): <- 250 __OwningControllerProcess\n10.137.11.80:51904 (filter: whonix): -> GETINFO version\n10.137.11.80:51904 (filter: whonix): <- (multi-line)\n    250-version=0.2.8.9 (git-cabd4ef300c6b3d6)\n    250 OK\n10.137.11.80:51904 (filter: whonix): -> SETEVENTS HS_DESC SIGNAL\nCONF_CHANGED\n10.137.11.80:51904 (filter: whonix) disconnected: client quit\n----------------------------------------\nException happened during processing of request from ('10.137.11.80', 51904)\nTraceback (most recent call last):\n  File \"/usr/lib/python3.4/socketserver.py\", line 613, in\nprocess_request_thread\n    self.finish_request(request, client_address)\n  File \"/usr/lib/python3.4/socketserver.py\", line 344, in finish_request\n    self.RequestHandlerClass(request, client_address, self)\n  File \"/usr/lib/python3.4/socketserver.py\", line 669, in __init__\n    self.handle()\n  File \"./tor-controlport-filter\", line 574, in handle\n    restrict_stream_events\n  File \"./tor-controlport-filter\", line 456, in handle_controlport_session\n    update_event_subscriptions(events)\n  File \"./tor-controlport-filter\", line 393, in update_event_subscriptions\n    if not rule.get('suppress', False) or \\\nAttributeError: 'list' object has no attribute 'get'\n----------------------------------------\n```\n\n----\n\nrelated code:\n\n```\n    def rewrite_line(replacers, line):\n        builtin_replacers = {\n            'client-address': client_address[0],\n            'client-port':    str(client_address[1]),\n            'server-address': server_address[0],\n            'server-port':    str(server_address[1]),\n        }\n        terminator = ''\n        if line[-2:] == \"\\r\\n\":\n            terminator = \"\\r\\n\"\n            line = line[:-2]\n        for r in replacers:\n            match = re.match(r['pattern'] + \"$\", line)\n            if match:\n                return r['replacement'].format(\n                    *match.groups(), **builtin_replacers\n                ) + terminator\n        raise NoRewriteMatch()\n```\n\n----\n\nBug reported here and waiting for reply from `anonym`:\nhttps://mailman.boum.org/pipermail/tails-dev/2016-November/011053.html\n","comments":[{"author":"Patrick","date_created":1481669207,"date_modified":1481904231,"content":"Needed to add `response:` after `HS_DESC:` before `- pattern:`.\n\n```\n---\n- match-exe-paths:\n    - '*'\n  match-users:\n    - '*'\n  match-hosts:\n    - '*'\n  commands:\n    SIGNAL:\n      - 'NEWNYM'\n    GETINFO:\n      - 'status/circuit-established'\n      - 'version'\n      - pattern: 'net/listeners/socks'\n        response:\n        - pattern:     '250-net/listeners/socks=\".*\"'\n          replacement: '250-net/listeners/socks=\"127.0.0.1:9150\"'\n      - 'onions/current'\n    ADD_ONION:\n      - pattern:     'NEW:BEST Port=80,(176[0-5][0-9])'\n        replacement: 'NEW:BEST Port=80,{client-address}:{} Flags=DiscardPK'\n    DEL_ONION:\n      - '.+'\n  confs:\n    __owningcontrollerprocess:\n  events:\n    SIGNAL:\n      suppress: true\n    CONF_CHANGED:\n      suppress: true\n    HS_DESC:\n      response:\n        - pattern:     '650 HS_DESC CREATED (\\S+) (\\S+) (\\S+) \\S+ (.+)'\n          replacement: '650 HS_DESC CREATED {} {} {} redacted {}'\n        - pattern:     '650 HS_DESC UPLOAD (\\S+) (\\S+) .*'\n          replacement: '650 HS_DESC UPLOAD {} {} redacted redacted'\n        - pattern:     '650 HS_DESC UPLOADED (\\S+) (\\S+) .+'\n          replacement: '650 HS_DESC UPLOADED {} {} redacted'\n        - pattern:     '.*'\n          replacement: ''\n```\n"},{"author":"Patrick","date_created":1481672198,"date_modified":1481672198,"content":"Works."}]},"PHID-TASK-dwzlgjtj4acrq2nrud2t":{"id":"573","title":"move from Whonix control-port-filter-python to tor-controlport-filter by Tails","status":"resolved","priority":"Normal","author":"Patrick","description":"reasons:\n\n* unix domain socket listener only\n* can rewrite client requests before using config files\n** thereby inject workstation IP address into add_onion command (T562)\n* can rewrite replies by Tor using config files\n** thereby prevent the workstation from learning the hidden service private key\n* less work than implementing the same with Whonix control-port-filter-python\n* sharing code with Tails\n* written in python3\n\ndisadvantages:\n\n* no `configuration drop-in snippet configuration extension` feature, see T576\n\n-----\n\n* https://www.whonix.org/wiki/Dev/Control_Port_Filter_Proxy#tor-controlport-filter_by_Tails\n* https://git-tails.immerda.ch/tails/tree/config/chroot_local-includes/usr/local/lib/tor-controlport-filter?h=feature%2F7870-include_onionshare\n* https://git-tails.immerda.ch/tails/tree/config/chroot_local-includes/etc/tor-controlport-filter.d?h=feature/7870-include_onionshare","comments":[{"author":"Patrick","date_created":1481138307,"date_modified":1481138307,"content":"* https://github.com/Whonix/whonix-gw-firewall/commit/f7ee29c866d376d853140b0feea7e9e6b4446ce7\n* https://github.com/Whonix/anon-ws-disable-stacked-tor/commit/5c8e5b736bf1d803ec79e62037590e2b452bd1f6\n"},{"author":"Patrick","date_created":1481143494,"date_modified":1481143494,"content":"- https://github.com/Whonix/whonix-ws-firewall/commit/d4e77795329775801b47db34772303df1593210d\n- https://github.com/Whonix/anon-shared-helper-scripts/commit/1cb1d33a758798eda6e39686c4ca9802fd665242\n- https://github.com/Whonix/anon-shared-helper-scripts/commit/0d71516e033eda1208ac40780eed4145b7543b14\n- https://github.com/Whonix/anon-shared-helper-scripts/commit/82412a5834982d41998dd9c3e44d2bdd8a7e3818\n\n- https://github.com/Whonix/control-port-filter-python/commit/d431e92f78d946ce26b16f4fe14fd45dd84049d9\n- https://github.com/Whonix/control-port-filter-python/commit/93f645ed1a7b95f0dd7171a8aba1cbe5c0621b58\n- https://github.com/Whonix/control-port-filter-python/commit/8ae1d312985cdb457c37b4a0ae0597e678d3f103\n- https://github.com/Whonix/control-port-filter-python/commit/8a5e396422ac099952eb57cb75859cb0242c3580\n- https://github.com/Whonix/control-port-filter-python/commit/21526163ef3b21de4e0105710b1fefc7f266016b\n- https://github.com/Whonix/control-port-filter-python/commit/2c615e544744b9431c65330b6c49772752aa785a\n- https://github.com/Whonix/control-port-filter-python/commit/80542aa94dceb09f8d3158aea88a0e1cb7362ea5\n- https://github.com/Whonix/control-port-filter-python/commit/6e48680ef2aeda4fa2b38f926accf096d37067d1\n- https://github.com/Whonix/control-port-filter-python/commit/dd80fd2658d329eeed0bb42e7d8b87f338b60406\n- https://github.com/Whonix/control-port-filter-python/commit/f0edd988d6454eccefc883c8646e0a60a86efeb2\n- https://github.com/Whonix/control-port-filter-python/commit/4e4b103680873b7711ee475f9e6271907ef826d6\n- https://github.com/Whonix/control-port-filter-python/commit/b58447a77e2ab9fbf59969d58af8e6f7a1f47774\n- https://github.com/Whonix/control-port-filter-python/commit/6635f29699877049722cddf4d80c5d76e406a8f2\n- https://github.com/Whonix/control-port-filter-python/commit/0a1494d6e064ef253d680d3086e865e6d0dbc5b9\n- https://github.com/Whonix/control-port-filter-python/commit/cc5836ccb5d21e24ce457c5d1f9919435f616511\n- https://github.com/Whonix/control-port-filter-python/commit/a063841e36cf3602e7c4e68f8783aaef17ae6954\n- https://github.com/Whonix/control-port-filter-python/commit/bd6b10386f6c85b083cea3b95b6bacd9d439b78a\n- https://github.com/Whonix/control-port-filter-python/commit/169b6c6180a204e6382934e07512ea81200aba91\n"},{"author":"Patrick","date_created":1481150977,"date_modified":1481150977,"content":"- https://github.com/Whonix/whonix-gw-network-conf/commit/58ee50f374433e49e6fad1875843d1c6f19014a9\n- https://github.com/Whonix/qubes-whonix/commit/85e00300e570139a588c1d0d2f0b20b05ecc60aa\n"},{"author":"Patrick","date_created":1481152302,"date_modified":1481152302,"content":"* https://github.com/Whonix/whonix-initializer/commit/deba20d4fa985c29e5957502229d77e7d47782f9\n* https://github.com/Whonix/qubes-whonix/commit/d054640facbb7df9dfe0b486d7fdbc4b455e40f5\n* https://github.com/Whonix/whonixcheck/commit/cebcdcb3c4441c0beb7edee8ba02698cd1b706d2\n* https://github.com/Whonix/whonixcheck/commit/62d8e9e7b115702164db1b9af86efca889aa6a06\n* https://github.com/Whonix/whonixcheck/commit/bb0a463f2fab96d94aa464d0ac335d8e8353ae64\n* https://github.com/Whonix/whonix-gw-firewall/commit/610474204b41fddfc6da4e42e3f9e134e15b4e56\n"},{"author":"Patrick","date_created":1481152949,"date_modified":1481152949,"content":"* https://github.com/Whonix/control-port-filter-python/commit/0245aff533b7d73ad963f65ea77202ba9737348c\n"},{"author":"Patrick","date_created":1481504494,"date_modified":1481504494,"content":"- python2.7 legacy cpfpy was removed.\n- python3 tor-controlport-filter by Tails was added.\n\nCode lives here:\nhttps://github.com/Whonix/control-port-filter-python\n"}]},"PHID-TASK-achlfoh5sueenir4c6g2":{"id":"572","title":"TBB Isolation Impact on FoxyProxy","status":"resolved","priority":"Normal","author":"HulaHoop","description":"While its great that the TBB sandbox project is nearly shipping, there could potentially be side-effects such as blocking access to proxies other than Tor.\n\nI know a TBB isolation boolean is planned so as a workaround this can be disabled if it interferes with using I2P. This can be included in the FoxyProxy template. \n\nWe can discuss this use-case with Tor devs so isolation can work with alternative setups though I doubt they will spend extra effort to support \"non-standard\" behavior.","comments":[{"author":"HulaHoop","date_created":1480954629,"date_modified":1480954629,"content":"https://lists.torproject.org/pipermail/tor-dev/2016-December/011724.html"},{"author":"HulaHoop","date_created":1481118617,"date_modified":1481118617,"content":"Answer: yes it would conflict but its opt-in. Later versions might work on supporting such configs.\n\nhttps://lists.torproject.org/pipermail/tor-dev/2016-December/011733.html\n\nAdded to documentation. closing."}]},"PHID-TASK-wjrxsuspobihyz5k5oug":{"id":"571","title":"HTTPS Everywhere TB icon stashed away on whonix-ws AppVM","status":"invalid","priority":"Needs Triage","author":"rustybird","description":"When I run Tor Browser in a whonix-ws (as opposed to debian-8 or fedora-23) AppVM, the small blue HTTPS Everywhere icon, usually placed to the right of the search bar, is missing. Instead, it appears inside the drawer that opens when the menu button (also to the right of the search bar) is pressed.\n\nThis happens both with the Tor Browser provided by Whonix (via the torbrowser command) and a manually downloaded and extracted Tor Browser.","comments":[{"author":"rustybird","date_created":1479736511,"date_modified":1479736511,"content":"I've managed to also trigger this on debian-8 now, not just whonix-ws. Closing this ticket here"},{"author":"Patrick","date_created":1479739671,"date_modified":1479739671,"content":"Thanks for update!"}]},"PHID-TASK-qhozvimkk2sugwwv72rc":{"id":"569","title":"Consider documenting how to turn Whonix-Gateway into a Tor Relay","status":"resolved","priority":"Normal","author":"HulaHoop","description":"0. Check with TPO if this is a good idea at all.\n\n1. Look for good guides/best practices for configuring Tor relays.\n\n2. Create a wiki page that combines different steps depending on different hypervisors.","comments":[{"author":"Patrick","date_created":1475876303,"date_modified":1475876303,"content":"[Hosting a (private) (obfuscated) bridge or (exit) relay](https://www.whonix.org/wiki/Hosting_a_%28private%29_%28obfuscated%29_bridge_or_%28exit%29_relay)"},{"author":"Patrick","date_created":1475876652,"date_modified":1475876652,"content":"> 0. Check with TPO if this is a good idea at all.\n\n> Do I get better anonymity if I run a relay?\n\nhttps://www.torproject.org/docs/faq.html.en#BetterAnonymity\n\n-> \"good idea\"\n\nhttps://www.torproject.org/docs/faq.html.en#EverybodyARelay\n\n-> \"bad idea\"\n"},{"author":"HulaHoop","date_created":1475879073,"date_modified":1475879073,"content":"I didn't mean running everybody as a relay by default. That would be a bad idea because:\n\n* sometimes the users themselves are censored.\n* users tend to run compromised PCs.\n* very bad up-time.\n\nMy goal was to find out if its worth it to TPO to have some Whonix users who do not have these limitations, running relays. I can see no one posted so I assume they think its a dumb question.\n\n\nFeel free to close this if it doesn;t make sense."},{"author":"HulaHoop","date_created":1475879183,"date_modified":1475879183,"content":"Oh I see. It is already documented. My bad. closing"},{"author":"Patrick","date_created":1475883432,"date_modified":1475883432,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>   I didn't mean running everybody as a relay by default. That would be a bad idea because:\n\nAnd I didn't perceive it that way. :)\n\n>   - sometimes the users themselves are censored.\n>   - users tend to run compromised PCs.\n>   - very bad up-time.\n\nYes.\n\n>   My goal was to find out if its worth it to TPO to have some Whonix users who do not have these limitations, running relays.\n\nWhy wouldn't it be worth? :)\n\n> I can see no one posted so I assume they think its a dumb question.\n\nI didn't understand that sentence.\n\n>   Feel free to close this if it doesn;t make sense.\n\nIt makes sense, I guess. That's why there already is a stub in the wiki.\nThat stub was originally added, because someone asked about it."},{"author":"Patrick","date_created":1475883644,"date_modified":1475883644,"content":"Did not notice this answer before making my first answer.\n\nHulaHoop (HulaHoop):\n>   Oh I see. It is already documented. My bad. closing\n>\n\nThe quality of that article is not very good. At best documented for\nVirtualBox. But for other virtualizers it's only pointers, but not easy\nenough.\n\nSpecifically in Qubes this is not that simple to set up.\n\nWould have to follow these instructions:\n\nhttps://www.qubes-os.org/doc/qubes-firewall/#port-forwarding-to-a-vm-from-the-outside-world"}]},"PHID-TASK-rjv2vjnn2szdtq3ilpvr":{"id":"568","title":"Pidgin Apparmor Profile Removal","status":"resolved","priority":"Normal","author":"HulaHoop","description":"With Pidgin being recommended against, the Apparmor profile should no longer be relevant.","comments":[{"author":"Patrick","date_created":1487865751,"date_modified":1487865751,"content":"https://github.com/Whonix/Whonix/commit/692b29b15aa33fc5b0c431d6bf0f3c2d5c1242fd"}]},"PHID-TASK-t5uckitlyyffdxs5vl7n":{"id":"567","title":"research: Single Tor-Gateway with Multiple Workstations vs Multiple Tor-Gateways mapped 1:1 to Workstation VMs","status":"resolved","priority":"Normal","author":"HulaHoop","description":"~~I think the [[ https://www.whonix.org/wiki/Multiple_Whonix-Workstations | multi-WS ]] advice on its own is pointless for security and while possible its not advised. I would like to remove that section completely and keep the multiple GW stuff instead to discourage dangerous setups. ~~\n\n~~Also information like :~~\n\n\n> ~~\"An adversary could stress either/and CPU, HDD, RAM, network connection and other Whonix-Workstations and perhaps also the host would suffer.\"~~\n\n~~is factually incorrect since hypervisors can and should partition resources to prevent any single VM from affecting another this way.~~\n\nhttps://www.whonix.org/wiki/Dev/Multiple_Whonix-Workstations","comments":[{"author":"Patrick","date_created":1475340017,"date_modified":1475340017,"content":"Why did you remove the `'''Qubes-Whonix vs non-Qubes-Whonix'''` section? Qubes-Whonix does a lot better with multi ws behind same gw than Non-Qubes-Whonix. This is because various ws's cannot impersonate each other. They also cannot connect to each other.\n\n> An adversary can easily sniff and impersonate communication between another VM on the same internal network\n\nApplies to Non-Qubes-Whonix only.\n\n> is factually incorrect since hypervisors can and should partition resources to prevent any single VM from affecting another this way.\n\nThey should for sure. But do they? Never worked for me. Specifically I have never found something to tame IO stress. (`iotop`)\n\n> Ephermeral Onion Service keys of another workstation's programs for example. \n\nThat sentence has to be improved.\n\n* Only detached ephemeral onion services.\n* And only if using Whonix 14 and above.\n* And only when white listening the command for listing ephemeral onion services in cpfpy. (Which command even is that?) It's not clear that will be required since there are no ephemeral HS applications in the wild that would require that command.)\n\n> For example, an exploit in the browser can not read your IRC identity in another VM. There are no security benefits of running multiple Whonix-Workstation VMs that share the same Gateway.\n\nContradiction.\n\n-----\n\nNon-Qubes-Whonix one ws connecting to another: Will no longer be possible in Whonix 14.\n\nNon-Qubes-Whonix impersonating: Sadly we still don't have authentication between ws and gw (ARP spoofing defense). The theory has been researched. It's certainly doable. ( https://www.whonix.org/wiki/Connections_between_Whonix-Gateway_and_Whonix-Workstation )\n\n-----\n\nI am not convinced yet. We should keep this somewhere either way. But yes, can be improves, since very different for different platforms."},{"author":"HulaHoop","date_created":1475368684,"date_modified":1475368684,"content":"> Why did you remove the '''Qubes-Whonix vs non-Qubes-Whonix''' section? Qubes-Whonix does a lot better with multi ws behind same gw than Non-Qubes-Whonix. This is because various ws's cannot impersonate each other. They also cannot connect to each other.\n\nDo you mean they can share a single GW running for different trust levels with ephemeral services safely?\n\nI thought the last statement in your comment here https://phabricator.whonix.org/T448#10443 implied this wasn't a recommended setup for Whonix, unless you mean non-Qubes.\n\nPlease revert all my changes from yesterday and cherry-pick the ones you feel useful."},{"author":"HulaHoop","date_created":1475369034,"date_modified":1475369359,"content":"blkiotune and iotune can restrict io (KVM only)\n\nhttps://libvirt.org/formatdomain.html#elementsBlockTuning\n\n\n***\n\n> Non-Qubes-Whonix one ws connecting to another: Will no longer be possible in Whonix 14.\n\nWhy?\n\n***\n\n> This is because various [Qubes] ws's cannot impersonate each other. They also cannot connect to each other.\n\nInteresting. How does it do this?\n\n> Non-Qubes-Whonix impersonating: Sadly we still don't have authentication between ws and gw (ARP spoofing defense). The theory has been researched. It's certainly doable.\n\nhttps://libvirt.org/formatnwfilter.html#nwfelemsRulesProtoARP"},{"author":"Patrick","date_created":1475446585,"date_modified":1475446585,"content":">>! In T567#10646, @HulaHoop wrote:\n>> Why did you remove the '''Qubes-Whonix vs non-Qubes-Whonix''' section? Qubes-Whonix does a lot better with multi ws behind same gw than Non-Qubes-Whonix. This is because various ws's cannot impersonate each other. They also cannot connect to each other.\n> \n> Do you mean they can share a single GW running for different trust levels with ephemeral services safely?\n> \n> I thought the last statement in your comment here https://phabricator.whonix.org/T448#10443 implied this wasn't a recommended setup for Whonix, unless you mean non-Qubes.\n\nTo specify the following...\n\n>>! In T448#10443, @Patrick wrote:\n> I would go as far recommending against using the same gateway for hosting hidden services (let alone ephemeral hidden services)  for other tasks such as simple browsing.\n\nWhat I would recommend:\n\n* use one gw / ws[s] combination for simple client activities (browsing, mail, chat)\n* use another gw /ws[s] combination where add_onion is whitelisted, i.e. where using Tor ephemeral hidden services is white listed\n\nDeanonymization is more at risk when using Tor hidden services compared to just using Tor as client. This is because Tor hidden services can be made to talk by connecting to them. A whole different class of attacks.\n\nSo when one just users Tor as a client and that ws gets compromised, it would be a safer if that VM did not have access to Tor creating ephemeral hidden services, since that allows more deanonymization attacks.\n\n\n\n>>! In T567#10647, @HulaHoop wrote:\n> blkiotune and iotune can restrict io (KVM only)\n> \n> https://libvirt.org/formatdomain.html#elementsBlockTuning\n> \n> \n> ***\n> \n>> Non-Qubes-Whonix one ws connecting to another: Will no longer be possible in Whonix 14.\n> \n> Why?\n\nBecause Whonix-Workstation firewall will be enabled by default.\n\n> ***\n> \n>> This is because various [Qubes] ws's cannot impersonate each other. They also cannot connect to each other.\n> \n> Interesting. How does it do this?\n\nBy dynamically creating a separate vif interface per VM that connects to another ProxyVM. In whonix-gw-firewall instead of using `eth1` for the internal interface, we just added that being `vif+` for Qubes.\n\n>> Non-Qubes-Whonix impersonating: Sadly we still don't have authentication between ws and gw (ARP spoofing defense). The theory has been researched. It's certainly doable.\n> \n> https://libvirt.org/formatnwfilter.html#nwfelemsRulesProtoARP\n\nCan you implement it?"},{"author":"Patrick","date_created":1475446958,"date_modified":1475446958,"content":">>! In T567#10650, @Patrick wrote:\n>> https://libvirt.org/formatnwfilter.html#nwfelemsRulesProtoARP\n> \n> Can you implement it?\n\nWorth a separate ticket.\n\n>>! In T567#10647, @HulaHoop wrote:\n> blkiotune and iotune can restrict io (KVM only)\n> \n> https://libvirt.org/formatdomain.html#elementsBlockTuning\n\nThat's nice. To get that back to context.\n\n\"An adversary could stress either/and CPU, HDD, RAM, network connection and other Whonix-Workstations and perhaps also the host would suffer.\" [1]\n\nSure, if you can implement all restrictions such as blkiotune and iotune and whatnot then that would be awesome. Then also that sentence [1] could be rewritten. And more importantly, that (and the Qubes internal lan spoofing resistance) is great stuff for a comparison table, which can be a colorful tool to document platform differences. To point out other platforms issues and ideally have them some day ironed out."},{"author":"HulaHoop","date_created":1475458224,"date_modified":1475458224,"content":"\n> By dynamically creating a separate vif interface per VM that connects to another ProxyVM. In whonix-gw-firewall instead of using eth1 for the internal interface, we just added that being vif+ for Qubes.\n\nSo you are dynamically creating new separate internal networks that are connected to a virtual interface eth0+n?\n\nOr are you enforcing traffic rules that prevent WS ip/traffic spoofing from/to separate GW interfaces while everything shares the same internal network?\n\n> Can you implement it?\n\nYes simple. There is a default filter for clean-traffic that I can just refer to to activate it.\n\n> Sure, if you can implement all restrictions such as blkiotune and iotune and whatnot then that would be awesome.\n\nI am not sure about what limits to set. Might have to look some more."},{"author":"Patrick","date_created":1475517082,"date_modified":1475517082,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>   \n>   \n>   > By dynamically creating a separate vif interface per VM that connects to another ProxyVM. In whonix-gw-firewall instead of using eth1 for the internal interface, we just added that being vif+ for Qubes.\n>   \n>   So you are dynamically creating new separate internal networks that are connected to a virtual interface eth0+n?\n\nIt's a standard Qubes ProxyVM feature. Creates new separate virtual\ninternal network like `vif11.0`, `vif15.0`, etc.\n\nhttps://github.com/QubesOS/qubes-core-agent-linux/blob/master/network/vif-route-qubes\n\n>   Or are you enforcing traffic rules that prevent WS ip/traffic spoofing from/to separate GW interfaces while everything shares the same internal network?\n\nNo special firewall rules required. For example `vif11.0` cannot\ncommunicate with `vif15.0` by default."},{"author":"HulaHoop","date_created":1475586694,"date_modified":1475586694,"content":">It's a standard Qubes ProxyVM feature. Creates new separate virtual internal network like vif11.0, vif15.0, etc.\n\nI see. Is Whonix's ability to apply GW firewall rules (and a new controlport) on the new interface relies on a Qubes feature? - does it depend on virtual interface names like vif11.0?\n\n***\n\nOfftopic: I summarized reasons for and against using clean-filter\n\nhttps://www.whonix.org/wiki/Dev/KVM#Apply_Clean-filter_traffic"},{"author":"Patrick","date_created":1475629811,"date_modified":1475629811,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>> It's a standard Qubes ProxyVM feature. Creates new separate virtual\n>> internal network like vif11.0, vif15.0, etc.\n> \n> I see. Is Whonix's ability to apply GW firewall rules (and a new\n> controlport) on the new interface relies on a Qubes feature? - does\n> it depend on virtual interface names like vif11.0?\n\nHas nothing to do with Tor's ControlPort.\n\nThe anti spoofing feature is indeed a Qubes feature. It is implemented\nby vif interfaces. That Qubes vif interface feature relies on Xen features."},{"author":"HulaHoop","date_created":1475755457,"date_modified":1475755457,"content":"Wait I thought the ability for Whonix GW to process traffic from a second eth1 internal interface (eth2?) depended on changes to iptables (not implemented yet). Is that correct?"},{"author":"Patrick","date_created":1475767762,"date_modified":1475767762,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n> Wait I thought the ability for Whonix GW to process traffic from a\n> second eth1 internal interface (eth2?) depended on changes to\n> iptables (not implemented yet). Is that correct?\n\nIn case of Qubes, rather than writing `vif...` multiple times, iptables\nalso understands``vif+` which applies to all vif interfaces.\n\nSupport for multiple internal (and even external) interfaces are\nimplemented already in Whonix stable.\n\n    for int_if_item in $INT_IF; do\n    for int_tif_item in $INT_TIF; do\n    for ext_if_item in $EXT_IF; do\n\netc.\n\nExample: `/etc/whonix_firewall.d/50_user.conf`\n\n    INT_IF=\"eth1 eth2 eth3\"\n    INT_TIF=\"$INT_IF\""},{"author":"HulaHoop","date_created":1475843047,"date_modified":1475843047,"content":"I tried testing this by creating a second internal network connected ot the GW. And it does not seem to work though I'm sure with a bit of troubleshooting it will get there.\n\nSome points:\n\n* Its 50_user no .conf - the ending creates a second file.\n\n* I am not sure if needed but under eth1 I uncommented INT_IP INT_IF in /etc/network/interfaces.d/30_non-qubes-whonix but with no effect. ifconfig shows eth2 is only assigned an ip6 address. Is this supposed to happen?\n\n* I added an eth2 entry with a GW subnet section under eth1 in interfaces.d. ifconfig shows an ip4 address as expected but no connection can be made from cloned WS.\n"},{"author":"Patrick","date_created":1475862195,"date_modified":1475862195,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>   I tried testing this by creating a second internal network connected ot the GW. And it does not seem to work though I'm sure with a bit of troubleshooting it will get there.\n>   \n>   Some points:\n>   \n>   - Its 50_user no .conf - the ending creates a second file.\n\nCertainly must be a mistake. Only configuration files ending with .conf\nare sourced since Whonix 12.\n\nCheck the xtrace of `sudo bash -x whonix_firewall` until `source`ing is\ndown, i.e. up to line 44.\n\nAlso check the full xtrace and see if the changes settings actually\nresult in multiple network interfaces being processed. Or check the\nfirewall rules diff as per:\n\nhttps://www.whonix.org/wiki/Dev/Firewall_Refactoring\n\n>   - I am not sure if needed but under eth1 I uncommented INT_IP INT_IF in /etc/network/interfaces.d/30_non-qubes-whonix but with no effect.\n\nThat makes no sense. INT_IP and INT_IF are no valid ifupdown keywords.\nThat breaks networking.\n\ncomment:\n\n    ## comment\n\ncommented out command:\n\n    #command\n\n> ifconfig shows eth2 is only assigned an ip6 address. Is this supposed to happen?\n\nProbably not.\n\n>   - I added an eth2 entry with a GW subnet section under eth1 in interfaces.d. ifconfig shows an ip4 address as expected but no connection can be made from cloned WS.\n\nI'd replicate this setup using plain Debian first. Multi ws's that are\nconnected to one gw using multiple internal network interfaces. The ws's\nshould not be able to reach clearnet [no ip forwarding in Linux by\ndefault] but you should be able to ping the gateway from the ws since no\nWhonix stuff (no firewall) interferes."},{"author":"HulaHoop","date_created":1475943733,"date_modified":1475943733,"content":"The firewall works as expected according to xtrace. So we can conclude its something else. Probably too difficult to find out. Not worth the effort when an extra GW solves the problem and runs with very little resources."},{"author":"Patrick","date_created":1475946399,"date_modified":1475946399,"content":"HulaHoop (HulaHoop):\n> Not worth the effort when an extra GW solves the problem and runs with very little resources.\n\nExtra gw comes with disadvantages.\n\n- More Tor entry guards used,\n- or more more hassle setting up bridges.\n\n- Plus another system to keep updated.\n- Eating up more disk space.\n\n(Btw the latter two points are also better solved in Qubes due to root\nimage sharing so extra gws or extra wss need very much less disk space.)"},{"author":"HulaHoop","date_created":1476025120,"date_modified":1476025120,"content":"Any ideas for what else I can try?"},{"author":"Patrick","date_created":1476030258,"date_modified":1476030258,"content":"I'd replicate this setup using plain Debian first. Multi ws's that are\nconnected to one gw using multiple internal network interfaces. The ws's\nshould not be able to reach clearnet [no ip forwarding in Linux by\ndefault] but you should be able to ping the gateway from the ws since no\nWhonix stuff (no firewall) interferes."},{"author":"HulaHoop","date_created":1476211721,"date_modified":1476211721,"content":"vailla Debian 8 same result. After reading about similar setups I think there is more needed to get this working:\n\nhttps://serverfault.com/questions/705919/the-same-ip-on-multiple-interfaces"},{"author":"HulaHoop","date_created":1477007619,"date_modified":1477007619,"content":"I thought of something else. Using a single Gateway can link activities of two different Workstations even if they are on separate internal networks because the malicious WS can send NEWNYMs in som pattern which causes the traffic coming from the other clean WS to change exits at will. So while the identity of the user is not unmasked the entire purpose of the setup (multiple unlinked identities) is defeated."},{"author":"Patrick","date_created":1477020499,"date_modified":1477020499,"content":"Interesting thought!\n\n- long lived connections are not affected, they never change the circuit\nas long as these are active\n\n- streams are isolated [more reliably if IP spoofing is prevented]\n\n- I wonder how non-long lived, new connections would be trackable by\nmalicious newnym patterns?\n\n-- Let's say for the sake of thinking this trough some application do a\nsimple fetch check.tpo, close the connection, repeat every minute.\n\n-- What check.tpo would be seeing is not the same exit fetching\ncheck.tpo every minute and then an exit IP change, but an exit IP change\nevery 2, 4 and 8 minutes or so.\n\nAlso I wonder how newnym spam looks to ISP level adversaries?\n\nNot sure which one is better. Mutliple Whonix-Gateways result in\nmultiple instances of Tor running at the same time. This will certainly\nbe noticeable for ISP level adversaries. [Leaving hiding Tor aside.] And\none would end up with using multiple Tor entry guards at once.\n(Unlikely, that Tor picks the same one.) Multiple Tor entry guards is\nsomething that TPO has eliminated for purposes of not aiding tracking\nTor users who change locations (assigning a pseudonym to them based on\ntheir pretty unique choice of multiple Tor entry guards) as well as\nsince they decided, multiple Tor entry guards pose a higher risk.\n\nOther than newnym, a compromised workstation could also induce a pattern\nby causing a lot traffic followed by causing very little traffic. That\nmight eat up the connection speed (and latency?) of the Tor connection\nfrom the non-compromised workstation. On the other hand, this could also\nhappen when using multiple Whonix-Gateway. It's not hard to make one Tor\ncause loads of outgoing traffic (thereby influencing another Tor)."},{"author":"HulaHoop","date_created":1477061079,"date_modified":1477061202,"content":"> I wonder how non-long lived, new connections would be trackable by malicious newnym patterns?\n\nSome first party tracking site \"X\" sets a cookie. newnym from unrelated WS causes circuit changes for all short-lived circuits. A script running in the browser causes re-fetching data and sends cookie ID from a new exit IP. With Tor's current design of unchanging exit IPs per domain - with many requests it becomes clear that the changes are caused by the adversary's behavior. Especially if the site in question is obscure.\n\n> Also I wonder how newnym spam looks to ISP level adversaries?\n\nWith an Entry Guard this shouldn't pose a risk. Tor cells are padded to a constant size though the netflows still are not. This will happen soon in the 0.30 release which should defeat DNS deanonymization and website fingeprinting. While the former protects traffic size fingeprinting from network adversaries outside Tor, the latter will protect against if they are running relays.\n\n> Not sure which one is better. Mutliple Whonix-Gateways result in multiple instances of Tor running at the same time. This will certainly be noticeable for ISP level adversaries.\n\nIts not that unique of a setup. Think about Debian systems that have TBB and apt-transport-tor installed. Location tracking will take manual effort to mitigate in general because besides clearing the Tor guard data one needs disposable wifi sticks.\n\n> Other than newnym, a compromised workstation could also induce a pattern by causing a lot traffic followed by causing very little traffic. That might eat up the connection speed (and latency?) of the Tor connection from the non-compromised workstation. On the other hand, this could also happen when using multiple Whonix-Gateway. It's not hard to make one Tor cause loads of outgoing traffic (thereby influencing another Tor).\n\nThis sounds like a variant of the CPU-induced network latency attack and should be mitigated by the queuing fix. Likely holds for both siutations and is dangerous enough to completely deanonymize a rooted WS user rather than just linking activities. \n\n\n***\n\nWhat I wrote is based on my understanding of how Tor works. I think this would make an interesting question for the Tor devs.\n\n\"Do you recommend allowing Workstation VMs of different security levels to communicate with the same instance of Tor (even if they do so via separate isolated networks)?\""},{"author":"Patrick","date_created":1477062184,"date_modified":1477062184,"content":"Yes, that seems useful. Please also add the pros and cons we discussed\nabove."},{"author":"HulaHoop","date_created":1477082891,"date_modified":1477082891,"content":"https://lists.torproject.org/pipermail/tor-dev/2016-October/011590.html"},{"author":"Patrick","date_created":1477083180,"date_modified":1477083180,"content":"Thanks, great!"},{"author":"HulaHoop","date_created":1477185059,"date_modified":1477185059,"content":"Got an answer: https://lists.torproject.org/pipermail/tor-dev/2016-October/011591.html\n\nSeems that a shared Gateway is a very bad idea. There are caveats about separate gateways too but nothing as serious:\n\n>* Links traffic at different guards to the same source IP address\n\nA network adversary can see connections to two different guards.\n\n>* Even VM-level isolation is not proof against some attacks\n\nThis true as seen in many advanced attacks involving covert channels and side channels.\n\n***\n\nThe last important thing I learned that we should document for opsec is: gateways cache DNS entries and descriptors of HS websites visited which can give away that they were visited before (because of faster site loading response) even if a single WS is used and is rolled back to a clean snapshot. The solution is to always rollback the gateway to a clean state between different WS sessions."},{"author":"Patrick","date_created":1477262805,"date_modified":1477262805,"content":"Could you please add all of these pros and cons to that wiki page? Or\nsome /Dev page if too irrelevant for users?\n\nPerhaps we just make the recommendation to them and keep the details on\nsome /Dev page for a shorter page / better usability?"},{"author":"Patrick","date_created":1477263028,"date_modified":1477263028,"content":"HulaHoop (HulaHoop):\n> gateways cache DNS entries and descriptors of HS websites visited\n> which can give away that they were visited before (because of faster\n> site loading response) even if a single WS is used and is rolled back\n> to a clean snapshot.\n\nDoes this apply even when Tor is recognizing proper stream isolation?\n\nBecause the repercussions by this would contradict why stream isolation\nwas implemented by Tor in the first place? If so, should we create a Tor\nbug report, suggesting Tor should only cache DNS / HS descriptors per\nstream, but not globally?\n\n> The solution is to always rollback the gateway to a clean state\nbetween different WS sessions.\n\nReally bad from usability point of view."},{"author":"HulaHoop","date_created":1477313083,"date_modified":1477313083,"content":">Could you please add all of these pros and cons to that wiki page? Or some /Dev page if too irrelevant for users?\n\nSure. I will finalize everything once you discuss the consequences.\n\n>Perhaps we just make the recommendation to them and keep the details on some /Dev page for a shorter page / better usability?\n\nI think its best if we include it on the user page but below the short and clear recommendation. So users who care to learn more can access the info in one place.\n\n>Does this apply even when Tor is recognizing proper stream isolation?\n\nI believe so. He is describing what Tor normally does AFAICT.\n\n>Because the repercussions by this would contradict why stream isolation was implemented by Tor in the first place? If so, should we create a Tor bug report, suggesting Tor should only cache DNS / HS descriptors per stream, but not globally?\n\n+1 but you should discuss this on the ML first to see what they have to say.\n\n>Really bad from usability point of view.\n\nIts a big PITA for usability but can you see another way?"},{"author":"HulaHoop","date_created":1477436829,"date_modified":1477436829,"content":"I would prefer if you post these questions on tor developer ML since you understand the topic better and it is an important thing we need to know."},{"author":"Patrick","date_created":1477586345,"date_modified":1477586345,"content":">>! In T567#10782, @HulaHoop wrote:\n> I would prefer if you post these questions on tor developer ML since you understand the topic better and it is an important thing we need to know.\n\nI am not sure they will be happy with that. A while ago I got a negative feedback when I did that. Perhaps times have changed.\n\nWhat about creating a ticket instead? The issue with Tor mailing list discussions, that often no tickets for issues found are created, hence the issues never fixed or unnecessarily delayed. A ticket persists, may get a milestone, may get postponed a few times but eventually gets fixed."},{"author":"HulaHoop","date_created":1478002050,"date_modified":1478002050,"content":"Another reply:\n\nhttps://lists.torproject.org/pipermail/tor-dev/2016-October/011613.html"},{"author":"Patrick","date_created":1478008066,"date_modified":1478008066,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>   Another reply:\n>   \n>   https://lists.torproject.org/pipermail/tor-dev/2016-October/011613.html\n\nMost of that is related to Tor ControlPort. We forgot to add in the\noriginal question that access to Tor ControlPort is white listed and\nsupports only very few commands.\n\nAnyhow. Perhaps a good source to \"super blacklist\" a few Tor control\ncommands. I mean, adding them to the control port filter wiki page with\nan explanation why these should never be white listed."},{"author":"Patrick","date_created":1478123236,"date_modified":1478123236,"content":"draft:\n\n> stream isolation for DNS and hidden service descriptor cache\n\n-----\n\n> Seems like Tor's DNS cache ({{{CacheIPv4DNS}}}, {{{CacheIPv6DNS}}}) and caching of hidden service descriptors is cached globally.\n> \n> The first connection in stream one resolves all DNS or hidden service descriptors. But follow up connections in separate streams to the same website do not resolve and use Tor's cache.\n> \n> So webservers could provide a slightly unique version of their website per visitor. Each visitors browser could be instructed to load additional content from varying hostnames. Due to caching vs non-caching it might be possible to make visitors pseudonymous rather than anonymous.\n> \n> The problem is that Tor's cache is global and not stream isolated.\n\nWhat do you think?"},{"author":"HulaHoop","date_created":1478177052,"date_modified":1478177052,"content":"Good write-up\n\n> Most of that is related to Tor ControlPort. We forgot to add in the original question that access to Tor ControlPort is white listed and supports only very few commands.\n\nTrue but teor's reply discusses things that do not depend on controlport access.\n\n\n> Anyhow. Perhaps a good source to \"super blacklist\" a few Tor control commands. I mean, adding them to the control port filter wiki page with an explanation why these should never be white listed.\n\nMaybe but there could be a lot of functionality that can be abused that we can't think of because we don't know how every bit of Tor's internals."},{"author":"Patrick","date_created":1478191138,"date_modified":1478191138,"content":"Posted:\nhttps://trac.torproject.org/projects/tor/ticket/20555"},{"author":"HulaHoop","date_created":1478230898,"date_modified":1478230898,"content":"Nice. The Tor guys took notice.\n\nontopic: While DNS and HS desc caching is one of the things. The original reply implies there are still many other problems - some known and possibly some unknown unknowns. To be absolutely safe we should still recommend for multi-setup with gw snapshots as a catch-all. Inconvenient? yes but better safe than sorry.\n\n>* Caching of DNS, HS descriptors, preemptive circuits, etc. \n>* VMs can leak other VM's guards and even entire circuits\n> * easily without a control port filter\n> * perhaps some discovery attacks even with a filter"},{"author":"Patrick","date_created":1478307030,"date_modified":1478307030,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>   Nice. The Tor guys took notice.\n>   \n>   ontopic: While DNS and HS desc caching is one of the things. The original reply implies there are still many other problems - some known and possibly some unknown unknowns. To be absolutely safe we should still recommend for multi-setup with gw snapshots as a catch-all. Inconvenient? yes but better safe than sorry.\n>   \n>   > - Caching of DNS, HS descriptors, preemptive circuits, etc.\n>   > - VMs can leak other VM's guards and even entire circuits\n>   >   - easily without a control port filter\n>   >   - perhaps some discovery attacks even with a filter\n> \n> TASK DETAIL\n>   https://phabricator.whonix.org/T567\n> \n> EMAIL PREFERENCES\n>   https://phabricator.whonix.org/settings/panel/emailpreferences/\n> \n> To: HulaHoop\n> Cc: Patrick, WhonixQubes, entr0py, HulaHoop\n> \n\nNot too long ago Tor got some improvements:\n\n- The number of Tor entry guards was reduced from 3 to 1.\n- And guards are kept for longer. (Longer guard cycling period.)\n\nIf we encourage multiple Whonix-Gateways, we subvert these improvements.\n\na) I think guard related attacks are much more serious since they lead\nto deanonymization.\n\nb) Caching issues for in multi-ws single-gw setups can lead to linking\nmultiple workstations together.\n\nI think a) is more serious than b). So for now I guess multi-ws\nsingle-gw is still better than multi-gw multi-ws.\n\nFor multi-gw setups it might be theoretically an option to have them\nmanually use the same Tor entry guard? That also does not seem too\ngreat, since Tor guard selection then would be manual?\n\n-----\n\nAsked an additional somewhat related question:\n\nhttps://lists.torproject.org/pipermail/tor-dev/2016-November/011633.html\n\n-----\n\nPerhaps we could equate the following two?\n\n> single-gw multi-ws\n> * perhaps some discovery attacks even with a filter\n\n> multi-gw multi-ws\n> * Even VM-level isolation is not proof against some attacks\n\nIf these can be equated, then only the caching issues remain. And these\ncan be considered bugs that can one day fixed in Tor."},{"author":"HulaHoop","date_created":1478361108,"date_modified":1478361108,"content":">For multi-gw setups it might be theoretically an option to have them manually use the same Tor entry guard? \n\nThe solution is much simpler than you imagine. A user would simply clone the original GW VM after its started and chosen its guard so they have the same one. Now this must be repeated before the guard time is up which is 3 months I think to make sure the same guard is in use.\n\nIts not airtight because if a guard disappears each VM may choose a different alternative (unless the choice is deterministic) which means that both can be expected to have picked the same one from an ordered list generated at first run. Worth asking about.\n\nOne mild disadvantage of such a setup is it would be clear from the network fingerprint that two connections to the same guard is a sign of Whonix use. Now a solution to this is to ask upstream to modify TBB Tor to use a system Tor's guard if present to minimize the risks of multiple guards we know of and this also increases the anonymity set for the Whonix multiGW situation above.\n"},{"author":"Patrick","date_created":1478392367,"date_modified":1478392367,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>> For multi-gw setups it might be theoretically an option to have\n>> them manually use the same Tor entry guard?\n> \n> The solution is much simpler than you imagine. A user would simply\n> clone the original GW VM after its started and chosen its guard so\n> they have the same one.\n\nIf anything, it might be better to just copy over /var/lib/tor/state.\n\nCloning may not be a great idea in context of Non-Qubes-Whonix. Cloning\nimplies, that the VM has been previously started. That is not great\nbecause then lots of files a generated that should not be shared such as\nrandom seeds.\n\nThat is why Whonix is build inside chroot. No services are ever started\nbefore the images are deployed.\n\nFor multiple gateways or workstations it is better to import a fresh\nimage rather than trying to have a master image.\n\nTorBOX 0.1.3 had a critical vulnerability of sharing an already\npopulated /var/lib/tor folder known to public (because deployed image)\nbecause back then we did create VM images inside VMs by running them and\nrunning commands inside. (As said, for a very long time now, images are\nbuild inside chroot and services never started.)\n\nInstalling software / services inside a master image and running them\nthere is problematic. Imagine sshd. Upon installation, it generates its\nkeys. Once one done that, one should not use that image as a master image.\n\nImagine a private key that Tor creates that should not be shared.\nPractically, a user is happy with one gateway, sets up a hidden service.\nLater discovers multi-gw is a thing now and clones that gateway. That\nwould contaminate the different trust levels.\n\n> Now this must be repeated before the guard\n> time is up which is 3 months I think to make sure the same guard is\n> in use.\n> Its not airtight because if a guard disappears each VM may choose a\n> different alternative (unless the choice is deterministic) which\n> means that both can be expected to have picked the same one from an\n> ordered list generated at first run.\n\nYes, not a reliable solution. Specifically users cloning the gateway\nafter almost 3 months.\n\n> Worth asking about.\n\nThat would be nice. There may be already is a long standing ticket for\nthis. It's called guard seed. In that discussion a password/pin was\nsuggested in order to get more stable Tor entry guards.\n\nhttps://trac.torproject.org/projects/tor/ticket/5236\n\nOnce Tails implements persistent Tor state\n\nhttps://tails.boum.org/blueprint/persistent_Tor_state/\n\nthe need for that feature may be lower. Then the only (to Tails and TPO)\nknown users in need for that feature would be Tails users who do not use\npersistence.\n\n> One mild disadvantage of such a setup is it would be clear from the\n> network fingerprint that two connections to the same guard is a sign\n> of Whonix use.\n\n> Now a solution to this is to ask upstream to modify\n> TBB Tor to use a system Tor's guard if present to minimize the risks\n> of multiple guards we know of and this also increases the anonymity\n> set for the Whonix multiGW situation above.\n\nThat's unlikely to happen since TPO maintains TBB as a portable\napplication. System Tor version may not match TBB Tor version. TPO\nsupports many platforms while Whonix is a derivative of Debian that\nalways ships latest Tor version.\n\nWhat is also unlikely but perhaps more likely is that TBB will be\nproperly packaged for Debian one day. Then indeed it would use system Tor.\n\nhttps://trac.torproject.org/projects/tor/ticket/3994\nhttps://trac.torproject.org/projects/tor/ticket/5236"},{"author":"HulaHoop","date_created":1478609920,"date_modified":1478609920,"content":"I will post the new usage advice on the KVM page because some applies for a simple setup.\n\nAs for multi-gw page I think we should post the raw facts from teor's post - which discourages a shared setup and has caveats for regular use. The fact that it impacts usability needs another ticket to track upstream features or Whonix platform changes needed to improve that. Otherwise this ticket can be considered complete."},{"author":"Patrick","date_created":1478614213,"date_modified":1478614213,"content":"Before rushing such a major usability decreasing change, I want to make\nsure it is really well justified and we are not chasing a ghost.\n\nmulti-ws behind single-gw has issues, but I don't think we exhausted all\ncommunication with upstream yet or that they advised against it. We\nhaven't stressed what is worse.\n\n- a) single gateway sharing vs\n- b) using multi-gw and thereby subverting number and duration of entry\nguard selection\n\n(In that question we must make sure to add that we do use control port\nfiltering.)\n\nFor now we gathered a great deal of new information, but I don't think\nthey advised the Whonix project to move from single-gw to multi-gw in\nall cases.\n\nAlso another point that makes me insecure...\n\ncontext was:\n\n> multi-gw multi-ws\n\nteor wrote:\n\n> Even VM-level isolation is not proof against some attacks\n\nLet's write a draft for that question.\n\n-----\n\nThere are three options for user recommendation:\n\n1) multi-gw multi-ws\n2) single-gw multi-ws\n3) single-gw with multi-ws while recommending against running different\nactivities of different trust levels / pseudonyms at the same time\n\n-----\n\nYet another option might be to run multiple Tor instances on the same\nWhonix-Gateway. Tor's systemd service supports that. (Would use separate\nTor data dirs, thereby Tor entry guards.)"},{"author":"HulaHoop","date_created":1478699833,"date_modified":1478699833,"content":"> Before rushing such a major usability decreasing change, I want to make sure it is really well justified and we are not chasing a ghost.\n\nSure.\n\n> multi-ws behind single-gw has issues, but I don't think we exhausted all communication with upstream yet or that they advised against it. We haven't stressed what is worse.\n\nOK. I'll think of something but its better if you post so he doesn't get impatient.\n\n>2. single-gw multi-ws\n>3. single-gw with multi-ws while recommending against running different activities of different trust levels / pseudonyms at the same time\n\nThese two can be collapsed into scenario 3. I thought we already advised that on the wiki since it has stronger guarantees fr activity isolation. I think you've written a good short description that we should use in the draft.\n\n> Even VM-level isolation is not proof against some attacks\n\nI am certain he means the virtualization covert and sidechannel attacks that were published recently. Stuff we already know about and documented in the Advanced Attacks chapter.\n\n\n> Yet another option might be to run multiple Tor instances on the same Whonix-Gateway. Tor's systemd service supports that. (Would use separate Tor data dirs, thereby Tor entry guards.)\n\nVery cool. I'm thinking if this is yet a different setup that we should also ask about. So it it used in a multi-ws context or single too?\n\n(Without TCP Timestamps network monitoring cannot tell if mutliple Tor connections come from different machines behind NAT or the same one.)"},{"author":"Patrick","date_created":1478828790,"date_modified":1478828790,"content":">>! In T567#10795, @HulaHoop wrote:\n> OK. I'll think of something but its better if you post so he doesn't get impatient.\n\nSure. Can post. But first we need the draft. And before that I am re-reading this whole ticket. And than add everything we learned here, which is a lot, here:\n\nhttps://www.whonix.org/wiki/Dev/Multiple_Whonix-Workstations\n\n>> Even VM-level isolation is not proof against some attacks\n> \n> I am certain he means the virtualization covert and sidechannel attacks that were published recently. Stuff we already know about and documented in the Advanced Attacks chapter.\n\nPossibly. And then there are the old sidechannel attacks. Hypervisors will probably not defeat them anytime soon.\n\n>> Yet another option might be to run multiple Tor instances on the same Whonix-Gateway. Tor's systemd service supports that. (Would use separate Tor data dirs, thereby Tor entry guards.)\n> \n> Very cool. I'm thinking if this is yet a different setup that we should also ask about.\n\nYes.\n\n> So it it used in a multi-ws context or single too?\n\nI had multi-ws in mind, but multiple Tor instances per single-ws might also make sense. It's related but solving a different problem."},{"author":"Patrick","date_created":1479779901,"date_modified":1479779901,"content":"Draft ready. Please check/edit.\n\nhttps://www.whonix.org/wiki/Dev/Multiple_Whonix-Workstations#Draft"},{"author":"HulaHoop","date_created":1479785239,"date_modified":1479785239,"content":"Good in principle however I want to avoid confusion.\n\nmulti-gw multi-ws -> single-g/ws 1:1\n\n>single-gw with multi-ws while recommending against running multiple VMs for activities of different trust levels / pseudonyms at the same time\n\nIs this the setup I describe where a single ws is rolledback between different activities? If yes then this should be better described. \n\n\nIMHO its better not to rehash what was sent before at the beginning of the message but instead simply zip to the three other setups to avoid losing their attention. The concern you have can be best compressed in this sentence:\n\n\"Given all the disadvantages of multi-ws sharing a single gw, is it worse than having multiple entry guards into Tor if we make use of separate gateways?\"\n\n\nAlso no need to link to the draft page."},{"author":"Patrick","date_created":1480025040,"date_modified":1480025040,"content":">>! In T567#10844, @HulaHoop wrote:\n> Good in principle however I want to avoid confusion.\n> \n> multi-gw multi-ws -> single-g/ws 1:1\n> \n>>single-gw with multi-ws while recommending against running multiple VMs for activities of different trust levels / pseudonyms at the same time\n> \n> Is this the setup I describe where a single ws is rolledback between different activities? If yes then this should be better described. \n\nNo rollback for ws considered.\n\n> IMHO its better not to rehash what was sent before at the beginning of the message but instead simply zip to the three other setups to avoid losing their attention. The concern you have can be best compressed in this sentence:\n> \n> \"Given all the disadvantages of multi-ws sharing a single gw, is it worse than having multiple entry guards into Tor if we make use of separate gateways?\"\n\nWhat about the compression inside the TLDR section? Can you write it please?"},{"author":"Patrick","date_created":1480206207,"date_modified":1480206207,"content":"Is https://www.whonix.org/w/index.php?title=Dev%2FMultiple_Whonix-Workstations&type=revision&diff=26455&oldid=26415 in progress or done?\n\n(Intermediate edits are very much fine. Just need a notification here once ready. Keep your time.)"},{"author":"HulaHoop","date_created":1480289014,"date_modified":1480289014,"content":"Done. Feel free to discuss it further before posting if needed."},{"author":"Patrick","date_created":1480688181,"date_modified":1480688181,"content":"I think we should post the long draft. I am not convinced, they are offended by longer mails / complexity. That wiki page shows, that we considered each of their sentences and made an effort to reflect on it before asking more questions.\n\nTheir past replies indicate, they didn't assume, that Whonix does have control port filtering. So starting that we do upfront will change the replies we are going to receive.\n\nAnd if change from multiple-gw multiple-ws mapped 1:1 it will be second-guessed a lot in future. Then it's good to have a reference by Tor developers where all of this was discussed in its full complexity.\n\nAny more draft suggestion?\n\n>>! In T567#10844, @HulaHoop wrote:\n> multi-gw multi-ws -> single-g/ws 1:1\n\nSorted out. Please check.\n\nReady to post?"},{"author":"HulaHoop","date_created":1480778359,"date_modified":1480778359,"content":"Go for it."},{"author":"Patrick","date_created":1480788813,"date_modified":1480788813,"content":"sent:\nhttps://lists.torproject.org/pipermail/tor-dev/2016-December/011720.html"},{"author":"Patrick","date_created":1482878619,"date_modified":1485885665,"content":"Talked to Roger Dingledine in person of Tor at 33c3 ccc conference. The short summary is, Roger also doesn't know what the advisable trade-off for our [`single-gw multiple-ws` vs `multiple-gw multiple-ws mapped 1:1`](https://lists.torproject.org/pipermail/tor-dev/2016-December/011720.html) question is.\n\nRoger wants to connect us to Tariq. The researcher [who improved](https://blog.torproject.org/blog/improving-tors-anonymity-changing-guard-parameters) the guard parameters. Tariq possibly help writing a research-wanted blog post that Roger suggested to have posted on blog.torproject.org.\n\nWe can use existing texts from wiki and mailing lists. And since the post targets researchers, it can be as verbose as this topic really is.\n\nRoger will reply to our mail next year. And if he doesn't, we should mail him again."},{"author":"Patrick","date_created":1485984679,"date_modified":1485984679,"content":"Mailed Roger."},{"author":"Patrick","date_created":1487011352,"date_modified":1487011352,"content":"Roger mailed Tariq. Now waiting for Tariq's reply.\n\nNot sure about the ticket status. It's actually \"wait for reply\"."},{"author":"Patrick","date_created":1490540503,"date_modified":1490540503,"content":"Talked to Tariq.\n\nTODO: write an introduction to Whonix for the research wanted blog post. Then sent that to Tariq who will work through the https://www.whonix.org/wiki/Dev/Multiple_Whonix-Workstations. Deadline 06.04.2017.\n\nMy notes...\n\n* Note, we're addressing people that have never heard of Whonix. Workstation may mean to them the whole computer they are using. Therefore these terms need to be defined.\n* What is Whonix? Whonix is a integration project for VMs, Debian, Tor.\n* Whonix allows any application over Tor without leaks and comes with other enhancements as well.\n* we wonder if we better use one gateway or multiple\n* What are Whonix's aims in terms of anonymity?\n* What are the properties that Whonix hopes to provide?\n* compartmentalization\n* definition gateway / workstation\n* assumption: no Tor ControlPort access\n* assumption: leaving side channel attacks against VMs out (different research and problem solving area)\n* what happens when one vm is malicious how can it affect anonymity of the other vm\n* Note, that everything happens all on the clients local machine, i.e. no gateway on the remote computers.\n* adversary can only see connections to the external network\n* exclude internal lan ip addresses analysis (not worth, easy to detect if running in Qubes, VirtualBox or KVM)\n* assumption: gateway not maliciously altered\n* assumption: Tor cannot be exploited (auditing and hardening Tor is a different research area, not useful to mix it in here)\n* IP discovery ticket is quite good - https://trac.torproject.org/projects/tor/ticket/5928\n* define IP leak\n* mention the workstation is fully torified - a question to ask could be can I find out my ip\n* links to Whonix and Qubes-Whonix so people can easily install and try\n"},{"author":"Patrick","date_created":1493143380,"date_modified":1493143380,"content":"Finally got back to Tariq."},{"author":"Patrick","date_created":1520384595,"date_modified":1520384595,"content":"Could you please ping Tariq about the status of this? @HulaHoop "},{"author":"HulaHoop","date_created":1539384123,"date_modified":1539384123,"content":"Reply:\n\n\n> The short story is that things get worse very quickly, but there is hope.\n> The analysis below assumes only the adversary that runs guards and not the local adversary like the host OS or the Whonix processes themselves.\n> In my analysis I assume a hypothetical adversarial guard bandwidth of 10% of the entire network. This is an arbitrary number since we don't know the real number, but it serves to show the trends as we increase the guards per client and number of clients per user. I do the kind of analysis we do in the Conflux[1] paper which is very relevant here, especially Table 3 and its discussion in section 5.2. I update the numbers and extend that analysis for the scenarios you have described.\n> \n> 1. 1 guard/client, 1 client/user.\n> The adversary (i,e, the compromised guard) will have the ability to observe 10% of the clients and hence 10% users. This is the situation today.\n> \n> 2. 2 guards/client, 1 client/user.\n> This is worse than 1 above. There is now a 18% probability that only one of the guards is compromised per client and a 1% chance that two guards are compromised per client. The probability of at least one bad guard is hence 19%. There really is not a real distinction between one or two bad guards from the user perspective since in both situations the client will go through a malicious guard in a short period of time, since the guard is picked uniformly at random from the guard set.\n> \n> 3. 1 guard/client, 2 clients/user.\n> The observable clients again increase to 19% from the base 10% in 1 above. This means that if the user split her app (or group of apps) across the clients then there is a 19% chance that at least one of the app (groups) is compromised. However, for each client there is still only a 10% chance that a malicious guard is present. Is this configuration better than scenario 2 above? Perhaps, but let's look at the following scenario first.\n> \n> 4. 2 guards/client, 2 clients/user.\n> The observable clients increases to 54%. This means that there is a 54% chance that at least one bad guard is present. This is worse than all the other scenarios above. However, if we fix apps (or groups of apps) to particular clients then we can compare to scenario 2 where the app group/client is analogous and the same analysis holds. Then, for each client there is again a 19% chance that there is a malicious guard present. If we compare to 3 above we can see that if we only use 1 guard/client then we can drop the exposure back down to 10% for that client and hence app group.\n> \n> Taking the above into account we can get good results by keeping the guard set size to 1 and users spin up one client for each app. Then we can achieve at most 10% of apps compromised at *any given time* but not simultaneously. We can call this scenario (which is an extension of scenario 3) the 1 guard/app scenario (1G/A). See the appendix for more tweaks to decrease guard exposure.\n> \n> If we want to consider 1G/A, then the next question for your user base is that is it better to either 1) have some portion of your apps compromised at *all* times (scenario 1G/A) or 2) have *all* your apps compromised some portion of the time (scenario 1). Tor tends to bend towards option 2, but then they have not considered the option of multi-client usage since it doesn't improve the situation in a non-compartmentalized setting, unlike the Whonix situation. I believe that option 2 is flawed because you never know if you are in fact currently compromised or not. It might be better to go ahead with assuming that you are compromised and mitigating that compromise to some portion of your network activity than all or nothing, which is what option 1 provides.\n> \n> I hope that answers your questions. Please do not hesitate to get in touch again if you would like to discuss further. I think this is a very interesting problem area and would be happy to contribute to improving the situation.\n> \n> Best regards,\n> Tariq Elahi\n> \n>  [1] http://cacr.uwaterloo.ca/techreports/2013/cacr2013-16.pdf\n> \n> Appendix\n> We can do better if we allow a user's clients to look at each other's lists to exclude guards that are already picked. The benefit would be that once the bad bandwith has been assigned it can no longer affect subsequent guard selections. However, clients looking at each other's memory space will compromise your vision of process containment. A zero knowledge/oblivious method for comparing guard lists might work to avoid this problem, and indeed the adversarial response will be weak since the best they can do is spread their bad bandwidth over many relays and at best return to the original exposure rate (e.g. 10%) but now with added costs of running many more relays. \n> \n> \n\n"},{"author":"HulaHoop","date_created":1539384253,"date_modified":1539384253,"content":"Proposed implementations for multi-Tor suggested here:\n\nhttp://forums.dds6qkxpwdeubwucdiaord2xgbbeyds25rbsgr73tbfpqpt4a6vjwsyd.onion/t/cooperating-multi-tor-implementation-to-avoid-guard-duplication/6126\n\n@Patrick Should I open a separate ticket for which ever implementation you end up choosing or is this ticket sufficient?\n"},{"author":"HulaHoop","date_created":1549075639,"date_modified":1549075639,"content":"The concept was documented for operational use. Auto Guard de-duplication considered too complex to deploy and manual checking is enough."}]},"PHID-TASK-x6xcuqw3phytdobgcmes":{"id":"566","title":"control-port-filter add_onion unit test","status":"invalid","priority":"Normal","author":"Patrick","description":">>! In T448#10487, @marmarek wrote:\n>>>! In T448#10482, @Patrick wrote:\n>> I guess we don't get around unit testing now. Do you have any examples where I can define function names, inputs and expected outputs?\n> \n> Take a look at https://docs.python.org/2/library/unittest.html\n> Generally, add a new class inheriting from `unittest.TestCase`, then add method(s) named `test_something` and use `self.assertEqual(expected_result, actual_result)` (or other method - see linked documentation). Then call it: `python -m unittest path/to/file`\n> \n> Some example: https://github.com/marmarek/qubes-core-admin/blob/core3-firewall/qubes/tests/firewall.py\n> \n> It's easier to write unit tests when code is sufficiently divided to functions: for example have separate `prepare_response` and `send_response` instead of `prepare_and_send_response`. But even in the later case, you can create wrapper class (just for testing purpose) to override `self.send` with something that will just save the data for later checking.\n> \n> It is common practice to have tests in separate file, but that is possible only when the actual code is installed as a python module, not directly in executable. Not sure if worth changing it here, probably not.\n\n","comments":[{"author":"Patrick","date_created":1478975880,"date_modified":1478975880,"content":"T565#10807"}]},"PHID-TASK-rgvu6prk7of5doweeruo":{"id":"565","title":"control-port-filter ddos test","status":"open","priority":"Normal","author":"Patrick","description":">>! In T448#10490, @HulaHoop wrote:\n> * a query stress test - bombarding cpfp with a very high volume of valid requests. Does cpfp fail gracefully? How does it cope with a simulated DDoS?","comments":[{"author":"Patrick","date_created":1478975836,"date_modified":1478975836,"content":"discussion:\nhttps://mailman.boum.org/pipermail/tails-dev/2016-November/011040.html\n\nconclusion:\n\nI guess we can use T16 for DDOS from external sources.\n\nThis ticket an attempt to contain damage by compromised workstations from ddos'ing the control port filter. Even if solved, still Tor could be ddos'ed. So I suggest to defer this ticket for a later release. The we perhaps solve it by using iptables as a limiter.\n"}]},"PHID-TASK-mue4chsplmpsix22dodg":{"id":"564","title":"rate limit add_onion / number of ephemeral Tor hidden services","status":"open","priority":"Normal","author":"Patrick","description":"We might able to use python-stem `list_ephemeral_hidden_services`.","comments":[{"author":"Patrick","date_created":1478975474,"date_modified":1478975474,"content":"I am no longer convinced that rate limiting buys us much.\n\nWill be limited to onionshare 50 ports initially. (Looking into ricochet later.)\n\ndiscussion:\nhttps://mailman.boum.org/pipermail/tails-dev/2016-November/011038.html"}]},"PHID-TASK-tb2xgdxdyqjdgyeigncn":{"id":"563","title":"no longer install by default brltty, brltty-speechd, brltty-x11","status":"resolved","priority":"Normal","author":"Patrick","description":"Creates a local listener port which might badly interact with T562.\n\nWe can try sort out not opening a listener later in T457.","comments":[{"author":"Patrick","date_created":1476210166,"date_modified":1476210166,"content":"https://github.com/Whonix/anon-meta-packages/commit/6bd004b9b145975cff79728d2fb7e74a62655adb"}]},"PHID-TASK-gyjrztlhzaqer7o4v6lb":{"id":"562","title":"control-port-filter add_onion parsing","status":"invalid","priority":"Normal","author":"Patrick","description":"Limit IPs to:\n\n* Qubes-Whonix: 10.137.0.0-10.138.255.255\n* Non-Qubes-Whonix: 10.152.152.0-10.152.152.24\n\nLimit ports to:\n\n* real ports\n\n----\n\nWIP:\n\n```\n#!/usr/bin/python\n\nimport logging\nimport os\nimport sys\n\nclient_ip = \"555.555.555.555\"\nADD_ONION_INJECT_IP = True\n\n#\"ADD_ONION RSA1024:[Blob Redacted] Port=80,192.168.1.1:8080\",\n\nadd_onion_test = [\n \"ADD_ONION NEW:BEST Flags=DiscardPK Port=80\",\n \"ADD_ONION NEW:BEST Flags=DiscardPK Port=80\",\n \"ADD_ONION NEW:BEST Port=22 Port=80,8080\",\n \"ADD_ONION NEW:BEST Flags=DiscardPK,BasicAuth Port=22\",\n \"ADD_ONION NEW:BEST Flags=DiscardPK Port=22\",\n \"ADD_ONION NEW:BEST Flags=DiscardPK,NonAnonymous Port=22\",\n \"ADD_ONION NEW:BEST Flags=DiscardPK Port=22\",\n \"ADD_ONION NEW:BEST Flags=DiscardPK,NonAnonymous Port=22\",\n \"add_onion new:best port=80,17600\",\n \"add_onion new:best port=80,127.0.0.1:17600\",\n \"add_onion new:best port=8 0,17600\"\n \"add_onion new:best port=80 : 17600\",\n \"add_onion new:best port=80 : 17600 Flags=DiscardPK\",\n \"add_onion new:best port= 80:17600 Flags=DiscardPK\",\n];\n\n## TODO: KeyBlob support\n## TODO: do not lower KeyBlob\n## TODO: do not lower ClientBlob\n## TODO: do not lower ClientName\n## TODO: (when implementing) KeyBlob maximum string length\n## TODO: (when implementing) ClientBlob maximum string length\ndef add_onion_parse(request, client_ip, inject):\n    ## ADD_ONION KeyType:KeyBlob\n    ## Flags=Flag,Flag\n    ## Port=VirtPort,TargetIP:TargetPort\n    ## ClientAuth=ClientName\n    ## ClientAuth=ClientName:ClientBlob\n\n    request_processed = \"\"\n\n    block_counter = 0\n    for block in request.split(\" \"):\n        block_counter = block_counter + 1\n        #logger.info('block %s: %s' % (str(block_counter), block))\n        if block_counter == 1 and block == \"add_onion\":\n           request_processed = \"add_onion\"\n           continue\n        if block_counter == 2:\n           KeyTyp = block.split(\":\")[0]\n           KeyBlob = block.split(\":\")[1]\n           if KeyTyp == \"new\":\n               request_processed = request_processed + \" \" + \"new\"\n           elif KeyTyp == \"rsa1024\":\n               request_processed = request_processed + \" \" + \"rsa1024\"\n           else:\n               logger.error('KeyType not whitelisted! KeyTyp: %s' % (KeyType))\n               return False\n           request_processed = request_processed + \":\" + KeyBlob\n           continue\n\n        first = block.split(\"=\")[0]\n        second = block.split(\"=\")[1]\n        if first == \"flags\":\n            request_processed = request_processed + \" \" + \"flags=\"\n            for single_flag in second.split(\",\"):\n                #logger.info('single_flag: %s' % (single_flag))\n                if single_flag == \"discardpk\":\n                   request_processed = request_processed + \"discardpk,\"\n                elif single_flag == \"detach\":\n                   request_processed = request_processed + \"detach,\"\n                elif single_flag == \"basicauth\":\n                   request_processed = request_processed + \"detach,\"\n                else:\n                   logger.error('Flag not whitelisted! flag: %s' % (single_flag))\n                   return False\n\n            ## Remove extraneous ',' at the end.\n            request_processed = request_processed[:-1]\n        elif first == \"port\":\n           request_processed = request_processed + \" \" + \"port=\"\n           port = second\n\n           ##    port=22\n           ## vs port=80,17600\n\n           ## Format such as 'Port=80,192.168.1.1:8080' not yet supported.\n\n           if len(port.split(\",\")) == 1:\n               if not port.isdigit():\n                   logger.error('port is no digit! port: %s' % (str(port)))\n                   return False\n               request_processed = request_processed + port + \",\"\n           elif len(port.split(\",\")) == 2:\n               port_counter = 0\n               for port_single in port.split(\",\"):\n                  if not port_single.isdigit():\n                     logger.error('port_single is no digit! port_single: %s' % (str(port_single)))\n                     return False\n\n                  #logger.info('port_single %s: %s' % (str(port_counter), port_single))\n                  port_counter = port_counter + 1\n                  if port_counter == 1:\n                      request_processed = request_processed + port_single + \",\"\n                  elif port_counter == 2:\n                      if inject == True:\n                          request_processed = request_processed + client_ip + \":\" + port_single + \",\"\n                      else:\n                          request_processed = request_processed + \":\" + port_single + \",\"\n                  else:\n                     logger.error('len(port.split(\",\")) too long!')\n                     return False\n\n           ## Remove extraneous ',' at the end.\n           request_processed = request_processed[:-1]\n\n    return request_processed\n\n\nmypid = os.getpid()\nlog_prefix = \"CPFP \" + str(mypid) + \" log\"\nlogger = logging.getLogger(log_prefix)\nlogger.setLevel(logging.DEBUG)\n\nformatter = logging.Formatter(\"%(asctime)s - %(name)s - %(levelname)s - %(message)s\")\nhandler = logging.StreamHandler(sys.stdout)\nhandler.setFormatter(formatter)\nlogger.addHandler(handler)\n\nfor request in add_onion_test:\n    logger.info('request_requested: %s' % (request))\n    request = request.lower().strip()\n    request_startswith = request.split(' ', 1)[0]\n    if request_startswith == \"add_onion\":\n        try:\n            request_processed = add_onion_parse(request, client_ip, ADD_ONION_INJECT_IP)\n        except:\n            exception_msg = str(sys.exc_info()[0])\n            logger.error('exception_msg: %s' % (exception_msg))\n            request_processed = False\n        logger.info('request_processed: %s' % (request_processed))\n        print \"\"\n```\n\n-----\n\n```\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Flags=DiscardPK Port=80\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_processed: add_onion new:best flags=discardpk port=80\n\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Port=22 Port=80,8080\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_processed: add_onion new:best port=22 port=80,555.555.555.555:8080\n\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Flags=DiscardPK,BasicAuth Port=22\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_processed: add_onion new:best flags=discardpk,detach port=22\n\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Flags=DiscardPK Port=22\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_processed: add_onion new:best flags=discardpk port=22\n\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Flags=DiscardPK,NonAnonymous Port=22\n2016-09-27 16:26:19,283 - CPFP 9680 log - ERROR - Flag not whitelisted! flag: nonanonymous\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_processed: False\n\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Flags=DiscardPK Port=22\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_processed: add_onion new:best flags=discardpk port=22\n\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Flags=DiscardPK,NonAnonymous Port=22\n2016-09-27 16:26:19,283 - CPFP 9680 log - ERROR - Flag not whitelisted! flag: nonanonymous\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_processed: False\n\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_requested: add_onion new:best port=80,17600\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_processed: add_onion new:best port=80,555.555.555.555:17600\n\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_requested: add_onion new:best port=80,127.0.0.1:17600\n2016-09-27 16:26:19,284 - CPFP 9680 log - ERROR - port_single is no digit! port_single: 127.0.0.1:17600\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_processed: False\n\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_requested: add_onion new:best port=8 0,17600add_onion new:best port=80 : 17600\n2016-09-27 16:26:19,284 - CPFP 9680 log - ERROR - exception_msg: <type 'exceptions.IndexError'>\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_processed: False\n\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_requested: add_onion new:best port=80 : 17600 Flags=DiscardPK\n2016-09-27 16:26:19,284 - CPFP 9680 log - ERROR - exception_msg: <type 'exceptions.IndexError'>\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_processed: False\n\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_requested: add_onion new:best port= 80:17600 Flags=DiscardPK\n2016-09-27 16:26:19,284 - CPFP 9680 log - ERROR - port is no digit! port: \n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_processed: False\n```\n","comments":[{"author":"Patrick","date_created":1481134237,"date_modified":1481134237,"content":"Superseded by T573."}]},"PHID-TASK-tw2utvdizhtry4osfbuu":{"id":"561","title":"find way to have Tor ephermal hidden service using applications in Whonix-Workstation bind on all interfaces","status":"resolved","priority":"Normal","author":"Patrick","description":"For example onionshare binds its webserver on 127.0.0.1.\n\nThat cannot work because it needs to bind on the external IP.\n\nApproaches:\n\n----\n\n* a) work with upstream (onionshare etc.) to provide a switch to listen on all interfaces and automatically do so inside Whonix. Not great, not generic, takes a long time until merged and landing in Debian.\n\n----\n\n\n* b) Some solution using [bindp](https://github.com/yongboy/bindp).\n\n     BIND_ADDR=\"10.137.6.41\" LD_PRELOAD=/home/user/bindp/libindp.so onionshare a\n\n(tested to work)\n\n\nNot great, not generic.\n\n----\n\n* c) An iptables based solution that requires `net.ipv4.conf.all.route_localnet=1`.\n\n`What are the security implications of net.ipv4.conf.eth0.route_localnet=1 / route_localnet?`\nhttp://security.stackexchange.com/questions/137602/what-are-the-security-implications-of-net-ipv4-conf-eth0-route-localnet-1-rout\n\nhttps://www.whonix.org/wiki/Dev/Port_Redirection\n\nNot great, not generic.\n\n----\n\n* d)\n\n```\nsocat TCP-LISTEN:17600,bind=10.137.6.41,fork TCP:127.0.0.1:17600\n```\n\n * Loads of socat listeners. At some point they could even eat too much RAM if they become too many.\n * Could be made conditional by only loading these listeners if onionshare is installed. (Not great when installed inside template and not all Whonix-Workstations use onionshare.)\n * EDIT: Perhaps not that many socat listeners by using systemd socket activation.\n  * related: `port anon-ws-disable-stacked-tor to systemd socket activation` T623\n\n----\n\n* e) something better?\n\nhttp://unix.stackexchange.com/questions/311492/redirect-application-listening-on-localhost-to-listening-on-external-interface\n\n----\n\n(EDIT)\n\n* f) `write draft for local listener standard on debian-devel` T635","comments":[{"author":"Patrick","date_created":1484038144,"date_modified":1484038144,"content":"> a) work with upstream (onionshare etc.) to provide a switch to listen on all interfaces and automatically do so inside Whonix. Not great, not generic, takes a long time until merged and landing in Debian.\n\nWon't happen by the time this ends up in stretch. Anyhow. Should go for it optionally so any other workarounds can later be abolished.\n\n> b) Some solution using bindp.\n\nI decided to go for that solution since the other solutions aren't looking feasible/great. bindp has been packaged by me, automated as wrapper and added it #uwt. Will git push it soon.\n\nCould you please have a look bindp and comment on the C code from a security perspective? @marmarek Without comments it's just 5 lines of make and 100 lines of C code.\n\nhttps://github.com/yongboy/bindp\n\nI managed to enable Debian packaging compiler hardening flags. Output of checksec looks \"quite good\", \"almost all green\", besides the stack canary field. (Better than most libs in `/usr/lib/**.so`.)\n\n```\nchecksec --file libindp.so \n```\n```\nRELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE\nFull RELRO      No canary found   NX enabled    PIE enabled     No RPATH   No RUNPATH   libindp.so\n```\n\nAs you can see, just the stack canary is missing. Is that a huge isssue?\n\nCompilation during package build looks as follows and shows a warning.\n\n```\ngcc -nostartfiles -fpic -shared bindp.c -o libindp.so -ldl -D_GNU_SOURCE -D_FORTIFY_SOURCE=2 -g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -fPIE -pie -Wl,-z,relro -Wl,-z,now\n/usr/bin/ld.bfd.real: warning: cannot find entry symbol _start; defaulting to 0000000000000660\n```\n\nIs there anything concerning about that?"},{"author":"Patrick","date_created":1484038499,"date_modified":1484038499,"content":"Also reported these two compilation issues upstream.\n\n- https://github.com/yongboy/bindp/issues/2\n- https://github.com/yongboy/bindp/issues/3"},{"author":"Patrick","date_created":1484042902,"date_modified":1484042902,"content":"```\nonionshare support\npackage bindp\nuwtwrapper_verbose\nuwt rewrite\ncode simplification\nrefactoring\n```\nhttps://github.com/Whonix/uwt/commit/f3688a6813abe82597399da5bf05f0bca7771ff8"},{"author":"Patrick","date_created":1484043249,"date_modified":1484043249,"content":"onionshare feature request:\nhttps://github.com/micahflee/onionshare/issues/220#issuecomment-271536830\n"},{"author":"marmarek","date_created":1484092689,"date_modified":1484092689,"content":">>! In T561#11317, @Patrick wrote:\n>> a) work with upstream (onionshare etc.) to provide a switch to listen on all interfaces and automatically do so inside Whonix. Not great, not generic, takes a long time until merged and landing in Debian.\n> \n> Won't happen by the time this ends up in stretch. Anyhow. Should go for it optionally so any other workarounds can later be abolished.\n> \n>> b) Some solution using bindp.\n> \n> I decided to go for that solution since the other solutions aren't looking feasible/great. bindp has been packaged by me, automated as wrapper and added it #uwt. Will git push it soon.\n> \n> Could you please have a look bindp and comment on the C code from a security perspective? @marmarek Without comments it's just 5 lines of make and 100 lines of C code.\n> \n> https://github.com/yongboy/bindp\n\nGenerally it looks ok. The only issue I see is it replace address in all `bind` calls - even those with different address family than `AF_INET`. In that case, address structure may be different (and also have different size) and strange things may happen. If a particular application use only `AF_INET` binds, it should be ok. You can check with `strace` and `grep`.\n\n> I managed to enable Debian packaging compiler hardening flags. Output of checksec looks \"quite good\", \"almost all green\", besides the stack canary field. (Better than most libs in `/usr/lib/**.so`.)\n> \n> ```\n> checksec --file libindp.so \n> ```\n> ```\n> RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE\n> Full RELRO      No canary found   NX enabled    PIE enabled     No RPATH   No RUNPATH   libindp.so\n> ```\n> \n> As you can see, just the stack canary is missing. Is that a huge isssue?\n\nNot a huge, especially as the library doesn't deal with any dynamic sized structures on stack (maybe that's why gcc didn't put stack canary there, even with `-fstack-protector-strong`?).\n\n> Compilation during package build looks as follows and shows a warning.\n> \n> ```\n> gcc -nostartfiles -fpic -shared bindp.c -o libindp.so -ldl -D_GNU_SOURCE -D_FORTIFY_SOURCE=2 -g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -fPIE -pie -Wl,-z,relro -Wl,-z,now\n> /usr/bin/ld.bfd.real: warning: cannot find entry symbol _start; defaulting to 0000000000000660\n> ```\n> \n> Is there anything concerning about that?\n\nMy guess: missing `-shared` option. Not a big problem."},{"author":"Patrick","date_created":1484159446,"date_modified":1484159446,"content":"Created T599 for that."},{"author":"Patrick","date_created":1487011007,"date_modified":1487011007,"content":"Removed from #uwt and moved to its own package.\n\nhttps://github.com/Whonix/bindp"}]},"PHID-TASK-yyccqd2e6xifhvxlcuzw":{"id":"560","title":"finish RetroShare over Tor port redirection instructions","status":"open","priority":"Wishlist","author":"Patrick","description":"https://www.whonix.org/wiki/Chat#RetroShare\n\n> INCOMPLETE - Depends on unimplemented features for Whonix\n> https://github.com/RetroShare/RetroShare/issues/356\n\nShould be doable since #whonix_14 by using [`/etc/anon-ws-disable-stacked-tor.d`](https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/etc/anon-ws-disable-stacked-tor.d) drop-in config snippet? (T544)","comments":[]},"PHID-TASK-ggfz4xqvowllgusur5w2":{"id":"559","title":"Securing/Removing DHCPClient from GW (was: Netstat Gateway log)","status":"resolved","priority":"Normal","author":"HulaHoop","description":"On the GW the netstat -tulpen output shows dhclient as working on all interfaces including the internal network. This is very bad especially since its not just listening. The only place where dhclient makes sense is the outer NIC of the GW where its a trusted NAT network that assigns dynamic addresses - however it should never be looking at the internal network for anything.\n\n\n```\nProto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode       PID/Program name\n\nudp        0      0 0.0.0.0:16151           0.0.0.0:*                           0          11238       858/dhclient    \nudp        0      0 0.0.0.0:68              0.0.0.0:*                           0          11262       858/dhclient    \nudp        0      0 10.152.152.10:5300      0.0.0.0:*                           0          18054       3435/tor        \nudp6       0      0 ::: (sanitized*)                    :::*                                0          11239                  \n            858/dhclient \n```\n            \n\n*Sanitized since I am not familiar with IPv6 addresses\n\nThe Tor UDP connection is unusual too. Any idea what that is about?","comments":[{"author":"Patrick","date_created":1474645108,"date_modified":1474645108,"content":"Tor port `5300` is easily answered. It's Tor's `DnsPort`.\n\nhttps://github.com/Whonix/anon-gw-anonymizer-config/blob/49ce21f97965609e4fe06af20005637878324fcc/usr/share/tor/tor-service-defaults-torrc.anondist#L153\n\n-----\n\ndhclient is a dependency of #anon-gw-dhcp-conf.\n\nhttps://github.com/Whonix/anon-gw-dhcp-conf/blob/b4999b1a6f79c280afbdecc521a1a05feb84526a/debian/control#L17\n\nIt is used to obtain a lan ip address for eth0 from the virtualizer. It should not be reachable from Whonix-Workstations since it is blocked by Whonix-Gateway firewall.\n\nAnyhow. It would be useful to make dhclient listen on eh0 only. Can you figure out how to configure isc-dhcp-client that way? We could also switch the dhcp client while we are at it."},{"author":"HulaHoop","date_created":1474653094,"date_modified":1474653159,"content":"Perhaps its not a problem:\n\n>Even though netstat shows dhcpd has a socket open that is listening, but \n>it only processes dhcp requests on the named interface.\n>\n>You can also use the local-address statement, but beware the special requirements.\n\n\nhttps://lists.isc.org/pipermail/dhcp-users/2010-July/011973.html\n\nHowever a couple of replies down:\n\n> I've found that version 3.0.4-13+etch2 (debian) listens and steals traffic not intended for it on interfaces which it is configured to not use.\n\nhttps://lists.isc.org/pipermail/dhcp-users/2010-July/011974.html\n\nI don't know much to disprove it either way but as long as it only listens (firewall takes care of that) and doesn't attempt talking to a dhcp server on the WS, it should be OK.\n\n***\n\nAn alternative could be the pydhcplib in Debian:\n\nhttp://pydhcplib.tuxfamily.org/pmwiki/index.php?n=Site.OptionsList\n\nHowever I'm leaning towards keeping everything as it is since you seem to have paid great attention to blocking DNS resolution setting using script hooks, and changing to something else might need more effort to reach the same safety level."},{"author":"Patrick","date_created":1474654775,"date_modified":1474654852,"content":"Even a functional /etc/resolv.conf on Whonix-Gateway would not be scary. As long as there is no local Tor DnsPort, it wont work.\n\nThe listener on all interfaces is more scary.\n\nHow is dhclient called? -> http://stackoverflow.com/questions/14720571/which-program-invokes-dhclient-on-debian-squeeze\n\nThe way it is called influences our options to replace it.\n\nAnd DHCP involves raw packages that circumvent iptables. Which is even more scary. A difficult topic.\n\nhttps://mailman.boum.org/pipermail/tails-dev/2014-December/007553.html"},{"author":"Patrick","date_created":1474654843,"date_modified":1474654858,"content":""},{"author":"Patrick","date_created":1474724035,"date_modified":1474724035,"content":"A question I thought that @HulaHoop asked. (Because I confused myself in T239#10445.)\n\n> Why not remove the DHCP client on Whonix-Gateway to reduce attack surface?\n\nGood question. Has long not been reconsidered. In past perhaps because of physical isolation, but that would not count anymore nowadays.\n\nVirtualizer specific. Some comments here:\n\nhttps://github.com/Whonix/whonix-gw-network-conf/blob/master/etc/network/interfaces.d/30_non-qubes-whonix\n\n- VirtualBox: as per comments, seams doable.\n- KVM: no idea\n- Qubes: does not need this\n\nSo if I make it work for VirtualBox, I wouldn't know if the same config would work for KVM. In case of VirtualBox, I don't remember if it caused conflicts with real LAN, other VMs or cloned Whonix-Gateways.\n\n@Patrick:\n>> I don't remember if it caused conflicts with real LAN, other VMs or cloned Whonix-Gateways.\n\n@HulaHoop:\n>What kind of conflicts?\n\nLet's suppose we no longer had a DHCP client installed and used static IPs.\n\nVirtualBox:\n\nThat this is non-trivial, is mentioned here:\nhttps://forums.virtualbox.org/viewtopic.php?f=1&t=49066\n\n* Whonix-Gateway 1 using static IP: 10.0.2.15\n* Whonix-Gateway 2 using static IP: 10.0.2.15\n* Some non-Whonix VM using NAT, getting IP 10.0.2.15 from VirtualBox DHCP server.\n\nWould they conflict within the VirtualBox NAT network? That has to be tested.\n\nDes VirtualBox static networking work reliable? That has to be tested.\n\n> Could you fool the Gateway filtering rules with spoofed IPs?\n\nNo. Imagine several physically isolated Whonix-Gateways behind the same physical router. Whonix-Workstations still cannot connect to other Whonix-Gateway which they are not directly connected to or otherwise circumvent them."},{"author":"HulaHoop","date_created":1474769481,"date_modified":1474769481,"content":"> The way it is called influences our options to replace it.\n\nHere is some similar info on what invokes it and how to change it:\n\nhttps://ubuntuforums.org/showthread.php?t=1773210&s=3926512bb7f3f9044dd8ed5b6a553d1f&p=10893136#post10893136\n\nDo you know what happens if no clients listed in ifupdown are installed?\n\n> Good question. Has long not been reconsidered. In past perhaps because of physical isolation, but that would not count anymore nowadays.\n\nThe effect it has on different hypervisors and how to change it is very hard to know and might cause even more usability friction. I'm for replacing dhclient with something else that we can configure to more sensible defaults.\n\n\n***\n\nChoices:\n\n* The pydhcplib package contains the client pydhcp that can be called from commandline to parse DHCP packets the way we would like. Seems to have the ability to alter interfaces on demand. Let me know if this is useful for our purposes:\n\nhttp://manpages.ubuntu.com/manpages/precise/man8/pydhcp.8.html\n\n\"Option up tells pydhcp to set the network interface  up  if\n       not.  noup  tells  not  to  set  up the interface. up and noup are only\n       useful in combination with the device type. Default is noup.\"\n\n* https://packages.debian.org/jessie/udhcpc\n\nVery barebones busybox implementation. Listed in ifup list as one of the options it cycles thru if dhclient is not available."},{"author":"Patrick","date_created":1474775612,"date_modified":1474775612,"content":">>! In T559#10454, @HulaHoop wrote:\n> Do you know what happens if no clients listed in ifupdown are installed?\n\nDidn't test. Would speculate, no DHCP, no connectivity then.\n\n> The effect it has on different hypervisors and how to change it is very hard to know and might cause even more usability friction. I'm for replacing dhclient with something else that we can configure to more sensible defaults.\n\nYes, that would be great. Ideally written in a memory safe language. And ideally neither listening for nor sending raw packages.\n\nFar best solution and to be sorted out first however is a static network configuration without any dhcp. Seems less effort to me than reinventing a new dhcp solution."},{"author":"HulaHoop","date_created":1474778560,"date_modified":1474779917,"content":"Confirmed. You are right that it uses raw sockets which do bypass iptables. For the record Shellshock directly affected dhcpclient. I think something this dangerous should be ripped out then questions asked later if it doesn't completely break things.\n\nhttps://diablohorn.com/2013/11/28/qp-raw-sockets-iptables/\n\nPotential solution is a \"derooted DHCPclient that does not need CAP_NET_RAW\"\n\nLikely possible with systemd because it can whitelist CAPS.  Not sure if it can be run non-root however.\n\nApparmor can block raw socket access. AFAIK the version in Debian cannot control network access yet?\n\nIts worst than I thought. This behavior is part of an RFC so likely this is how other clients might behave... There is pushback when someone suggested to change this:\n\nhttps://kb.isc.org/article/AA-00378/0/Why-does-DHCP-use-raw-sockets.html\n\n***\n\nYou can indirectly disable raw sockets by removing the raw cap with an Apparmor profile for dhcpclient."},{"author":"HulaHoop","date_created":1474805997,"date_modified":1474805997,"content":"To check if this measure works show all raw sockets on system:\n\nhttps://stackoverflow.com/a/17523444\n\ncat /proc/net/raw"},{"author":"Patrick","date_created":1474915926,"date_modified":1474915926,"content":"Switched to static network configuration.\n\n- https://github.com/Whonix/anon-gw-dhcp-conf/commit/ce5b8e0c4e09f24379a09748524a5fb58812170c\n- https://github.com/Whonix/whonix-gw-network-conf/commit/670b928231327fc858e4cc588c5be58d281b4f25\n\n- Works with #virtualbox.\n- Likely breaks #kvm. A solution for that has to be found. @HulaHoop \n- Will make #physical_isolation configuration more difficult.\n"},{"author":"HulaHoop","date_created":1474930649,"date_modified":1474930649,"content":"\nWith libvirt a user can create another NAT network besides the default - with the same IP range. So another GW would have its own dedicated NAT without conflicts."},{"author":"Patrick","date_created":1474932112,"date_modified":1474932112,"content":"Can you emulate these changes, use that static IP? What will need changes? KVM documentation?"},{"author":"HulaHoop","date_created":1474946977,"date_modified":1474946977,"content":"> Can you emulate these changes, use that static IP?\n\nTested. Not working but thats expected since the ip range on the \"default\" network supports 192.168.122.2 - 192.168.122.254\n\n> What will need changes? KVM documentation?\n\nYes. I'll have to add steps for creating new NAT networks. I hope we can ship a static IP that works for both instead of adding another network creation step to KVM whonix default GW-WS install pair.\n\n> Works with VirtualBox.\n\nBy working you mean in multi-GW usecase too?"},{"author":"Patrick","date_created":1474986520,"date_modified":1474986520,"content":">   By working you mean in multi-GW usecase too?\n\nYes."},{"author":"HulaHoop","date_created":1474991959,"date_modified":1474991959,"content":"So can we move to something static in the 192.168.122.2 - 192.168.122.254 range (depends on VBox choking or not) or should I include another network file with the whonix-libvirt package?"},{"author":"Patrick","date_created":1475014784,"date_modified":1475014784,"content":"`192...` will be a huge generator of FUD \"conflicts with my router\". Long time ago we moved away from that exactly for that reason.\n\nShipping a network configuration file in whonix-libvirt won't work, since that would break VirtualBox.\n\nRemember https://forums.whonix.org/t/non-qubes-whonix-13-0-0-1-0-x-issues/2443? Relevant summary:\n\n- downloadable builds created by me\n- raw image contains both VirtualBox and KVM packages\n- therefore it was not possible to ship a KVM specific gui config package and not break VirtualBox at the same time\n\nSame here. Unless you find a way to active that network configuration file when it detects being run inside KVM only. You'd also have to conditionally - at run time - hide whonix-gw-network-conf /etc/network/interfaces.d/30_non-qubes-whonix. Very complex and hacky.\n\nChanging VirtualBox static IP range may be possible, but would break connectivity for all users who do Whonix 13 -> Whonix 14 upgrades and they'd have to run some obscure commands on the host to fix this. Would be a support hell."},{"author":"HulaHoop","date_created":1475071103,"date_modified":1475071103,"content":"My mistake I was not clear. By network configuration I mean yet another XML to create a new separate network as an alternative to \"default\" (like how I do it now with whonix internal network for KVM). It has nothing to do with GW files at all. No changes have to be made there.\n\nNow my only question is: What is the subnet range you would like me to include for that custom network?"},{"author":"Patrick","date_created":1475075441,"date_modified":1475075441,"content":"Same as VirtualBox.\n\nhttps://github.com/Whonix/whonix-gw-network-conf/blob/670b928231327fc858e4cc588c5be58d281b4f25/etc/network/interfaces.d/30_non-qubes-whonix#L27\n\nIt has to work if Whonix-Gateway tries to use this static configuration:\n\n```\nauto eth0\niface eth0 inet static\n        address 10.0.2.15\n        netmask 255.255.255.0\n        gateway 10.0.2.2\n```"},{"author":"HulaHoop","date_created":1475081095,"date_modified":1475081095,"content":"What I meant was subnet range using the CIDR calculator:\n\nhttp://jodies.de/ipcalc?host=10.0.0.0&mask1=16&mask2=255.255.255.0\n\nNetwork:   10.0.2.0/24           00001010.00000000.00000010 .00000000 (Class A)\nBroadcast: 10.0.2.255            00001010.00000000.00000010 .11111111\nHostMin:   10.0.2.1              00001010.00000000.00000010 .00000001\nHostMax:   10.0.2.254            00001010.00000000.00000010 .11111110\nHosts/Net: 254\n\nI created a test network with 10.0.2.0/24 and no matter what I did the GW could not connect.\n\nI enabled broadcasts in interfaces.d, disabled and enabled the test network DHCP with no result. So the current code will completey break KVM Whonix connectivity unfortunately.\n\n***\n\nThe only sane solution IMO is to reinstate dhcp-client while wrapping it in an apparmor profile that forbids raw socket creation by denying the cap. That way iptables can blocks connections to it on internal-net.\n"},{"author":"Patrick","date_created":1475082179,"date_modified":1475082179,"content":"I doubt it is possible to successfully use a dhcp client with raw sockets disabled. It may be possible to develop such a thing in theory, but I don't think it exists.\n\nScratch the \"dhcp kvm\" search term. The proper search term is \"kvm static network configuration\". Start with a Debian VM, then port the working solution to Whonix for debugging purposes.\n\nhttp://serverfault.com/questions/627238/kvm-libvirt-how-to-configure-static-guest-ip-addresses-on-the-virtualisation-ho"},{"author":"HulaHoop","date_created":1475106151,"date_modified":1475106151,"content":"> http://serverfault.com/questions/627238/kvm-libvirt-how-to-configure-static-guest-ip-addresses-on-the-virtualisation-ho\n\nThese steps were not needed at all. Once I selected non-conflicting settings everything worked. Some changes to the netmask and gateway will need to be made to interfaces.d\n\nThis works:\n\n\n```\naddress 10.0.2.15\nnetmask 255.255.252.0\ngateway 10.0.0.1\n```\n\n\n***\n\nnetmask calculator:\n\nhttp://www.jodies.de/ipcalc?host=10.0.2.15&mask1=255.255.252.0&mask2=\n\n```\nAddress:   10.0.2.15             00001010.00000000.000000 10.00001111\nNetmask:   255.255.252.0 = 22    11111111.11111111.111111 00.00000000\nWildcard:  0.0.3.255             00000000.00000000.000000 11.11111111\n=>\nNetwork:   10.0.0.0/22           00001010.00000000.000000 00.00000000 (Class A)\nBroadcast: 10.0.3.255            00001010.00000000.000000 11.11111111\nHostMin:   10.0.0.1              00001010.00000000.000000 00.00000001\nHostMax:   10.0.3.254            00001010.00000000.000000 11.11111110\nHosts/Net: 1022 \n```   \n\nI compared it to internal network's netmask to make sure no conflicts:\n\n\n\n```\nAddress:   10.152.152.10         00001010.10011000.10 011000.00001010\nNetmask:   255.255.192.0 = 18    11111111.11111111.11 000000.00000000\nWildcard:  0.0.63.255            00000000.00000000.00 111111.11111111\n=>\nNetwork:   10.152.128.0/18       00001010.10011000.10 000000.00000000 (Class A)\nBroadcast: 10.152.191.255        00001010.10011000.10 111111.11111111\nHostMin:   10.152.128.1          00001010.10011000.10 000000.00000001\nHostMax:   10.152.191.254        00001010.10011000.10 111111.11111110\nHosts/Net: 16382                 (Private Internet)\n```\n\n***\n\nThe nat network settings that worked. What other name do you suggest besides \"test\"?\n\n\n```\n<network>\n  <name>test</name>\n  <forward mode='nat'>\n    <nat>\n      <port start='1024' end='65535'/>\n    </nat>\n  </forward>\n  <bridge name='virbr2' stp='on' delay='0'/>\n  <domain name='test'/>\n  <ip address='10.0.0.1' netmask='255.255.252.0'>\n    <dhcp>\n      <range start='10.0.2.0' end='10.0.3.254'/>\n    </dhcp>\n  </ip>\n</network>\n\n```"},{"author":"HulaHoop","date_created":1475106298,"date_modified":1475106298,"content":"Various documentation changes:\n\n\nAdd import steps for new network\n\nChange the side by side instructions to account for static addresses and vibr numbers.\n\nInclude a warning somewhere on the multi-WS pages against using the same gateway for different WS trust-levels"},{"author":"Patrick","date_created":1475108898,"date_modified":1475108898,"content":">>! In T559#10494, @HulaHoop wrote:\n> address 10.0.2.15\n> netmask 255.255.252.0\n\nThis works for VirtualBox.\n\n> gateway 10.0.0.1\n\nThis breaks VirtualBox.\n> What other name do you suggest besides \"test\"?\n\n`Whonix-Gateway`? Perhaps even more specifically, it being for the external network interface.\n"},{"author":"Patrick","date_created":1475109083,"date_modified":1475109083,"content":"Looks like libvirt supports a `gateway=` keyword. Does that work?"},{"author":"HulaHoop","date_created":1475110250,"date_modified":1475110250,"content":"> Looks like libvirt supports a gateway= keyword. Does that work?\n\nNo. Its applicable to static routing networks not NAT, however I will test with another subnet range. It will likely work but the choice of 10.0.2.15 must be changed."},{"author":"HulaHoop","date_created":1475111455,"date_modified":1475111455,"content":"10.0.2.0/24\n\nWorks:\n\n\n```\naddress 10.0.2.128\nnetmask 255.255.255.0\ngateway 10.0.2.1\n\n\n<network>\n  <name>nat</name>\n  <forward mode='nat'>\n    <nat>\n      <port start='1024' end='65535'/>\n    </nat>\n  </forward>\n  <bridge name='virbr2' stp='on' delay='0'/>\n  <domain name='nat'/>\n  <ip address='10.0.2.1' netmask='255.255.255.0'>\n    <dhcp>\n      <range start='10.0.2.128' end='10.0.2.254'/>\n    </dhcp>\n  </ip>\n\n```"},{"author":"Patrick","date_created":1475119028,"date_modified":1475119028,"content":">>! In T559#10500, @HulaHoop wrote:\n> address 10.0.2.128\n> netmask 255.255.255.0\n\nWorks with VirtualBox.\n\n> gateway 10.0.2.1\n\nChanging the gateway IP does not work for VirtualBox."},{"author":"HulaHoop","date_created":1475152929,"date_modified":1475152929,"content":"Then we have reached an impasse because nothing I can put in the network configuration can change the gateway IP. Its not KVM's fault as its the norm to have gateway IPs of x.x.x.1 for a given subnet. Because some idiot on the VBox team chose .2 compatibility is impossible.\n\nThe only network type where it can be changed is in static routing but it would require users to change their physical LAN settings to run Whonix - not gonna happen."},{"author":"HulaHoop","date_created":1475155252,"date_modified":1475155252,"content":"A very ugly hack:\n\nUse a realtime network packet editor like netsed to change any outgoing packet ip destination headed for 10.0.2.2 to 10.0.2.1.\n\nnetsed uses scapy which uses raw sockets but at least you can bind it to a single interface instead of being forced to have this on all interfaces as with dhcpclient.\n\nhttps://packages.debian.org/jessie/netsed"},{"author":"Patrick","date_created":1475170388,"date_modified":1475170388,"content":"Can you redirect these packages using `route`? (Try in a Debian VM first to exclude Whonix firewall from interfering.)"},{"author":"HulaHoop","date_created":1475181695,"date_modified":1475181695,"content":"> Can you redirect these packages using route? (Try in a Debian VM first to exclude Whonix firewall from interfering.)\n\nThought about it some more.\n\nMy last idea doesn't make sense since it will do this for both versions so it will still break VBox.\n\nI see no easy solution to this..."},{"author":"Patrick","date_created":1475183009,"date_modified":1475183009,"content":"We're using `ConditionVirtualization=kvm` elsewhere already.\n(shared-folder-help systemd unit file) Should be doable to reuse it for\nthe `route` command also."},{"author":"HulaHoop","date_created":1475205557,"date_modified":1475205557,"content":"> We're using ConditionVirtualization=kvm elsewhere already.(shared-folder-help systemd unit file) Should be doable to reuse it for the route command also.\n\nSince this is an option how about shipping a 30_non-qubes-vbox or just 30_vbox and a 30_kvm and have a service that conditiobally activates one or the other based on detecting the vm type - it can do this by deleting the unnecessary file upon boot. This makes sure that even if the package updates reintroduce the file it gets cleaned up again.\n\nThe advantage is I can include a static ip config in 30_kvm that just works with the default network without needing yet more steps to setup kvm whonix.\n\n\n***\n\nTested that multiple GWs using the same static ip works. No documentation changes needed for that."},{"author":"Patrick","date_created":1475241859,"date_modified":1475241859,"content":"Seems like an awful hack. Last resort. If it somehow by some update (by ifupdown) is run after ifupdown, it breaks connectivity.\n\nWhat about `ConditionVirtualization=kvm` + `route`?"},{"author":"HulaHoop","date_created":1475247490,"date_modified":1475247490,"content":"OK I will try route but I need some help with commands.\n\nIs it possible to overwrite everything to be in the 192.168.122.0/24 subnet?"},{"author":"Patrick","date_created":1475247942,"date_modified":1475247942,"content":"No idea. But we should probably stay on the subnet we have."},{"author":"HulaHoop","date_created":1475264206,"date_modified":1475264206,"content":"Great news! This config works without hacks. You can keep 10.0.2.15 unchanged too. Turns out the gateway ip address was just called \"ip address\"...\n\n\n```\n<network>\n  <name>external</name>\n  <forward mode='nat'/>\n  <bridge name='virbr1' stp='on' delay='0'/>\n  <ip address='10.0.2.2' netmask='255.255.255.0'/>\n</network>\n```\n\n\nMust change Whonix (internal) to virbr2\n\nThinking about changing naming of network files to internal/external to be more clear.\n\n\nsubnet range not conflicting:\n\n\n```\nAddress:   10.0.2.0              00001010.00000000.00000010 .00000000\nNetmask:   255.255.255.0 = 24    11111111.11111111.11111111 .00000000\nWildcard:  0.0.0.255             00000000.00000000.00000000 .11111111\n=>\nNetwork:   10.0.2.0/24           00001010.00000000.00000010 .00000000 (Class A)\nBroadcast: 10.0.2.255            00001010.00000000.00000010 .11111111\nHostMin:   10.0.2.1              00001010.00000000.00000010 .00000001\nHostMax:   10.0.2.254            00001010.00000000.00000010 .11111110\nHosts/Net: 254  \n``` "},{"author":"Patrick","date_created":1475270661,"date_modified":1475270661,"content":"That's great! So https://github.com/Whonix/whonix-gw-network-conf/blob/master/etc/network/interfaces.d/30_non-qubes-whonix can stay as is?\n\nBut existing KVM users need to change their config after upgrading to Whonix 14?"},{"author":"HulaHoop","date_created":1475291448,"date_modified":1475291448,"content":"Yes it can stay as it is.\n\n\n> But existing KVM users need to change their config after upgrading to Whonix 14?\n\nWith Whonix 14 there will be no direct upgrade path on KVM at least since the interfaces.d will break connectivity. Also with 64bit compatibility this means the repo paths have changed.\n\nNot a big problem as long as we warn people about it. The inevitable support threads can be redirected to a sticky topic."},{"author":"Patrick","date_created":1475335876,"date_modified":1475335876,"content":"> Also with 64bit compatibility this means the repo paths have changed.\n\nNo such issue. 32 bit users do not have to do anything. Just users who\ndownload Whonix 14 images will be 64 bit users. Users who used Whonix 13\nor before that was 32 bit can continue to use that. This is because\nWhonix packages are platform `_all`.\n\nhttps://forums.whonix.org/t/state-of-offical-64-bit-builds/399/16?u=patrick\n\nAt some point however when Debian kills 32 bit, they will have to\ndownload a new image. Not sure if it will be possible to upgrade i386 in\nplace to amd64 or if that would result in a too huge mess."}]},"PHID-TASK-ffmbthhr6m2bgnd3ic75":{"id":"557","title":"no longer install apparmor-notify by default","status":"resolved","priority":"Normal","author":"Patrick","description":"Having tons of users experience, worry and report harmless denied messages such as /etc/perl/sitecustomize.pl warning ( https://forums.whonix.org/t/var-log-kern-log-contains-4-denied-messages-in-the-last-day ) is not useful.\n\nTherefore no longer install aa-notify by default.\n\nAt the same time we should recommend installing aa-notify on the https://www.whonix.org/wiki/AppArmor as well as on the https://www.whonix.org/wiki/Security_Guide so apparmor warnings will still be noticed.","comments":[{"author":"Patrick","date_created":1476210264,"date_modified":1476210264,"content":"https://github.com/Whonix/anon-meta-packages/commit/4385dbdd54f68b0855cbc20574b9faa2d2f8a83e"}]},"PHID-TASK-d3p3pbvjx467hoxrwhb7":{"id":"556","title":"fix OpenPGP verifications confusion ova vs libvirt.xz ","status":"resolved","priority":"Normal","author":"Patrick","description":"https://www.reddit.com/r/Whonix/comments/531v0l/verifying_whonix_image_why_is_it_so_complicated/\n\nTODO:\n\n1) Remove `( sha512, sig)` from download tables.\n\n> (They are a relic from a time where I (@Patrick) tried making everyone happy. Implemented the feature request to also provide signed sha512 files. Either I say no to them or I mess up usability of the download table and confuse more users. I got better at saying no to non-contributing minorities of minorities that demand signed sha512 files in the download table.) (The links to these files will still be available download.whonix.org.)\n\n2) Create wiki templates for the following two guides:\n\n- https://www.whonix.org/wiki/Verify_the_virtual_machine_images_using_Linux and\n- https://www.whonix.org/wiki/Verify_the_virtual_machine_images_using_the_command_line\n\nThen create KVM and VirtualBox specific instructions. ova or libvirt.xz passed as wiki template variable.","comments":[{"author":"HulaHoop","date_created":1474512355,"date_modified":1474512355,"content":"Can you please link to the mediawiki variables instructions? I keep seeing math formula pages but that's not what we want"},{"author":"Patrick","date_created":1474514379,"date_modified":1474514389,"content":"This:\nhttps://www.mediawiki.org/wiki/Help:Templates\n\nBut you may be able to skip that, created an example here:\n\n- https://www.whonix.org/wiki/Template:Example\n- https://www.whonix.org/wiki/Example"},{"author":"HulaHoop","date_created":1475301864,"date_modified":1475301998,"content":"\nI can apply simple variables successfully with\n\n{{Verify_the_virtual_machine_images_using_Linux|livbirt.xz}} or .ova. However linking to a template (with variables in its name) instead of showing it from within another template is not allowed\n\nI wanted to call {{Verify the Whonix images|livbirt.xz}} from the KVM page which then changes\n\n{{tl|Verify the virtual machine images using Linux|{{{1}}}}} -> {{tl|Verify the virtual machine images using Linux|livbirt.xz}} on its own page to fetch a KVM specific set of instructions.\n\n***\n\nI think it will be easier to create a brief set of commandline instructions and forget about this."},{"author":"Patrick","date_created":1475337051,"date_modified":1475337051,"content":"Looking into it now."},{"author":"Patrick","date_created":1475338327,"date_modified":1475338327,"content":"Partially done. Now the most important parts of Verify_the_virtual_machine_images_using_the_command_line are still shared. \n\n* https://www.whonix.org/wiki/Verify_the_virtual_machine_images_using_the_command_line\n* https://www.whonix.org/wiki/VirtualBox/Verify_the_virtual_machine_images_using_the_command_line\n* https://www.whonix.org/wiki/KVM/Verify_the_virtual_machine_images_using_the_command_line\n* https://www.whonix.org/wiki/Template:Verify_the_virtual_machine_images_using_the_command_line\n* https://www.whonix.org/wiki/KVM#Verify_the_Whonix_images\n* https://www.whonix.org/wiki/Verify_the_Whonix_images\n\nDoes this help?"},{"author":"HulaHoop","date_created":1475367895,"date_modified":1475367895,"content":"Awesome. Done.\n\nShould I bother with Mac/Windows instructions when KVM is Linux only?"},{"author":"Patrick","date_created":1475432128,"date_modified":1475432128,"content":"Dunno if it happens that users download KVM on a Windows computer, than\ninstall on a Linux computer. Perhaps take a shortcut and tell them to\nstart doing it right everything on a Linux computer for better security."},{"author":"HulaHoop","date_created":1475457076,"date_modified":1475457076,"content":"I hope they will be smart enough to understand that KVM is Linux only.\n\nRemoved irrelevant guides. Considered done."}]},"PHID-TASK-yjw3w7bimpebs7fgyfrt":{"id":"555","title":"Host<->guest clipboard for KVM gateway is default on, should be off","status":"wontfix","priority":"Needs Triage","author":"HawKing","description":"For KVM gateway, the XML file needs to have the clipboard set to off for the gateway (it is default on currently for 13.0.0.1.1) . Klipper in the gateway sits there collecting the entire contents of everything copy-pasted in the host. Also, Klipper really shouldn't auto-start in the gateway, and probably not in the workstation; it just makes clipboard history that much easier to access for exploit. ","comments":[{"author":"HulaHoop","date_created":1473264097,"date_modified":1473264097,"content":"Hello HawKing. The reason we decided to enable it for the gateway is because it makes it easier to paste bridge addresses. The GW is considered part of the trusted computing base and if it isn't you will have much bigger problems that it just seeing clipboard input."}]},"PHID-TASK-4ljxk7myjtkhe6gaonag":{"id":"554","title":"install youtube-dl by default","status":"resolved","priority":"Low","author":"Patrick","description":"Has been suggested here:\nhttps://forums.whonix.org/t/vlc-apparmor-profile-wip\n","comments":[{"author":"HulaHoop","date_created":1474336337,"date_modified":1474336337,"content":"+1 Where should I add the package name?"},{"author":"Patrick","date_created":1474416018,"date_modified":1474416018,"content":"https://github.com/Whonix/anon-meta-packages/blob/master/debian/control#L86\n\nPackage: anon-workstation-packages-recommended"},{"author":"HulaHoop","date_created":1474471875,"date_modified":1474471875,"content":"https://github.com/Whonix/anon-meta-packages/pull/3/commits/eed9849c872622c1d4e8d10fe1e2991a3f43edff"}]},"PHID-TASK-hjxtpmlmudn7crk2qmnv":{"id":"553","title":"Emergency Crash Script to Protect Host FDE","status":"resolved","priority":"Wishlist","author":"HulaHoop","description":"One interesting feature I remember from Truecrypt was the ability to crash the system (using a user defined custom key) in an emergency shutdown to protect encrypted host data from seizure.\n\nOn Linux the way this would work is to enable the kernel feature for it and have a script execute the sysrq-trigger on demand - mapped to a key of the user's choice.\n\nhttps://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/s2-kdump-configuration-testing.html\n\nThen type the following commands at a shell prompt:\n\necho 1 > /proc/sys/kernel/sysrq\necho c > /proc/sysrq-trigger","comments":[{"author":"HulaHoop","date_created":1472773970,"date_modified":1472773970,"content":"Tested this and I found it causes the VM to freeze and hang. Far from the emergency solution I was looking for."},{"author":"Patrick","date_created":1472774581,"date_modified":1472774581,"content":"Host panic key instructions (or some day a package) would still be\ndesirable."},{"author":"HulaHoop","date_created":1474338556,"date_modified":1474338556,"content":"Apparently this feature is enabled on Debian hosts by default (so no package needed). Please test the key combination to confirm so I can document it.\n\nTo enable it:\necho \"1\" > /proc/sys/kernel/sysrq\n\nTo force crash:\necho \"o\" > /proc/sysrq-trigger\n\nor press:\nAlt + Printscreen + o\n\n***\n\nhttps://en.wikipedia.org/wiki/Magic_SysRq_key\nhttp://www.thegeekstuff.com/2008/12/safe-reboot-of-linux-using-magic-sysrq-key/"},{"author":"HulaHoop","date_created":1474656181,"date_modified":1474656181,"content":"Tested working without sysctl changes on Linux baremetal. Not supported on Xen.\n\nhttps://forums.whonix.org/t/fde-emergency-feature-testing-requested/2985\n\nwiki updated"},{"author":"marmarek","date_created":1474659837,"date_modified":1474659837,"content":"On Qubes it results in kernel message: `sysrq: SysRq : This sysrq operation is disabled.`\nDefault value of `/proc/sys/kernel/sysrq` on Qubes dom0 is 16. Changing to `1` does not work either:\n```\n[1363616.422789] sysrq: SysRq : Power Off\n[1363616.423456] xenbus: xenbus_dev_shutdown: backend/console/1069/0: Initialising != Connected, skipping\n[1363621.427069] xenbus: xenbus_dev_shutdown: backend/vbd/1069/51760 timeout closing device\n[1363626.430065] xenbus: xenbus_dev_shutdown: backend/vbd/1069/51744 timeout closing device\n[1363631.434062] xenbus: xenbus_dev_shutdown: backend/vbd/1069/51728 timeout closing device\n[1363636.437593] xenbus: xenbus_dev_shutdown: backend/vbd/1069/51712 timeout closing device\n[1363636.437595] xenbus: xenbus_dev_shutdown: backend/console/1068/0: Initialising != Connected, skipping\n[1363641.441056] xenbus: xenbus_dev_shutdown: backend/vbd/1068/51760 timeout closing device\n[1363646.443064] xenbus: xenbus_dev_shutdown: backend/vbd/1068/51744 timeout closing device\n[1363651.446038] xenbus: xenbus_dev_shutdown: backend/vbd/1068/51728 timeout closing device\n[1363656.447016] xenbus: xenbus_dev_shutdown: backend/vbd/1068/51712 timeout closing device\n[1363656.447016] xenbus: xenbus_dev_shutdown: backend/console/1067/0: Initialising != Connected, skipping\n[1363661.448050] xenbus: xenbus_dev_shutdown: backend/vbd/1067/51760 timeout closing device\n[1363666.451077] xenbus: xenbus_dev_shutdown: backend/vbd/1067/51744 timeout closing device\n[1363671.454069] xenbus: xenbus_dev_shutdown: backend/vbd/1067/51728 timeout closing device\n[1363676.457060] xenbus: xenbus_dev_shutdown: backend/vbd/1067/51712 timeout closing device\n[1363676.457118] xenbus: xenbus_dev_shutdown: backend/console/711/0: Initialising != Connected, skipping\n[1363681.460065] xenbus: xenbus_dev_shutdown: backend/vbd/711/51760 timeout closing device\n```\nAnd finally shutdown after timing out for every VM - 20s per VM. Not good, at least.\nSysrq-c makes dom0 frozen for some time (5s?) and then reboots. Also after changing sysctl setting."}]},"PHID-TASK-7cpymfz5exa5qmmmjjiz":{"id":"552","title":"Packaging USBKill","status":"open","priority":"Wishlist","author":"HulaHoop","description":"USBKill (GPL licensed) is a really cool anti-forensics script written in the aftermath of the SilkRoad trial. Its purpose is to trigger protection events that prevents adversaries from siphoning files/installing malware/running a mouse jiggler. It creates a USB whitelist of allowed devices of which anything else plugged into the machine causes it to erase its RAM and immediately shutdown. This can be adjusted to exclude all devices.\n\nIt can also be used in reverse, with a whitelisted flash drive in the USB port attached to the user's wrist via a lanyard serving as a key. In this instance, if the flash drive is forcibly removed, the program will initiate the desired routines. \n\n\n***\n\n~~github.com/hephaest0s/usbkill~~\n~~github.com/hephaest0s/usbkill/issues/75 - RFP~~\n\nhttps://github.com/Lvl4Sword/Killer\nhttps://github.com/Lvl4Sword/Killer/issues/31 - RFP\n\nhttps://en.wikipedia.org/wiki/USBKill\nhttps://7io.net/2015/07/02/python-usbkill-anti-forensic-usb-killswitch/#more-201\n\nOverlaps with T905.","comments":[{"author":"HulaHoop","date_created":1578415860,"date_modified":1578415860,"content":"An interesting product that triggers a system wipe if the cable is pulled:\n\nhttps://www.schneier.com/blog/archives/2020/01/usb_cable_kill_.html\n\nOf course it is too risky and very likely to create a false positive. May risk the cable being backdoored in a waterhole attack if it requires a tailored hardware product to work. "}]},"PHID-TASK-6wv2ipbhlwem4ybfuxtx":{"id":"551","title":"enter Whonix firewall timesync-fail-closed mode before suspend / enter Whonix firewall full mode after resume and clock-fix","status":"review","priority":"Normal","author":"Patrick","description":"- stop sdwdate before suspend\n- enter Whonix firewall timesync-fail-closed mode before suspend\n- restart sdwdate after resume\n- enter Whonix firewall full mode after sdwdate succeeded\n\n(Follow up task of T533.)","comments":[{"author":"Patrick","date_created":1473946362,"date_modified":1473946362,"content":"https://github.com/Whonix/sdwdate/commit/5262c9d956c55d7579ca3a8406f7ff70fd7f0cef"},{"author":"Patrick","date_created":1473979395,"date_modified":1473979395,"content":"- https://github.com/Whonix/sdwdate/commit/94064740bbf838d4d01f878fb96381424d7a87de\n- https://github.com/Whonix/whonix-gw-firewall/commit/54a32ab11b2e9bc88b55f2cdc559cf402d470ee2\n- https://github.com/Whonix/whonix-ws-firewall/commit/8321c2c2540879864dbb23f680ed999e8d698d69"},{"author":"Patrick","date_created":1520776170,"date_modified":1520776170,"content":"This is implemented but not activated as of Whonix 14.\nWhonix 14 uses `firewall_mode=full` in firewall config generally since T533 / T658."}]},"PHID-TASK-4xmx47a7thhafvagjsrj":{"id":"550","title":"Clock Drift Detection","status":"open","priority":"Normal","author":"HulaHoop","description":"A potential solution should be a part of sdwdate (or a separate component if you think it has multiple use cases).\n\nntpd does clock jump detection:\n\nhttps://unix.stackexchange.com/a/118636\n\n***\n\nProblems we need to workaround so it becomes possible:\n\n* On KVM Whonix at least, the hardware timer information is not updated in WS because kvm-clock and others are disabled.\n\n* Use of a guest agent to pass that kind of information from the host is not an option because its unsafe.\n\n* Fetching and comparing remote data with the perceived time in the WS poses scalability, performance and bootstrapping problems if the guest time is way off.\n\n***\n\nSolution concept:\n\n* The information about the current time is available to code in the GW where kvm-clock is available (via hwclock).\n\n* Create a systemd service that runs constantly and queries the hwclock on GW. If the drift between system time and hwclock exceeds a threshold it would trigger syncing locally on the GW and send a simple packet pattern to the Whonix internal network.\n\n* knockd server [0][1] constantly monitors the internal network would trigger the iptables lockdown if it sees the magic knock sequence. Note that no ports needs to be open on WS.\n\n***\n\n[0] http://www.zeroflux.org/projects/knock\n[1] https://packages.debian.org/jessie/knockd","comments":[{"author":"HulaHoop","date_created":1472331599,"date_modified":1472331599,"content":"The idea is complicated and the worrying part is the inter-VM communication of this information. Can this be done securely or will it create a massive attack surface on the GW?\n\nAll searches on piping commands to remote hosts involve using SSH in some way which I think we should never do..."},{"author":"HulaHoop","date_created":1472342050,"date_modified":1472342050,"content":"If T550 cannot be realized in an easy and secure way then we can simply advise users to freshly reboot their WS machines as part of their workflow.\n\nI think that for the GW at least, triggering post-suspend timesync is easier because it has access to an external clock source and doesn't communicate with other VMs."},{"author":"HulaHoop","date_created":1472472009,"date_modified":1472472084,"content":"Update:\n\nI thought of a way to get around the need for SSH. Its a concept of a simple signalling protocol that doesn't require access to open ports or a client program on the GW. Its similar to something I suggested when discussing alternatives to a CPF long ago but it makes much more sense in this situation."},{"author":"Patrick","date_created":1472495835,"date_modified":1472495835,"content":"Perhaps no gw/ws/host communication required in the following concept.\n\nI would not know why hwclock needs to be involved here. After suspend/resume both, hwclock and system clock should still be moved forward as if sdwdate was not involved? (Just the usual suspend/resume process for any system. They also do not have a messed up clock when using suspend/resume.)\n\nAfter suspend/resume be a leap, a \"clock jump\". Some time that could not be witnessed to have passed in a script. Should be able to detect. See the following prototype.\n\n`clock_jump_detector_monitor`:\n\n```\n#!/bin/bash\n\nset -x\nset -e\n\nclock_jump_detected() {\n   #if sudo service sdwdate status ; then\n      #sudo service sdwdate restart || true\n      #sudo service sdwdate status || true\n   #fi\n   sleep 60\n}\n\nwhile true; do\n   old_time=\"$(date)\"\n   old_unixtime=\"$(date +%s)\"\n   sleep 10\n   new_unixtime=\"$(date +%s)\"\n   new_time=\"$(date)\"\n   result=\"$(( new_unixtime - old_unixtime ))\"\n   if [ \"$result\" -ge \"60\" ]; then\n      true \"ge\"\n      clock_jump_detected\n   elif [ \"$result\" -le \"-60\" ]; then\n      true \"le\"\n      clock_jump_detected\n   else\n      true \"No clock jump detected.\"\n   fi\ndone\n```\n\nCan you try please if that script is able to detect suspend/resume?\n\nFor a production version, another feature would be required. Not detecting clock jumps caused by sdwdate itself. So sdwdate would have to create status files for:\n\n* `/var/run/sdwdate/clock_jump_soon.status`\n* `/var/run/sdwdate/clock_jump_done.status`\n\nThen a systemd daemon `clock_jump_detector_supervisor`script could use `inotifywait`.\n\n* When `/var/run/sdwdate/clock_jump_soon.status` is created, stop `clock_jump_detector_monitor`.\n* When `/var/run/sdwdate/clock_jump_done.status` is created, restart `clock_jump_detector_monitor`.\n\nExample of using `inotfywait`:\n\n* https://github.com/Whonix/anon-shared-helper-scripts/blob/master/usr/lib/anon-shared-helper-scripts/firewall-restarter\n* https://github.com/Whonix/whonix-gw-firewall/blob/master/lib/systemd/system/whonix-firewall-sdwdate-watcher.service"},{"author":"HulaHoop","date_created":1472499738,"date_modified":1472499738,"content":"Test summary:\n\n* WS paused for two minutes then resumed: No clock jump detected\n* WS left running then host suspended for two minutes then resumed: No clock jump detected\n* GW left running then host suspended for two minutes then resumed: clock_jump_detected\n\nI think the reason it can't work for the WS is because it has no notion of time outside it. It must reference a current time source to know that time has elapsed.\n\n> I would not know why hwclock needs to be involved here.\n\nYou are right. This seems to work for the GW."},{"author":"HulaHoop","date_created":1472505232,"date_modified":1472505232,"content":"For generating the knock packets (when clock jump detected) we can use scapy:\nhttps://packages.debian.org/jessie/python-scapy\n\nknockd listens on Layer 2 which means its not dependent on the packets reaching the WS ports. The advantage of this is that multiple WSs sharing the internal net can respond to the same knock signal even if its destined for one WS."},{"author":"Patrick","date_created":1472510520,"date_modified":1472510520,"content":"Right, `clock_jump_detector_monitor` works also not in VirtualBox ws (or gw). Both system time (`date`) and hardware clock (`hwclock`) do not notice VirtualBox being paused.\n\nLast hope, pm-utils. Did we discuss that yet? Perhaps `/etc/pm/sleep.d/` could do? Does pm-utils function in VMs? I did not have any luck back then getting it to work in VirtualBox or Qubes.\n\nWithout (virtualizer specific) hooks to be notified about suspend/resume, implementing this is a total mess. Without those also implementing T551 is impossible.\n\nI wonder if it was better to implement a host package that notifies VMs when they get suspend / resume. Then both this T550 and T551 would be easier to implement. (Such a package would likely and unfortunately require virtualizer specific parts.)"},{"author":"HulaHoop","date_created":1472750412,"date_modified":1472750412,"content":"\n\n> Right, clock_jump_detector_monitor works also not in VirtualBox ws (or gw). Both system time (date) and hardware clock (hwclock) do not notice VirtualBox being paused.\n\nIs that true on Linux too? I thought I saw a support thread about VBox 5+ using kvmclock device too: https://www.whonix.org/blog/virtualbox-acceleration-mode\n\n> Last hope, pm-utils. Did we discuss that yet? Perhaps /etc/pm/sleep.d/ could do? Does pm-utils function in VMs? I did not have any luck back then getting it to work in VirtualBox or Qubes.\n\nI don't think we talked about this. How would this work?\n\n> Without (virtualizer specific) hooks to be notified about suspend/resume, implementing this is a total mess. Without those also implementing T551 is impossible.\n\nI know that KVM guest agent can notify the gateway about a suspend resume. For other hypervisors where this isn't possible you might be able to pause the Gateway upon resume with a script on the host.\n\nConcept:\n\n* host script pauses GW upon a suspend event. \n* A daemon in WS constantly check to see if Tor is connected. If not it immediately set iptables to fail closed and initiates a sync event. The daemon check intervals are much shorter to prevent a race condition when host resumed.\n* host script unpauses GW after a longer interval to ensure fail closed is enforced.\n*The clock_jump_detector_monitor on GW initiates sync when jump detected. (I'll think about workarounds if it still doesn't work with VBox in paravirtual mode)\n\nNB This replaces the earler knockd/scapy proposal.\n\n> I wonder if it was better to implement a host package that notifies VMs when they get suspend / resume. Then both this T550 and T551 would be easier to implement. (Such a package would likely and unfortunately require virtualizer specific parts.)\n\nIf you are open to implementing host side packages for timesync then I think one which sets a random offset for VMs would be another great thing. Out of scope of this ticket but I'll open a new one if you agree.\n\nAll in all the stronger protections will be available for a subset of whonix host configurations anyway - VBox and KVM on Debian and Qubes. That is an acceptable compromise."},{"author":"Patrick","date_created":1472763556,"date_modified":1472763556,"content":">>! In T550#10191, @HulaHoop wrote:\n> \n> \n>> Right, clock_jump_detector_monitor works also not in VirtualBox ws (or gw). Both system time (date) and hardware clock (hwclock) do not notice VirtualBox being paused.\n> \n> Is that true on Linux too? I thought I saw a support thread about VBox 5+ using kvmclock device too: https://www.whonix.org/blog/virtualbox-acceleration-mode\n\nOnly tested and noticed to fail on Linux. Using VBox legacy as parallelization method.\n\n>> Last hope, pm-utils. Did we discuss that yet? Perhaps /etc/pm/sleep.d/ could do? Does pm-utils function in VMs? I did not have any luck back then getting it to work in VirtualBox or Qubes.\n> \n> I don't think we talked about this. How would this work?\n\npm-utils notices suspend/resume and can dispatch scripts that are dropped in `.d` folders. Perfect in theory. However as said above, didn't get it to work in VMs. \n\n>> Without (virtualizer specific) hooks to be notified about suspend/resume, implementing this is a total mess. Without those also implementing T551 is impossible.\n> \n> I know that KVM guest agent can notify the gateway about a suspend resume. For other hypervisors where this isn't possible you might be able to pause the Gateway upon resume with a script on the host.\n> \n> Concept:\n> \n> * host script pauses GW upon a suspend event. \n\nThat might be implemented with pm-utils that apparently work a lot better on hosts than in VMs.\n\n> * A daemon in WS constantly check to see if Tor is connected. If not it immediately set iptables to fail closed and initiates a sync event. The daemon check intervals are much shorter to prevent a race condition when host resumed.\n\nConstantly check is not going to fly. Also wastes cpu. It needs to be event based. No rushing. No fear of suspend actually happening before the scripts finished. It needs to be event based.\n\nFor VirtualBox this could be the way to go:\n\npm-utils > dispatches scripts on suspend -> blocks suspend until all scripts are done [this probably is an already existing core feature of pm-utils] -> run vboxmanage guestcontrol /path/to/suspend-pre-script/witin/vm -> stop Tor and sdwdate -> wait for that to finish -> actually suspend host\n\nSimilar for the suspend-pre-post script which would receive a randomized time from the host, restart Tor and sdwdate.\n\nThis is already implemented for Qubes, where this was simple due to their exemplary qrexec.\n\n(That way TCP connections be be avoided. Involving TCP would make all of this a lot more difficult. Then we would have to add a host-only network interface in the VMs, figure out the VM internal IPs from the host, and somewhat reinvent what vboxmanage guestcontrol is doing.)\n\n> *The clock_jump_detector_monitor on GW initiates sync when jump detected. (I'll think about workarounds if it still doesn't work with VBox in paravirtual mode)\n\nOnce we can dispatch hooks, a script before suspend / after resume, no clock jump detector will be required. Clock jump detector is just a weird workaround for that missing feature in virtualizers. Without such hooks, T551 cannot be effectively implemented.\n\n> If you are open to implementing host side packages for timesync then I think one which sets a random offset for VMs would be another great thing. Out of scope of this ticket but I'll open a new one if you agree.\n\nIt's a good idea, but I wouldn't know when I find time to implement it. The best we can do is have clear tickets that are actionable, that just need code, by prospective volunteers.\n\n-----\n\nThe more I think about it, host packages are really busting it.\n\n* virtualizer specific\n* host operating specific (Windows, Linux, MAC)\n** linux distribution specific (Debian vs Fedora vs etc.)\n* increasing difficulty to set up Whonix, more difficult to document \"you don't just need to install our VMs but also need to install these operating system specific host packages installed\""},{"author":"HulaHoop","date_created":1472771044,"date_modified":1472772655,"content":"You're right. My idea is needlessly complicated and I admit I learned a lot from your plan.\n\nhttps://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Virtualization_Deployment_and_Administration_Guide/sect-Managing_guest_virtual_machines_with_virsh-Starting_suspending_resuming_saving_and_restoring_a_guest_virtual_machine.html\n\n\nIIRC VBox disables power states for guests - maybe they can be enabled. KVM supports receiving pm events from the host.\n\n> The best we can do is have clear tickets that are actionable, that just need code, by prospective volunteers.\n\nYes.\n\n> The more I think about it, host packages are really busting it.\n\nI'd say there's no rush here. These are \"nice to have\" features but make no serious differences to Whonix's basic security guarantees. If some of the Whonix features can be  usable in Debian then why not?\n\nEDIT:\n\nOne thing I forgot is I removed the RTC timer so offsets are no longer possible. I consider the benfits of low resolution timers to outweigh the unavailability of the offset features."},{"author":"HulaHoop","date_created":1472773799,"date_modified":1472773799,"content":"Tested enabling pm settings in KVM and I don't see suspend/hibernate in the VM power options in the menu. VBox threads on SE agree that guest suspend isn't available.\n\nAt this point I think this idea is impossible for most virtualizers anyway."},{"author":"Patrick","date_created":1472774538,"date_modified":1472774538,"content":"HulaHoop (HulaHoop):\n> Tested enabling pm settings in KVM and I don't see suspend/hibernate in the VM power options in the menu.\n\nThese KDE menus are disabled by Whonix. In plain Debian VMs these should\nbe visible."},{"author":"HulaHoop","date_created":1472782403,"date_modified":1472782403,"content":"> These KDE menus are disabled by Whonix. In plain Debian VMs these should\nbe visible.\n\nOK. I used systemctl suspend in the guest and it worked. However there is a blocker.\n\n\nSending a suspend event from the host via virsh gives:\n\nsudo virsh dompmsuspend Whonix-Workstation --target mem\nerror: Domain Whonix-Workstation could not be suspended\nerror: argument unsupported: QEMU guest agent is not configured\n\nSince there are security warnings about installing the guest agent in untrusted VMs - its not possible."},{"author":"Patrick","date_created":1517757433,"date_modified":1517757433,"content":"Didn't rehash. What's next here? Looks like we learned a lot, but then things stalled. Could you please rehash, and then create a follow-up ticket with the way forward? @HulaHoop "},{"author":"HulaHoop","date_created":1518368988,"date_modified":1518406576,"content":"\n@Patrick I wrote a rehash. If you think is too complicated, let me know. It was the simplest and most reliable way I could think of:\n\n\nIn absence of a safe way to directly tell the WS about clock drift from the host's hardware clock, I propose a signalling mechanism from the GW to WS to trigger an iptables lockdown combined with activating timesync before re-allowing connections.\n\nOutline:\n\n* GW has access to host's hwclock since its part of the TCB.\n* Once a clock drift is detected after a suspend/hibernate, a GW service would send a simple packet pattern to a knockd instance on the WS.\n* knockd has the ability to trigger arbitrary commands based on the signal. This makes it flexible enough to use for iptables lockdown, timesync activation followed by iptables release.\n\nEDIT:\n\n**How will packets be generated? There are a couple of good ways:**\n\npktgen \n\nis an in-kernel module that does just that. Its part of the linux networking subsystem and has been around a long time. I believe that the Linux net stack has really been well examined over time.\n\nhttps://wiki.linuxfoundation.org/networking/pktgen\n\n***\n\ntrafgen\n\nIf you still don't like the idea of using something in-kernel then there is this tool that comes as part of the netsniff-ng fuzzing suite by Daniel Borkmann. Borkmann is a really talented sec professional who has made some impressive contributions to Linux over time. N.B. that it needs to run as root too. The netsniff-ng toolkit does not depend on the libpcap library - which is important since pcap has had a very bad history of sec vulns.. Moreover, no special operating system patches are needed to run the toolkit. \n\nhttps://en.wikipedia.org/wiki/Netsniff-ng\nhttps://www.mankier.com/8/trafgen\n\nIts included in Debian.\n\n***\n\n**How can clock drift be measured?**\n\nhttps://unix.stackexchange.com/a/118636\n\nUsing //ntpdate -d// in the example script.\n\nntpdate in this case is running dormantly with no connections to the outside world configured."},{"author":"Patrick","date_created":1518428582,"date_modified":1518428582,"content":"It's a very good rehash!\n\n`ntpdate -d`, I am afraid, might not work for us. Probably does not work over Tor (if you try that inside Whonix-Workstation)?\n\n> iptables lockdown, timesync activation followed by iptables release.\n\nfirewall lockdown after boot mostly done:\nhttps://forums.whonix.org/t/firewall-lockdown-until-timesync-is-done/4820\n\nfirewall lockdown after clock drift detection: could be regarded a separate feature. Clock fix (sdwdate restart) after clock drift detection is the main feature here. Mostly a technicality.\n\nfirewall lockdown after clock drift detection:\n\n* It would be too slowly activate for already open connections. By the time the gateway detected the clock drift and notified the workstation, reload of the firewall, almost certainly already running applications have emitted traffic.\n * A working solution needs some kind of hook that locks the network before suspend, i.e. what suspend-pre scripts are for, which are not available to us in most virtualizers.\n* May be still worthwhile to prevent new connections, but then we may muddle the water. Implying to provide security that we do not?\n\n"},{"author":"HulaHoop","date_created":1518450735,"date_modified":1518451655,"content":"Oops didn't realize ntpdate requires query of remote servers. ntpdate is obsolete anyhow but the newer clockdiff still talks to online servers instead of comparing local values. hwclock can give us that:\n\nhttps://stackoverflow.com/a/40656375\n\n//hwclock --compare//\n\nwill do what you want. This compares the system time against the HW clock time. It does this continuously at 5 second intervals allowing it to compute the PPM drift between the two clocks.\n\n***\n\nOops didn't realize ntpdate requires query of remote servers. ntpdate is obsolete anyhow but the newer clockdiff still talks to online servers instead of comapring local values. hwclock can give us that:\n\nhttps://stackoverflow.com/a/40656375\n\nhwclock --compare\n\nwill do what you want. This compare the system time against the HW clock time. It does this continuously at 5 second intervals allowing it to compute the PPM drift between the two clocks.\n\n***\n\nWithout a host side package to run qemu-guest agent commands upon changing power events, this becomes an intractable problem. Without immediately shutting off the network such an implementation doesn't deliver the on guarantees claimed and so I think this is dead in the water.\n\nIf there is a theoretical host package it would pass suspend/resume commands to guests in sync with host events. The guest's suspend-pre scripts would take appropriate action of disabling the network.\n\n***\n\nAvailable qemu-ga host commands\n\nhttp://wiki.stoney-cloud.org/wiki/Qemu_Guest_Agent_Integration#Getting_list_of_available_qemu-ga_commands"},{"author":"HulaHoop","date_created":1518452633,"date_modified":1518452664,"content":"With qemu-ga code the hwclock drift detection code becomes redundant. If a suspend event is triggered the GW should assume clocks are out of sync and trigger lockdown."},{"author":"Patrick","date_created":1518472906,"date_modified":1518472906,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n> With qemu-ga code the whole clock drift detection code becomes redundant. If a \n> suspend event is triggered the GW should assume clocks are out of sync and \n> trigger lockdown.\n\nThat would work. I was on wrong path: of course, if the gateway does the\nlockdown the workstation will loose connectivity. No reason for the\nworkstation to enter lockdown mode for the reason of leak prevention.\n\nThe workstation entering lockdown mode is still useful, but more for\nusability reasons as well as more code reuse."},{"author":"HulaHoop","date_created":1518567133,"date_modified":1518567133,"content":"Yes there are less moving parts especially when multiple WSs share a GW. Some way to exempt timesync traffic from the WS would be needed though. \n"},{"author":"HulaHoop","date_created":1519843226,"date_modified":1519860790,"content":"https://www.redhat.com/archives/libvirt-users/2018-February/msg00083.html\n[libvirt-users] QEMU guest-agent safety in hostile VM?\n\nI forgot to use replay all and so most of the correspondence was not public. Forwarded the responses to whonix mail list:\nhttps://www.whonix.org/pipermail/whonix-devel/2018-March/001125.html\n\n***\n\nNow that I discovered qemy-ga is safe to use in untrusted guests I have asked about the supported commands libvirt can pass thru to the guest.\n\nhttps://www.redhat.com/archives/libvirt-users/2018-February/msg00085.html\n[libvirt-users] Libvirt supported qemu-ga commands"},{"author":"HulaHoop","date_created":1519846843,"date_modified":1519846843,"content":"It turns out the QEMU guest agent warning was not relevant to those who use libvirt. With libvirt a safe parser is used. Breakouts can only happen if a process on the host is designed to parse guest input because there is no way to control that otherwise it should be safe for our uses. This potentially simplifies the design in many respects but a host package will still be needed. I will update the task list."},{"author":"HulaHoop","date_created":1519857546,"date_modified":1519857546,"content":"https://wiki.libvirt.org/page/Qemu_guest_agent"},{"author":"HulaHoop","date_created":1519858983,"date_modified":1519858983,"content":"The YAJL parser used in libvirt is tiny, modern (written in2007) and has no CVEs. It is an SAX  type event-driven parser unlike the vulnerable, top-down recursive descent type that was used in QEMU.\n\nhttps://github.com/lloyd/yajl\nhttp://www.craftinginterpreters.com/parsing-expressions.html"},{"author":"HulaHoop","date_created":1519861983,"date_modified":1519873896,"content":"\n\nThe proper and direct way to use virsh to communicate with guest agent:\n\nhttps://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/virtualization_deployment_and_administration_guide/sect-using_the_qemu_guest_virtual_machine_agent_protocol_cli-libvirt_commands\n\n\nTo suspend/resume one can use: (NB. Will confirm it first then give feedback)\n\n\n\n> virsh suspend --mode=agent\n> virsh resume --mode=agent\n\n\n\n\nSome guest relevant docs:\nhttps://access.redhat.com/solutions/732773\n\nService needs to be enabled in guest after install:\n\n\n> systemctl enable qemu-guest-agent\n\n\n***\n\nThe following command can be used to execute any og the API's supported commands:\n\nvirsh qemu-agent-command ${VMNAME} '{\"execute\":\"guest-info\"}'\n\nhttp://wiki.stoney-cloud.org/wiki/Qemu_Guest_Agent_Integration#Getting_list_of_available_qemu-ga_commands\n\n\n***\n\nIn case any Apparmor modification needed. This was a long time ago and was prbably fixed.\nhttps://serverfault.com/questions/672253/how-to-configure-and-use-qemu-guest-agent-in-ubuntu-12-04-my-main-aim-is-to-get\n\n***\n\n@Patrick \n\nPS. qemu-ga can also query/set the clock from the host but this is not a good idea since we want timesync to do its thing?\n"},{"author":"HulaHoop","date_created":1519875252,"date_modified":1519875252,"content":"Actually we don't have to suspend the guest. Execution of any command on the host after resume is enough to create a uniqu event in the qemu-ga's log file.\n\nTh next step is to use a program like monit to trigger custom commands in response to a specified keyword in the log. The second link documents how. The custom commands are obviosuly iptables lockdown and timesync init.\n\nhttps://stackoverflow.com/a/17639196\nhttps://mmonit.com/monit/documentation/monit.html#FILE-CONTENT-TEST\n\nmonit available in Debian:\n\nhttps://packages.debian.org/stretch/monit\n\n***\n\nI will have to summarize all this some place else because the thread has become unmanageable."},{"author":"HulaHoop","date_created":1519924381,"date_modified":1519924381,"content":"\nNB for the record: with qemu-ga a guest can still shut itself off via crafted input to the agent. So besides removing timer access to the guest, there was no other advantage to removing ACPI."}]},"PHID-TASK-mtvo34xfsdmk5zi3rnpz":{"id":"549","title":"use sudo --non-interactive for better error handling","status":"resolved","priority":"Low","author":"Patrick","description":"When using `sudo` in scripts we should add `--non-interactive` for better error handling. It is better to have `sudo` instantly exit non-zero for missing `/etc/sudoers.d` exceptions and have this logged / noticed rather than asking for a user password.\n","comments":[]},"PHID-TASK-dbbws6u5qfwsaxuyfazu":{"id":"548","title":"port whonixcheck check_tor_socks_port_reachability.bsh to using Tor unix domain socket socks file","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_tor_socks_port_reachability.bsh\n\nRequires newer curl with `--unix-socket` from #debian_stretch.\n\nReplace\n\n```\n   $CURL \\\n      --fail \\\n      $CURL_VERBOSE \\\n      --max-time 10 \\\n      --output \"$TEMP_DIR/socks_port_open_file\" \\\n      \"$GATEWAY_IP:$SOCKS_PORT_WHONIXCHECK\" \\\n      &\n```\n\nwith\n\n```\n   $CURL \\\n      --fail \\\n      $CURL_VERBOSE \\\n      --max-time 10 \\\n      --output \"$TEMP_DIR/socks_port_open_file\" \\\n      --unix-socket \"/var/run/tor/socks\" \\\n      \"file//var/run/tor/socks\" \\\n      &\n```","comments":[{"author":"Patrick","date_created":1484733779,"date_modified":1484733779,"content":"https://github.com/Whonix/whonixcheck/commit/0b71a85c66cd2a217a2a776da5ed888e16483dc5"}]},"PHID-TASK-2oqee7ercez3oyngrwzx":{"id":"547","title":"add user documentation for Remote Administration, Keystroke Fingerprinting, Stylometry","status":"open","priority":"Normal","author":"Patrick","description":"We have https://www.whonix.org/wiki/Surfing_Posting_Blogging but that does not not suffice to properly educate users about the following issues.\n\n(For example, users are interested in the task remote administration, and may read the documentation related to that, but not the documentation related to posting, blogging. \n\n* https://www.whonix.org/wiki/Remote_Administration\n** https://www.whonix.org/wiki/SSH\n*** key strengths\n*** ssh encryption / authentication was / is broken?\n\n* https://www.whonix.org/wiki/Keystroke_Fingerprinting\n\n* https://www.whonix.org/wiki/Stylometry\n","comments":[]},"PHID-TASK-eqw5vz3kkb7hsp5qfhyw":{"id":"546","title":"Captive portal minimal authenticator/browser","status":"open","priority":"Normal","author":"HulaHoop","description":"With attacks like this [1] even LAN connections to Captive portals are a big risk.\n\nWorth researching a captive portal authenticator and/or absolute minimal browser to advise users to use for minimizing attack surface.\n\nTAILS research on the topic. [3]\n\n***\n\n\n[1] https://assets.documentcloud.org/documents/3031639/07-Introduction-to-BADDECISION-Redacted.pdf\n\n[2] https://github.com/subgraph/defector/issues/1\n\n[3] https://tails.boum.org/blueprint/detect_captive_portals/","comments":[]},"PHID-TASK-lzj76vvwkmhylsn5rsoh":{"id":"545","title":"apt-get Qubes instructions","status":"resolved","priority":"Normal","author":"Patrick","description":"TODO:\nSearch the wiki for `apt-get`. These instructions should be turned into a template. And that template has to mention, that Qubes users have to do this in a TemplateVM so the newly installed packages persist.\n","comments":[]},"PHID-TASK-2qdfj6rdkmtgn5h3v6ws":{"id":"544","title":"systemd-socket-proxyd instructions template","status":"resolved","priority":"Normal","author":"HulaHoop","description":"When systemd-socket-proxyd is finished I would like to make instructions into a template and replace the more difficult alternative ones for HS guides.\n\nThis ticket is for listing the pages that need this change.","comments":[{"author":"Patrick","date_created":1471981944,"date_modified":1471981944,"content":"Example. On the workstation, create a file `/etc/anon-ws-disable-stacked-tor/50_user.conf`.\n\n```\nsocat TCP-LISTEN:80,fork TCP:$GATEWAY_IP:80 &\n```\n\n-----\n\n`80` should become a wiki template variable.\n\n`$GATEWAY_IP` should be used verbatim as is. That variable is provided by the #anon-ws-disable-stacked-tor `socat-unix-sockets` script."},{"author":"Patrick","date_created":1525807997,"date_modified":1525858482,"content":"We'll no longer use `socat`. Whonix 14 will use `systemd-socket-proxyd`.\n\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/usr/lib/anon-ws-disable-stacked-tor/systemd-unit-files-generator is not yet configureable but easy to add. Will add in time for #Whonix_14. (T796)\n"},{"author":"Patrick","date_created":1525858516,"date_modified":1525858516,"content":"Done. Updated package not uploaded yet.\n\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/etc/anon-ws-disable-stacked-tor.d/30_anon-dist.conf"},{"author":"Patrick","date_created":1525858533,"date_modified":1525858533,"content":"Can you make head or tail of https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/etc/anon-ws-disable-stacked-tor.d/30_anon-dist.conf ?"},{"author":"HulaHoop","date_created":1526472273,"date_modified":1526472273,"content":"@Patrick seems self explanatory. How are we doing on RAM use? Is it any more or less efficient than socat after you cut down the number of spawned instances? "},{"author":"HulaHoop","date_created":1526472556,"date_modified":1526472556,"content":"All socat mentions here with 7 results, less if we want the relevant pages only: https://www.whonix.org/w/index.php?title=Special%3ASearch&profile=default&fulltext=Search&search=socat"},{"author":"Patrick","date_created":1526484894,"date_modified":1526484894,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n> seems self explanatory.\n\nGreat!\n\n> How \n> are we doing on RAM use? Is it any more or less efficient than socat after you \n> cut down the number of spawned instances?\n\nAnswered here:\nT623#16074"},{"author":"HulaHoop","date_created":1534531151,"date_modified":1534531151,"content":"Template created: https://www.whonix.org/wiki/Template:Systemd-socket-proxyd\n\nNow I want to figure out what pages need it."},{"author":"HulaHoop","date_created":1549075735,"date_modified":1549075735,"content":"@Patrick Was this only relevant for Retroshare?"},{"author":"Patrick","date_created":1549096524,"date_modified":1549096524,"content":"Not only relevant for retroshare.\n\nThis could be useful for any future applications that expect Tor or ControlPort to listen on any specific port or unix domain socket file that is not (yet) added to #anon-ws-disable-stacked-tor config by default.\n\nOr for any other `port or unix domain socket file)` redirections from the workstation to the gateway.\n\n[I2P integration](https://forums.whonix.org/t/i2p-integration/4981) ships as #anon-ws-disable-stacked-tor config snippet if I remember right."},{"author":"HulaHoop","date_created":1549137390,"date_modified":1549137390,"content":"I created a user documentation page explaining this feature and when to use it for users to understand. \n\nhttps://www.whonix.org/wiki/Systemd-socket-proxyd"}]},"PHID-TASK-rtniwyl47csulx7w7ex4":{"id":"543","title":"TCP ISNs and Temperature induced clock skews","status":"open","priority":"Normal","author":"HulaHoop","description":"Attack summary:\n\nQoS acts as a countermeasure by preventing flows on an anonymity-network node from interfering with each other. However, an inevitable result is that when a flow is running at less than its reserved capacity, CPU load on the node will be reduced. This induces a temperature decrease, which affects the frequency of the crystal oscillator driving the system clock. This effect can be measured remotely by requesting timestamps and deriving clock skew. This vector is not low hanging fruit [2] but it would be good to shut down for those who need higher assurance.\n\n(The NFQUEUE-based fix for the latency is great beause this was a more practical real world attack)\n\nTCP ISNs are not possible to block and needed for security anyway. Are a part of all modern OSs.\n\n\nThe only practical solution listed in the paper/slides [1]\n\n\n\n> 23C3 Slide 30:\n> \n> Run CPU at full load - Inefficient and must be done with care since different types of tasks can have varying temperature effects \n\n\n\n\nDeployment: on host out of reach of malicious code in vm. \n\n\n***\n\nConsiderations:\n\nCan disabling c-states accomplish the same?\n\nYes.\n\n\n\n> Ethan:\n> \n> However, the suggestion of disabling c-states more or less obsolesces this suggestion, as the `stress` solution could easily decrease battery life by 2-3x, whereas I've never seen wattage even double from disabling c-states.\n\n\n\n\n***\n\n[1] https://events.ccc.de/congress/2006/Fahrplan/attachments/1211-23c3hotornotpres.pdf\n\n[2]\n\n> Another option with Linux is to use TCP sequence numbers, which are the sum of a cryptographic result and a 1 MHz clock. Over short periods, the high h gives good results, but as the cryptographic function is re-keyed every 5 minutes, maintaining long term clock skew figures is non-trivial.\n\n----\n\n* [An analysis of TCP secure SN generation in Linux and its privacy issues](https://bitguard.wordpress.com/2019/09/03/an-analysis-of-tcp-secure-sn-generation-in-linux-and-its-privacy-issues/)\n* [Tirdad kernel module for random ISN generation](https://github.com/0xsirus/tirdad)\n* Tor Project bug report: [Add research idea for Linux TCP Initial Sequence Numbers may aid correlation ](https://trac.torproject.org/projects/tor/ticket/16659)\n* research paper: [Hot or not: revealing hidden services by their clock skew](https://dl.acm.org/citation.cfm?id=1180410)\n* https://forums.whonix.org/t/tcp-secure-sn-generation-in-linux-and-its-privacy-issues-tirdad-kernel-module-for-random-isn-generation/8552\n","comments":[{"author":"HulaHoop","date_created":1472039626,"date_modified":1472039626,"content":"Rewriting ISNs idea: https://phabricator.whonix.org/T530#10027\n\n> I think that rewriting TCP ISNs is something we definitely want to do.\n\nYes.\n\nShould we reach out to Steven first and see if he can give us code?\n\n\n> I think that rewriting TCP ISNs is something we definitely want to do. The precise formula for this could be debated; but I'd suggest E(t + H(localhost | localport | remotehost | remoteport)), where E is a 32-bit block cipher under a secret key, and H(x) is the first 32 bits of the digest of x using a MAC with a secret key (I'd suggest HMAC-SHA256 or similar). A choice of E is arguable; I'd suggest a balanced Feistel network based on RC2, or RC5 (has the patent on that expired yet?).\n\nIf we don't care about decryption then the RC family is OK however lots of recent cryptanalysis and evidence from Snowden shows how badly broken RC is. Some of it has to do with the overall design of the cipher.\n\n\nThis answer proposes using better ciphers in stream mode:\nhttps://stackoverflow.com/a/1971766"},{"author":"HulaHoop","date_created":1472323723,"date_modified":1472323723,"content":"Collision Attacks Against 64-Bit Block Ciphers:\n\nhttps://www.schneier.com/blog/archives/2016/08/collision_attac.html\nhttps://twitter.com/julianor/status/768431064964558848\n\nThat means goodbye 3DES and BlowFish. Nushu uses 3DES unfortunately."},{"author":"HulaHoop","date_created":1472472226,"date_modified":1472472226,"content":"Asked Steven about Lathra:\n\nhttps://www.whonix.org/pipermail/whonix-devel/2016-August/000719.html"},{"author":"ethanwhite","date_created":1472524553,"date_modified":1472524553,"content":"> Should we reach out to Steven first and see if he can give us code?\n\nWe're not trying to transmit data ourselves, so we probably don't need his code. In fact, we don't even need to try to blend in with normal Linux ISNs. All we need to do is make it impossible for someone who doesn't know the secret key to get timing data from the ISNs.\n\n> If we don't care about decryption then the RC family is OK however lots of recent cryptanalysis and evidence from Snowden shows how badly broken RC is.\n\n> That means goodbye 3DES and BlowFish. Nushu uses 3DES unfortunately.\n\nThe reason I suggested a 32-bit block cipher was simply to use it as a 32-bit secret permutation, in order to prevent repetitions of TCP ISNs (which RFC 6528 suggests are bad). At the end of the day, the block cipher we use doesn't have to be particularly strong; it just needs to make it difficult to see the value of the four microsecond clock that RFC 6528 suggests we use in the ISN generation process. (The RFC also outlines reasons that the 4 microsecond clock is required).\n\nI also read through the other answers on the StackOverflow thread linked above, and one of them suggested a block cipher I'd completely forgotten about, Speck. I don't really trust the key schedule, though, and it uses a 64-bit key anyway (which is way to small), so we'd likely want to swap out the key schedule for a hash function in OFB or CTR mode, and increase the number of rounds."},{"author":"HulaHoop","date_created":1472749176,"date_modified":1472749176,"content":"> We're not trying to transmit data ourselves, so we probably don't need his code. In fact, we don't even need to try to blend in with normal Linux ISNs. All we need to do is make it impossible for someone who doesn't know the secret key to get timing data from the ISNs.\n\nI see. Very well then, makes things easier. \n\n> I also read through the other answers on the StackOverflow thread linked above, and one of them suggested a block cipher I'd completely forgotten about, Speck.  I don't really trust the key schedule, though, and it uses a 64-bit key anyway (which is way to small)\n\nBetter to stick with something else. I'm iffy about anything made by Fort Meade. Although I'm sure with sufficient analysis there could be assurance I don't see much cryptanalysis on Speck.\n\nA similar designed cipher is DJB's Salsa20/ChaCha20. Very fast and recently RFC'd. He's known for making crypto libs that are dead easy to use by software programmers to avoid fudged implementations. I think its a better and safer choice:\n\nhttps://en.wikipedia.org/wiki/Salsa20"},{"author":"ethanwhite","date_created":1473284245,"date_modified":1473284245,"content":"> A similar designed cipher is DJB's Salsa20/ChaCha20. Very fast and recently RFC'd. He's known for making crypto libs that are dead easy to use by software programmers to avoid fudged implementations.\n\nThe reason I'm proposing a block cipher is because, if we want to use the trivial extension I proposed of RFC 6528, we need an encryption mechanism that produces a secret bijection from the set of vectors of 32 bits to the same set, which is something only a 32-bit block cipher can provide. [1] Speck and Simon are the only 32-bit block ciphers available that have had serious cryptanalysis efforts against them.\n\nWith that said, there is another option. I've been working on a construction to use a stream cipher to generate four different 16-bit permutations (adding up to a round 1MB of ram) . We could then use those two permutations in a four-round Feistel network. Although rolling your own cryptography is generally discouraged, in this case it would be relatively safe for two reasons. First off, any attack on the block cipher would have to be spectacular based on the fact that the input is relatively unpredictable, and the volume of ciphertext likely available. Second, my current version of the construction has a reductionist security argument to the security of the stream cipher (if it were possible to distinguish the 16-bit permutations from permutations chosen randomly and uniformly from the set of possible permutations, then it would be possible to leverage that to build a distinguishing attack on the stream cipher). [2]\n\nIf we do want to use this, I can properly write up both the construction and the security proof.\n\n***\n1. Because that's the definition of a 32-bit block cipher: a secret bijection from the set of vectors of 32 bits to the set of vectors of 32 bits, so anything that provided that would be a block cipher.\n2. The reason this isn't used for real-world block ciphers is simply that the memory requirements and key setup time would be somewhat ridiculous for block sizes above 32 bits."},{"author":"HulaHoop","date_created":1473291842,"date_modified":1473291842,"content":"> If we do want to use this, I can properly write up both the construction and the security proof.\n\nYes I think that's the way to go. Can you please use 256 bit keys so we have a post-quantum resistant solution?"},{"author":"ethanwhite","date_created":1474943326,"date_modified":1474943326,"content":"I went ahead and implemented the aforementioned 32-bit block cipher, and the implementation is available [[https://gist.github.com/ethan2-0/4cb36368b233c2a8765d64876fbc7c27|here]]. It's relatively performant, getting about a million encryptions per second; that should be enough, especially given that this is only used when a socket is first opened."},{"author":"HulaHoop","date_created":1474992222,"date_modified":1474992222,"content":"Great stuff :) Thanks Ethan!\n\nTo make sure, this is for generating the ISNs but we still need some way to overwrite the ISN field in packets?"},{"author":"HulaHoop","date_created":1475106726,"date_modified":1475106726,"content":"Dumb question but do the results of this quantum cryptanalysis paper have any effect on using CTR?\n\nhttps://arxiv.org/pdf/1602.05973v3.pdf\n\n\n\n\n> We obtain attacks with very strong implications. First, we show that the most widely used modes of operation for authentication and authenticated encryption (e.g. CBC-MAC, PMAC, GMAC, GCM, and OCB) are completely broken in this security model. Our attacks are also applicable to many CAESAR candidates: CLOC, AEZ, COPA, OTR, POET, OMD, and Minalpher. This is quite surprising compared to the situation with encryption modes: Anand et al. show that standard modes are secure with a quantum-secure PRF.\n\n"},{"author":"HulaHoop","date_created":1475159324,"date_modified":1475159554,"content":"\nSome ideas for tools needed to change tcp headers:\n\nhttps://serverfault.com/questions/318960/easy-way-to-edit-the-traffic-coming-from-a-tcp-host-linux. \n\nnetsed uses scapy. Need to be careful about interfaces its set on because raw sockets bypass iptables.\n\nhttps://packages.debian.org/jessie/netsed\n\nApplication similar to netsed uses python-libnetfilter-queue:\nhttps://github.com/rgerganov/nfqsed\n\n\n\n\n> nfqsed is a command line utility that transparently modifies network traffic using a predefined set of substitution rules. It runs on Linux and uses the netfilter_queue library. It is similar to netsed but it also allows modifying the network traffic passing through an ethernet bridge. This is especially useful in situations where the source MAC address needs to stay unchanged.\n\n\n"},{"author":"HulaHoop","date_created":1475618946,"date_modified":1475618946,"content":"@ethanwhite\n\nI guess I'm trying to figure out if its possible to use the code you wrote to overwrite ISNs without patching the kernel.\n\nI've looked into TCP Option parameters and there doesn't seem to be one that supports altering sequence numbers. If you have any insight on what can be done please let us know."},{"author":"HulaHoop","date_created":1483916976,"date_modified":1483916976,"content":"https://www.whonix.org/pipermail/whonix-devel/2017-January/000827.html"},{"author":"HulaHoop","date_created":1483978078,"date_modified":1484158942,"content":"SipHash: a fast short-input PRF by djb. Already used in a number of networking programs and kernels.\n\nhttps://131002.net/siphash/\nhttps://en.wikipedia.org/wiki/SipHash\nhttps://phoronix.com/scan.php?page=news_item&px=SipHash-PRF-V3-For-Linux\n\n\nPatch series to obsolete MD5/SHA1 across the Linux network stack (including ISNs) already submitted:\n\n\nhttp://lkml.iu.edu/hypermail/linux/kernel/1701.1/00074.html\nhttp://lkml.iu.edu/hypermail/linux/kernel/1701.1/00076.html\n\nhttps://lkml.org/lkml/2016/12/13/596\n\n\nAccepted for 4.11\n\nhttps://news.ycombinator.com/item?id=13361860\n\nOther interesting reading:\n\nhttps://chris-wood.github.io/2016/09/30/TCP-ISN-MD5.html\nhttps://github.com/chris-wood/chris-wood.github.io/blob/master/_posts/2016-9-23-TCP-Sequence-Prediction.md\nhttps://tools.ietf.org/html/rfc6528\n\n***\n\n@Patrick given this news should this ticket be considered done?"},{"author":"HulaHoop","date_created":1484188052,"date_modified":1484188052,"content":"Nope. This problem still exists:\n\nhttps://lists.torproject.org/pipermail/tor-dev/2017-January/011789.html"},{"author":"HulaHoop","date_created":1554490535,"date_modified":1554490535,"content":"\n@Patrick What is the status of integration? Since we have kloak this is also a great defense to have. There is a script on there for packing as a deb:\n\nhttps://github.com/ethan2-0/nfqueue-packet-delay"},{"author":"Patrick","date_created":1554495606,"date_modified":1554495606,"content":">>! In T543#18086, @HulaHoop wrote:\n> \n> @Patrick What is the status of integration?\n\nBuild bug from T530#10723 is unresolved. Waiting for @ethanwhite to fix since I don't know how."},{"author":"HulaHoop","date_created":1570410666,"date_modified":1570410802,"content":"An alternative proposal for editing ISNs without involving the kernel:\n\nWe can use netsed to edit any arbitrary field of the TCP and UDP protocols. The setup will be done on traffic at the outgoing NIC of Whonix Gateway only, where it is relevant for masking visible traffic connected to a user in the open (User -> Guard node). Netsed is in Debian. Alternatively scapy can be used instead if you prefer (also in Debian). [1]\n\n[0] https://packages.debian.org/buster/netsed\n[1] https://stackoverflow.com/questions/10033285/how-to-change-a-packet-data-with-scapy\n\nNetsed preferred because of its compact size and single focus.\n\n***\n\nManual for netsed info and how to edit a packet:\n\nhttp://www.linuxcertif.com/man/1/netsed/\n\n\nFor scapy here is a snippet of code to read seq numbers for sync/ack:\n\nhttps://networkengineering.stackexchange.com/questions/40420/extremely-large-sequence-and-acknowledge-numbers-when-using-scapy\n***\n\nProxying outgoing packets thru netsed. This can be done in a couple of ways. 1) Using iptables for transparent proxying of TCP traffic thru a local port that netsed listens on and does its thing then sends the outgoing packets on their way. 2) Using  libnetfilter_qu in addition to  iptables, is another option to \"...[reinject] altered packets to the kernel nfnetlink_queue subsystem.\" This option gives the most extensibility as it's up to you to code software.\n\nhttps://serverfault.com/questions/318960/easy-way-to-edit-the-traffic-coming-from-a-tcp-host-linux\n\nOpen questions:\n* Will the kernel protest over modified ISNs and start dropping connections?"},{"author":"Patrick","date_created":1573899568,"date_modified":1573899568,"content":"* [An analysis of TCP secure SN generation in Linux and its privacy issues](https://bitguard.wordpress.com/2019/09/03/an-analysis-of-tcp-secure-sn-generation-in-linux-and-its-privacy-issues/)\n* [ Tirdad kernel module for random ISN generation](https://github.com/0xsirus/tirdad)"}]},"PHID-TASK-ap6oepvzftem26jv5m77":{"id":"542","title":"Keyboard/Mouse Fingerprinting Defense","status":"resolved","priority":"Normal","author":"HulaHoop","description":"Attack summary: the timings of and between key presses are unique to each person. They are actively used in the wild to track individuals with extreme accuracy and leads to complete unmasking.\n\n\nThe only choices that seem available is to:\n\n* write a custom keyboard device driver [1] Difficulty very hard. Unlikely to get mainlined.\n\n* abstract the system keyboard input as an (internal) network stream that we can add random latency to before releasing it back to the system. (Idea inspired by [2])\n\nThe second option is best because its display server agnostic, system wide, easier to implement.\n\n***\n\nHow option 2 would work:\n\nNetevent is a program that redirects input events from the host to a specified destination. Naturally we can set the destination as the host too over the loopback interface.  Apply the netfilter_queing rules by @ethanwhite on loopback to introduce random delays. \n\nThis package would run as service on host out of reach of malicious code in VM and to provide system wide protection.\n\n\n***\n\nTesting defense if it actually works:\n\nKeyboard demos:\nhttps://www.behaviosec.com/demos/\nhttps://www.keytrac.net/\n\nMouse demo:\nhttp://jcarlosnorte.com/security/2016/03/06/advanced-tor-browser-fingerprinting.html\n\n***\n\nMouse pointer motion fingerprinting is also another effective attack [4][5]. Luckily netevent also abstracts mouse input events.\n\n***\n\n\n[1] https://github.com/vmonaco/keystroke-obfuscation/issues/1\n[2] https://stackoverflow.com/a/33134735\n[3] https://github.com/Blub/netevent/wiki/Share-devices-over-the-net (GPLv2)\n[4] http://jcarlosnorte.com/security/2016/03/06/advanced-tor-browser-fingerprinting.html\n[5] http://www.cs.wm.edu/~hnw/paper/ccs11.pdf\n\n***\n\nRelated:\n\n* Qubes Feature Request: [Anti-Keystroke Fingerprinting Tool](https://github.com/QubesOS/qubes-issues/issues/1850)\n* try kloak anti keystroke deanonymization tool and leave feedback (done): T583\n* keep an eye on kloak anti keystroke deanonymization tool: T596\n","comments":[{"author":"HulaHoop","date_created":1471577035,"date_modified":1471577035,"content":"Orthogonal to ticket but as the first C package we are likely to ship, we must think about reproducibly building it and redundant ways to validate this."},{"author":"ethanwhite","date_created":1472172330,"date_modified":1472361347,"content":"The first mitigation that comes to mind is to, similarly to T530, queue up all keyboard input events over a period of time (say, 30 milliseconds), and then process them all at once.\n\n> Orthogonal to ticket but as the first C package we are likely to ship, we must think about reproducibly building it and redundant ways to validate this.\n\nAccording to [[https://stackoverflow.com/questions/12230213/how-to-comsume-a-keyboard-event-on-linux-using-input-subsystem|this StackOverflow question]], we should be able to get exclusive access to keyboard events (i.e. the events won't propogate past our handler) using only `ioctl` calls, which can be done in pure Python. Causing those events to be processed is somewhat harder, but one thing to consider is [[https://github.com/python-xlib/python-xlib|the Python X Library]]; if that were the case, we could do this 100% from pure python. One disadvantage to going the X Library route is that we'd need to make 100% sure that this fix is alive 100% of the time the X server is up, and 0% of the time it's not; otherwise, the system would become unresponsive to keyboard events. A possible solution to that would be to use `uinput` instead (Python bindings are available).\n\n**EDIT:** After re-reading the issue description, I realize that netevent is probably the way to go. We could choose two ports on localhost (thus using the loopback interface), and run the same netfilter_queue script, but with a shorter delay (on the order of 15-30ms). If the delay were anything like the 150ms used for external network connections, then the whole system would feel incredibly sluggish."},{"author":"HulaHoop","date_created":1472324186,"date_modified":1472324186,"content":"According to the research:\n\nhttps://github.com/vmonaco/keystroke-obfuscation\n\n\"Identification accuracy is reduced by 20% with a 25 ms random keystroke delay not noticeable to the user.\"\n\nSo I guess that should be the lower bound for this."},{"author":"HulaHoop","date_created":1472757040,"date_modified":1472757040,"content":"Update:\n\nResearcher Vinnie Monaco is creating a sampling distribution library that an obfuscating input driver prototype can use or our netqueue solution.\n\nhttps://github.com/vmonaco/keystroke-obfuscation/issues/1#issuecomment-243433528"},{"author":"Patrick","date_created":1484049587,"date_modified":1484049587,"content":"For reference, kloak is being tracked here:\n\n* try kloak anti keystroke deanonymization tool and leave feedback (done): T583\n* keep an eye on kloak anti keystroke deanonymization tool: T596\n"},{"author":"Patrick","date_created":1597307529,"date_modified":1597307529,"content":"Shipping kloak in Whonix stable for a few releases already.\n\nhttps://www.whonix.org/wiki/Kloak\n\nThat fixes the keyboard part.\n\nFor mouse we documented it as known issue here:\n\nhttps://www.whonix.org/wiki/Keystroke_Deanonymization#Future\n\nFor mouse feel free to open a new ticket in the new issue tracker:\n\nhttps://www.whonix.org/wiki/Reporting_Bugs#Issue_Tracker"}]},"PHID-TASK-lwrdfj2rhkvwgrwpowch":{"id":"541","title":"DRAMA: Exploiting DRAM Addressing for Cross-CPU Attacks ","status":"open","priority":"Normal","author":"HulaHoop","description":"\n\nPaper and Code:\n\nhttps://www.usenix.org/conference/usenixsecurity16/technical-sessions/presentation/pessl\n\nTest PoC: https://github.com/IAIK/drama \n\nSummary:\n\nThis work builds on Rowhammer. An attacker running an unprivileged process in a VM is able to log keystroke events for the entire system. \n\n\n\n> \"In this attack, the spy and the victim can run on separate CPUs and do not share memory, i.e. , no access to shared libraries and no page deduplication between VMs. \" \n> \n\n\n\nMitigation:\n\n\n\n> stress-m2 in parallel (i.e., the attacker’s core is under stress) made any measurements impossible. While no false positive detections occurred, only 9 events were correctly detected. Thus, our attack is susceptible to noise especially if the attacker only gets a fraction of CPU time on its core. \n\n\n\nor\n\nNUMA with non-interleaved memory combined with CPU pinning also described as valid mitigation. Problem is multi NUMA environments exist for server systems only for the most part. Two protection domains not enough for VM based OSs.\n\nThe memory stress solution is too expensive for battery and of questionable effectiveness.\n\nSolution must be on host out of reach of malicious code in vm.\n\n***\n\nConversation with Daniel Gruss (researcher):\n\nhttps://www.whonix.org/pipermail/whonix-devel/2016-August/000707.html\nhttps://www.whonix.org/pipermail/whonix-devel/2016-August/000709.html\nhttps://www.whonix.org/pipermail/whonix-devel/2016-August/000710.html\nhttps://www.whonix.org/pipermail/whonix-devel/2016-August/000711.html\nhttps://www.whonix.org/pipermail/whonix-devel/2016-August/000712.html\nhttps://www.whonix.org/pipermail/whonix-devel/2016-August/000717.html\nhttps://www.whonix.org/pipermail/whonix-devel/2016-August/000722.html","comments":[{"author":"HulaHoop","date_created":1471524149,"date_modified":1471524149,"content":"@ethanwhite \n\nThough this ticket is unrelated to your research it would be great if you can give some insight on the battery life/system strain cost of simulating it.\n\nThe proposed solution:\n\nstress-m2 in parallel on the host."},{"author":"HulaHoop","date_created":1471720983,"date_modified":1471720983,"content":"\nI didn't notice a very important point about this class of attacks and have been mistakenly conflating this definition with side-channel attacks which are more relevant (and deadly) to the Whonix threat model. In summary covert channels require colluding malicious code on both sides of a barrier while the latter [2] doesn't.\n\nWe should separate between local covert channel attacks and network based ones. The network based ones are very dangerous because the artificial signals created on the machine leak in the network traffic which is immediately observable and collected by a network GPA.\n\nWe need to decide how relevant local covert channels are for Whonix. In our threat model we define a host or GW compromise as fatal so this becomes irrelevant. Under what scenarios does this threat become plausible? The only example in mind is an infected anonymous VM receiving private information that can deanonymize a user from another instance of a snooping process running in a clearnet VM. (includes JS code). Is this something we should defend against?\n\n\n\n***\n\n[1] From a paper cited in the DRAMA paper:\n\nhttp://www.cs.wm.edu/~hnw/paper/HyperWhisper.pdf\n\nWhispers in the Hyper-space: High-speed Covert Channel Attacks in the Cloud\n\n6.1.1  Attack Scenario\nCovert channel attacks are distinct from a seemingly similar threat, side channel attacks [22, 24]. Side channels extrapolate information by observing an unknowing sender, while covert channels transfer data between two collaborating parities. As a result, a successful covert\nchannel attack requires an “insider” to function as a datasource. However, this additional requirement does not significantly reduce the usefulness of covert channels in data theft attacks. Data theft attacks are normally launched in two steps, infiltration and exfiltration. In the infiltration step, attackers leverage multiple attack vectors, such as buffer overflow [4], VM image pollution [2, 26], and various social engineering techniques [15, 27], to place “insiders” in the victim and gain partial control over it. And then, in the exfiltration step, the “insiders” try to traffic sensitive in formation from the victim back to the attackers. Because the “insiders” usually would only have very limited control of the victim, their behaviors are subjected to strict security surveillance, e.g., firewall, network intrusion detection, traffic logging, etc. Therefore, covert channels become ideal choices for secret data transmissions under such circumstances.\n\n\n[2] (Cryptographers answers to side-channels are to pay attention to how crypto lib timing info, use crypto hardware acceleration and also CPU pinning."},{"author":"HulaHoop","date_created":1471730159,"date_modified":1471730159,"content":"Re-read the DRAM paper and there are multiple attacks outlined - 1 covert, 1 side-channel. The keystroke sniffing is a side channel so the ticket still valid either way."},{"author":"HulaHoop","date_created":1471973375,"date_modified":1471980345,"content":"Not enough to pin vcpus. Must restrict host from accessing the pCPU assigned to a VM. [1]\n\nIt should be allowed to access the GW cpu too since its part of the TCB.\n\n***\n\n[1] http://redhatstackblog.redhat.com/2015/05/05/cpu-pinning-and-numa-topology-awareness-in-openstack-compute/\n\n\"At this point if we created a guest we would already see some changes in the XML, pinning the guest vCPU(s) to the cores listed in vcpu_pin_set:\n\n<vcpu placement='static' cpuset='2-3,6-7'>1</vcpu>\n\n\nNow that we have set up the guest virtual machine instances so that they will only be allowed to run on cores 2, 3, 6, and, 7 we must also set up the host processes so that they will not run on these cores – restricting themselves instead to cores 0, 1, 4, and 5. To do this we must set the isolcpus kernel argument – adding this requires editing the system’s boot configuration.\n\nOn the Red Hat Enterprise Linux 7 systems used in this example this is done using grubby to edit the configuration:\n\n# grubby --update-kernel=ALL --args=\"isolcpus=2,3,6,7\" \"\n\nhttps://serverfault.com/a/343771 - useful KVM information"},{"author":"HulaHoop","date_created":1472040840,"date_modified":1472041918,"content":"The choices for systems with a single NUMA node are:\n\nDetection:https://dreamsofastone.blogspot.co.at/2015/11/detecting-stealth-mode-cache-attacks.html\n\nUsing extremely resource demanding stress daemon with unreliable results.\n\nAdvise the user to not perform keyboard tasks of different security levels concurrently. At least pause suspicious VMs.\n\nEven if a user opts for a more expensive machine with 2 NUMA nodes that is still a big restriction on multi-VM systems like Qubes which make use of many protection domains.\n\n***\n\nWe may have to deal with it using stress because the side-channel can sniff key-stroke timings."},{"author":"ethanwhite","date_created":1472364206,"date_modified":1472364206,"content":"> The network based ones are very dangerous because the artificial signals created on the machine leak in the network traffic which is immediately observable and collected by a network GPA.\n\n> We need to decide how relevant local covert channels are for Whonix.\n\nI think this is a place to return to the weakest point principle. There are many things an adversary can do if they've achieved local (non-root, but not browser-sandboxed,) code execution; for example, they could sit in a loop uploading screenshots to a server, or helpfully rsync all the user's files to a machine they control.\n\nI'd suggest that covert channels that require local code execution (as before, not root, but not browser-sandboxed) are, at least for the moment, definitely not the weakest point; as outlined above, the adversary could partake in many, much more dangerous, actions if given local code execution.\n\nWith that said, I do think this is something we want to address; the side channel in particular could be devastating.\n\n> Though this ticket is unrelated to your research it would be great if you can give some insight on the battery life/system strain cost of simulating it.\n> stress -m 2 in parallel on the host\n\nIt's almost precisely as bad as `stress --cpu 8`. It divides my battery life in three.\n\n> We may have to deal with it using stress because the side-channel can sniff key-stroke timings.\n\nIsn't this a cache-related attack? If so, in theory, couldn't we just have the hypervisor flush the cache every time it context switches a logical CPU?"},{"author":"HulaHoop","date_created":1472401835,"date_modified":1472401835,"content":"> I'd suggest that covert channels that require local code execution (as before, not root, but not browser-sandboxed) are, at least for the moment, definitely not the weakest point; as outlined above, the adversary could partake in many, much more dangerous, actions if given local code execution.\n\nMakes sense. Thats why exploitation prevention (grsec) is a very important part of defense besides containment after the fact. \n\n> With that said, I do think this is something we want to address; the side channel in particular could be devastating.\n\nYes \n\n> It divides my battery life in three.\n\nThanks for looking at it. Its impractical then.\n\n> Isn't this a cache-related attack? If so, in theory, couldn't we just have the hypervisor flush the cache every time it context switches a logical CPU?\n\nAFAIK (please feel free to correct me) The only thing these attacks depend on is sharing the same DRAM module row buffer instead of a CPU cache. \n\nThe malicious code abuses cache flushing or eviction to access DRAM as much as possible. Reverses physical addressing (automated within seconds) because this info is not readily available in a VM. Causes row conflicts with victim processes allowing it to measure and spy on row access times. \n\nhttps://www.usenix.org/sites/default/files/conference/protected-files/security16_slides_pessl.pdf\n\n***\n\nI am currently contacting the researchers. There is likely some solution that isn't as resource intensive. It combines restricting cache flushing (clflush), blocking timing sources (removing guest timers) and making sure no is hyperthreading/multithreading for guests so they can't use it as an alternative for timers."},{"author":"HulaHoop","date_created":1472506922,"date_modified":1472506922,"content":"Done. Applied all measures in last comment:\n\nhttps://github.com/Whonix/whonix-libvirt/commit/df7d27d77da6f4570de3a7173f624fa0794663ee\nhttps://github.com/Whonix/whonix-libvirt/commit/731b891f4b1486c77990e65e85cf24a3b57dc4b3\nhttps://github.com/Whonix/whonix-libvirt/commit/773a83d14bd6927fcd03344ecba35985766545a6\n\nStripped all external timers avilable for the guest. Only the coarse and inaccurate refined-jiffies inside the guest kernel is available: \n\nhttps://github.com/torvalds/linux/blob/master/kernel/time/jiffies.c\n\nCoarse timers are useless for attackers. They need at least subnanosecond accuracy. \n\nAs per section 3.3 of https://www.usenix.org/system/files/conference/usenixsecurity16/sec16_paper_lipp.pdf\n\nThe only thing remaining is to make sure no true multithreading is available in the guest."},{"author":"HulaHoop","date_created":1472508829,"date_modified":1472508829,"content":"QEMU executes code in single threaded environment:\n\nhttps://archive.is/zgPF3\n\n> QEMU actually uses a hybrid architecture that combines event-driven programming with threads. It makes sense to do this because an event loop cannot take advantage of multiple cores since it only has a single thread of execution. In addition, sometimes it is simpler to write a dedicated thread to offload one specific task rather than integrate it into an event-driven architecture. Nevertheless, the core of QEMU is event-driven and most code executes in that environment.\n\nAFAICT Likely to stay that way long-term. Stick with single vcpu environments:\n\nhttp://www.linux-kvm.org/images/1/17/Kvm-forum-2013-Effective-multithreading-in-QEMU.pdf\n\nTL;DR\n\nMultithreading is not a problem in KVM."}]},"PHID-TASK-afza26nc6ktxqb47v4w4":{"id":"540","title":"Advanced Attacks Meta Ticket","status":"open","priority":"Normal","author":"HulaHoop","description":"This ticket is for tracking covert channel vulnerabilties and progress on solutions. Each item should be discussed in its own ticket only.\n\nMore details:\nhttps://www.whonix.org/wiki/Dev/Advanced_Attacks\nhttps://www.whonix.org/wiki/Advanced_Attacks\n\n\nCPU-induced latency Covert Channel: T530\n\nCross-VM cache attacks countermeasures: T539\n\nDRAMA: Exploiting DRAM Addressing for Cross-CPU Attacks: T541\n\nTCP ISNs and Temperature induced clock skews: T543\n\nKeystroke Dynamics Defense: T542\n\nMouse Fingerprinting: [wiki](https://www.whonix.org/wiki/Keystroke_Deanonymization#mouse)","comments":[]},"PHID-TASK-45rka3nw3i7ifgjxrcyg":{"id":"539","title":"Cross-VM cache attacks countermeasures","status":"open","priority":"Normal","author":"HulaHoop","description":"Makes some covert channel attacks more difficult. Eliminates cross-VM cache attacks on crypto.\n\n\nhttps://www.usenix.org/system/files/conference/usenixsecurity16/sec16_paper_pessl.pdf\n\nQuoted verbatim:\n\n\n\n> \"\n> To attack such configurations, successful and practical\n> attacks must comply with the following requirements:\n> \n> 1.\n> Work across processors:\n> As these configurations\n> are now ubiquitous, an attack that does not work\n> across processors is severely limited and can be triv-\n> ially mitigated by exclusively assigning processors\n> to tenants or via the scheduler.\n> \n> 2.\n> Work without any shared memory:\n> With memory\n> deduplication disabled, shared memory is not avail-\n> able between VMs. All attacks that require shared\n> memory are thus completely mitigated in cross-VM\n> settings with such configurations.\n> In the last years, the most prominent and well-studied\n> example of shared-hardware exploits is cache attacks.\n> They use the processor-integrated cache and were shown\n> to be effective in a multitude of settings, such as cross-\n> VM key-recovery attacks [9, 12, 20, 30], including at-\n> tacks across cores [5, 14, 16, 28]\n> \n> \n> However, due to the cache being local to the processor, these attacks do not\n> work across processors and thus violate requirement 1.\n> Note that in a recent concurrent work, Irazoqui et al.\n> [11] presented a cross-CPU cache attack which exploits\n> cache coherency mechanisms in multi-processor sys-\n> tems.  However, their approach requires shared mem-\n> ory and thus violates requirement 2. The whole class\n> of cache attacks is therefore not applicable in multi-\n> processor systems without any shared memory.\"\n\n\n\n\n***\n\nSummary: Pinning vcpus to physical cpus makes some covert channel attacks more difficult. Eliminates cross-VM cache attacks on crypto. Memory deduplication is (shared memory) is opt in (on Linux at least) and hence this doesn't apply to a default KVM configuration. NB recent versions of Windows starting with 8 enable memory deduplication by default. Worth warning VBox users about.","comments":[{"author":"HulaHoop","date_created":1471492275,"date_modified":1471492275,"content":"KVM CPU pinning. Done. Reduced WS cpu count to 1 core to allow dual core systems to run KVM Whonix. Tested performance is adequate with common tasks including video playback.\n\nhttps://github.com/Whonix/whonix-libvirt/pull/40/commits/1423e91959b0e7bfb9d308fe618f9378bd12796d\n\nhttps://github.com/Whonix/whonix-libvirt/pull/41/commits/c10111fbd68544bda88d9ca858fe85a2b9407e2d\n\nhttps://github.com/Whonix/whonix-libvirt/pull/42/commits/bcae8efa72f853c35f84111ccaa71f8ab5804b10"}]},"PHID-TASK-gch3s35dgic4m25yy4zw":{"id":"538","title":"remove auditd configuration folder parsing /etc/audit/rules.d/ by default workaround","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/usability-misc/blob/master/lib/systemd/system/auditd.service.d/30_usability-misc.conf can be removed in #debian_stretch.\n\nThis is because that feature has been implemented upstream:\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=833474","comments":[{"author":"Patrick","date_created":1484733336,"date_modified":1484733336,"content":"https://github.com/Whonix/usability-misc/commit/5eb707e97bed0987e498d4fda6d8bd3a59594e95"}]},"PHID-TASK-bllfa2xf7nfoaew3cxzt":{"id":"537","title":"monitor what changes /var/lib/tor/lock access rights","status":"resolved","priority":"Low","author":"Patrick","description":"So [/var/lib/tor changed access rights bug](https://forums.whonix.org/t/sys-whonix-cant-connect-to-tor/2584/5) can be debugged.\n\nRequires:\n\n* a `/etc/audit/rules.d/` drop-in config snippet\n* T535\n* #anon-gw-anonymizer-config dependency on `auditd`\n\nRelated:\nT535","comments":[{"author":"Patrick","date_created":1470352305,"date_modified":1470352305,"content":"https://github.com/Whonix/anon-gw-anonymizer-config/commit/17b4b11343b2623b379ff8a83e3e77db410bb8ae"}]},"PHID-TASK-54qu7fhsljttkgdswp4l":{"id":"536","title":"Username Generator Tool","status":"resolved","priority":"Normal","author":"HulaHoop","description":"I've been thinking about some of the ways users can deanonymize themselves when posting on a forum. \n\nBesides password re-use from non-anonymous accounts (which password managers deal with), writing style (Anonymouth is supposed to deal with that - openjdk support in progress), Re-using a non-anonymous username by mistake is a remaining problem.\n\nI found a simple python username generator that has an optional GUI. It combines words from a pre-defined list:\n\nhttps://github.com/korons/username-generator\n\nLicense: GPL2\n\n***\n\nIMHO this is a simple tool really worth packaging for Whonix. ","comments":[{"author":"Patrick","date_created":1470415029,"date_modified":1470415029,"content":"I don't think this tool is ready for prime time.\n\n```\n\t# Verbs and nouns for namegen\n\tverbs =\n['happy','sad','tall','short','malious','ravenous','smooth','loving','mean']\n\tnouns = ['hacker','lumberjack','horse','unicorn','guy','girl']\n\t# Not Safe For Work verbs and nouns to be added in later\n\tverbs_nfsw = []\n\tnouns_nfsw = ['rapist','fuck']\n```\n\nCan you ask on tor-talk please which tools are advisable for this purpose?"},{"author":"HulaHoop","date_created":1470422155,"date_modified":1470422155,"content":"https://lists.torproject.org/pipermail/tor-talk/2016-August/041924.html"},{"author":"HulaHoop","date_created":1470422806,"date_modified":1470422806,"content":"There's a lot of them. Anything specific we are looking for that can slim it down?\n\nhttps://github.com/search?utf8=%E2%9C%93&q=Username+Generator"},{"author":"HulaHoop","date_created":1470424002,"date_modified":1470424002,"content":"\nGood choices:\n\n*https://github.com/EzraBrooks/UsernameGenerator - This looks reasonably simple and its random generation is a good thing. So surveillors are unlikely to flag the output as coming from a Whonix specific tool. Unlicensed\n\n*https://github.com/lordappsec/UsernameGenerator - Well featured perhaps too much. Picks from predefined real name lists. Unlicensed\n\n*https://github.com/MGakowski/Word-Name-Generator/blob/master/Generator.py - Simple random but readable. Licensed.\n\n*https://github.com/AlexShulz/UDG - Can generate random username, email address and password. GUI optional but in non-English language. sqlite dependency Licensed\n\n I limited choices to python only. If you're ok with some other langs let me know.\n\nLack of GUI is not a deal breaker IMHO. If its a simple one-line command it should be usable. We shouldn't worry about password generation as they're out of scope and better done with specialized tools. Licensed is a big thing - means we won't have to chase people who might not be active anymore.\n\n\n\n"},{"author":"Patrick","date_created":1470849622,"date_modified":1470849622,"content":"Is any of these tools popular?\n\nNo such tool already in Debian?\n\n-----\n\nWhat about the list / generator by Tails?\n\nhttps://git-tails.immerda.ch/tails/plain/config/chroot_local-includes/lib/live/config/2010-pidgin\n\nCould could (would have to be) slightly modified to just output a generated user name rather than doing modifying pidgin config. Ideally, Tails would refactor out the username generator script from the pidgin modification script."},{"author":"HulaHoop","date_created":1470941900,"date_modified":1470941900,"content":"> Is any of these tools popular?\n\nNo.\n\n> No such tool already in Debian?\n\nNot exactly. The closest thing I found is meant to be a password generator but it can do good job generating pronounceable usernames.\n\nCons:\n\nThe word length is fixed at eight characters. That's not too bad because a user can just append some characters from the next word. People might be tempted to misuse it for passwords instead though they can do that anyway with any other solution.\n\nhttps://packages.debian.org/jessie/gpw\n\n> What about the list / generator by Tails?\n\nIf its easier for packaging why not? However I don't really like being limited to a predefined list. Makes profiling of users easier - network observer would say \"probably the person behind that username is an anonymous OS user because it comes from this word list\"\n\n***\n\nIf you don't find gpw acceptable then https://github.com/MGakowski/Word-Name-Generator/blob/master/Generator.py is the next best thing. Users can choose the word length."},{"author":"HulaHoop","date_created":1470966515,"date_modified":1470966515,"content":"pwgen is perfect for our purposes.\n\nhttps://lists.torproject.org/pipermail/tor-talk/2016-August/041969.html\n\nPackaged in Debian \n\nReliable enough that its used by Debian Installer to recommend stronger passwords\nCan control length, capitalization, special symbols and numbers."},{"author":"Patrick","date_created":1471041735,"date_modified":1471041735,"content":"https://screenshots.debian.net/screenshots/000/000/598/large.png\n\nSuch strings (from the above screenshot) would be used as user names? Probably better than anything a user could manually make up. And since there is no standard on pseudonymous user names, I don't see anything that speaks against this.\n\nInstalling pwgen by default would be super simple (can be done for Whonix14). Send a pull request for anon-meta-packages? Fits in anon-workstation-packages-recommended."},{"author":"HulaHoop","date_created":1471411818,"date_modified":1471411818,"content":"\n\nhttps://github.com/Whonix/anon-meta-packages/pull/2/commits/9872e7c2cd0198aee4612f902141a915ff74b244\n\nWill add note on blogging wiki page."},{"author":"Patrick","date_created":1471461660,"date_modified":1471461660,"content":"Merged."}]},"PHID-TASK-3xlebr24wneje7hwk7te":{"id":"535","title":"auditd: process configuration folder /etc/audit/rules.d/ by default","status":"resolved","priority":"Low","author":"Patrick","description":"This would be useful so auditd can be used to diagnose some difficult to debug bugs:\n\n* [/var/lib/tor changed access rights bug](https://forums.whonix.org/t/sys-whonix-cant-connect-to-tor/2584/5)\n* [Whonix template: /etc owned by user:user](https://github.com/QubesOS/qubes-issues/issues/1156)\n\nDebian feature request:\n[please use configuration folder /etc/audit/rules.d/ by default](http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=833474)\n\nCan be implemented in form of a systemd drop-in file in the #usability-misc package.","comments":[{"author":"Patrick","date_created":1470351330,"date_modified":1470351330,"content":"https://github.com/Whonix/usability-misc/commit/28204e16a51de662e3ef13141994fd2c2b5aa7f7"},{"author":"Patrick","date_created":1470351998,"date_modified":1470351998,"content":"- https://github.com/Whonix/usability-misc/commit/9c1daa4251eb4de74f8967928bbbddbaba3ac7e6\n- https://github.com/Whonix/usability-misc/commit/6b9ac496a4b3fa4690388804a94092054ad5b145"}]},"PHID-TASK-up2omayxvjzgfdfwaprm":{"id":"534","title":"make sdwdate-gui Qubes friendly (sdwdate-gui-qubes)","status":"open","priority":"Normal","author":"Patrick","description":"#sdwdate-gui currently is effectively unused in #Qubes.\n\n* It is installed by default, can be manually started and works.\n* However cannot be automatically started, since that would be a #usability mess. One systray icon just for sdwdate per VM. So for most users at least two, for gateway and workstation. And and additional one for any additional workstation.\n\nThe only instance of sdwdate-gui in Qubes should run inside Whonix-Gateway. Any Whonix-Workstation that boots should register itself automatically inside Whonix-Gateway's sdwdate-gui. Then notify Whonix-Gateway about its status. And on shutdown, de-register from Whonix-Gateway.\n\nIn case of Whonix-Gateway reboot, it would have to ask all currently connected Whonix-Workstations to re-register and to relay their current status.\n\nWhonix-Gateway and all Whonix-Workstations would result in new sdwdate-gui systray icon sub menus.\n\nIt should be possible to securely implement this communication protocol using Qubes qrexec.","comments":[{"author":"Patrick","date_created":1497287057,"date_modified":1497287057,"content":"We have someone working on this now. Some thoughts on the design...\n\n- sdwdate-gui currently is only for a single VM. It's `old right click menu` looks like that:\n\n```\n-------------------\nOpen sdwdate's log\n-------------------\nRestart sdwdate\nStop sdwdate\nExit\n-------------------\n```\n\nA green, yellow or red systray symbol is shown depending on the state.\n\n- The new implementation for Non-Qubes-Whonix should look the same as currently is in Non-Qubes-Whonix. There probably should be a command line switch for sdwdate-gui's two different modes? Or should there be better two different Non-Qubes-Whonix sdwdate-gui and Qubes-Whonix sdwdate-gui? Whatever makes more sense code maintenance wise. I guess a new tool `/usr/bin/sdwdate-gui-qubes` would make more sense than trying to share code in `/usr/bin/sdwdate-gui`?\n\n- Probably no separate package required. (Package sdwdate-gui-qubes not requried.) Just add to #sdwdate-gui (and modify #sdwdate for qrexec).\n\n- There could be theoretically an \"infinite\" (large) amount of Whonix-Workstations booting up.\n\n- When a Whonix-Workstation boots up, it issues an qrexec call to Whonix-Gateway to register itself so it gets added to Whonix-Gateway's sdwdate-gui systray.\n\n- What if Whonix-Workstation is shut down, killed ungracefully, or crashed? Then it cannot deregister itself. How does Whonix-Gateway's sdwdate-gui systray notice and remove it? Any idea? Should Whonix-Gateway \"ping\" the Whonix-Workstations every X seconds? And if they don't answer, remove them from the menu? What if Whonix-Workstations just hang and come back later? The case has to be covered if a Whonix-Workstation sends a updated sdwdate status which was not previously registered.\n\n- Implement qrexec status notification where? #sdwdate should use qrexec to #sdwdate-gui on sys-whonix? (Skip qrexec calls on Non-Qubes-Whonix and continue to use the current implementation.)\n\n- Whonix-Gateway has its own sdwdate-gui status.\n\n- This explanation is a bit redundant. Since quite hard to say for me in English, I rephrase the same various times.\n- If gateway is in status \"red\" -> use red color.\n- If gateway is in status \"yellow\" -> use yellow color.\n- If any of the workstations is in status \"red\" -> use red color.\n- If any of the workstations is in status \"yellow\" -> use red color.\n- If there are mixed statuses (one workstation green, another one yellow, another one red), use the worst status.\n- Red is the worst status, yellow is better, green is best.\n- Red has always priority over yellow\n- Yellow has always priority over green.\n- Show only green if Whonix-Gateway and all Whonix-Workstations (if any) are green.\n\n- Each entry in sdwdate-gui should show the name of the Whonix-Workstation (`qubesdb-read /name`) and an icon showing its status.\n\n- The right click menu of the new Qubes-Whonix sdwdate-gui. Generic description:\n\n```\n----------------------------------------------------------\nred|yellow|green symbol | sys-whonix\n----------------------------------------------------------\nred|yellow|green symbol | anon-whonix\nred|yellow|green symbol | anon-web\nred|yellow|green symbol | anon-mail\n----------------------------------------------------------\n```\n\n- The right click menu for the new Qubes-Whonix sdwdate-gui. Specific example:\n\n```\n----------------------------------------------------------\ngreen symbol  | sys-whonix\n----------------------------------------------------------\nyellow symbol | anon-whonix\ngreen symbol  | anon-web\nred symbol    | anon-mail\n----------------------------------------------------------\n```\n\n- Once hovering over a menu point such as \"anon-whonix\", open a sub menu showing the same as the `old right click menu`?\n\n- Please keep in mind, that in a later version we might extend the functionality of sdwdate-gui to a Tor controller. Similar to what Vidalia did in past (but much more lightweight, less features). A tool that would also show the state of Tor connectivity. Probably not before Whonix 15 or 16.\n\n- Does that sound like sane usability? Do we have any access to any usability designer?"},{"author":"Patrick","date_created":1499083438,"date_modified":1499083438,"content":"@marmarek is there some `qubesdb-read` to find out from `anon-whonix` that its NetVM is `sys-whonix`?\n\n(Required to qrexec target variable. Trying to cover the case where one is using multiple Whonix-Gateway's.)"},{"author":"marmarek","date_created":1499133572,"date_modified":1499133572,"content":">>! In T534#13990, @Patrick wrote:\n> @marmarek is there some `qubesdb-read` to find out from `anon-whonix` that its NetVM is `sys-whonix`?\n> \n> (Required to qrexec target variable. Trying to cover the case where one is using multiple Whonix-Gateway's.)\n\nCurrently there isn't, but can be easily added, even as a stable update to Qubes 3.2.\nOn the other hand, better would be to control it using qrexec `target=` option - then, Whonix-Workstation do not need to know the name of its Whonix-Gateway (better privacy). And at the same time we get strict policy that Whonix-Workstation can connect only to specific Whonix-Gateway. It would look like this:\n```\ndom0$ cat /etc/qubes-rpc/policy/whonix.sdwdate-gui\nother-whonix  $anyvm allow,target=other-whonix-gw\nanon-whonix $anyvm allow,target=sys-whonix\n# in Qubes 4.0:\n$tag:whonix $anyvm allow,target=sys-whonix\n# or even (works also in Qubes 3.2), but probably bad idea:\n$anyvm $anyvm allow,target=sys-whonix\n```\nA problem with this approach - needs to be manually synchronized when configuring multiple Whonix-Gateways. On the other hand, some policy for this qrexec will be needed anyway.\n"},{"author":"troubadour","date_created":1516104726,"date_modified":1516105388,"content":"Playing with tags.\n\n@marmarek \nAm I correct saying that the default anon-whonix created during installation of Qubes 4.0 contains a tag `anon-vm` (like Whonix templates containing `whonix-updatevm`)? When creating a second Whonix workstation, only the default `created-by-dom0` tag is listed.\n\nFor a single gateway / multiple workstations setup,  have done the following:\n\nAdd tag `gateway` for sys-whonix\nAdd tag  `anon-vm` for newly created workstations.\nAdd policy `/etc/qubes-rpc/policy/whonix.test`\n\n      $tag:anon-vm $anyvm allow,target=sys-whonix\nor\n      $tag:anon-vm $tag:gateway allow\nBoth work.\n\nIn sys-whonix, create a command `/usr/local/etc/qubes-rpc/whonix.test`\n\nThe new command can be run from any anon-vm with\n  qrexec-client-vm sys-whonix whonix.test+\"[argument]\"\n\nIt looks fine, but we still need to manually add a tag for each newly created anon-vm. Would there be a way to automate the process ?"},{"author":"troubadour","date_created":1516487453,"date_modified":1516487453,"content":"Some progress on this one. A summary without literature.\n\nThe new GUI is partially done (no icons for the reasons below).\n\n```\nsys-whonix (or the name found in qubesdb)\n-------------------------------------------------\nanon-whonix-1                                                  \nanon-whonix-2\nanon-whonix-3\n```\nThe anon-vm list is updated in the menu as they start.\n\nsubmenu when hovering on the vm name:\n```\nShow status\n-------------------------------------------------\nOpen sdwdate's log\n-------------------------------------------------\nRestart sdwdate\nStop sdwdate\n```\n`Show status` is implemented, showing the last -partial- message for the corresponding vm in the gui popup.\n\nNo status tooltip, only a general one.\n\nFor now, the qrexec commands are issued from the workstations sdwdate-gui, for practical reasons, the main one being that it's easy to restart sdwdate from there.\n\n Obviously they'll have to be in sdwdate. They are some issues regarding the format of the argument in `qrexec-client-vm sys-whonix whonix.test+\"[argument]\"` when it reaches the target vm. It's sanitized, no problem there, it can be parsed, but it's truncated at 51 bytes, which limits what we can  pass.\n\nTwo possible solutions.\nUse the yaml key instead of the message in its entirety (a big change in sdwdate), or perhaps  use a file argument as per https://www.qubes-os.org/doc/qrexec3/#qubes-rpc-example---with-argument-usage. It would probably require a two-way communication, which anyhow will be  needed at some stage .\n\nOr whatever you might suggest.\n\n\n>>! In T534#13994, @marmarek wrote:\n>>>! In T534#13990, @Patrick wrote:\n>> @marmarek is there some `qubesdb-read` to find out from `anon-whonix` that its NetVM is `sys-whonix`?\n>> \n>> (Required to qrexec target variable. Trying to cover the case where one is using multiple Whonix-Gateway's.)\n> \n> Currently there isn't, but can be easily added, even as a stable update to Qubes 3.2.\n\nThat would help.\n"},{"author":"Patrick","date_created":1516585986,"date_modified":1516585986,"content":"Awesome progress! :)\n\ntroubadour (troubadour):\n>   For now, the qrexec commands are issued from the workstations sdwdate-gui, for practical reasons, the main one being that it's easy to restart sdwdate from there.\n>   \n>   Obviously they'll have to be in sdwdate.\n\nPossibly, yes. Necessarily, maybe not. Keeping all the \"if Qubes then\"\nlogic outside of sdwdate may also be an option. There could be an\nexternal tool sdwdate-message-sender or so (part of package #sdwdate) if\nthat was to help with ease of development, debugging, code cleanness.\nsdwdate-message-sender could inotifywait read the sdwdate status files\nand then translate that to qrexec notifications sent to\nQubes-Whonix-Gateway.\n\nI was also wondering to keep the current sdwdate-gui as is, and then\nautostart it in Non-Qubes-Whonix only. Just to keep that sdwdate-gui\ncode small, simple and for reference. (And to manually start sdwdate-gui\neven in Qubes for debugging purposes.)\n\nThe sdwdate-gui-qubes version could be a separate program (part of\n#sdwdate-gui package still), which only gets auto-started in\nQubes-Whonix-Gateway's. I guess there is not that much code to share\nbetween the both? Just brainstorming. Whatever you think works best.\n\n> They are some issues regarding the format of the argument in `qrexec-client-vm sys-whonix whonix.test+\"[argument]\"` when it reaches the target vm. It's sanitized, no problem there, it can be parsed, but it's truncated at 51 bytes, which limits what we can  pass.\n\nWhy is it truncated? @marmarek\n\nI guess it can be solved somehow? I mean, qrexec can also be used to\ntransfer files of multiple GB or tens of thousands of lines of text\n(Qubes secure copy and paste is based on qrexec).\n\n>   In https://phabricator.whonix.org/T534#13994, @marmarek wrote:\n>   \n>   > In https://phabricator.whonix.org/T534#13990, @Patrick wrote:\n>   >\n>   > > @marmarek is there some `qubesdb-read` to find out from `anon-whonix` that its NetVM is `sys-whonix`?\n>   > >\n>   > > (Required to qrexec target variable. Trying to cover the case where one is using multiple Whonix-Gateway's.)\n>   >\n>   >\n>   > Currently there isn't, but can be easily added, even as a stable update to Qubes 3.2.\n>   \n>   \n>   That would help.\n\nIndeed!\n\n(But without that feature - give that Qubes R3.2 will be deprecated in 1\nyear [my last update], I wouldn't go into gymnastics working around this\nin Whonix then. We'd just wait for Qubes R4 then.)"},{"author":"marmarek","date_created":1516587067,"date_modified":1516587067,"content":"> Obviously they'll have to be in sdwdate. They are some issues regarding the format of the argument in qrexec-client-vm sys-whonix whonix.test+\"[argument]\" when it reaches the target vm. It's sanitized, no problem there, it can be parsed, but it's truncated at 51 bytes, which limits what we can pass.\n\nYou can send the message inside the connection. argument is really useful when you want to setup qrexec policy based on its value (like allow some messages but not others). If you just want to send a message, pipe it to service stdin on one side, and receive from stdout on the other.\n\n> @marmarek is there some qubesdb-read to find out from anon-whonix that its NetVM is sys-whonix?\n> (Required to qrexec target variable. Trying to cover the case where one is using multiple Whonix-Gateway's.)\n\nWorking on it. Right now you can use some placeholder (`$default` in R4.0) and redirect it to appropriate VM in qrexec policy. Downside of this solution - you need to keep qrexec policy in sync with netvm setting manually.\n\nAs for qubesdb - I'm considering `/qubes-netvm` or `/qubes-netvm-name` for that. But I have a problem: we already use various `/qubes-netvm-*` for settings inside of netvm (like what network range should be provided to other VMs). Not for information about VM's uplink. Any better idea for the entry name?"},{"author":"troubadour","date_created":1516657366,"date_modified":1516657566,"content":"troubadour\n>For now, the qrexec commands are issued from the workstations sdwdate-gui, \n>for practical reasons,    the main one being that it's easy to restart sdwdate from there.\n>Obviously they'll have to be in sdwdate.\nPatrick\n>Possibly, yes. Necessarily, maybe not. Keeping all the \"if Qubes then\"\n>logic outside of sdwdate may also be an option. \nThat would help a lot. There are not that many \"if Qubes then\" in sdwdate --  actually we also check if we are not in sys-whonix --, but when it comes to run the qrexec command in sdwdate, the problem begins. Have tried all sort of things to get the `call, Popen` or even `os.system` command working in sdwdate, to no avail, although `call` works in many other places.\n\n>There could be an\n>external tool sdwdate-message-sender or so (part of package sdwdate) if\n>that was to help with ease of development, debugging, code cleanness.\n\nThat's what I was thinking of when starting. The tool would be  a subset of sdwdate-gui.  At the moment I'm using sdwdate-gui \"as is\" plus the qrexec command.\n\nI'll try to describe the current setup (working).\n\n- in anon-whonix external tool: if is_qubes and  is_anon_vm and I have a new sdwdate status --> \"//qrexec sys-whonix `new-status-rpc`(my name)//\"\n- in sys-whonix,  `new-status-rpc` writes the calling vm name to a file:  \"//echo $1 >`new-status-file`//\"\n- in anon-whonix, the script `sdwdate-status-rpc`: \"//cat /var/run/sdwdate/status//\"\n- in sys-whonix, sdwdate-gui watches `new-status-file`. On change --> \"//qrexec vm-name `sdwdate-status-rpc` > status-file//\".  Then //`pickle.load status-file`// and the following logic is common with sys-whonix status_changed.\n\nHope this is clear enough. It's almost easier to write the code than to describe it.\n\nThis way, we leave sdwdate untouched.\n\n \n>The sdwdate-gui-qubes version could be a separate program (part of  \n>sdwdate-gui package still), which only gets auto-started in\n>Qubes-Whonix-Gateway's. I guess there is not that much code to share\n>between the both? Just brainstorming. Whatever you think works best.\n\nYes, the code in sdwdate-gui-qubes has a lot of additions and cannot be adapted to non-qubes environments. So we could have an additional module in the same package. It would be up to you installing the right one."},{"author":"troubadour","date_created":1516657921,"date_modified":1516657921,"content":" >>! In T534#15414, @marmarek wrote:\n\n> As for qubesdb - I'm considering `/qubes-netvm` or `/qubes-netvm-name` for that. But I have a problem: we already use various `/qubes-netvm-*` for settings inside of netvm (like what network range should be provided to other VMs). Not for information about VM's uplink. Any better idea for the entry name?\n\nPerhaps `/qubes-gateway` or `/qubes-gateway-name`. I'm using a tag `gateway` for the policies in dom0. It would be consistent with Whonix."},{"author":"troubadour","date_created":1516836059,"date_modified":1516836059,"content":"Update.\n\nThe submenu commands are implemented. Looks nice and handy.\n\nAs a reminder, the  Whonix-Workstation are registered as they start. In the systray menu, the icon  besides the workstation name is the one from sdwdate status.\n\nNow, we have to update the systray icon to reflect the  worst case in the running workstations. As the icons are passed by path/name, it's not easy to sort, unless we reproduce the icons names in sdwdate-gui. \n\nThe icons path could be in sdwdate-gui (logically they belong there), and the icon level would be passed from sdwdate as a number ( 0 = success, 1  = restricted,  2 = error).\n\nDoes that sound sensible?"},{"author":"Patrick","date_created":1516843928,"date_modified":1516843928,"content":">>! In T534#15420, @troubadour wrote:\n> Update.\n> \n> The submenu commands are implemented. Looks nice and handy.\n\nWow!\n\n> As a reminder, the  Whonix-Workstation are registered as they start. In the systray menu, the icon  besides the workstation name is the one from sdwdate status.\n\nWhat happens if a workstation is killed, and then later restarted? Any other cases where any (delayed) re(starts) corner cases could lead to something strange? Like when the workstation sends sdwdate-gui info to the gateway before the gateway is ready or is that pretty unlikely?\n\n> Now, we have to update the systray icon to reflect the  worst case in the running workstations. As the icons are passed by path/name, it's not easy to sort, unless we reproduce the icons names in sdwdate-gui. \n> \n> The icons path could be in sdwdate-gui (logically they belong there), and the icon level would be passed from sdwdate as a number ( 0 = success, 1  = restricted,  2 = error).\n> \n> Does that sound sensible?\n\nPassing which icon by passing a number through qrexec sounds very reasonable, yes, why not."},{"author":"Patrick","date_created":1516844110,"date_modified":1516844110,"content":">>! In T534#15415, @troubadour wrote:\n> Then //`pickle.load status-file`\n\nCould a compromised workstation use this to execute code on the gateway?"},{"author":"troubadour","date_created":1516983119,"date_modified":1516983119,"content":"//Probably// no. But I,m not an expert in security or attacks.\n\n`pickle load` deserialize an object, in our case a DICTionary. Anything not in that form would raise an exception. Even if a dictionary element contained some code, it would be displayed as such (or raise an exception for the [icon] entry)."},{"author":"marmarek","date_created":1516988950,"date_modified":1516988950,"content":">>! In T534#15424, @troubadour wrote:\n> //Probably// no. But I,m not an expert in security or attacks.\n> \n> `pickle load` deserialize an object, in our case a DICTionary. Anything not in that form would raise an exception. \n\nHow do you ensure that? Normally pickle.load would gladly deserialize any object, even if that results in executing code inside of it. See https://docs.python.org/3/library/pickle.html\nBetter use json or such if really a structure (rather than a single value) is needed.\n"},{"author":"troubadour","date_created":1516996365,"date_modified":1516996591,"content":"> What happens if a workstation is killed, and then later restarted?\n\nThe workstations gracefully notify the gateway when they shut down, thus being de-registered in sdwdate-gui-qubes, and re-registered whenever they restart.\n\nThat is for normal shutdown-reboot-poweroff. If they are crashed/killed, the gateway has no way to know (yet). \n\n> Any other cases where any (delayed) re(starts) corner cases could lead to something strange? Like when the workstation sends sdwdate-gui info to the gateway before the gateway is ready or is that pretty unlikely?\nThat seems very unlikely in a normal start sequence (gateway booting before workstation). Anyhow, the setup being heavily tested during this phase, we'll see if I manage to defeat it. "},{"author":"troubadour","date_created":1516997503,"date_modified":1516997503,"content":">>! In T534#15425, @marmarek wrote:\n>>>! In T534#15424, @troubadour wrote:\n>> //Probably// no. But I,m not an expert in security or attacks.\n>> \n>> `pickle load` deserialize an object, in our case a DICTionary. Anything not in that form would raise an exception. \n> \n> How do you ensure that? Normally pickle.load would gladly deserialize any object, even if that results in executing code inside of it. See https://docs.python.org/3/library/pickle.html\n> Better use json or such if really a structure (rather than a single value) is needed.\n\nThanks for the clarification. I was not sure. Will use json instead."},{"author":"Patrick","date_created":1517236637,"date_modified":1517236637,"content":"Relevant code excerpt #sdwdate.\n\n```\ndef write_status(icon, msg):\n    sdwdate.status['icon'] = icon\n    sdwdate.status['message'] = msg\n\n        with open(sdwdate.status_path, 'w') as f:\n            json.dump(sdwdate.status, f)\n```\n\nRelevant code excerpt #sdwdate-gui.\n\n```\n            with open(self.status_path, 'r') as f:\n                status = json.load(f)\nf.close()\n```\n\n```\n        icon = self.icon[self.icons.index(status['icon'])]\n        self.setIcon(QtGui.QIcon(icon))\n        self.message = status['message'].strip()\n\n        self.setToolTip('%s\\n%s' %(self.title, self.message))\nself.update.update_tip.emit()\n```\n\nAny security concerns about that? @marmarek "},{"author":"marmarek","date_created":1517237087,"date_modified":1517237087,"content":"Json handling looks fine. Not sure about using the data loaded from there - for example if `self.message` require sanitization. AFAIR some Qt widgets support html formatting, so it may be undesirable to allow that.\n\nBTW `f.close()` is unnecessary when using `with` syntax."},{"author":"troubadour","date_created":1517440954,"date_modified":1517440954,"content":"`sdwdate-gui-qubes` will be shortly ready for packaging.\n\nThere are files for the gateway, files for the workstations, none for non-qubes environment. At this stage, for review,  it would be easier to make a standalone package before merging in `sdwdate-gui`.\n\n"},{"author":"troubadour","date_created":1517532444,"date_modified":1517532444,"content":">>! In T534#15444, @troubadour wrote:\n> `sdwdate-gui-qubes` will be shortly ready for packaging.\n> \n> There are files for the gateway, files for the workstations, none for non-qubes environment. At this stage, for review,  it would be easier to make a standalone package before merging in `sdwdate-gui`.\nIt was actually easier to merge directly, if only for the new user sdwdate-gui created in postint.\n\nBut there is an issue I might need some help with. When making the packages (`make deb-icup`), the files in `/etc/qubes/rpc` are not installed. I cannot list all the things I have checked/tried, to no avail. The other files are installed, including `/usr/lib/qubes/notify-shutdown`. Have  been wondering if there could be an issue with qubes folders...\n\nThe package should be complete on github. \nhttps://github.com/troubadoour/sdwdate-gui\n\nAfter installation, it is -probably- required to enable `shutdown-notify` systemd service in whonix-ws.\n\nIn dom0, add tags\n```\nqvm-tags sys-whonix add gateway\n```\nFor each new anon-vm \n```\nqvm-tags vm-name add anon-vm\n```\nIn `/etc/qubes-rpc/policy` add policies\n- `whonix.GatewayCommand` and `whonix.SdwdateStatus`\n```\n$tag:gateway $tag:anon-vm allow\n$anyvm $anyvm deny\n```\n- `whonix.NewStatus`\n```\n$tag:anon-vm $tag:gateway allow\n$anyvm $anyvm deny\n```\n"},{"author":"Patrick","date_created":1517582848,"date_modified":1517582848,"content":"Only small issues for now.\n\n* please grep for `rm /var/run/sdwdate/success` and make that `rm -f /var/run/sdwdate/success` to avoid failing when the file does not exist\n* What if `NAME` set nothing, i.e. `NAME=\"\"`. What would happen?\n\n\n(Somehow phabricator markup broken when writing NAME= in within code tags, weird.)\n\n     NAME $(/usr/bin/qubesdb-read /name)\n     /usr/bin/qrexec-client-vm sys-whonix whonix.NewStatus+$NAME\" shutdown\"\n\nThis could use some defensive code. This may happen if qubesdb-read refuses to reply such as when qubesdb is being upgraded or when it is broken due to a bug. Even if not fixable, the result should not be a crash or so. (Dunno what would happen.)\n\n* `check_output(['qubesdb-read', '/name']).decode().strip()` - this also needs some kind of protection in case qubes-db does not work. You could simulate that case by using:\n\n\n     sudo service qubes-db stop\n\nWhich would then result in:\n\n     qubesdb-read /name\n\n> `Failed connect to local daemon`\n\nBy checking if exit code is non-zero.\n\n* Also in case of a bug `qubesdb-read /name` might return `\"\"`, i.e. nothing."},{"author":"troubadour","date_created":1517696138,"date_modified":1517696138,"content":"Implemented some defensive code against `qubes-db`and `qubes-qrexec-agent` just in case. Now if one or both of those services stop, it just ensures that the sdwdate-gui programs don't crash, and that's it. \n\n\n>    Please keep in mind, that in a later version we might extend the functionality of sdwdate-gui to a Tor controller. Similar to what Vidalia did in past (but much more lightweight, less features). A tool that would also show the state of Tor connectivity. Probably not before Whonix 15 or 16.\n\n\nI do not remember what Vidalia did exactly, never used it much. There was probably some circuit changing and other exotic features.\n\nTo begin with a Tor controller, it looks feasible (with a dedicated submenu under sys-whonix menu entry) to run `anon-connection-wizard` and `restart-tor-gui` from the systray  icon. "},{"author":"Patrick","date_created":1517759336,"date_modified":1517759336,"content":">>! In T534#15447, @troubadour wrote:\n> Implemented some defensive code against `qubes-db`and `qubes-qrexec-agent` just in case. Now if one or both of those services stop, it just ensures that the sdwdate-gui programs don't crash, and that's it. \n\nGreat!\n\n>>    Please keep in mind, that in a later version we might extend the functionality of sdwdate-gui to a Tor controller. Similar to what Vidalia did in past (but much more lightweight, less features). A tool that would also show the state of Tor connectivity. Probably not before Whonix 15 or 16.\n\nSounds awesome!\n\nIf possible: it should only show Tor restart gui / anon-connection-wizard if these are installed. Otherwise not show such a menu entry.\n\nPerhaps mostly external applications that get tied together in sdwdate-gui? Like a plugin structure (without inventing overkill)?\n\n> I do not remember what Vidalia did exactly, never used it much. There was probably some circuit changing and other exotic features.\n\nI still remember it and found some representative Vidalia screenshots.\n\n* main menu - http://i1-win.softpedia-static.com/screenshots/Vidalia-for-Windows_1.png - very old program, probably should not reinvent, probably don't need all of that\n* world map - http://i1-mac.softpedia-static.com/screenshots/Vidalia_2.jpg - we probably don't need to reinvent (all) - we already install https://packages.debian.org/stretch/onioncircuits by default. Perhaps we let users run onioncircuits from `it`?\n* a nice log viewer: https://obrazki.elektroda.pl/7662399900_1336128587.png\n* a bandwith graph - http://tr3.cbsistatic.com/hub/i/r/2013/11/25/ad67be71-1dbe-451a-9e43-be5acf67382a/resize/620x485/6b49afbfe4f9f738cfe5a90145ee471e/vidalia_figure_b.112513.png - not sure if useful\n\nI guess most importantly (and only?) (simple...): \"Does Tor work or not? If not, what's the status? Any advice?\" / \"reconfigure using anon-connection-wizard\". That would be a superb start, I guess.\n\nMore complex stuff such as configuration of hidden services could be done later if ever.\n\n* (How onionshare does it seems the way to go. The user doesn't have to create the hidden service manually. And the remaining instructions like https://www.whonix.org/wiki/Next#onionshare could be automated using qrexec. Similarly it would be good if there was a simple way to setup a hidden web server. The only thing I don't like is that with onionshare's way the hidden service private key ends up inside the workstation.)\n\nWe could use some wider input such as from the tor-talk mailing list (what features would be useful for a Tor controller, Vidalia replacement) as well as from some usability designer.\n\n`it`: Once sdwdate-gui is also a Tor controller, we'd need to rename it? Any generic use case / generic name possible (i.e. not `Whonix` in its name)?\n"},{"author":"troubadour","date_created":1517775024,"date_modified":1517775024,"content":"Have pushed an updated version with `Restart Tor` and `Anon Connection Wizard` commands from the menu, so you can have an idea of the look and feel. This is of  course not written in stone. The standalone `restart-tor-gui` was updated for testing. https://github.com/troubadoour/restart-tor-gui\n\nSo we have a  frame where we could put theoretically anything. There will definitely be a question of usability, but for the time being:\n\n> I guess most importantly (and only?) (simple...): \"Does Tor work or not? If not, what's the status? Any advice?\" / \"reconfigure using anon-connection-wizard\". That would be a superb start, I guess.\n\nYes, the next step should be trying to get a comprehensive tor status with recommendations and perhaps some tor log in case of failure. "},{"author":"troubadour","date_created":1517781740,"date_modified":1517781740,"content":"> If possible: it should only show Tor restart gui / anon-connection-wizard if these are installed. Otherwise not show such a menu entry.\n\nDone. (with a TODO)"},{"author":"troubadour","date_created":1518652553,"date_modified":1518652553,"content":"Some progress here.\n\nThe sdwdate-gui icon is updated according to Tor status. Which, before any other question, leads to the name `sdwdate-gui` vs `??`. It will be a big change in the package, so before going farther, it would be nice to agree on a name. \nI'm not  good on that matter. A bit lazy perhaps, `Anon Controller` would do the job if only because there is GUI with the existing tools in the pipeline. Some other people could have input.\n\n\nA couple of remarks about the current version.\n\nIn sys-whonix, Tor status message GUI is shared with sdwdate message, meaning that when showing Tor status and restarting sdwdate (or it restarts by itself),  the latter will pop (unless Tor is stopped or disabled) . Might be petty, but when used intensively, it can be annoying. I have already a dedicated `show_tor_message` that gets the  status icon too. Wondering  if it's worth implementing the logic for a separate popup. \n\nSecond and more important, the precedence of `Tor not running` vs `Tor disabled` (DisableNetwork 1). When Tor is disabled, we might or we might not have an internet connection. Obviously, after setting Disable in `Anon Connection Wizard`, there is none because we stop Tor too. I guess this issue could be the subject of another (umpteenth) thread.  "},{"author":"troubadour","date_created":1518819519,"date_modified":1518819519,"content":"Added the relevant icon in show_message (after resizing the sdwdate icons from mediawiki, the original are huge)."},{"author":"troubadour","date_created":1520201002,"date_modified":1520201002,"content":"A new Tor controller GUI. \n\nhttps://github.com/troubadoour/tor-control-panel\n\nThe package is standalone, not depending on any other Whonix package, except anon-connection-wizard, which can be checked on loading.\n\nAfter the last update, the package can be run from sdwdate-gui menu. \n\nIt's a tabbed application. Considering the number of options that might end up in there, I believe that it is the best layout. The opening tab is the one really needed by the user, showing Tor status and configuration, plus access to useful commands.\n\nIt's far from being completed. Though it's running, there is most likely some debugging left. \n\nBefore adding more feature and perhaps publishing some screenshots, would be nice to have you point of view. "},{"author":"troubadour","date_created":1530819333,"date_modified":1530820880,"content":"Update, after my post in the forum.\nhttps://forums.whonix.org/t/testers-wanted-blocking-networking-until-sdwdate-finished-status-of-sdwdate-gui/5372/3\n\nWhen putting sdwdate-gui-qubes under stress, I have been chasing a segmentation fault. \nIt was due to a poorly written context menu. Fixed. \n\nCurrently, sdwdate-gui-qubes is being bombarded with sys-whonix and five anon-vm restarting \nsdwdate at a random time interval ranging from 1 to 2 minutes.\n\nIt looks promising. It might be ready for testers shortly."},{"author":"troubadour","date_created":1530995180,"date_modified":1530995180,"content":"Have run the `fuzzer` unit test simultaneously in sys-whonix and five anon-vm.\n\nTHAT is bombarding, but sdwdate-gui-qubes is still alive, after a few runs..."},{"author":"Patrick","date_created":1531811961,"date_modified":1531811961,"content":"What happens in case of multiple Whonix-Gateway ProxyVMs? I.e. in case of `sys-whonix`, `sys-whonix-two`, etc.? How would `anon-whonix-two` know it has to connect to `sys-whonix-two`?\n\n@marmarek [asked](https://github.com/QubesOS/qubes-core-admin/pull/216#issuecomment-405056957):\n\n> I assume those VMs will locate each other some other mechanism, so anon-whonix will know to call to appropriate whonix gateway, even if user create custom one, right?\n\nCan you think of any mechanism suitable for that?"},{"author":"troubadour","date_created":1531862051,"date_modified":1531862051,"content":"For the time being, the vm's whonix gateway is hard coded in two files, the one watching and sending sdwdate satus and the one sending the shutdown notification.\n\nThe easiest way would be to have a new entry for `qubesdb-read`, in addition to `qubes-gateway` which holds the IP address.\nSomething like `qubesdb-read /qubes-gateway-name`."},{"author":"marmarek","date_created":1531865547,"date_modified":1531865547,"content":">>! In T534#16397, @troubadour wrote:\n> The easiest way would be to have a new entry for `qubesdb-read`, in addition to `qubes-gateway` which holds the IP address.\n> Something like `qubesdb-read /qubes-gateway-name`.\n\nI'm ok with that, unless you consider it a privacy issue."},{"author":"Patrick","date_created":1532165915,"date_modified":1581491971,"content":"Created [way to find out name of gateway from witin VM - qubesdb-read /qubes-gateway-name](https://github.com/QubesOS/qubes-issues/issues/4117) for it."}]},"PHID-TASK-hvcz54zthvrpxrt43cqf":{"id":"533","title":"iptables block network access until sdwdate succeeded","status":"open","priority":"Normal","author":"Patrick","description":"Iptables block network access until #sdwdate succeeded. Reasons:\n\n* cover cases where sdwdate is slow or failing\n* catch race conditions where sdwdate is slower than a user starting a client program, server or daemon that already issued network traffic and leaked the time\n\nPreviously this was implemented in form of the #timesync progress bar. But such a progress bar was bad for various reasons:\n\n* not enforced, easily ignored\n* does not stop automatically starting applications and/or the user from using the network\n* a popup which is bad for usability\n* two or more [when using multiple Whonix-Workstation's] on the same desktop when using Qubes [due to its nature of using seamless mode]\n\nA follow up task of T300.\n\nImplementation:\n\n* after boot #whonix-gw-firewall / #whonix-ws-firewall should block the network for everything but Tor and #sdwdate\n** should create a `/var/run/whonix_firewall/first_run_current_boot.status` file\n** when Whonix firewall gets restarted and `/var/run/whonix_firewall/first_run_current_boot.status` already exists, it should unblock the network and create a status file `/var/run/whonix_firewall/consecutive_run.status`.\n* after the first time synchronization succeeded, sdwdate should issue unlocking the network\n** sdwdate already creates a status file `/var/run/sdwdate/first_success`, then\n** reload whonix_firewall\n* enabled by default\n* configuration options to disable all of this\n* all of this should safeguard allowing the user to allow network access even if one day a case is met where sdwdate is permanently failing\n* #sdwdate-gui should shows that status of network time synchronization\n\n-----\n\nTesting:\n```\nsudo rm /var/run/sdwdate/* && sudo service sdwdate restart && sudo service tor restart && whonixcheck_tor_bootstrap_wait_max=10 whonixcheck --gui --cli\n```\n\n----\n\n#TODO:\n\nBetter notification than sdwdate-gui if network access is limited or full.","comments":[{"author":"HulaHoop","date_created":1471977482,"date_modified":1471977482,"content":"I like the idea but how do you plan to tackle the case when a user resumes a guest from sleep?\n\nA clock jump detection script that looks at hwclock maybe?"},{"author":"Patrick","date_created":1471979732,"date_modified":1471979732,"content":"Thank you for participating in this one! I can really use some input here.\n\n>>! In T533#10081, @HulaHoop wrote:\n> I like the idea but how do you plan to tackle the case when a user resumes a guest from sleep?\n\nIt's a good question. Please create a separate ticket for that since this is is very hard already. (At least looks like atm.)\n\n> A clock jump detection script that looks at hwclock maybe?\n\nRestarting sdwdate is done for Qubes-Whonix. References:\n\n- https://github.com/Whonix/sdwdate/blob/master/etc/qubes/suspend-pre.d/30_sdwdate.sh\n- https://github.com/Whonix/sdwdate/blob/master/etc/qubes/suspend-post.d/30_sdwdate.sh\n- https://github.com/QubesOS/qubes-issues/issues/1779\n\nI am not sure we have a ticket for Non-Qubes-Whonix clock jump detection. Probably not. We discussed this in T381 and T385. Non-Qubes-Whonix sdwdate restart on suspend / clock jump detection would be useful independently from this ticket also.\n\n-----\n\nDesigning the overall interaction of this is not simple. Working at that atm. I was considering to introduce two new concepts:\n\n* Whonix firewall in restricted mode\n** the mode after booting Whonix\n** where only sdwdate and whonixcheck [local-only] Tor bootstrap test are allowed\n** hidden services blocked\n** any other client applications blocked, including apt-get\n\n* Whonix firewall in full mode\n** the mode on Whonix firewall restart (?)\n** the mode on sdwdate restart (?)\n** where all torified connections are allowed as usual\n** like in Whonix 13\n\nAny suggestions on the concept names and concepts?\n\nI am wondering on how to integrate this with whonixcheck Tor bootstrap test. (i.e. the passive popups \"Connecting to Tor...\", \"Connected to Tor.\")\n\n* keeping sdwdate unspecific to Whonix and Whonix firewall\n* sdwdate-gui vs whonixcheck Tor bootstrap test\n* keeping it simple for the user\n\nI guess in Whonix 14 whonixcheck, user notification \"Connecting to Tor...\" should technically mean \"Tor bootstrap not finished yet, in progress AND sdwdate in progress\".... As well as user notification \"Connected to Tor.\" should technically mean \"Tor bootstrap succeeded AND sdwdate time synchronization succeeded\"...?\n\nFor Non-Qubes-Whonix it is a bit simpler, since we have separate passive popups for gateway in workstation in two separate contained VM windows.\n\nFor Qubes-Whonix it looks weird to have the gateway passive popup say \"Connected to Tor.\" while the workstation sdwdate synchronization may not be done yet, therefore workstation networking may still be locked. And in case sdwdate fails on the workstation, network locked \"forever\" without manual user interaction. sdwdate-gui for Qubes, i.e.  T534 would solve this, but that is a python gui task, I am not sure I can finish for Whonix 14.\n"},{"author":"Patrick","date_created":1472068320,"date_modified":1472068320,"content":"WIP\n\n- https://github.com/Whonix/whonix-gw-firewall/commit/d88073538fa9e5dd14ac46cb7335151ccd3d3a7c\n- https://github.com/Whonix/whonix-gw-firewall/commit/e9eaeb71bc85115ebba2121d550f0ddf4c8b4201\n- https://github.com/Whonix/whonix-gw-firewall/commit/2fc16d8ac336f77df65e9eb9e5a26730f687c349\n\n- https://github.com/Whonix/whonixcheck/commit/1bc4ba9674af5df773faf296bf6ded536f8d0e33\n"},{"author":"Patrick","date_created":1472098311,"date_modified":1472098311,"content":"WIP\n\n- https://github.com/Whonix/whonix-gw-firewall/commit/7ada53980cc74d260ecfb980714fcf93bc46cd70\n- https://github.com/Whonix/whonix-gw-firewall/commit/52d91011594ee3842292cee3c2dc8202277e53af\n\n- https://github.com/Whonix/whonixcheck/commit/1bc4ba9674af5df773faf296bf6ded536f8d0e33\n- https://github.com/Whonix/whonixcheck/commit/cdb5408d941fee0bea03aa2b5e2ea5b3236a542b\n- https://github.com/Whonix/whonixcheck/commit/49c84b3b43078593a6e32959ccef1230d08a0920\n- https://github.com/Whonix/whonixcheck/commit/2c95286b1b35c287038f470671a816d92fe4c453\n- https://github.com/Whonix/whonixcheck/commit/0fcc4947ef9d32850f750ab85c69b20ec50ce585\n- https://github.com/Whonix/whonixcheck/commit/b04205463492e9da67a851a085597154d7d871fb\n\n- https://github.com/Whonix/msgcollector/commit/64add9551b6f823308a89a23afce603f824f38fd\n\n- https://github.com/Whonix/qubes-whonix/commit/1c793c84f119a080dd79b0d956fad4bb864d4efa"},{"author":"Patrick","date_created":1472244943,"date_modified":1472244943,"content":"WIP\n\n- https://github.com/Whonix/sdwdate-gui/commit/9aeeb919caf2a8a9a53385e751f1ab81219db39d\n\n- https://github.com/Whonix/sdwdate/commit/043c86624a7860989ad5c6ec97b99e4d7aca735f\n- https://github.com/Whonix/sdwdate/commit/9ed587055361ed846c5e7dd5734bb705b91906ea\n\n- https://github.com/Whonix/whonix-gw-firewall/commit/b9e7794931be0186825da7ea94717bfec88b6bc4\n- https://github.com/Whonix/whonix-gw-firewall/commit/6efdd73fe45f4cba98ca150d375409bc0a2adad2\n- https://github.com/Whonix/whonix-gw-firewall/commit/29e282fdb7c7ba1d8a9795c18793b0c198685979\n- https://github.com/Whonix/whonix-gw-firewall/commit/057a01519c361561dad20e4c44f076cf1d18e702\n"},{"author":"Patrick","date_created":1472245336,"date_modified":1472245336,"content":"WIP\n\n- https://github.com/Whonix/msgcollector/commit/a9c2c1219b70a69128c96b4f94c82099ab9db5aa\n- https://github.com/Whonix/msgcollector/commit/bdd05e4d2161e637df99c245c9d03f6ba26d8e4b\n\n- https://github.com/Whonix/whonixcheck/commit/44f777e24982c337ec64dcaede9a60d59a047053\n- https://github.com/Whonix/whonixcheck/commit/18f694d14bb03adafc305822c4ad40a12c31fac7\n- https://github.com/Whonix/whonixcheck/commit/143b26bf5cf112486ab276393eb28c634aab5e18\n"},{"author":"HulaHoop","date_created":1472322706,"date_modified":1472322706,"content":"> clock jump detection would be useful independently from this ticket also.\n\nOK. I'll look around to see if this is already implemented in some package we can reuse. If not I'll try finding more about the best way to do this.\n\n> Any suggestions on the concept names and concepts?\n\nI was thinking we can call them\n\nwhonix firewall: timesync fail closed mode & fail open mode - its more specific than restricted and full which can imply many other things. I like the concepts and how they work.\n\nI think its best to display simplified progress dialogs like \"Tor is connecting\" is preferable to \"Tor is bootstrapping\". However we should still keep the sdwdate dialogs separate from Tor ones to not confuse a user when reporting a bug - mistaking sdwdate sync failure for a Tor one. I definitely agree with keeping sdwdate unspecific to Whonix and Whonix firewall because it belongs as project in its own right.\n\nIn case sdwdate fails hard we should display how to turn off the connection restrictions in a dialog. This is important where an adversary can somehow root some of the servers on the sdwdate and refuse to allow sync requests to succeed - this can be used to DoS the entire Whonix user base. So we want to make sure that users have an easy way to override this - because they won't be able to connect to search the problem or ask for help."},{"author":"HulaHoop","date_created":1472349373,"date_modified":1472349373,"content":"Instead of monitoring the clock for changes we can assume that an interrupted Tor connection was caused by suspend event that initiates syncing. Is the tearing down of stale circuits when waking up the machine detectable in Tor's log? Can this be checked via a controlport event?"},{"author":"Patrick","date_created":1472507582,"date_modified":1472507582,"content":"```\n- separate whonixcheck help message when Tor bootstrap succeeded but timesync failed\n- avoid too technical word \"bootstrap\"\n- output\n- comments\n\nhttps://phabricator.whonix.org/T533\n```\nhttps://github.com/Whonix/whonixcheck/commit/7ab9126eb76e5ee6fc78971d1e96e40cc5265994\n\n-----\n\n>>! In T533#10128, @HulaHoop wrote:\n\n> whonix firewall: timesync fail closed mode & fail open mode - its more specific than restricted and full which can imply many other things. I like the concepts and how they work.\n\nOk.\n\n> I think its best to display simplified progress dialogs like \"Tor is connecting\" is preferable to \"Tor is bootstrapping\". \n\nDoing that already with passive popups. \"Connecting to Tor...\" \"Connected to Tor.\" With above commit I totally removed bootstrapping from any output.\n\n> However we should still keep the sdwdate dialogs separate from Tor ones to not confuse a user when reporting a bug - mistaking sdwdate sync failure for a Tor one.\n\nDone with above commit.\n\n> I definitely agree with keeping sdwdate unspecific to Whonix and Whonix firewall because it belongs as project in its own right.\n\nYes, fortunately I was able to keep it that way.\n\n> In case sdwdate fails hard we should display how to turn off the connection restrictions in a dialog. This is important where an adversary can somehow root some of the servers on the sdwdate and refuse to allow sync requests to succeed - this can be used to DoS the entire Whonix user base. So we want to make sure that users have an easy way to override this - because they won't be able to connect to search the problem or ask for help.\n\nAnother way to phrase is this \"To have all Whonix users give up on Whonix's time related deanonymization protections, we just need to take down enough of its time sources.\" We'll find a better way. Explaining users how to manually set the time.\n\nThe following message is the whonixcheck error active popup message in case initial Tor bootstrap fails after boot. (The markup is not visible, but not handy to create a screenshot.)\n\n```\nERROR: Time Synchronization Result: \nWhonixcheck gave up waiting. \n\nTime synchronization status: pending \nsdwdate reports: Maximum allowed number of failures reached in pool 1 (4 of 14). Giving up.\nIf the problem occurs too frequently, please report it.\n\nSleeping for 10 minutes. \n\nPossible issues: \n- sdwdate will need a few more moments for fetching the time. \n- sdwdate time sources might be dysfunctional. \n\nRecommendations: \n\nA) Rerun whonixcheck: \ndom0 -> Start Menu -> ServiceVM: sys-whonix -> Whonix Check\nor in Terminal: whonixcheck \nor in Terminal with debugging: whonixcheck --debug --verbose --gui --cli \n\nB) Restart sdwdate. \ndom0 -> Start Menu -> ServiceVM: sys-whonix -> sdwdate-gui -> right click on sdwdate-gui systray -> Restart sdwate - instantly adjust the time\nor in Terminal: sudo service sdwdate restart \n\nC) Manually set the time. \n\nAs last resort... \n\n1. Open a terminal. (dom0 -> Start Menu -> ServiceVM: sys-whonix -> Terminal) \n2. Set the clock to the correct time in UTC. (Example.) \nsudo date --set \"Mon Aug 29 21:43:23 UTC 2016\"\n3. Simulate sdwdate success. \nsudo touch /var/run/sdwdate/first_success\n4. Rerun whonixcheck.\n```\n\nStill need to somehow explain, that the time should slightly differ for host/gw/ws."},{"author":"HulaHoop","date_created":1472509127,"date_modified":1472509127,"content":"Maybe instruct them to:\n\n-> \"Set the clock close to but not exactly the correct time in UTC. +/- a minute.\""},{"author":"Patrick","date_created":1472511574,"date_modified":1472511574,"content":"It's a bit more difficult.\n\nRelated:\n\n- (similar instructions) https://www.whonix.org/wiki/Advanced_Security_Guide#Spoof_the_Initial_Virtual_Hardware_Clock_Offset\n- argument to not exclude any values: https://forums.whonix.org/t/bootclockrandomization-always-moving-clock-plus-or-5-seconds\n\nHumans are not good at choosing random values. Speficially I doubt someone would take 0, 1 or 2 or so. With not too high effort, I think this can be made safer and more usable by providing a script for manually setting the clock."},{"author":"HulaHoop","date_created":1472750561,"date_modified":1472750561,"content":"OK. Do you suggest a simple sdwdate input box for them to put their current time in, then it applies the offset range we think is safe before setting the guest time?"},{"author":"Patrick","date_created":1473009508,"date_modified":1473009508,"content":"Yes."},{"author":"Patrick","date_created":1473019804,"date_modified":1473019804,"content":"- `clock-random-manual-cli` - https://github.com/Whonix/bootclockrandomization/commit/93367e59057c45533ceae51559a7bc5a80f87cfc\n- `clock-random-manual-gui` - https://github.com/Whonix/bootclockrandomization/commit/960fac3b8aa4724c46093859fbcc95d555cfb149\n\nAdded to #bootclockrandomization package. Non-ideal, but less overhead (no additional package just for this) and more code can be reused.\n\n- bootclockrandomization uses at boot a +/- 180 second offset.\n- Manual clock randomization (for sdwdate permanent failure cases) where the user (hopefully) enters a reasonable correct clock uses a +/- 30 seconds offset to emulate being closer to #sdwdate accuracy."},{"author":"Patrick","date_created":1473087763,"date_modified":1473087763,"content":"restricted mode -> timesync-fail-closed mode\n\n- https://github.com/Whonix/whonix-gw-firewall/commit/4bf032818748398fdc830fb584346f1f820b51fb\n- https://github.com/Whonix/whonix-ws-firewall/commit/e72928c0eeebe116d48e0cd668e0c633bcd69472\n\nShould we still go for full mode -> timesync-fail-open mode? I think that sounds a bit strange. An alternative to 'full' would be 'normal' or 'regular' or something like that."},{"author":"HulaHoop","date_created":1473264452,"date_modified":1473264452,"content":"Up to you but I still think timesync-fail-open sounds more technically descriptive from a dev POV than using normal/regular. That isn't a problem because regular users should not even know about it."},{"author":"Patrick","date_created":1473434733,"date_modified":1473434733,"content":"- https://github.com/Whonix/whonix-ws-firewall/commit/9a02fb1cc429bc5450a671708d3dff0da2df257c\n- https://github.com/Whonix/whonix-gw-firewall/commit/e55b6213a4d284368a4d3736590f516b712a109e"},{"author":"Patrick","date_created":1473980400,"date_modified":1473980400,"content":"On Whonix-Gateway:\n\nGui applications such as kwrite can currently not be opened in Whonix firewall timesync-fail-closed mode because also localhost connections are blocked.\n\nBut if localhost connections are allowed, then apt-get -> localhost -> Tor -> debian-tor user is allowed to connect anywhere -> connection succeeds. This is a failure, since we are in timesync-fail-closed mode.\n\nAny idea how to elegantly fix this?"},{"author":"marmarek","date_created":1473981410,"date_modified":1473981410,"content":"Network shouldn't be needed for GUI applications as long as DISPLAY\nenvironment variable is correctly set. Make sure it's `:0`, and not\n`localhost:0`."},{"author":"Patrick","date_created":1473982608,"date_modified":1473982608,"content":"Only `kwrite` does not work without localhost access. Strange.\n\n```\necho \"$DISPLAY\"\n```\n```\n:0\n```\n\n```\nIN= OUT=lo SRC=127.0.0.1 DST=127.0.0.1 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=3088 DF PROTO=TCP SPT=52713 DPT=111 WINDOW=43690 RES=0x00 SYN URGP=0\n```\n\nHowever, `leafpad` works. Another reason to move away from KDE.\n\nAre any other issues to be expected without localhost access?"},{"author":"marmarek","date_created":1473982838,"date_modified":1473982838,"content":"I'd expect some more problems, but nothing serious. For example CUPS may\nnot work..."},{"author":"Patrick","date_created":1481906920,"date_modified":1481906920,"content":"Blocking outgoing connections to 127.0.0.1 in timesync-fail-closed mode creates massive issues. For example `konsole` starts but then is unresponsive (frozen) due to the blocked localhost tcp packages. ([And since we'll stay with kwrite.](https://github.com/QubesOS/qubes-issues/issues/1781#issuecomment-262842056)) A solution needs to be found.\n\n`temporary workaround for 127.0.0.1 connections issues to unbreak developers repository`:\n\n- https://github.com/Whonix/whonix-gw-firewall/commit/829761e27c8fe058a4389e3af08f6675be22e2db\n- https://github.com/Whonix/whonix-ws-firewall/commit/baea88f6e3bbdba0f0ecda00ecff90265906cc63\n"},{"author":"Patrick","date_created":1482526139,"date_modified":1482526139,"content":"The current workaround (to unbreak Whonix developers repository) allowing full outgoing access to `127.0.0.1` is as bad as not implementing this ticket. (One could run `apt-get update` which results in `uwt apt-get update` connecting to `127.0.0.1`, where Tor would accept it.)\n\nRather than blocking all connections to `127.0.0.1` and therefore breaking `konsole`, `kwrite` among other things we could blacklist all connections to ports included in [`socks_ports_list`](https://github.com/Whonix/whonix-gw-firewall/blob/master/usr/bin/whonix_firewall#L263) (i.e. block connections to all Tor `SocksPort`s).\n\n-----\n\nAnother issue is, that `whonix-gw` / `whonix-ws` TemplateVM's [`qubes-whonix-torified-updates-proxy-check.service`](https://github.com/Whonix/qubes-whonix/blob/master/lib/systemd/system/qubes-whonix-torified-updates-proxy-check.service) fails as long as `sys-whonix` is still in `firewall_mode=timesync-fail-closed` mode. Any idea how to solve that?\n\nThe TemplateVM is up (and runs `qubes-whonix-torified-updates-proxy-check.service`) faster than `sdwdate` succeeded on `sys-whonix` [not accepting traffic yet].\n\nOne rather hacky way might be `qubes-whonix-torified-updates-proxy-check.service` using `qrexec` communicating with `sys-whonix` and to waiting until `sys-whonix` is in `firewall_mode=full mode`.\n\nAlternatively, is there a way to delay TemplateVM start until `sys-whonix` signals \"ready\"?"},{"author":"marmarek","date_created":1482526392,"date_modified":1482526392,"content":"What about retrying qubes-whonix-torified-updates-proxy-check.service on\nconnection failure?"},{"author":"Patrick","date_created":1482532273,"date_modified":1482532273,"content":"That's a good idea."},{"author":"Patrick","date_created":1482535676,"date_modified":1482535676,"content":"- https://github.com/Whonix/whonix-gw-firewall/commit/00823a325d104e04d065fda8ae96992d1f90e184\n- https://github.com/Whonix/whonix-ws-firewall/commit/df5183dcecd62dae9329571c5ab0e57916bd6eb4\n- https://github.com/Whonix/qubes-whonix/commit/1c99edbbce1f375591f2e42aaf679ba7492b4dd8\n"},{"author":"Patrick","date_created":1482605498,"date_modified":1482605498,"content":"First I thought allowing incoming traffic on Whonix-Workstation in timesync-fail-closed mode would be okay, since outgoing traffic would be blocked. On a second thought, it would not be useful if a hidden service was reachable but the backend server could not reply (still blocked in timesync-fail-closed mode). So...\n\nTODO:\n\n* add timesync-fail-closed considerations to ipv4_input_rules / https://github.com/Whonix/whonix-ws-firewall/blob/master/usr/bin/whonix_firewall#L196\n"},{"author":"Patrick","date_created":1482634360,"date_modified":1482634360,"content":"* https://github.com/Whonix/qubes-whonix/commit/d65d3f37c8512dd7dacb5ef680043fa94d591b7c\n\n-----\n\n>>! In T533#11156, @Patrick wrote:\n> * add timesync-fail-closed considerations to ipv4_input_rules / https://github.com/Whonix/whonix-ws-firewall/blob/master/usr/bin/whonix_firewall#L196\n\nDone:\nhttps://github.com/Whonix/whonix-ws-firewall/commit/041eeb4b53e4ddfe559eec7dd4b3fa24025e93c3\n"},{"author":"Patrick","date_created":1487201225,"date_modified":1487201225,"content":"https://github.com/Whonix/whonixcheck/commit/5c8bf9be88f9951d2263b23aa82818935aa3f733"},{"author":"Patrick","date_created":1495812350,"date_modified":1495812350,"content":"Note to self: try to disable and see if konsole and kwrite are still functional in timesync-fail-closed mode.\n\n```\n      ## TODO: temporary - https://phabricator.whonix.org/T533#10288\n      $iptables_cmd -A OUTPUT -m iprange --dst-range \"127.0.0.1\" -j ACCEPT\n```\n\nhttps://github.com/Whonix/whonix-ws-firewall/blob/master/usr/bin/whonix_firewall#L318"},{"author":"Patrick","date_created":1513875335,"date_modified":1513875335,"content":">>! In T533#13328, @Patrick wrote:\n> Note to self: try to disable and see if konsole and kwrite are still functional in timesync-fail-closed mode.\n> \n> ```\n>       ## TODO: temporary - https://phabricator.whonix.org/T533#10288\n>       $iptables_cmd -A OUTPUT -m iprange --dst-range \"127.0.0.1\" -j ACCEPT\n> ```\n> \n> https://github.com/Whonix/whonix-ws-firewall/blob/master/usr/bin/whonix_firewall#L318\n\nDone.\n\nhttps://github.com/Whonix/whonix-ws-firewall/commit/af8dc373e301060de48454ceba7f42dcbd1c5e92\n"},{"author":"Patrick","date_created":1610437914,"date_modified":1610437914,"content":"I am not sure sdwdate-gui would be a strong enough notification if networking was actually blocked if sdwdate did not succeed yet.\n\nWould have been pretty bad usability in the current situation:\n[Most Onions Down due to a Denial of Service Attack on the Tor Network](https://forums.whonix.org/t/most-onions-down-due-to-a-denial-of-service-attack-on-the-tor-network/10979)"}]},"PHID-TASK-wuko5sbldddth4opim2h":{"id":"532","title":"Control Port Filter Apparmor: Pull Requests Review","status":"resolved","priority":"Normal","author":"HulaHoop","description":"Locked down CPFP  Apparmor profile. Denied script read access to interpreter:\n\nhttps://github.com/Whonix/control-port-filter-python/pull/1/commits/4f1cd35cceec5a8a69cf066e5091a04d32ce6e05\n\nhttps://github.com/Whonix/control-port-filter-python/pull/1\n\nhttps://github.com/Whonix/control-port-filter-python/pull/2","comments":[{"author":"Patrick","date_created":1471220083,"date_modified":1471220083,"content":"Merged."}]},"PHID-TASK-5frcx37dlvd2bvdgroie":{"id":"531","title":"Control Port Filter Hardening: Pull Request Review","status":"resolved","priority":"Normal","author":"HulaHoop","description":"Enabled some systemd security  options for CPFP hardening:\n\n*Syscall whitelist added.\n*/usr /boot and /etc are set read-only.\n*Access to /home /run/user is denied.\n*Turned off all physical device access.\n\nhttps://github.com/Whonix/control-port-filter-python/pull/2/commits/c86b9ed6ffda98b3ca3b1a4235230f8df44b2076","comments":[]},"PHID-TASK-vpnxfisbmiuqsnpcjwue":{"id":"530","title":"CPU-induced latency Covert Channel Countermeasures","status":"invalid","priority":"Normal","author":"HulaHoop","description":"Some very interesting research and practical attacks that build on the \"Hot or Not\" clock skew paper. The researcher (Ethan White) proposes some effective countermeasures for TAILS and Whonix deployment.\n\nThis ticket is for tracking this development.\n\nIMHO this fix should not be optional. We should always deploy safer defaults whenever possible to meet users' expectations that Whonix protects them from advanced attacks.\n\n***\n\nhttps://lists.torproject.org/pipermail/tor-talk/2016-July/041908.html\n\n***\n\nRelated:\nT12","comments":[{"author":"Patrick","date_created":1469973985,"date_modified":1469973985,"content":"I tend towards enabling this by default also. Even if it would require more battery.\n\nIs there a fix already?\n\nDoes the fix require more battery?\n\n[ I strongly prefer a solution that does not require changing kernel parameters. That would be more flexible with respect to custom configurations. And easier to implement for Qubes. Once the fix boils down to \"run these commands\" it can be translated into a systemd service that applies this in early boot before networking. ]\n\nThis is a good subject for a Whonix blog post to get more attention. And if it would require more battery, we would discuss this beforehand in another blog post also."},{"author":"marmarek","date_created":1469976556,"date_modified":1469976556,"content":"In Qubes (or Xen in general), VM cannot disable c-states. This is possible only from dom0. Using this command (at every system startup):\n```\nxenpm set-max-cstate 0\n```\nThere is probably also Xen command line option for this, but as you've pointed out, it's easier to maintain a command running at startup."},{"author":"HulaHoop","date_created":1469981966,"date_modified":1469982142,"content":"No patches posted yet but he plans on submitting them. The fix is well described that it should be possible to work on it. We can discuss our plan with him too.\n\n> Does the fix require more battery?\n\nYes though its much lower compared to using stress.\n\nHow low is difficult to know without benchmarking. It may be negligible enough that we may not even need to discuss it.\n\nThe c-state fix must be done on the host indeed. [1] (makes sense since power management is sensitive and needs privileged CPU access).\n\n\n\n> [ I strongly prefer a solution that does not require changing kernel parameters. That would be more flexible with respect to custom configurations. And easier to implement for Qubes. Once the fix boils down to \"run these commands\" it can be translated into a systemd service that applies this in early boot before networking. ]\n\n\n\n+1\n\nThe second link [3] in [2] mentions an alternative to using the kernel commandline directly. A python script part of \"tuned\" suite [4] can do the same thing. It recommends against using it on its own but its possible. Its not packaged for Debian but its worth making one for it if it gives more flexibility (For Whonix KVM this can be part of the security-misc package):\n\n\n\n> Now in 2011, Red Hatter Jan Vcelak wrote a handy script called pmqos-static.py that can enable this paradigm.  No more dependence on kernel cmdline.  On-demand, toggle C-states to your application’s desire.  Control C-states from your application startup/shutdown scripts.  Use cron to dial up the performance before business hours and dial it down after hours.  Significant power savings can come from this simple script, when compared to using the cmdline.\n\n\n\nNo need to use its performance cron options since it needs to always run to provide protection.\n\n***\n\n[1] https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Virtualization/3.0/html/Administration_Guide/KVM_Clock_Appendix.html\n[2] https://lists.torproject.org/pipermail/tor-talk/2016-July/041813.html\n[3] http://www.breakage.org/2012/11/14/processor-max_cstate-intel_idle-max_cstate-and-devcpu_dma_latency/\n[4] https://git.fedorahosted.org/cgit/tuned.git/tree/libexec/pmqos-static.py?h=1.0\n"},{"author":"Patrick","date_created":1469989680,"date_modified":1469989680,"content":"Is this also useful for general security or only for anonymity?"},{"author":"HulaHoop","date_created":1470001172,"date_modified":1470001172,"content":"> Is this also useful for general security or only for anonymity?\n\nShould be useful even for non-anonymity cases. Image an infected VM without internet still being able to communicate with the outside world."},{"author":"ethanwhite","date_created":1470109719,"date_modified":1470109719,"content":"I figure I should weigh in on this.\n\nFirst off, the Whonix gateway appears to do the right thing in silently dropping any sort of network traffic resulting from anything other than a TCP connection it's initiated. This certainly makes executing the attack more difficult; however, an adversary could, for example, inject data into an already-opened TCP connection (using a trick similar to TCP veto); the adversary could send a packet with an invalid checksum (and a spoofed return address) and look at dupack timings (they can look at the amount of data sent on a Wi-Fi network, even if the content is encrypted with WPA2 or similar).\n\nAnother idea I had for mitigation is to queue up all received packets; then, say, once per second, we go through the queued packets and process them (we wouldn't even send TCP ACKs until we process the packets on the second). This would make gathering enough information to create a useful covert channel infeasible (on the order of thousands of years). However, I believe that this would require kernel hacking, something we probably don't want to do. Just an idea.\n\nI'm still somewhat wary of disabling c-states, due to decreased battery life and increased CPU temperature; the latter is quite scary as it could cause hardware damage. (I've seen CPU temperature climb to 72 Celsius, with `sensors` reporting the high temperature as 80 Celsius; if an ad in your browser decided it needed to run at 100% CPU for a while...)\n\nI would also point out that, to disable c-states in a hypervised environment, we'd need the co-operation of either the hypervisor, or every single guest (I think; correct me if I'm wrong). My understanding is that, in most Whonix configurations, the hypervisor would be beyond Whonix's control; in a lot of configurations (such as Qubes), Whonix likely wouldn't even control the majority of guests (again, correct me if I'm wrong). Is there a way to get around this?"},{"author":"Patrick","date_created":1470110843,"date_modified":1470110843,"content":">>! In T530#9705, @ethanwhite wrote:\n> I figure I should weigh in on this.\n\nGreat! Thanks for signing up!\n\n> First off, the Whonix gateway appears to do the right thing in silently dropping any sort of network traffic resulting from anything other than a TCP connection it's initiated.\n\nYes.\n\n> However, I believe that this would require kernel hacking, something we probably don't want to do. Just an idea.\n\nCertainly outside of my skill set.\n\nCan you make an argument that mentions only security but implicitly also covers anonymity in form of a kernel bug report? I guess a general security issue has more chances as a kernel bug report that get fixed one day than involving anonymity which may be of much less interest.\n\n[[\"similar\" case](https://trac.torproject.org/projects/tor/ticket/16659): \"But again, we're not exactly on strong footing to land a kernel patch here. We'd have better luck making an ISN prediction argument, I bet.\"]\n\n> I'm still somewhat wary of disabling c-states\n\nI see. For now, there are no other options?\n\n> I would also point out that, to disable c-states in a hypervised environment, we'd need the co-operation of either the hypervisor, or every single guest (I think; correct me if I'm wrong). My understanding is that, in most Whonix configurations, the hypervisor would be beyond Whonix's control; in a lot of configurations (such as Qubes), Whonix likely wouldn't even control the majority of guests (again, correct me if I'm wrong). Is there a way to get around this?\n\nIn case of Qubes, cooperation is very likely. (Qubes-Whonix is joint effort of Qubes and Whonix. @marmarek is Qubes' lead developer and already replied above in this ticket.) If we find a sensible solution, it might be applied right on the Qubes host. Perhaps even by default. [Ideally such a solution would not add grave disadvantages such as battery or hardware life decrease.] And if it is not appropriate to enable it by default, perhaps there will be a wizard or switch button or whatever. Let's see what kind of fixes get available before we decide on how we ship them.\n\nIn case of Non-Qubes-Whonix we would recommend the user to apply these changes on the host in documentation and who knows, perhaps someone will maintain one day a whonix-host-additions package or something like that."},{"author":"ethanwhite","date_created":1470193251,"date_modified":1470194086,"content":"> I would also point out that, to disable c-states in a hypervised environment, we'd need the co-operation of either the hypervisor, or every single guest (I think; correct me if I'm wrong). My understanding is that, in most Whonix configurations, the hypervisor would be beyond Whonix's control; in a lot of configurations (such as Qubes), Whonix likely wouldn't even control the majority of guests (again, correct me if I'm wrong). Is there a way to get around this?\n\nAs it turns out, simply passing the params `processor.max_cstate=1` and `idle=poll` to the kernel at boot time are sufficient to prevent this attack, provided one spells them correctly (derp), at least in VirtualBox. Further testing would be required for other hypervisors; however, **it is definitely possible to disable c-states as a guest operating system** (under certain hypervisors), and **this appears to effectively mitigate the covert channel in question**. In light of this, I think that disabling c-states is likely the right way to go."},{"author":"marmarek","date_created":1470208832,"date_modified":1470208832,"content":"I'd expect that PV VM can't control c-states, so on Qubes it will not be\nthat simple, at least in default configuration. But worth a try.\n\nAnyway, if it's possible to do this for selected VMs only, I understand\nit makes sense mostly for Whonix Workstation VMs only.\n\nMy reasoning: \nAssumption 1: attacker have some control over Whonix Workstation\n(like can inject cpu-intensive JS code into a site you visit there).\nAssumption 2: attacker have ability to observe clearnet traffic for\nselected suspects; can also ping them or do any other active network\nmeasurement from outside of the user system\nAssumption 3: attacker can't execute code on all the monitoring users\nmachines\n\nThis means that the attack could be used in one direction only:\ninfluencing latency of clearnet activity by controlling Tor Browser\nactivity (mostly CPU usage). But can't be done the other way around -\ncontrolling CPU usage outside of Whonix Workstation and measuring\nlatency inside - trying one user after another.\n\nI'm not sure about Whonix Gateway (VM where Tor process is running), but I\nguess the attacker don't have reliable control over CPU usage there, so\nattack shouldn't be possible anyway.\n\nIs this correct?"},{"author":"Patrick","date_created":1470233520,"date_modified":1470233520,"content":"If an attacker compromised a Whonix-Workstation, arbitrary traffic can be sent to Tor and I would not wonder if some combination and/or bug can influence its CPU usage. Even if the workstation is not compromised, lets say some fancy browser feature can issue a lot traffic, that would again influence the gateway's Tor CPU usage. Therefore I guess we on the safer side enabling the protections for Whonix-Gateway also.\n\nRelated:\nT12"},{"author":"HulaHoop","date_created":1470235291,"date_modified":1470236192,"content":"@ethanwhite\n\n> it is definitely possible to disable c-states as a guest operating system\n\nGood to know. IMHO even if thats the case its still preferable to place this mitigation outside the untrusted VM so it stays out of reach of the attacker (so they won't be able to disable it). Also a system-wide solution stops cross-VM cover channel leaks.\n\n\n***\n\nI've been looking at virtio-net options that could help on this but I am not sure if any are useful. virtio-net devices are available in all hypervisors which can be useful for a cross platform solution:\n\nhttps://libvirt.org/formatdomain.html#elementsDriverBackendOptions\nhttps://libvirt.org/formatdomain.html#elementsBackendOptions\n\n\n***\n\nI wonder if there are changes that can be made to Tor's own TCP stack to frustrate malformed packets/signals.\n\n***\n\nEDIT:\n\nAnother crazy idea: Running a packet stress tool on the virtual network interface on the gateway. Something like described in the ticket below. This could interfere with signals sent through?\n\nhttps://fedoraproject.org/wiki/Features/MQ_virtio_net#Multiqueue_virtio-net"},{"author":"HulaHoop","date_created":1470241405,"date_modified":1470262072,"content":"\nHere is someone using tc (traffic control) [1] and netem [2] to delay packets in a queue. It can be applied to all traffic [3]\nAnother way to delay packets is using the libnetfilter_queue interface. [4]\n\n\n***\n\n[1] http://linux.die.net/man/8/tc\n[2] https://wiki.linuxfoundation.org/networking/netem\n[3] https://serverfault.com/questions/389290/using-tc-to-delay-packets-to-only-a-single-ip-address\n[4] https://serverfault.com/questions/701228/delaying-packets-with-libnetfilter-queue\n***\n\nEDIT: \n\nAfter looking at the netem documentation I'm pretty sure there is something here we can use."},{"author":"ethanwhite","date_created":1470339311,"date_modified":1470347975,"content":"> After looking at the netem documentation I'm pretty sure there is something here we can use.\n\nI completely agree. I can't see any disadvantages to using this, and it has numerous advantages over all of the mitigations based on disabling c-states or similar.\n\n***\n\nI wrote a simple program to implement this that seems to effectively mitigate this attack [1]. It's written using the Python bindings of libnetfilter_queue.\n\n[1] https://gist.github.com/ethan2-0/2c8505049c991fe0aac3d303dddb6075"},{"author":"HulaHoop","date_created":1470404683,"date_modified":1470404683,"content":"\nHere I found an example of someone using libnetfilter_queue to manipulate ICMP packet timing. Though their goal is different - they embed covert patterns while we are preventing them. [1]\n\nlibipq can specifically isolate the ICMP queue for later processing by userspace programs:[2]\n\n\n\n> # modprobe iptable_filter\n> \n> # modprobe ip_queue\n> \n> # iptables -A OUTPUT -p icmp -j QUEUE\n> \n> will cause any locally generated ICMP packets (e.g. ping output) to be sent to the ip_queue module, which will then attempt to deliver the packets to a userspace application. If no userspace application is waiting, the packets will be dropped \n\n\n \n ***\n \n[1] https://www.anfractuosity.com/projects/timeshifter/\n[2] http://linux.die.net/man/3/libipq\n"},{"author":"HulaHoop","date_created":1470421709,"date_modified":1470421709,"content":"@ethanwhite\n\nCan you please implement the same protections for IPv6/ICMP6 if its not too much work. We plan to roll out the package for Whonix hosts (to end this attack for other VMs besides Whonix) where some users may have no choice but to connect with IPv6 because of their ISP. \n\nIts also a good thing to make this protection future proof for Whonix when Tor starts supporting IPv6 connections too."},{"author":"ethanwhite","date_created":1470454349,"date_modified":1470515597,"content":"> Can you please implement the same protections for IPv6/ICMP6 if its not too much work.\n\nIt's a matter of using `ip6tables` as well as `iptables`; I've added a shell script to configure them both automatically as well, for ease of use. However, none of the machines I have access to seem to have good IPv6 support, so I wasn't able to test it properly.\n\nAs well, it turns out that the `iptables` rules I was using locally on my testing VM were only matching TCP traffic (derp); the ones in the configuration script I added will match all traffic.\n\nI'm not aware of any other issues. Performance seems to be decent as well; although this obviously increases the average latency, it can easily handle 10mbps of traffic.\n\n**EDIT**: After thinking about this some more, I'm realizing it may be a better fit for Tails or even an option in TBB than in Whonix. If a process increases the Whonix guest's CPU usage in the host, then it will decrease the proportion of time the CPU is in a c-state, and an adversary would still be able to perform the attack using another guest or even the host.\n\nAs a result, I think that, unless we're sure that every packet that's processed will at some point end up in this filter (which could be possible if we run the script on the host and use NAT for connectivity in VirtualBox), we probably want to go the c-state route."},{"author":"HulaHoop","date_created":1470528123,"date_modified":1470528123,"content":"> I'm not aware of any other issues. Performance seems to be decent as well; although this obviously increases the average latency, it can easily handle 10mbps of traffic.\n\nExcellent\n\n> EDIT: After thinking about this some more, I'm realizing it may be a better fit for Tails or even an option in TBB than in Whonix. If a process increases the Whonix guest's CPU usage in the host, then it will decrease the proportion of time the CPU is in a c-state, and an adversary would still be able to perform the attack using another guest or even the host.\n\nBecause of Whonix's architecture, any solution will need to be deployed on the host-side too (no way around it). For TAILS its a simpler step because they are the host OS. IMHO the queuing solution is most elegant for the reasons brought up before: it doesn't murder battery life or the hardware.\n\nAs for Tor it would be great if you can convince the TPO devs to add a package that can be installed on Linux hosts at least from their repo. \n\nAs more advanced attacks become easier and more realistic, the protection gap between those running vanilla TBB and those running specialized Torrification systems will widen.\n\n\n***\n\nWe would like your feedback on the TCP ISN attack/mitigation info (or on the covert channel attack in general) on the wiki page. Some of the information on there is wrong because its a complex topic that we didn't understand well at the time.\n\nhttps://www.whonix.org/wiki/Time_Attacks"},{"author":"Patrick","date_created":1470669734,"date_modified":1470669734,"content":">>! In T530#9844, @ethanwhite wrote:\n>> Can you please implement the same protections for IPv6/ICMP6 if its not too much work.\n> \n> It's a matter of using `ip6tables` as well as `iptables`; I've added a shell script to configure them both automatically as well, for ease of use. However, none of the machines I have access to seem to have good IPv6 support, so I wasn't able to test it properly.\n\nYou can upgrade to IPv6 using an 4to6 tunnel broker. Some might provide a free IPv6 address (which gets actually tunneled over your IPv4). I haven't looked into that for a while but in past that worked well.\n\nhttps://en.wikipedia.org/wiki/List_of_IPv6_tunnel_brokers\n\nWould that be an option?\n\n> As a result, I think that, unless we're sure that every packet that's processed will at some point end up in this filter (which could be possible if we run the script on the host and use NAT for connectivity in VirtualBox), we probably want to go the c-state route.\n\nFor Qubes / Qubes-Whonix that may not be a big issue. The solution would simply be applied in Qubes sys-net VM so all packages would be processed. I might create a package that sets up that configuration which gets installed inside Qubes sys-net VM. (Or alternatively we could patch the qubes-core-agent-linux package if @marmarek prefers that way, perhaps also depending on the implementation details.)\n\nFor Non-Qubes-Whonix / Debian, ideally there would be general Debian purpose package indeed that is supposed to be installed on any host. Perhaps a general security argument can be made to convince Debian to apply this fix by default?"},{"author":"ethanwhite","date_created":1470687442,"date_modified":1470687545,"content":"> We would like your feedback on the TCP ISN attack/mitigation info (or on the covert channel attack in general) on the wiki page.\n\nI don't immediately see any errors; however, I'm relatively new to covert channels and the likes, so I could definitely be missing something.\n\n> You can upgrade to IPv6 using an 4to6 tunnel broker.\n\nI don't think this is necessary. `ip6tables` is no less functional than `iptables` (I think; again, I don't have a very good testing setup for IPv6). However, if this does prove to be necessary, it definitely seems like it would work.\n\n> For Qubes / Qubes-Whonix that may not be a big issue. The solution would simply be applied in Qubes sys-net VM so all packages would be processed. I might create a package that sets up that configuration which gets installed inside Qubes sys-net VM. (Or alternatively we could patch the qubes-core-agent-linux package if @marmarek prefers that way, perhaps also depending on the implementation details.)\n\nThat seems like a good idea.\n\n> For Non-Qubes-Whonix / Debian, ideally there would be general Debian purpose package indeed that is supposed to be installed on any host.\n\nMy worry is that this introduces more ways for users to shoot themselves in the foot. If configured improperly, this would provide a false sense of security (more dangerous than no security at all).\n\nAs a case study, I was thought the reason that ICMP traffic wasn't being sent through my `libnetfilter_queue` handler was because I'd configured iptables improperly. However, it was actually as a result of some configuration changes I'd made about a year ago that I'd since forgotten about.\n\n> Perhaps a general security argument can be made to convince Debian to apply this fix by default?\n\nThis seems unlikely; for the mitigation to be effective at all, we need to queue packets up over an interval of 50ms or more; I chose 150ms to be safe. That means that, starting from nothing, an HTTP request would take around 675ms (as low as 600ms or as high as 750ms, depending on when the initial TCP SYN falls)."},{"author":"HulaHoop","date_created":1470694290,"date_modified":1470694430,"content":"@ethanwhite\n\nWould it be correct to say that the fix developed also defends against the earlier attack described by Steven Murdoch? - Therefore closing up this entire class of threats.\n\n***\n\n> However, it was actually as a result of some configuration changes I'd made about a year ago that I'd since forgotten about.\n\nAre there any general caveats that users should look out for in configurations to avoid this? Is it iptables rule ordering or network stack options they should pay attention to?"},{"author":"ethanwhite","date_created":1470845010,"date_modified":1470845010,"content":"> Would it be correct to say that the fix developed also defends against the earlier attack described by Steven Murdoch?\n\nI don't think so. The clock skews Murdoch observed were on the order of 20 milliseconds, much beyond anything the fix in question could hope to mitigate (and besides, Murdoch's attack works on TCP timestamps, which just queueing packets up before they're sent out to the network wouldn't affect).\n\n> Are there any general caveats that users should look out for in configurations to avoid this?\n\nI had a rule to automatically accept all ICMP packets before my rule to send all packets off to my queue. As long as you don't do that, you should be fine.\n\n***\n\nI also changed my fix to randomize the amount of time that packets are queued up across (it's different every iteration). That should make averaging attacks even harder. (Note that my randomness source is currently Python's `SystemRandom`, which is based off of `/dev/urandom`. If that turns out to be a performance issue, then I can change it to a simple userspace CSPRNG, such as a hash function in OFB mode)."},{"author":"Patrick","date_created":1471542221,"date_modified":1471542221,"content":"Could you please post (and license Open Source) your fix to github? @ethanwhite"},{"author":"ethanwhite","date_created":1471569871,"date_modified":1471569871,"content":">>! In T530#9956, @Patrick wrote:\n> Could you please post (and license Open Source) your fix to github? @ethanwhite\n\nMy fix is available [[ https://gist.github.com/ethan2-0/2c8505049c991fe0aac3d303dddb6075 | here ]]. Its license comprises the SQLLite public-domain dedication, as well as the MIT license warranty and liability disclaimer."},{"author":"HulaHoop","date_created":1471582672,"date_modified":1471582672,"content":"@ethanwhite\n\nThanks for researching this and contributing a fix.\n\n***\n\n> Murdoch's attack works on TCP timestamps\n\nI see. We (and Tails too I believe) disable TCP Timestamps. ICMP traffic can be blocked entirely with iptables. The only thing we can't do anything about are TCP ISNs.\n\nI've been trying to figure out how practical TCP ISNs are for an attacker in a real world situation. Here is a vague quote from the paper which I can't understand. In your opinion what do you make of it? Have you discussed it with Steven?\n\n\n\n\n> Another option with Linux is to use TCP sequence numbers, which are the sum of a cryptographic result and a 1 MHz clock. Over short periods, the high h gives good results, but as the cryptographic function is re-keyed every 5 minutes, maintaining long term clock skew figures is non-trivial.\n\n"},{"author":"Patrick","date_created":1471620150,"date_modified":1471620150,"content":"The following is an issue for us. (Since upgrades come outside of apt-get which makes it hard to keep it up to date for users as linux distribution maintainer. Package manager security and whatnot.)\n\n```\npip3 install NetfilterQueue\n```\n\nCould it be replaced with the Debian package [python-nfqueue](https://packages.debian.org/jessie/python-nfqueue)? Is it the same?"},{"author":"ethanwhite","date_created":1471890626,"date_modified":1471890626,"content":"> Could it be replaced with the Debian package python-nfqueue? Is it the same?\n\nThe Debian package you mentioned is actually a completely different library serving the same purpose. I'll probably end up porting my code over to use that (perhaps optionally?), but that'll take [[https://xkcd.com/1070/|a couple]] days (I've found myself suddenly quite busy).\n\n> I've been trying to figure out how practical TCP ISNs are for an attacker in a real world situation.\n\nIf the attacker's goal is to judge clock skew (which can get to be tens of milliseconds), then it's completely practical; they need only average over about a dozen samples. If their goal is to observe 80us delays due to waking up the processor from a c-state, then they could probably pull it off, although they'd need to average over hundreds or even thousands of samples.\n\nFor reference, I believe that Linux generates TCP ISNs as the arithmetic sum of the current time in microseconds and an MD4 hash of some secret data, with the first byte replaced with the current uptime in seconds divided by 300. For almost all purposes, the result of an MD4 hash of secret data can be treated simply as a random number; this is why the averaging method works. Feel free to correct me if I'm wrong."},{"author":"HulaHoop","date_created":1471903220,"date_modified":1471903220,"content":"> If the attacker's goal is to judge clock skew (which can get to be tens of milliseconds), then it's completely practical\n\nI see.\n\nIn a newer presentation Steven hints that ISNs can be rewritten [1]. Going back to the paper [2] from 22C3 he talks about the different ways (and difficulty) of rewriting a packet's ISN field with arbitrary data while not standing out on the network hence the steganographic uses. This gives me an alternative idea to burning up the CPU.\n\nWhat if we rewrite the ISNs to prevent leaking skew information?\n\nThe three different softwares in the paper:\n\n* covert_tcp [3] - primitive, very low throughput - not useful for decent connections, easily detectable practically giving away that a user is running Whonix. Code available.\n\n* Nushu - written by Joanna, goes too far in making the ISN look random while in reality Linux is not that good. stands out. No public code.\n\n* Lathra - the proposed solution by Steven in the paper that supposedly achieves perfect indistinguishability. No known code. Potentially the best solution if we can get the code.\n\n***\n\nPS. @ethanwhite I hope you don't mind that we tagged you in a bunch of tasks that you haven't signed up for. We appreciate what you have done for us. Truth is, we would really like if you stick around and help us with more stuff (if you're interested of course). The benefits go beyond our distro and helps other privacy/security OSs too.\n\n\n\n\n***\n\n[1] http://sec.cs.ucl.ac.uk/users/smurdoch/talks/eurobsdcon07hotornot.pdf - slide 9\n\nTCP sequence numbers\n•\nWorks for Linux, 1 MHz, generated\nfrom system clock, rewriting needs\nstate on firewalls, (more in my\n22C3 talk)\n\n[2] http://sec.cs.ucl.ac.uk/users/smurdoch/papers/ih05coverttcp.pdf\n\n[3] http://firstmonday.org/ojs/index.php/fm/article/view/528/449\n\n\n"},{"author":"ethanwhite","date_created":1472017330,"date_modified":1472017330,"content":"> The Debian package you mentioned is actually a completely different library serving the same purpose. I'll probably end up porting my code over to use that\n\nAs it turns out, that other library chokes whenever the packet handler releases the GIL (which is the only way to get the packet skewing we want). //We can't use the Debian package python-nfqueue.//\n\nThat really leaves us with two options:\n* I could rewrite the handler entirely in C, in which case all we need is Debian's `libnetfilter-queue` package. However, I generally consider writing security-critical code in C to be a bad idea, especially when threads are involved like they are here.\n* I could create a Debian package including both my Python handler that depends on the pip `NetfilterQueue` package, as well as the `NetfilterQueue` package itself. That could then be used in whatever process Whonix regularly uses to include packages at install time.\n\nI could do either.\n\n***\n\n> What if we rewrite the ISNs to prevent leaking skew information?\n\nFirst off, this would likely better be discussed directly on T543, as it's largely unrelated to ping latency covert channels.\n\nI think that rewriting TCP ISNs is something we definitely want to do. The precise formula for this could be debated; but I'd suggest `E(t + H(localhost | localport | remotehost | remoteport))`, where `E` is a 32-bit block cipher under a secret key, and `H(x)` is the first 32 bits of the digest of `x` using a MAC with a secret key (I'd suggest HMAC-SHA256 or similar). A choice of `E` is arguable; I'd suggest a balanced Feistel network based on RC2, or RC5 (has the patent on that expired yet?).\n\nAs for TCP timestamps, I'd suggest just decreasing the resolution to 1Hz (it's currently around 1KHz, at least in Ubuntu), possibly adding a bit of red herring skew that should overpower that from the heat."},{"author":"HulaHoop","date_created":1472039131,"date_modified":1472039131,"content":"> First off, this would likely better be discussed directly on T543, as it's largely unrelated to ping latency covert channels.\n\nYou're right :) I'll answer you there."},{"author":"Patrick","date_created":1472071723,"date_modified":1472071723,"content":">>! In T530#10102, @ethanwhite wrote:\n>> The Debian package you mentioned is actually a completely different library serving the same purpose. I'll probably end up porting my code over to use that\n> \n> As it turns out, that other library chokes whenever the packet handler releases the GIL (which is the only way to get the packet skewing we want). //We can't use the Debian package python-nfqueue.//\n> \n> That really leaves us with two options:\n> * I could rewrite the handler entirely in C, in which case all we need is Debian's `libnetfilter-queue` package. However, I generally consider writing security-critical code in C to be a bad idea, especially when threads are involved like they are here.\n\nI agree, C is best avoided.\n\n> * I could create a Debian package including both my Python handler that depends on the pip `NetfilterQueue` package, as well as the `NetfilterQueue` package itself. That could then be used in whatever process Whonix regularly uses to include packages at install time.\n\nhttps://github.com/kti/python-netfilterqueue is a small project, looks like. Unfortunately not yet in Debian apparently indeed. ([feature request](https://github.com/kti/python-netfilterqueue/issues/15))\n\nSo yes, while not an ideal solution, embedding this code kti/python-netfilterqueue in your package would be a tremendous help!"},{"author":"ethanwhite","date_created":1472839158,"date_modified":1472839158,"content":"I've created some bash scripts to create a Debian package for kti/python-netfilterqueue. They're available in [[https://github.com/ethan2-0/python3-netfilterqueue-packager|this GitHub repository]], and I've uploaded a version of the package created on my Debian Jessie system [[https://www.ethanwhite.xyz/static/python3-netfilterqueue_0.7_amd64.deb|here]]. There are still a few issues I'll be resolving in the coming days, including the lack of a source package, but it's overall completely functional.\n\nI'm thinking that, from an architecture standpoint, we probably want to have one package for kti/python-netfilterqueue, and another one for my NetfilterQueue handler, rather than merge them both into the same package. This would be good if we end up with more than one NetfilterQueue handler (which seems likely; see, for example, T543). I'll also be creating a Debian package for my NetfilterQueue handler in the coming days."},{"author":"Patrick","date_created":1473184338,"date_modified":1473184338,"content":">>! In T530#10231, @ethanwhite wrote:\n> I'm thinking that, from an architecture standpoint, we probably want to have one package for kti/python-netfilterqueue, and another one for my NetfilterQueue handler, rather than merge them both into the same package. This would be good if we end up with more than one NetfilterQueue handler (which seems likely; see, for example, T543). I'll also be creating a Debian package for my NetfilterQueue handler in the coming days.\n\nYes, that seems a lot better than all in one."},{"author":"ethanwhite","date_created":1473367128,"date_modified":1473367128,"content":"I've now added Debian packaging support to the actual filter. Both packages install correctly and work well.\n\nI've put the filter up on a proper GitHub repository [[ https://github.com/ethan2-0/nfqueue-packet-delay | here ]] (instead of a Gist). I've also put up a version of the package I built on Debian Jessie [[ http://ethanwhite.xyz/static/nfqueue-packet-delay_0.1_any.deb | here ]]."},{"author":"Patrick","date_created":1476218418,"date_modified":1476218418,"content":"Looks like I overlooked [python3-netfilterqueue-packager](https://github.com/ethan2-0/python3-netfilterqueue-packager).\n\nThere are a few error during package build, `cp` and `du` is failing.\n\n```\nbash -x build.sh \n+ source build.conf\n++ archive_sha256=f24c592a0d2e8b2233ee365528fc1f90f7e3d80cb35c09195e3aafe3d451eac5\n++ archive_url=https://pypi.python.org/packages/7b/c3/204d47c1c47a7fd6ac1e4e341bdc6021f8142e6c7b6e488436592a6d2488/NetfilterQueue-0.7.tar.gz\n++ package_version=0.7\n+ cd src\n+ ./build.sh https://pypi.python.org/packages/7b/c3/204d47c1c47a7fd6ac1e4e341bdc6021f8142e6c7b6e488436592a6d2488/NetfilterQueue-0.7.tar.gz f24c592a0d2e8b2233ee365528fc1f90f7e3d80cb35c09195e3aafe3d451eac5\n[Build] Downloading archive, verifying sha256, and extracting...\n--2016-10-11 22:21:07--  https://pypi.python.org/packages/7b/c3/204d47c1c47a7fd6ac1e4e341bdc6021f8142e6c7b6e488436592a6d2488/NetfilterQueue-0.7.tar.gz\nResolving pypi.python.org (pypi.python.org)... 151.101.12.223, 2a04:4e42:3::223\nConnecting to pypi.python.org (pypi.python.org)|151.101.12.223|:443... connected.\nHTTP request sent, awaiting response... 200 OK\nLength: 55215 (54K) [application/octet-stream]\nSaving to: ‘NetfilterQueue-0.7.tar.gz’\n\nNetfilterQueue-0.7.tar.gz       100%[=======================================================>]  53.92K   277KB/s   in 0.2s   \n\n2016-10-11 22:21:08 (277 KB/s) - ‘NetfilterQueue-0.7.tar.gz’ saved [55215/55215]\n\n[Build] SHA256 matches. (= f24c592a0d2e8b2233ee365528fc1f90f7e3d80cb35c09195e3aafe3d451eac5)\n[Build] Creating virtualenv...\nAlready using interpreter /usr/bin/python3\nUsing base prefix '/usr'\nNew python executable in ./bin/python3\nAlso creating executable in ./bin/python\nInstalling setuptools, pip...done.\n[Build] Installing netfilterqueue in virtualenv...\nrunning install\nrunning build\nrunning build_ext\nbuilding 'netfilterqueue' extension\ncreating build/temp.linux-x86_64-3.4\nx86_64-linux-gnu-gcc -pthread -DNDEBUG -g -fwrapv -O2 -Wall -Wstrict-prototypes -g -fstack-protector-strong -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2 -fPIC -I/usr/include/python3.4m -I/home/user/python3-netfilterqueue-packager/src/include/python3.4m -c netfilterqueue.c -o build/temp.linux-x86_64-3.4/netfilterqueue.o\nnetfilterqueue.c: In function ‘__pyx_f_14netfilterqueue_6Packet_set_nfq_data’:\nnetfilterqueue.c:1939:67: warning: passing argument 2 of ‘nfq_get_payload’ from incompatible pointer type\n   __pyx_v_self->payload_len = nfq_get_payload(__pyx_v_self->_nfa, (&__pyx_v_self->payload));\n                                                                   ^\nIn file included from netfilterqueue.c:271:0:\n/usr/include/libnetfilter_queue/libnetfilter_queue.h:119:12: note: expected ‘unsigned char **’ but argument is of type ‘char **’\n extern int nfq_get_payload(struct nfq_data *nfad, unsigned char **data);\n            ^\nnetfilterqueue.c: In function ‘__pyx_pf_14netfilterqueue_6Packet_4get_payload’:\nnetfilterqueue.c:2279:5: warning: implicit declaration of function ‘PyString_FromStringAndSize’ [-Wimplicit-function-declaration]\n     __pyx_t_2 = PyString_FromStringAndSize(__pyx_v_self->payload, __pyx_v_self->payload_len); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 107, __pyx_L1_error)\n     ^\nnetfilterqueue.c:2279:15: warning: assignment makes pointer from integer without a cast\n     __pyx_t_2 = PyString_FromStringAndSize(__pyx_v_self->payload, __pyx_v_self->payload_len); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 107, __pyx_L1_error)\n               ^\ncreating build/lib.linux-x86_64-3.4\nx86_64-linux-gnu-gcc -pthread -shared -Wl,-O1 -Wl,-Bsymbolic-functions -Wl,-z,relro -Wl,-z,relro -g -fstack-protector-strong -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2 build/temp.linux-x86_64-3.4/netfilterqueue.o -lnetfilter_queue -o build/lib.linux-x86_64-3.4/netfilterqueue.cpython-34m.so\nrunning install_lib\ncopying build/lib.linux-x86_64-3.4/netfilterqueue.cpython-34m.so -> /home/user/python3-netfilterqueue-packager/src/lib/python3.4/site-packages\nrunning install_egg_info\nWriting /home/user/python3-netfilterqueue-packager/src/lib/python3.4/site-packages/NetfilterQueue-0.7.egg-info\n[Build] Copying binaries to package directory...\ncp: cannot create regular file ‘/home/user/python3-netfilterqueue-packager/src/../package/usr/lib/python3/dist-packages’: No such file or directory\ncp: cannot create regular file ‘/home/user/python3-netfilterqueue-packager/src/../package/usr/lib/python3/dist-packages’: No such file or directory\n+ cd ..\n+ cd package\n+ find DEBIAN\n+ grep -v DEBIAN\n+ xargs md5sum\n+ cd ..\n++ du --block-size 1K package/usr/lib/python3/dist-packages/NetfilterQueue-0.7.egg-info\n++ cut -f1\ndu: cannot access ‘package/usr/lib/python3/dist-packages/NetfilterQueue-0.7.egg-info’: No such file or directory\n+ egg_info_du=\n++ du --block-size 1K 'package/usr/lib/python3/dist-packages/netfilterqueue.cpython*'\n++ cut -f1\ndu: cannot access ‘package/usr/lib/python3/dist-packages/netfilterqueue.cpython*’: No such file or directory\n+ so_du=\nbuild.sh: line 39: +  : syntax error: operand expected (error token is \"+  \")\n+ echo 'Package installed size:  kilobytes'\nPackage installed size:  kilobytes\n++ python3 -c 'import sys; print(sys.version_info.minor)'\n+ py3_version=4\n+ py3_nextversion=5\n+ echo 'Python 3 version: 3.4, next version: 3.5'\nPython 3 version: 3.4, next version: 3.5\n++ dpkg --print-architecture\n+ architecture=amd64\n+ cat\n+ dpkg -b package/ python3-netfilterqueue_0.7_amd64.deb\ndpkg-deb: building package `python3-netfilterqueue' in `python3-netfilterqueue_0.7_amd64.deb'.\n```\n"},{"author":"HulaHoop","date_created":1482887307,"date_modified":1482887307,"content":"Another LAN/Public wifi fingerprinting attack that Ethan's code can defeat:\n\nhttp://www2.ece.gatech.edu/cap/papers/1569740227-3.pdf"},{"author":"HulaHoop","date_created":1570377875,"date_modified":1570395310,"content":"**tc-netem** is a utility that is part of the **iproute2** package in Debian. It leverages functionality already built into Linux and userspace utilities to simulate networks including packet delays and loss. \n\nThe advantage is it also supports random delays and with a distribution that is found over normal networks.\n\nExample usage\n\nThis is the simplest example, it just adds a fixed amount of delay This adds a delay to to all packets going out of the local Ethernet in the order of 100 ± 20 ms. Network delay variation isn't purely random, so to emulate that there is a correlation value of a normal distribution added there as well:\n\n\n```\n# tc qdisc change dev eth0 root netem delay 100ms 20ms distribution normal\n```\n\nhttps://stackoverflow.com/questions/614795/simulate-delayed-and-dropped-packets-on-linux\n\nhttp://man7.org/linux/man-pages/man8/tc-netem.8.html\n\n\n[[ https://github.com/ethan2-0/nfqueue-packet-delay/issues/1 | TBD ]]:\n\nWhether these parameters are sane and if it thwarts the attack as queuing packets across a variable length window would.\n\nEDIT:\n\nRate control as a potential solution for packet bursts.\n\nhttps://www.badunetworks.com/traffic-shaping-with-tc/\n\nhttp://home.ifi.uio.no/paalh/students/AndersMoe.pdf (2.4.5 Rate control)\n\n\n```\ntc qdisc add dev eth0 root netem rate 1mbit delay 100ms\n```"},{"author":"HulaHoop","date_created":1570388493,"date_modified":1570388493,"content":"When an implementation is decided, let's decide if we can include this in security-misc  for use on Linux hosts and Kicksecure. We would need some way in detecting the active NIC since on wireless systems wlan0 is the interface of choice and not eth0 \n\n@Patrick "},{"author":"Patrick","date_created":1570391220,"date_modified":1570391220,"content":"Reported build failures:\n\n* https://github.com/ethan2-0/python3-netfilterqueue-packager/issues/1\n* https://github.com/ethan2-0/python3-netfilterqueue-packager/issues/2\n\nNot in Debian also due to build issues:\n\n* https://packages.debian.org/sid/python-nfqueue\n* https://qa.debian.org/excuses.php?package=nfqueue-bindings\n* https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=906495"},{"author":"HulaHoop","date_created":1570395180,"date_modified":1570395276,"content":""},{"author":"HulaHoop","date_created":1570976297,"date_modified":1570976297,"content":"Analysis by Cyrus cited here for completion:\n\nWindowing in TCP is used for flow control and it's implemented in the kernel and is not related to this issue for which the solution has been proposed and it doesn't have anything to do with the \"window\" that the author has mentioned in his README. Having taken a look at his code, I see that he's creating a user-space software defined window to group packets before releasing them. What the code does is it inserts random delays between groups of packets not individual packets. The delay affects the number of packets in the group (or in the window as he calls it), when the sleeping thread wakes up it empties the group by letting the packets go.\n\n> # tc qdisc change dev eth0 root netem delay 50ms 50ms distribution normal\nI've not previously worked with this command (shouldn't you write \"add\" instead of \"change\"?) but if it does what they advertise in their manual file, then it sets a delay for each individual packet which eventually means it's better than the python script I just talked about. However how much this amount of delay is effective to foil correlation attacks depends on the network activity. It seems that your delay is less than what is suggested for that python script. To be able to say how much delay is reasonable I should know that how much the CPU load affects the packet timings. Whatever it is, the delay should be greater or equal to it.\nI saw in the README that he points out the given [75ms, 200ms] delay is enough to make the attack impossible or very hard. If that's the case, replace 50ms with these numbers and see the performance cost. If it's tolerable then go for it. And if you still need to make sure the delay is sufficient or not, we need to know more about the attack details. If CPU load can change the timing 100ms then your delay must be between +100ms and -100ms.\n\nWarning: Even after inserting random delay I think it's still possible to notice the CPU-induced timing change in packets using some mathematical models and calculation. The reason is that the CPU-induced timing will be still visible in the average value of delay between packets. So by observing a couple of thousands of packets, the adversary should be able to discern this CPU related delay he's looking for.\nSolution: Instead of using a single range for delay insertion, use multiple number of ranges to choose a random number from. For example [-100,+200], [-50,+230],[-240,+100] .... The best choice would be to select the upper and lower bounds randomly each time before choosing a random delay. For example: choose x randomly as a number larger than 100, then choose a random delay from the range [-x , +x]\nThis solution can be implemented using a combination of a simple program and the command you provided in which the program or bash script should constantly run the tc command and change the delay parameters (which again should be tested for performance issues).\n\n"},{"author":"HulaHoop","date_created":1571167594,"date_modified":1571167594,"content":"https://redmine.tails.boum.org/code/issues/17156"},{"author":"HulaHoop","date_created":1590849201,"date_modified":1590849201,"content":"Ticket above closed and convo moved to tails-dev.\n\nTPO ticket on same topic:\nhttps://github.com/mikeperry-tor/vanguards/issues/46"},{"author":"HulaHoop","date_created":1596296567,"date_modified":1596303755,"content":"The good news is I think I've figured out the equivalent tc-netem command looking the slot parameter in the manual:\n\nhttps://www.man7.org/linux/man-pages/man8/tc-netem.8.html\n\nslot\n       defer delivering accumulated packets to within a slot. Each available\n       slot can be configured with a minimum delay to acquire, and an\n       optional maximum delay.  Alternatively it can be configured with the\n       distribution similar to distribution for delay option. Slot delays\n       can be specified in nanoseconds, microseconds, milliseconds or\n       seconds (e.g. 800us). Values for the optional parameters BYTES will\n       limit the number of bytes delivered per slot, and/or PACKETS will\n       limit the number of packets delivered per slot.\n\n\n```\ntc qdisc add dev eth0 root netem slot 75ms 200ms \n```\n\nAn extra sub setting  of slot is needed to specify a uniform distribution of delay values instead of the \"normal\" bellcurve distribution that is used by default. To do this, a custom distribution table has to be generated for the min/max delay range and supplied as uniform.dist under\n \n```\n/usr/lib/tc/\n```\n\nto make the probability of selecting every  value between 75-200ms equally probable.\n\nhttp://www.unixunique.com/2018/07/linux-network-emulator-custom-delay_9.html\n\nEDIT:\n\nSeems netem uses uniform by default according to these sources\n\n* https://www.rationali.st/blog/files/20151126-jittertrap/netem-shemminger.pdf\n\n> By  default, NetEm uses a uniform distribution, but any distribution conversion table.\n\n\n* https://lists.linuxfoundation.org/pipermail/netem/2015-November/001631.html\nhttps://raw.githubusercontent.com/torvalds/linux/master/net/sched/sch_netem.c\n\n***\n\nhttps://www.systutorials.com/docs/linux/man/8-tc/"},{"author":"HulaHoop","date_created":1596819251,"date_modified":1596819251,"content":"Cyrus recommends adding delays per packet to disrupt inter-packet patterns that remain. The command can be fine tuned as such:\n\n```\ntc qdisc add dev eth0 root netem slot 75ms 200ms packets 1\n```\n\nHe also confirmed that the default command does use an uniform distribution is a custom one is not defined."},{"author":"HulaHoop","date_created":1597249809,"date_modified":1597265062,"content":"After running a bunch of tcp ping tests, the conclusion is this attack\nis not really effective against TCP like ICMP. The latency is much lower\nfor TCP pings and though it slightly decreases with cpu stress it is not\nconsistent. Reloading pages in TBB with cpu stress\non/off does not impact latency readings while doing so with tc\nattached has massive latency foot prints - implying it will ironically make such attacks much easier in addition to degrading performance.\n\nThe solution is effective against ICMP Which we don't care about for Tor\nand can be blocked on non-Whonix host systems. tc can be used with IPTables to single out ICMP for processing, but why bother with all this when it can be easily avoided?\n\nTesting commands:\nhttps://whonix.org/wiki/Dev/latency-obfuscator"}]},"PHID-TASK-2y6fnh6h2jro6b4ilujq":{"id":"529","title":"document how to use microphones","status":"resolved","priority":"Normal","author":"Patrick","description":"We have a few mentions of microphones in Whonix documentation.\n\nhttps://www.whonix.org/w/index.php?search=microphone&fulltext=Search\n\nBut apart from warnings no instructions on how to actually use a microphone.\n\nGood questions and answers:\n\nhttps://forums.whonix.org/t/microphone-dont-working-in-whonix\n\nPerhaps we should add a new page https://www.whonix.org/wiki/Microphone?\n\nRelated:\nhttps://www.whonix.org/wiki/VoIP\n","comments":[{"author":"HulaHoop","date_created":1469821516,"date_modified":1469821516,"content":"Makes sense.\n\nAs far as KVM is concerned this works out of the box and so I warned users to disable the host's microphone if not using it (which they should do anyway)."},{"author":"HulaHoop","date_created":1469920950,"date_modified":1469920950,"content":"Done for KVM. Other hypervisors pending."},{"author":"Patrick","date_created":1469971617,"date_modified":1469971617,"content":"On a second thought, to remove the redundancy that page should be merged with the following chapter?\n\nhttps://www.whonix.org/wiki/Computer_Security_Education#Microphone"},{"author":"HulaHoop","date_created":1469979070,"date_modified":1469979070,"content":"Good point. Done."},{"author":"Patrick","date_created":1469988956,"date_modified":1469988956,"content":"Fixed that page. (All content after the microphone content was hidden due to open and unclosed div tag.) And restored the improved, generic introduction chapter."}]},"PHID-TASK-txlanfbyxuihf2arbqs4":{"id":"528","title":"fix qubes-whonix-firewall systemd service start in Q2198 branch","status":"resolved","priority":"Unbreak Now!","author":"Patrick","description":"This currently blocks pretty much everything.\n\nThis branch is supposed to fix various bugs such as Tor starting/failing for multiple times and qubes-whonix-torified-updates-proxy still sometimes failing.\n\n- https://github.com/adrelanos/qubes-whonix/tree/Q2198\n- https://github.com/adrelanos/qubes-whonix/tree/Q2198/lib/systemd/system\n- https://github.com/adrelanos/qubes-whonix/blob/Q2198/lib/systemd/system/qubes-whonix-firewall.service\n\nIt does not get mentioned in `sudo journalctl -b` at all.\n\n```\nuser@host:~$ sudo service qubes-whonix-firewall status\n● qubes-whonix-firewall.service - Qubes Whonix firewall updater\n   Loaded: loaded (/lib/systemd/system/qubes-whonix-firewall.service; disabled)\n   Active: inactive (dead)\n```\n\nManual start `sudo service qubes-whonix-firewall start` works without issues.\n\nIt was changed from WantedBy=multi-user.target to WantedBy=network-pre.target. \n\nThe updated qubes-whonix-network.service [which also has this change] works, which baffles me.\n\nFor debugging purposes I also removed all After= and Before= from these both services to no avail.\n\n`sudo systemctl enable qubes-whonix-firewall` (or `reenable`) does not help either.\n","comments":[{"author":"Patrick","date_created":1469663567,"date_modified":1469663567,"content":"(Old systemd targets wants symlinks are cleaned up.)"},{"author":"Patrick","date_created":1469663905,"date_modified":1469663905,"content":"With WantedBy=multi-user.target qubes-whonix-firewall systemd service auto starts as usual. With WantedBy=network-pre.target issue happens as described above."},{"author":"Patrick","date_created":1469667398,"date_modified":1469667419,"content":"`qubes-whonix-network.service` contains:\n`Alias=qubes-network.service`\n\nWhich results in an additional file:\n\n```\nuser@host:~$ ls -la /etc/systemd/system/qubes-network.service \nlrwxrwxrwx 1 root root 48 Jul 28  2016 /etc/systemd/system/qubes-network.service -> /lib/systemd/system/qubes-whonix-network.service\n```\n\nWithout that file / without that alias, both qubes-whonix-network.service and qubes-whonix-firewall.service end up in this strange loaded, enabled, inactive status."},{"author":"marmarek","date_created":1469696707,"date_modified":1469696707,"content":"Maybe nothing pulls in `network-pre.target`? I think `network-pre.target` is only for ordering, not for starting services (so, only `After=` or `Before=` dependencies, but no `WantedBy=`). Generally quite good description is in `systemd.special` man page.\n\n>>! In T528#9599, @Patrick wrote:\n> `qubes-whonix-network.service` contains:\n> `Alias=qubes-network.service`\n> \n> Which results in an additional file:\n> \n> ```\n> user@host:~$ ls -la /etc/systemd/system/qubes-network.service \n> lrwxrwxrwx 1 root root 48 Jul 28  2016 /etc/systemd/system/qubes-network.service -> /lib/systemd/system/qubes-whonix-network.service\n> ```\n> \n> Without that file / without that alias, both qubes-whonix-network.service and qubes-whonix-firewall.service end up in this strange loaded, enabled, inactive status.\n\nThis is expected - this is how `Alias=` works."},{"author":"Patrick","date_created":1469735556,"date_modified":1469735556,"content":"Also a super simple new service I added just for testing purposes on my local machine only with WanntedBy=network-pre.target did not load.\n\n>>! In T528#9600, @marmarek wrote:\n> Maybe nothing pulls in `network-pre.target`? I think `network-pre.target` is only for ordering, not for starting services (so, only `After=` or `Before=` dependencies, but no `WantedBy=`).\n\nYes, quite possible.\n\nI am currently looking for some recommended/secure or even canonical way to load firewall rules.\n\n`[systemd-devel] How to securely load a firewall before networking gets up?`\nhttps://lists.freedesktop.org/archives/systemd-devel/2016-July/037236.html"},{"author":"Patrick","date_created":1469739002,"date_modified":1469739002,"content":"I finally have a working setup. Will commit soon."},{"author":"Patrick","date_created":1469743220,"date_modified":1469743220,"content":"I am still running into systemd ordering cycles.\n\nFor debugging purposes, I've masked qubes-whonix-postinit.service, qubes-whonix-network.service and qubes-whonix-firewall.service. No more ordering cycles then.\n\nThen I just unmasked a minimal qubes-whonix-firewall.service and again ordering cycles.\n\nqubes-whonix-firewall.service\n```\n[Unit]\nDescription=Qubes Whonix firewall updater\n\nBefore=network-pre.target\nWants=network-pre.target\n\n## Preventing race condition with\n## /etc/xdg/autostart/qubes-whonixsetup.desktop.\n## TODO:\n## Not the most efficient / clean solution.\n## https://phabricator.whonix.org/T424\n#Before=qubes-gui-agent.service\n\n## For /rw/whonix_firewall.d.\n#After=local-fs.target\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStart=/usr/lib/qubes-whonix/init/enable-firewall\nStandardOutput=syslog\n\n[Install]\nWantedBy=multi-user.target\n```\n\n```\nJul 28 21:54:45 host systemd[1]: Found ordering cycle on basic.target/start\nJul 28 21:54:45 host systemd[1]: Found dependency on paths.target/start\nJul 28 21:54:45 host systemd[1]: Found dependency on acpid.path/start\nJul 28 21:54:45 host systemd[1]: Found dependency on sysinit.target/start\nJul 28 21:54:45 host systemd[1]: Found dependency on networking.service/start\nJul 28 21:54:45 host systemd[1]: Found dependency on network-pre.target/start\nJul 28 21:54:45 host systemd[1]: Found dependency on qubes-whonix-firewall.service/start\nJul 28 21:54:45 host systemd[1]: Found dependency on basic.target/start\nJul 28 21:54:45 host systemd[1]: Breaking ordering cycle by deleting job paths.target/start\nJul 28 21:54:45 host systemd[1]: Job paths.target/start deleted to break ordering cycle starting with basic.target/start\nJul 28 21:54:45 host systemd[1]: Found ordering cycle on basic.target/start\nJul 28 21:54:45 host systemd[1]: Found dependency on sysinit.target/start\nJul 28 21:54:45 host systemd[1]: Found dependency on networking.service/start\nJul 28 21:54:45 host systemd[1]: Found dependency on network-pre.target/start\nJul 28 21:54:45 host systemd[1]: Found dependency on qubes-whonix-firewall.service/start\nJul 28 21:54:45 host systemd[1]: Found dependency on basic.target/start\nJul 28 21:54:45 host systemd[1]: Breaking ordering cycle by deleting job networking.service/start\nJul 28 21:54:45 host systemd[1]: Job networking.service/start deleted to break ordering cycle starting with basic.target/start\n```\n\nAny idea?"},{"author":"marmarek","date_created":1469744394,"date_modified":1469744394,"content":"Apparently `network-pre.target` is implicitly ordered before `basic.target`, which is automatically added (as `After=`) by `DefaultDependencies=yes`. Which would mean that any service with `Before=network-pre.target` also needs 'DefaultDependencies=no`.\nI can't find any other example with `Before=netowork-pre.target`, but all the units I can find on Debian with `Before=network.target` also have `DefaultDependencies=no`. On the other hand, on Fedora I see multiple services with `Before=network.target`, but with `DefaultDependencies=yes`, so this looks like something Debian-specific. I guess it's about `networking.service`:\n```\n$ systemctl show networking.service |grep 'After=\\|Before=\\|DefaultDependencies='\nBefore=sysinit.target shutdown.target network.target\nAfter=mountkernfs.service local-fs.target systemd-random-seed.service network-pre.target systemd-journald.socket system.slice\nDefaultDependencies=no\n```\nThis impose ordering: `networ-pre.target` -> `networking.service` -> `sysinit.target` (which is before `basic.target`).\nI have no idea whether it is some design decision, or unexpected side effect..."},{"author":"Patrick","date_created":1469759653,"date_modified":1469759653,"content":"Sounds like a bug. Reported one against Debian. Let's see.\n\n`usage of network-pre.target results in systemd ordering cycle`\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=832802"},{"author":"Patrick","date_created":1469805340,"date_modified":1469901925,"content":"Got a reply:\nhttps://lists.freedesktop.org/archives/systemd-devel/2016-July/037242.html\n\nRight, looks like `DefaultDependencies=no` cannot be prevented. I had hope it can be, since that makes things more difficult to get right."},{"author":"Patrick","date_created":1469901912,"date_modified":1469901912,"content":"Debian systemd question:\n`How to securely load a firewall before networking gets up?`\nhttp://lists.alioth.debian.org/pipermail/pkg-systemd-maintainers/2016-July/012253.html"},{"author":"Patrick","date_created":1469904894,"date_modified":1469904894,"content":"Getting closer. Will commit soon.\n\n`networking.service` causes a systemd ordering cycle. Would it be sane to add `Alias=networking.service` to `qubes-whonix-network.service`? This is what I currently have. I am asking, because Qubes might want to use the default upstream networking tools at some point and I would not want to make migration more difficult than necessary then. @marmarek "},{"author":"marmarek","date_created":1469911032,"date_modified":1469911032,"content":"I think that's fine. Because it serves very similar purpose as\nnetworking.service. But this alone probably will not fix all the\nproblems, as it will have the same dependencies, which are added using\ndrop-ins: \n```\nuser@host:~$ systemctl status networking\n● networking.service - LSB: Raise network interfaces.\n   Loaded: loaded (/etc/init.d/networking)\n  Drop-In: /lib/systemd/system/networking.service.d\n           └─40_qubes.conf\n        /run/systemd/generator/networking.service.d\n           └─50-insserv.conf-$network.conf\n        /lib/systemd/system/networking.service.d\n           └─network-pre.conf\n   Active: inactive (dead)\n           start condition failed at Tue 2016-07-26 22:45:03 UTC; 3 days ago\n           ConditionPathExists=!/usr/lib/qubes-whonix was not met\n```\n\nYou can probably have the same result by setting the same dependencies\nin qubes-whonix-network.service itself. And the risk of some conflicts\nwill be lower."},{"author":"Patrick","date_created":1469969331,"date_modified":1469969331,"content":"marmarek (Marek Marczykowski-Górecki):\n> marmarek added a comment.\n> \n> \n>   I think that's fine. Because it serves very similar purpose as\n>   networking.service.\n\nGood, so this will be it.\n\n> But this alone probably will not fix all the\n>   problems, as it will have the same dependencies, which are added using\n>   drop-ins:\n\nI feared that yesterday also, but my test result is, that these drop-ins\nare ignored once qubes-whonix-network.service had\nAlias=networking.service. I will double check today that this is not the\ncase."},{"author":"Patrick","date_created":1469996959,"date_modified":1469996959,"content":"Works well. The updated qubes-whonix package is in Whonix developers repository now and will soon be migrated into the testing and jessie-proposed-updates repository."},{"author":"Patrick","date_created":1469999652,"date_modified":1469999652,"content":"```\nfor x in qubes-whonix-firewall.service qubes-whonix-network.service qubes-whonix-postinit.service qubes-whonix-torified-updates-proxy-check.service ; do\n   echo \"$x\"\n   systemctl show -p After,Before,Wants,Requires,RequiresOverridable \\\n                  -p Requisite,RequisiteOverridable,BindsTo,PartOf   \\\n                  -p Conflicts,DefaultDependencies \"$x\"\n   echo \"#####\"\ndone | cat\n```\n\nold:\n\n```\nqubes-whonix-firewall.service\nRequires=basic.target\nRequiresOverridable=\nRequisite=\nRequisiteOverridable=\nWants=system.slice\nBindsTo=\nPartOf=\nConflicts=shutdown.target\nBefore=qubes-whonix-torified-updates-proxy-check.service network.target qubes-gui-agent.service shutdown.target multi-user.target\nAfter=qubes-whonix-postinit.service qubes-whonix-network.service systemd-journald.socket basic.target system.slice\nDefaultDependencies=yes\n#####\nqubes-whonix-network.service\nRequires=basic.target\nRequiresOverridable=\nRequisite=\nRequisiteOverridable=\nWants=system.slice\nBindsTo=\nPartOf=\nConflicts=shutdown.target\nBefore=qubes-whonix-torified-updates-proxy-check.service network.target qubes-update-check.service qubes-update-check.timer shutdown.target multi-user.target qubes-whonix-firewall.service qubes-firewall.service\nAfter=iptables.service systemd-journald.socket basic.target system.slice qubes-whonix-postinit.service\nDefaultDependencies=yes\n#####\nqubes-whonix-postinit.service\nRequires=basic.target\nRequiresOverridable=\nRequisite=\nRequisiteOverridable=\nWants=system.slice\nBindsTo=\nPartOf=\nConflicts=shutdown.target\nBefore=qubes-whonix-network.service qubes-gui-agent.service tor.service rinetd.service control-port-filter-python.service qubes-whonix-firewall.service whonixcheck.service sdwdate.service anon-ws-disable-stacked-tor.service shutdown.target multi-user.target whonix-legacy.service\nAfter=qubes-mount-dirs.service qubes-whonix-sysinit.service qubes-mount-home.service systemd-journald.socket basic.target system.slice\nDefaultDependencies=yes\n#####\nqubes-whonix-torified-updates-proxy-check.service\nRequires=basic.target\nRequiresOverridable=\nRequisite=\nRequisiteOverridable=\nWants=system.slice\nBindsTo=\nPartOf=\nConflicts=shutdown.target\nBefore=shutdown.target multi-user.target\nAfter=qubes-whonix-firewall.service network.target systemd-journald.socket basic.target system.slice qubes-whonix-network.service\nDefaultDependencies=yes\n#####\n```\n\nnew:\n\n```\nqubes-whonix-firewall.service\nRequires=\nRequiresOverridable=\nRequisite=\nRequisiteOverridable=\nWants=network-pre.target system.slice\nBindsTo=\nPartOf=\nConflicts=\nBefore=network-pre.target qubes-gui-agent.service\nAfter=local-fs.target qubes-mount-dirs.service qubes-mount-home.service sysinit.target systemd-journald.socket system.slice\nDefaultDependencies=no\n#####\nqubes-whonix-network.service\nRequires=\nRequiresOverridable=\nRequisite=\nRequisiteOverridable=\nWants=network.target system.slice\nBindsTo=\nPartOf=\nConflicts=\nBefore=network.target\nAfter=sysinit.target network-pre.target systemd-journald.socket system.slice\nDefaultDependencies=no\n#####\nqubes-whonix-postinit.service\nRequires=basic.target\nRequiresOverridable=\nRequisite=\nRequisiteOverridable=\nWants=system.slice\nBindsTo=\nPartOf=\nConflicts=shutdown.target\nBefore=qubes-gui-agent.service tor.service tor@default.service rinetd.service control-port-filter-python.service whonixcheck.service sdwdate.service anon-ws-disable-stacked-tor.service shutdown.target multi-user.target whonix-legacy.service\nAfter=qubes-whonix-sysinit.service local-fs.target qubes-mount-dirs.service qubes-mount-home.service systemd-journald.socket basic.target system.slice\nDefaultDependencies=yes\n#####\nqubes-whonix-torified-updates-proxy-check.service\nRequires=basic.target\nRequiresOverridable=\nRequisite=\nRequisiteOverridable=\nWants=network.target network-online.target system.slice\nBindsTo=\nPartOf=\nConflicts=shutdown.target\nBefore=qubes-updates-proxy.service qubes-updates-cache.service shutdown.target multi-user.target\nAfter=network.target network-online.target systemd-journald.socket basic.target system.slice\nDefaultDependencies=yes\n#####\n```\n"},{"author":"Patrick","date_created":1470000011,"date_modified":1470000011,"content":"qubes-whonix-network.service and qubes-whonix-firewall.service are longer using `Conflicts=shutdown.target`. Is it worth another update? I am wondering if the missing `Conflicts=shutdown.target` should be considered a bug or feature. At least for the firewall that may even be an advantage."},{"author":"marmarek","date_created":1470008419,"date_modified":1470008419,"content":"It means the service will not be stopped at VM shutdown. In case of\nfirewall indeed it may be ok, but for network setup I think it may be a\nbug.\n\nNote that Conflict= is the same type as Wants= - it affect whether the\nservice is started/stopped, but do not affect ordering - this is taken\nfrom Before=/After= (in case of shutdown - in reverse order)."},{"author":"Patrick","date_created":1470015361,"date_modified":1470015361,"content":"Okay.\n\nDone:\nhttps://github.com/Whonix/qubes-whonix/commit/bbfe3682c718b4fd38907a9165972f8c773b5748\n\nPrevious merge btw:\nhttps://github.com/Whonix/qubes-whonix/commit/bcdc2e6a15b0f3558ca34407f0716af33dacbebe\n\n(Stopping the firewall does not unload the firewall rules so using Conflicts=shutdown.target does no harm but is more correct and perhaps a few milliseconds faster shutdown.)\n\nUpdated qubes-whonix package version soon. (5.7-1)"},{"author":"Patrick","date_created":1470056659,"date_modified":1470056659,"content":"qubs-whonix 5.7-1 with Conflicts=shutdown.target.\n\n```\nqubes-whonix-firewall.service\nRequires=\nRequiresOverridable=\nRequisite=\nRequisiteOverridable=\nWants=network-pre.target system.slice\nBindsTo=\nPartOf=\nConflicts=shutdown.target\nBefore=network-pre.target qubes-gui-agent.service\nAfter=local-fs.target qubes-mount-dirs.service qubes-mount-home.service sysinit.target systemd-journald.socket system.slice\nDefaultDependencies=no\n#####\nqubes-whonix-network.service\nRequires=\nRequiresOverridable=\nRequisite=\nRequisiteOverridable=\nWants=network.target system.slice\nBindsTo=\nPartOf=\nConflicts=shutdown.target\nBefore=network.target qubes-firewall.service\nAfter=sysinit.target network-pre.target systemd-journald.socket system.slice\nDefaultDependencies=no\n#####\nqubes-whonix-postinit.service\nRequires=basic.target\nRequiresOverridable=\nRequisite=\nRequisiteOverridable=\nWants=system.slice\nBindsTo=\nPartOf=\nConflicts=shutdown.target\nBefore=qubes-gui-agent.service tor.service tor@default.service rinetd.service control-port-filter-python.service whonixcheck.service sdwdate.service anon-ws-disable-stacked-tor.service shutdown.target multi-user.target whonix-legacy.service\nAfter=qubes-whonix-sysinit.service local-fs.target qubes-mount-dirs.service qubes-mount-home.service systemd-journald.socket basic.target system.slice\nDefaultDependencies=yes\n#####\nqubes-whonix-torified-updates-proxy-check.service\nRequires=basic.target\nRequiresOverridable=\nRequisite=\nRequisiteOverridable=\nWants=network.target network-online.target system.slice\nBindsTo=\nPartOf=\nConflicts=shutdown.target\nBefore=qubes-updates-proxy.service qubes-updates-cache.service shutdown.target multi-user.target\nAfter=network.target network-online.target systemd-journald.socket basic.target system.slice\nDefaultDependencies=yes\n#####\n```"}]},"PHID-TASK-47vbywpp37o5fimoad2v":{"id":"527","title":"Build failure of whonix-workstation Qubes template for R3.2 / add qubes-template-whonix to continuous integration service TravisCI","status":"resolved","priority":"Unbreak Now!","author":"marmarek","description":"```\nSetting up whonix-workstation-packages-recommended (3:3.4-1) ...\ndpkg: dependency problems prevent configuration of whonix-workstation-shared-packages-shared-meta:\n whonix-workstation-shared-packages-shared-meta depends on anon-workstation-packages-recommended; however:\n  Package anon-workstation-packages-recommended is not configured yet.\n\ndpkg: error processing package whonix-workstation-shared-packages-shared-meta (--configure):\n dependency problems - leaving unconfigured\n\n(...)\n\nSetting up qubes-whonix (1:5.5-1) ...\nAdding 'diversion of /etc/qubes-rpc/qubes.SyncNtpClock to /etc/qubes-rpc/qubes.SyncNtpClock.anondist-orig by qubes-whonix'\nAdding 'diversion of /etc/qubes-rpc/qubes.SetDateTime to /etc/qubes-rpc/qubes.SetDateTime.anondist-orig by qubes-whonix'\nAdding 'diversion of /usr/lib/qubes/qubes-setup-dnat-to-ns to /usr/lib/qubes/qubes-setup-dnat-to-ns.anondist-orig by qubes-whonix'\nAdding 'diversion of /usr/share/tinyproxy/default.html to /usr/share/tinyproxy/default.html.anondist-orig by qubes-whonix'\nAdding 'diversion of /usr/share/qubes-updates-cache/errors/ERR_INVALID_URL to /usr/share/qubes-updates-cache/errors/ERR_INVALID_URL.anondist-orig by qubes-whonix'\nSetting up qubes-whonix-shared-packages-recommended (1:5.5-1) ...\nSetting up qubes-thunderbird (1.2.8-1+deb8u1) ...\nSetting up qubes-gpg-split (2.0.23-1+deb8u1) ...\nSetting up qubes-pdf-converter (2.0.5-1+deb8u1) ...\nSetting up system-config-printer (1.4.6-1) ...\ndpkg: dependency problems prevent configuration of qubes-whonix-workstation:\n qubes-whonix-workstation depends on whonix-workstation-shared-packages-shared-meta; however:\n  Package whonix-workstation-shared-packages-shared-meta is not configured yet.\n\ndpkg: error processing package qubes-whonix-workstation (--configure):\n dependency problems - leaving unconfigured\n```\n\nFull log: https://gist.github.com/marmarek/8c35ac0f82df2c3c33638646ecffd6f2\n(there is also gateway build log, but the build succeeded)","comments":[{"author":"Patrick","date_created":1469662503,"date_modified":1469662503,"content":"The culprit is probably this line:\n\nhttps://github.com/adrelanos/qubes-template-whonix/blob/4233ccab24e8f0ae4da22a66b20bb2789da1a886/whonix-gateway/04_install_qubes_post.sh#L39\n\nI forget to set that to jessie since the builds created for Whonix 13 was blessed stable.\n\nIf you want just a debug build... If you can set this environment variable (not well tested)...\n\n```\nexport whonix_repository_suite=\"jessie\"\n```\n\nOr edit/commit to `qubes-template-whonix/whonix-gateway/04_install_qubes_post.sh`.\n\nFor a new testing or even stable release, I need to finish the updated qubes-whonix package that I am working on at the moment."},{"author":"Patrick","date_created":1469663549,"date_modified":1469663562,"content":""},{"author":"marmarek","date_created":1469697071,"date_modified":1469697071,"content":">>! In T527#9583, @Patrick wrote:\n> For a new testing or even stable release, I need to finish the updated qubes-whonix package that I am working on at the moment.\n\nOk, so I think for Qubes R3.2-rc2 I'll use whonix templates from rc1. Is it ok?"},{"author":"Patrick","date_created":1469717389,"date_modified":1469717389,"content":"Yes. (Whonixl legacy bind-directories should be disabled thanks to the\nqubes-core-agent-linux upgrade and bind-dirs.sh should work fine.)"},{"author":"Patrick","date_created":1469735214,"date_modified":1469735214,"content":">>! In T527#9601, @marmarek wrote:\n>>>! In T527#9583, @Patrick wrote:\n>> For a new testing or even stable release, I need to finish the updated qubes-whonix package that I am working on at the moment.\n> \n> Ok, so I think for Qubes R3.2-rc2 I'll use whonix templates from rc1. Is it ok?\n\n>>! In T527#9602, @Patrick wrote:\n> Yes. (Whonixl legacy bind-directories should be disabled thanks to the\n> qubes-core-agent-linux upgrade and bind-dirs.sh should work fine.)\n\nOn a second thought that would not work. If you use templates from R3.3-rc1 those still and these get upgrades to newer qubes-core-agent, these would be missing the bind-directories legacy function that is not yet in Whonix stable repository. whonix-setup-wizard would rerun, lost Tor config, new Tor entry guards... Perhaps a compromise we can make.\n\nWhat would work better would be a rebuild of Whonix 13 from Whonix stable repository with Qubes R3.2-rc2. These would get started with bind-dirs.sh from the first boot."},{"author":"marmarek","date_created":1469737134,"date_modified":1469737134,"content":"R3.2-rc2 is already released...\nBut - the whole thing applied only to workstation template - gateway build was ok and new one is included there - I've just checked and it has legacy function in `/usr/lib/qubes-bind-dirs.d/41_qubes-whonix.conf`.\n\nBTW I think it worth adding template builds for automatic testing via travis-ci. It's super easy - take a look at Debian one:\nhttps://github.com/QubesOS/qubes-builder-debian/blob/master/.travis.yml\n\nWhat repository would be good for it? qubes-template-whonix?"},{"author":"Patrick","date_created":1469739330,"date_modified":1469739330,"content":">>! In T527#9607, @marmarek wrote:\n> R3.2-rc2 is already released...\n> But - the whole thing applied only to workstation template - gateway build was ok and new one is included there - I've just checked and it has legacy function in `/usr/lib/qubes-bind-dirs.d/41_qubes-whonix.conf`.\n\nI wonder where `/usr/lib/qubes-bind-dirs.d/41_qubes-whonix.conf` comes from. I haven't added it to the stable repository.\n\n> BTW I think it worth adding template builds for automatic testing via travis-ci. \n\nThat would be awesome!\n\n> It's super easy - take a look at Debian one:\n> https://github.com/QubesOS/qubes-builder-debian/blob/master/.travis.yml\n\n> What repository would be good for it? qubes-template-whonix?\n\nYes."},{"author":"marmarek","date_created":1469741127,"date_modified":1469741127,"content":">>! In T527#9609, @Patrick wrote:\n>>>! In T527#9607, @marmarek wrote:\n>> R3.2-rc2 is already released...\n>> But - the whole thing applied only to workstation template - gateway build was ok and new one is included there - I've just checked and it has legacy function in `/usr/lib/qubes-bind-dirs.d/41_qubes-whonix.conf`.\n> \n> I wonder where `/usr/lib/qubes-bind-dirs.d/41_qubes-whonix.conf` comes from. I haven't added it to the stable repository.\n\nProbably because of the line you've mentioned earlier the build used development repository..."},{"author":"Patrick","date_created":1469745443,"date_modified":1469745443,"content":"Ah. Sure. However, an image build from the Whonix developers repository should not make it into any testing or even stable releases. That repo is very unstable where I do experiments that could break anything."},{"author":"marmarek","date_created":1469745888,"date_modified":1469745888,"content":"Hmm, this is all strange. As you can see in the build log, I've build from https://github.com/marmarek/qubes-template-whonix, master branch. And there I see [[ https://github.com/marmarek/qubes-template-whonix/blob/master/builder.conf#L14 | WHONIX_APT_REPOSITORY_OPTS ?= stable ]]\nIs this setting ignored?"},{"author":"Patrick","date_created":1470017057,"date_modified":1470017057,"content":"Added .travis.yml:\n\nhttps://github.com/adrelanos/qubes-template-whonix/blob/master/.travis.yml\n\n`sudo ln -s sid /usr/share/debootstrap/scripts/stretch` is failing. Log:\n\nhttps://api.travis-ci.org/jobs/148761324/log.txt?deansi=true\n\nAny idea? Is it even needed? I try without. (Without is also better for more consistent results.)"},{"author":"Patrick","date_created":1470017819,"date_modified":1470017819,"content":"> Package anon-workstation-packages-recommended is not configured yet.\n\nThis is likely just be a symptom. [I also would have wondered what could have broken dependencies.] The build breaks on purpose. \"Failing closed.\" The culprit is:\n\n> Failed to download: https://dist.torproject.org/torbrowser/5.5.5/sha256sums.txt.asc\n\nI think we discussed this before, if so, you likely remember. Anyhow, I described that failing closed mechanism when TBB download fails during build here:\nhttps://www.whonix.org/wiki/Tor_Browser#Qubes_specific\n\nqubes-template-whonix has been changed to `whonix_repository_suite=\"jessie-proposed-updates\"` for now.\n\nEven if I haven't learned how to build Qubes R3.2 myself yet (https://groups.google.com/forum/#!topic/qubes-devel/W917Ur9XBVI), chances are good, that you are already able to build Qubes R3.2 Whonix 13.\n\nWhonix jessie-proposed-updates repository contains both a newer version of tb-updater (maintenance update with up to date version number) as well as an updated qubes-whonix package (fixes from T528)."},{"author":"Patrick","date_created":1470018672,"date_modified":1470018672,"content":"Another Travis CI issue.\n\n> Makefile:45: *** Building template whonix-gateway not supported by any of configured plugins.  Stop.\n\nhttps://s3.amazonaws.com/archive.travis-ci.org/jobs/148762157/log.txt\n\n(Using a minimal TravisCI config for now until these issues are sorted out until all variations get added.)\n\n-----\n\n~3 years ago I had TravisCI builds somewhat working. `--target root` and package builds only. No vm image builds back then due to various TravisCI limitations. At one point I gave up on TravisCI, because there was too much effort and to keep it running and too much if Debian or Ubuntu code. Perhaps things have improved now. Hopefully! Generally, CI is very cool, but a Debian based CI platform is desirable."},{"author":"marmarek","date_created":1470042973,"date_modified":1470042973,"content":">>! In T527#9673, @Patrick wrote:\n> Added .travis.yml:\n> \n> https://github.com/adrelanos/qubes-template-whonix/blob/master/.travis.yml\n> \n> `sudo ln -s sid /usr/share/debootstrap/scripts/stretch` is failing. Log:\n> \n> https://api.travis-ci.org/jobs/148761324/log.txt?deansi=true\n> \n> Any idea? Is it even needed? I try without. (Without is also better for more consistent results.)\n\nIt needs to be done after installing `debootstrap`.\n\nAlso, `dist: jessie` is not supported, only `precise` and `trusty` - and we need `trusty` to have less ancient tools (for example make is too old in `precise`).\n\n> Makefile:45: *** Building template whonix-gateway not supported by any of configured plugins. Stop.\n\nYou need to enable `template-whonix` builder plugin (in addition to `builder-debian`). Simply place `BUILDER_PLUGINS=\"template-whonix builder-debian\"` in env."},{"author":"Patrick","date_created":1470059704,"date_modified":1470059704,"content":"Using that now.\n\nYet BUILDER_PLUGINS is missing it.\n\n```\nBUILDER_PLUGINS:\n\n     builder-fedora, builder-debian, mgmt-salt,\n```\n\nHence, build still failing.\n\n> Makefile:45: *** Building template whonix-gateway not supported by any of configured plugins.  Stop.\n\nlog:\nhttps://s3.amazonaws.com/archive.travis-ci.org/jobs/148863490/log.txt\n"},{"author":"marmarek","date_created":1470060176,"date_modified":1470060176,"content":">>! In T527#9675, @Patrick wrote:\n>> Package anon-workstation-packages-recommended is not configured yet.\n> \n> This is likely just be a symptom. [I also would have wondered what could have broken dependencies.] The build breaks on purpose. \"Failing closed.\" The culprit is:\n> \n>> Failed to download: https://dist.torproject.org/torbrowser/5.5.5/sha256sums.txt.asc\n\nAh, haven't found this before. Anyway this was the fourth build in row which failed with the same message...\n\n> \n> I think we discussed this before, if so, you likely remember. Anyhow, I described that failing closed mechanism when TBB download fails during build here:\n> https://www.whonix.org/wiki/Tor_Browser#Qubes_specific\n> \n> qubes-template-whonix has been changed to `whonix_repository_suite=\"jessie-proposed-updates\"` for now.\n> \n> Even if I haven't learned how to build Qubes R3.2 myself yet (https://groups.google.com/forum/#!topic/qubes-devel/W917Ur9XBVI), chances are good, that you are already able to build Qubes R3.2 Whonix 13.\n> \n> Whonix jessie-proposed-updates repository contains both a newer version of tb-updater (maintenance update with up to date version number) as well as an updated qubes-whonix package (fixes from T528).\n\nOk, will try."},{"author":"marmarek","date_created":1470060284,"date_modified":1470060284,"content":">>! In T527#9680, @Patrick wrote:\n> Using that now.\n> \n> Yet BUILDER_PLUGINS is missing it.\n> \n> ```\n> BUILDER_PLUGINS:\n> \n>      builder-fedora, builder-debian, mgmt-salt,\n> ```\n> \n> Hence, build still failing.\n> \n>> Makefile:45: *** Building template whonix-gateway not supported by any of configured plugins.  Stop.\n> \n> log:\n> https://s3.amazonaws.com/archive.travis-ci.org/jobs/148863490/log.txt\n\nTry again (just retry build from travis UI)- I've fixed builder.conf to allow `BUILDER_PLUGINS` being overridden from env:\nhttps://github.com/QubesOS/qubes-builder/commit/f4073690e0ecca8cb26f4b6b0c8ad791f40ca38b"},{"author":"Patrick","date_created":1470063312,"date_modified":1470063312,"content":"Getting closer.\n\n```\n-> Updating sources for template-whonix...\n\n--> Fetching from https://github.com/QubesOS/qubes-template-whonix.git master...\n\nremote: Invalid username or password.\n\nfatal: Authentication failed for 'https://github.com/QubesOS/qubes-template-whonix.git/'\n\nmake: *** [template-whonix.get-sources] Error 128\n```\n\nI could probably add a pre-script to add an override.conf that uses Whonix rather than QubesOS as github account name unless you have a better solution in mind."},{"author":"Patrick","date_created":1470065527,"date_modified":1470065527,"content":"I have the override file in place.\n\nhttps://github.com/adrelanos/qubes-template-whonix/blob/master/.travis.yml\n\nBut it is ignored. Still failing for the same reason.\n\nHow do I make changes to override.conf take effect from command line? (usually I use ./setup, but that gui tool won't work for TravisCI)\n\nlog:\nhttps://api.travis-ci.org/jobs/148908578/log.txt?deansi=true"},{"author":"marmarek","date_created":1470066579,"date_modified":1470066579,"content":">>! In T527#9688, @Patrick wrote:\n> I have the override file in place.\n> \n> https://github.com/adrelanos/qubes-template-whonix/blob/master/.travis.yml\n> \n> But it is ignored. Still failing for the same reason.\n> \n> How do I make changes to override.conf take effect from command line? (usually I use ./setup, but that gui tool won't work for TravisCI)\n\noverride.conf is only a feature of `./setup` - to apply modification some and and still be able to use setup UI. It isn't a standard qubes-builder configuration.\n\nBut you can set of those settings using environment. Maybe even `export xxx=yyy` in before script will work (to avoid very long lines in `env` section)."},{"author":"Patrick","date_created":1470070392,"date_modified":1470070392,"content":"That works. Sorting out gpg key import and verification was a bit difficult. And the before_script looks kinda complex now. Non-ideal, but it is building now. Let's see."},{"author":"Patrick","date_created":1470071451,"date_modified":1470071451,"content":"The build succeeded, however there was an error at the end.\n\n> ./create_template_list.sh: line 13: xenstore-read: command not found\n\nlog:\nhttps://api.travis-ci.org/jobs/148930967/log.txt?deansi=true"},{"author":"marmarek","date_created":1470073820,"date_modified":1470073820,"content":">>! In T527#9691, @Patrick wrote:\n> The build succeeded, however there was an error at the end.\n> \n>> ./create_template_list.sh: line 13: xenstore-read: command not found\n\nLooks to be related to not running inside Qubes. Can be safely ignored."},{"author":"Patrick","date_created":1470078645,"date_modified":1470078645,"content":"Half of the builds succeeded. Both gateway and workstation builds succeeded. R3.1 and R3.2 builds succeeded.\n\nInterestingly, only builds using `USE_QUBES_REPO_TESTING=1` succeeded. These not using that failed.\n\nhttps://travis-ci.org/Whonix/qubes-template-whonix\n\nIs this something to worry about or something worth ignoring since fixed in testing?"},{"author":"marmarek","date_created":1470080364,"date_modified":1470080364,"content":"For 3.1 - yes, this is expected, qubes-core-agent package currently is available only in testing repository (will be in stable in two days) - https://github.com/QubesOS/qubes-issues/issues/2205\n\nFor 3.2 - that's strange:\n```\nSetting up brltty (5.2~20141018-5) ...\nupdate-rc.d: warning: start and stop actions are no longer supported; falling back to defaults\n./functions.sh: line 68: 28742 Segmentation fault      (core dumped) /usr/sbin/chroot \"${INSTALLDIR}\" ${1+\"$@\"}\n```"},{"author":"Patrick","date_created":1470081449,"date_modified":1470081449,"content":"Where did that happen? I checked all successful logs and found that nowhere."},{"author":"marmarek","date_created":1470081970,"date_modified":1470081970,"content":"In the failed one (job #13.5)"},{"author":"Patrick","date_created":1470140733,"date_modified":1470140733,"content":"Okay, that is very strange indeed. No idea. Perhaps a transient TravisCI issue?\n\nDisabled the failing ones for now. Qubes testing R3.1 and R3.2 are building fine on a rebuild."},{"author":"Patrick","date_created":1471214983,"date_modified":1471214983,"content":"https://github.com/QubesOS/qubes-issues/issues/2228"}]},"PHID-TASK-6p2fdwuse2jt44uzsgcx":{"id":"526","title":"systemd introduces memory protection","status":"open","priority":"Normal","author":"HulaHoop","description":"A great new security feature comes to systemd. Will be good to have for Whonix daemons:\n\n> Systemd 231 will allow the MemoryLimit and TasksMax and related unit settings to be specified as a percentage, support for the \"memory\" cgroup controller on cgroupsv2, a new MemoryDenyWriteExecute (optional) setting to prevent a service from creating memory mappings that are writable and executable at the same time (great for security!), systemd-resolved improvements, various other network-related systemd additions, support for VERSION_CODENAME in the os-release file, and many other changes. \n\nhttp://www.phoronix.com/?page=news_item&px=systemd-231-Features\n\nPatrick said:\nSetting MemoryLimit, TasksMax and maybe other related settings might be useful for some services such as sdwdate. More of a reliability improvement in case the service has a resource exhaustion bug. It cannot prevent local DOS because kernel / systemd does not provide IO limiting as found out during [constrained system resources program starter wrapper](https://forums.whonix.org/t/constrained-system-resources-program-starter-wrapper/10914) development.","comments":[]},"PHID-TASK-7hknz7kkmfivfl5trjvw":{"id":"525","title":"NEWNYM can be removed from CPFP","status":"invalid","priority":"Normal","author":"HulaHoop","description":"Recent changes to Torbutton make NEWNYM whitelisting in CPFP no longer necessary. Its good to remove rules that are no longer relevant to tighten the filter. Yawning confirms no other Tor software makes use of this command besides TBB which doesn't need controlport access for it.\n\n(Needs to be tested to confirm first)\n\nSteps:\n\n* Disable CPFP\n* Visit check.tpo\n* New identity\n* Re-visit check.tpo to confirm IP change\n\n***\n\nLinks:\n\nhttps://gitweb.torproject.org/torbutton.git/commit/?id=36d849291ec0b20a58cccc2cd846fcd2540c9bbe\n\nhttps://lists.torproject.org/pipermail/tor-dev/2016-July/011223.html\n\n> Assuming Tor Browser works as advertised, the only reason it needs control port access for this sort of use case is the circuit display (as of torbutton commit 36d849291ec0b20a58cccc2cd846fcd2540c9bbe, sending NEWNYM should be unnecessary if domain isolation is applied to everything).","comments":[{"author":"HulaHoop","date_created":1469191447,"date_modified":1469191480,"content":"Never mind.\n\nRead to mean it can trigger a new IP WITHOUT controlport access when it actually means domain isolation is good enough in TBB to prevent a single browser's activity from being correlated across many sites."}]},"PHID-TASK-pyx5tsjukebk7kwydevq":{"id":"524","title":"Using corridor, a Tor traffic whitelisting gateway with Whonix KVM","status":"wontfix","priority":"Normal","author":"Patrick","description":"It's currently documented for Qubes-Whonix, but not for #KVM.\n\nhttps://www.whonix.org/wiki/Corridor\n\nIt would be good as sanity test that Whonix is leak free today and stays leak free as Whonix developers (future firewall changes T509, IPv6, etc.)\n\nEither as a separate wiki page. Then we could transform many shared contents into wiki templates and re-use them on both pages.\n\nOr on the same wiki page. Then we would work with expand buttons where Qubes, VirtualBox and KVM instructions differ.","comments":[{"author":"HulaHoop","date_created":1468980806,"date_modified":1468980806,"content":"Overview of instructions relevant to KVM (feel free to correct me):\n\n* BridgeFirewall instructions and its .d config path\n* Should we assume the Whonix repo is enabled and just refer to the already documented steps on enabling it if the user hasn't done this? \n* Is the warning about giving away that someone is a Whonix user valid here? Does this affect non-Qubes Whonix?\n* testing/logging/results\n\n\nWhen this is tested more it would be great to have by default."},{"author":"Patrick","date_created":1468987397,"date_modified":1468987397,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>   Overview of instructions relevant to KVM (feel free to correct me):\n>   \n>   - BridgeFirewall instructions and its .d config path\n\nYes.\n\n>   - Should we assume the Whonix repo is enabled and just refer to the already documented steps on enabling it if the user hasn't done this?\n\nSince these instructions assume Debian, not Whonix, we cannot assume the\nWhonix repo is enabled.\n\n>   - Is the warning about giving away that someone is a Whonix user valid here?\n\nI did not write that. Connecting to whonix.org [[repository]] would give\naway Whonix, most likely.\n\nIt is in context of\nhttps://www.whonix.org/wiki/Hide_Tor_and_Whonix_from_your_ISP which is\nvery specific. Would assume someone managed to hide Whonix [and Tor] to\nthis point by not ideally never visiting Whonix website without Tor\nBrowser or at least never downloading from whonix.org. Ideally also\nhiding Tor. Not sure this is a realistic model at all.\n\n> Does this affect non-Qubes Whonix?\n\nNo difference between Qubes-Whonix / Non-Qubes-Whonix.\n\n>   - testing/logging/results\n\nYes.\n\n>   When this is tested more it would be great to have by default.\n\nHow? Shipping 3 VMs rather than 2 by default?\n\n(This cannot be merged into Whonix-Gateway. It is either,\n\n- corridor-workstation plus corridor-gateway, or\n- Whonix-Workstation plus Whonix-Gateway plus corridor-Gateway.)"},{"author":"Patrick","date_created":1469019226,"date_modified":1469019226,"content":"I think in case of [Non-Qubes-Whonix](https://www.whonix.org/wiki/Non-Qubes-Whonix), installing corridor in a VM is not that useful. More useful:\n\n* corridor as a host firewall\n * [already possible with some configuration](https://github.com/rustybird/corridor/issues/3)\n * for Debian hosts [perhaps also any Linux] probably simpler to document and do than creating a new VM and reconfiguring Whonix-Gateway VM to use corridor-gateway VM\n* [standalone corridor-gateway](https://github.com/rustybird/corridor)"},{"author":"HulaHoop","date_created":1469029960,"date_modified":1469029960,"content":"> This cannot be merged into Whonix-Gateway\n\nOh OK. I hadn't seen this before posting this question on the forum.\n\n> I think in case of Non-Qubes-Whonix, installing corridor in a VM is not that useful. More useful:\n\n+1\n\n\n> corridor as a host firewall\n\nYes. Maybe make it a dependency of usability (or security-misc)? So its a part of the Whonix host security improvements initiative."},{"author":"Patrick","date_created":1469032643,"date_modified":1469032643,"content":">>! In T524#9511, @HulaHoop wrote:\n>> corridor as a host firewall\n> \n> Yes. Maybe make it a dependency of usability (or security-misc)? So its a part of the Whonix host security improvements initiative.\n\nFirst of all, this very ticket needs to be implemented.\n\nusability-misc dependency, no, since very much out of scope.\n\nsecurity-misc dependency, no, since that would make a non-Tor specific package suddenly result in shipping a firewall that breaks networking for all but Tor connections.\n\nIt could be a dependency of a Whonix host package. Perhaps there would be two Whonix host packages. One that permits clearnet traffic and one that does not. Or someone have this configureable. It is speculative, since currently there is no whonix-host package and no Whonix host maintainer. [Besides Qubes OS functioning as a Whonix host.]"},{"author":"HulaHoop","date_created":1469055837,"date_modified":1469055885,"content":"I'm thinking about how to make this available for KVM users first so it can be run and tested. Then documented to complete this ticket.\n\n* Shipping 3VMs is a no go. Too much build time, download time ...\n\n* The Whonix-Host package doesn't exist and won't for a long time. I don't see the need for it yet.\n\n> security-misc dependency, no, since that would make a non-Tor specific package suddenly result in shipping a firewall that breaks networking for all but Tor connections.\n\n* What if its not enabled by default. Just merely installed for the user to enable at will?"},{"author":"Patrick","date_created":1469066352,"date_modified":1469066352,"content":"HulaHoop (HulaHoop):\n>   - The Whonix-Host package doesn't exist and won't for a long time. I don't see the need for it yet.\n\nI guess it would be useful. Depending on security-misc, providing a\nfirewall, perhaps allowing/blocking clearnet traffic.\n\n( blocking would be useful to implement:\nhttps://www.whonix.org/wiki/DoNot#Do_not_use_clearnet_and_Tor_at_the_same_time.\n)\n\nPerhaps also install sdwdate.\n\n>   > security-misc dependency, no, since that would make a non-Tor specific package suddenly result in shipping a firewall that breaks networking for all but Tor connections.\n>   \n>   - What if its not enabled by default. Just merely installed for the user to enable at will?\n\nThat is not how Debian packages are usually made. Once you install them,\nthey start providing their functionality. Servers automatically start etc.\n\nThe corridor package at the moment works like that. Now, the\nsecurity-misc package could have a \"feature\" to disable the corridor\nsystemd target by default. Such a \"feature\" sounds like a bug.\n\nImagine someone using corridor and then installing security-misc, just\nwondering it just broke corridor.\n\nI don't think a dependency would be right or useful. The corridor\npackage could be manually installed on its own. And if it should be part\nof some kind of meta package, it would be a lot better to create a new\npackages such as whonix-host or anon-host-enhancements or something like\nthat.\n\nSuch a anon-host-enhancements package or so could depend on both,\nsecurity-misc and corridor. That would be a sane and robust solution.\n\n> I'm thinking about how to make this available for KVM users first so\nit can be run and tested.\n\nJust install corridor on the host and configure it as a host firewall\n([already possible with some\nconfiguration](https://github.com/rustybird/corridor/issues/3))"},{"author":"Patrick","date_created":1469066575,"date_modified":1469066587,"content":"The current corridor deb package in Whonix repository should work fine on Debian hosts. It just needs testing, documentation and maintenance.\n\nhttps://github.com/adrelanos/corridor\n\n> Tor traffic whitelisting gateway - Debian focussed fork of https://github.com/rustybird/corridor\n\n`sudo apt-get install corridor` from Whonix repository. Installation from Debian repository would be better, but I don't know if that will happen.\n\nDebian request for package (RFP):\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=829740\n"},{"author":"HulaHoop","date_created":1469106593,"date_modified":1469106621,"content":"\n\n> That is not how Debian packages are usually made. Once you install them, they start providing their functionality. Servers automatically start etc.\n\nOK.\n\nOn second thought not including it in the misc package is better because its a full project and not a minor configuration file change.\n\n\n> The current corridor deb package in Whonix repository should work fine on Debian hosts. It just needs testing, documentation and maintenance.\n\nSounds good. I'll test.\n\nIf I setup the Whonix repo url with apt-transport-tor I should be ok?\n\n> Just install corridor on the host and configure it as a host firewall (already possible with some configuration)\n\nIts as simple as running a single command? Does this conflict with ufw?\n\nTo remove these rules I can uninstall and restart. What about temporarily disabling corridor to access local resources, how can I do that? (useful for me to include in the documentation).\n\n\n***\n\n> ...Perhaps also install sdwdate.\n\nCan these be technically installed right now stand-alone ? - (but need some testing for leak checks that corridor can now do)\n\nI think creating more packages canbe time consuming and probably not useful unless the host relevant packages start to sprawl."},{"author":"Patrick","date_created":1469125324,"date_modified":1469125324,"content":">>! In T524#9516, @HulaHoop wrote:\n> \n> \n>> That is not how Debian packages are usually made. Once you install them, they start providing their functionality. Servers automatically start etc.\n> \n> OK.\n> \n> On second thought not including it in the misc package is better because its a full project and not a minor configuration file change.\n\nYes.\n\n> \n>> The current corridor deb package in Whonix repository should work fine on Debian hosts. It just needs testing, documentation and maintenance.\n> \n> Sounds good. I'll test.\n> \n> If I setup the Whonix repo url with apt-transport-tor I should be ok?\n\nYes.\n\n>> Just install corridor on the host and configure it as a host firewall (already possible with some configuration)\n> \n> Its as simple as running a single command?\n\nAccording to rustybird, it is.\n\n> Does this conflict with ufw?\n\nDunno. Asked upstream.\n\n`clarify compatibility with ufw`\nhttps://github.com/rustybird/corridor/issues/26\n\n> To remove these rules I can uninstall and restart. What about temporarily disabling corridor to access local resources, how can I do that? (useful for me to include in the documentation).\n\nGood question. I think this needs to be tested.\n\ncanonical, corridor specific:\n\n* check iptables rules before installing corridor, store them to file a\n* install corridor, check iptables rules again, store them to file b\n* stop corridor\n\n```\nsudo service corridor-init-forwarding stop\nsudo service corridor-init-snat stop\n```\n\n* check iptables rules again, store them to file c\n* then look at them with a diff viewer\n\nVery similar to this very chapter which is not very specific to Whonix:\nhttps://www.whonix.org/wiki/Dev/Firewall_Refactoring#How_to_refactor_the_firewall_script_while_being_sure_there_are_no_iptables_changes\n\ngeneric, crude, developers only:\nhttps://www.whonix.org/wiki/Dev/Firewall_Unload\n\nNot sure what you meant by local resources. Local connections? LAN connections?\n\n> \n> ***\n> \n>> ...Perhaps also install sdwdate.\n> \n> Can these be technically installed right now stand-alone ?\n\nTheoretically yes, but there is no maintainer, not regularity tested by me.\n\n> - (but need some testing for leak checks that corridor can now do)\n> \n> I think creating more packages canbe time consuming and probably not useful unless the host relevant packages start to sprawl.\n\n"},{"author":"HulaHoop","date_created":1469192322,"date_modified":1469192322,"content":"> Not sure what you meant by local resources. Local connections? LAN connections?\n\nYes LAN connections.\n\n\nI'll gamble and test this. I think your service stop instruction will be enough to temporarily disable it."},{"author":"Patrick","date_created":1469199327,"date_modified":1469199327,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>   > Not sure what you meant by local resources. Local connections? LAN connections?\n>   \n>   Yes LAN connections.\n\nTry first if LAN connections are blocked at all. I am not sure they are.\n\nAnd even if these were blocked, it would be better to add an additional\niptables rule to allow these rather than totally disabling the firewall."},{"author":"HulaHoop","date_created":1469294501,"date_modified":1469294501,"content":"I was editing the Whonix packages on Debian host page and you added some changes half way through that almost blew my cover.\n\nMy instructions are for anonymously adding the Whonix repos. Most of the new stuff added goes against this. Should I make a new section for this?"},{"author":"Patrick","date_created":1469295831,"date_modified":1469295831,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>   I was editing the Whonix packages on Debian host page and you added some changes half way through that almost blew my cover.\n\nSorry, I just saw an anonymous edit and it reminded me to use wiki\ntemplates so instructions are consistent everywhere.\n\n>   My instructions are for anonymously adding the Whonix repos. Most of the new stuff added goes against this. Should I make a new section for this?\n\nUse the wiki template.\n\nhttps://www.whonix.org/wiki/Template:Whonix-APT-Repository-Add\n\nIntroductions about options and two sections with expand buttons.\n\nOne:\nclear http non-annymous apt\n\nTwo:\napt-transport-tor and Whonix hidden service for apt"},{"author":"HulaHoop","date_created":1469295946,"date_modified":1469295946,"content":"II'll do it after I test corridor."},{"author":"HulaHoop","date_created":1469297717,"date_modified":1469297717,"content":"No luck. Seems it depends on qubes processes that don't exist:\n\n\n\n> ● corridor-init-forwarding.service - corridor's forwarding\n>    Loaded: loaded (/lib/systemd/system/corridor-init-forwarding.service; enable\n>   Drop-In: /lib/systemd/system/corridor-init-forwarding.service.d\n>            └─qubes-service.conf, qubes.conf\n>    Active: inactive (dead)\n> Condition: start condition failed at Sat\n>            ConditionPathExists=/var/run/qubes-service/corridor was not met\n\n\n"},{"author":"Patrick","date_created":1469297895,"date_modified":1469297895,"content":"Fow now:\n```\nsudo touch /var/run/qubes-service/corridor\n```\nAnd restart systemd services.\n\nI think of something to solve this."},{"author":"Patrick","date_created":1469298684,"date_modified":1469298684,"content":"Or...\n\n```\nsudo rm /lib/systemd/system/corridor.target.d/qubes-service.conf\n```\n\n...and reboot should also help."},{"author":"Patrick","date_created":1469299100,"date_modified":1469299100,"content":"`delete qubes/systemd/corridor.target.d/qubes-service.conf`\nhttps://github.com/rustybird/corridor/pull/27"},{"author":"HulaHoop","date_created":1469299473,"date_modified":1469299605,"content":"I will make them into a template.\n\n> One: clear http non-annymous apt\n\nKeeping in line with our safe defaults policy, what is the benefit of adding this? The number of people connecting directly to Whonix repos is so small that it would be very noticed.\n\nI guess if you want to consider server admin needs it would make sense not to rely on TBB but the answer for that is to download the key using gpg from a HS keyserver:\n\nhttps://lists.gnupg.org/pipermail/gnupg-announce/2015q4/000381.html\n\n\n\n> dirmngr: New option --use-tor.  For full support this requires libassuan version 2.4.2 and a patched version of libadns (e.g. adns-1.4-g10-7 as used by the standard Windows installer).\n\n\n\n(Needs to be confirmed if dependencies met in Debian for this to happen safely)\n\n\nEDIT: \n\nOr we can tell them to use Whonix to download the key.\n\nI like that more because less effort."},{"author":"Patrick","date_created":1469300340,"date_modified":1469300340,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n> I will make them into a template.\n> \n>> One: clear http non-anonymous apt\n> \n> Keeping in line with our safe defaults policy, what is the benefit of\n> adding this? The number of people connecting directly to Whonix repos\n> is so small that it would be very noticed.\n\nUsability. Clear http non-anonymous apt is a lot simpler to set up.\n\nAnd if https://www.whonix.org/wiki/Hide_Tor_and_Whonix_from_your_ISP\ndoes not apply, not really needed.\n\nAnd if one wanted to go for Hide_Tor_and_Whonix_from_your_ISP, then this\nwould be difficult since the Debian Tor package automatically connects\nto the public Tor network. They would have to configure bridges [or\nelse] before installing Tor from Debian.\n\nAs for security, just using Whonix onion apt may have no benefits if not\nusing onion apt for everything. (Related to: T399)\n\n> I guess if you want to consider server admin needs\n\nNo server admin needs. Not sure what you mean by that.\n\n> it would make\n> sense not to rely on TBB but the answer for that is to download the\n> key using gpg from a HS keyserver:\n> \n> https://lists.gnupg.org/pipermail/gnupg-announce/2015q4/000381.html\n> \n>> dirmngr: New option --use-tor.  For full support this requires\n>> libassuan version 2.4.2 and a patched version of libadns (e.g.\n>> adns-1.4-g10-7 as used by the standard Windows installer).\n> \n> (Needs to be confirmed if dependencies met in Debian for this to\n> happen safely)\n\nYes, hiding all, including the signing key download through Tor is\ndifficult, but worthwhile."},{"author":"HulaHoop","date_created":1469311450,"date_modified":1469311450,"content":">           Or...\n> sudo rm /lib/systemd/system/corridor.target.d/qubes-service.conf\n> \n> ...and reboot should also help.\n\n\n\n\nUnfortunately nothing good:\n\n\n\n> ● corridor-init-forwarding.service - corridor's forwarding\n>    Loaded: loaded (/lib/systemd/system/corridor-init-forwarding.service; enabled; vendor preset: enabled)\n>   Drop-In: /lib/systemd/system/corridor-init-forwarding.service.d\n>            └─qubes-service.conf, qubes.conf\n>    Active: failed (Result: exit-code) since Sat \n>    \n>  Main PID: 1810 (code=exited, status=1/FAILURE)\n> \n> Jul 23 17:23:08 debian systemd[1]: Starting corridor's forwarding...\n> Jul 23 17:23:08 debian corridor-init-forwarding[1810]: ipset v6.29: Cannot open session to kernel.\n> Jul 23 17:23:11 debian systemd[1]: corridor-init-forwarding.service: Main process exited, code=exited, status=1/FAILURE\n> Jul 23 17:23:11 debian systemd[1]: Failed to start corridor's forwarding.\n> Jul 23 17:23:11 debian systemd[1]: corridor-init-forwarding.service: Unit entered failed state.\n> Jul 23 17:23:11 debian systemd[1]: corridor-init-forwarding.service: Failed with result 'exit-code'.\n> Warning: corridor-init-forwarding.service changed on disk. Run 'systemctl daemon-reload' to reload units.\n\n\n\n"},{"author":"Patrick","date_created":1469312180,"date_modified":1469312180,"content":"HulaHoop (HulaHoop):\n>   >  Jul 23 17:23:08 debian corridor-init-forwarding[1810]: ipset v6.29: Cannot open session to kernel.\n\nUsing Debian jessie?\n\nCan you fix ipset on your system?\n\nSomehow ipset is broken on your system. Debian\nhttps://packages.debian.org/de/jessie/ipset ships 6.23-2. Version 6.29\nperhaps comes from Debian stretch? I guess this is a case where mixing\nDebian suites (here jessie and stretch) causes issues. Try to avoid\nmixing. Use backports if possible, they should not be affected by such\nissues."},{"author":"HulaHoop","date_created":1469312937,"date_modified":1469312937,"content":"Besides the other solution I tried earlier today\n\n\n> sudo touch /var/run/qubes-service/corridor\n>\n> And restart systemd services.\n\ngives:\n\n> touch: cannot touch '/var/run/qubes-service/corridor': No such file or directory\n"},{"author":"HulaHoop","date_created":1469313179,"date_modified":1469313179,"content":"> Using Debian jessie?\n\nNo on Stretch. I forgot to mention that... \n\n\n>Can you fix ipset on your system?\n>\n>Somehow ipset is broken on your system. Debian https://packages.debian.org/de/jessie/ipset ships 6.23-2. Version 6.29 perhaps comes from Debian stretch? I guess this is a case where mixing Debian suites (here jessie and stretch) causes issues. Try to avoid mixing. Use backports if possible, they should not be affected by such issues.\n\nWhat can I do to avoid this besides downgrading which is a huge hassle?"},{"author":"HulaHoop","date_created":1469313297,"date_modified":1469314357,"content":""},{"author":"HulaHoop","date_created":1469314034,"date_modified":1469314342,"content":""},{"author":"HulaHoop","date_created":1469314832,"date_modified":1469314832,"content":"I think I know how to fix it."},{"author":"Patrick","date_created":1469316203,"date_modified":1469316203,"content":">   > touch: cannot touch '/var/run/qubes-service/corridor': No such file or directory\n\nBeforehand:\n```\nsudo mkdir /var/run/qubes-service\n```"},{"author":"Patrick","date_created":1469316383,"date_modified":1469316383,"content":"HulaHoop (HulaHoop):\n>   Why not set the ipset dependency to >=6.23-2 ?\n\nThere is no versioned dependency. Upstream assumes \"ipset just works\".\nDebian packaging declared \"ipset any version\".\n\nI think ipset is broken on your system without corridor being involved\nat all.\n\n> Ok so manually installed ipset from jessie should fix it?\n\nNo. Mixing stretch with jessie packages would create a bigger mess.\nDon't. The ipset version you have has to be made to work.\n\n> What can I do to avoid this besides downgrading which is a huge hassle?\n\nFix ipset. Must be a configuration issue or Debian bug etc."},{"author":"HulaHoop","date_created":1469323529,"date_modified":1469323529,"content":"● corridor-init-forwarding.service - corridor's forwarding\n   Loaded: loaded (/lib/systemd/system/corridor-init-forwarding.service; enabled; vendor preset: enabled)\n  Drop-In: /lib/systemd/system/corridor-init-forwarding.service.d\n           └─qubes-service.conf, qubes.conf\n   Active: active (exited) since Sun\n  Process: 3570 ExecStart=/bin/rm -f /var/run/qubes-service/qubes-firewall (code=exited, status=0/SUCCESS)\n  Process: 3541 ExecStart=/usr/sbin/corridor-init-forwarding (code=exited, status=0/SUCCESS)\n Main PID: 3570 (code=exited, status=0/SUCCESS)\n\nJul 24 00:10:20 debian systemd[1]: Starting corridor's forwarding...\nJul 24 00:10:20 debian corridor-init-forwarding[3541]: net.ipv4.ip_forward = 1\nJul 24 00:10:20 debian corridor-init-forwarding[3541]: net.ipv6.conf.all.forwarding = 0\nJul 24 00:10:20 debian systemd[1]: Started corridor's forwarding.\n\n\n\nCorridor testing:\n\n\nGood news: \n\nGot it working with the workarounds. \n\n\n\nBad news:\n\n* It blocks any new Whonix connections after the corridor service successfully starts while Tor connections on the host still work.\n\n* LAN connections are permitted. Is this intentional? Please ask rustybird. Its safer for this to be restricted unless a user wants otherwise. Imagine subscribing to a wireless carrier or ISP which assigns local addresses. leaking anything to this non-trusted network is dangerous.\n \n \n Two solutions come to mind: adding a LAN permission option to corridor for manual use. Out of scope of this ticket but an interesting topic that should be discussed: add a barebones captive portal responder on the host under its own user account that is exempted by corridor. This keeps leaks absolutely minimal and reduces attack surface when having to deal with captive portals.\n"},{"author":"Patrick","date_created":1469324554,"date_modified":1469324554,"content":"I don't know why that is happening. Please take all of this to upstream."},{"author":"Patrick","date_created":1469721419,"date_modified":1469721419,"content":"Update of corridor v0.10.0 uploaded to Whonix repository just now. Please update.\n\n* Contains supposed fix for the the /var/run/qubes-service/corridor issue by rustybird. Untested by me.\n* Maybe fixes the \"Couldn't load target `CORRIDOR_FILTER'\" issue. I have not checked in which version the chain was renamed. Perhaps you talked past each other since you were not using the latest version of corridor because it was not in Whonix repository.\n\nPlease also install the usability-misc package from Whonix repository since it provides the iptables-save-deterministic command or get it from [elsewhere](https://www.whonix.org/wiki/Dev/Firewall_Refactoring).\n\nLook how the chains are named in your local iptables rules. Compare with those from corridor iptables commands from corridor source code.\n\n```\nsudo iptables-save-deterministic\n```\n"},{"author":"HulaHoop","date_created":1469834413,"date_modified":1469834413,"content":"OK reinstalled new version from scratch.\n\nGot the qubes service error still:\n \n● corridor-init-forwarding.service - corridor's forwarding\n   Loaded: loaded (/lib/systemd/system/corridor-init-forwarding.service; enabled; ve\n  Drop-In: /lib/systemd/system/corridor-init-forwarding.service.d\n           └─qubes-service.conf, qubes.conf\n   Active: inactive (dead)\nCondition: start condition failed\n           ConditionPathExists=/var/run/qubes-service/corridor was not met\n\n\nI'll apply the workaround and see what else changed."},{"author":"Patrick","date_created":1469891956,"date_modified":1469891956,"content":"> ConditionPathExists=/var/run/qubes-service/corridor was not met\n\nReported this here now:\nhttps://github.com/rustybird/corridor/pull/27#issuecomment-236368253\n\n-----\n\nIt might help to attach the output of iptables-save-deterministic to https://github.com/rustybird/corridor/issues/28. I attach mine below. Yours should look similar. Slight differences may happen due to Qubes vs Debian configuration.\n\n```\nsudo iptables-save-deterministic\n```\n```\n*nat\n:PREROUTING ACCEPT [0,0]\n:INPUT ACCEPT [0,0]\n:OUTPUT ACCEPT [0,0]\n:POSTROUTING ACCEPT [0,0]\n:CORRIDOR_SNAT - [0,0]\n-A POSTROUTING -j CORRIDOR_SNAT\n-A CORRIDOR_SNAT -s 10.137.0.0/16 ! -d 10.137.0.0/16 -j MASQUERADE\nCOMMIT\n*filter\n:INPUT ACCEPT [0,0]\n:FORWARD ACCEPT [0,0]\n:OUTPUT ACCEPT [0,0]\n:CORRIDOR_FILTER - [0,0]\n-A FORWARD -j CORRIDOR_FILTER\n-A CORRIDOR_FILTER -m conntrack --ctstate RELATED,ESTABLISHED -j RETURN\n-A CORRIDOR_FILTER -m set --match-set corridor_relays dst,dst -j RETURN\n-A CORRIDOR_FILTER -m set --match-set corridor_logged src -j LOG --log-prefix \"corridor: reject \" --log-macdecode\n-A CORRIDOR_FILTER -j REJECT --reject-with icmp-host-prohibited\nCOMMIT\n```"},{"author":"HulaHoop","date_created":1469965893,"date_modified":1469965893,"content":"Tried doing a clean install of 0.10.0-2. The installation process hangs indefinitely after the last step. I am not able to remove the package because dpkg insists that its still installing:\n\n\n\n> Setting up corridor (0.10.0-2) ...\n> Created symlink /etc/systemd/system/multi-user.target.wants/corridor-init-logged.service → /lib/systemd/system/corridor-init-logged.service.\n> Created symlink /etc/systemd/system/multi-user.target.wants/corridor-init-snat.service → /lib/systemd/system/corridor-init-snat.service.\n> Created symlink /etc/systemd/system/multi-user.target.wants/corridor-data.service → /lib/systemd/system/corridor-data.service.\n> Created symlink /etc/systemd/system/multi-user.target.wants/corridor-init-forwarding.service → /lib/systemd/system/corridor-init-forwarding.service.\n> Created symlink /etc/systemd/system/systemd-networkd.service.requires/corridor-init-forwarding.service → /lib/systemd/system/corridor-init-forwarding.service.\n> Created symlink /etc/systemd/system/multi-user.target.wants/corridor.target → /lib/systemd/system/corridor.target.\n\n"},{"author":"Patrick","date_created":1469973462,"date_modified":1469973462,"content":"What hangs? Check processes / process trees.\n\n```\nps aux\n```\n\nWould be good to know.\n\nAlso check the \"sudo service ... status\" of all corridor services.\n(Documented on corridor wiki page.) Or perhaps journalctl -u ... for all\nof them.\n\nDoes reboot help? Perhaps it's just related to the\n/var/run/qubes-service/corridor bug fix update.\n\nAlso standard Debian ways for removal of broken Debian packages \"dpkg\nforce all\" would work.\n\nEnabling verbosity of the maintainer scripts at least the postinst\nscript might help. For the latter create a file:\n/usr/lib/pre.bsh\n\ncontents:\n\n```\nset -x\n```\n\nThen during installation we should have more debug output."},{"author":"HulaHoop","date_created":1470000958,"date_modified":1470000958,"content":"Postinst verbose:\n\nPreparing to unpack .../corridor_0%3a10.0.0-3_all.deb ...                           \nUnpacking corridor (10.0.0-3) ...                                                   \nProcessing triggers for man-db (2.7.5-1) ...                                        \nSetting up corridor (10.0.0-3) ...                                                  \n+ set -e\n+ true '\n#####################################################################\n## INFO: BEGIN: corridor postinst configure' '\n#####################################################################\n'\n+ case \"$1\" in\n+ mkdir --parents /var/lib/corridor\n+ true 'INFO: debhelper beginning here.'\n+ deb-systemd-helper unmask corridor-init-logged.service\n+ deb-systemd-helper --quiet was-enabled corridor-init-logged.service\n+ deb-systemd-helper enable corridor-init-logged.service\nCreated symlink /etc/systemd/system/multi-user.target.wants/corridor-init-logged.service → /lib/systemd/system/corridor-init-logged.service.\n+ deb-systemd-helper unmask corridor-init-snat.service\n+ deb-systemd-helper --quiet was-enabled corridor-init-snat.service\n+ deb-systemd-helper enable corridor-init-snat.service\nCreated symlink /etc/systemd/system/multi-user.target.wants/corridor-init-snat.service → /lib/systemd/system/corridor-init-snat.service.\n+ deb-systemd-helper unmask corridor-data.service\n+ deb-systemd-helper --quiet was-enabled corridor-data.service\n+ deb-systemd-helper enable corridor-data.service\nCreated symlink /etc/systemd/system/multi-user.target.wants/corridor-data.service → /lib/systemd/system/corridor-data.service.\n+ deb-systemd-helper unmask corridor-init-forwarding.service\n+ deb-systemd-helper --quiet was-enabled corridor-init-forwarding.service\n+ deb-systemd-helper enable corridor-init-forwarding.service\nCreated symlink /etc/systemd/system/multi-user.target.wants/corridor-init-forwarding.service → /lib/systemd/system/corridor-init-forwarding.service.\nCreated symlink /etc/systemd/system/systemd-networkd.service.requires/corridor-init-forwarding.service → /lib/systemd/system/corridor-init-forwarding.service.\n+ deb-systemd-helper unmask corridor.target\n+ deb-systemd-helper --quiet was-enabled corridor.target\n+ deb-systemd-helper enable corridor.target\nCreated symlink /etc/systemd/system/multi-user.target.wants/corridor.target → /lib/systemd/system/corridor.target.\n+ '[' -d /run/systemd/system ']'\n+ systemctl --system daemon-reload\n+ deb-systemd-invoke start corridor-init-logged.service corridor-init-snat.service corridor-data.service corridor-init-forwarding.service corridor.target\n\n\n\n\nsudo journalctl -u corridor*\n\n-- Logs begin at \n25 debian systemd[1]: Started corridor's relay list.\n25 debian corridor-data[1917]: /usr/sbin/corridor-data: 39: /usr/sbin/corridor-data: cannot open /var/run/tor/control.authcookie: No such file\n25 debian corridor-data[1917]: :25 socat[1923] E connect(5, AF=1 \"/var/run/tor/control\", 22): No such file or directory\n26 debian systemd[1]: Starting corridor's forwarding...\n26 debian systemd[1]: Starting corridor's logging...\n26 debian systemd[1]: Starting corridor's source NAT...\n27 debian corridor-data[1917]: /usr/sbin/corridor-data: 39: /usr/sbin/corridor-data: cannot open /var/run/tor/control.authcookie: No such file\n27 debian corridor-data[1917]: :27 socat[1949] E connect(5, AF=1 \"/var/run/tor/control\", 22): No such file or directory\n27 debian systemd[1]: Started corridor's source NAT.\n28 debian corridor-data[1917]: /usr/sbin/corridor-data: 39: /usr/sbin/corridor-data: cannot open /var/run/tor/control.authcookie: No such file\n28 debian corridor-data[1917]: :28 socat[1993] E connect(5, AF=1 \"/var/run/tor/control\", 22): No such file or directory\n28 debian corridor-init-forwarding[1936]: net.ipv4.ip_forward = 1\n28 debian corridor-init-forwarding[1936]: net.ipv6.conf.all.forwarding = 0\n28 debian systemd[1]: Started corridor's forwarding.\n29 debian corridor-data[1917]: /usr/sbin/corridor-data: 39: /usr/sbin/corridor-data: cannot open /var/run/tor/control.authcookie: No such file\n29 debian corridor-data[1917]: :29 socat[2032] E connect(5, AF=1 \"/var/run/tor/control\", 22): No such file or directory\n30 debian corridor-data[1917]: /usr/sbin/corridor-data: 39: /usr/sbin/corridor-data: cannot open /var/run/tor/control.authcookie: No such file\n30 debian corridor-data[1917]: :30 socat[2057] E connect(5, AF=1 \"/var/run/tor/control\", 22): No such file or directory\n31 debian corridor-data[1917]: /usr/sbin/corridor-data: 39: /usr/sbin/corridor-data: cannot open /var/run/tor/control.authcookie: No such file\n31 debian corridor-data[1917]: :31 socat[2068] E connect(5, AF=1 \"/var/run/tor/control\", 22): No such file or directory\n32 debian corridor-data[1917]: /usr/sbin/corridor-data: 39: /usr/sbin/corridor-data: cannot open /var/run/tor/control.authcookie: No such file\n32 debian corridor-data[1917]: :32 socat[2093] E connect(5, AF=1 \"/var/run/tor/control\", 22): No such file or directory\n33 debian corridor-data[1917]: /usr/sbin/corridor-data: 39: /usr/sbin/corridor-data: cannot open /var/run/tor/control.authcookie: No such file\n33 debian corridor-data[1917]: :33 socat[2195] E connect(5, AF=1 \"/var/run/tor/control\", 22): No such file or directory\n34 debian corridor-data[1917]: /usr/sbin/corridor-data: 39: /usr/sbin/corridor-data: cannot open /var/run/tor/control.authcookie: No such file\n34 debian corridor-data[1917]: :34 socat[2212] E connect(5, AF=1 \"/var/run/tor/control\", 22): No such file or directory\n35 debian corridor-data[1917]: /usr/sbin/corridor-data: 39: /usr/sbin/corridor-data: cannot open /var/run/tor/control.authcookie: No such file\n35 debian corridor-data[1917]: :35 socat[2228] E connect(5, AF=1 \"/var/run/tor/control\", 22): No such file or directory\n36 debian corridor-data[1917]: /usr/sbin/corridor-data: 39: /usr/sbin/corridor-data: cannot open /var/run/tor/control.authcookie: No such file\n52 debian corridor-data[1917]: 515 Authentication failed: Wrong length on authentication cookie.\n53 debian corridor-data[1917]: :53 socat[3031] E write(1, 0x2551aa0, 7963): Broken pipe\n55 debian corridor-data[1917]: :55 socat[3072] E write(1, 0x853aa0, 7963): Broken pipe\n56 debian corridor-data[1917]: :56 socat[3101] E write(1, 0x1235aa0, 7963): Broken pipe\n57 debian corridor-data[1917]: :57 socat[3119] E write(1, 0x1de4aa0, 7963): Broken pipe\n59 debian corridor-data[1917]: :59 socat[3127] E write(1, 0x10daaa0, 7963): Broken pipe\n00 debian corridor-data[1917]: :00 socat[3138] E write(1, 0x14eeaa0, 7963): Broken pipe\n01 debian corridor-data[1917]: :01 socat[3148] E write(1, 0x2668aa0, 7963): Broken pipe\n03 debian corridor-data[1917]: :03 socat[3161] E write(1, 0xee1aa0, 7963): Broken pipe\n04 debian corridor-data[1917]: :04 socat[3189] E write(1, 0x80daa0, 7963): Broken pipe\n05 debian corridor-data[1917]: :05 socat[3206] E write(1, 0x1b9caa0, 7963): Broken pipe\n07 debian corridor-data[1917]: :07 socat[3218] E write(1, 0xecfaa0, 7963): Broken pipe\n08 debian corridor-data[1917]: :08 socat[3245] E write(1, 0x2072aa0, 7963): Broken pipe\n09 debian corridor-data[1917]: :09 socat[3272] E write(1, 0x1e36aa0, 7963): Broken pipe\n11 debian corridor-data[1917]: :11 socat[3298] E write(1, 0x9f0aa0, 7963): Broken pipe\n12 debian corridor-data[1917]: :12 socat[3315] E write(1, 0xfb3aa0, 7963): Broken pipe\n13 debian corridor-data[1917]: :13 socat[3338] E write(1, 0x1845aa0, 7963): Broken pipe\n15 debian corridor-data[1917]: :15 socat[3359] E write(1, 0x705aa0, 7963): Broken pipe\n16 debian corridor-data[1917]: :16 socat[3370] E write(1, 0xe9eaa0, 7963): Broken pipe\n17 debian corridor-data[1917]: :17 socat[3377] E write(1, 0xf7daa0, 7963): Broken pipe\n19 debian corridor-data[1917]: :19 socat[3394] E write(1, 0x1d6eaa0, 7963): Broken pipe\n20 debian corridor-data[1917]: :20 socat[3413] E write(1, 0x1dd6aa0, 7963): Broken pipe\n22 debian corridor-data[1917]: :22 socat[3422] E write(1, 0x2034aa0, 7963): Broken pipe\nlines 1-53\n\n\n\nsudo systemctl status corridor*\n\n\n● corridor-init-logged.service - corridor's logging\n   Loaded: loaded (/lib/systemd/system/corridor-init-logged.service; enabled; vendor\n  Drop-In: /lib/systemd/system/corridor-init-logged.service.d\n           └─qubes-service.conf, qubes.conf\n   Active: activating (start) since\n Main PID: 5776 (corridor-init-l)\n   CGroup: /system.slice/corridor-init-logged.service\n           ├─5776 /bin/sh -e /usr/sbin/corridor-init-logged\n           └─8636 sleep 1\n\n debian systemd[1]: Starting corridor's logging...\n"},{"author":"Patrick","date_created":1470003678,"date_modified":1470003678,"content":"Probably two things here.\n\n* 1) corridor not being robust if Tor has issues\n* 2) your Tor having issues\n\n-----\n\n`1)` I reported some bugs upstream that might fix this.\n\n- https://github.com/rustybird/corridor/issues/30\n- https://github.com/rustybird/corridor/issues/32\n\n-----\n\n`2)`\n\nDo you have Tor running?\n\n`sudo service tor status`\n\n`sudo service tor@default status`\n\nDid Tor create the required files?\n\n`sudo ls -la /var/run/tor/control`\n\n`sudo ls -la /var/run/tor/control.authcookie`\n\nThese are owned by user/group debian-tor?\n\n-----\n\nOn Debian the Tor control socket should already be set up by default.\n\n```\ncat /usr/share/tor/tor-service-defaults-torrc\n```\n```\nDataDirectory /var/lib/tor\nPidFile /var/run/tor/tor.pid\nRunAsDaemon 1\nUser debian-tor\n\nControlSocket /var/run/tor/control\nControlSocketsGroupWritable 1\n\nCookieAuthentication 1\nCookieAuthFileGroupReadable 1\nCookieAuthFile /var/run/tor/control.authcookie\n\nLog notice file /var/log/tor/log\n```\n\n-----\n\nIf it hangs at deb-systemd-invoke, as a workaround you should be able to just kill that process.\n\n`sudo killall deb-systemd-invoke`\n\n\nOr search the pid with ps aux or some other process manager and sigterm/sigkill it as root. Verify it was really terminated. Then the postinst and package installation should successfully continue. That should be good enough for reboot and test how it works."},{"author":"HulaHoop","date_created":1470063534,"date_modified":1470063534,"content":"Results: Tor is running properly the auth cookie exists and the torrc file looks sane.\n\nI think its the order of service initialization that rusty talks about that is causing this. I'll wait for the newer version by rusty to be uploaded before I test again."},{"author":"Patrick","date_created":1470064227,"date_modified":1470064227,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>   Results: Tor is running properly the auth cookie exists and the torrc file looks sane.\n\nGood.\n\n>   I think its the order of service initialization that rusty talks about that is causing this. I'll wait for the newer version by rusty to be uploaded before I test again.\n\nThat new version will only have cosmetic advantages. Better looking logs.\n\nWill likely not solve any other issues you are having. Most likely will\nnot solve any issues you could not solve by manually restarting corridor\nsystemd services after the system finished booting."},{"author":"Patrick","date_created":1470064278,"date_modified":1470064278,"content":"Therefore, no need to wait for that reason. Testing, debugging, upstream\nbug reporting now is as good as later."},{"author":"HulaHoop","date_created":1470095694,"date_modified":1470095694,"content":"OK posted:\n\nhttps://github.com/rustybird/corridor/issues/28#issuecomment-236744443"},{"author":"Patrick","date_created":1480545143,"date_modified":1480545143,"content":"I somehow doubt rustybird is going to move this forward because rustybird is a Qubes host, not Debian host user. Without third party contributions to corridor, probably not going to happen. (Meanwhile other Qubes specific software was released, [split-browser for Qubes](https://forums.whonix.org/t/split-browser-for-qubes).)"},{"author":"HulaHoop","date_created":1481749791,"date_modified":1481749791,"content":"Agreed. This is good as dead. Feel free to close."}]},"PHID-TASK-sxf3v4wjl64z3aigxgbb":{"id":"523","title":"document identity correlation attacks and defenses / Removing Apache Recommendation","status":"resolved","priority":"Normal","author":"HulaHoop","description":"Summary:\n\nApache includes everything and the kitchen sink. Some of its features are bad for privacy and leaks info about a server's configuration:\n\nhttps://mascherari.press/why-onionscan-should-worry-you/\nhttps://mascherari.press/thwarting-identity-correlation-attacks/\n\nAlternatives to Apache we can possibly recommend instead: Nginx, reverse proxies in general, anything very simple that's enough for most people.\n\nRelated Documentation:\n\nhttps://www.whonix.org/wiki/Hidden_Services#Hidden_Webserver\n\nALPaCA defense\nhttps://forums.whonix.org/t/website-fingerprinting-defenses-at-the-application-layer\n?","comments":[{"author":"HulaHoop","date_created":1469847827,"date_modified":1469847827,"content":"And more damage from Apache plugins...\n\nIts going to get rough:\n\nhttps://mascherari.press/100s-of-dark-web-sites-should-now-be-considered-compromised/\n\nhttps://twitter.com/SarahJamieLewis/status/759095469997826048"},{"author":"HulaHoop","date_created":1492114243,"date_modified":1492114243,"content":"https://www.whonix.org/w/index.php?title=Hidden_Services&diff=prev&oldid=28910"},{"author":"Patrick","date_created":1492170218,"date_modified":1492170218,"content":"Great! Anything else to do here?"},{"author":"HulaHoop","date_created":1492524768,"date_modified":1492524768,"content":"No :)"},{"author":"Patrick","date_created":1545476490,"date_modified":1545476490,"content":"We still have the warning on https://www.whonix.org/wiki/Onion_Services.\n\n> You are better off not using Apache! We do not have a suggestion for a privacy friendly web server yet. That is still TODO. See ticket, document identity correlation attacks and defenses / Removing Apache Recommendation. Help welcome!"},{"author":"HulaHoop","date_created":1546025495,"date_modified":1546025495,"content":"From this size comparison on Debian wiki, I think the best and most secure option is the smallest and most minimal one: micro-httpd\n\nhttps://wiki.debian.org/WebServers\n\nhttps://packages.debian.org/stretch/micro-httpd\n\nOnce this is added on there, can I remove the banner or at least change the warning content and move it at the beginning of the section."},{"author":"Patrick","date_created":1546433687,"date_modified":1546433687,"content":"Sounds good!"},{"author":"HulaHoop","date_created":1546621077,"date_modified":1546621077,"content":"Done. You can close this ticket once you agree with edits."},{"author":"Patrick","date_created":1546759486,"date_modified":1546759486,"content":"https://www.whonix.org/wiki/Onion_Services#Step_1:_Install_Server_Software needs update."},{"author":"HulaHoop","date_created":1547341011,"date_modified":1547341011,"content":"Done"}]},"PHID-TASK-7klcm2uwogjn2ldbtf2d":{"id":"522","title":"Change Partition Scheme","status":"open","priority":"Wishlist","author":"Lobster","description":"Change the partition scheme from a single root partition to multiple partitions to allow the use of mount options (noexec, nodev, nosuid) and to prevent attacks which involve filling up all available space\n\nSee also:\nhttps://www.debian.org/doc/manuals/securing-debian-howto/ch3.en.html#s3.2\nhttps://www.debian.org/doc/manuals/securing-debian-howto/ch4.en.html#s4.10\nhttp://security.stackexchange.com/questions/38793/most-secure-way-to-partition-linux\nhttp://web.archive.org/web/20150905090218/http://hermann-uwe.de/blog/towards-a-moderately-paranoid-debian-laptop-setup--part-1-base-system","comments":[{"author":"Patrick","date_created":1468514861,"date_modified":1533292425,"content":"Not easy.\n\nTo create the base raw image during the build we are using grml-debootstrap. (Creating base raw images is not a trivial process, so a specialized tool for that is being used.)\n\n* https://grml.org/grml-debootstrap\n* https://github.com/grml/grml-debootstrap\n* https://github.com/Whonix/Whonix/blob/master/build-steps.d/1300_create-raw-image\n\nI do not think grml-debootstrap supports such a feature. Please consider posting a feature request against upstream against grml-debootstrap and/or implement that feature upstream.\n\nAlternatively do the same as above with [image-bootstrap](https://github.com/hartwork/image-bootstrap). The alternative project and upstream might be quicker to implement it. Although that may likely create more follow up tasks. We do not have a ticket yet for porting Whonix build process from using the old grml-debootstrap to using the more modern (but not packaged for Debian) image-bootstrap. It would have to be checked, if image-bootstrap can already do everything that we require using grml-debootstrap for at the moment.\n\nSee also:\nhttps://forums.whonix.org/t/replacing-grml-debootstrap-debos-build-platform"}]},"PHID-TASK-gulqog437d4erkyrwqve":{"id":"521","title":"simplify https://www.whonix.org/wiki/Documentation","status":"resolved","priority":"Normal","author":"Patrick","description":"https://www.whonix.org/wiki/Documentation\n\nForum discussion:\nhttps://forums.whonix.org/t/splitting-whonix-documentation-into-a-short-and-long-edition-for-better-usability","comments":[{"author":"Patrick","date_created":1561116863,"date_modified":1561116863,"content":"https://forums.whonix.org/t/splitting-whonix-documentation-into-a-short-and-long-edition-for-better-usability/1861/53?u=patrick"}]},"PHID-TASK-4cvgtezsbgq55uek3lcw":{"id":"520","title":"install fteproxy by default in Whonix-Gateway when porting to Debian stretch","status":"invalid","priority":"Normal","author":"Patrick","description":"* included in TBB\n* current as per https://trac.torproject.org/projects/tor/wiki/doc/PluggableTransports\n* available in #debian_stretch  - https://packages.debian.org/stretch/fteproxy\n\nTODO:\n\n* ~~add fteproxy to #anon-meta-packages~~ (done)\n* ~~#user_documentation~~ ([done](https://www.whonix.org/w/index.php?title=Bridges&type=revision&diff=28258&oldid=27164))\n* apparmor profile white listing required - https://github.com/Whonix/anon-gw-anonymizer-config/blob/master/etc/apparmor.d/local/system_tor.anondist\n* systemd hardening - something in `/lib/systemd/system/tor@default.service` prevents starting fteproxy\n* testing","comments":[{"author":"Patrick","date_created":1486792839,"date_modified":1486792839,"content":"Not easy. Need to wait for reply from TPO.\n\ntorproject.org bug report - `fteproxy does not work on Debian stretch / document fteproxy usage on Debian stretch`:\nhttps://trac.torproject.org/projects/tor/ticket/21436\n\n`add fteproxy to anon-gateway-packages-recommended`:\nhttps://github.com/Whonix/anon-meta-packages/commit/a57853dd0f9263201f6b2fc6aa4c54e75ed926ac\n"},{"author":"Patrick","date_created":1698149444,"date_modified":1698149444,"content":"quote https://forums.whonix.org/t/whonix-16-has-been-released-debian-11-bullseye-based-for-virtualbox-major-release/12297\n\n> [remove flashproxy-client and fteproxy from Whonix-Gateway since deprecated in Debian bullseye](https://gitlab.com/whonix/anon-meta-packages/-/commit/7488c0bdea6a1c2a415d514ba1dc4d4b60fa2709)"}]},"PHID-TASK-q4h5uuvh5fyfmslo2hs2":{"id":"519","title":"/etc/skel/.bashrc symlink breaks firejail","status":"resolved","priority":"Normal","author":"Symbolis","description":"Firejail whitelisting fails because /etc/skel/.bashrc is a symlink in whonix:\n\nuser@host:~$ firejail /usr/bin/iceweasel\nReading profile /home/user/.config/firejail/iceweasel.profile\nReading profile /etc/firejail/disable-mgmt.inc\nReading profile /etc/firejail/disable-secret.inc\nReading profile /etc/firejail/disable-common.inc\nReading profile /etc/firejail/disable-devel.inc\nReading profile /etc/firejail/whitelist-common.inc\nParent pid 30345, child pid 30346\nError: invalid /etc/skel/.bashrc file\nError: cannot establish communication with the parent, exiting...\n\nWorkaround:\nrm /etc/skel/.bashrc\ncp -a /etc/skel/.bashrc.whonix /etc/skel/.bashrc","comments":[{"author":"Patrick","date_created":1465132664,"date_modified":1465132664,"content":"Seems to me firejail should be capable to survive such a situation. Can you please report a bug against firejail? With instructions on how to reproduce this issue without having to install Whonix."},{"author":"Symbolis","date_created":1465138991,"date_modified":1465138991,"content":"https://github.com/netblue30/firejail/issues/556"},{"author":"Patrick","date_created":1465140938,"date_modified":1465140938,"content":"Thank you!"},{"author":"Symbolis","date_created":1465261054,"date_modified":1465261054,"content":"He made a fix: https://github.com/netblue30/firejail/commit/c5ed2af102d72be6aa4edc473f50278013b10241\n\nI guess it will be in the next version."}]},"PHID-TASK-c57x6cn32oscthh3oxqt":{"id":"518","title":"corridor","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/rustybird/corridor\n\nhttps://github.com/QubesOS/qubes-issues/issues/2108\n","comments":[{"author":"Patrick","date_created":1466685379,"date_modified":1466685379,"content":"Qubes / corridor feature request:\n`Qubes-corridor-Gateway (a Tor traffic whitelisting gateway)`\nhttps://github.com/QubesOS/qubes-issues/issues/2108"},{"author":"Patrick","date_created":1467572808,"date_modified":1467572808,"content":"Debian packaging work in progress:\nhttps://github.com/rustybird/corridor/issues/10"},{"author":"Patrick","date_created":1471300514,"date_modified":1471300514,"content":"- https://www.whonix.org/wiki/Corridor\n- https://www.whonix.org/blog/corridor-a-clearnet-leak-tester\n- https://www.whonix.org/blog/using-corridor-tor-traffic-whitelisting-gateway-qubes-whonix"}]},"PHID-TASK-nzzz5wsw4fhfm5nso5u3":{"id":"517","title":"iceweasel rather than Tor Browser is default browser bug / has higher mime priority / hexchat opens urls with iceweasel","status":"resolved","priority":"Normal","author":"wax","description":"When upgrading whonix 12 -> 13.  Hexchat is opening urls with iceweasel.\n\n","comments":[{"author":"Patrick","date_created":1464983777,"date_modified":1464983777,"content":"Works for me in Qubes-Whonix-Workstation. Opens links in Tor Browser.\n\nPlease check:\n\n```\ndpkg -l | grep tb-default-browser\n```\n\n> ii  tb-default-browser                                          3:1.4-1                                all          Configures system to use /usr/bin/torbrowser as default browser\n\n```\ndpkg -l | grep open-link-confirmation\n```\n\n> ii  open-link-confirmation                                      3:1.3-1                              all          Asks for confirmation before opening links"},{"author":"wax","date_created":1464995070,"date_modified":1464995070,"content":"Both are installed\n\n```\n$ dpkg -l |grep tb-default\nii  tb-default-browser                           3:1.4-1                              all          Configures system to use /usr/bin/torbrowser as default browser\n\n$ dpkg -l |grep open-link\nii  open-link-confirmation                       3:1.3-1                              all          Asks for confirmation before opening links\n```"},{"author":"Patrick","date_created":1465046188,"date_modified":1465046188,"content":"Qubes-Whonix or Non-Qubes-Whonix?"},{"author":"wax","date_created":1465054882,"date_modified":1465054882,"content":"Non-Qubes-Whonix, kvm image.\n\nI tried apt-get purge hexchat and rm -rf ~/.xchat2 and ~/.config/hexchat\nThe issue still exist"},{"author":"wax","date_created":1465076214,"date_modified":1465076214,"content":"The MIME is messed up\n\ngrep iceweasel /usr/share/applications/mimeinfo.cache\n\n\n\n\n\n\n> application/rdf+xml=iceweasel.desktop;janondisttorbrowser.desktop;\n> application/rss+xml=iceweasel.desktop;janondisttorbrowser.desktop;\n> application/vnd.mozilla.xul+xml=iceweasel.desktop;janondisttorbrowser.desktop;\n> application/xhtml+xml=iceweasel.desktop;janondisttorbrowser.desktop;\n> application/xml=iceweasel.desktop;janondisttorbrowser.desktop;\n> image/gif=kde4-okularApplication_kimgio.desktop;kde4-gwenview.desktop;>iceweasel.desktop;janondisttorbrowser.desktop;\n> image/jpeg=kde4-okularApplication_kimgio.desktop;kde4-gwenview.desktop;iceweasel.desktop;janondisttorbrowser.desktop;\n> image/png=kde4-okularApplication_kimgio.desktop;kde4-gwenview.desktop;iceweasel.desktop;janondisttorbrowser.desktop;\n> text/html=iceweasel.desktop;janondisttorbrowser.desktop;\n> text/xml=iceweasel.desktop;janondisttorbrowser.desktop;\n> **x-scheme-handler/http=iceweasel.desktop;janondisttorbrowser.desktop;\n> x-scheme-handler/https=iceweasel.desktop;janondisttorbrowser.desktop**;\n\nI removed iceweasel.desktop from the http/https handlers and hexchat now gets the open url warning for tor browser.\n\n\n\n"},{"author":"Patrick","date_created":1465077165,"date_modified":1465077165,"content":"This could be a bug in [tb-default-browser](https://github.com/Whonix/tb-default-browser). It should set the mime priority, and set it high enough.\n\nhttps://github.com/Whonix/tb-default-browser/blob/master/debian/tb-default-browser.mime"},{"author":"Patrick","date_created":1467986675,"date_modified":1467986675,"content":"Can anyone provide instructions on how to reproduce this issue?\n\nI tried installation / uninstallation of `iceweasel` / `tb-starter` / `tb-default-browser` and never reached a condition where `iceweasel.desktop` gained a higher priority than `janondisttorbrowser.desktop` in `/usr/share/applications/mimeinfo.cache`.\n\n-----\n\n* https://github.com/Whonix/tb-default-browser/blob/master/debian/tb-default-browser.mime\n* https://github.com/Whonix/tb-default-browser/blob/master/debian/tb-default-browser.postinst\n\n* http://anonscm.debian.org/cgit/pkg-mozilla/iceweasel.git/tree/debian/browser.mime.in\n* http://anonscm.debian.org/cgit/pkg-mozilla/iceweasel.git/tree/debian/browser.postinst.in\n\n-----\n\nYou have some experience with the weirdness of mime also.... Any idea? @marmarek "},{"author":"Patrick","date_created":1471300220,"date_modified":1471300220,"content":"The workaround will be to no longer install iceweasel by default. No longer required, since we install Tor Browser by default.\n\n(And also make it easy to uninstall iceweasel without having to remove a Whonix meta package.)\n\nSince iceweasel is discouraged anyhow, this is considered good enough.\n\nhttps://github.com/Whonix/anon-meta-packages/commit/24da5bf9be49aa9b96ee0576478e58ae78aad3f2"}]},"PHID-TASK-turatkoqvnr57bovq2ki":{"id":"516","title":"document bitmask","status":"open","priority":"Normal","author":"Patrick","description":"- https://github.com/QubesOS/qubes-issues/issues/2021\n- https://groups.google.com/forum/#!msg/qubes-users/dUgf68iiN4I/rqVOSnnHJwAJ\n- https://forums.whonix.org/t/bitmask\n\nRelated:\nT506\n","comments":[{"author":"Patrick","date_created":1486326585,"date_modified":1486326585,"content":"Part 1 is now documented.\n\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_a_VPN#VPN_Client_Choice\n\n> Using bitmask for this use case is not possible. In other words, you cannot use <code>user -> Tor -> bitmask -> Internet</code>. <ref>\n> https://github.com/leapcode/bitmask_client/issues/1009\n> </ref>\n\n-----\n\nTODO:\n\nDocument bitmask in context of https://www.whonix.org/wiki/Tunnels/Connecting_to_a_VPN_before_Tor.\n"},{"author":"Patrick","date_created":1486327916,"date_modified":1486327916,"content":"`vpnprocess.py error`\nhttps://github.com/leapcode/bitmask_client/issues/1020\n\nGiven the non-responsiveness earlier (https://github.com/leapcode/bitmask_client/issues/1008), postponing this."},{"author":"Patrick","date_created":1486410374,"date_modified":1486410374,"content":"`add option to not modify firewall rules`\nhttps://github.com/leapcode/bitmask_client/issues/1021\n\n`Whonix support`\nhttps://github.com/leapcode/bitmask_client/issues/1022\n\n`Qubes support`\nhttps://github.com/leapcode/bitmask_client/issues/1023"}]},"PHID-TASK-rkzpv6twcfowh25tjjjf":{"id":"515","title":"port open-link-confirmation to qubes.OpenURL","status":"resolved","priority":"Normal","author":"Patrick","description":"reference:\n\n* https://github.com/marmarek/qubes-core-agent-linux/commit/19921274e1d677268c9fbee36bee41a8a3d2fb18\n* https://github.com/QubesOS/qubes-issues/issues/1462#issuecomment-231393513\n\nTODO:\n\n* keep compatibility with older Qubes versions without qubes.OpenURL\n* port open-link-confirmation to qubes.OpenURL","comments":[{"author":"Patrick","date_created":1468526190,"date_modified":1468526190,"content":"Actually, on the Whonix side there should be nothing to do since all of this is done by `qvm-open-in-vm`, right? @marmarek "},{"author":"marmarek","date_created":1468526774,"date_modified":1468526774,"content":"Yes."},{"author":"Patrick","date_created":1471300440,"date_modified":1471300440,"content":"open-link-confirmation still working fine indeed."}]},"PHID-TASK-4oxq6dltfd3lfg5dszis":{"id":"514","title":"wordpress Post2Email replacement required","status":"invalid","priority":"Normal","author":"Patrick","description":"So mirroring of Whonix blog posts to Whonix mailing list is broken.\n\nSince broken in latest wordpress version.\n\nTODO:\n\n* contact the author\n* perhaps replace it with one that works","comments":[{"author":"Patrick","date_created":1467202046,"date_modified":1467202046,"content":"https://wordpress.org/support/topic/post2mail-broken-missing-argument-3-for-post2emailhelfpost2email_send"},{"author":"Patrick","date_created":1476211244,"date_modified":1476211244,"content":"Hard to find a privacy friendly replacement. Most tools do other stuff.\n\n* ask users for e-mail address and create a newsletter list. -> we want a simple redirection of Whonix blog posts to our existing Whonix mailing list, not start over collecting e-mail addresses\n* newsletter list management by third party services such as mailchimp\n* separate content newsletters, not blog post to mailing list forwarding\n* contains an \"unsubscribe\" link, would not be useful to have a troll subscribe our blog post to mailing list mirrorer \n"},{"author":"Patrick","date_created":1482069689,"date_modified":1482069689,"content":"No solution for this on the horizon."},{"author":"Patrick","date_created":1529817939,"date_modified":1529817939,"content":"https://forums.whonix.org/t/replacing-whonix-wordpress-blog-https-www-whonix-org-blog"}]},"PHID-TASK-4izhrutaaatxcpysyita":{"id":"513","title":"document KVM hardware identifiers","status":"resolved","priority":"Normal","author":"Patrick","description":"Please go to https://www.whonix.org/wiki/Protocol-Leak-Protection_and_Fingerprinting-Protection#Less_important_identifiers\n\nPress edit\n\nSearch multiple times for:\n`TODO document`\n\nAnd fill out the gaps.\n\nRelated:\nT449","comments":[{"author":"HulaHoop","date_created":1464829456,"date_modified":1464829456,"content":"Tested and documented."}]},"PHID-TASK-ltr35nqsfirtwhk3uxot":{"id":"512","title":"Change suffix of compressed archives to .tar.xz","status":"open","priority":"Low","author":"Lobster","description":"Some archive managers like [[ https://packages.debian.org/jessie/file-roller | File Roller ]] (which is the default on at least [[ https://help.ubuntu.com/community/File%20Roller | Ubuntu ]] and Debian with Cinnamon desktop environment) rely on this naming convention. It would also make clear to the user that the file is an xz-compressed tar-archive.\nThis applies to the Whonix libvirt images, which are named like Whonix-Gateway/Workstation-x.x.x.x.x.libvirt.xz","comments":[{"author":"Lobster","date_created":1464858041,"date_modified":1464858041,"content":"I searched a bit in GitHub and I think these are the only lines that need to be changed:\n\nWhonix/Whonix – variables\nhttps://github.com/Whonix/Whonix/blob/1226333076e224a94c674e0600d1bf34a00cad5c/help-steps/variables#L330-333\n\nWhonix/whonix-developer-meta-files – prepare_release\nhttps://github.com/Whonix/whonix-developer-meta-files/blob/bddd181d597c5b3903331e4c683d2cce7dad405e/release/prepare_release#L136\n\nWhonix/whonix-developer-meta-files – upload_images\nhttps://github.com/Whonix/whonix-developer-meta-files/blob/bddd181d597c5b3903331e4c683d2cce7dad405e/release/upload_images#L50\nhttps://github.com/Whonix/whonix-developer-meta-files/blob/bddd181d597c5b3903331e4c683d2cce7dad405e/release/upload_images#L63\nhttps://github.com/Whonix/whonix-developer-meta-files/blob/bddd181d597c5b3903331e4c683d2cce7dad405e/release/upload_images#L82\n\nAnd these wiki pages would have to be updated accordingly:\nhttps://www.whonix.org/wiki/KVM#Decompress\nhttps://www.whonix.org/wiki/KVM#Cleanup\nhttps://www.whonix.org/wiki/KVM/Installation_Screenshots"}]},"PHID-TASK-lpla7i6bkzddabva7s6s":{"id":"511","title":"abolish /usr/share/X11/xorg.conf.d/50-qxl.conf by having X11 auto detection fixed - X11 bug report","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/HulaHoopWhonix/qxl-xorg-enhance/blob/master/usr/share/X11/xorg.conf.d/50-qxl.conf\n\nWhy is that even required? Should not X11 auto detect that?\n\nTODO:\n\n* report a bug against X11\n","comments":[{"author":"HulaHoop","date_created":1463328053,"date_modified":1463328053,"content":"There are many bug reports about this problem:\n\nA Debian bug report filed against xserver-xorg-video-qxl package also mentions a thread on our forum.[1] The problem is acknowledged and fixed upstream because it was also experienced in fedora.[2] The changelog for the Ubuntu release lists a fix for disabling surfaces included in (Debian) 0.1.4.[3]\n\n>  * Resync on Debian, grabbing new upstream release 0.1.4 (LP: #1474154).\n>  * Take some patches from Fedora.\n>    + debian/patches/qxl-kms-disable-composite.patch: Fix graphical glitches\n>      by disabling COMPOSITE extension. (LP: #1261916)\n>    + debian/patches/no-surfaces-kms.patch: Should fix crashes.\n\n\nThe current stable version is 0.1.1. Debian Testing has 0.1.4 that includes the fix.[4] \n\n\n\n[1] https://bugs.debian.org/801081\n\n[2] http://spice-space.org/page/XorgQXL\n\n[3] https://bugs.launchpad.net/ubuntu/+source/xserver-xorg-video-qxl/+bug/1474154\n\n[4] https://packages.debian.org/search?keywords=xserver-xorg-video-qxl&searchon=names&suite=all&section=all\n\n\n***\n\nYet another example of why Stable is a PITA. Non security bugs can afflict users for years at a time because package versions are ossified. Yay Stable! :P"},{"author":"Patrick","date_created":1463351920,"date_modified":1463351920,"content":"Awesome write-up. Can you please reference this ticket from the relevant places (package description, documentation, forum, w/e) so no one will again wonder (and create a ticket :)? Then this can be considered very much done."},{"author":"HulaHoop","date_created":1463441031,"date_modified":1463441031,"content":"Linked relevant topics. Feel free to close this ticket unless there is something else."}]},"PHID-TASK-srl4r5eqa7opufyyqhhy":{"id":"510","title":"show better error message when Tor Browser exits non-zero","status":"resolved","priority":"Normal","author":"Patrick","description":"In case there is some non-Whonix related Tor Browser issue which results in start-tor-browser not to start Tor Browser and to exit zero, there currently the tb-starter error handler is invoked, which is not great.\n\nTODO:\nHandle this error properly.","comments":[{"author":"Patrick","date_created":1464802820,"date_modified":1464802820,"content":"https://github.com/Whonix/tb-starter/commit/5e37c18b31d173877ac156efc1e1fd9c582a0697"}]},"PHID-TASK-bnqk6xb7z3slm7pi4eqn":{"id":"509","title":"Consider nftables / Berkeley Packet Filter (BPF) as a replacement for iptables","status":"open","priority":"Normal","author":"HulaHoop","description":"nftables is the biggest change in the linux firewalling system in more than a decade.\n\nIt promises simplified rulesets, unification of IPv4/IPv6 rules and superior performance to iptables. It also allows backward compatibility with iptables rules. There may be benefits to switching but also reasons for not: if it ain't broke don't fix it. Nonetheless its some food for thought.\n\nSupported in recent kernels 3.13+ and packaged in Debian for Jessie and up.\n\nhttps://en.wikipedia.org/wiki/Nftables\nhttp://wiki.nftables.org/wiki-nftables/index.php/Main_Page\nhttp://netfilter.org/projects/nftables/\nhttp://ral-arturo.org/2018/06/16/nfws2018.html\n\n----\n\nOr Berkeley Packet Filter (BPF)?\n\nhttps://cilium.io/blog/2018/04/17/why-is-the-kernel-community-replacing-iptables/\n\n----\n\nIPv6 is coming in Tor:\n\n* https://trac.torproject.org/projects/tor/ticket/21269\n* more importantly: https://trac.torproject.org/projects/tor/ticket/17217\n\n----\n\nTODO:\n\n* Work at upstream Tor: An older version of https://trac.torproject.org/projects/tor/wiki/doc/TransparentProxy page was the origin of Whonix. Update that page for nftables / IPv6 support without mentioning Whonix. Then discuss that on the tor-talk mailing list for wider input. - https://trac.torproject.org/projects/tor/ticket/21397\n* implement corridor feature request `add IPv6 support / port to nftables` - https://github.com/rustybird/corridor/issues/39\n* port #whonix-gw-firewall to nftables\n* port #whonix-ws-firewall to nftables\n* make connections to IPv6 Tor relays work\n* make connections to IPv6 destinations work","comments":[{"author":"Patrick","date_created":1463005849,"date_modified":1469018870,"content":"Yes, one day, nftables may be a good idea. Also, one day, IPv6 support may not be avoided if it is so widespread that Whonix would stand out without having IPv6 support.\n\nWhonix is still \"essentially based on the https://trac.torproject.org/projects/tor/wiki/doc/TransparentProxy wiki page\".\n\nipv6 / nftables is not something I am looking forward to. At the moment Whonix is well leak tested. There are leaks as obscure as the following one:\n[FIN ACK / RST ACK - Leak Test](https://www.whonix.org/wiki/Dev/Leak_Tests#FIN_ACK_.2F_RST_ACK_-_Leak_Test)\n\nAnd I wouldn't know who would have the skills and time to create an nftables based Whonix firewall that works at first as good as our current one.\n\nSo I propose to avoid nftables / IPv6 as long as sanely possible.\n\nEDIT:\n~~I would like to finish other work in preparation. Namely, packaging [corridor](https://github.com/rustybird/corridor) and enabling testers to easily set up it as leak testing gateway in front of Whonix-Gateway.~~ (corridor is now [ready](https://www.whonix.org/wiki/Corridor).)"},{"author":"marmarek","date_created":1485774376,"date_modified":1485774376,"content":"Please note that Qubes 4.0 will use nftables (if available):\nhttps://github.com/QubesOS/qubes-issues/issues/974#issuecomment-251825457\n\nBut it shouldn't be a problem to use iptables at the same time - thanks to compatibility layer. Using nftables in Qubes will allow to enable qubes-firewall in Whonix Gateway without breaking firewall installed by Whonix - at least in theory."},{"author":"HulaHoop","date_created":1529499825,"date_modified":1529499825,"content":"nftables transition info:\n\nhttp://ral-arturo.org/2018/06/16/nfws2018.html"},{"author":"HulaHoop","date_created":1543856548,"date_modified":1543856548,"content":"https://researchut.com/post/migrating-firewall-to-nftables/"},{"author":"HulaHoop","date_created":1571333356,"date_modified":1571333356,"content":"Starting with Bullseye nftables will be the default:\n\nhttps://ral-arturo.org/2019/10/14/debian-netfilter.html"},{"author":"Patrick","date_created":1571635986,"date_modified":1571635986,"content":"NonaSuomy:\n> Added requested NFTables example from duclicsic #netfilter freenode.\n\n* https://trac.torproject.org/projects/tor/wiki/doc/TransparentProxy?action=diff&version=130&old_version=129\n* https://trac.torproject.org/projects/tor/ticket/21397#comment:7"},{"author":"Patrick","date_created":1576026633,"date_modified":1576026633,"content":"Or skip nftables and use Berkeley Packet Filter (BPF)?\n\nhttps://cilium.io/blog/2018/04/17/why-is-the-kernel-community-replacing-iptables/"},{"author":"marmarek","date_created":1576031731,"date_modified":1576031731,"content":"It looks like bpfilter is in rather early stages, and it's few years until we'll see it in Debian."},{"author":"ak88","date_created":1628529773,"date_modified":1628529773,"content":"Any updates on this?\n\n>>! In T509#9147, @Patrick wrote:\n> And I wouldn't know who would have the skills and time to create an nftables based Whonix firewall that works at first as good as our current one.\n\nI've actually been working with nftables and IPv6 quite a bit lately. Maybe I could offer some insight?\n\nNftables is essentially just an alternative syntax to iptables. It uses the same core engine (netfilter) under the hood, and has the same symantics as iptables. There are even automated tools for converting between the two.\n\nFor example, here's what the current Whonix Workstation firewall would look like (on my machine at least) in nftables:\n```\ntable ip filter {\n\tchain INPUT {\n\t\ttype filter hook input priority 0; policy drop;\n\t\tct state invalid counter packets 0 bytes 0 drop\n\t\tct state invalid counter packets 0 bytes 0 drop\n\t\ttcp flags & (fin | syn | rst | psh | ack | urg) == fin | syn | rst | ack counter packets 0 bytes 0 drop\n\t\ttcp flags & (fin | syn) == fin | syn counter packets 0 bytes 0 drop\n\t\ttcp flags & (syn | rst) == syn | rst counter packets 0 bytes 0 drop\n\t\tip frag-off & 8191 != 0 counter packets 0 bytes 0 drop\n\t\ttcp flags & (fin | syn | rst | psh | ack | urg) == fin | syn | rst | psh | ack | urg counter packets 0 bytes 0 drop\n\t\ttcp flags & (fin | syn | rst | psh | ack | urg) == 0x0 counter packets 0 bytes 0 drop\n\t\tiifname \"lo\" counter packets 0 bytes 0 accept\n\t\tct state established counter packets 0 bytes 0 accept\n\t\tip protocol tcp counter packets 0 bytes 0 reject with tcp reset\n\t\tcounter packets 0 bytes 0 reject\n\t}\n\n\tchain FORWARD {\n\t\ttype filter hook forward priority 0; policy drop;\n\t\tcounter packets 0 bytes 0 drop\n\t}\n\n\tchain OUTPUT {\n\t\ttype filter hook output priority 0; policy drop;\n\t\tct state invalid counter packets 0 bytes 0 reject with icmp type admin-prohibited\n\t\tct state invalid counter packets 0 bytes 0 reject with icmp type admin-prohibited\n\t\ttcp flags & (fin | syn | rst | psh | ack | urg) == fin | syn | rst | ack counter packets 0 bytes 0 reject with icmp type admin-prohibited\n\t\ttcp flags & (fin | syn) == fin | syn counter packets 0 bytes 0 reject with icmp type admin-prohibited\n\t\ttcp flags & (syn | rst) == syn | rst counter packets 0 bytes 0 reject with icmp type admin-prohibited\n\t\tip frag-off & 8191 != 0 counter packets 0 bytes 0 reject with icmp type admin-prohibited\n\t\ttcp flags & (fin | syn | rst | psh | ack | urg) == fin | syn | rst | psh | ack | urg counter packets 0 bytes 0 reject with icmp type admin-prohibited\n\t\ttcp flags & (fin | syn | rst | psh | ack | urg) == 0x0 counter packets 0 bytes 0 reject with icmp type admin-prohibited\n\t\toifname \"lo\" counter packets 0 bytes 0 accept\n\t\tip daddr 10.137.0.8 udp dport domain counter packets 0 bytes 0 accept\n\t\tip daddr 10.152.152.10 udp dport domain counter packets 0 bytes 0 accept\n\t\tip daddr 10.139.1.1 udp dport domain counter packets 0 bytes 0 accept\n\t\tip daddr 10.139.1.2 udp dport domain counter packets 0 bytes 0 accept\n\t\tip protocol != tcp counter packets 0 bytes 0 reject\n\t\tcounter packets 0 bytes 0 accept\n\t\tcounter packets 0 bytes 0 reject\n\t}\n}\n```\n\nThere's also iptables-nft, which converts iptables commands into nftables commands on the fly. In theory you could instantly convert a whole system just by symlinking it.\n\nIs there something I'm missing here? The only catch I can think of is that nftables doesn't directly support ipset, which is used by corridor. We would have to patch corridor to use either ipset-translate or nftables native sets, or replace the ipset command with a shim. Still, it doesn't sound too difficult either way.\n\nIPv6 is kind of a separate issue, is it not? I'm not sure what it has to do with migrating to nftables, other than that nftables supports unified rulesets for IPv4 and IPv6, and therefore it would be convenient to switch to nftables before adding IPv6 support. Don't get me wrong, I'd very much like to see IPv6 in Whonix at some point in the foreseeable future, whether it's with nftables or ip6tables. FWIW, at the moment Whonix is the main reason I haven't replaced my dual-stack setup with an IPv6+NAT64 setup. Nftables is not a requirement for IPv6 however."},{"author":"Patrick","date_created":1628536411,"date_modified":1628536411,"content":">>! In T509#20232, @ak88 wrote:\n> Any updates on this?\n\nNone.\n\n>>>! In T509#9147, @Patrick wrote:\n>> And I wouldn't know who would have the skills and time to create an nftables based Whonix firewall that works at first as good as our current one.\n> \n> I've actually been working with nftables and IPv6 quite a bit lately. Maybe I could offer some insight?\n\nYes, please.\n\n> There's also iptables-nft, which converts iptables commands into nftables commands on the fly. In theory you could instantly convert a whole system just by symlinking it.\n\nWell, in that case we could just replace calls to iptables to iptables-nft but that seems a bit pointless?\n\nCurrent implementation:\n\n* https://github.com/Whonix/whonix-firewall\n* https://github.com/Whonix/whonix-firewall/blob/master/usr/bin/whonix_firewall\n* https://github.com/Whonix/whonix-firewall/blob/master/usr/bin/whonix-gateway-firewall\n* https://github.com/Whonix/whonix-firewall/blob/master/usr/bin/whonix-gateway-firewall\n\n> Nftables is essentially just an alternative syntax to iptables. It uses the same core engine (netfilter) under the hood, and has the same symantics as iptables. There are even automated tools for converting between the two.\n\nFrom that perspective we could even stick with iptables for many years to come? No real need to move to nftables?\n\nAdvantages of Whonix keeping iptables:\n\n* Years long tested in Whonix.\n* More people supposedly know iptables.\n\nOther advantages for/against iptables/nftables that would speak for making such a major change?\n\n> The only catch I can think of is that nftables doesn't directly support ipset, which is used by corridor. We would have to patch corridor to use either ipset-translate or nftables native sets, or replace the ipset command with a shim. Still, it doesn't sound too difficult either way.\n\nCould you discuss this please with corridor?\n\n> IPv6 is kind of a separate issue, is it not?\n\nYes."},{"author":"Patrick","date_created":1683627830,"date_modified":1683627830,"content":"* https://unix.stackexchange.com/questions/722007/translate-firewall-rule-from-iptables-to-nftables\n* https://wiki.nftables.org/wiki-nftables/index.php/Moving_from_iptables_to_nftables"},{"author":"Patrick","date_created":1683628496,"date_modified":1683628496,"content":"https://www.kicksecure.com/wiki/Dev/Firewall_Refactoring#nftables\n\n    ls -la /usr/sbin/iptabels\n\n> /usr/sbin/iptables -> /etc/alternatives/iptables\n\n    ls -la /etc/alternatives/iptables\n\n> /etc/alternatives/iptables -> /usr/sbin/iptables-nft\n\nIn other words, `iptabels` is already symlinked to `iptabels-nft` anyhow. Therefore Whonix is already using `iptabels-nft`.\n"},{"author":"Patrick","date_created":1684171388,"date_modified":1684171388,"content":"Some progress.\n\n----\n\n* https://github.com/Whonix/whonix-firewall/tree/master/doc\n* https://github.com/Whonix/whonix-firewall/blob/master/translate-iptables-to-nftables\n* https://github.com/Whonix/whonix-firewall/blob/master/translate-remove-iptables-comments\n\n----\n\n* https://github.com/Whonix/whonix-firewall/blob/master/usr/bin/whonix-gateway-firewall\n* https://github.com/Whonix/whonix-firewall/blob/master/usr/bin/whonix-gateway-firewall.nftables\n\n----\n\n* https://github.com/Whonix/whonix-firewall/blob/master/usr/bin/whonix-workstation-firewall\n* https://github.com/Whonix/whonix-firewall/blob/master/usr/bin/whonix-workstation-firewall.nftables\n\n----\n\nThe appendix `.nftables` will probably be just transitional."},{"author":"Patrick","date_created":1684174887,"date_modified":1684174887,"content":"https://wiki.nftables.org/wiki-nftables/index.php/Scripting"},{"author":"Patrick","date_created":1684233129,"date_modified":1684233129,"content":"https://wiki.nftables.org/wiki-nftables/index.php/Atomic_rule_replacement"},{"author":"Patrick","date_created":1700980120,"date_modified":1700980120,"content":"blocker:\nQubes integration\n[Integrate Whonix firewall with Qubes nftables rule](https://github.com/QubesOS/qubes-issues/issues/8562)"}]},"PHID-TASK-it3mc33zjxripapkpnnx":{"id":"508","title":"test","status":"resolved","priority":"Low","author":"fortasse","description":"","comments":[]},"PHID-TASK-fvrkjfpctmmgvbmz55sq":{"id":"507","title":"remove fetching Whonix source code in qubes-template-whonix","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1462402593,"date_modified":1462402593,"content":"WIP:\nhttps://github.com/adrelanos/qubes-template-whonix/commit/39982cd10f3ed2770efa54a2147074dc2cd5ff7e\n"},{"author":"Patrick","date_created":1462410123,"date_modified":1462410123,"content":"That seems to work.\n\nI'd appreciate if you could have a glimpse please if I broke something obvious in qubes-builder with these changes. @marmarek\n\nhttps://github.com/adrelanos/qubes-template-whonix/commit/39982cd10f3ed2770efa54a2147074dc2cd5ff7e"},{"author":"marmarek","date_created":1462411378,"date_modified":1462411378,"content":"Nothing obvious, but haven't tested it."},{"author":"Patrick","date_created":1462416598,"date_modified":1462416598,"content":"https://github.com/adrelanos/qubes-template-whonix/commit/2ed345f2d12824a9f436c4d0d1e26cf710a3b2da"}]},"PHID-TASK-6qbru5fkfi7suzx7tx7i":{"id":"506","title":"check bitmask for shared VPN/Tor server leak bug","status":"open","priority":"Wishlist","author":"Patrick","description":"With openvpn...\n\nIf a Tor entry guard is running on the same server (same IP) as the VPN server (same IP), and if VPN breaks down, Tor may connect directly to the VPN if it happened to choose that Tor relay (same IP) as entry guard. This is not that unlikely, because a lot VPN providers support VPN port forwarding, use public IPs and people host Tor servers behind VPN's.\n\nA partial solution for this to set the VPN VM's firewall rules to allow connections only to the VPN server. Specifying destination port in that firewall rule should help a lot. Some cases will not be solved (like VPN running on 443).\n\nA full solution is to allow only user tunnel to connect to the open internet. All other users not.\n\n(Similar to T460.)\n\nTODO:\n\n* improve above issue description\n* check if bitmask is affected ","comments":[{"author":"Patrick","date_created":1468604531,"date_modified":1468604531,"content":"`bitmask shared VPN/Tor server leak bug?`\nhttps://github.com/leapcode/bitmask_client/issues/1010"}]},"PHID-TASK-7zqmredxsvuyeax5ctq4":{"id":"505","title":"do not use tput if variable TERM is empty","status":"resolved","priority":"Normal","author":"Patrick","description":"How this has been spotted:\n```\nqvm-run --pass-io anon-whonix update-torbrowser\n```\n\n```\nqvm-run --pass-io anon-whonix \"tput cols\"\n```\n\nWhat really happens:\n```\nTERM=\"\" tput cols\n```\n\n```\ntput: No value for $TERM and no -T specified\n```\n","comments":[{"author":"Patrick","date_created":1461905552,"date_modified":1461905552,"content":"Related, has it been considered for `qvm-run --pass-io` to set or not set environment variable `TERM`? I wonder if the current implementation is correct. @marmarek "},{"author":"marmarek","date_created":1461955194,"date_modified":1461955194,"content":"`qvm-run --pass-io` uses simple pipe (not virtual terminal), so it is\nexpected to not have TERM set."},{"author":"Patrick","date_created":1464868031,"date_modified":1464868031,"content":"https://github.com/Whonix/curl-scripts/commit/6a56d4a95eb440d0792115486b398a96af219aab"},{"author":"Patrick","date_created":1464868741,"date_modified":1464868741,"content":"Done in all involved components."}]},"PHID-TASK-q4f54o4tfyak3h6uerv4":{"id":"504","title":"anon-connection-wizard development","status":"open","priority":"Normal","author":"Patrick","description":"`anon-connection-wizard` is [now ready](https://forums.whonix.org/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/303) to be shipped with Whonix14.\n\nHowever, there are still a large number of improvement can be done:\n- implement bridges information validity check by RE or Tor ERROR complaints\n- ~~[merge whonixsetup(cli)](https://forums.whonix.org/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/288) into anon-connection-wizard~~ [won't do] [on second thought, not good idea to mix CLI with GUI application packages]\n- ~~[integrate whonix-setup-wizard](https://forums.whonix.org/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/289) with anon-connection-wizard T716~~ [done]\n- implement bridge request via anon-connection-wizard once BridgeDB API is finished [#15967](https://trac.torproject.org/projects/tor/ticket/15967)\n\nThe future goal of anon-connection-wizard is to be packaged as a generic standalone application into Debian so that it can be used by different anonymity focused distributions like Whonix and Tails. In order to achieve it, the following works need to be done:\n\n- ~~package anon-connection-wizard as .deb~~ [done]\n- make anon-connection-wizard translatable\n- get anon-connection-wizard translated into different languages\n- after doing all the steps above, check if it can be helpful for Tails\n\nForum discussions: https://forums.whonix.org/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/325","comments":[{"author":"iry","date_created":1504151871,"date_modified":1504151871,"content":"TODO:\n\nPatrick [pointed out](https://forums.whonix.org/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/315):\n\n\n>  Low priority… Could you please prettify the short and long package description in debian/control?\n> \n>     https://github.com/Whonix/anon-connection-wizard/blob/master/debian/control#L21\n>     https://github.com/Whonix/anon-connection-wizard/blob/master/debian/control#L22-L27\n> \n> I guess there is a lot more to say there now. More generically. Not tied to Whonix. The description targets users, not so much developers.\n> \n> Would then show up in package info websites. Example: https://packages.debian.org/stretch/tor\n> \n> (Then please try to rebuild the package so that no new lintian warnings due to the improved package description are introduced.)\n\n"}]},"PHID-TASK-vfwrkd7ztqvs2orzb7ij":{"id":"503","title":"have sane built-in defaults even if config files are non-existing","status":"resolved","priority":"Normal","author":"Patrick","description":"* #whonix-gw-firewall done\n* #whonix-ws-firewall done\n* #whonixcheck done (no changes required)\n* #sdwdate done (no changes required)\n* #uwt done\n* #control-port-filter-python done\n* #rads done\n* #open-link-confirmation done (no changes required)\n* #tb-starter done (no changes required)\n* #tb-updater done (no changes required)\n* #anon-ws-disable-stacked-tor (done)","comments":[{"author":"Patrick","date_created":1461812860,"date_modified":1461812860,"content":"https://github.com/Whonix/uwt/commit/651d2af8417fb0b7f77a88493a37935972ed444b"},{"author":"Patrick","date_created":1476312003,"date_modified":1476312003,"content":"https://github.com/Whonix/whonix-gw-firewall/commit/f2dfc5c43cfe28a2b84b4543ee2f8eed07e7b4bd"},{"author":"Patrick","date_created":1476316610,"date_modified":1476316610,"content":"https://github.com/Whonix/rads/commit/168642875e30d202613d4e0274972ce5d18e102d"},{"author":"Patrick","date_created":1554563871,"date_modified":1554563871,"content":"https://github.com/Whonix/anon-ws-disable-stacked-tor/commit/128e2312bf58a5c1cea3eecd74d1fa0a1a194b51"}]},"PHID-TASK-ryz2nfu6dyfiw2vwypkb":{"id":"502","title":"prevent running /usr/lib/qubes/qubes-setup-dnat-to-ns in Qubes-Whonix to stop it from modifying firewall rules","status":"resolved","priority":"Normal","author":"Patrick","description":"**Why?**\nPrevent it from modyfying Whonix firewall rules.\n\n**How is it started at the moment?**\n[/usr/lib/qubes/qubes-setup-dnat-to-ns](https://github.com/QubesOS/qubes-core-agent-linux/blob/master/network/qubes-setup-dnat-to-ns) gets started through two ways.\n\n* 1)\nqubes-network.service -> /usr/lib/qubes/init/network-proxy-setup.sh -> /usr/lib/qubes/qubes-setup-dnat-to-ns\nNo problem. qubes-whonix-network.service replaces qubes-network.service through a systemd alias.\n\n* 2)\nqubes-misc-post.service -> /usr/lib/qubes/init/misc-post.sh -> /usr/lib/qubes/setup-ip -> /usr/lib/qubes/qubes-setup-dnat-to-ns\n\n**Spotted how?**\nWhile experimenting with blacklisting conntrack (T468), qubes-misc-post.service blocked forwever - which prevented qrexec from starting - we probably should add systemd timeouts to systemd units (?) - 'iptables-restore -n' did permanently fail to obtain a lock.\n\n**Solution**\nThe easiest would be to config-package-dev displace /usr/lib/qubes/qubes-setup-dnat-to-ns with a dummy script in the qubes-whonix package. Does that sound good or is there a better solution?","comments":[{"author":"marmarek","date_created":1461444416,"date_modified":1461444416,"content":"Yes, I think replacing `/usr/lib/qubes/qubes-setup-dnat-to-ns` is an option for now. It may not be required in Qubes 4.0, as we will simplify network layout. I think we'll manage to get rid of DNAT for DNS in ProxyVMs.\n\n> 'iptables-restore -n' did permanently fail to obtain a lock\n\nHow is that possible? Isn't it `iptables-restore` bug?"},{"author":"Patrick","date_created":1461611386,"date_modified":1461611386,"content":">>! In T502#8900, @marmarek wrote:\n> Yes, I think replacing `/usr/lib/qubes/qubes-setup-dnat-to-ns` is an option for now.\n\nWill do.\n\n>> 'iptables-restore -n' did permanently fail to obtain a lock\n> \n> How is that possible? Isn't it `iptables-restore` bug?\n\nAlso `iptables --wait -t nat -F` can never obtain a lock. I am no longer sure disabling the conntrack module is a sane idea. Even iptables --list causes the module to load. I saw a suggestion of disabling protocol specific parsers but not blacklisting the whole module. Perhaps the kernel is not well tested with such modules blacklisted."},{"author":"Patrick","date_created":1461613269,"date_modified":1461613269,"content":"https://github.com/Whonix/qubes-whonix/commit/c0c3875c32c2f17358ef7e4a7cbb15ee48d8041d"},{"author":"Patrick","date_created":1463684301,"date_modified":1463684301,"content":"https://github.com/adrelanos/vpn-firewall/commit/b1a77b8eb7fb28c2ad9ad394b5326673b9272398"}]},"PHID-TASK-6jpq727khqmfqciizvky":{"id":"501","title":"port from Whonix bind-directories to Qubes bind-dirs.sh","status":"resolved","priority":"Normal","author":"Patrick","description":"Now that Whonix bind-directories has been upstreamed to Qubes as bind-dirs.sh (T414), Whonix needs to actually start using it.\n\nInquiry when bind-dirs.sh will be available in Qubes R3.1 or R4.0, done:\nhttps://github.com/marmarek/qubes-core-agent-linux/pull/58#issuecomment-213114874\n\nThe difficulty here is to smoothly transition away from Whonix bind-directories as soon as Qubes bind-dirs.sh gets available. Perhaps Whonix bind-directories should check if Qubes bind-dirs.sh is available and terminate when it is? Then the config file for Qubes bind-dirs.sh could be deployed right now and no user of R3 / 3.1 / 3.2 / 4.0 should run into any issues, right?","comments":[{"author":"marmarek","date_created":1461275605,"date_modified":1461275605,"content":":+1:"},{"author":"Patrick","date_created":1461276093,"date_modified":1461276093,"content":"Wondering, should there be just one config file per whole Whonix or a\nsnippet per related package?\n\nFor example, /etc/tor and /var/lib/tor could go into\nanon-gw-anonymizer-config."},{"author":"Patrick","date_created":1461614213,"date_modified":1461614213,"content":"https://github.com/Whonix/qubes-whonix/commit/abd1734a95152d9978e9749ee066aa85efa6f6df"},{"author":"Patrick","date_created":1461903037,"date_modified":1461903037,"content":"Function `legacy` is broken.\n\nFor reference:\nhttps://github.com/marmarek/qubes-core-agent-linux/blob/f4d367a6a7eb70f3658e28f5ae5841b2fff3b1c9/vm-systemd/bind-dirs.sh#L49-L56\n\nI could overwrite the function in package qubes-whonix or fix it in qubes-core-agent-linux. The latter should work just fine if the bug fixed version makes it into R3.2 (if that comes) or R4.\n\nApart from this it seems to migrate just fine."},{"author":"marmarek","date_created":1461955764,"date_modified":1461955764,"content":"What would fix look like? Anyway, it shouldn't be a problem to have it\nincluded in Qubes 3.2."},{"author":"Patrick","date_created":1461966477,"date_modified":1461966477,"content":">>! In T501#9040, @marmarek wrote:\n> What would fix look like?\n\nhttps://github.com/marmarek/qubes-core-agent-linux/pull/69\n\n> Anyway, it shouldn't be a problem to have it\n> included in Qubes 3.2.\n\nGreat.\n"}]},"PHID-TASK-ahet7iafrd7l2w66yd5e":{"id":"500","title":"disable preview in nautilus by default","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/security-misc\n\nhttps://github.com/QubesOS/qubes-issues/issues/1108#issuecomment-263174448\n\nShould avoid using the same filename `/usr/share/glib-2.0/schemas/org.gnome.nautilus.gschema.override` to avoid conflicts with qubes-core-agent-linux-package if that is possible.","comments":[{"author":"Patrick","date_created":1487543702,"date_modified":1487543702,"content":"https://github.com/Whonix/security-misc/commit/5ba2a5b6ff53df37ad38f082ad86ff2227158d93\nhttps://github.com/Whonix/security-misc/commit/dfe8a569b639dd09ef4cd7f35c05efd7ea080406"}]},"PHID-TASK-4tr5ymq5m776lvcv6msz":{"id":"499","title":"fix whonix-setup-wizard","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/218?u=patrick","comments":[{"author":"Patrick","date_created":1461683162,"date_modified":1461683181,"content":""}]},"PHID-TASK-z34pduokddun6crn65lr":{"id":"498","title":"Qubes-Whonix build process: install Whonix from Whonix binary APT repository","status":"resolved","priority":"Normal","author":"Patrick","description":"advantages:\n\n* simpler #qubes-template-whonix code\n* faster builds, packages no longer need to be build during Qubes-Whonix template build\n* build dependencies will no longer be installed inside the template\n** therefore smaller template sizes\n*** therefore less space issues on Qubes installer DVD\n* solves T416 for free\n* simpler than trying to have Qubes builder create Whonix packages (T438 ?)\n\ndisadvantages:\n\n* building Whonix templates with Whonix packages build from source code gets harder\n\nrelated:\n\n* T461 \n","comments":[{"author":"Patrick","date_created":1461104497,"date_modified":1461104497,"content":"```\nQubes-Whonix build process: install Whonix from Whonix binary APT repository\n\nhttps://phabricator.whonix.org/T498\n```\nhttps://github.com/adrelanos/qubes-template-whonix/commit/b7b83fee56d72abb69617bd8bc8deda239f29ae7\n\n(I will clean up all the comments and todo soon.)\n\nPlease have a glimpse if the current 04_install_qubes_post.sh goes into the direction you imagined. @marmarek\n\n04_install_qubes_post.sh:\nhttps://github.com/adrelanos/qubes-template-whonix/blob/b7b83fee56d72abb69617bd8bc8deda239f29ae7/whonix-gateway/04_install_qubes_post.sh"},{"author":"marmarek","date_created":1461105624,"date_modified":1461105624,"content":"Looks really good! :)"},{"author":"Patrick","date_created":1461213472,"date_modified":1461213472,"content":"It's done.\n\n* https://github.com/adrelanos/qubes-template-whonix/blob/master/whonix-gateway/04_install_qubes_post.sh\n* https://github.com/adrelanos/qubes-template-whonix/blob/master/whonix-gateway/09_cleanup_post.sh\n\n-----\n\nAs for building Qubes-Whonix templates with Whonix packages build from source...\n\n* It would help if Qubes builder worked on top of Debian. ([#1907](https://github.com/QubesOS/qubes-issues/issues/1907))\n* Then one could create a local repository of all Whonix packages (using Whonix build script).\n* By setting `whonix_signing_key_fingerprint` to `none` would results into not adding any signing key.\n* Alternatively, a signing key of ones choice could be added.\n* As for getting the local packages into the repository, that is not that simple.\n** Either one would have to upload them to some remote repository and set a custom `whonix_repository_uri`.\n** Or run a local web server and  something like `whonix_repository_apt_line=\"[trusted=yes] deb 127.0.0.1/... jessie main\"`.\n** `whonix_repository_apt_line=\"[trusted=yes] deb file:/... jessie main\"` and then somehow get the local repository mounted inside the chroot. Perhaps by hacking `04_install_qubes_post.sh`."}]},"PHID-TASK-7ahrigddkgvbseyagrny":{"id":"497","title":"extend Whonix signing key","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1461015542,"date_modified":1461015542,"content":"https://github.com/Whonix/whonix-repository/commit/04ba12a77526191ec507fd25dbcd1dba641b2123\nhttps://github.com/Whonix/whonix-repository/commit/d253d364332ca70a422d0aabbfe75caee865bcff\nhttps://github.com/Whonix/whonixcheck/commit/700134e19135b6247c835c89b9e4040fea69579f\n"},{"author":"Patrick","date_created":1461683188,"date_modified":1461683188,"content":"test new builds: ok\ntest upgraded builds: todo"},{"author":"Patrick","date_created":1461801172,"date_modified":1461801172,"content":"test upgraded builds: ok"}]},"PHID-TASK-mzeovpg3hahzidrdbnze":{"id":"496","title":"Templates incorrectly think they're not connected to a Whonix gateway.","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/templates-incorrectly-think-theyre-not-connected-to-a-whonix-gateway/2258/1","comments":[]},"PHID-TASK-dsrps3a37tlxrmjyhe46":{"id":"495","title":"Track upstream fix for QXL auto resolution bug","status":"resolved","priority":"Normal","author":"HulaHoop","description":"No upstream response to bug report: https://lists.freedesktop.org/archives/spice-devel/2016-April/028133.html\n\nFeature proposal:\n\nRunning \"xrandr --output Virtual-0 --auto\" always readjusts resolution to match window size.\n\nAutomating this command as a systemd unit (or something else?) that runs in the background every couple of seconds to compensate for the broken auto-resize feature should be good enough.","comments":[{"author":"HulaHoop","date_created":1460411656,"date_modified":1460411656,"content":"Tried making timer for the service with these settings as shown: http://jason.the-graham.com/2013/03/06/how-to-use-systemd-timers\n\nStatus: Not working.\n\n```\n#auto-res-kvm.service\n\n[Unit]\nDescription=Automatically adjusts screen resolution for QEMU-KVM guests running Grsecurity\nConditionVirtualization=kvm\n\n[Service]\nType=simple\nExecStart=/usr/bin/xrandr --output Virtual-0 --auto\n```\n\n\n```\n#auto-res-kvm.timer\n\n[Unit]\nDescription=Runs auto-res-kvm.service every 3 seconds\n\n[Timer]\n# Time between running each consecutive time\nOnUnitActiveSec=3\nUnit=auto-res-kvm.service\nAfter=auto-res-kvm.service\n\n[Install]\nWantedBy=multi-user.target\n```\n\n\nTips from working with systemd before:\n\nhttps://phabricator.whonix.org/T144\nhttps://github.com/Whonix/shared-folder-help/\nhttps://www.freedesktop.org/software/systemd/man/systemd.timer.html"},{"author":"Patrick","date_created":1460425230,"date_modified":1460425230,"content":"Doesn't the bug report belong to https://bugs.freedesktop.org/describecomponents.cgi?product=Spice?"},{"author":"HulaHoop","date_created":1460556098,"date_modified":1460556098,"content":"You're right. I opened it here:\n\nhttps://bugs.freedesktop.org/show_bug.cgi?id=94920\n\n\n***\n\nAnother idea is to have a simple bash script running this command at 5 second intervals in an infinite loop. Then have this script started at boot with a simple service file.\n\nnohup (no hangup. Used by daemons. Works even if user logs out):\nhttps://stackoverflow.com/questions/2499187/how-to-run-infinitely-script-in-background-on-linux\n\n\n\nwatch runs command repeatedly, displaying its output (the first screenfull). This allows you to watch the program output change over time. By default, the program is run every 2 seconds; use -n or --interval to specify a different interval.\n\nwatch will run until interrupted.\n\nhttps://superuser.com/questions/361902/continuously-re-execute-a-command-when-it-finishes-in-bash"},{"author":"Patrick","date_created":1460561126,"date_modified":1460561126,"content":"It's also worth a support request / bug report against grsecurity. It\nmay be their kernel which is misbehaving, therefore there issue to fix."},{"author":"HulaHoop","date_created":1460750895,"date_modified":1460776590,"content":"Done. Will post link when topic approved on their support forum.\n\nhttps://forums.grsecurity.net/viewtopic.php?f=3&t=4449"},{"author":"HulaHoop","date_created":1461899320,"date_modified":1461899320,"content":"Update:\n\nI tested a vanilla build and it has this bug. It has nothing to do with the Grsec patch set. There is no need to invest time in a workaround for an upstream bug. I am not optimistic about a fix any time soon and the Linux developers are inaccessible for user feedback.\n\nClosing."},{"author":"HulaHoop","date_created":1476112600,"date_modified":1476113320,"content":"A few months later someone confirmed the QXL bug and explained some workarounds which involve disabling KMS mode which will also require disabling important Grsecurity features.\n\nI filed an upstream ticket to get this fixed so such steps won't be needed.\n\n\nhttps://forums.grsecurity.net/viewtopic.php?f=3&t=4449#p16533\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1383425\n\n***\n\nAn unrelated bug also reported with patch form Grsec dev:\n\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1383435\nhttps://forums.grsecurity.net/viewtopic.php?f=3&t=4544"},{"author":"HulaHoop","date_created":1476192655,"date_modified":1476192655,"content":"I tried registering on https://bugs.kde.org/ to create a bug report but it seems to be blocking anonymous users from creating accounts. Patrick can you please open an account and post it on my behalf?\n\n\nTicket I wanted to post:\n\n\nAutomatic VM display resolution broken under KDE hosts\n\nThis is easy to reproduce. Running any VM guest on a KDE host will prevent it from automatically adjusting its resoltuion to fit the virt-viewer screen.\n\nRelated bug reports and suggested solution:\n\nhttps://forums.whonix.org/t/not-able-to-adjust-display-resolution-in-kvm-and-late-password-prompt-during-login/2798/4\n\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1383425\n\nThe solution is to implement handling of the monitor hotplug event in the window manager of KDE, like GNOME did in mutter and gnome-settings-daemon"},{"author":"Patrick","date_created":1476209967,"date_modified":1476209967,"content":"Against what product (component)? There is a zillion of them. List here:\nhttps://bugs.kde.org/query.cgi?format=advanced"},{"author":"HulaHoop","date_created":1476211459,"date_modified":1476211459,"content":" KDE window manager so that would be the component: kwin\n"},{"author":"Patrick","date_created":1476211959,"date_modified":1476211959,"content":"https://bugs.kde.org/show_bug.cgi?id=370494"},{"author":"Patrick","date_created":1476279103,"date_modified":1476279103,"content":"An answer was posted:\nhttps://bugs.kde.org/show_bug.cgi?id=370494#c1"},{"author":"HulaHoop","date_created":1476279332,"date_modified":1476279332,"content":"Thanks. Looks like we got a reply from the project lead Martin Gräßlin.\n\nI relayed back his suggestion to the RedHat ticket."},{"author":"Patrick","date_created":1476316802,"date_modified":1476316802,"content":">>! In T495#10722, @Patrick wrote:\n> https://bugs.kde.org/show_bug.cgi?id=370494\n\nGot another answer:\nhttps://bugs.kde.org/show_bug.cgi?id=370494#c2"},{"author":"HulaHoop","date_created":1476666710,"date_modified":1476666710,"content":"To move things along please post this:\n\nUnfortunately I run Debian Stable and it will be a while before 5.8 lands in the repo. I understand there is a lot going on that you have to handle but please try to prioritize this before the Debian Stretch freeze. "},{"author":"Patrick","date_created":1476720962,"date_modified":1476720962,"content":"Done, posted."},{"author":"Patrick","date_created":1476741065,"date_modified":1476741065,"content":"Got another answer:\nhttps://bugs.kde.org/show_bug.cgi?id=370494#c4"},{"author":"Patrick","date_created":1476807176,"date_modified":1476807176,"content":"More answers there."},{"author":"HulaHoop","date_created":1476910039,"date_modified":1476910039,"content":"Great. Looks like the libvirt devs from the other ticket are helping out!"},{"author":"Patrick","date_created":1476916576,"date_modified":1476916576,"content":"Great!"},{"author":"Patrick","date_created":1479432234,"date_modified":1479432234,"content":"https://bugs.kde.org/show_bug.cgi?id=370494 has more comments."},{"author":"Patrick","date_created":1479432284,"date_modified":1479432284,"content":"https://bugs.kde.org/show_bug.cgi?id=356864"},{"author":"HulaHoop","date_created":1479530560,"date_modified":1479530560,"content":"Awesome. The bug has been identified and fixed with backports of the fix coming to the longterm 5.8 series.\n\nThis is a good instance of upstream coop.\n\nThanks Patrick for filing it. "},{"author":"Patrick","date_created":1479577951,"date_modified":1479577951,"content":"Great!\n\nWant to close this or prefer keep open?"},{"author":"HulaHoop","date_created":1479654773,"date_modified":1479654773,"content":"Its done so will close :)"},{"author":"Patrick","date_created":1480204982,"date_modified":1480204982,"content":"https://bugs.kde.org/show_bug.cgi?id=356864 has more answers."}]},"PHID-TASK-bdapo5lv2qn64k64nwyu":{"id":"494","title":"get onion back online for whonix.org","status":"resolved","priority":"Normal","author":"Patrick","description":"We still have the key for the onion we previously had. The bug why we turned off the onion previously should be fixed by now.\n\nThe Debian mirror serving over an onion (T399) seems to work. So we should get the onion for whonix.org back online.\n\nSubdomains (phabricator.whonix.org and forums.whonix.org) are problematic. So we might just do it for www.whonix.org.\n\nBut maybe there is also a solution for sub domains? -> https://gist.github.com/mtigas/565718bbb928ce439e95\n\nDoes letsencrypt help with onions? -> T443 \n","comments":[{"author":"Patrick","date_created":1460392176,"date_modified":1460392176,"content":"Doesn't looks like we can get letsencrypt ssl for our onion yet.\n\n- https://community.letsencrypt.org/t/if-when-will-le-support-onion-addresses/341/41\n- https://github.com/letsencrypt/letsencrypt/issues/91"},{"author":"fortasse","date_created":1462127164,"date_modified":1462127164,"content":"I'm posting from http://phabricator.kkkkkkkkkk63ava6.onion/T494 :)"},{"author":"fortasse","date_created":1462129017,"date_modified":1462129478,"content":"http://phabricator.kkkkkkkkkk63ava6.onion/\nhttp://forums.kkkkkkkkkk63ava6.onion/\nhttp://kkkkkkkkkk63ava6.onion (and http://www.kkkkkkkkkk63ava6.onion)\nhttp://download.kkkkkkkkkk63ava6.onion/ (the same as https://www.whonix.org/download/)\n\nall up and running.\n\nI also updated https://www.whonix.org/w/index.php?title=Forcing_.onion_on_Whonix.org, but I'm not sure it's 100% accurate anymore. The xml posted there works pretty well for me. Phabricator is the only thing that seems to be giving trouble, the wiki and the forums appear to be perfectly happy with supplying relative path links and not redirecting back to whonix.org.\n\nI'll leave this open a while longer while we work out any issues, but it seems like things are working pretty well for me.\n"},{"author":"fortasse","date_created":1462129262,"date_modified":1462129262,"content":"If/when LE let's us get .onions on our certificate, I'll do that as well."},{"author":"HulaHoop","date_created":1463005055,"date_modified":1463005055,"content":"The onion site for the forums and wiki works great however for phabricator when logging in it still redirects to the clearnet site with an error about not being able to set a cookie for the username."},{"author":"Patrick","date_created":1463005409,"date_modified":1463005409,"content":"I think the only solution may be this one:\n\nhttps://www.whonix.org/wiki/Forcing_.onion_on_Whonix.org"},{"author":"Patrick","date_created":1463585909,"date_modified":1463585909,"content":"Works fine so far. No complaints. Closing. We can always reopen in case of issues."}]},"PHID-TASK-cy2te35hkpogm4jpfhay":{"id":"493","title":"ask TPO to merge separate repository dist http://deb.torproject.org/torproject.org/dists/obfs4proxy/ into usual dist","status":"resolved","priority":"Normal","author":"Patrick","description":"There are two separate [dists](http://deb.torproject.org/torproject.org/dists/).\n\n* http://deb.torproject.org/torproject.org/dists/jessie/\n* http://deb.torproject.org/torproject.org/dists/obfs4proxy/\n\nThis complicates T472 in case we ever want the newer obfs4proxy from TPO's repository installed on Whonix-Gateway.\n\n(Because then we would not only have to add http://deb.torproject.org/torproject.org/dists/jessie/ but also http://deb.torproject.org/torproject.org/dists/obfs4proxy/, download, reupload to Whonix repository.)\n\nTODO:\n\nAsk TPO if they could upload obfs4proxy to the usual dists (jessie, stretch, etc.) to simplify their repository.","comments":[{"author":"Patrick","date_created":1460398471,"date_modified":1460398471,"content":"`deb.torproject.org: merge obfs4proxy apt repository into regular deb.torproject.org repositories`:\nhttps://trac.torproject.org/projects/tor/ticket/18796"}]},"PHID-TASK-xmjltpeunms4unshpzle":{"id":"492","title":"research / document impact for tunnel users if Tor [exit] relays hosted at the same tunnel provider","status":"review","priority":"Normal","author":"Patrick","description":"It is possible to host Tor relays [any... bridges, entry, middle or exit] behind VPN IPs using VPN port forwarding.\n\n-----\n\nscenario 1)\n\n* a) User uses VPN IP A on the host, thereby using it as it's first relay.\n* b) User's Tor client happens to pick a Tor exit relay running on VPN IP A.\n* Conditions a and b match at the same time. The user is now using the same IP as first and last proxy.\n\n-----\n\nscenario 2)\n\n* a) User sets up a VPN inside Whonix-Workstation. Thereby that results in user -> Tor -> VPN -> internet. Using VPN IP A.\n* b) A Tor entry guard is being hosted on VPN IP A.\n* Conditions a and b match at the same time. The user is now using the same IP as first and last proxy.\n\n-----\n\nIt might result in [Tor over Tor](https://www.whonix.org/wiki/DoNot#Prevent_Tor_over_Tor_scenarios.). Needs to be through through.\n\n-----\n\ndocument where:\nhttps://www.whonix.org/wiki/Tunnels/Introduction\n\n-----\n\nTODO:\n\n* think this through\n* 1) a) Is Tor clever enough to detect and avoid such situations?\n* ask on the tor-talk mailing list","comments":[{"author":"HulaHoop","date_created":1460026274,"date_modified":1460026274,"content":"Unless the VPN operator goes out of their way to do a sybil attack, Tor already protects users from the choke-point situations you describe:\n\n\n\"Tor tries not to choose relays which might belong to the same operator.\n\n* Relay is not in the same /16 subnet. So Tor only uses one IP address in a range from 10.12.0.0 to 10.12.255.255 (10 and 12 can be any number).\n* Operators who run more than one relay should declare those relays their 'family' (There is a special option in the configuration). Tor doesn't choose more then one relay from a family.\n* A client can also set such a family option. This will also be respected.\"\n\n\nhttps://tor.stackexchange.com/a/231\n"},{"author":"Patrick","date_created":1460036758,"date_modified":1460036758,"content":"The VPN used as first or last proxy is not a relay that Tor picked. It's\nsomething the user has set up. So we cannot be sure it is covered by that.\n\nThe question can be re-phrased. \"I am running a Tor daemon in relay mode\non my computer. And I am running a separate Tor daemon in client mode.\nWill the Tor in client mode avoid using my own Tor relay?\""},{"author":"HulaHoop","date_created":1460052253,"date_modified":1460052734,"content":"\n```\nscenario 1)\n\na) User uses VPN IP A on the host, thereby using it as it's first relay.\nb) User's Tor client happens to pick a Tor exit relay running on VPN IP A.\nConditions a and b match at the same time. The user is now using the same IP as first and last proxy.\n```\n\nSimplified: VPN IP A - could be considered as any other ISP running surveilling a user. And the Tor Exit running on a VPN - a malicious exit. Some Exits are malicious but that does not break Tor.  The Exit lasts for 10 minutes. The user is safe if the Tor Guard is OK. That is the most common situation anyway.\n\n\n```\nscenario 2)\n\na) User sets up a VPN inside Whonix-Workstation. Thereby that results in user -> Tor -> VPN -> internet. Using VPN IP A.\nb) A Tor entry guard is being hosted on VPN IP A.\nConditions a and b match at the same time. The user is now using the same IP as first and last proxy.\n```\n\nSimplified: Malicious guard is pretty bad but on its own is not enough to deanonymize. As long as the Tor Exit is not also cooperating with the same party as the one hosting the Guard - Tor should not fail.\n\n```\nI am running a Tor daemon in relay mode\non my computer. And I am running a separate Tor daemon in client mode.\nWill the Tor in client mode avoid using my own Tor relay?\n```\n\nThis is a third (and different) scenario. \n\n[fr33d0m4all] You can explicitly configure Tor client to exclude your own node by using ExcludeNodes and specifying the ID of your relay\n[fr33d0m4all] user: ExcludeNodes node,node,…\n[fr33d0m4all] A list of identity fingerprints, country codes, and address patterns of nodes to avoid when building a circuit. Country codes must be wrapped in braces; fingerprints may be preceded by a dollar sign. (Example: ExcludeNodes ABCD1234CDEF5678ABCD1234CDEF5678ABCD1234, {cc}, 255.254.0.0/8)\n\n```\n1) a) Is Tor clever enough to detect and avoid such situations?\n```\n\nTor cannot detect something outside its network but a newer research version takes AS path selection and network adversaries into account when creating circuits. Based on this research: \n\nhttp://freehaven.net/anonbib/cache/DBLP:conf/ccs/EdmanS09.pdf\nhttp://freehaven.net/anonbib/cache/oakland2012-lastor.pdf\n\nEDIT:\n\nIts called ASToria\n\nhttp://arxiv.org/pdf/1505.05173.pdf\nhttps://github.com/sbunrg/Astoria/tree/master/astoria-tor-client\nhttps://www.dailydot.com/politics/tor-astoria-timing-attack-client/"},{"author":"Patrick","date_created":1460055303,"date_modified":1460055303,"content":">>! In T492#8634, @HulaHoop wrote:\n> \n> ```\n> scenario 1)\n> \n> a) User uses VPN IP A on the host, thereby using it as it's first relay.\n> b) User's Tor client happens to pick a Tor exit relay running on VPN IP A.\n> Conditions a and b match at the same time. The user is now using the same IP as first and last proxy.\n> ```\n> \n> Simplified: VPN IP A - could be considered as any other ISP running surveilling a user. And the Tor Exit running on a VPN - a malicious exit. Some Exits are malicious but that does not break Tor.  The Exit lasts for 10 minutes. The user is safe if the Tor Guard is OK. That is the most common situation anyway.\n\nConsidering it an ISP is a category mistake. You cannot go up to that threat model for the sake of the argument. Because Tor entry guards in the first place defeat only a weaker threat model, where an adversary hosts malicious Tor entry guards. The original case for Tor entry guards was to that your chances are better if you stick to the Tor entry guards. From the point of view, the ISP can be considered a permanent entry.\n\nAfaik, Tor is most vulnerable if the adversary controls the first and the last relay and runs an end-to-end correlation attack. That's one reason why it's 3 and not 4 hops in Tor. Because those in the middle are less important. This is why Tor tries to avoid using a relay by the same host more than once in its chain.\n\n> \n> ```\n> scenario 2)\n> \n> a) User sets up a VPN inside Whonix-Workstation. Thereby that results in user -> Tor -> VPN -> internet. Using VPN IP A.\n> b) A Tor entry guard is being hosted on VPN IP A.\n> Conditions a and b match at the same time. The user is now using the same IP as first and last proxy.\n> ```\n> \n> Simplified: Malicious guard is pretty bad but on its own is not enough to deanonymize. As long as the Tor Exit is not also cooperating with the same party as the one hosting the Guard - Tor should not fail.\n\nAfter the Tor exit, it connects to the VPN before connecting to the destination. For practical purposes, is the VPN to be considered an extension of the Tor chain? Fact remains, that you are connecting to a server hosted by the same provider twice in your chain. That should make certain attacks easier. Perhaps some passive attacks. More certainly it allows to run active attacks. By tampering with the traffic at the earliest link in the chain, i.e. by adding a artificial delay, these effects could be measured at latest link in the chain. A more rough attack would be to selectively not serve most but one user [or delay] until there is a correlation.\n\nIt may not be the end of the world, but something useful to avoid.\n\n> ```\n> I am running a Tor daemon in relay mode\n> on my computer. And I am running a separate Tor daemon in client mode.\n> Will the Tor in client mode avoid using my own Tor relay?\n> ```\n> \n> This is a third (and different) scenario. \n> \n> [fr33d0m4all] You can explicitly configure Tor client to exclude your own node by using ExcludeNodes and specifying the ID of your relay\n> [fr33d0m4all] user: ExcludeNodes node,node,…\n> [fr33d0m4all] A list of identity fingerprints, country codes, and address patterns of nodes to avoid when building a circuit. Country codes must be wrapped in braces; fingerprints may be preceded by a dollar sign. (Example: ExcludeNodes ABCD1234CDEF5678ABCD1234CDEF5678ABCD1234, {cc}, 255.254.0.0/8)\n\nYou can certainly exclude it manually. But that was not the question. Good to have this information so it can be incorporated when asking the question. Because I am not looking for a workaround here that may or may not be needed. An authoritative answer would be useful since we are trying to establish a negative here. (\"No, Tor does not figure out it's external IP and then tries to avoid using other relays hosted within the same /16 subnet.\")\n"},{"author":"Patrick","date_created":1467932640,"date_modified":1467932640,"content":"`Tor routing algorithm questions`:\nhttps://lists.torproject.org/pipermail/tor-talk/2016-July/041753.html"},{"author":"Patrick","date_created":1467977042,"date_modified":1467977042,"content":"answer by Roger:\nhttps://lists.torproject.org/pipermail/tor-talk/2016-July/041756.html"},{"author":"Patrick","date_created":1467978597,"date_modified":1467978597,"content":"tor-talk discussion:\n`using a VPN, proxy or ssh can make you actually less anonymous`:\nhttps://lists.torproject.org/pipermail/tor-talk/2016-July/041757.html"},{"author":"Patrick","date_created":1468599246,"date_modified":1468599246,"content":"Now documented here, please check contents and clarity:\nhttps://www.whonix.org/wiki/Tunnels/Introduction#Introduction\n"},{"author":"HulaHoop","date_created":1468639326,"date_modified":1468639326,"content":"Maybe add a note that there is Tor research on picking routes through Autonomous Systems and IXPs less likely to be surveilled. \n\nSomewhat related:\n\nIf this is as dangerous as you think then people using meek-google are completely hosed? Worth asking IMO.\n\n\nNote that for correlation attacks to work they must be running the nodes themselves not merely looking at them from the outside. Though avoiding the latter is still better.\n"}]},"PHID-TASK-ztlujvszddqvfbko5n25":{"id":"491","title":"port whonixcheck and tb-updater to Qubes qrexec based updates proxy","status":"resolved","priority":"Normal","author":"Patrick","description":"[Since in Qubes 4.0, TemplateVMs will be non-networked by default](https://github.com/QubesOS/qubes-issues/issues/1858):\n\n* #whonixcheck and\n* #tb-updater \n\nNeed to be ported to [qrexec based updates proxy](https://github.com/QubesOS/qubes-issues/issues/1854).","comments":[{"author":"Patrick","date_created":1471564386,"date_modified":1471564386,"content":"Since the [recent batch](https://forums.whonix.org/t/whonixcheck-whonix-14-ideas/2456/8?u=patrick) of whonixcheck commits, the only thing to do is modifying the operating systems updates check.\n\nHowever, that is not possible to implement this at the moment. I have to see how https://github.com/QubesOS/qubes-issues/issues/1858 will be implemented.\n\nI will recheck this for every release of Whonix."},{"author":"marmarek","date_created":1505940228,"date_modified":1505940228,"content":"Since https://github.com/Whonix/qubes-whonix/commit/01964e3c8c53b49aa14e56f7924fce5e88b5a448, other places can simply source `/usr/lib/qubes-whonix/utility_function.sh` and use `PROXY_SERVER` variable to get appropriate proxy address."},{"author":"Patrick","date_created":1508506055,"date_modified":1508506071,"content":"https://github.com/Whonix/whonixcheck/blob/Whonix13/usr/lib/whonixcheck/check_qubes.bsh\n\nis already using\n\n```\n   source /usr/lib/qubes-whonix/utility_functions.sh\n\n   if [ \"$qubes_vm_type\" = \"NetVM\" ] || [ \"$qubes_vm_type\" = \"ProxyVM\" ]; then\n      PROXY_SERVER=\"${PROXY_SERVER/10.137.255.254/127.0.0.1}\"\n   fi\n```\n\nand it works. Just now tested.\n\nShould be good enough?\n\nRelated: T723\n"},{"author":"marmarek","date_created":1508506388,"date_modified":1508506388,"content":"Is that changing to 127.0.0.1 work on Qubes 3.2? Anyway, yes, it should be good enough for Qubes 4.0."},{"author":"Patrick","date_created":1508506953,"date_modified":1508506953,"content":">>! In T491#14667, @marmarek wrote:\n> Is that changing to 127.0.0.1 work on Qubes 3.2?\n\nIt's to make the test work in sys-whonix as well.\n\n> Anyway, yes, it should be good enough for Qubes 4.0.\n\nGreat!"},{"author":"Patrick","date_created":1508506997,"date_modified":1508506997,"content":"Here is the fix for tb-updater. Please have a look. Untested. Will test now. If it works, I will backport to Whonix 13 tb-updater.\n\nhttps://github.com/Whonix/tb-updater/commit/1ce837d7b0341e5a7d78751cb1b44d7241f0d217"},{"author":"Patrick","date_created":1508507817,"date_modified":1508507817,"content":"Backported to Whonix 13 tb-updater.\n\nhttps://github.com/Whonix/tb-updater/commit/20707be7d474ec6181343d0626e503841c0b839b\n\nAnd other fix required.\n\nhttps://github.com/Whonix/tb-updater/commit/e3ac6e23c954c99885b1710cfe3ecfc1e7c49bac\n\nAnd while we are at it.\n\nhttps://github.com/Whonix/tb-updater/commit/229efa817cda7e468994a6bb77cbacdae1fe473a"},{"author":"Patrick","date_created":1508508125,"date_modified":1508508125,"content":"tb-updater fix for Whonix 14 / master.\n\nhttps://github.com/Whonix/tb-updater/commit/f331f2b3073743f0a6e1f21a53415e068563be43\n"}]},"PHID-TASK-4vkp3v3gyugvzxve5sua":{"id":"490","title":"whonixcheck should test if network interfaces are up","status":"resolved","priority":"Normal","author":"Patrick","description":"    sudo ifconfig eth0\n    sudo ifconfig eth1\n\nOtherwise the first test that fails would be the check Tor pid test, which is not so useful. (Tor failing to start would only be a follow up error caused by the network interfaces that may be down.)","comments":[{"author":"Patrick","date_created":1459461784,"date_modified":1459461784,"content":"https://github.com/Whonix/whonixcheck/commit/142621dc7ecec233a99d674e5d9a0e342b176660"}]},"PHID-TASK-blzb4bbnoaaq7n6h6bqq":{"id":"489","title":"upgrade from curl usage from --tlsv1 to --tlsv1.2","status":"resolved","priority":"Normal","author":"Patrick","description":"Works:\n\n```\ncurl --tlsv1.2 --proto =https https://www.torproject.org/projects/torbrowser/RecommendedTBBVersions\n```\n\n-----\n\n~~Does not work with check.torproject.org~~\n\n~~Tor Project upstream bug report:~~\n~~trac.torproject.org/projects/tor/ticket/13972~~\n\n-----\n\nTODO:\n\n* recheck after port to #Debian_Stretch if there are any newer curl TLS options\n* ~~enable higher TLS versions for #whonixcheck / https://check.torproject.org for #whonix_14~~","comments":[{"author":"Patrick","date_created":1459458442,"date_modified":1459459306,"content":"Done as far as possible for now.\n\n- https://github.com/Whonix/tb-updater/commit/26172f8d132cb059fa5fb7584fb99feabcbfb7fb\n- https://github.com/Whonix/scurl/commit/11aa4822b227084debf69099be600e8845062766\n* https://github.com/Whonix/whonixcheck/commit/774af24282a2bf18697a4dfabb82f6e7c83ff365\n* https://github.com/Whonix/whonixcheck/commit/dd81a2841948e63e1a30d03038ab458699c2ed31"},{"author":"entr0py","date_created":1465008932,"date_modified":1465008932,"content":"Upstream ticket fixed as of 05/2016.\n\nhttps://check.torproject.org now supports TLS v1.2."},{"author":"Patrick","date_created":1465426627,"date_modified":1465426627,"content":"https://github.com/Whonix/whonixcheck/commit/599b43e95085b8b741df8d0583ca1e2d554b50bb\n\nDone for Whonix 14. Recheck for Debian Stretch if there are any newer TLS versions."},{"author":"Patrick","date_created":1484731647,"date_modified":1484731647,"content":"No newer options in stretch.\n\nFollow up task:\nT609"}]},"PHID-TASK-d7b3xbhid26yorkxnk4y":{"id":"488","title":"whonixcheck should test for failed daemons","status":"resolved","priority":"Normal","author":"Patrick","description":"At least when using `--verbose`. Useful during testing new builds and after upgrades. Not sure it's useful in normal mode.\n\n```\nsudo systemctl list-units --failed\n```\n\nOr a somehow better machine readable command.\n\nSome daemons are expected to fail such as AppArmor in Qubes (since not enabled there by default).","comments":[{"author":"Patrick","date_created":1471215288,"date_modified":1471215288,"content":"https://github.com/Whonix/whonixcheck/commit/b8a3cc9cadc3c3d45dddebf9b7c9e6d559691084"},{"author":"Patrick","date_created":1471216803,"date_modified":1471216803,"content":"* https://github.com/Whonix/qubes-whonix/commit/e6c261f1a2aba563696b5f8eac10070ca0bad9ab\n* https://github.com/Whonix/whonixcheck/commit/c9fa6b72cc72741eabd651af24ad871724d17267\n* https://github.com/Whonix/whonixcheck/commit/be677f9964a7318b1034a1b2060ff83cd08f1f08\n"}]},"PHID-TASK-w4s7a4zwtnzanvswulam":{"id":"487","title":"port to netfilter-persistent?","status":"open","priority":"Normal","author":"Patrick","description":"* port to [netfilter-persistent](https://packages.debian.org/jessie/netfilter-persistent)?\n** It might be more appropriate to get the firewall loaded before any networking gets up than [whonix-firewall.service](https://github.com/Whonix/whonix-gw-firewall/blob/master/lib/systemd/system/whonix-firewall.service).\n** Could therefore simplify the setup, and\n** allow additional custom/extension-package firewall rules being load before and after Whonix Firewall.\n\n-----\n\n* NOT [iptables-persistent](https://packages.debian.org/iptables-persistent)\n** (which is more useful to local system administrators rather than distribution maintainers)\n\n-----\n\n```\ncat /usr/share/doc/netfilter-persistent/README\nnetfilter-persistent and its plugins\n------------------------------------\n\nnetfilter-persistent does no work on its own. You need the accompanying\nplugins (for example, iptables-persistent) to load and save filter rules.\n\nHowever, commands are run from netfilter-persistent. For example, to save\nall filter rules:\n\n   netfilter-persistent save\n\nor to load them:\n\n   netfilter-persistent start\n\nFor more details, see `man netfilter-persistent`.\n\nThe system service will try to load rules at startup if enabled, but by\ndefault it will not flush rules at shutdown. This behaviour can be changed\nby editing /etc/default/netfilter-persistent.\n\n -- Jonathan Wiltshire <jmw@debian.org>  Sat, 02 Jan 2016 00:00:00 +0000\n```\n\n-----\n\n```\nDESCRIPTION\n       netfilter-persistent uses a set of plugins to load, flush and save netfilter rules at boot and halt time.  Plugins can be written in any suitable language and stored in\n       /usr/share/netfilter-persistent/plugins.d\n```\n\n```\nPLUGINS\n       Plugins  can  be written in any language and are merely executed by netfilter-persistent with a single argument.  All plugins are stored in /usr/share/netfilter-persis‐\n       tent/plugins.d\n\n       Plugins must implement the start flush and save arguments and must not rely on additional arguments for other functionality.\n       Plugins must return 0 on success and any other code on failure.\n\n       Plugins are free to use and extend the configuration in /etc/default/netfilter-persistent and to implement their own configuration files.\n```\n\n-----\n\n* ~~[netfilter-persistent loads firewall rules too late](http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=829640)~~\n* [netfilter-persistent systemd service does not lock the network if netfilter-persistent wrapper is failing at system bootup](http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=829752)\n* [add dpkg trigger for /usr/share/netfilter-persistent/plugins.d folder to have newly installed plugins take effect](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=824290)\n\n-----\n\n__related__:\n\nsystemd feature request:\n[please provide a firewall scripts drop-in folder](https://github.com/systemd/systemd/issues/3661)","comments":[{"author":"rAntOCauDgb","date_created":1459215902,"date_modified":1459215902,"content":"Would porting to netfilter-persistent negate any need for a (development time) iptables-dump diff'ing facility, or such's (potential) whonixcheck use if such were ever integrated into whonixcheck? i.e. Before I start prodding at a iptables-dump diff'ing facility [to my mind a precursor to this task, as a sanity check facility for this task], instead of zigging towards an iptables-save basis for such, should I be zagging deeper into netfilter-persistent as it already contains within it the desired functionality?"},{"author":"Patrick","date_created":1459262693,"date_modified":1459262693,"content":">>! In T487#8482, @rAntOCauDgb wrote:\n> Would porting to netfilter-persistent negate any need for a (development time) iptables-dump diff'ing facility,\n\nI don't think so.\n\nhttps://forums.whonix.org/t/bolt-on-for-whonix-firewall-best-place-to-put-files/2222/26?u=patrick\n\n> instead of zigging towards an iptables-save basis for such, should I be zagging deeper into netfilter-persistent as it already contains within it the desired functionality?\n\nnetfilter-persistent doesn't have this feature. It's rather simple. In a nutshell:\n\n* it runs before network systemd target\n* runs programs/scripts in a `.d` folder with an argument\n"},{"author":"rAntOCauDgb","date_created":1459304858,"date_modified":1459304953,"content":"OK. Thanks.\n\nThen, note to selves - any replacement functionality will have to be able to duplicate whonix_firewall / this's ability to run after boot and re-reset iptables. Running whonix_firewall while running is wonderfully reassuring to reset iptables after beating upon it. Presumably this would be by whonix_firewall being replaced with something that calls the same thing systemd triggers at boot.\n\nFrom Patrick's original comments, the advantage to netfilter-persistent over current would be that there is currently a theoretical deficiency in whonix_firewall in terms of flexibility of sucking in (hook) functionality at multiple points, and this flexibility is already present in netfilter-persistent. Thus, rather than reinventing the wheel with hooks in whonix_firewall, migrate whonix_firewall to netfilter-persistent. ([He] Proposed.)"},{"author":"Patrick","date_created":1467746616,"date_modified":1509925139,"content":"netfilter-persistent may not be ready for prime time.\n\nnetfilter-persistent bug reports:\n\n* ~~[netfilter-persistent loads firewall rules too late](http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=829640)~~\n* [netfilter-persistent systemd service does not lock the network if netfilter-persistent wrapper is failing at system bootup](http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=829752)\n\nnetfilter-persistent feature request:\n\n* [add dpkg trigger for /usr/share/netfilter-persistent/plugins.d folder to have newly installed plugins take effect](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=824290)\n\n-----\n\nsystemd feature request:\n[please provide a firewall scripts drop-in folder](https://github.com/systemd/systemd/issues/3661)\n\nnetfilter feature request:\n[please provide a firewall scripts drop-in folder](https://bugzilla.netfilter.org/show_bug.cgi?id=1078)"},{"author":"Patrick","date_created":1476283139,"date_modified":1476283139,"content":"netfilter-persistent still has too many issues. And I doubt it will be ready for Whonix 14. In meanwhile [whonix-firewall.service](https://github.com/Whonix/whonix-gw-firewall/blob/master/lib/systemd/system/whonix-firewall.service) will do. Maybe some day."}]},"PHID-TASK-kospa46pjwtqky3y6tdg":{"id":"486","title":"Disable conntrack helper?","status":"open","priority":"Normal","author":"Patrick","description":"`cat /proc/sys/net/netfilter/nf_conntrack_helper`\n\nReasoning:\nhttps://mailman.boum.org/pipermail/tails-dev/2014-December/007537.html\n\nPerhaps useful:\nhttps://labs.riseup.net/code/issues/11391\n\nTODO:\n\n* test this for a while and see if anything major breaks\n* disable `nf_conntrack_helper`","comments":[{"author":"HulaHoop","date_created":1459294620,"date_modified":1459294620,"content":"Very dangerous feature that allows a bunch of unsafe protocols to be parsed in the kernel when they have no business there:\n\nhttps://home.regit.org/netfilter-en/secure-use-of-helpers/\n\n\nWill you disable it by blacklisting the module before it loads:\n\nmodprobe nf_conntrack nf_conntrack_helper=0\n\n\nor with sysctl after it loads?\n \necho 0 > /proc/sys/net/netfilter/nf_conntrack_helper"},{"author":"Patrick","date_created":1459295287,"date_modified":1459295287,"content":"Not using `echo`, that would be a non-ideal implementation.\n\nProbably using `/etc/sysctl.d` should be appropriate, well auditable,\nconfigurable."},{"author":"HulaHoop","date_created":1459314789,"date_modified":1459314789,"content":"Found it. The sysctl.d paramter is:\n\nnet.netfilter.nf_conntrack_helper =0\n\n\nI think its best if the tcp-timestamps-disable package is extended as a general hardening package for the network and its name changed to someything like \"safe-networking\" instead.\n\nI am willing to change the name in every other package's depends section if there is a way enumerate them all."},{"author":"HulaHoop","date_created":1459352289,"date_modified":1459352289,"content":"tcp-timestamps-disable\nReverse Depends:\n  anon-shared-packages-dependencies\n"},{"author":"Patrick","date_created":1459364440,"date_modified":1459364440,"content":"Should we also disable conntrack helper in Qubes? @marmarek\n\nI was wondering if the tcp-timestamps-disable package should be merged\ninto the security-misc package. Disabling conntrack helper might fit\ninto the security-misc package?"},{"author":"marmarek","date_created":1459365084,"date_modified":1459365084,"content":"> Should we also disable conntrack helper in Qubes?\n\nI think so.\n\n> I was wondering if the tcp-timestamps-disable package should be merged\n> into the security-misc package. Disabling conntrack helper might fit\n> into the security-misc package?\n\nGood idea."},{"author":"HulaHoop","date_created":1459395018,"date_modified":1459395018,"content":"I added the changes to security-misc. I formatted debian/control to follow packaging rules but the formatting looks ugly in the README.\n\nI looked for a anon-shared-packages-dependencies metapackage to change dependencies but couldn't find it.\n\nAfter these small tweaks tcp-timestamps-disable can be deleted - I can't do a pull for that."},{"author":"Patrick","date_created":1459395829,"date_modified":1459395829,"content":"So we should do this for #Whonix13 already? Might be doable.\n\nDid you try enabling this setting in your Whonix VMs and host yet? Did\nit cause any obvious issues?\n\nHulaHoop (HulaHoop):\n>   I looked for a anon-shared-packages-dependencies metapackage to change dependencies but couldn't find it.\n\nUse grep from the Whonix source code folder.\n\ngrep --exclude-dir=.git -r tcp-timestamps-disable\n\nIt's here:\n\nhttps://github.com/Whonix/anon-meta-packages/blob/9bf7e5764d80bc449de285552acb2c33b839aa15/debian/control#L23"},{"author":"Patrick","date_created":1459395916,"date_modified":1459395916,"content":"https://github.com/Whonix/security-misc/pull/1"},{"author":"Patrick","date_created":1459396380,"date_modified":1459396380,"content":">>! In T486#8529, @HulaHoop wrote:\n> I formatted debian/control to follow packaging rules but the formatting looks ugly in the README.\n\nThe README.md can be automatically generated from debian/control. (Also should be. Otherwise these have to be manually merged upon next run of the auto generator.)\n\nHow?\n\nGet into Whonix folder packages/[whonix-developer-meta-files](https://github.com/Whonix/whonix-developer-meta-files)\n\nGeneral overview. (No other documentation. Requires reading the source and it's supposed to be used by devs only.)\n\n    ./debug-steps/packaging-helper-script\n\nReadme creation.\n\n    ./debug-steps/packaging-helper-script pkg_readme_creator\n"},{"author":"HulaHoop","date_created":1459436161,"date_modified":1459436161,"content":"> So we should do this for #Whonix13 already? Might be doable.\n\nYes its worth it.\n\n\n> Did you try enabling this setting in your Whonix VMs and host yet? Did\nit cause any obvious issues?\n\nTried it with no negative effects so far.\n\n\n> The README.md can be automatically generated from debian/control.\n\nI just wanted to check with you debian/control looks good.\n\n\nFixed dependencies."},{"author":"Patrick","date_created":1459438424,"date_modified":1459438424,"content":"Please post your links to the pull requests so everyone can keep track of them (and in case github mailer does not work).\n\nhttps://github.com/Whonix/anon-meta-packages/pull/1\n\n-----\n\n> Fixed dependencies.\n\nThere is no point to have both anon-shared-packages-dependencies and anon-shared-packages-recommended depend on security-misc. Should just be one or the other. Otherwise if you keep enforcing the duplicate dependency we would have to do that for a lot other packages also and that does seem counter useful."},{"author":"Patrick","date_created":1459439807,"date_modified":1459439807,"content":"Don't copy from github web - it eats formatting such as leading spaces. If anything, copy from gitub raw, or for better security directly from local file.\n\n-----\n\n* https://github.com/Whonix/security-misc/commit/d5e61eb4b12106f9ee3fdf8938686e89a8c7e465\n* https://github.com/Whonix/security-misc/commit/9d7ad9e97ed6b341e72ed6d6d2104c840c73b37f\n"},{"author":"Patrick","date_created":1459439913,"date_modified":1459439913,"content":"https://github.com/Whonix/Whonix/commit/2082200bd6bda6442bb36ec6f849f1b30c87233c"},{"author":"Patrick","date_created":1461262234,"date_modified":1461262234,"content":"Doesn't work. The file is in place.\n\nhttps://github.com/Whonix/security-misc/blob/master/etc/sysctl.d/nf_conntrack_helper.conf\n\nYet, conntrack still is enabled!\n\n```\ncat /proc/sys/net/netfilter/nf_conntrack_helper\n```\n```\n1\n```\n\nThe config file notation `net.netfilter.nf_conntrack_helper=0` vs `net.netfilter.nf_conntrack_helper = 0` does not make a difference. (But as per other files in `/etc/sysctl.d` both formats should work.)\n\nAny idea?"},{"author":"HulaHoop","date_created":1461340280,"date_modified":1461340334,"content":"Looks like disabling the helper is more complicated because of module dependencies:\nhttps://github.com/regit/secure-conntrack-helpers/blob/master/secure-conntrack-helpers.rst\n\nInstructions: Disable Helper by default\n\nAnother module \"nf_conntrack\" has to be blacklisted in modprobe .\n"},{"author":"Patrick","date_created":1461614736,"date_modified":1461614736,"content":"`How to disable conntrack protocol parsing in the linux kernel?`:\nhttp://security.stackexchange.com/questions/121513/how-to-disable-conntrack-protocol-parsing-in-the-linux-kernel"},{"author":"Patrick","date_created":1461626899,"date_modified":1461626899,"content":"Disabled for now as it needs more work.\n\nhttps://github.com/Whonix/security-misc/commit/192d1e0cee505a59c5f62d01022562b12ca6646e\n\nI am also wondering if we are chasing a ghost here. As long as we are not using `--helper ftp` or similar, the protocol parser code might not be used.\n\nAlso in [/usr/bin/whonix_firewall](https://github.com/Whonix/whonix-gw-firewall/blob/master/usr/bin/whonix_firewall) we are using `-m conntrack`. So totally disabling conntrack may not be possible."},{"author":"HulaHoop","date_created":1461686709,"date_modified":1461686709,"content":"That explains it. If iptables rules rely on the module it will be enabled: https://serverfault.com/a/73087. Also there are tips on the web to make iptables rules more DoS resistant by disabling conntracking. Is it possible to replace these rules or are they necessary?\n\n\nWhat I understand from Jacob's message is that by having this module enabled you expose all the code paths to malicious input."},{"author":"marmarek","date_created":1461704974,"date_modified":1461704974,"content":"I think blacklisting specific conntrack helpers modules should be\nenough. After all we want to disable protocols parsing code, not the\nconntrack itself. Also adding appropriate check to whonixcheck is a good\nthing."},{"author":"Patrick","date_created":1464988281,"date_modified":1464988281,"content":"https://labs.riseup.net/code/issues/11391"},{"author":"Patrick","date_created":1476116278,"date_modified":1476116278,"content":"https://github.com/Whonix/security-misc/commit/6cda8b1496795422d4c0bfcea2ea2bf29c32daa0"},{"author":"Patrick","date_created":1482099458,"date_modified":1482099458,"content":"I don't know what to think of this which warns of conntrack... https://lists.torproject.org/pipermail/tor-talk/2016-December/042717.html\n\nBut anyhow. If less attack surface can be exposed in the kernel... Maybe we can not only get rid of conntrack helpers but also of conntrack generally.\n\nThe remaining use of conntrack in Whonix...\n\n----\n\nWhonix generally:\n\nMay not be wise to remove...\n\n```\n## https://lists.torproject.org/pipermail/tor-talk/2014-March/032507.html\n$iptables_cmd -A OUTPUT -m conntrack --ctstate INVALID -j REJECT --reject-with icmp-admin-prohibited\n$iptables_cmd -A OUTPUT -m state --state INVALID -j REJECT --reject-with icmp-admin-prohibited\n```\n\nMay not be possible to remove...\n\n```\n $iptables_cmd -A INPUT -m state --state ESTABLISHED -j ACCEPT\n```\n\n\n----\n\nQubes-Whonix for updates proxy only:\n\nRemoving those works fine... Those both have pros and cons so hard to make a decision.\n\n```\n$iptables_cmd -t nat -A OUTPUT -p udp -m owner --uid-owner tinyproxy -m conntrack --ctstate NEW -j DNAT --to \"127.0.0.1:${DNS_PORT_GATEWAY}\"\n```\n```\n$iptables_cmd -t nat -A OUTPUT -p tcp -m owner --uid-owner tinyproxy -m conntrack --ctstate NEW -j DNAT --to \"127.0.0.1:${TRANS_PORT_GATEWAY}\"\n```\n```\n$iptables_cmd -t nat -A OUTPUT -p udp -m owner --uid-owner vm-updates -m conntrack --ctstate NEW -j DNAT --to \"127.0.0.1:${DNS_PORT_GATEWAY}\"\n```\n```\n$iptables_cmd -t nat -A OUTPUT -p tcp -m owner --uid-owner vm-updates -m conntrack --ctstate NEW -j DNAT --to \"127.0.0.1:${TRANS_PORT_GATEWAY}\"\n```"},{"author":"marmarek","date_created":1482107888,"date_modified":1482107888,"content":">>! In T486#11057, @Patrick wrote:\n> I don't know what to think of this which warns of conntrack... https://lists.torproject.org/pipermail/tor-talk/2016-December/042717.html\n\nI think it's a wrong link.\n\n> But anyhow. If less attack surface can be exposed in the kernel... Maybe we can not only get rid of conntrack helpers but also of conntrack generally.\n\nDoesn't NAT use conntrack too?\n\n> May not be possible to remove...\n> \n> ```\n>  $iptables_cmd -A INPUT -m state --state ESTABLISHED -j ACCEPT\n> ```\n\nYes, this would be hard to replace with anything else (if possible at all). "},{"author":"HulaHoop","date_created":1482109923,"date_modified":1482109923,"content":">I think it's a wrong link.\n\nTrue. It think Patrick meant this message which mentions conntrack.\n\nhttps://lists.torproject.org/pipermail/tor-talk/2016-December/042710.html\n\nMaybe the guy is talking about conntrack helper, which we've known to be problematic for some time now."}]},"PHID-TASK-fybcvzrxm5dmfgxce6fu":{"id":"485","title":"whonix-host-qemu-kvm package has an unmet dependency. Depends: whonix-host-shared but is not installable","status":"invalid","priority":"Wishlist","author":"Lobster","description":"After adding \"deb [[http://mirror.whonix.de/whonixdevelopermetafiles/internal/]] jessie main\" to my apt sources and performing an apt-get update, I get the following error while trying to install the whonix-host-qemu-kvm package:\n\n> root@debian:/home/user# apt-get install whonix-host-additions whonix-host-qemu-kvm\n> Reading package lists... Done\n> Building dependency tree       \n> Reading state information... Done\n> Some packages could not be installed. This may mean that you have\n> requested an impossible situation or if you are using the unstable\n> distribution that some required packages have not yet been created\n> or been moved out of Incoming.\n> The following information may help to resolve the situation:\n> \n> The following packages have unmet dependencies:\n> whonix-host-qemu-kvm : Depends: whonix-host-shared but it is not installable\n> E: Unable to correct problems, you have held broken packages.\n\n[[http://mirror.whonix.de/whonixdevelopermetafiles/internal/dists/jessie/main/binary-amd64/Packages]] lists no whonix-host-shared package (but a whonix-host-shared-dependencies package, maybe that was meant?)\n\nMy system accoring to uname -a (if that is relevant)\n> Linux debian 3.16.0-4-amd64 #1 SMP Debian 3.16.7-ckt20-1+deb8u3 (2016-01-17) x86_64 GNU/Linux","comments":[{"author":"Patrick","date_created":1458739112,"date_modified":1458739112,"content":"That package and that usage of the Whonix repository is not ready and it is unclear it will ever be."},{"author":"Patrick","date_created":1556015818,"date_modified":1556015818,"content":"No such package anymore."}]},"PHID-TASK-f5ynactrjdhrvqxsgpyh":{"id":"484","title":"Template:Apt-Pinning vs Template:Install_Backport","status":"resolved","priority":"Normal","author":"Patrick","description":"- https://www.whonix.org/wiki/Template:Apt-Pinning\n- https://www.whonix.org/wiki/Special:WhatLinksHere/Template:Apt-Pinning\n\n- https://www.whonix.org/wiki/Template:Install_Backport\n- https://www.whonix.org/wiki/Special:WhatLinksHere/Template:Install_Backport\n\n- https://www.whonix.org/wiki/Install_Software#Backports\n- https://www.whonix.org/wiki/Money#Electrum\n\nTODO:\n\n* The https://www.whonix.org/wiki/Install_Software page should use Template:Apt-Pinning somewhere to explain apt pinning.\n* Do we want to keep Template:Install_Backport for one time package install from backports? Will it be kept up to date?\n* Or should Template:Install_Backport be integrated into and replaced by Template:Apt-Pinning?","comments":[{"author":"HulaHoop","date_created":1458656870,"date_modified":1458656870,"content":"I am for integrating backports into apt-pinning. To not overcrowd the template the apt-get -t branch install part is left out and depends on what is being installed."},{"author":"Patrick","date_created":1458739871,"date_modified":1458739871,"content":"Ok."},{"author":"HulaHoop","date_created":1458770537,"date_modified":1458770537,"content":"Done."},{"author":"Patrick","date_created":1458838456,"date_modified":1458838456,"content":"https://www.whonix.org/wiki/Next still uses Template:Install_Backport."}]},"PHID-TASK-v5nh3kk26tn5lu7vtajx":{"id":"483","title":"test - delete this","status":"invalid","priority":"Normal","author":"adretest","description":"test descr","comments":[]},"PHID-TASK-kd2qj7lbdoenyemmo6t4":{"id":"482","title":"whonixcheck should test for slow / fast clock","status":"resolved","priority":"Normal","author":"Patrick","description":"`/var/run/tor/log` might include.\n\n> Mar 20 01:01:02.000 [warn] Our clock is 1 days, 12 hours, 58 minutes behind the time published in the consensus network status document (2016-03-21 14:00:00 UTC).  Tor needs an accurate clock to work correctly. Please check your time and date settings!\n\nProbably the most common cause for connection issues. Would have been useful for the following two tickets.\n\n- https://github.com/QubesOS/qubes-issues/issues/1779\n- https://github.com/QubesOS/qubes-issues/issues/1764\n\nUntil sdwdate gets this feature (T151), a simple #whonixcheck test would be useful. Since Tor provides no great interface for this... [anondate](https://www.whonix.org/wiki/Dev/TimeSync#anondate) will be required for that purpose.\n\nBarely related:\nT480\n","comments":[{"author":"Patrick","date_created":1458638416,"date_modified":1458638416,"content":"https://github.com/Whonix/whonixcheck/commit/1411d7c3d2b3cb55c501c30c102321ef419e97d1"},{"author":"Patrick","date_created":1458643172,"date_modified":1458643172,"content":"https://github.com/Whonix/whonixcheck/commit/66d666aef612009a0d64e5694ab9967ccb821d6c\nhttps://github.com/Whonix/whonixcheck/commit/66d666aef612009a0d64e5694ab9967ccb821d6c\nhttps://github.com/Whonix/whonixcheck/commit/ec227cd50d3d663dfe2451b166310c4b8c91d701\nhttps://github.com/Whonix/whonixcheck/commit/80b98c617ee8f4e44ab1db27b1b6b092957fc0ba\nhttps://github.com/Whonix/whonixcheck/commit/61be795d764487352e5acbc2544ae903a8bb0d7d\nhttps://github.com/Whonix/whonixcheck/commit/04c2ac6a53873b925dd1a736821c879af445ed46\nhttps://github.com/Whonix/whonixcheck/commit/ad84a55667e84c9c5bbc0626b2b2a4619c4ae97e\nhttps://github.com/Whonix/whonixcheck/commit/1603651d03f752c22ceba1c2860efffd083d69a0\nhttps://github.com/Whonix/whonixcheck/commit/483ee4785d0d8ff916055f88818426af66cd48dd"}]},"PHID-TASK-f7cfiknjt7ilnbdtrtuj":{"id":"481","title":"sdwdate should check if clock got changed behind our back","status":"resolved","priority":"Normal","author":"Patrick","description":"[Happens.](https://github.com/QubesOS/qubes-issues/issues/1779) Might happen in other hardware / virtualizer interaction cases.\n\nChanging the clock behind our back might relate to kernel timekeeping issues, which can generate lots of confusion, inconvenience and even time related fingerprinting issues.\n\nRelated:\nT480\n\nTODO:\n* before setting the time, store the old time in variable\n* before setting the time again, check if the time matches we think it should\n* if not, provide this information in a status file so sdwdate-gui can make that visible\n\n\"Clock was changed without sdwdate knowing about it. Either you manually set the time. In this case, you can ignore this. Or this is a bug.\" (That message can certainly be improved. We get to that once we have this feature implemented.)","comments":[{"author":"Patrick","date_created":1487906562,"date_modified":1487906562,"content":"https://github.com/Whonix/sdwdate/commit/709306e4a3f67423dd97618399aa615d49c2b74d"}]},"PHID-TASK-h6a4l5jbzoakfa6r675m":{"id":"480","title":"have whonixcheck look out for timekeeping watchdog kernel messages","status":"resolved","priority":"Normal","author":"Patrick","description":"This...\n```\n[ 2743.843690] timekeeping watchdog: Marking clocksource 'tsc' as unstable, because the skew is too large:\n```\n... or similar it could look in `dmesg`.\n\n`whonixcheck` or `whonixcheck --verbose` should add a test for that?\n\nIt could `dmesg` for \"timekeeping watchdog\" and if detected, show a warning.\n\nKernel messages wrt timekeeping can indicate issues which generate lots of confusion, inconvenience and even time related fingerprinting issues. See https://github.com/QubesOS/qubes-issues/issues/1779 (new information to be added there soon). Which took a while to debug.\n\nImplementation details:\n\n* #whonixcheck runs as user `user`. `/var/log/kern.log` is owned by group `adm`. So whonixcheck has no access to it. To avoid adding user `user` to group `adm`, `dmesg` gets used instead, which [strangely but never mind] is accessible as standard user.\n* `dmesg` has the added advantage, that it only shows kernel messages since last reboot. So it would not show any messages that may have occurred much earlier that were fixed by kernel or virtualizer upgrades.","comments":[{"author":"marmarek","date_created":1458565052,"date_modified":1458565052,"content":"Good idea.\n\nAlso I wonder is it possible to mark `tsc` back as stable, for example after fixing time after resume."},{"author":"Patrick","date_created":1458569787,"date_modified":1458569787,"content":"```\nlook out for timekeeping watchdog kernel messages\n\nKernel messages wrt timekeeping can indicate issues which generate lots of\nconfusion, inconvenience and even time related fingerprinting issues. See\nhttps://github.com/QubesOS/qubes-issues/issues/1779 (new information to be\nadded there soon). Which took a while to debug.\n\nhttps://phabricator.whonix.org/T480\n```\nhttps://github.com/Whonix/whonixcheck/commit/acf19620fc68f0b6c7b29cab9669a6cb5e7e9877\n\n`run check_kernel_messages test`:\nhttps://github.com/Whonix/whonixcheck/commit/1049109a01bcf997a193265abb22e122b324463e"},{"author":"Patrick","date_created":1458570078,"date_modified":1458570078,"content":"In future, whonixcheck will show the following message.\n```\n[WARNING] [whonixcheck] Check Kernel Messages Test Result: Remarkable kernel message found using dmesg.\n[ 2743.843690] timekeeping watchdog: Marking clocksource 'tsc' as unstable, because the skew is too large:\n```\nYes, violates most [Qubes usability advice](https://www.qubes-os.org/doc/usability-ux/). Keeps the user left with a cryptic message and stranded. Not too useful. But at this stage I have no advice. Therefore open to suggestions and looping in @bnvk."}]},"PHID-TASK-rf36dqc2ifjbgdw6jja6":{"id":"479","title":"Pre-install FoxyProxy from Debian & Add Custom Configuration","status":"resolved","priority":"Normal","author":"HulaHoop","description":"Problems with current setup:\n\n* At the moment too many steps are required to customize TBB to work with alternative proxies. Many rules need to be added manually after FoxyProxy is installed.\n\n* The FoxyProxy addon is still unsigned by Mozilla and so downloading it from their site incurs unacceptable risk.\n\n***\n\nThis ticket suggests simplifying the process by:\n\n* Pre-installing the FoxyProxy package from the Debian repo.\n\n* Supplying a configuration file to the addon for a variety of services (written by KillYourTV) [1]\n\n* Since it has to be optional and still done from the command line there is no point in scripting the symlinking/ config file moving part. These will be documented on the wiki.\n\n***\n\nThe way it would work:\n\n1. Run a script to enable this functionality by creating a symlink (making the addon available to TBB) + copy the custom config to the Tor Browser folder.\n\n\nln -s /usr/share/xul-ext/foxyproxy-standard/ /home/user/.tb/tor-browser/Browser/TorBrowser/Data/Browser/profile.default/extensions/foxyproxy@eric.h.jung\n\n\ncp /some/package/location/foxyproxy.xml /home/user/.tb/tor-browser/Browser/TorBrowser/Data/Browser/profile.default/\n\n\n2. Also included is another script to reverse step 1 to make the addon unavailable in TBB to restore TBB's default fingerprint. This is done by simply deleting the symlink:\n\nrm /home/user/.tb/tor-browser/Browser/TorBrowser/Data/Browser/profile.default/extensions/foxyproxy@eric.h.jung\n\n\n3. Optionally block any access to FoxyProxy by the default installed Iceweasel and IceDove by blacklisting the addon folder path in Apparmor\n\n4. **TODO** (assigned to HulaHoop) : Extend the config to cover access for Syncthing and Zeronet localhost pages. Update documentation for FoxyProxy to cover this feature when implemented.\n\n***\n\nResources:\n\n[1] http://qza32xuddl3guikc.onion/tutorials/darknets/foxyproxy.xml","comments":[{"author":"HulaHoop","date_created":1458658683,"date_modified":1458658683,"content":"I am working on packaging. Should the packaged foxyproxy xml path be: /usr/share/ ? something else?"},{"author":"Patrick","date_created":1458662098,"date_modified":1458662098,"content":"HulaHoop (HulaHoop):\n>   I am working on packaging. Should the packaged foxyproxy xml path be: /usr/share/ ? something else?\n\nYes.\n\nWhich package? -> #usability-misc ?"},{"author":"HulaHoop","date_created":1458737869,"date_modified":1458737869,"content":"Good idea. I don't think an entire new package is needed for this.\n\nWhere do I put the xul-ext-foxyproxy-standard dependency?"},{"author":"Patrick","date_created":1458739562,"date_modified":1458739562,"content":"What is the licensing of foxyproxy.xml?\n\n> Where do I put the xul-ext-foxyproxy-standard dependency?\n\nI don't think there is a great place for that."},{"author":"HulaHoop","date_created":1458747481,"date_modified":1458747481,"content":"There wasn't one specified but KYTV licenses everything under MIT. I assumed this would be covered. He is unavailable so a conversation with him is unlikely.\n\nTo be safe you can put this on hold - though likely it will never happen."},{"author":"HulaHoop","date_created":1458910953,"date_modified":1458910953,"content":"Copyright protects expression, not ideas or data. Configuration files are't copyrightable because they contain data. Data that can only be expressed in a single and certain way because of the underlying software which reads it: \n\nhttps://groups.drupal.org/node/17555"},{"author":"Patrick","date_created":1459012261,"date_modified":1459012261,"content":"Ok, I am not concerned by the copyright."},{"author":"HulaHoop","date_created":1459098967,"date_modified":1459098967,"content":"Will adding xul-ext-foxyproxy-standard to debian/control be enough to have it preinstalled during a Whonix build?"},{"author":"Patrick","date_created":1459167826,"date_modified":1459167826,"content":"Yes."},{"author":"HulaHoop","date_created":1459261807,"date_modified":1459262322,"content":"I want to block the getfoxyproxy ad from loading. Can this be done by adding a blacklisted entry in  /etc/hosts?\n\nThis page runs once after install but we don't want any outside connections from Iceweasel:\n\ngetfoxyproxy.org/help.html"},{"author":"Patrick","date_created":1459263609,"date_modified":1459263609,"content":"Tor Browser doesn't use /etc/hosts. Rightly so, since system specific and fingerprintable.\n\n-----\n\n> https://www.whonix.org/wiki/Template:FoxyProxy\n\n> To reverse this action and restore Tor Browser's default fingerprint run: \n\nI have reason to doubt it restores the fingerprint. Because...\n\n> https://www.whonix.org/wiki/Template:Tor_Browser_Remove_Proxy_Settings\n\n> Undo\n> Undoing this setting is undocumented. Simply no longer setting that environment variable will not do the trick. This is because of limitations of Tor Browser. The easiest way to undo these instructions would be to start over with a fresh installation of Tor Browser. Please contribute these instructions.\n\nTo find that out...\n\n1) Start with a fresh Tor Browser.\n\n2) make a copy of `/.tb/tor-browser/Browser/TorBrowser/Data/Browser/profile.default/prefs.js` (or add it to a version management system such as git) `[*]`\n\n3) make the (proxy) changes\n\n4) see if/how prefs.js changed (to make sure we know settings are changed there)\n\n5) undo the (proxy) changes\n\n6) see if the settings file is back to normal like in step 2.\n\n-----\n\n`[*]` Would be a lot better to add the whole Tor Browser folder to a version management system such as git observe files change back and forth."},{"author":"HulaHoop","date_created":1459288559,"date_modified":1459288559,"content":"Good catch. There are two changes that remain between the first version and the one after removing the symlink:\n\n+user_pref(\"extensions.foxyproxy.firstrun\", false);\n+user_pref(\"extensions.foxyproxy.last-version\", \"3.4\");\n\nCan content running in the browser fingerprint/read these changes in the pref.js? I think that's probably true since you pointed out and will change recommendations."},{"author":"Patrick","date_created":1459289220,"date_modified":1459289220,"content":"HulaHoop (HulaHoop):\n>   Good catch. There are two changes that remain between the first version and the one after removing the symlink:\n>   \n>   +user_pref(\"extensions.foxyproxy.firstrun\", false);\n>   +user_pref(\"extensions.foxyproxy.last-version\", \"3.4\");\n\nThe remaining two prefs are probably harmless cruft wrt to proxy settings.\n\n>   Can content running in the browser fingerprint/read these changes in the pref.js?\n\nOther add-ons can likely. [But that would not matter as they could other\nbad stuff also.]\n\nI haven't heard that remote websites can read arbitrary settings from\npref.js. Does pref.js include private data not to be shared? If so, such\na feature would be pretty outrageous. Unlikely. Worth researching."},{"author":"HulaHoop","date_created":1459289695,"date_modified":1459289695,"content":"So I rollback documentation to removing the symlink?"},{"author":"Patrick","date_created":1459290765,"date_modified":1459290765,"content":"HulaHoop (HulaHoop):\n>   So I rollback documentation to removing the symlink?\n\nYes. Perhaps leave a footnote to this discussion."},{"author":"HulaHoop","date_created":1459373995,"date_modified":1459373995,"content":"All done. Closing this."},{"author":"Patrick","date_created":1459608351,"date_modified":1459608351,"content":"Moved the file to adhere the convention (or stronger?) that it's /usr/share/package-name/...\n\nhttps://github.com/Whonix/usability-misc/commit/9312d64c321d21a98a5637f5b823a407c89d8a63"},{"author":"Patrick","date_created":1460662883,"date_modified":1460662883,"content":"Adding xul-ext-foxyproxy-standard as a dependency to #usability-misc was a mistake. Too intrusive. It causes too many issues. (plain Debian) I was starting icedove, and then it run some compatibility test that failed. Also having it installed it in iceweasel by default causes issues. It is confusing for Whonix users who happen to look into iceweasel wondering what it is good for or if that is a recommendation. And the foxyproxy homepage gets opened to each time the add-on is updated.\n\nSo on balance it creates more usability issues than it fixes (saving local proxy users a step). I think it would be more justified if local proxy users would be recommended to manually install it."},{"author":"HulaHoop","date_created":1460748633,"date_modified":1460748633,"content":"OK. I'll add the apt-get install step for the instructions.\n\nCan this problematic behavior be stopped by Apparmor rules? (Depends on whether the profiles are enabled by default)"},{"author":"Patrick","date_created":1460775513,"date_modified":1460775513,"content":">   Can this problematic behavior be stopped by Apparmor rules? (Depends on whether the profiles are enabled by default)\n\nIt might. Dunno. Would certainly be a problematic hack leading to other\nissues."},{"author":"HulaHoop","date_created":1460776535,"date_modified":1460776535,"content":"OK lets forget about default installation. One more command to go thru won't make a difference."},{"author":"Patrick","date_created":1460986967,"date_modified":1460986967,"content":"Done.\n\nhttps://github.com/Whonix/usability-misc/commit/ab042e1037c579ec4e521a28b3501fa9584b2815"},{"author":"Patrick","date_created":1465045558,"date_modified":1465045558,"content":"Can you please try to upstream https://github.com/Whonix/usability-misc/blob/master/usr/share/usability-misc/tbb-foxyproxy/foxyproxy.xml to foxyproxy?"},{"author":"HulaHoop","date_created":1465077230,"date_modified":1465077230,"content":"The Foxyproxy Debian package or upstream?"},{"author":"Patrick","date_created":1465077332,"date_modified":1465077332,"content":"Upstream, I guess. Having a default config shipped by upstream with examples for common use cases seems useful to me."},{"author":"HulaHoop","date_created":1465214965,"date_modified":1465214965,"content":"https://forums.getfoxyproxy.org/viewtopic.php?f=1&t=1825"},{"author":"Patrick","date_created":1465216317,"date_modified":1465216317,"content":"Awesome! Are you subscribed to the thread to proxy any reactions?"},{"author":"HulaHoop","date_created":1465424386,"date_modified":1465424386,"content":"Yeah :)\n"},{"author":"Patrick","date_created":1465425358,"date_modified":1465425358,"content":"Reason for upstreaming is also reduced documentation steps a user must\ntake and less maintenance work for us."},{"author":"HulaHoop","date_created":1465562709,"date_modified":1465562709,"content":"I guess they are not convinced. Was worth trying anyhow."}]},"PHID-TASK-xtnjayw572i6jd4crw55":{"id":"478","title":"Permissions test 1","status":"resolved","priority":"Needs Triage","author":"fortassetestuser1","description":"Testing ","comments":[{"author":"adretest","date_created":1458556865,"date_modified":1458556865,"content":"answer test with non-admin user..."}]},"PHID-TASK-xks7l3q2ciufs6xlnefk":{"id":"477","title":"tb-updater in Qubes TemplateVM should use Qubes updates proxy","status":"resolved","priority":"Normal","author":"Patrick","description":"Since Qubes will [set NetVM of TemplateVMs to none by default](https://github.com/QubesOS/qubes-issues/issues/1858), #tb-updater should use Qubes updates proxy.","comments":[{"author":"Patrick","date_created":1458412093,"date_modified":1458412093,"content":"` use Qubes updates proxy in Qubes TemplateVMs`:\nhttps://github.com/Whonix/tb-updater/commit/9a3d8fecdb0f31df484c1b3ccc75e0cdd492dcc2"}]},"PHID-TASK-eyd3k7irulhscifbq5hb":{"id":"476","title":"make sys-whonix function as Qubes FirewallVM ","status":"invalid","priority":"Normal","author":"Patrick","description":"TODO:\n\nmake sys-whonix function as Qubes FirewallVM \n\nBlocker:\n\nWaiting for Qubes ticket [Implement new firewall dom0->VM interface](https://github.com/QubesOS/qubes-issues/issues/1815) to be implemented.\n\nForum discussion:\nhttps://forums.whonix.org/t/sys-whonix-does-not-yet-function-was-qubes-firewallvm\n","comments":[{"author":"Patrick","date_created":1471565045,"date_modified":1471565045,"content":"Duplicate of T466."}]},"PHID-TASK-6apjeiypxdi5ndekrbdi":{"id":"475","title":"move to whonix.org repository","status":"resolved","priority":"Normal","author":"Patrick","description":"TODO:\n\n* ~~ask for testing in blog post -> https://www.whonix.org/blog/test-whonix-org-apt-repository ~~\n* ~~change in #whonix-repository and #whonixcheck Whonix News~~\n* ~~Whonix 12 -> Whonix 13 upgrades (#whonix-legacy)~~\n","comments":[{"author":"Patrick","date_created":1458567660,"date_modified":1458567660,"content":"* https://github.com/Whonix/whonix-repository/commit/44c23f1669ee447b99e873fa94dd970ff94baa47\n* https://github.com/Whonix/whonixcheck/commit/9795c5c5bf59e5eee20d05f6b0cfed1058816afe\n"},{"author":"Patrick","date_created":1458568049,"date_modified":1458568049,"content":"https://github.com/Whonix/whonix-legacy/commit/019f20ec794814098a0188cc5c7ba911b789c631"},{"author":"Patrick","date_created":1461683652,"date_modified":1461683652,"content":"new builds: ok\nupgraded builds: todo"},{"author":"Patrick","date_created":1461906051,"date_modified":1461906051,"content":"upgraded builds: ok"},{"author":"Patrick","date_created":1461906148,"date_modified":1462320682,"content":"TODO:\n\n- ~~redirect http://mirror.whonix.de/ to http://www.whonix.org/download/ for smoother transition~~\n- inform mirrors that these can be shut down\n- ~~keep rsync service as it does not hurt~~ (done)"}]},"PHID-TASK-4dmjdj6sna7ohrqaa5w3":{"id":"474","title":"review Surfing Posting Blogging page","status":"resolved","priority":"Normal","author":"Patrick","description":"Some anonymous edits were done.\n\nhttps://www.whonix.org/w/index.php?title=Surfing_Posting_Blogging&type=revision&diff=22450&oldid=22372\n\n@HulaHoop could you review/accept them please if applicable?","comments":[{"author":"HulaHoop","date_created":1456857264,"date_modified":1456857577,"content":"Changes reviewed and accepted. Looks good."}]},"PHID-TASK-mh3e2qzf5gqsel2path5":{"id":"473","title":"test ticket - can be deleted","status":"resolved","priority":"High","author":"adretest","description":"","comments":[{"author":"Patrick","date_created":1665000777,"date_modified":1665000777,"content":"test"},{"author":"Patrick","date_created":1665001206,"date_modified":1665001206,"content":"test"}]},"PHID-TASK-b3zcjxa4t4nidw5ftvae":{"id":"472","title":"maintain and upload a known good version of tor from deb.torproject.org in Whonix repository","status":"resolved","priority":"Normal","author":"Patrick","description":"Installing the `tor` from deb.torproject.org is great because it gives us more recent versions of Tor. Which has versions closer to the one included in TBB.\n\nAt one point this was even required:\nhttps://blog.torproject.org/blog/how-to-handle-millions-new-tor-clients\n\nThe problem with deb.torproject.org is that it is a too fast moving target, i.e. a new release of Tor might break Whonix for all users. Could happen when they change something related to the systemd service or so.\n\nThe responsible way would be to download Tor from deb.torproject.org and to upload it to the Whonix repository.\n\nI could not think of yet how this gets together with builds from source code. (You cannot run apt-get update from postinst scripts.)\n\nTODO:\n\n* ~~automate download (verification) and adding to Whonix local / remote apt repository~~  (done)\n* ~~disable TPO sources.list on existing installations using #whonix-legacy~~\n* ~~remove TPO signing key on existing installations using #whonix-legacy~~ (happens during deb.torproject.org-keyring package removal Debian maintainer prerm script)\n* ~~actually upload TPO packages to Whonix repository~~\n* ~~more comments in /etc/apt/sources.list.d/torproject.list #anon-shared-build-apt-sources-tpo to more easily add experimental versions of Tor~~\n* ~~usability feature for testers~~\n * ~~output torproject repo in use:~~\n  * ~~`cat /etc/apt/sources.list.d/torproject.list | grep -v '#' | grep deb`~~\n * ~~output of Tor version~~\n","comments":[{"author":"HulaHoop","date_created":1456173782,"date_modified":1456173782,"content":"I prefer we not touch binary packages unless there are solid security guarantees - similar to verification of binaries hosted on a mirror.\n\nHow complicated is it for using apt to check a package against some signing key in the keychain?"},{"author":"Patrick","date_created":1456256839,"date_modified":1456256839,"content":"HulaHoop (HulaHoop):\n>   I prefer we not touch binary packages unless there are solid security guarantees - similar to verification of binaries hosted on a mirror.\n\nI don't think there is such verification at the moment let alone anyone\non the internet keeping on auditing.\n\nIt won't change a lot. Rather than building a Whonix source package from\nsource and then comparing it with the binary one from the Whonix\nrepository, an auditor would download the binary tor package from\ndeb.torproject.org and then compare it with the one in the Whonix\nrepository which should have matching hashes.\n\n>   How complicated is it for using apt to check a package against some signing key in the keychain?\n\nIs this in scope of this ticket? If you are asking if someone who\ndownloaded the tor package from Whonix repository could verify it\nagainst the deb.torproject.org signing key, no that is not supported by\napt-get. This is (also) because in apt repositories, the repository\nmetadata is signed. Packages are verified against that metadata. The\nmetadata is verified against all available apt keys. Individual packages\nare not signed. Debian unfortunately does not have an end-to-end\nauthentication mechanism for binary packages signed by the package\nmaintainer up the user who downloaded them through apt-get. This is\n(also) because Debian packages are usually build on Debian build\nservers. [off-topic, FYI: Some of these build machines are just located\nin 'some Debian Developer's home'. Which is not great for security.\nThat's why reproducible builds really matter.]"},{"author":"HulaHoop","date_created":1456418105,"date_modified":1456418166,"content":"> an auditor would download the binary tor package from\ndeb.torproject.org and then compare it with the one in the Whonix\nrepository which should have matching hashes.\n\nWill this be done automatically by the build script? I don't want this to be a manual verification process that depends on the interest of someone doing it sometimes.\n\n> If you are asking if someone whodownloaded the tor package from Whonix repository could verify it against the deb.torproject.org signing key, no that is not supported by apt-get.\n\nYes that's what I was asking about. Very interesting as I wasn't familiar with details about apt.\n\nThere are some problems I foresee with critical update logistics. At the moment if the Tor package needs an emergency update, the people tracking Debian stable only will get it as its backported and those tracking deb.torproject.org get it as soon as the new \"testing\" release is uploaded. If we arbitrarily freeze some \"testing\" Tor release then how is it decided to upgrade? Will you need to read the changelog of every minor release to decide? Is this sustainable?"},{"author":"Patrick","date_created":1456423638,"date_modified":1456423638,"content":">>! In T472#8166, @HulaHoop wrote:\n>> an auditor would download the binary tor package from\n> deb.torproject.org and then compare it with the one in the Whonix\n> repository which should have matching hashes.\n> \n> Will this be done automatically by the build script? I don't want this to be a manual verification process that depends on the interest of someone doing it sometimes.\n\nThere are no verification scripts for any Debians repository at the moment at all. More info:\n\nhttps://www.whonix.org/wiki/Verifiable_Builds#Verifiable_Whonix_Debian_Packages\n\n>> If you are asking if someone whodownloaded the tor package from Whonix repository could verify it against the deb.torproject.org signing key, no that is not supported by apt-get.\n> \n> Yes that's what I was asking about. Very interesting as I wasn't familiar with details about apt.\n> \n> There are some problems I foresee with critical update logistics. At the moment if the Tor package needs an emergency update, the people tracking Debian stable only will get it as its backported and those tracking deb.torproject.org get it as soon as the new \"testing\" release is uploaded.\n\n> If we arbitrarily freeze some \"testing\" Tor release then how is it decided to upgrade?\n\nUpgrade every time. Unless the upgrade would break something that would require another Whonix package upgrade to make sure it does not break at the same time. Then upgrading would take longer.\n\n> Will you need to read the changelog of every minor release to decide? \n\nYes, I must do that anyhow.\n\n> Is this sustainable?\n\nIt has to be."},{"author":"HulaHoop","date_created":1456448464,"date_modified":1456448594,"content":"> There are no verification scripts for any Debians repository at the moment at all. More info.\n\nThere is a semantics mix up. When I say verifiable I mean to check package signatures or hashes not build reproducibility. \n\nWill the Whonix build script be able to download and compare hashes from the two different repos?\n\nEDIT: I think Verifiable -> Deterministic makes more sense in the documentation.\n> It has to be.\n\nOK and I'll help with keeping track too."},{"author":"Patrick","date_created":1456481923,"date_modified":1456481923,"content":"- The build using Whonix build script should not require using Whonix\nbinary repository. So there is nothing to compare.\n\n- Automated downloading of the tor package from deb.torproject.org\ncertainly must use usual apt-get verification.\n\n> I could not think of yet how this gets together with builds from\nsource code. (You cannot run apt-get update from postinst scripts.)\n\nConflicts with goal T461 (getting rid of chroot scripts)."},{"author":"HulaHoop","date_created":1456507414,"date_modified":1456507414,"content":"I'm confused. Source builds will have nothing to with these changes? This only applies for official builds?\n\nI don't think placing such a critical package in a third party repo is a good idea if we don't have a reliable and automated way to trace the chain of trust back to the original binaries. \n\n> Conflicts with goal T461 (getting rid of chroot scripts).\n\nBlocking this ticket is not really worth the gain. Why not switch to the older version in Debian's repos if testing is moving too fast? "},{"author":"Patrick","date_created":1456571315,"date_modified":1456571315,"content":">>! In T472#8174, @HulaHoop wrote:\n> I'm confused. Source builds will have nothing to with these changes? This only applies for official builds?\n\n- The chroot script https://github.com/Whonix/anon-shared-build-apt-sources-tpo should be abolished. (T461) Therefore it is related to builds from source code.\n- deb.torproject.org should be removed (this ticket).\n- Builds from source code should still download, verify and install `tor` from deb.torproject.org.\n- You cannot run `apt-get update` from Debian packaging maintainer (postinst ...) scripts. (Because apt-get and dpkg is already running, therefore locked.)\n-- (Running `apt-get update` would be required within the process of temporarily adding deb.torproject.org, downloading and verifying `tor`.)\n\n> Why not switch to the older version in Debian's repos if testing is moving too fast? \n\nThat would block lots of other stuff. Such as onionshare. (T448 etc.) And latest Tor security enhancements such as to the guard selection algorithm. Also in case they need to deploy a fix to cope up with another botnet attack on the Tor network, we need to react also."},{"author":"marmarek","date_created":1456572946,"date_modified":1456572946,"content":">   - Builds from source code should still download, verify and install `tor` from deb.torproject.org.\n>   - You cannot run `apt-get update` from Debian packaging maintainer (postinst ...) scripts. (Because apt-get and dpkg is already running, therefore locked.)\n>     - (Running `apt-get update` would be required within the process of temporarily adding deb.torproject.org, downloading and verifying `tor`.)\n\nIt should be quite easy to download and verify it manually, but there should\nbe also utilities to do that, without modifying /etc/apt/sources.list*.\nTake a look at https://wiki.debian.org/AptMedium for example - basically\nit calls apt-get with alternative configuration, pointing at different\ndirectory to download packages without interacting with system database."},{"author":"Patrick","date_created":1456575786,"date_modified":1456575786,"content":"How to work around the dpkg lock?"},{"author":"marmarek","date_created":1456576233,"date_modified":1456576233,"content":"I understand apt-medium uses a separate dpkg database."},{"author":"Patrick","date_created":1456578694,"date_modified":1456578694,"content":"So we could install another deb package using dpkg from the postinst\nwhile dpkg is already running and installing a package?\n\nThat is the circle I am trying to square here which will likely not work."},{"author":"marmarek","date_created":1456579565,"date_modified":1456579565,"content":"No, we do not want to install it there, we want to download it only,\ndon't we? Then put it into local repository (same as other packages\nbuild there), or upload to whonix apt repo.\n\nAm I missing something?"},{"author":"Patrick","date_created":1459875665,"date_modified":1459875665,"content":"It depends on how far `Installation from Repository / proverbial \"sudo apt-get install whonix\"` (T461) should go.\n\n-----\n\n`a)`\n\n1) start a (Qubes) Debian (template)\n2) add Whonix binary apt repository `[*]`\n3) `sudo apt-get install whonix-gateway`\n\n-----\n\n`b)`\n\n1 start a (Qubes) Debian (template)\n2 have a script that\n2a adds Whonix binary apt repository `[*]`\n2b runs `sudo apt-get install whonix-gateway`\n2c downloads and installs the `tor` package from `deb.torproject.org`\n\n---\n\nIf it is supposed to become as simple as the following 3 steps in `a)`... Then we cannot download and install the `tor` package from `deb.torproject.org`. This is because while the package manager is running, we cannot run dpkg install package, since the package database would be already locked.\n\nWhich one do we require/want? `a)` or `b)`?\n\n-----\n\n`[*]` Or create a local Whonix apt repository from source code."},{"author":"marmarek","date_created":1459881514,"date_modified":1459881514,"content":"If `tor` package is going to be uploaded to Whonix binary apt repository, it doesn't matter. Downloading `tor` package from `deb.torproject.org` is the part of build process, not installation process."},{"author":"Patrick","date_created":1459893334,"date_modified":1459893334,"content":"Update: I am trying to avoid uploading the `tor` package from `deb.torproject.org` to the Whonix binary apt repository. After thinking more about, it significantly adds up a maintenance burden. Instead I am considering to implement some usability enhancements.\n\n* a script run from `.bashrc` thats shows the current Tor version / Tor Project repository once some file is created (`touch ~/tester` or so)\n* more comments in `/etc/apt/sources.list.d/torproject.list` to more easily allow enabling `tor-experimental-0.2.7.x-jessie` etc.\n\nThese should simplify/remind to keep track of newer Tor versions and see how they work with Whonix before they flow into Tor Project's stable apt repository.\n\n-----\n\nFYI, a hack (will probably not use it)...\n`install apt packages from deb postinst`:\n* http://javier.io/blog/en/2015/09/10/apt-packages-from-deb-postinst.html\n* https://gist.github.com/chilicuil/74fddda2a31bba09b973\n\n-----\n\nHere is my work in progress attempt for downloading the `tor` package during Debian maintainer postinst script. It uses a separate apt database. It works.\n\nhttps://github.com/adrelanos/anon-gw-anonymizer-config/blob/5fdf627e7e4286cdab418e8e634df3c07e209133/debian/anon-gw-anonymizer-config.postinst#L24-L92\n\nInstallation from there is more tricky. The above hack of merging dpkg status file changes should probably be avoided. The least awful hack might be to have a blocking startup script that runs early and installs the package at next reboot.\n\nThat would move us closer to \"sudo apt-get install whonix-gateway\" etc. Getting rid of chroot scripts. (T461) Then one could create a Qubes Debain ProxyVM by using method `a)` to morph it into a Whonix-Gateway. That would greatly simplify Whonix installation process. Make it more robust, easier/quicker testing overall, easier porting. I hope I don't have to bend things too much to get there. (We are overwriting files such as /etc/resolv.conf, load firewall rules, etc. I hope none of this is a deal breaker during installation. I don't think there is any other Debian derivative yet that can be installed using apt-get alone.)\n\nThat doesn't give us a set of packages that could be installed from Qubes installer inside a Debian template to morph it into Whonix. (The purpose is to save space on the installer disc here.) But getting pure T461 done somewhat simplifies the development of that."},{"author":"Patrick","date_created":1459954281,"date_modified":1459954281,"content":"I succeeded to implement the download of\n\n* `tor`\n* `tor-geoipdb`\n* `deb.torproject.org-keyring`\n\nfrom `deb.torproject.org` using #anon-gw-anonymizer-config postinst script and installation during next reboot. `[*]`\n\n\n\n- https://github.com/adrelanos/anon-gw-anonymizer-config/blob/T461/debian/anon-gw-anonymizer-config.postinst\n- https://github.com/adrelanos/anon-gw-anonymizer-config/blob/T461/lib/systemd/system/anon-gw-anonymizer-config.service\n- https://github.com/adrelanos/anon-gw-anonymizer-config/blob/T461/usr/lib/anon-gw-anonymizer-config/startup\n- https://github.com/adrelanos/anon-gw-anonymizer-config/blob/T461/usr/lib/anon-gw-anonymizer-config/startup_helper\n\n-----\n\n#anon-gw-anonymizer-config now depends on #anon-shared-build-apt-sources-tpo.\n\nShould the `deb.torproject.org-keyring` package be rather installed by #anon-shared-build-apt-sources-tpo? That certainly would be cleaner. But then #anon-shared-build-apt-sources-tpo would need a similar mechanism to download that package during postinst and to install it on next reboot. `[*]`\n\nIf yes, it would certainly be cleaner to a separate package for the `download packages during postinst` code being a standalone shell library and a generic `install on next reboot mechanism` `[*]` that gets used by both packages, #anon-shared-build-apt-sources-tpo and #anon-gw-anonymizer-config.\n\nAll doable but quite some work.\n\nSo I am wondering, do we still require an independent package `add torproject apt repository` (#anon-shared-build-apt-sources-tpo)?\n\nDo we still want to enable torproject's apt repository within Whonix-Workstation? We no longer install any packages from torproject's apt repository in Whonix-Workstation. We used to install `torsocks` from there, but since Debian `jessie` this is no longer necessary. We might need that in future though, if Tor Browser gets added to torproject's apt repository - if that ever happens.\n\n-----\n\n`[*]` Or manually running `sudo service anon-gw-anonymizer-config start` after installation of the #anon-gw-anonymizer-config package. (I wouldn't know how to automate this during `apt-get install whonix-gateway` etc. This is as long as dpkg is running, there is no (sane) way to dpkg install another package since the package database is locked. And there are no post apt-get hooks. So there is no sane way to not require manually running `sudo service anon-gw-anonymizer-config start` or reboot after `apt-get install whonix-gateway`.)"},{"author":"Patrick","date_created":1459973875,"date_modified":1459973875,"content":"Ended up implementing exactly that:\nT461#8622"},{"author":"Patrick","date_created":1460074559,"date_modified":1460074559,"content":"The download during postinst as part of `apt-get install whonix-...` does not work. /etc/resolv.conf gets modified during distribution morphing, therefore breaks networking, so the download will fail. I wonder how this could be solved."},{"author":"marmarek","date_created":1460076062,"date_modified":1460076062,"content":"How exactly it gets modified? Maybe it is possible to make both old and new version working at the same time?"},{"author":"Patrick","date_created":1460125177,"date_modified":1460125177,"content":"Small specification so we are on the same page. What I am not talking about here, is the installation without network access for morphing a Debian template into Whonix during Qubes firstboot. This is an issue with `apt-get install whonix-...` from a usual Debian system with network access. I.e. if subgraph was to ask \"how to install Whonix\" (for porting), it would be as simple as `a)`. /etc/resolv.conf gets modified by package [anon-gw-dns-conf](https://github.com/Whonix/anon-gw-dns-conf). `apt-get install whonix-gateway` leads to installation for that package first. After that networking is broken so any other packages requiring networking won't work.\n\n`apt-get install whonix-...` is different from the way packages are currently [installed when using the build script](https://github.com/Whonix/Whonix/blob/master/build-steps.d/1700_install-packages). Then the script installs them in the right order, the script can also create a backup of such files and read-only mount them in chroot. Also currently: we do not start services during initial install (think: whonix-gw-firewall) vs new: start services during install. This is somewhat an attempt to dumb down [build-steps.d/1700_install-packages](https://github.com/Whonix/Whonix/blob/master/build-steps.d/1700_install-packages) to `apt-get install whonix-...`.\n\nIt's great to do that. I just now need to solve issues I could not think of earlier how to solve.\n\nSomehow I would have to express in Debian packaging terms to have the packages that require internet access (anon-gw-anonymizer-config) to be installed first. So other packages that do not require internet access and break internet access are installed after that."},{"author":"Patrick","date_created":1460142246,"date_modified":1460142246,"content":"After all the complication for software outside of the Debian repository and the workarounds being complex, I guessed that adding the TPO packages to the Whonix local and binary repository would be the most canonical and best understandable solution.\n\nI've signed up for [tor-announce](https://lists.torproject.org/cgi-bin/mailman/listinfo/tor-announce) which seems not to be super busy with stable release updates and seems to be on par with deb.torproject.org.\n\nI've started working on scripts to automate the process of downloading (and verifying) packages from deb.torproject.org for reupload to whonix.org repository.\n\n-----\n\n```\ndownload binary and source packages from torproject repo and add to Whonix repo\n\nThe following packages:\ntor tor-geoipdb deb.torproject.org-keyring\n\nAre being added to Whonix local / remote repository.\n\nhttps://phabricator.whonix.org/T472\n```\nhttps://github.com/Whonix/Whonix/commit/61397b057290f245c4ce0bebf16b64494b0d2e27\n\n```\nenabled deb-src so we can download source pages during build\n\nhttps://phabricator.whonix.org/T472\n```\nhttps://github.com/Whonix/anon-shared-build-apt-sources-tpo/commit/822ca719f783b66877c4c82f9433d2df926ace81"},{"author":"Patrick","date_created":1460215953,"date_modified":1460215953,"content":"```\nadded anon-info - shows Tor apt repository status and Tor package version\n\nhttps://phabricator.whonix.org/T472\n```\nhttps://github.com/Whonix/anon-gw-anonymizer-config/commit/950b9c4edfc840a89fad630f3df14835c413789f"},{"author":"Patrick","date_created":1460566704,"date_modified":1460566704,"content":"```\nmore out commented by default repositories to ease testing\n\nhttps://phabricator.whonix.org/T472\n```\nhttps://github.com/Whonix/anon-shared-build-apt-sources-tpo/commit/f62153744865ccb2ce6478edf4ecef3fd0c8fe90"},{"author":"Patrick","date_created":1460567135,"date_modified":1460567135,"content":"```\nno longer download from deb.torproject.org because it gets uploaded to Whonix repo\n    \nhttps://phabricator.whonix.org/T472\n```\nhttps://github.com/Whonix/anon-gw-anonymizer-config/commit/93b31efe6df6f118f66098a47f6d6964e2249a05"},{"author":"Patrick","date_created":1460568363,"date_modified":1460568398,"content":"```\nhave deb.torproject.org and its signing key removed during apt-get autoremove\n\nfor existing installations\n\nhttps://phabricator.whonix.org/T472\n```\nhttps://github.com/Whonix/whonix-legacy/commit/e10915b86f3129a8c392ef2e53513e377757a816"},{"author":"Patrick","date_created":1460662266,"date_modified":1460662266,"content":"```\nsimplify just refreshing deb.torproject.org packages in Whonix repository mirror\n\nhttps://phabricator.whonix.org/T472\n```\nhttps://github.com/Whonix/Whonix/commit/8365ee40f6d3bc857b311404ce19f8a972273f5a"},{"author":"Patrick","date_created":1460663638,"date_modified":1460663638,"content":"Adding `anon-info` to `~/.bashrc` should be simple enough."},{"author":"Patrick","date_created":1460677852,"date_modified":1460677852,"content":"```\nremoved download of packages from deb.torproject.org\n\nbecause using different implementation (uploading these packages to Whonix\nlocal / remote repository.\n\nNot installing apt-during-apt and not installing these packages also ensures a\nsmoother transition for existing Whonix versions where deb.torproject.org is to\nbe disabled.\n\nhttps://phabricator.whonix.org/T472\n```\nhttps://github.com/Whonix/anon-shared-build-apt-sources-tpo/commit/b416da52403162172611f803d28631a9f42f2ecc\n\n```\nremoved apt-during-apt because decided not using this approach\n\nhttps://phabricator.whonix.org/T472\n```\nhttps://github.com/Whonix/Whonix/commit/c19b1c7a9b2d021c37a26078e60b1f3eead04498"},{"author":"Patrick","date_created":1460680781,"date_modified":1460680781,"content":"```\nremoved anon-gw-build-upgrade-tor from whonix-gateway-shared-packages-shared-meta\n\nbecause no longer required / existing\n\nhttps://phabricator.whonix.org/T472\n```\nhttps://github.com/Whonix/anon-meta-packages/commit/5a440f5552d83a05adf4e87530890c9680a14bac"},{"author":"Patrick","date_created":1461683853,"date_modified":1461683853,"content":"new builds: ok\nupgraded builds: todo"},{"author":"Patrick","date_created":1461801792,"date_modified":1461801792,"content":"upgraded builds: ok"},{"author":"Patrick","date_created":1470353903,"date_modified":1470353903,"content":"Good users are not getting updates unfiltered from deb.torproject.org anymore since Whonix 13.\n\nUsers who did not upgrade and stayed on Whonix 12 did now run into an issue that was caused by a newer Tor version from deb.torproject.org that required anon-gw-anonymizer-config being upgraded beforehand:\n\nhttps://forums.whonix.org/t/error-tor-bootstrap-result\n"}]},"PHID-TASK-crflabmqkelr4jhsrh25":{"id":"471","title":"Disable systemd DNS resolver feature","status":"resolved","priority":"Normal","author":"HulaHoop","description":"\nSystemd just gained DNS resolution as a feature. This should be disabled because of potentially negative consequences for anonymity and to reduce attack surface.\n\nhttps://lists.freedesktop.org/archives/systemd-devel/2016-February/035748.html","comments":[{"author":"Patrick","date_created":1484736953,"date_modified":1484736953,"content":"This can probably be implemented by adding a systemd override for `systemd-resolved.service`.\n\nTo check:\n\n    sudo systemctl status systemd-resolved.service\n"},{"author":"Patrick","date_created":1486325774,"date_modified":1486325774,"content":"Done.\n\n* https://github.com/Whonix/anon-gw-dns-conf/commit/9d6a3671b4850238e35be331a4644a12da37b3e1\n* https://github.com/Whonix/anon-ws-dns-conf/commit/8585dd80ea1934050c6b3a78cce5a7eff8116790\n\nI've spent a lot thought on the migration. For new Whonix 14 images, systemd-resolved will never start.\n\nWhen upgrading Whonix 13 to Whonix 14,\n\n* using https://www.whonix.org/wiki/Upgrading_Whonix_13_to_Whonix_14 - it will not start (since using apt-get-noninteractive that prevents daemon restarts and after reboot the systemd drop-in to prevent its startup will be in place)\n* when not using apt-get-noninteractive, systemd-resolved would start and keep running until the next reboot\n** there won't be an auto upgrade from Whonix 13 to Whonix 14 since the user has to manually change from jessie to stretch Debian and Whonix repository, so the risk for this to accidentally happen should be low\n** otherwise preventing this would be cumbersome and require a lot more code (inventing a postinst running systemd daemon-reload and whatnot)\n"},{"author":"anonymous1","date_created":1486450775,"date_modified":1486451946,"content":"relevant:\n\nhttp://suckless.org/sucks/systemd\n\nhttps://devuan.org/\n\nhttps://muchweb.me/systemd-nsa-attempt\n\nhttps://systemdexploit.wordpress.com"},{"author":"Patrick","date_created":1486486879,"date_modified":1486486879,"content":"This isn't a ticket for general question systemd yes vs no. If you like to raise this, please move it to the forums or so."},{"author":"anonymous1","date_created":1486488683,"date_modified":1486489546,"content":"It was just to remind that this \"feature\" is just the tip of an iceberg that keeps getting bigger over time. If you see it feasible and preferable to move away from systemd I would expect you to start the ticket/discussion"}]},"PHID-TASK-kcgijejyr5jsxr7bcsmv":{"id":"470","title":"Whonix home page redesign","status":"resolved","priority":"Normal","author":"Patrick","description":"https://forums.whonix.org/t/whonix-org-main-homepage-improvements-looking-for-html-volunteer/8523","comments":[]},"PHID-TASK-og37a67mwy6fiboykja4":{"id":"469","title":"research non-persistent Tor directory guards","status":"resolved","priority":"Normal","author":"Patrick","description":"We have (non-)persistent Tor entry guards documented. (T94)\nhttps://www.whonix.org/wiki/Tor#Non-Persistent_Entry_Guards\n\nPersistent Tor directory guards [were implemented](https://trac.torproject.org/projects/tor/ticket/6526) in Tor 0.2.4.\n\nThey might have the same effect as (non-)persistent Tor entry guards. They might not require additional documentation steps from the user as our current documentation for non-persistent entry guards might already implicitly cover them.","comments":[{"author":"HulaHoop","date_created":1455204039,"date_modified":1455204039,"content":"It doesn't seem to be a separate fingerprintability vector. Entry guards act as a client's directory guards by default:\n\n> UseEntryGuardsAsDirGuards 0|1\n>\n> If this option is set to 1, and UseEntryGuards is also set to 1, we try to use our entry guards as directory guards, and failing that, pick more nodes to act as our directory guards. This helps prevent an adversary from enumerating clients. It’s only available for clients (non-relay, non-bridge) that aren’t configured to download any non-default directory material. It doesn’t currently do anything when we lack a live consensus. (Default: 1)\n"},{"author":"Patrick","date_created":1455386187,"date_modified":1455386187,"content":"I am afraid it is a fingerprinting vector in some cases. The critical part is the following:\n\n> and failing that, pick more nodes to act as our directory guards\n\nSo let's say fetching the consensus from the entry guard failed for some reason(*), an additional directory guard will be picked. Then it's some entry guard a plus some directory guard b. Now going to another location and connecting to both relays should be fingerprintable.\n\n(*) Perhaps adversaries could specifically block downloading the consensus from the entry guard only but let through all other traffic.\n\n-----\n\nHowever, out current instructions should implicitly cover it.\n\n* Alternating Bridges\n* Fresh Tor Entry Guards by regenerating Tor State File\n* Always Non-Persistent Entry Guards\n\nAny of these should cover the directory guards also. Does that make sense?"},{"author":"HulaHoop","date_created":1455654529,"date_modified":1455654529,"content":"> (*) Perhaps adversaries could specifically block downloading the consensus from the entry guard only but let through all other traffic.\n\nThe only way that could happen is if your guard is malicious but then there are bigger problems to worry about.\n\nA bridge acts as a directory guard (to bypass censoring of this data requested by the clients).\n\n> However, out current instructions should implicitly cover it.\n\nAgreed."},{"author":"Patrick","date_created":1455656975,"date_modified":1455656975,"content":"Great! Done.\n\nFor reference only...\n\nJust added a footnote.\n\nhttps://www.whonix.org/w/index.php?title=Tor&type=revision&diff=22367&oldid=22077\n\nAnd linked it from the forums.\n\nhttps://forums.whonix.org/t/persistent-tor-entry-guard-relays-can-make-you-trackable-across-different-physical-locations/2090/8?u=patrick\n"}]},"PHID-TASK-mj5hyuslvfhk7xi4ktjz":{"id":"468","title":"package paxrat for offical debian.org repository","status":"resolved","priority":"Normal","author":"Patrick","description":"__Introduction__:\n\npaxrat is a utility to set PaX flags on a set of binaries.\n\n-----\n\n__TODO__:\n\nAdd Debian packaging files for paxrat. Get feedback from debian.org developers. Make sure to meet Debian requirements to have the package added to the official debian.org repository.\n\n-----\n\n__Debian RFP (request for packaging)__:\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=810479\n\n-----\n\n__paxrat upstream ticket__:\nhttps://github.com/subgraph/paxrat/issues/1\n\n-----\n\n__Mirrored from__:\nhttps://phabricator.whonix.org/T468\n\n-----\n\n__On bountysource__:\nhttps://www.bountysource.com/issues/29647889-debian-packaging\n\n-----\n\n__Bounty too low?__:\n\n1) Go to https://www.bountysource.com/issues/29647889-debian-packaging\n2) Click on \"Developers\"\n3) Click on \"Get Started\"\n4) Select Status \"Bounty too low\"\n5) Enter your offer and press \"Save\".","comments":[{"author":"Patrick","date_created":1540368532,"date_modified":1540368532,"content":"https://packages.debian.org/stretch/paxrat"}]},"PHID-TASK-45iosixhabsrgqwayn2m":{"id":"467","title":"Migration to Gnome-Shell / port to GNOME-ish applications","status":"wontfix","priority":"Normal","author":"HulaHoop","description":"There are major advantages to migrating DE.\n\n* Better accessibility support (as mentioned) in T457\n* Wayland support = better performance/security. Gnome-Shell and Wayland are reportedly working in Debian Jessie.\n* Gnome-Shell is the Gnome variant that does not require any GPU acceleration support - essential for VM performance constraints.\n\n`port to GNOME-ish applications`:\nhttps://github.com/QubesOS/qubes-issues/issues/1781\n\n\nTODO:\n\n* #gnome\n* auto login\n* disable auto screen lock\n* kdesudo -> gksudo\n* disable blank screen\n* disable gnome system sounds?\n* systray settings?\n\nforum discussion:\nhttps://forums.whonix.org/t/updating-whonix-from-jessie-to-stretch-migration-to-gnome-shell-port-to-gnome-ish-applications","comments":[{"author":"HulaHoop","date_created":1455205367,"date_modified":1455205367,"content":"Important features:\n\n- installable from Debian: https://packages.debian.org/jessie/gnome-shell\n\n- auto login scripting: https://wiki.archlinux.org/index.php/GDM#Automatic_login\n\n- self-contained dependencies like libgtk are used throughout the programs suite."},{"author":"Patrick","date_created":1479870164,"date_modified":1479870164,"content":"Since changing from #KDE to #GNOME is not so simple, since many packages have to be changed (kde vs gnome, jessie vs stretch), I think it's best to delay this change and implement it when porting #Whonix to #debian_stretch."},{"author":"Patrick","date_created":1484210252,"date_modified":1484210252,"content":"As discussed in https://forums.whonix.org/t/updating-whonix-from-jessie-to-stretch-migration-to-gnome-shell-port-to-gnome-ish-applications it's not going to be gnome nor gnome-ish applications."}]},"PHID-TASK-gak2fvp3cfkuw6uwj2o3":{"id":"466","title":"Qubes sys-whonix does not do its job as Qubes FirewallVM","status":"open","priority":"Normal","author":"Patrick","description":"TODO:\n\nmake sys-whonix function as Qubes FirewallVM\n\n-----\n\n~~Blocker:~~\n\n~~Waiting for Qubes ticket [Implement new firewall dom0->VM interface](https://github.com/QubesOS/qubes-issues/issues/1815) to be implemented.~~\n\n-----\n\nForum discussion:\nhttps://forums.whonix.org/t/sys-whonix-does-not-yet-function-was-qubes-firewallvm\n\n-----\n\nA sys-whonix currently does it's job as a ProxyVM, but not as a FirewallVM. It currently ignores QubesDB `qubes-iptables` entries.\n\n* Therefore, for example, any TemplateVM using sys-whonix as its NetVM does not block the TemplateVM from using the open (torified) internet. (T372) (That will be solved once [set NetVM of TemplateVMs to none by default / make TemplateVMs non-networked by default](https://github.com/QubesOS/qubes-issues/issues/1858) gets implemented.)\n* Additional firewall rules in '[Firewall rules' tab](https://www.qubes-os.org/attachment/wiki/QubesFirewall/r2b1-manager-firewall.png) are ignored.\n\nAny suggestion on how to implement it without re-inventing qubes-core-agent-linux/network/qubes-firewall? Or refactoring the Qubes code so Whonix can just call the required portion of it?\n\n-----\n\nRelated:\n\n* [mechanism to hide Qubes VM Manager 'Firewall rules' tab](https://github.com/QubesOS/qubes-issues/issues/1323)\n","comments":[{"author":"marmarek","date_created":1453169271,"date_modified":1453169271,"content":"Related to:  [[ https://github.com/QubesOS/qubes-issues/issues/1323 | mechanism to hide Qubes VM Manager 'Firewall rules' tab ]]\n\nNot sure if worth it. But if it does, lets finish [[ https://groups.google.com/d/msgid/qubes-devel/20160114163808.GW4892%40mail-itl | Qubes firewall dom0->VM interface ]] and [[ https://github.com/QubesOS/qubes-issues/issues/974 | Qubes Firewall - Add rules to QBS-prefixed chain ]] first. It would be much easier to integrate `qubes-firewall` with some other firewall scripts."},{"author":"Patrick","date_created":1475703537,"date_modified":1475703537,"content":">>! In T466#8003, @marmarek wrote:\n> Related to:  [[ https://github.com/QubesOS/qubes-issues/issues/1323 | mechanism to hide Qubes VM Manager 'Firewall rules' tab ]]\n> \n> Not sure if worth it. But if it does, lets finish [[ https://groups.google.com/d/msgid/qubes-devel/20160114163808.GW4892%40mail-itl | Qubes firewall dom0->VM interface ]] and [[ https://github.com/QubesOS/qubes-issues/issues/974 | Qubes Firewall - Add rules to QBS-prefixed chain ]] first. It would be much easier to integrate `qubes-firewall` with some other firewall scripts.\n\nJust noticed Qubes firewall dom0->VM interface  is done. Qubes Firewall - Add rules to QBS-prefixed chain not yet. I guess the latter will come soon?\n\nSo this feature could still make it into Whonix 14."},{"author":"marmarek","date_created":1475709509,"date_modified":1475709509,"content":"Actually the later is also done (slightly differently - see my comment there).\nDefault static firewall (blocking INPUT etc) still uses `iptables`, but it doesn't matter on Whonix, since it uses its own version. Dynamic part (`qubes-firewall` service) use nftables (when installed) and should not interfere with other firewall rules."},{"author":"Patrick","date_created":1475947333,"date_modified":1475947333,"content":"For tracking purposes... This still has to wait until Qubes 4.0 since\n[Qubes firewall dom0->VM interface](Qubes firewall dom0->VM interface)\nwill come in Qubes 4.0?"}]},"PHID-TASK-wsl23vmkwzxabndxjpor":{"id":"465","title":"refactor socks redirection firewall rules","status":"resolved","priority":"Normal","author":"Patrick","description":"As mentioned in T462, Whonix's socks redirection firewall rules size should be shrinked. Same rules. Less script code.\n\nCode in question:\n\n* https://github.com/Whonix/whonix-gw-firewall/blob/7f5f65f6bf682a7f7df1df37976b8733f933f239/usr/bin/whonix_firewall#L385-L412\n* https://github.com/Whonix/whonix-gw-firewall/blob/7f5f65f6bf682a7f7df1df37976b8733f933f239/usr/bin/whonix_firewall#L435-L463\n\nWe can do firewall refactoring with virtually zero risk of changing actual rules by adhering the following instructions:\nhttps://www.whonix.org/wiki/Dev/Firewall_Refactoring\n","comments":[{"author":"Patrick","date_created":1452441158,"date_modified":1452441158,"content":"https://github.com/Whonix/whonix-gw-firewall/commit/e6ed118ede2bd012f5b869cd4b864262472aa9a9"},{"author":"Patrick","date_created":1452594847,"date_modified":1452594847,"content":"https://github.com/Whonix/whonix-gw-firewall/commit/14c6e5ad3c37022be1acaa19cc327969d46aef27"},{"author":"Patrick","date_created":1452627133,"date_modified":1452627133,"content":"https://github.com/Whonix/whonix-gw-firewall/commit/14c6e5ad3c37022be1acaa19cc327969d46aef27#commitcomment-15395031\n\nhttps://github.com/Whonix/whonix-gw-firewall/commit/7ef15d52e4d61a80f82df0e02b0b3f3ba21c942d"},{"author":"Patrick","date_created":1461265310,"date_modified":1461265310,"content":"Whonix 13. iptables-save-deterministic\n\n```\n*mangle\n:PREROUTING ACCEPT [0,0]\n:INPUT ACCEPT [0,0]\n:FORWARD ACCEPT [0,0]\n:OUTPUT ACCEPT [0,0]\n:POSTROUTING ACCEPT [0,0]\nCOMMIT\n*nat\n:PREROUTING ACCEPT [0,0]\n:INPUT ACCEPT [0,0]\n:OUTPUT ACCEPT [0,0]\n:POSTROUTING ACCEPT [0,0]\n:PR-QBS-SERVICES - [0,0]\n-A PREROUTING -j PR-QBS-SERVICES\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9052 -j REDIRECT --to-ports 9052\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9124 -j REDIRECT --to-ports 9124\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9104 -j REDIRECT --to-ports 9104\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9111 -j REDIRECT --to-ports 9111\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9117 -j REDIRECT --to-ports 9117\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9107 -j REDIRECT --to-ports 9107\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9123 -j REDIRECT --to-ports 9123\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9105 -j REDIRECT --to-ports 9105\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9103 -j REDIRECT --to-ports 9103\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9101 -j REDIRECT --to-ports 9101\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9122 -j REDIRECT --to-ports 9122\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9121 -j REDIRECT --to-ports 9121\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9120 -j REDIRECT --to-ports 9120\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9113 -j REDIRECT --to-ports 9113\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9112 -j REDIRECT --to-ports 9112\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9118 -j REDIRECT --to-ports 9118\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9108 -j REDIRECT --to-ports 9108\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9106 -j REDIRECT --to-ports 9106\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9100 -j REDIRECT --to-ports 9100\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9150 -j REDIRECT --to-ports 9150\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9115 -j REDIRECT --to-ports 9115\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9116 -j REDIRECT --to-ports 9116\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9102 -j REDIRECT --to-ports 9102\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9119 -j REDIRECT --to-ports 9119\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9050 -j REDIRECT --to-ports 9050\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9109 -j REDIRECT --to-ports 9109\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9110 -j REDIRECT --to-ports 9110\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9114 -j REDIRECT --to-ports 9114\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9125 -j REDIRECT --to-ports 9125\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9152 -j REDIRECT --to-ports 9152\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9153 -j REDIRECT --to-ports 9153\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9154 -j REDIRECT --to-ports 9154\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9155 -j REDIRECT --to-ports 9155\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9156 -j REDIRECT --to-ports 9156\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9157 -j REDIRECT --to-ports 9157\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9158 -j REDIRECT --to-ports 9158\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9159 -j REDIRECT --to-ports 9159\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9160 -j REDIRECT --to-ports 9160\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9161 -j REDIRECT --to-ports 9161\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9162 -j REDIRECT --to-ports 9162\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9163 -j REDIRECT --to-ports 9163\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9164 -j REDIRECT --to-ports 9164\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9165 -j REDIRECT --to-ports 9165\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9166 -j REDIRECT --to-ports 9166\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9167 -j REDIRECT --to-ports 9167\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9168 -j REDIRECT --to-ports 9168\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9169 -j REDIRECT --to-ports 9169\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9170 -j REDIRECT --to-ports 9170\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9171 -j REDIRECT --to-ports 9171\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9172 -j REDIRECT --to-ports 9172\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9173 -j REDIRECT --to-ports 9173\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9174 -j REDIRECT --to-ports 9174\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9175 -j REDIRECT --to-ports 9175\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9176 -j REDIRECT --to-ports 9176\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9177 -j REDIRECT --to-ports 9177\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9178 -j REDIRECT --to-ports 9178\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9179 -j REDIRECT --to-ports 9179\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9180 -j REDIRECT --to-ports 9180\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9181 -j REDIRECT --to-ports 9181\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9182 -j REDIRECT --to-ports 9182\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9183 -j REDIRECT --to-ports 9183\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9184 -j REDIRECT --to-ports 9184\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9185 -j REDIRECT --to-ports 9185\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9186 -j REDIRECT --to-ports 9186\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9187 -j REDIRECT --to-ports 9187\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9188 -j REDIRECT --to-ports 9188\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9189 -j REDIRECT --to-ports 9189\n-A PREROUTING -i vif+ -p udp -m udp --dport 53 -j REDIRECT --to-ports 5300\n-A PREROUTING -i vif+ -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -j REDIRECT --to-ports 9040\n-A OUTPUT -p udp -m owner --uid-owner 999 -m conntrack --ctstate NEW -j DNAT --to-destination 127.0.0.1:5400\n-A OUTPUT -p tcp -m owner --uid-owner 999 -m conntrack --ctstate NEW -j DNAT --to-destination 127.0.0.1:9041\n-A OUTPUT -m owner --uid-owner 1002 -j RETURN\n-A OUTPUT -m owner --uid-owner 106 -j RETURN\n-A OUTPUT -m iprange --dst-range 127.0.0.0-127.0.0.24 -j RETURN\n-A OUTPUT -m iprange --dst-range 10.137.0.0-10.138.255.255 -j RETURN\n-A PR-QBS-SERVICES -d 10.137.255.254/32 -i vif+ -p tcp -m tcp --dport 8082 -j REDIRECT\nCOMMIT\n*filter\n:INPUT DROP [0,0]\n:FORWARD DROP [0,0]\n:OUTPUT DROP [0,0]\n-A INPUT -m conntrack --ctstate INVALID -j DROP\n-A INPUT -m state --state INVALID -j DROP\n-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,ACK -j DROP\n-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN FIN,SYN -j DROP\n-A INPUT -p tcp -m tcp --tcp-flags SYN,RST SYN,RST -j DROP\n-A INPUT -f -j DROP\n-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,PSH,ACK,URG -j DROP\n-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j DROP\n-A INPUT -i vif+ -p tcp -m tcp --dport 8082 -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n-A INPUT -m state --state ESTABLISHED -j ACCEPT\n-A INPUT -p icmp -j DROP\n-A INPUT -i vif+ -p udp -m udp --dport 5300 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9040 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9052 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9124 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9104 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9111 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9117 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9107 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9123 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9105 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9103 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9101 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9122 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9121 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9120 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9113 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9112 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9118 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9108 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9106 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9100 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9150 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9115 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9116 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9102 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9119 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9050 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9109 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9110 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9114 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9125 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m multiport --dports 9152:9189 -j ACCEPT\n-A INPUT -j DROP\n-A FORWARD -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -o vif+ -p tcp -m tcp --sport 8082 -j ACCEPT\n-A OUTPUT -m conntrack --ctstate INVALID -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -m state --state INVALID -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,ACK -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -p tcp -m tcp --tcp-flags FIN,SYN FIN,SYN -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -p tcp -m tcp --tcp-flags SYN,RST SYN,RST -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -f -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,PSH,ACK,URG -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -m state --state ESTABLISHED -j ACCEPT\n-A OUTPUT -m iprange --dst-range 127.0.0.0-127.0.0.24 -j ACCEPT\n-A OUTPUT -m iprange --dst-range 10.137.0.0-10.138.255.255 -j ACCEPT\n-A OUTPUT -m owner --uid-owner 1002 -j ACCEPT\n-A OUTPUT -m owner --uid-owner 106 -j ACCEPT\n-A OUTPUT -j REJECT --reject-with icmp-admin-prohibited\nCOMMIT\n```"},{"author":"Patrick","date_created":1461816691,"date_modified":1461816691,"content":"Whonix 12. iptables-save-deterministic\n```\n*mangle\n:PREROUTING ACCEPT [0,0]\n:INPUT ACCEPT [0,0]\n:FORWARD ACCEPT [0,0]\n:OUTPUT ACCEPT [0,0]\n:POSTROUTING ACCEPT [0,0]\nCOMMIT\n*nat\n:PREROUTING ACCEPT [0,0]\n:INPUT ACCEPT [0,0]\n:OUTPUT ACCEPT [0,0]\n:POSTROUTING ACCEPT [0,0]\n:PR-QBS-SERVICES - [0,0]\n-A PREROUTING -j PR-QBS-SERVICES\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9052 -j REDIRECT --to-ports 9052\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9050 -j REDIRECT --to-ports 9050\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9100 -j REDIRECT --to-ports 9100\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9101 -j REDIRECT --to-ports 9101\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9102 -j REDIRECT --to-ports 9102\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9103 -j REDIRECT --to-ports 9103\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9104 -j REDIRECT --to-ports 9104\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9105 -j REDIRECT --to-ports 9105\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9106 -j REDIRECT --to-ports 9106\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9107 -j REDIRECT --to-ports 9107\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9108 -j REDIRECT --to-ports 9108\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9109 -j REDIRECT --to-ports 9109\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9110 -j REDIRECT --to-ports 9110\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9111 -j REDIRECT --to-ports 9111\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9112 -j REDIRECT --to-ports 9112\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9113 -j REDIRECT --to-ports 9113\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9114 -j REDIRECT --to-ports 9114\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9115 -j REDIRECT --to-ports 9115\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9116 -j REDIRECT --to-ports 9116\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9117 -j REDIRECT --to-ports 9117\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9118 -j REDIRECT --to-ports 9118\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9119 -j REDIRECT --to-ports 9119\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9120 -j REDIRECT --to-ports 9120\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9121 -j REDIRECT --to-ports 9121\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9122 -j REDIRECT --to-ports 9122\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9123 -j REDIRECT --to-ports 9123\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9124 -j REDIRECT --to-ports 9124\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9125 -j REDIRECT --to-ports 9125\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9150 -j REDIRECT --to-ports 9150\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9152 -j REDIRECT --to-ports 9152\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9153 -j REDIRECT --to-ports 9153\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9154 -j REDIRECT --to-ports 9154\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9155 -j REDIRECT --to-ports 9155\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9156 -j REDIRECT --to-ports 9156\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9157 -j REDIRECT --to-ports 9157\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9158 -j REDIRECT --to-ports 9158\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9159 -j REDIRECT --to-ports 9159\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9160 -j REDIRECT --to-ports 9160\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9161 -j REDIRECT --to-ports 9161\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9162 -j REDIRECT --to-ports 9162\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9163 -j REDIRECT --to-ports 9163\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9164 -j REDIRECT --to-ports 9164\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9165 -j REDIRECT --to-ports 9165\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9166 -j REDIRECT --to-ports 9166\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9167 -j REDIRECT --to-ports 9167\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9168 -j REDIRECT --to-ports 9168\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9169 -j REDIRECT --to-ports 9169\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9170 -j REDIRECT --to-ports 9170\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9171 -j REDIRECT --to-ports 9171\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9172 -j REDIRECT --to-ports 9172\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9173 -j REDIRECT --to-ports 9173\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9174 -j REDIRECT --to-ports 9174\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9175 -j REDIRECT --to-ports 9175\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9176 -j REDIRECT --to-ports 9176\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9177 -j REDIRECT --to-ports 9177\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9178 -j REDIRECT --to-ports 9178\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9179 -j REDIRECT --to-ports 9179\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9180 -j REDIRECT --to-ports 9180\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9181 -j REDIRECT --to-ports 9181\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9182 -j REDIRECT --to-ports 9182\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9183 -j REDIRECT --to-ports 9183\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9184 -j REDIRECT --to-ports 9184\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9185 -j REDIRECT --to-ports 9185\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9186 -j REDIRECT --to-ports 9186\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9187 -j REDIRECT --to-ports 9187\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9188 -j REDIRECT --to-ports 9188\n-A PREROUTING -i vif+ -p tcp -m tcp --dport 9189 -j REDIRECT --to-ports 9189\n-A PREROUTING -i vif+ -p udp -m udp --dport 53 -j REDIRECT --to-ports 5300\n-A PREROUTING -i vif+ -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -j REDIRECT --to-ports 9040\n-A OUTPUT -p udp -m owner --uid-owner 999 -m conntrack --ctstate NEW -j DNAT --to-destination 10.137.3.1:5300\n-A OUTPUT -p tcp -m owner --uid-owner 999 -m conntrack --ctstate NEW -j DNAT --to-destination 10.137.3.1:9040\n-A OUTPUT -m owner --uid-owner 107 -j RETURN\n-A OUTPUT -m owner --uid-owner 1001 -j RETURN\n-A OUTPUT -m iprange --dst-range 127.0.0.0-127.0.0.24 -j RETURN\n-A OUTPUT -m iprange --dst-range 10.137.0.0-10.137.255.255 -j RETURN\n-A PR-QBS-SERVICES -d 10.137.255.254/32 -i vif+ -p tcp -m tcp --dport 8082 -j REDIRECT\nCOMMIT\n*filter\n:INPUT DROP [0,0]\n:FORWARD DROP [0,0]\n:OUTPUT DROP [0,0]\n-A INPUT -m conntrack --ctstate INVALID -j DROP\n-A INPUT -m state --state INVALID -j DROP\n-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,ACK -j DROP\n-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN FIN,SYN -j DROP\n-A INPUT -p tcp -m tcp --tcp-flags SYN,RST SYN,RST -j DROP\n-A INPUT -f -j DROP\n-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,PSH,ACK,URG -j DROP\n-A INPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j DROP\n-A INPUT -i vif+ -p tcp -m tcp --dport 8082 -j ACCEPT\n-A INPUT -i lo -j ACCEPT\n-A INPUT -m state --state ESTABLISHED -j ACCEPT\n-A INPUT -p icmp -j DROP\n-A INPUT -i vif+ -p udp -m udp --dport 5300 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9040 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9052 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9050 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9100 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9101 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9102 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9103 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9104 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9105 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9106 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9107 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9108 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9109 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9110 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9111 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9112 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9113 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9114 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9115 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9116 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9117 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9118 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9119 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9120 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9121 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9122 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9123 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9124 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9125 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m tcp --dport 9150 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m multiport --dports 9152:9159 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m multiport --dports 9160:9169 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m multiport --dports 9170:9179 -j ACCEPT\n-A INPUT -i vif+ -p tcp -m multiport --dports 9180:9189 -j ACCEPT\n-A INPUT -j DROP\n-A FORWARD -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -o vif+ -p tcp -m tcp --sport 8082 -j ACCEPT\n-A OUTPUT -m conntrack --ctstate INVALID -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -m state --state INVALID -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,ACK -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -p tcp -m tcp --tcp-flags FIN,SYN FIN,SYN -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -p tcp -m tcp --tcp-flags SYN,RST SYN,RST -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -f -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG FIN,SYN,RST,PSH,ACK,URG -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -p tcp -m tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j REJECT --reject-with icmp-admin-prohibited\n-A OUTPUT -m state --state ESTABLISHED -j ACCEPT\n-A OUTPUT -m iprange --dst-range 127.0.0.0-127.0.0.24 -j ACCEPT\n-A OUTPUT -m iprange --dst-range 10.137.0.0-10.137.255.255 -j ACCEPT\n-A OUTPUT -m owner --uid-owner 107 -j ACCEPT\n-A OUTPUT -m owner --uid-owner 1001 -j ACCEPT\n-A OUTPUT -j REJECT --reject-with icmp-admin-prohibited\nCOMMIT\n```"},{"author":"Patrick","date_created":1461816708,"date_modified":1461816708,"content":"The diff looks sane."}]},"PHID-TASK-4y7eyypbb2bdqniazwex":{"id":"464","title":"replace rinetd with socat","status":"resolved","priority":"Normal","author":"Patrick","description":"There is now a real reason to transition away from rinetd. I don't think upstream still cares about rinetd. Never got a reply to the following inquiry.\n\n* https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=796235\n* https://www.whonix.org/pipermail/whonix-devel/2015-August/000405.html\n\n(Socat would be useful for better [I2PBOX](https://www.whonix.org/wiki/I2P#Installing_I2P_on_Whonix-Gateway_.28I2PBOX.29) support. - https://www.whonix.org/pipermail/whonix-devel/2016-January/000501.html)\n\n-----\n\n```\nsocat TCP-LISTEN:9050,fork TCP:10.137.2.1:9050\n```\n\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/etc/rinetd.conf.anondist\n\n-----\n\nMigrated from:\nhttps://github.com/Whonix/Whonix/issues/341","comments":[{"author":"marmarek","date_created":1452294179,"date_modified":1452294179,"content":"What about iptables redirect? Isn't that enough, or some problems with it?"},{"author":"Patrick","date_created":1452296383,"date_modified":1462420042,"content":"iptables cannot redirect local port traffic to remote ports, otherwise\nthese tools would not be needed."},{"author":"HulaHoop","date_created":1454484492,"date_modified":1454484492,"content":"A very ugly crypto bug/backdoor was dug up in socat. Maybe an aternative is better?\n\nhttp://arstechnica.com/security/2016/02/crypto-flaw-was-so-glaring-it-may-be-intentional-eavesdropping-backdoor/"},{"author":"marmarek","date_created":1454496113,"date_modified":1454496113,"content":"As no crypto is used in Whonix (and generally nothing more than simple\nTCP connection), I think it doesn't matter."},{"author":"Patrick","date_created":1462495948,"date_modified":1462495948,"content":"https://forums.whonix.org/t/retroshare-tickets/2364/2?u=patrick makes me wonder, if this whole thing should be configurable using a `.d` configuration folder.\n\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/usr/lib/anon-ws-disable-stacked-tor/socat-unix-sockets could be simplified. To allow arbitrary local workstation ports being redirected to the gateway, maybe the config file should just be a long list of socat commands that get executed one after another?"},{"author":"HulaHoop","date_created":1462739971,"date_modified":1462739971,"content":"> https://forums.whonix.org/t/retroshare-tickets/2364/2?u=patrick makes me wonder, if this whole thing should be configurable using a .d configuration folder.\n\nAgreed.\n\n> https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/usr/lib/anon-ws-disable-stacked-tor/socat-unix-sockets could be simplified. To allow arbitrary local workstation ports being redirected to the gateway, maybe the config file should just be a long list of socat commands that get executed one after another?\n\nYes would be more convenient and extendable."},{"author":"Patrick","date_created":1465424873,"date_modified":1465424873,"content":"https://github.com/Whonix/anon-ws-disable-stacked-tor"},{"author":"Patrick","date_created":1465424887,"date_modified":1465424887,"content":"https://github.com/Whonix/anon-ws-disable-stacked-tor/commit/2ead73c2d15ba39836ec14f122a14f5047bb768a"},{"author":"Patrick","date_created":1465426251,"date_modified":1465426251,"content":"https://github.com/Whonix/anon-ws-disable-stacked-tor/commit/57673fa1923536319853dcc93a148703dbb3eabc\nhttps://github.com/Whonix/whonix-legacy/commit/7d2ae02c19b907926c63ce6613310740e70e53dc"},{"author":"Patrick","date_created":1474658262,"date_modified":1474658262,"content":"I kept this as review, since this all has to be tested again when a new build has been created."},{"author":"Patrick","date_created":1520382110,"date_modified":1520382110,"content":"(superseded by systemd socket activation)"}]},"PHID-TASK-tbtsoc5w3d7odtrpqjhx":{"id":"463","title":"Qubes-Whonix-Workstation DispVM Support","status":"resolved","priority":"Normal","author":"Patrick","description":"__TODO abstract__:\n\nMake sure Qubes-Whonix-Workstation can be used as DispVM.\n\n-----\n\n__TODO specific__:\n\n~~whonixcheck is already working in a Qubes-Whonix-Workstation DispVM in the Whonix 13 development version. Apparently the Qubes upstream issue [home folder of template not inherited by DispVM](https://github.com/QubesOS/qubes-issues/issues/1335) is the only thing preventing this.~~\n\n-----\n\n__History__:\n\nThanks to the help of @marmarek two issues preventing this were already fixed.\n\n* https://github.com/QubesOS/qubes-issues/issues/1328\n* https://github.com/QubesOS/qubes-issues/issues/1591\n\nRelated:\n\n* `no longer write to home folder directly; use /etc/skel`:T419\n* `up to date versions of Tor Browsers in newly created AppVMs inherited from updated TemplateVMs`: T417\n\nuser documentation stub:\nhttps://www.whonix.org/wiki/Qubes/Disposable_VM\n","comments":[{"author":"Patrick","date_created":1452206388,"date_modified":1452206388,"content":"```\nseparate done file for Qubes TemplateVMs to make this work with the\ncurrent home folder population for Qubes DispVMs.\nhttps://github.com/QubesOS/qubes-core-agent-linux/blob/f380c346cf9af3f058b8ece853d7d4a5ece28815/misc/dispvm-prerun.sh#L6-L12\n\nhttps://phabricator.whonix.org/T419\nhttps://phabricator.whonix.org/T463\n```\nhttps://github.com/Whonix/whonix-base-files/commit/9ade708ed7288a1fec4a662b2bf062a8ebffc15c"},{"author":"Patrick","date_created":1462416426,"date_modified":1462416426,"content":"Qubes-Whonix-Workstation DispVM Support is done on Whonix VM level, but not on Qubes dom0 level.\n\n`echo konsole | /usr/lib/qubes/qfile-daemon-dvm qubes.VMShell dom0 DEFAULT red` and then running `whonixcheck` or `torbrowser` works.\n\nQubes bug [qvm-open-in-vm opens URLs in non-default browser](https://github.com/QubesOS/qubes-issues/issues/1487) is an issue, because links are opened in iceweasel rather than Tor Browser.\n\nNot having [Whonix default VM settings fixes - salt management](https://github.com/QubesOS/qubes-issues/issues/1954) (3) is an even more serious issue."},{"author":"Patrick","date_created":1463512877,"date_modified":1463512877,"content":"The above is not something I can solve for Whonix 13. Therefore removing #Whonix_13 milestone."},{"author":"marmarek","date_created":1505348694,"date_modified":1505348694,"content":"qubes-devel discussion: https://groups.google.com/d/msgid/qubes-devel/0f80b2a7-af84-fe3c-db9b-5d9bbeedfea6%40riseup.net"},{"author":"marmarek","date_created":1505349394,"date_modified":1505349394,"content":"https://github.com/QubesOS/qubes-mgmt-salt-dom0-virtual-machines/pull/5"},{"author":"Patrick","date_created":1550479174,"date_modified":1550479174,"content":"Looks like nothing more to do here."}]},"PHID-TASK-76fnafckq22lzsyms2tx":{"id":"462","title":"Gateway PREROUTING rules for SOCKS ports may interfere with trans port traffic","status":"resolved","priority":"Normal","author":"bubblewap","description":"Hello again,\n\nThis follows from a discussion in:\nhttps://forums.whonix.org/t/iptables-gateway-prerouting-cant-acess-specific-ports-through-trans-port/1850\n\nThe nat PREROUTING rules of Whonix Gateway firewall for all SOCKS ports should probably match on the gateway IP address in addition to the port.\n\nThe current rules resolve to (gotten from iptables-save):\n```\nPREROUTING -i eth1 -p tcp -m tcp --dport 9189 -j REDIRECT --to-ports 9189\n```\nThey should probably be:\n```\nPREROUTING -i eth1 -d 10.152.152.10 -p tcp -m tcp --dport 9189 -j REDIRECT --to-ports 9189\n```\n\nThey can probably be further simplified to:\n```\nPREROUTING -i eth1 -d 10.152.152.10 -p tcp -m tcp --dport 9189 -j ACCEPT\n```\n(but this is not well tested)\n\nOn my system, if the rules do not match on the gateway IP address, the rules interfere with Trans port communication for packets going out (via trans port 9040) with the same destination port as any of the socks ports, effectively blocking them.\n\nBased on the previous discussion, it is not clear that this poses an issue for everyone, or in what cases it applies exactly, but on my system (Whonix 11 dist-upgraded), the problem is always reproducible. Adding a socks port and rules for port 443 using existing Whonix rules on the gateway - this results in \"curl.anondist-orig https://www.whonix.org\" no longer working on the workstation. Adding \"-d 10.152.152.10\" works and I believe would be logical to have in any case.\n\nNote the DNS and Trans port PREROUTING rules must remain the way they are, those ones are ok, it's only the socks ports rules that may have an issue.\n\nhttps://github.com/Whonix/whonix-gw-firewall/blob/c26d7395e1d0a6d03ffca320109869bdb5b383a7/usr/bin/whonix_firewall#L436-L509\n","comments":[{"author":"Patrick","date_created":1451954841,"date_modified":1451954841,"content":"Not all that simple to fix.\n\nThis would break TorBirdy. Just now tested.\n\nThe version currently installed from Debian still uses the old Whonix-Gateway IP from previous versions.\n\n( https://github.com/ioerror/torbirdy/commit/b44db6e23773fea1d079acb88980b34f1733844f )\n\nPerhaps similar cases.\n\nAlso, in Qubes, the IP of Qubes-Whonix-Gateway is not static. ([Qubes does not yet support static IP addresses.](https://github.com/QubesOS/qubes-issues/issues/1477))\n\nSo applications able to connect with wrong socks proxy settings is currently a handy feature.\n\nMaybe we could accept destination 192.168.0.10, 10.152.152.10, the Qubes range (?), and ignore the rest?"},{"author":"bubblewap","date_created":1451958051,"date_modified":1451959133,"content":"I had no idea you had to deal with dynamic IPs, but I've had a completely unrelated system where I ran into a similar issue.\n\nThe solution there was to convert the firewall script to an iptables-save script that can be loaded atomically with iptables-restore, and reload the firewall script after network goes up and IPs come in (with extra bash to get the interface IP).\n\n(I'm not 100% on the safety of atomic iptables-restore operation - should be researched just to be safe - but on that system it was a non issue)\n\nAlternatively, depending on how the apps are configured in Qubes Whonix Workstation (I don't know!) this could be a non-issue. If the apps are configured to connect to 10.152.152.10 and 192.168.0.10 on qubes, then instead of the last rule conversion I suggested:\n```\nPREROUTING -i eth1 -d 10.152.152.10 -p tcp -m tcp --dport 9189 -j ACCEPT\n```\nyou could just go back to the redirect:\n```\nPREROUTING -i eth1 -d 10.152.152.10 -p tcp -m tcp --dport 9189 -j REDIRECT --to-ports 9189\n```\n\nand it might \"just work\" (10.152.152.10 will become the qubes IP on the packet). But it depends on how the apps are configured in qubes whonix workstation (I don't know!).\n\n(and of course you double up one or more of those rules for 192.168.0.10)"},{"author":"bubblewap","date_created":1451959960,"date_modified":1451960559,"content":"Hmm, I think you can disregard the last (\"Alternatively, ...\") part of my comment. I looked at your script files https://github.com/Whonix/qubes-whonix/blob/master/usr/lib/qubes-whonix/replace-ips and so it seems you replace the IPs in all the config files. Sorry. [suggestion only works if the app config is static]\n\nI thought you might've kept static configurations and sent it all to the gateway through routing (because the PREROUTING rules I'd noticed end up working no matter the IP in many cases, and I've exploited this myself [in something other than this ticket])."},{"author":"bubblewap","date_created":1451970600,"date_modified":1451970600,"content":"Given the previous I can think of no other ideas and your initial suggestion was the simplest:\n\n> Maybe we could accept destination 192.168.0.10, 10.152.152.10, the Qubes range (?), and ignore the rest?\n\nYou could probably capture the whole private IP address space since Tor shouldn't route it (?), but less is more so yours is better.\n\nIn any case if you know the static qubes range in advance (10.777.777.0/24), I think this would work (assuming this port needs all the IPs):\n```\nPREROUTING -i eth1 -d 192.168.0.10 -p tcp -m tcp --dport 9189 -j REDIRECT --to-ports 9189\nPREROUTING -i eth1 -d 10.152.152.10,10.777.777.0/24 -p tcp -m tcp --dport 9189 -j ACCEPT\n```\nIf I understood the configuration correctly, only 192.168.0.10 needs the REDIRECT jump. 10.152.152.10 should be ACCEPT unless there are configurations not accounted for; either's probably fine. For ranges it's probably better to use ACCEPT (so unconcerned IPs get filtered out by the host instead of redirected).\n\nIf you can't know the qubes range and you can't get or action on the dynamic IP, then as a last resort:\n```\nPREROUTING -i eth1 -d 192.168.0.10 -p tcp -m tcp --dport 9189 -j REDIRECT --to-ports 9189\nPREROUTING -i eth1 -d 10.0.0.0/8,172.16.0.0/12,192.168.0.0/16 -p tcp -m tcp --dport 9189 -j ACCEPT\n```\nTake with grain of salt because I'm tired."},{"author":"Patrick","date_created":1451998118,"date_modified":1459872802,"content":"Qubes-Whonix-Gateway/Workstation IP's 'only' change after boot. Fortunately, they don't change while the system is running. So the current /usr/bin/whonix_firewall script is dynamic enough.\n\nThe replace-ips script is not something I like. I would like to abolish it. Probably not possible until Qubes supports static IPs. ([Qubes feature request, optional static IP addresses](https://github.com/QubesOS/qubes-issues/issues/1477))\n\nQubes IP range (already defined in the firewall script) should be `10.137.0.0-10.137.255.255`, right? @marmarek"},{"author":"marmarek","date_created":1451998662,"date_modified":1451998662,"content":">   Qubes IP range (already defined in the firewall script) should be `10.137.0.0-10.137.255.255`, right? @marmarek\n\nYes."},{"author":"marmarek","date_created":1451998728,"date_modified":1451998728,"content":">   >   Qubes IP range (already defined in the firewall script) should be `10.137.0.0-10.137.255.255`, right? @marmarek\n>   \n>   Yes.\n\nNo... DispVMs has 10.138.x.x. So it should be\n`10.137.0.0-10.138.255.255`."},{"author":"Patrick","date_created":1452001423,"date_modified":1452001423,"content":"Okay. Using that IP range now:\nhttps://github.com/Whonix/whonix-gw-firewall/commit/7f5f65f6bf682a7f7df1df37976b8733f933f239\n"},{"author":"Patrick","date_created":1476295682,"date_modified":1476295682,"content":"Now implemented:\n\nhttps://github.com/Whonix/whonix-gw-firewall/commit/e4e8d73af263364870ec7ee6853d689e707991a0\n\nSince this change had the potential of breaking all stream isolation, also added a unit test:\n\nhttps://github.com/Whonix/whonix-ws-firewall/commit/28845cca125e74a9656a2863643875d22a4cb940\n"},{"author":"Patrick","date_created":1476312538,"date_modified":1476312538,"content":"https://github.com/Whonix/whonix-gw-firewall/commit/0b43f74331fec0b93b15bc4c463c745215fa824f"}]},"PHID-TASK-be7o7fngguw6e36cwh6t":{"id":"461","title":"Installation from Repository / proverbial \"sudo apt-get install whonix\"","status":"resolved","priority":"Normal","author":"Patrick","description":"https://www.whonix.org/wiki/Dev/Installation_from_Repository\n\ndiscussion:\n`'sudo apt-get install whonix-(gateway|workstation)' feature`\nhttps://groups.google.com/forum/#!msg/qubes-devel/3-BC87cbWVk/Xby-YeqUBwAJ\n\nTODO:\n\n* Requires making Whonix build and work without several [chroot scripts](https://www.whonix.org/wiki/Dev/Source_Code_Intro#Chroot_Scripts). Reimplementing them in postinst or otherwise.\n* Handle whonixcheck Whonix News without build version file somehow or have somehow a build version file created.\n","comments":[{"author":"Patrick","date_created":1451951978,"date_modified":1451951978,"content":"`converted chroot-script 40_add_torprojects_key to postinst script`:\nhttps://github.com/Whonix/anon-shared-build-apt-sources-tpo/commit/495fc4cf73392dc9b9fd7e780afb92eb16c32d80\n"},{"author":"Patrick","date_created":1451954087,"date_modified":1451954087,"content":"```\nlog build version\n\nSo the chroot-script\nhttps://github.com/Whonix/anon-shared-build-log-build-version/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/70_log_build_version\ncan be deprecated.\n```\nhttps://github.com/Whonix/anon-base-files/commit/a9752eb30fa3347fd0b0cf555720b6218ffb0d32\n\n```\nremoved anon-shared-build-log-build-version\n\nBecause that is now implemented in anon-base-files postinst.\n```\nhttps://github.com/Whonix/anon-meta-packages/commit/a8d9e666da27e04abf5e567cdcddd97eaee54339\n"},{"author":"HulaHoop","date_created":1452033460,"date_modified":1452033460,"content":"Its a great leap towards upstreaming and overlaps with some work needed for a hypothetical Whonix-Host metapackage.\n\nThis could solve the porting nightmare to new architectures. All a user would need to do on an ARM machine is just download the vanilla Debian images, install apt-transport-tor, add the Whonix repo and BAM! They are converted it into the Whonix images."},{"author":"Patrick","date_created":1459876245,"date_modified":1459876245,"content":"```\nremoved anon-shared-build-upgrade-torsocks since no longer required\n    \n(version from Debian is recent enough)\n\nthereby chroot-script deprecated\n    \nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/Whonix/commit/cc79fa15580bcb43f01e14d8f306b38eb8e0073e\n"},{"author":"Patrick","date_created":1459957836,"date_modified":1459957836,"content":"```\nremoved anon-shared-build-inst-tb because it has been merged into tb-updater\n\nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/Whonix/commit/5b9189fc6397d24a20cd4d06abc74d63fc9f306c"},{"author":"Patrick","date_created":1459972612,"date_modified":1459972612,"content":"```\nconverted chroot scripts into postinst script\n\nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/anon-shared-build-apt-sources-tpo/commit/495fc4cf73392dc9b9fd7e780afb92eb16c32d80"},{"author":"Patrick","date_created":1459973854,"date_modified":1459973854,"content":"Created a new package:\nhttps://github.com/Whonix/apt-during-apt\n\n-----\n\nMore background:\n* T472#8603\n* T472#8606\n\n-----\n\n```\ndownload packages tor and tor-geoipdb from The The Project's apt repository\n\nusing apt-during-apt\n\nthereby abolished previous chroot scripts for doing that\n```\nhttps://github.com/Whonix/anon-gw-anonymizer-config/commit/8db878bb634f01e6789c4e44ee10ce2d24f3d1d1"},{"author":"Patrick","date_created":1459974037,"date_modified":1459974037,"content":"```\ndeprecated anon-gw-build-upgrade-tor package since now integrated as postinst\n\nin package anon-gw-anonymizer-config\n\nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/Whonix/commit/b40ad931432498b5865d341d10c102fdd487cfda"},{"author":"Patrick","date_created":1459987566,"date_modified":1459987566,"content":"```\ncleanup, got rid of obsolete /usr/lib/anon-dist/chroot-scripts-pre.d/20_sanity_checks\n\nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/anon-shared-build-sanity-checks/commit/55d1c95b06d38245e6505191cd3f03f440dbbd8b"},{"author":"Patrick","date_created":1459989129,"date_modified":1459989129,"content":"```\nfixed logging version of the package as build version\n\nin case anon_dist_build_version is not set\n\nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/anon-base-files/commit/a2bc954be3cadd8bbb710dfbdd1351267f6a35ad\n\n```\nremoved anon-shared-build-log-build-version because it was merged into anon-base-files\n\nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/Whonix/commit/a82bbc43599767d40b3151246b74d159276b4979\n"},{"author":"Patrick","date_created":1459991282,"date_modified":1459991282,"content":"There are only 4 [chroot scripts](https://www.whonix.org/wiki/Dev/Source_Code_Intro#Chroot_Scripts) left.\n\n```\nfind . -type f -not -iwholename '*.git*' | grep chroot-script\n```\n\n* https://github.com/adrelanos/anon-shared-build-sanity-checks/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/20_sanity_checks\n* https://github.com/adrelanos/whonix-initializer/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/80_cleanup\n* https://github.com/adrelanos/anon-shared-build-ban-nonfree/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/75_vrms\n* https://github.com/adrelanos/anon-shared-build-remember-sources/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/75_sources\n\nI am wondering how/where to most elegantly re-implement them."},{"author":"Patrick","date_created":1460055484,"date_modified":1460055484,"content":"```\ncheck for nonfree packages during\n\nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/whonixcheck/commit/41eb9e1eba1b1e45c39ff20b3730bf184d6432fe\n\n```\nremoved anon-shared-build-ban-nonfree because it was merged into whonixcheck\n\nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/Whonix/commit/471b9aa5cbe0a28d6b5631dff3ba1b08420f3895"},{"author":"Patrick","date_created":1460056303,"date_modified":1460056303,"content":"```\nmerged chroot scripts from anon-shared-build-sanity-checks and anon-shared-build-remember-sources\n\nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/whonix-initializer/commit/151eec132b99f64d50fea0e8d5b909c68d24c4ad\n\n```\nadded dependencies debsums and damngpl for new chroot scripts that were merged\n\nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/whonix-initializer/commit/d087c4490a63928b922869aa3ede852cd2994a3d\n\n```\nremoved anon-shared-build-remember-sources and anon-shared-build-sanity-checks\n\nbecause they were merged into whonix-initializer\n\nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/Whonix/commit/e74de8c44c29c4888b05586546f069b14c99fb6a"},{"author":"Patrick","date_created":1460057428,"date_modified":1460057428,"content":"* Chroot scripts were reduced to a minimum.\n* They are no longer relevant for installation of Whonix from repository using `apt-get install whonix-gateway`etc.\n* Non-Qubes-Whonix: chroot scripts are still relevant for building Non-Qubes-Whonix images using Whonix's build script. To my knowledge, there is no sane way to run the [cleanup chroot script](https://www.whonix.org/wiki/Dev/Source_Code_Intro#whonix-initializer) from within a Debian package maintainer script.\n* Qubes-Whonix: chroot-scripts are mostly irrelevant. Mostly. When the `whonix-gateway` or `whonix-workstation` package gets installed into a Qubes Debian template - with the purpose of morphing it into Whonix - perhaps while running on top of the Qubes installer DVD - then the [cleanup](https://github.com/marmarek/qubes-builder-debian/blob/master/template_debian/09_cleanup.sh) of the template would be up to the script doing that. It could do so by running [/usr/lib/anon-dist/chroot-scripts-post.d/80_cleanup](https://github.com/Whonix/whonix-initializer/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/80_cleanup) or otherwise."},{"author":"marmarek","date_created":1460063528,"date_modified":1460063528,"content":"Great! This will allow major reduction of duplicated data on installation ISO (Debian base packages, Whonix gw/ws common packages). And also result in smaller Whonix templates (no build depends installed there).\nAs for the cleanup - that's fine - it can be done using salt management stack.\n\nOne minor thing: when installing Whonix from firstboot, it should be done without network access, because we can't assume user have set it at that stage. But that isn't a problem - we can bundle copy of appropriate deb packages in installation image. Then creating Whonix templates would look like this:\n1. Clone `debian-8` template to `whonix-gw`/`whonix-ws`\n2. Start `whonix-ws`/`whonix-gw`\n3. `qvm-block --ro -A whonix-ws dom0:/usr/share/qubes-whonix/repository.img`\n4. `qvm-run whonix-ws 'mkdir /mnt/whonix-repo && mount /dev/xvdi /mnt/whonix-repo`\n5. Add `/mnt/whonix-repo` to `/etc/apt/sources.list.d/whonix-local.list` (or sth like this)\n6. Install appropriate packages (`whonix-gateway`/`whonix-workstation`)\n7. Remove temporary repository, execute cleanup script, shutdown VM\n\nThat local repository could be easily created using `apt-get --download-only install whonix-gateway whonix-workstation`. \nInstead of mounting repository as a block device, we could ship AppVM/ProxyVM with HTTP server configured, but IMO that would be overkill.\nAny better idea? Do you see any drawbacks of such approach?\n\nQuestion: do we need Debian minimal template for that? Or standard template also can be morphed into Whonix template?"},{"author":"Patrick","date_created":1460071572,"date_modified":1460071572,"content":"I yet have to actually try `apt-get install whonix-...` and see how it goes. Will work on this next.\n\n>>! In T461#8640, @marmarek wrote:\n> One minor thing: when installing Whonix from firstboot, it should be done without network access, because we can't assume user have set it at that stage. But that isn't a problem - we can bundle copy of appropriate deb packages in installation image.\n\nOne complication. Tor Browser. If tb-updater no longer runs in a chrooted environment with network access, it cannot download Tor Browser from torproject.org. Any idea how to solve that?\n\nWe concluded earlier already we don't want to have a debian package hosting Tor Browser tarballs (tb-binary). (Mentioned in T417.) We might reconsider if not avoidable.\n\nOne way or another, Tor Browser tarballs would have to end up on Qubes installer DVD, then be copied into the to-be-morphed-to-Whonix Qubes Debian template. From there, tb-updater could take over with installation. (reusing that existing code)\n\n> That local repository could be easily created using `apt-get --download-only install whonix-gateway whonix-workstation`. \n\nSure, I don't think that would resolve and download the dependencies also?\n\n> Instead of mounting repository as a block device, we could ship AppVM/ProxyVM with HTTP server configured, but IMO that would be overkill.\n\nYes, that sounds overkill. At least if not needed for various other purposes also.\n\n> Any better idea? Do you see any drawbacks of such approach?\n\nYour idea sounds alright. No objections, just the details mentioned in this comment.\n\n> Question: do we need Debian minimal template for that? Or standard template also can be morphed into Whonix template?\n\nAt the moment the packages expect nothing other than Debian, something as minimal as a debootstrapped system. [everything else could be seen as a package bug]\n\nHowever, I don't think we need the Debian minimal template. For two reasons.\n\n* It's less tested.\n* It has had issues in past.\n\nMaybe these are no valid reasons. (Issues in past were due to missing installed Qubes default packages. And after it was morphed into Whonix, it would be more widely tested.)\n\nDebian standard template should work,\n* as soon as ported to gnome to avoid duplicate applications (konsole plus gnome-terminal installed at the same time), i.e. Whonix 14.\n* as long as it does not install any [unwanted packages](https://github.com/Whonix/whonixcheck/blob/41eb9e1eba1b1e45c39ff20b3730bf184d6432fe/etc/whonix.d/30_whonixcheck_default.conf#L64-L74) by default."},{"author":"marmarek","date_created":1460074330,"date_modified":1460074330,"content":"> We concluded earlier already we don't want to have a debian package hosting Tor Browser tarballs (tb-binary). (Mentioned in T417.) We might reconsider if not avoidable.\n\nIndeed that may be a complication. In worst case we can include downloaded tarball in the same image as debs and have some script which will hand it over to `tb-updater` (copy to `/var/cache/tb-updater` so `tb-updater` will use that?). But that soulds like a hack, not a clean solution.\n\n> Sure, I don't think that would resolve and download the dependencies also?\n\n`apt-get --download-only install` should download everything what is needed. `apt-get download` downloads only a single package, not dependencies.\n\n> - It's less tested.\n> - It has had issues in past.\n\nHmm, maybe we should add it to the set of templates I'm running automated tests on? We don't have much tests for VM stuff, but at least something.\n\n> as long as it does not install any unwanted packages by default.\n\nThere is chrony + ntpdate. And there is also `/usr/bin/wnpp-check`, but it belongs to `devscripts` (that may be only my template, not installed by default).\n\nI see two possible solutions:\n- handled that using custom step in Whonix setup script (just before step 6)\n- have some (optional?) package, which will \"conflict\" with all the unwanted packages (\"conflict\" = the type of dependency which removes the other package - is it \"replaces\"?) "},{"author":"Patrick","date_created":1460074735,"date_modified":1460074735,"content":"current blockers:\n\n* 1) Tor Browser tarball / installation (described above)\n\n* 2) download of tor, tor-geoipdb, deb.torproject.org-keyring not possible (T472). If we have no networking during that stage... Which is on one hand a very good thing, so we do not depend on it.\n\nIf anyone has any ideas how to solve that without increasing maintenance effort..."},{"author":"marmarek","date_created":1460075971,"date_modified":1460075971,"content":"> 2) download of tor, tor-geoipdb, deb.torproject.org-keyring not possible (T472). If we have no networking during that stage... Which is on one hand a very good thing, so we do not depend on it.\n\nJust for installation it shouldn't be a problem - we can simply add `deb.torproject.org` repo for the time of `apt-get --download-only install ...`. But it doesn't help in anyway how to keep track on `tor` package later.\n\nHmm, maybe for T472 do not download the package separately, but simply keep some package with strict version dependency like `tor (= x.y.z)`? That should work in both cases - collecting packages for offline installation and later tracking its version. Does `deb.torproject.org` keep old version of packages in repository? "},{"author":"Patrick","date_created":1460129205,"date_modified":1460129205,"content":">>! In T461#8647, @marmarek wrote:\n>> 2) download of tor, tor-geoipdb, deb.torproject.org-keyring not possible (T472). If we have no networking during that stage... Which is on one hand a very good thing, so we do not depend on it.\n> \n> Just for installation it shouldn't be a problem - we can simply add `deb.torproject.org` repo for the time of `apt-get --download-only install ...`. But it doesn't help in anyway how to keep track on `tor` package later.\n\n[anon-shared-build-apt-sources-tpo](https://github.com/Whonix/anon-shared-build-apt-sources-tpo) could do that. It ships /etc/apt/souces.list.d/torproject.list. Then newer versions on installed systems would come from deb.torproject.org.\n\n> Hmm, maybe for T472 do not download the package separately, but simply keep some package with strict version dependency like `tor (= x.y.z)`? That should work in both cases - collecting packages for offline installation and later tracking its version.\n\n> Does `deb.torproject.org` keep old version of packages in repository? \n\nNo."},{"author":"HulaHoop","date_created":1460138062,"date_modified":1460140653,"content":"systemd-nspawn talked about as a drop in replacement for chroot in build environments:\n\nhttp://0pointer.de/blog/projects/changing-roots.html\nhttps://lindenberg.io/blog/post/debian-containers-with-systemd-nspawn/\n\nCould it be an answer for the chroot problem in non-Qubes builds?"},{"author":"Patrick","date_created":1460677166,"date_modified":1460677166,"content":"```\nadded install-from-local-repository script\n\nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/whonix-developer-meta-files/commit/976b7131002ddae909382236ccc907ae676345e5"},{"author":"Patrick","date_created":1460682988,"date_modified":1460682988,"content":"```\nmore robust handling of /etc/hostname\n\nhttps://phabricator.whonix.org/T461\n```\nhttps://github.com/Whonix/anon-base-files/commit/887094d1e21ec79ad03abc2364cb07fe0bc100cf"},{"author":"Patrick","date_created":1461104942,"date_modified":1461104942,"content":"This is done. Further work being tracked in T498."}]},"PHID-TASK-m6nhxor2ytgvipyljeti":{"id":"460","title":"fix shared VPN/Tor server leak bug","status":"resolved","priority":"Normal","author":"Patrick","description":"If the a Tor entry guard is running on the same server as the VPN Server (variable VPN_SERVERS), if the VPN breaks down, Tor may connect directly to the VPN if it happened to choose that as entry guard. This is a bug if the user wants to hide Tor.\n\nThe risk increases, if the VPN supports remote port forwarding, because that allows anyone to host a Tor entry guard and have it show up with the VPN's external IP.\n\nIt can be fixed by only allowing user `tunnel` to establish connections once VPN_FIREWALL has been set to 1. (As opposed to currently to allow connections to all IP defined by variable VPN_SERVERS.\n\nQubes:\nhttps://github.com/QubesOS/qubes-issues/issues/1941","comments":[{"author":"Patrick","date_created":1451421756,"date_modified":1451421756,"content":"`create user 'tunnel'`\nhttps://github.com/Whonix/whonix-gw-firewall/commit/00724fd517e66fed0fb52051635aecb9f8e8dca3\n\n`when VPN_FIREWALL=1, allow user 'tunnel'; abolished VPN_SERVERS variable`\nhttps://github.com/Whonix/whonix-gw-firewall/commit/c26d7395e1d0a6d03ffca320109869bdb5b383a7\n"},{"author":"Patrick","date_created":1451423330,"date_modified":1451423330,"content":"`simplify running OpenVPN as unprivileged user`\nhttps://github.com/Whonix/usability-misc/commit/91482787adedabaea6fa0e369784c0d4a05b41c0\n"},{"author":"Patrick","date_created":1452357869,"date_modified":1452357869,"content":"* https://github.com/Whonix/usability-misc/commit/81ff389dcadd390d52bae810ad06c8365b574d27\n* https://github.com/Whonix/usability-misc/commit/5a9f39dc9d7e576425b50c38a0be7d46847a0c41\n* https://github.com/Whonix/usability-misc/commit/f946e06b06e73c0f251ae39def4114c1e7082776\n* https://github.com/Whonix/usability-misc/commit/c26bfb72de8dd797ed79d2f41686f5f3d5ac3e62"},{"author":"Patrick","date_created":1462225226,"date_modified":1462225226,"content":"Works.\n\nDocumentation ( https://www.whonix.org/wiki/Next#VPN_before_Tor ) tested."}]},"PHID-TASK-3vlbqqvckvuqeea4arfw":{"id":"459","title":"VPN Firewall should not allow non-VPN connections to the VPN server","status":"open","priority":"Normal","author":"Patrick","description":"","comments":[]},"PHID-TASK-2sc5iouy6pqk53opdjch":{"id":"458","title":"research if there are further local clock leaks on Whonix-Gateway","status":"open","priority":"Normal","author":"Patrick","description":"[Quite a few local clock leaks in upstream projects have been identified and reported.](https://www.whonix.org/wiki/Dev/TimeSync#Local_Clock_Leaks)\n\n-----\n\nI think, there might be others. This is because I was involved in reporting some of these local clock leaks. They were only fixed, because by chance I happened to read historic Tor trac development discussions, and then using logic to draw the right conclusions, then reported bugs. I didn't read the related source codes nor checked with a traffic analyzer that there are no other local clock leaks. And I find it very likely, that no one else ever did that either, because these issues remained unnoticed for years.\n\n-----\n\n[1] I remember having read a thread about apt-get. It was mentioned, that it leaks the language to remote servers. Perhaps also installed packages. Among other stuff. Possibly also local clock? Would be good to have a list of these leaks.\n\n-----\n\nTODO\n\n* ~~1) ask TPO to think through if there are any further local clock leaks -> [check Tor for local clock leaks](https://trac.torproject.org/projects/tor/ticket/17911)~~\n* 2) research leaks by apt-get [1]\n* 3) figure out, and check using a tshark or wireshark regex that searches for timestamps\n","comments":[{"author":"HulaHoop","date_created":1450734837,"date_modified":1450734837,"content":"Are the instructions similar to the leaktests I ran before? How can I get started on this?"},{"author":"Patrick","date_created":1450739622,"date_modified":1450739622,"content":"I don't think there are any existing information. This requires original\nresearch."},{"author":"HulaHoop","date_created":1450744170,"date_modified":1450744170,"content":"Apt is http with all that would mean. From research on http 1.1 only the server supports timestamp requests from the client nothing in the other direction. That makes sense or else a website can be able to know a workstation's time from an sdwdate query."}]},"PHID-TASK-5uohugvg5ber4qsdhwyp":{"id":"457","title":"install accessibility tools by default","status":"invalid","priority":"Normal","author":"Patrick","description":"As per [Whonix - Advice on Accessibility for a Debian Derivative](https://lists.debian.org/debian-accessibility/2015/12/msg00043.html), the following packages should be installed by default.\n\ngnome-orca espeakup brltty brltty-speechd brltty-x11 console-braille florence dasher kdeaccessibility kvkbd kmousetool kmag kmouth jovie xbrlapi festival qt-at-spi\n\nMakes the images ~ 73 MB bigger. (Installed using `apt-get --no-install-recommends`.)\n\nInstalling these by default probably makes only sense in Non-Qubes-Whonix, as in a Qubes environment, these would have to be installed by default in dom0, I think.\n\n(These should be installed by default, and manual installation is not so useful, because the people requiring these tools in the first place, are not capable to install them by themselves without help of a third person.)\n\n[Especially for users requiring to use Tor Bridges, and a Non-Qubes-Whonix-Gateway, this poses a difficult to overcome obstacle. Recently got a mail by such a user.]","comments":[{"author":"Patrick","date_created":1452274770,"date_modified":1452274770,"content":"```\ninstall more accessibility tools by default\n\nanon-shared-kde-accessibility\n\ngnome-orca espeakup brltty brltty-speechd brltty-x11 console-braille florence dasher kdeaccessibility kvkbd kmousetool kmag kmouth jovie xbrlapi festival qt-at-spi\n```\nhttps://github.com/Whonix/anon-meta-packages/commit/dc2b97efef5af2ae67a4134480d1eb32f50da809"},{"author":"Patrick","date_created":1474598498,"date_modified":1474598498,"content":"brltty is problematic, because it opens a local listener port on `4101`. (T448#10396)"},{"author":"Patrick","date_created":1479937908,"date_modified":1479937908,"content":"`brltty floods both syslog and daemon.log`:\nhttps://forums.whonix.org/t/brltty-floods-both-syslog-and-daemon-log"},{"author":"Patrick","date_created":1479944504,"date_modified":1479944504,"content":"`/var/log/syslog spam host brltty[204]: file system mount error: usbfs[brltty-usbfs] -> /var/run/brltty/usbfs: No such device`:\nhttp://bugs.debian.org/cgi-bin/bugreport.cgi?bug=845496"},{"author":"Patrick","date_created":1480279598,"date_modified":1480279598,"content":"`espeakup` systemd unit restart fails during jessie to stretch upgrades."},{"author":"Patrick","date_created":1480279636,"date_modified":1480279636,"content":"```\nno longer install accessibility tools by default due to issues\n\nno longer depend on anon-shared-kde-accessibility\n\nhttps://phabricator.whonix.org/T457\n```\nhttps://github.com/Whonix/anon-meta-packages/commit/cd23ef486c1f404f9903f2605fdc2b5972c3bd2e\n"}]},"PHID-TASK-wbd5d6aug3dwpysfvz3k":{"id":"456","title":"msgdispatcher_dispatch_x 'details' and 'more help' button to improve whonixcheck error messages etc. usability","status":"open","priority":"Normal","author":"Patrick","description":"@bnvk suggested to shrink various #whonixcheck error messages. For example...\n\n> [ERROR] [whonixcheck] Tor Bootstrap Result:\n> Whonixcheck gave up waiting after 120 seconds.\n> Tor Circuit: established\n> Bootstrapping 5 % done. Tor reports: NOTICE BOOTSTRAP PROGRESS=100 TAG=done SUMMARY=\"Done\"\n> \n> Possible issues:\n> - Is the host's internet connection working?\n> - Whonix-Gateway will need a few moments for bootstrapping the Tor network.\n> - Do you live in a censored area?\n> \n>\n> Recommendations:\n> \n> 1.)\n> Shut down Whonix and try to get the Tor Browser Bundle from https://www.torproject.org\n> working on your host. If you cannot get the Tor Browser Bundle to work, you will most certainly not get Whonix to work either.\n> \n> The Tor Browser Bundle is great for testing if you live in a censored area. If you need bridges for the Tor Browser Bundle,\n> you will need them for Whonix as well.\n> \n> 2.)\n> Try again: dom0 -> Start Menu -> ServiceVM: sys-whonix -> Whonix Check\n> or in Terminal: whonixcheck\n> or in Terminal with debugging: whonixcheck --debug --verbose\n> \n> 3.)\n> Use arm, connection page two, to see if Tor is connected:\n> dom0 -> Start Menu -> ServiceVM: sys-whonix -> Arm\n> or in Terminal: arm\n\n* to remove \"after 120 seconds\"\n* to have a `Details` button that expands upon click\n* to have a `More Help` button that opens a help file\n\nThis requires #msgcollector, namely [msgdispatcher_dispatch_x](https://github.com/Whonix/msgcollector/blob/master/usr/lib/msgcollector/msgdispatcher_dispatch_x) (written in #python) modifications.","comments":[{"author":"joysn1980","date_created":1485254353,"date_modified":1485254489,"content":"Another old task\n\nhttps://github.com/joysn/msgcollector/blob/master/usr/lib/msgcollector/msgdispatcher_dispatch_x\n\nMajor Change was done \n1) Using QMessageBox instead of QDialog \nReason :- MessageBox easily supports extensible text (Showdetails/Hide Details)\n2) Using own QMessageBox on top of QMessageBox to reset the size of the message box\n3) Use the default icons for Info/Warn/Error instead of /usr/share/icons/oxygen/64x64/status/\n4) User can still supply its own icon and use it.\n\nPlease review\nStandalone testing can be done using \n./msgdispatcher_dispatch_x 'info' 'title' '[INFO] [whonixcheck] Tor Bootstrap Result:' 0\n./msgdispatcher_dispatch_x 'info' 'title' '[INFO] [whonixcheck] Tor Bootstrap Result:' 1\n./msgdispatcher_dispatch_x 'error' 'title' '[ERROR] [whonixcheck] Tor Bootstrap Result:' 0\n./msgdispatcher_dispatch_x 'warning' 'title' '[ERROR] [whonixcheck] Tor Bootstrap Result:' 0\n\nI have also tested it by putting it in /usr/lib/msgcollector/\nWorks fine. Couple of screen shots\n\n{F109727}\n{F109724}\n\n"},{"author":"Patrick","date_created":1485263747,"date_modified":1485263747,"content":"This is mostly a #usability question. Wondering if better to only have a `Show Details` button or to have both, a `Show Details` and `More Help` button. How can we make such error messages most helpful for the user?\n\nWhat about this...\n\n----\n\nMain (the usual as of before this ticket) popup:\n\n\n\n> [ERROR] [whonixcheck] Tor Bootstrap Result:\n> Whonixcheck gave up waiting.\n> \n> Possible issues:\n> \n> * Is the host's internet connection working?\n> * Whonix-Gateway will need a few moments for bootstrapping the Tor network.\n> * Do you live in a censored area?\n> \n> Recommendations:\n> \n> 1.)\n> Try again: dom0 -> Start Menu -> ServiceVM: sys-whonix -> Whonix Check\n> \n> 2.)\n> See More Help button for more help.\n\n----\n\n`More Help`:\n\n> Shut down Whonix and try to get the Tor Browser Bundle from https://www.torproject.org working on your host. If you cannot get the Tor Browser Bundle to work, you will most certainly not get Whonix to work either.\n> \n> The Tor Browser Bundle is great for testing if you live in a censored area. If you need bridges for the Tor Browser Bundle, you will need them for Whonix as well.\n\n----\n\n`Technical details`:\n```\nTor Circuit: established\nBootstrapping 5 % done. Tor reports: NOTICE BOOTSTRAP PROGRESS=100 TAG=done SUMMARY=\"Done\"\n\nYou could try re-running whonixcheck in Terminal:\nwhonixcheck\n\nUse arm, connection page two, to see if Tor is connected:\ndom0 -> Start Menu -> ServiceVM: sys-whonix -> Arm\nor in Terminal: arm\n\nCheck /var/run/tor/log\n```\n\n----\n\nAny opinions? Any other proposals?"},{"author":"joysn1980","date_created":1485573213,"date_modified":1485573213,"content":"The issue here is that - msgdispatcher_dispatch_x is a generic script, which displays the message that comes to it.\nNow, the question is - what is the best way to find out a generic way to split a message into the below three parts\n- Part that comes inside message being displayed\n- Part that comes inside 'Show Details\"\n- Part that comes inside 'More Help'\n\nWhat I did was to modify this script to find a generic way to split the message into such a way that we have two parts -\n1) Part that is displayed by default\n2) Part that is comes with \"Show Details\"\n\nNow, coming to your proposal. Why do you think you should differentiate between \"Details\" and \"more help\". Don't you think there is no line between them? After all\nNow, the question is how do we implement your proposal. I think it is a much larger change.\n1) We need to formalize all message so that we have 3 parts to it.\na) Default Message\nb) Details\nc) More Help\n\nAnd this should be done to all the messages.\nOnce done, we can probably implement that too.\n\nPersonally I feel that there is very hazy line between \"Details\" and \"More Help\". It is not very intuitive to tell what comes under what category. \"Details\" is all about \"More\". My 2 cents.\n\nLet me know what you think about refurbishing all the messages that is being used by \"msgdispatcher_dispatch_x\"?"},{"author":"Patrick","date_created":1485619074,"date_modified":1485619074,"content":">>! In T456#11896, @joysn1980 wrote:\n> The issue here is that - msgdispatcher_dispatch_x is a generic script, which displays the message that comes to it.\n> Now, the question is - what is the best way to find out a generic way to split a message into the below three parts\n> - Part that comes inside message being displayed\n> - Part that comes inside 'Show Details\"\n> - Part that comes inside 'More Help'\n\nThe calling script (such as whonixcheck) would pass that by command line option, such as `--message \"this message\"`, `--details \"these details\"`, `\"--mhelp \"more help\"`. Or if that does not work well, pass it by environment variables.\n\n> Why do you think you should differentiate between \"Details\" and \"more help\".\n\nDetails are more like technical details. Interesting for advanced users, developers and for bug reports.\n\n> Don't you think there is no line between them?\n\nWhile writing these help messages and gathering output for it, it's hard to think about lines between them. So the calling script (such as whonixcheck) would define which part goes where and then pass it to msgdispatcher_dispatch_x.\n\n> Personally I feel that there is very hazy line between \"Details\" and \"More Help\". It is not very intuitive to tell what comes under what category. \"Details\" is all about \"More\". My 2 cents.\n\nYes, sure. Perhaps all error messages and help advice should be in the main popup and only technical details being hidden under the details button."}]},"PHID-TASK-3hplfmcrtpozkcxsmybu":{"id":"455","title":"various issues with Tor Browser documentation chapter Local Connections","status":"resolved","priority":"Normal","author":"Patrick","description":"https://www.whonix.org/wiki/Tor_Browser#Local_Connections\n\n-----\n\n1:\n\n> You [could set to transparent torification](https://www.whonix.org/wiki/Tor_Browser#Remove_Proxy_Settings), but then you would be vulnerable to fingerprinting issues.\n\nWhat is the source of that? I would like to add a footnote.\n\n-----\n\n2:\n\n> the green onion icon in your toolbar -> Preferences... -> Use custom proxy settings -> No Proxies for: AND there enter \"127.0.0.1\". Then, click on \"OK\"\n\nWon't work anymore. Because that menu was removed from Tor Browser.\n\n-----\n\n3:\n\nSplit a) \"best way to use Tor Browser with local connections\" from b) \"fingerprint threat analysis\". Because\n- a) is interesting for users\n- b) for is interesting for design, reasoning, auditors advanced users.\n- a ) can stay where it is.\n- b) can moved down to advanced topics.\n\n-----\n\n4:\n\nIf `1:` is true, then it should also be mentioned at the [Tor_Browser#Remove_Proxy_Settings ](https://www.whonix.org/wiki/Tor_Browser#Remove_Proxy_Settings) instructions.\n\n-----\n\nCould you work on this please, @HulaHoop?","comments":[{"author":"HulaHoop","date_created":1450303460,"date_modified":1450303460,"content":"> You could set to transparent torification, but then you would be vulnerable to fingerprinting issues.\n\nThere is a misunderstanding. I was talking about application of settings in https://www.whonix.org/wiki/Tor_Browser#Local_Connections not transproxying.\n\n\n> Won't work anymore. Because that menu was removed from Tor Browser.\n\nThese settings still exist but the menu names have changed I will update them or replace them with FoxyProxy settings that can mitigate the fingerprinting threat.\n\n\n> Split a) \"best way to use Tor Browser with local connections\" from b) \"fingerprint threat analysis\"...\n\nI don't know what you mean. Please tell me specifics"},{"author":"Patrick","date_created":1450370609,"date_modified":1450370609,"content":"> You could set to transparent torification, but then you would be vulnerable to fingerprinting issues.\n\n>> There is a misunderstanding. I was talking about application of settings in https://www.whonix.org/wiki/Tor_Browser#Local_Connections not transproxying.\n\nWhy was transparent torification added in the first place?\n\nTransparent torification allows local connections?\n\nTransparent torification also sets \"no proxies to 127.0.0.1\"?\n\n> I don't know what you mean. Please tell me specifics\n\npart a)\n\nNote, accessing 127.0.0.1 using Tor Browser is no longer possible due to a change in Tor Browser by The Tor Project. You could set to transparent torification, but then you would be vulnerable to fingerprinting issues. See Tor Browser, Local Connections for more information and a workaround. \n\n...\n\n-----\n\npart b)\n\nThreat Details\n\nAccording to this Firefox ticket, JavaScript can be abused to scan internal networks, fingerprint devices, and make malicious commands to those devices if they have a web interface. \n\n..."},{"author":"HulaHoop","date_created":1450412557,"date_modified":1450412557,"content":"I see the confusion. Fingerprinting would happen because scanning of locally listening programs if the default TBB proxy settings were changed/disabled and it was left to use the Transproxy like any other software. Its not because of the transproxy...\n\nAnyway I will phrase this better."},{"author":"HulaHoop","date_created":1450413806,"date_modified":1450413806,"content":"Done. Please check and close the ticket if you're happy with it."},{"author":"Patrick","date_created":1450415103,"date_modified":1450415103,"content":"`TOR_TRANSPROXY=1 ./start-tor-browser.desktop` results in allowing local connections, therefore to the scanning issue, therefore to the fingerprinting issue?"},{"author":"Patrick","date_created":1450415342,"date_modified":1450415342,"content":"That reference to https://phabricator.whonix.org/T291#5252 is bogus, because https://phabricator.whonix.org/T291#5252 does not mention Tor Browser's `TOR_TRANSPROXY=1` feature. Ideally, we would reference an official confirmation of this issue or alternatively come up with an argument why that is so."},{"author":"HulaHoop","date_created":1450417331,"date_modified":1450417331,"content":">  Tor Browser's TOR_TRANSPROXY=1 feature\n\nI meant to ay that by disabling Tor Browsers Torrified proxy settings you end up being torrfed by the gateway like anything else running on the ws. I am not saying Tor's transproxy is causing the fingerprinting. The sentence was needlessly verbose so I removed it.\n\n"},{"author":"Patrick","date_created":1450440995,"date_modified":1450440995,"content":"This Tor Browser \"transparent proxying\" feature causes lots of confusion. It was a bad decision by TPO to call it \"transparent proxying\". What it actually does, is \"set to no proxy settings\", i.e \"set to system default\". Then Tor Browser works network wise just as a unconfigured Firefox / Iceweasel. If the person using this Tor Browser \"transparent proxying\" feature, happens to not use a gateway with transparent torification features such as Whonix-Gateway, traffic would go through clearnet. If the person using this Tor Browser \"transparent proxying\" feature, happens to use a torifying gateway such as Whonix-Gateway, traffic happens to go through Tor. If the person using this Tor Browser \"transparent proxying\" feature, happens to have a JonDo-Gateway, traffic happens to go through JonDo.\n\nNot to be confused with Tor's setting ` TransPort [address:]port|auto [isolation flags] ` setting. Not to be confused with [TransparentProxy](https://trac.torproject.org/projects/tor/wiki/doc/TransparentProxy), which is different from an [IsolatingProxy](https://trac.torproject.org/projects/tor/wiki/doc/TorifyHOWTO/IsolatingProxy).\n\n> You can disable Tor Browser's proxy settings, but then you would be vulnerable to fingerprinting issues.<ref>https://bugzilla.mozilla.org/show_bug.cgi?id=354493</ref>\n\nHow can the reader understand the causality between \"disable Tor Browser's proxy settings\", or in other words \"no proxy settings\" and \"fingerprinting issues\"?\n\nWould the following...\n\n> You can disable Tor Browser's proxy settings, but then you would be vulnerable to fingerprinting issues.<ref>This is because my removing proxy settings from Tor Browser, also local connections will be allowed. These can be abused for fingerprinting issues as described in https://bugzilla.mozilla.org/show_bug.cgi?id=354493</ref>\n\n...be correct?"},{"author":"HulaHoop","date_created":1450456175,"date_modified":1450456175,"content":"> Would the following be correct?\n\nYes.\n\n> This Tor Browser \"transparent proxying\" feature causes lots of confusion.\n\nTell me about it. I had trouble understanding whats going on at first. Can you add this terminology info under advanced topics on the page?"},{"author":"Patrick","date_created":1450549423,"date_modified":1450549423,"content":"Just now hidden \"You can disable Tor Browser's proxy settings\" in a footnote. It's not all that important. It was the only workaround, before you added this improved workaround.\n\nMade lots of changes. I am happy with the local connections instructions now. As good as we can get them in the absence of the underlying issues of third parties fixing these bugs.\n\nDocumented terminology:\nhttps://www.whonix.org/wiki/Tor_Browser#Tor_Browser_Transparent_Proxying"}]},"PHID-TASK-wcdveu5qwscbz3ilhp6b":{"id":"454","title":"fix broken anon-ws-disable-stackedtor 'sudo service tor status' in Qubes","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1450143868,"date_modified":1450143868,"content":"https://github.com/Whonix/anon-ws-disable-stacked-tor/commit/4616332dbf4f06964449bcb17d305d37c993d638"}]},"PHID-TASK-yle763volb3ancnvvads":{"id":"453","title":"each documentation page requires an image for previews","status":"resolved","priority":"Normal","author":"Patrick","description":"**Purpose**\n\n* for the preview box when posting a Whonix website link to the forums\n* for the preview images when posting a Whonlx website link to social media (mostly facebook)\n\n-----\n\n**Image Sizes**\n\nAs per [ideal-image-sizes-social-media-posts](https://blog.bufferapp.com/ideal-image-sizes-social-media-posts) and recent successful test results.\n\n* The first best image size for now appears to be `470x246`. Example page where this is working good with full size preview: https://www.whonix.org/wiki/Documentation\n* The second best image size for now appears to be `158x158`. Example page where this is working good with half size preview: https://www.whonix.org/wiki/Tor_Controller\n\n-----\n\n**How**\n\nIn the wiki markup, below\n```\n{{Header}}\n```\nWe need something like this:\n```\n{{#seo:\n|description=Using a Tor Controller with Whonix. Arm. Vidalia. Change your Tor circuit. Monitor Tor.\n|og:image=https://www.whonix.org/w/images/5/54/Screenshot_arm_page1_cropped.png\n}}\n```\n\n(The `description` appears as info text in search engine results below the page title. It can be anything and should be an informative summary. - Most pages should already have it.)\n\nLook through existing files:\nhttps://www.whonix.org/wiki/Special:NewFiles\n\nIf we can reuse some, then we don't need new ones.\n\nOr upload new suitable screnshots. Something that works as an illustrative image. Upload it.\n\nGo to the image link. For example https://www.whonix.org/wiki/File:Tux.png. Don't use https://www.whonix.org/wiki/File:Tux.png directly! Won't work. Click on the image until you get a full size one, example: https://www.whonix.org/w/images/a/af/Tux.png.\n\nThe images does not have necessarily to be added to that wiki page. However, when it makes sense, then now is a good time to have at least one [illustrative] image [or sceenshot - if applicable] per documentation wiki page.\n\nFor simple cases of image resizing we can use mediawiki. Go to https://www.whonix.org/wiki/Dev/ImageResize. Add images to that page. Example:\n\n```\n[[File:Virtualbox_logo.png]]\n\n[[File:Virtualbox_logo.png|470px]]\n\n[[File:Virtualbox_logo.png|156px]]\n```\nSave. Mediawiki then will automatically created \"thumbnails\". Right click on the smaller image -> Copy Image Location. Example result: https://www.whonix.org/w/images/thumb/d/d5/Virtualbox_logo.png/156px-Virtualbox_logo.png.","comments":[{"author":"TNTBOMBOM","date_created":1450046319,"date_modified":1450046319,"content":"well u can say i understand the general concept of changing the images sizes.\n\nso u would like to do that for all the current images atm ? or the new uploaded one ? \n\nalso not sure how can confirm that the image going to fit for this size or that size , essential visual result needed to c the effect on facebook or twitter ..etc (preview). or im missing something? "},{"author":"Patrick","date_created":1450047852,"date_modified":1450047852,"content":"TNTBOMBOM (TNT BOM BOM):\n>   so u would like to do that for all the current images atm ? or the new uploaded one ?\n\nJust for the images we will use as og:image.\n\n>   also not sure how can confirm that the image going to fit for this size or that size , essential visual result needed to c the effect on facebook or twitter ..etc (preview). or im missing something?\n\nGimp can show image sizes. And also resize.\n\nYou can check it by trying it out. But it would require being logged\ninto facebook. Post the link on your wall. (Perhaps with setting to just\nshow me to prevent spamming your wall.) See how it looks. Normally, you\ndon't even have to post it - because the preview will already show how\nthey would render the image.\n\nThere is also the facebook debugger.\n\nhttps://developers.facebook.com/tools/debug/\n\n- Perhaps that thing has some bugs itself also. Sometimes you need to\npress the \"go\" button (the debug button) (or the fetch new scrap\ninformation button) multiple times. On the first run it shows a false\npositive error.\n\n- The big preview on the facebook debugger may look messed up. (Image\nout of visible area a bit.) But once you click \"See this in the share\ndialog.\", it should look normal.\n\n- not sure that debugger will work for your (related to who the facebook\n\"app\" created)\n\nYou can also test the image preview by pasting a link to a Whonix forum\npost. (Create a test thread.)\n\nFor twitter, not sure that's worth it at this time. We would need\nthis... Example:\n\n|twitter:image:src=https://www.whonix.org/w/images/c/c9/Whonix_logo600x321.png\n\nThere is a twitter card preview tester here:\n\nhttps://cards-dev.twitter.com/validator\n\nBut since twitter cards are not expanded by default in most cases - I am\nnot sure it's worth the work involved. The card only auto expands for\nsuper popular tweets or if we bought twitter advertisements. (Not sure\nthat's worth any money.)\n\nFrom\nhttps://twittercommunity.com/t/what-is-the-optimum-size-for-the-image-on-a-summary-card-with-large-image/22251/4\nI learned, that 600 x 321\n(1.867:1 ratio)\nis the optimal image size.\n\nTry first how it looks with the two example wiki links that are already\nworking with preview images."},{"author":"TNTBOMBOM","date_created":1450210703,"date_modified":1450210703,"content":"> Gimp can show image sizes. And also resize.\n> \n> You can check it by trying it out. But it would require being logged\n> into facebook. Post the link on your wall. (Perhaps with setting to just\n> show me to prevent spamming your wall.) See how it looks. Normally, you\n> don't even have to post it - because the preview will already show how\n> they would render the image.\n\nhmm that requires two things i dont have:- \n\nGimp knowledge & Facebook account\n\nGimp way too complex than shutter or paint, need month or more to know the essential right basics of it. this is not the big issue for me.\n\nbut Facebook account , thats really an issue, as u know  now facebook requires a real mobile number in order to have an account. spent lot of time trying to register and skipping the mobile number but it seems no hope after all...\n\nif u know any good skipping method or having an account then its good to have it.\n"},{"author":"Patrick","date_created":1450211053,"date_modified":1450211053,"content":"Resizing images with gimp is simple. Does not require a month to learn.\n\nBut if you know other tools than can do resizing, that is fine also.\n\nI don't think there are facebook account skipping possibilities. But the\ntesting is not super important. Once you have one or two images done, I\ncan test them. No need to test all of them. Once the image size is\nsorted out, it will work."},{"author":"TNTBOMBOM","date_created":1450309573,"date_modified":1450309573,"content":"good then , so just to get everything right:- \n\nnow i go to the documentation  link:- https://www.whonix.org/wiki/Documentation\n\nand each topic which is contain photos inside it , i will choose the best one (if there is more than one) inside the topic and  resize the image to 158x158 and add it in the top of the page with this command:- \n\n{{#seo:\n|description= xxxxxx (describing the topic content) \n|og:image=https://www.whonix.org/w/images\nXXXXX (name the image).png\n}}\n\n\nright ? if im missing something pls add/correct.\n\n"},{"author":"Patrick","date_created":1450376699,"date_modified":1450376699,"content":"Do not add the name of the image to description=. If description= exists\nand looks good, no need to modify.\n\nTry to resize to 470xsomething first.\n\nPlease do it for one page first. Then we'll see."},{"author":"TNTBOMBOM","date_created":1451046554,"date_modified":1451046554,"content":"check:- https://www.whonix.org/wiki/The_World_Wide_Web_And_Your_Privacy\n\nhmm i dunno if it worked or not but just check on it."},{"author":"Patrick","date_created":1451046896,"date_modified":1451046896,"content":"Need '='. Not ':'. Please use copy and paste.\n\nExample:\n\n|og:image=https://www.whonix.org/w/images/5/54/Screenshot_arm_page1_cropped.png\n\nWon't work with files on your local disk such as:\n\n/home/user/.tb/tor-browser/Browser/Downloads/rsz_google-chart.png\n\nNeeds to be links linking to whonix.org. Example:\n\nhttps://www.whonix.org/w/images/5/54/Screenshot_arm_page1_cropped.png"},{"author":"TNTBOMBOM","date_created":1451101190,"date_modified":1451101242,"content":"aha ok , but it seems that u cant upload photo from qubes-whonix to the wiki ? i have tried many ways it either stuck on the upload (always whatever i do) or doesnt upload the photo at all. i should try then from debian environment.  \n\ntrying to upload the image here:- \n\nhttps://www.whonix.org/wiki/Dev/ImageResize"},{"author":"Patrick","date_created":1451137953,"date_modified":1451137953,"content":"Error on whonix.org server. Now fixed. Image upload should work now as\nbefore. \"Drop files here\" exists again.\n\nBtw I don't think you can do it all in one step. You first need to \"Drop\nfiles here\", then find the direct link to the image, then edit the wiki."},{"author":"TNTBOMBOM","date_created":1451141730,"date_modified":1451141778,"content":"yeah i know , its a little time consuming but ok np with that.\n\ncheck now:-\n\n\n```\n{{Header}}\n{{#seo:\n|description=Anonymity Online. Privacy Online.\n|og:image=https://www.whonix.org/w/images/3/35/Rsz_google-chart.png\n}}\n```\n\nhttps://www.whonix.org/wiki/The_World_Wide_Web_And_Your_Privacy\n\n\n"},{"author":"Patrick","date_created":1451160464,"date_modified":1451160464,"content":"TNTBOMBOM (TNT BOM BOM):\n>   https://www.whonix.org/wiki/The_World_Wide_Web_And_Your_Privacy\n\nLooks very good! Even got the big preview!\n\nPlease change a few more sites, and I'll check them. Then we see if this\nhas become a flawless process."},{"author":"TNTBOMBOM","date_created":1451213063,"date_modified":1451213063,"content":"great then , i will change 5 to 10 sites tonight and i will put the links here and then check. "},{"author":"TNTBOMBOM","date_created":1451367202,"date_modified":1451375232,"content":"~~can u check if u can have the place where can u upload the photo:- \nhttps://www.whonix.org/wiki/Dev/ImageResize\nthe place where i can upload my photo doesnt show up , i have turned off noscript but it seems the page still acting as if i turning on the noscript. happening with u ? ~~\n\nworked now , i dunno but Tor browser acting strangely today \n\nalso what is this link about ? can we use it for the same purpose ?\n\nhttps://www.whonix.org/wiki/Special:Upload "},{"author":"TNTBOMBOM","date_created":1451374988,"date_modified":1451374998,"content":""},{"author":"TNTBOMBOM","date_created":1451376699,"date_modified":1451376699,"content":"check those:- \n\n1- https://www.whonix.org/wiki/Data_Collection_Techniques\n\n2- https://www.whonix.org/wiki/Warning\n\nactually the problem that i have mentioned about disappearing of the upload field even if u turn off the noscript is still happening. and i dunno is it something from TBB or mediawiki or ..etc. \n\nso i couldnt upload more than these photos nor i do know what is the problem or how to solve it."},{"author":"Patrick","date_created":1451390603,"date_modified":1451390603,"content":"> also what is this link about ? can we use it for the same purpose ?\n> \n> https://www.whonix.org/wiki/Special:Upload \n\nYes.\n\nThat interfaces with the same internal mediawiki functions. Just it's a different interface. Using that or the drop image area has the same effect.\n\n> actually the problem that i have mentioned about disappearing of the upload field even if u turn off the noscript is still happening. and i dunno is it something from TBB or mediawiki or ..etc.\n\nDoes it with with non-TBB? With Firefox? If yes, then it must be a TBB issue.\n\n> check those:-\n\n> 1- https://www.whonix.org/wiki/Data_Collection_Techniques\n\n> 2- https://www.whonix.org/wiki/Warning\n\nLooks good with small preview."},{"author":"TNTBOMBOM","date_created":1451663512,"date_modified":1451663512,"content":"it seems that the issue from TBB , see here:- \n\n{F2762}\n\nso i will make the rest from firefox only , also i knew now how to move screenshots from dom0 to whonix ( it is hard one  but at least i knew how until qubes provide the good way of transferring things)."},{"author":"Patrick","date_created":1451677173,"date_modified":1451677173,"content":"Yes, the files drop in mediawiki does not work in TBB 5.5 anymore for\nsome reason."},{"author":"TNTBOMBOM","date_created":1451831170,"date_modified":1451831170,"content":"i think it is not just TBB , but also \"noscript\". try to disable it and see.\n\nim using firefox , and i had the same issue now. "},{"author":"TNTBOMBOM","date_created":1451836737,"date_modified":1451836737,"content":"i think i have finished all the documentation links. \n\ncheck them , and tell me if u want to change something and/or i have forgot any link.\n\n"},{"author":"Patrick","date_created":1451840822,"date_modified":1451840822,"content":"Thanks a lot! Quite a lot work has been done already.\n\nThere are still a lot pages missing. If you go to https://www.whonix.org/wiki/Documentation ...\n\n* Why do you need anonymity? - https://www.whonix.org/wiki/Anonymity\n* Surveillance Capabilities - https://www.whonix.org/wiki/Surveillance_Capabilities\n* etc.\n\nIf you want to work on this some more, please go through these links one by one."},{"author":"TNTBOMBOM","date_created":1451927660,"date_modified":1451927660,"content":"uw :) \n\nyeah why not , but these links dont have photos inside so how im going to add photos? or u mean i choose random photo fitting the subject and try to put it inside them ? like what we did witha logos? \n\nshow me the way and im on for it"},{"author":"Patrick","date_created":1451929525,"date_modified":1451929525,"content":"Yes, coming up with some illustrative image that fits the subject.\n\nThat image does not need to be on that page, but if it's useful to add\nit there, please do so."},{"author":"TNTBOMBOM","date_created":1452013159,"date_modified":1452013159,"content":"aha ok perfect , should i care about is this image with X license or Z license (like with logos)? or with images im free to use anyone i see it good to fit the subject ? \n\nand r we going to open a subject for it inside the forum ? "},{"author":"Patrick","date_created":1452018679,"date_modified":1452018679,"content":"TNTBOMBOM (TNT BOM BOM):\n>   aha ok perfect , should i care about is this image with X license or Z license (like with logos)? or with images im free to use anyone i see it good to fit the subject ?\n\nLicensing always matters unfortunately.\n\n>   and r we going to open a subject for it inside the forum ?\n\nPlease do."},{"author":"Patrick","date_created":1452529984,"date_modified":1452529984,"content":"There is a problem. File names that contain \"spaces\" are not allowed. `_` is considered a space.\n\nFor example https://www.whonix.org/wiki/File:Invisible-13955_640.jpg is broken.\n\nHow to fix:\n\nGo to https://www.whonix.org/wiki/File:Invisible-13955_640.jpg\n\nPress action -> move\n\nReplace the space ` ` with let's say a dash `-`.\n\nKeep `Leave a redirect behind` enabled.\n\nGet the new direct link. Update `og:image` with the new direct link."},{"author":"TNTBOMBOM","date_created":1452717634,"date_modified":1452717729,"content":"`Press action -> move`\n\ndidnt really got what do u mean by it ?\n\nim going to upload more photos to the documentation and without spaces `_` for the rest of the topics if i can."},{"author":"Patrick","date_created":1452717972,"date_modified":1452717972,"content":"On that wiki page... On the top... Pres...\naction\nthen press\nmove"},{"author":"TNTBOMBOM","date_created":1452736322,"date_modified":1452736322,"content":"finished , check out. "},{"author":"Patrick","date_created":1452739325,"date_modified":1452739325,"content":"Good work!"},{"author":"Patrick","date_created":1454529238,"date_modified":1455133543,"content":"We need some more preview images. Could you add them please? @TNTBOMBOM \n\n- https://www.whonix.org/wiki/PQCrypto\n\n- https://www.whonix.org/wiki/Tunnels/Connecting_to_a_VPN_before_Tor\n- https://www.whonix.org/wiki/Tunnels/Connecting_to_a_proxy_before_Tor\n- https://www.whonix.org/wiki/Tunnels/Connecting_to_SSH_before_Tor\n- https://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_a_VPN\n- https://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_a_proxy\n- https://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_SSH\n- https://www.whonix.org/wiki/Tunnels/Examples\n\n- https://www.whonix.org/wiki/Comparison_of_different_Whonix_variants\n- https://www.whonix.org/wiki/Dev/Build_Anonymity\n- https://www.whonix.org/wiki/Verifiable_Builds\n- https://www.whonix.org/wiki/Dev/Source_Code_Intro\n- https://www.whonix.org/wiki/Forcing_.onion_on_Whonix.org"},{"author":"TNTBOMBOM","date_created":1455506665,"date_modified":1455506783,"content":"done, check it out babe ;)\n\nalso fix ur first comment here:- \n\n\n\n> We need something like this:\n\n\n```\n{{#seo:\n|description=Using a Tor Controller with Whonix. Arm. Vidalia. Change your Tor circuit. Monitor Tor.\n|og:image=https://www.whonix.org/w/images/5/54/Screenshot_arm_page1_cropped.png\n}}\n```\n\nthe last line should be:- \n\n```\n\n|og:image=https://www.whonix.org/w/images/5/54/Screenshot-arm-page1-cropped.png\n\n```\n"},{"author":"Patrick","date_created":1455601718,"date_modified":1455601718,"content":"The removal of `_` is fortunately no longer required. Just now tested. Works as is."},{"author":"Patrick","date_created":1455601948,"date_modified":1455601948,"content":"Looks good! Thanks!"},{"author":"Patrick","date_created":1455654892,"date_modified":1482630144,"content":"TODO:\n\n* https://www.whonix.org/wiki/Hidden_Services\n* https://www.whonix.org/wiki/VPN-Firewall\n* https://www.whonix.org/wiki/Surfing_Posting_Blogging\n* https://www.whonix.org/wiki/Censorship_Circumvention_Tools\n* https://www.whonix.org/wiki/Stay_Tuned\n* https://www.whonix.org/wiki/Whonix-Gateway_System_DNS\n* https://www.whonix.org/wiki/Whonix-Gateways_Own_Traffic_Transparent_Proxy\n* https://www.whonix.org/wiki/Nymservers\n* https://www.whonix.org/wiki/Whonix_Packages_for_Debian_Hosts\n* https://www.whonix.org/wiki/What_we_do\n* https://www.whonix.org/wiki/Keyboard_Layout\n* https://www.whonix.org/wiki/VirtualBox/Other_Versions\n* https://www.whonix.org/wiki/VirtualBox/Known_Issues\n* https://www.whonix.org/wiki/VirtualBox/Troubleshooting\n* https://www.whonix.org/wiki/VirtualBox/Security_and_Support_Status\n* https://www.whonix.org/wiki/Upgrading_Whonix_12_to_Whonix_13\n* https://www.whonix.org/wiki/Protocol-Leak-Protection_and_Fingerprinting-Protection\n* https://www.whonix.org/wiki/HexChat (needs updated preview image and screenshots)\n* https://www.whonix.org/wiki/Qubes/Uninstall\n* https://www.whonix.org/wiki/Qubes/Update\n* https://www.whonix.org/wiki/Qubes/Install\n* https://www.whonix.org/wiki/Qubes/Disposable_VM\n* https://www.whonix.org/wiki/Stay_Tuned\n* https://www.whonix.org/wiki/Non-Qubes-Whonix_Known_bugs\n* https://www.whonix.org/wiki/JonDonym\n* https://www.whonix.org/wiki/I2P\n* https://www.whonix.org/wiki/Freenet\n* https://www.whonix.org/wiki/Ubuntu\n* https://www.whonix.org/wiki/Deprecated\n* https://www.whonix.org/wiki/Next\n* https://www.whonix.org/wiki/Avoid_nonfree_software\n* https://www.whonix.org/wiki/Censorship_Circumvention_Tools\n* https://www.whonix.org/wiki/ZeroNet\n* https://www.whonix.org/wiki/Lantern\n* https://www.whonix.org/wiki/Verify_the_virtual_machine_images_using_Windows\n* https://www.whonix.org/wiki/Verify_the_virtual_machine_images_using_Mac\n* https://www.whonix.org/wiki/Verify_the_virtual_machine_images_using_the_command_line\n* https://www.whonix.org/wiki/Verify_the_virtual_machine_images_using_Linux\n* https://www.whonix.org/wiki/QEMU\n* https://www.whonix.org/wiki/ZeroNet\n* https://www.whonix.org/wiki/Support\n* https://www.whonix.org/wiki/Forum_Best_Practices\n* https://www.whonix.org/wiki/Hidden_Services\n* https://www.whonix.org/wiki/Microphone\n* https://www.whonix.org/wiki/Sdwdate\n* https://www.whonix.org/wiki/CVE-2016-1252\n* https://www.whonix.org/wiki/Dev/project-news\n* https://www.whonix.org/wiki/Dev/apt-revoker\n* https://www.whonix.org/wiki/Dev/Permanent_Takedown_Attack_Defender\n* https://www.whonix.org/wiki/Ports\n* https://www.whonix.org/wiki/Malware"}]},"PHID-TASK-7s7mwg6esxvt6wzzwi35":{"id":"452","title":"open links from Qubes-Whonix-Gateway inside a Qubes-Whonix-Workstation","status":"resolved","priority":"Normal","author":"Patrick","description":"Links clicked by the user on the gateway currently show an error popup. (Such links could be seen in whonixcheck, logs, help files, etc.)\n\n```\nLink Confirm Open does not support opening links on Gateway for security reasons.\n\nPlease copy the link to the Workstation and open it there.\n\nUse Tor Browser under Workstation to browse the internet.\n```\n\nIn #Qubes, we might be able to do better than that.\n\nWhen #open-link-confirmation detects being run inside #Qubes, it could instead run the following command.\n\n```\nqvm-open-in-vm anon-whonix https://www.whonix.org\n```\n\nFirst, dom0 would show a confirmation popup.\n\nSecond, `anon-whonix`'s #open-link-confirmation would  show a confirmation popup.\n\n```\nThe following link will be opened in Tor Browser.\n\nBe careful if Tor Browser is already running as your activities might get linked.\n\nfile:///tmp/sys-whonix/tmp.yoMl6S7xV0\n\nContinue?\n```\n\nIt is showing `file:///tmp/sys-whonix/tmp.yoMl6S7xV0` rather than the link, because of #Qubes upstream issue '[there is no qubes.OpenURL](https://github.com/QubesOS/qubes-issues/issues/1487#issuecomment-163980385)  yet'.\n\nIt also seems a bit weird to default to opening inside `anon-whonix`. (I can easily make that configurable through [/etc/open_link_confirm.d](https://github.com/Whonix/open-link-confirmation/tree/master/etc/open_link_confirm.d).) But I don't know how the gateway could figure out any reasonable, or running, or anon-link, or existing whonix-gw based AppVMs. However, it should be good enough, because many users will have `anon-whonix` thanks to Qubes management stack.","comments":[{"author":"Patrick","date_created":1449881178,"date_modified":1449881178,"content":"https://github.com/Whonix/open-link-confirmation/commit/7dc3af9002b1b6ccbb54b837b6901f5d14d0a28c"},{"author":"marmarek","date_created":1449946097,"date_modified":1449946097,"content":">   It also seems a bit weird to default to opening inside `anon-whonix`. (I can easily make that configurable through [/etc/open_link_confirm.d](https://github.com/Whonix/open-link-confirmation/tree/master/etc/open_link_confirm.d).) But I don't know how the gateway could figure out any reasonable, or running, or anon-link, or existing whonix-gw based AppVMs. However, it should be good enough, because many users will have `anon-whonix` thanks to Qubes management stack.\n\nThis can be also done in dom0 qrexec policy (for example by management \nstack, or user creating dedicated \"link Whonix-Workstation\") \nExample (/etc/qubes-rpc/policy/qubes.OpenInVM or qubes.OpenURL in the \nfuture): \nsys-whonix $anyvm ask,target=anon-whonix \n \nDocumentation: \nhttps://www.qubes-os.org/doc/qrexec3/#tocAnchor-1-1-3"},{"author":"Patrick","date_created":1449946556,"date_modified":1449946556,"content":"Sounds good. Perhaps we want even two services, i.e. qubes.WhonixOpenURL\nvs qubes.OpenURL."},{"author":"marmarek","date_created":1449946727,"date_modified":1449946727,"content":">   Sounds good. Perhaps we want even two services, i.e. qubes.WhonixOpenURL\n>   vs qubes.OpenURL.\n\nWhat would be the difference?"},{"author":"Patrick","date_created":1449947353,"date_modified":1449947353,"content":"qubes.WhonixOpenURL by default setting opens in anon-whonix.\nqubes.WhonixOpenURL would be used by Whonix[-gw] by default.\n\nqubes.OpenURL by default settings opens in a non-anonymous DispVM.\nqubes.OpenURL would be used by other templates by default.\n\nTwo services, to give the user the option to use qubes.OpenURL for their\n'mail-work' VM as opposed to be using qubes.WhonixOpenURL for their\n'mail-anon' VM."},{"author":"marmarek","date_created":1449947826,"date_modified":1449947826,"content":"You can set that in qrexec policy:\n```\nmail-anon $anyvm ask,target=anon-whonix\nmail-work $anyvm ask,target=$dispvm\n```\nand so on."},{"author":"Patrick","date_created":1461689424,"date_modified":1461689424,"content":"`allow sys-whonix, whonix-gw and whonix-ws by default to open links in anon-whonix`:\nhttps://github.com/marmarek/qubes-core-agent-linux/pull/68"},{"author":"Patrick","date_created":1461690047,"date_modified":1461690047,"content":"Do you think the `/etc/open_link_confirm.d/31_default.conf` settings\n\n```\nlink_confirmation_target_vm=\"anon-whonix\"\nlink_confirmation_vm_open_tool=\"qvm-open-in-vm\"\n```\n\n( https://github.com/Whonix/open-link-confirmation/blob/7dc3af9002b1b6ccbb54b837b6901f5d14d0a28c/etc/open_link_confirm.d/31_default.conf#L20-L37 )\n\nare okay as is or should be somehow configured by dom0 qubes-rpc policy?\n\n`/usr/bin/qvm-open-in-vm` currently requires the `vmname` argument. It does not have an autodetection / fallback. So to have dom0 qubes-rpc policy set target to `anon-whonix` I would have to emulate `/usr/bin/qvm-open-in-vm`. Perhaps [`qubes.OpenURL`](https://github.com/QubesOS/qubes-issues/issues/1487) will have an vmname autodetection / fallback mechanism?"},{"author":"Patrick","date_created":1461690124,"date_modified":1461690124,"content":"`open links from Qubes-Whonix-Gateway inside a Qubes-Whonix-Workstation` works. Once [allow sys-whonix, whonix-gw and whonix-ws by default to open links in anon-whonix](https://github.com/marmarek/qubes-core-agent-linux/pull/68) lands, it will just be one confirmation question (by open-link-confirmation) rather than an extra one (dom0 qubes-rpc policy)."},{"author":"Patrick","date_created":1461779179,"date_modified":1461779179,"content":"https://github.com/marmarek/qubes-core-admin/pull/13"}]},"PHID-TASK-smihvy4zx25yt43skfl3":{"id":"451","title":"xdg desktop starters that start stuff in terminal windows such as tor-arm, restart Tor etc. should start maximized by default","status":"resolved","priority":"Normal","author":"Patrick","description":"Recently a user was confused by missing output by tor-arm, because the window was not maximized by default. (The connection the user was looking for needed to be scrolled down.)\n\nI think xdg desktop starters that start stuff in terminal windows such as tor-arm, restart Tor, restart firewall, and so forth, should start maximized by default.\n\n (As stopgap until T441 is implemented.)","comments":[{"author":"Patrick","date_created":1449686263,"date_modified":1449686263,"content":"xdg desktop specification feature request:\n`desktop entry to maximize terminal TerminalMaximized=true`\nhttps://bugs.freedesktop.org/show_bug.cgi?id=93306\n"},{"author":"Patrick","date_created":1449688054,"date_modified":1449688054,"content":"https://github.com/Whonix/whonix-gw-firewall/commit/475ff8ae4e2c208146ff10b9de0ff954406bcac7\n"},{"author":"Patrick","date_created":1449688803,"date_modified":1449688803,"content":"https://github.com/Whonix/anon-gw-anonymizer-config/commit/c02c2f8ceedcf6a05073849e253b9ddf80caaf34"}]},"PHID-TASK-zoq4vzmisw3ibwraywrg":{"id":"450","title":"document (individual) watermarking and eventual counter measures","status":"resolved","priority":"Normal","author":"Patrick","description":"Document (individual) watermarking and eventual counter measures.\n\nAdd to:\n\n* https://www.whonix.org/wiki/Surfing_Posting_Blogging\n* or https://www.whonix.org/wiki/Metadata\n","comments":[{"author":"HulaHoop","date_created":1449535710,"date_modified":1449535710,"content":"Here is the watermarking section. Where should I add it?\n\n***\n\nWatermarking is a subset of the science of stenagoraphy. It can apply to any type of digital media. Goals of watermarking are to trace back information leaks to a source. This is done by embedding covert data into the \"noise\" of data imperceptible to humans. A digital watermark is said to be  robust if it remains intact even if modifications are made to the files.<ref>https://en.wikipedia.org/wiki/Digital_watermarking</ref>\n\nA good countermeasure is to run documents through an OCR and share the output instead.\n\nAccording to a talk by Sarah Harrison from WikiLeaks, source tracing can happen through much simpler techniques such as looking at access lists for the materials. For example if only three people have access to a set of documents then the hunt is narrowed down considerably.\n"},{"author":"Patrick","date_created":1449599205,"date_modified":1449599205,"content":"Similar to, but not the definition of metadata probably does not apply.\n\nSo please add it here:\nhttps://www.whonix.org/wiki/Surfing_Posting_Blogging\n"},{"author":"HulaHoop","date_created":1449603056,"date_modified":1449603056,"content":"Done."}]},"PHID-TASK-4ihcgqr5ulhwv32v263n":{"id":"449","title":"mask more /proc/cpuinfo output in KVM","status":"resolved","priority":"Normal","author":"Patrick","description":"Currently lots of information from inside a compromised workstation (or fancy application reading and reporting it somewhere for whatever statistic purpose) can be read:\nhttps://www.whonix.org/wiki/Protocol-Leak-Protection_and_Fingerprinting-Protection#this_is_from_KVM_.2B_whonix_12_.28cat_.2Fproc.2Fcpuinfo_inside_WS.29\n\nSeems like CPU features can be reduced:\nhttps://www.berrange.com/posts/2010/02/15/guest-cpu-model-configuration-in-libvirt-with-qemukvm/\n\nAdd new 'kvm' domain feature and ability to hide KVM signature:\nhttps://www.redhat.com/archives/libvir-list/2014-August/msg00744.html\n\nMaybe more can be masked such as model and clock frequency.\n\nAs I understand, these features have been added to ease CPU migration in heterogeneous CPU environments. We can reuse these features to hide more hardware identifiers.\n\nNeeds research if there would be a performance penalty or something else would speak against this.","comments":[{"author":"Patrick","date_created":1449509246,"date_modified":1449509246,"content":"Some features exposed may even pose security issues. Whonix KVM's `cat /proc/cpuinfo`, `flags` includes `tsc`, which might allow the VM to access the host CPU's Time Stamp Counter (tsc). (Matters because of [Clock Correlation Attacks](https://www.whonix.org/wiki/Dev/TimeSync#Clock_Correlation_Attack).)\n\nAfter reading https://libvirt.org/formatdomain.html#elementsCPU I suggest to start experimenting with something like the following (untested):\n\n```\n  <cpu>\n  <cpu match='minimum'>\n  <model>486</model>\n  </cpu>\n```\n\nFor CPU models, see also:\n`/usr/share/libvirt/cpu_map.xml`\n\nIf we can afford it performance wise [and otherwise, depends for what it might break] we should only whitelist / allow required, \"secure\" CPU features, that we understand at least on their very superficial level."},{"author":"HulaHoop","date_created":1449528612,"date_modified":1449528612,"content":"I experimented with the cpu masking of individual features on different machines to test portability and reached the conclusion that it will cause a support nightmare.\n\nBlocking some features like tsc_deadline_timer and constant_tsc will cause the vm to fail on other hardware that doesn't have it.\n\nForcing a specific cpu model will cause the vm to fail on hardware made by another vendor. Using a virtual cpu to solve this like kvm64 masks a couple of features more in total than what is accessible to the guest now including critical ones like hardware-virtualization which kills nested virtualization. \n\nEven if all this was to work, an attacker in the VM can have a pretty good idea what cpu they are sitting on if they carry out some benchmarks."},{"author":"HulaHoop","date_created":1449529789,"date_modified":1449529789,"content":"What threat model are we considering for hiding the KVM signature? I am not opposed to it but I don't want security theater.\n\nResearch has shown it impossible to hide the fact that code is running in a virtual environment. Its described as useful for a debugging feature.\n\nhttps://archive.is/J2pbv"},{"author":"HulaHoop","date_created":1449530516,"date_modified":1449530516,"content":"tsc gives the rate of tick of the cpu which is what a pc calibrates its timers to when trying to keep a clock accurate set by the system. Nothing about the an actual reading of the time is leaked. \n\nhttps://lwn.net/Articles/209101/\nhttps://en.wikipedia.org/wiki/Time_Stamp_Counter"},{"author":"Patrick","date_created":1449531090,"date_modified":1449531090,"content":">>! In T449#7518, @HulaHoop wrote:\n> I experimented with the cpu masking of individual features on different machines to test portability and reached the conclusion that it will cause a support nightmare.\n> \n> Blocking some features like tsc_deadline_timer and constant_tsc will cause the vm to fail on other hardware that doesn't have it.\n\nAren't there settings to make this lenient? libvirt documentation implies there are.\n\n* `feature` `require` is obviously bad.\n* But why should `feature` `disable` \"`The feature will not be supported by virtual CPU.`\" be bad? (As long as the VM operating system starts and runs fine.)\n\nAlso `cpu` `match`,\n* `exact` and `strict` sounds bad. \n* But `cpu` `match` `minimum` seems lenient. (Make little to no cpu flags a requirement.)\n\nAlso `model` `fallback` `allow` seems lenient.\n\n> Blocking some features like tsc_deadline_timer and constant_tsc will cause the vm to fail on other hardware that doesn't have it.\n\nIsn't this a contradiction? How can you block something that does not exist? If the cpu feature is unwanted in the VM, then the hypervisor should be fine with the cpu feature not existing on the host, right?\n\n> Even if all this was to work, an attacker in the VM can have a pretty good idea what cpu they are sitting on if they carry out some benchmarks.\n\nI also worry about [future] applications, not compromised ones, leaking CPU info, that are as fancy as webrtc (which leaks local IP addresses).\n\n>>! In T449#7519, @HulaHoop wrote:\n> What threat model are we considering for hiding the KVM signature?\n\nI found that link only worth further research, because it discussed disabling cpu features."},{"author":"Patrick","date_created":1449532019,"date_modified":1449532019,"content":">>! In T449#7520, @HulaHoop wrote:\n> tsc gives the rate of tick of the cpu which is what a pc calibrates its timers to when trying to keep a clock accurate set by the system. Nothing about the an actual reading of the time is leaked. \n> \n> https://lwn.net/Articles/209101/\n> https://en.wikipedia.org/wiki/Time_Stamp_Counter\n\nI think leaking anything related to time from the host into the VM [or from VM to VM] risks cryptographic side channel attacks and should therefore be avoided.\n\nSearch term:\ntime stamp counter tsc side channel\n\nLeads to:\nhttp://blog.cr0.org/2009/05/time-stamp-counter-disabling-oddities.html\n"},{"author":"Patrick","date_created":1449532539,"date_modified":1449532539,"content":"TSC leaks may be similar to to TCP sequence numbers. (https://trac.torproject.org/projects/tor/ticket/16659#comment:10)\n\nTCP sequence numbers also do not directly leak time stamps.\n\n(Will add notes here: https://www.whonix.org/wiki/Dev/TimeSync#TSC)"},{"author":"HulaHoop","date_created":1449536729,"date_modified":1449536729,"content":"Yes all my tests were done with \"feature disable\". \n\n> If the cpu feature is unwanted in the VM, then the hypervisor should be fine with the cpu feature not existing on the host, right?\n\nThats what I thought too except it looks like the feature has to exist on the host for the mask to be applied or else it fails hard.\n\n> I also worry about [future] applications, not compromised ones, leaking CPU info, that are as fancy as webrtc (which leaks local IP addresses).\n\nCan you give examples? At the moment all sensitive data like model name and microcode version is masked by default.\n\n> http://blog.cr0.org/2009/05/time-stamp-counter-disabling-oddities.html\n\nSide channel attacks are a whole field that cryptographers have to deal with when designing and applying cryptography in the real world. They have to account for the fact that hardware is imperfect and can leak information about the key to attackers, Its not something we can solve here at such a simple level but something cryptographers account for when hacking on OpenSSL.\n\n> TSC leaks may be similar to to TCP sequence numbers. \n\nNothing is leaked to the network by TSC. Its also heavily affected by system load which caused the instruction to miss ticks so hardware manufacturers implemented constant_tsc to keep timers from skewing."},{"author":"HulaHoop","date_created":1449538297,"date_modified":1449539328,"content":"I'll read more about cpu minimum and report.\n\nEDIT:\n\nNo go."},{"author":"Patrick","date_created":1449610429,"date_modified":1449610429,"content":">>! In T449#7525, @HulaHoop wrote:\n>> I also worry about [future] applications, not compromised ones, leaking CPU info, that are as fancy as webrtc (which leaks local IP addresses).\n> \n> Can you give examples? At the moment all sensitive data like model name and microcode version is masked by default.\n\nThere are no examples as of now, but I would not be surprised after webrtc leaking local client IP.\n\n>> http://blog.cr0.org/2009/05/time-stamp-counter-disabling-oddities.html\n> \n> Side channel attacks are a whole field that cryptographers have to deal with when designing and applying cryptography in the real world. They have to account for the fact that hardware is imperfect and can leak information about the key to attackers, Its not something we can solve here at such a simple level but something cryptographers account for when hacking on OpenSSL.\n\nThe goal should be to make the VM as autonomous and isolated as possible. A compromised browser VM should not be able to interfere with any other cryptographic operations on the host or in other VMs. If we can get rid of TSC before cryptographers come up with clever defenses, and before new clever attacks to these clever defenses have been published, that would be awesome.\n\n>> TSC leaks may be similar to to TCP sequence numbers. \n> \n> Nothing is leaked to the network by TSC.\n\nRight. Normally not. Local compromise was assumed. Then the TSC could be analyzed by malware and/or send over the network. I see I am generating confusion by switching threat models."},{"author":"HulaHoop","date_created":1449717670,"date_modified":1449717670,"content":"I tested with both cpu minimum and feature disable but the settings cause the VM to never boot for the same reason.\n\nIf the hardware doesn't support it I can't mask it out."},{"author":"HulaHoop","date_created":1449891081,"date_modified":1449891081,"content":"I did some more research and there is good news to follow."},{"author":"HulaHoop","date_created":1449891140,"date_modified":1449891513,"content":"KVM cpus support a baseline of features by default. You can mask out the problematic ones and don't have to worry about the extra ones it doesn't support because it will be masked out anyhow (because it was never supported in the first place).\n\nThe only bad instructions we should filter out are a subset of whatever instructions are listed under the virtual cpu from the output of the cpu_map.xml list\n\ncat /usr/share/libvirt/cpu_map.xml\n\nI figured out safe defaults and will do a pull request. NB clflush was abused to carry out the rowhammer attack so its blacklisted. aes will be passed through for crypto performance - it doesn't mess with random number generation.\n\n\n\n```\n  <cpu mode='custom' match='exact'>\n    <model fallback='forbid'>qemu64</model>\n    <topology sockets='1' cores='2' threads='1'/>\n    <feature policy='disable' name='tsc'/>\n    <feature policy='disable' name='clflush'/>\n    <feature policy='optional' name='aes'/>\n  </cpu>\n```\n\n\n***\n\nhttps://libvirt.org/formatdomain.html#elementsCPU\n\nInformative link about cpu flag functionality: \nhttps://unix.stackexchange.com/questions/43539/what-do-the-flags-in-proc-cpuinfo-mean\n\nhttps://www.berrange.com/posts/2010/02/15/guest-cpu-model-configuration-in-libvirt-with-qemukvm/\n\n \"Every hypervisor has its own policies for what a guest will see for its CPUs by default, Xen just passes through the host CPU, with QEMU/KVM the guest sees a generic model called “qemu32” or “qemu64”.  \"\n \n \n cat output:\n \n ```\n     <model name='qemu64'>\n      <!-- These are supported only by TCG.  KVM supports them only if the\n           host does.  So we leave them out:\n\n           <feature name='abm'/>\n           <feature name='lahf_lm'/>\n           <feature name='popcnt'/>\n           <feature name='sse4a'/>\n      -->\n      <feature name='apic'/>\n      <feature name='clflush'/>\n      <feature name='cmov'/>\n      <feature name='cx16'/>\n      <feature name='cx8'/>\n      <feature name='de'/>\n      <feature name='fpu'/>\n      <feature name='fxsr'/>\n      <feature name='lm'/>\n      <feature name='mca'/>\n      <feature name='mce'/>\n      <feature name='mmx'/>\n      <feature name='msr'/>\n      <feature name='mtrr'/>\n      <feature name='nx'/>\n      <feature name='pae'/>\n      <feature name='pat'/>\n      <feature name='pge'/>\n      <feature name='pni'/>\n      <feature name='pse'/>\n      <feature name='pse36'/>\n      <feature name='sep'/>\n      <feature name='sse'/>\n      <feature name='sse2'/>\n      <feature name='svm'/>\n      <feature name='syscall'/>\n      <feature name='tsc'/>\n    </model>"},{"author":"Patrick","date_created":1449894703,"date_modified":1449894703,"content":"Could you add a improved [redacted] /proc/cpuinfo output here please?\nhttps://www.whonix.org/wiki/Protocol-Leak-Protection_and_Fingerprinting-Protection#.2Fproc.2Fcpuinfo_output\n\nA note on typography:\nWriting `cpus` is probably confusing. Because that's also the name of a linux printing service. Better to write `CPUs`."},{"author":"Patrick","date_created":1464787761,"date_modified":1464787761,"content":"Ping? @HulaHoop "},{"author":"HulaHoop","date_created":1464824656,"date_modified":1464824656,"content":"Once TNT  posts the results I'll update the wiki. Should I replace the older logs or paste under them?\n\nI also enabled the hidden KVM feature.\n"},{"author":"Patrick","date_created":1464857946,"date_modified":1464857946,"content":"HulaHoop (HulaHoop):\n> Should I replace the older logs or paste under them?\n\nI guess it's better to keep for hysteric comparison. Perhaps we should\nuse expand buttons for all the logs."},{"author":"Patrick","date_created":1464859389,"date_modified":1464859389,"content":"Historic comparison."},{"author":"HulaHoop","date_created":1464878591,"date_modified":1464878591,"content":"UPDATE:\n\nWhen disabling MSR the systemd-detect-virt output changes form \"kvm\" to \"qemu\". This breaks the shared folder automatic mounting that relies on seeing \"kvm\" from virt-detect and also whonixcheck which only recognizes the hypervisor that way only.\n\nIts not worth the trouble so commits are rolled back."},{"author":"HulaHoop","date_created":1465307700,"date_modified":1465307700,"content":"Done. New output added and confirms masking out problematic CPU instructions."}]},"PHID-TASK-wbyo7dln77wsbmewimjl":{"id":"448","title":"support for Tor control protocol events (setevent) by Control Port Filter Proxy","status":"resolved","priority":"Normal","author":"Patrick","description":"[onionshare](https://github.com/micahflee/onionshare), ricochet and others require #control-port-filter-python (cpfpy) to relay events back.\n\nAt the moment only \"oneshot\" Tor control protocol commands are supported by cpfpy. I.e. the application sends one command, cpfpy checks if it is on the whitelist, and if it is, relays the command to Tor's ControlPort, and relays back Tor's answer the the application.\n\nWhat's missing is support for Tor control protocol events. I.e. asynchronous event notification. Setting up an event, and getting responses some time later.\n\nStrictly for testing purposes only:\n```\nsetevents streams\n```\n\n-----\n\n* [tor-dev - Constraining Ephemeral Service Creation in Tor](https://lists.torproject.org/pipermail/tor-dev/2016-September/011477.html)","comments":[{"author":"Patrick","date_created":1474048083,"date_modified":1474048083,"content":"Made some progress in the development branch.\n\ncommit:\nhttps://github.com/Whonix/control-port-filter-python/commit/83ec5e3f90539571b90137ce2e9f1b0c2d95dcc8\n\nfile:\nhttps://github.com/Whonix/control-port-filter-python/blob/83ec5e3f90539571b90137ce2e9f1b0c2d95dcc8/usr/sbin/cpfpd\n\nThe trick is to not close the socket to Tor's real control port.\n\nFunction `handle` does now keep looping in `fh.readline()`. Now function `handle` also passes the socket to answer the workstation directly to `do_request_real`. Now in `do_request_real` there is another loop waiting for what Tor is (maybe) going to answer later (events) using `readh.readline()`.\n\nThese two loops are currently blocking each other. So after the request `addonion ...` or so was passed, the requester (workstation) will send new control port commands in vain since we keep lurking in `do_request_real`.\n\nSo function `do_request_real` should probably become a child thread so it won't be blocking function `handle`."},{"author":"Patrick","date_created":1474062677,"date_modified":1474062677,"content":"https://github.com/Whonix/control-port-filter-python/blob/master/usr/sbin/cpfpd\n\nCould you have a look please @marmarek? Should I go for a child thread or two instances of asyncore? I am trying to combine it with the existing StreamServer, but I don't know if either approach is a dead end."},{"author":"Patrick","date_created":1474081395,"date_modified":1474081395,"content":"Big progress. \n\n- https://github.com/Whonix/control-port-filter-python/commit/e073189f6f96380b66b577d02cb6f87fe4761a82\n- https://github.com/Whonix/control-port-filter-python/blob/development/usr/sbin/cpfpd\n\nStill a work in progress and a lot cleanup of debug output and other todos but the far worst part is done."},{"author":"marmarek","date_created":1474118676,"date_modified":1474118676,"content":"Commented in that last commit. Generally looks good. Few things to consider:\n - switching to `asyncore` completely - even for handling new incoming connections, replacing `StreamServer` - not sure if worth the effort, but will make the code even cleaner. Generally better use one API for handling sockets at the time.\n - filtering responses (is it needed?)"},{"author":"Patrick","date_created":1474123926,"date_modified":1474123926,"content":"(There is also almost no exception handling atm, but that is easy to add once the other stuff is sorted out.)\n\n-----\n\n>  - switching to `asyncore` completely - even for handling new incoming connections, replacing `StreamServer` - not sure if worth the effort, but will make the code even cleaner.\n\n> Generally better use one API for handling sockets at the time.\n\nYes, generally I agree, practically I don't know if my python skills allow me to do that yet.\n\n-----\n\n@marmarek wrote in https://github.com/Whonix/control-port-filter-python/commit/e073189f6f96380b66b577d02cb6f87fe4761a82#commitcomment-19064635\n\n> This looks a bit weird - handling one side with `asyncore`, but the other one with direct `select` call. I think you can handle both with `asyncore` - it looks like `asyncore.dispatcher` can accept existing socket in `__init__` parameter.\n> This way you'll also not need that 1 sec timeout on each side.\n\nI am absolutely not proud of that loop indeed. Too hacky. In this case, a `time.wait` is mostly a sign, that no proper asynchronous event / callback based handling has been implemented. Looks weird. A code bug, even if there are no functionality or security issues from it. (Does not cause high cpu yet, but I have to keep monitoring this does not waste cpu/hdd/ram.)\n\n-----\n\nI try to sketch how the Tor Control Protocol filtering works...\n\n* 1) client connects to cpfpy -> cpfpy accepts connection and keeps it open -> maybe filtered -> connect to Tor's real ControlPort -> Tor answers instantly and connection stays open -> relay answer back to client\n\n* 2) now, maybe after an unknown time (event) Tor sends more data in the same connection -> needs to somehow also relayed back to the client\n\n* 3) client sends more data in the same connection -> again needs to be forwarded to Tor like 1)\n\n* 4) a separate client connection comes in\n\nMaybe I am overthinking it, but the combination of 1), 2), 3) and 4) is difficult for me.\n\n-----\n\nLet's say we had two asyncore loops. Then the client handler (in case of `3)`) would have to talk to the Tor handler. Is that even possible? And if so, possible without mixing up different incoming client connections (in case of `4)`)? \n\nWould these two asyncore loops have to communicate through a third asyncore loop using internal sockets?\n\n-----\n\n>>! In T448#10296, @marmarek wrote:\n> filtering responses (is it needed?)\n\nWe filter, control what does into Tor. And Tor is trusted. So what comes out of Tor should be safe. I haven't heard any argument how filtering Tor's responses would be useful.\n\n\n\n\n>>! In T448#10296, @marmarek wrote:\n> Commented in that last commit. Generally looks good.\n\nGlad to hear! Thanks for looking!\n\n\n\n\n"},{"author":"Patrick","date_created":1474156578,"date_modified":1474156578,"content":"More progress. Now there is just a single Tor connection per client. Not a as before with a bug. (Before there was one new Tor connection per client command.)\n\n- https://github.com/Whonix/control-port-filter-python/commit/b9ea6c0519f2e2f9f5b10d52c8fdd8275deb988f\n- https://github.com/Whonix/control-port-filter-python/blob/development/usr/sbin/cpfpd"},{"author":"Patrick","date_created":1474156801,"date_modified":1474156801,"content":"For the case that Tor stops the connection (upgrade, shutdown or w/e)...\n\nIn Tor connection hander, in function `handle_close` I am doing `self.client_socket.close()`.\n\nDo you think this can be spotted in the client connection handler (function `stream_server_handler`)?`That would be good, so I could also break the `stream_server_handler` loop and close the client connection so the client application does not end up with a stale Tor control port connection.\n\nOr asking another way around.  How could the Tor connection hander communicate back to the client handler?"},{"author":"Patrick","date_created":1474158401,"date_modified":1474158401,"content":"There is another much bigger issue, a deal breaker. Simultaneous connections (multiple applications) are no longer possible. No idea why. Looks like I have to port everything to asyncore."},{"author":"marmarek","date_created":1474158668,"date_modified":1474158668,"content":"Working on it, will push something in half an hour."},{"author":"marmarek","date_created":1474161028,"date_modified":1474161028,"content":"https://github.com/Whonix/control-port-filter-python/pull/3"},{"author":"Patrick","date_created":1474167306,"date_modified":1474167306,"content":"Awesome! Works great!"},{"author":"Patrick","date_created":1474168383,"date_modified":1474168383,"content":">>! In T448#10318, @Patrick wrote:\n> Awesome! Works great!\n\nThat was tested using two instances of `nc` and `setevents stream`,\n\nHowever, does not yet work for real world applications (Tor Browser). Getting fragmented.\n\nauthen\nticate\n\n\n```\n2016-09-18 03:02:11,354 - CPFP 12520 log - DEBUG - Trying to start Tor control port filter on    IP 10.137.6.1 port 9052\n2016-09-18 03:02:11,354 - CPFP 12520 log - DEBUG - Tor control port filter started, listening on IP 10.137.6.1 port 9052\n2016-09-18 03:02:19,659 - CPFP 12520 log - DEBUG - handle_connect() done\n2016-09-18 03:02:19,660 - CPFP 12520 log - DEBUG - stream_server_handler: Getting command on sock: <__main__.ControlPortFilter connected 10.137.6.41:44448 at 0x7f1d1e655200>\n2016-09-18 03:02:19,660 - CPFP 12520 log - INFO - stream_server_handler: request: authen\n2016-09-18 03:02:19,660 - CPFP 12520 log - DEBUG - stream_server_handler: Getting command on sock: <__main__.ControlPortFilter connected 10.137.6.41:44448 at 0x7f1d1e655200>\n2016-09-18 03:02:19,660 - CPFP 12520 log - INFO - stream_server_handler: request: ticate \"\n2016-09-18 03:02:19,660 - CPFP 12520 log - DEBUG - handle_close() start\n2016-09-18 03:02:19,660 - CPFP 12520 log - DEBUG - handle_close(): answer by Tor: \n2016-09-18 03:02:19,661 - CPFP 12520 log - DEBUG - handle_close(): Closing connection. self.client_socket.close()\n2016-09-18 03:02:19,661 - CPFP 12520 log - DEBUG - handle_close(): Closed connection on sock. self.client_socket: <__main__.ControlPortFilter 10.137.6.41:44448 at 0x7f1d1e655200>\n```\n\nSomehow we need to read until the delimiter `\\r\\n`."},{"author":"marmarek","date_created":1474239855,"date_modified":1474239855,"content":"https://github.com/Whonix/control-port-filter-python/pull/4"},{"author":"HulaHoop","date_created":1474336502,"date_modified":1474336502,"content":"Thanks @marmarek for helping with this :)"},{"author":"Patrick","date_created":1474470218,"date_modified":1474470218,"content":"Progress, but still some side effects to be ironed out.\n\n* Tor Browser control port commands work now.\n* `nc` connection to cpfpy no longer works. (Should work, because it also works with real Tor Control Port.)\n* Running tor-`arm`  through cpfpy with filtering disabled crashes arm in konsole. So something significant that cpfpy replies differs from what the real Tor control port would reply.\n* [onionshare](https://www.whonix.org/wiki/Next#onionshare) is capable to create its ephemeral Tor hidden service, but that onion is not actually reachable from Tor Browser. Could be Whonix firewall issues ([unloaded](https://www.whonix.org/wiki/Dev/Firewall_Unload) all workstation firewall rules for now) or could be a cpfpy issue.\n"},{"author":"Patrick","date_created":1474472556,"date_modified":1474472556,"content":">>! In T448#10358, @Patrick wrote:\n> * [onionshare](https://www.whonix.org/wiki/Next#onionshare) is capable to create its ephemeral Tor hidden service, but that onion is not actually reachable from Tor Browser. Could be Whonix firewall issues ([unloaded](https://www.whonix.org/wiki/Dev/Firewall_Unload) all workstation firewall rules for now) or could be a cpfpy issue.\n\nOne reason why onionshare cannot work has just now been described here:\nhttps://github.com/micahflee/onionshare/issues/220#issuecomment-248650516"},{"author":"Patrick","date_created":1474475590,"date_modified":1474475590,"content":"One way would be getting these feature requests integrated into onionshare.\n\n- https://github.com/micahflee/onionshare/issues/220#issuecomment-248650516\n- https://github.com/micahflee/onionshare/issues/220\n\nBut then we would have to make similar modifications into all applications making use of Tor ephemeral services. Perhaps it is better to modify cpfpy so it automatically adds `Target=<workstation IP>` if it recognized the `add_onion` command."},{"author":"Patrick","date_created":1474487373,"date_modified":1474487373,"content":"There is another blocker. cpfpy now consistently uses 100% cpu.\n\nhttp://www.gossamer-threads.com/lists/python/python/118657"},{"author":"marmarek","date_created":1474492011,"date_modified":1474492011,"content":"I'm on it."},{"author":"marmarek","date_created":1474492399,"date_modified":1474492399,"content":"https://github.com/Whonix/control-port-filter-python/pull/5"},{"author":"marmarek","date_created":1474492616,"date_modified":1474492616,"content":"> nc connection to cpfpy no longer works. (Should work, because it also works with real Tor Control Port.)\n\nThis is because cpfpy now expects CRLF (just LF is not enough). According to spec, it is ok:\n> Wherever CRLF is specified to be accepted from the controller, Tor MAY also\n> accept LF.  Tor, however, MUST NOT generate LF instead of CRLF.\n> Controllers SHOULD always send CRLF.\n\nUse telnet, it works for me."},{"author":"Patrick","date_created":1474506378,"date_modified":1474506378,"content":"Cannot stop being amazed! :)\n\nYes, `telnet` is fine, never mind `nc`. (Using this for debugging only anyhow.)\n\n-----\n\nFor debugging purposes, I entered `add_onion new:best port=80,10.137.6.41:80` into cpfpy in combination with our [hidden web server instructions](https://www.whonix.org/wiki/Hidden_Services), which worked.\n\n-----\n\nI also sufficiently hacked things on my local computer to have a onionshare proof of concept.\n\nNow, there are just two pieces missing for this to go into production:\n\n* a) injecting IP in cpfpy into add_onion\n* b) onionshare http listener should listen on all interfaces (at least the external eth0 one)\n\n-----\n\nTo hack around a), luckily onionshare on restart always takes port `17600`. So I could hardcoded into cpfpy.\n\n```\nrequest = \"add_onion new:best port=80,10.137.6.41:17600\"\n```\n\nI try to implement this string manipulation for a) on the fly so it works for any port, any application.\n\n-----\n\nTo hack around b), inside the workstation:\n\n```\nsocat TCP-LISTEN:17600,bind=10.137.6.41,fork TCP:127.0.0.1:17600\n```\n\nFinding a generic solution for b) that is a bit harder.\n\n* 1) The onionshare developer could be open to add a feature to have the webserver listen on all interfaces when it detects being run inside Whonix.\n * Not great, because not generic. We would require similar feature requests from other applications that use Tor hidden services.\n* 2) Ship socat listeners by default that listen in onionshare range from `17600` to `17650`.\n * Also not generic.\n * Loads of socat listeners. At some point they could even eat too much RAM if they become too many.\n * Could be made conditional by only loading these listeners if onionshare is installed. (Not great when installed inside template and not all Whonix-Workstations use onionshare.)\n* 3) Can you think of any other solution?\n"},{"author":"HulaHoop","date_created":1474511069,"date_modified":1474511069,"content":"Are network namespaces (ip-netns) of any use here? It can manipulate any application's view of the local network stack even if its not aware or supports the feature:\n\nhttp://man7.org/linux/man-pages/man8/ip-netns.8.html"},{"author":"Patrick","date_created":1474516521,"date_modified":1474516521,"content":"I don't know how ip-netns could be used here.\n\nFor linux it's a strange question to ask, looks like. Most server software supports choosing bind addresses. Local interfaces, all interfaces, selected interfaces. Just the Tor ephemeral onion options come with no such option since from there view that is pointless, even dangerous. So the question to ask is like \"my server application can only bind on localhost, how can I let it bind localhost but actually have it bind on external network?\" Therefore there may be no obvious tool for this purpose.\n\nC code and LD_PRELOAD might do the magic here.\n\nPerhaps https://github.com/yongboy/bindp can already do? It's very small, still C."},{"author":"Patrick","date_created":1474518141,"date_modified":1474518141,"content":"bindp even works!\n\n```\nBIND_ADDR=\"10.137.6.41\" LD_PRELOAD=/home/user/bindp/libindp.so onionshare a\n```\n\nIt would require wrappers being installed. Similar to uwt. Not pretty. Still not generic, requires one wrapper per application. (I doubt there can be a generic solution.)\n\n-----\n\nWhat's better?\n\n* Implement the workarounds in Whonix? Then once #whonix_14 is released, we could provide instructions how users can install onionshare, ricochet from jessie-backports.\n* Or work with application developers like onionshare, ricochet so they would add modes for Whonix (or more generically called, Tor isolating proxy systems or so). Until we can preinstall onionshare, ricochet we should wait until #debian_stretch anyhow."},{"author":"Patrick","date_created":1474518559,"date_modified":1474518559,"content":"`redirect application listening on localhost to listening on external interface / alternative to bindp ( libindp.so )`:\nhttp://unix.stackexchange.com/questions/311492/redirect-application-listening-on-localhost-to-listening-on-external-interface"},{"author":"Patrick","date_created":1474554978,"date_modified":1474554978,"content":"cpfpy restart is broken.\n\n```\n2016-09-22 14:25:18,931 - CPFP 20603 log - INFO - Trying to start Tor control port filter on    IP 10.137.6.1 port 9052\n2016-09-22 14:25:18,931 - CPFP 20603 log - INFO - Tor control port filter started, listening on IP 10.137.6.1 port 9052\n2016-09-22 14:26:23,537 - CPFP 20603 log - INFO - Sigint received.\n2016-09-22 14:26:23,538 - CPFP 20603 log - INFO - End.\n2016-09-22 14:26:24,653 - CPFP 20606 log - INFO - Trying to start Tor control port filter on    IP 10.137.6.1 port 9052\n2016-09-22 14:26:24,653 - CPFP 20606 log - CRITICAL - Server error [Errno 98] Address already in use\n2016-09-22 14:26:24,653 - CPFP 20606 log - CRITICAL - Exiting.\n```\n\nAny idea why out sigterm / sigint  / keyboard interrupt handlers do not work? They are invoked, `asyncore.close_all()` is run, but it does not actually close the listener."},{"author":"HulaHoop","date_created":1474558735,"date_modified":1474559708,"content":"I'm seeing iptables rules for redirecting localhost ports to an external interface. Benefit is that no wrappers are required but a port specific rule for each application supported.\n\nhttps://superuser.com/questions/440324/iptables-how-to-forward-all-external-ports-to-one-local-port\n\n\nEDIT:\n\nhttps://superuser.com/a/807612\n\nYou may need to enable sysctl -w net.ipv4.conf.all.route_localnet=1 to allow such rules to work.\n\n> Implement the workarounds in Whonix? Then once Whonix 14 is released, we could provide instructions how users can install onionshare, ricochet from jessie-backports.\n\n+1\n\nI think solving this in Whonix instead of waiting on upstream cooperation which may be delayed or sometimes not possible is better."},{"author":"Patrick","date_created":1474562106,"date_modified":1474562106,"content":">>! In T448#10376, @HulaHoop wrote:\n> I'm seeing iptables rules for redirecting localhost ports to an external interface. Benefit is that no wrappers are required but a port specific rule for each application supported.\n> \n> https://superuser.com/questions/440324/iptables-how-to-forward-all-external-ports-to-one-local-port\n> \n> \n> EDIT:\n> \n> https://superuser.com/a/807612\n> \n> You may need to enable sysctl -w net.ipv4.conf.all.route_localnet=1 to allow such rules to work.\n\nThat doesn't work. Steps to try this out:\n\nhttps://www.whonix.org/wiki/Dev/Port_Redirection"},{"author":"Patrick","date_created":1474562383,"date_modified":1474562383,"content":"I was wrong. Made a mistake in the port number. It does work.\n\nQuestion is, if setting `sudo sysctl -w net.ipv4.conf.all.route_localnet=1` is sane or has any adverse effects?"},{"author":"Patrick","date_created":1474564646,"date_modified":1474564646,"content":"Whonix-Workstation IP injection into add_onion implemented.\n\nhttps://github.com/Whonix/control-port-filter-python/commit/79ecc7cad1058b50036d1ecf3e98b5fcc3bb151b"},{"author":"HulaHoop","date_created":1474582916,"date_modified":1474582916,"content":"Here are the security implications. I think they are important enough to warrant spinning off this sysctl tweak into its own package to prevent it being enabled on hosts that use the security/usability-misc packages on hosts (like mine):\n\nhttps://unix.stackexchange.com/a/112232\n\n> By default this value is 0, which instructs the kernel to not route external traffic destined to 127.0.0.0/8. This is just for security as such traffic is not normal.\n\nIf you decide this is not acceptable try this alternative to sysctl altering:\nhttps://unix.stackexchange.com/a/112213\n\n***\n\nOfftopic: In the iptables rules use eth0 to avoid conflicting addresses in case of multiple WSs on the same internal network."},{"author":"Patrick","date_created":1474587552,"date_modified":1474587552,"content":"That doesn't work. Same iptables command as net.ipv4.conf.all.route_localnet one."},{"author":"Patrick","date_created":1474587737,"date_modified":1474587737,"content":"`What are the security implications of net.ipv4.conf.eth0.route_localnet=1 / route_localnet?`\nhttp://security.stackexchange.com/questions/137602/what-are-the-security-implications-of-net-ipv4-conf-eth0-route-localnet-1-rout\n"},{"author":"Patrick","date_created":1474591731,"date_modified":1474591731,"content":"Merged into master branch since the remaining todo safely makes it into Whonix 14."},{"author":"Patrick","date_created":1474598436,"date_modified":1474607619,"content":"Security aspects...\n\nDo you think Whonix-Workstation could spoof its client_ip and therefore lead to an security issue?\n\n```\n    def handle_accept(self):\n        conn, addr = self.accept()\n        client_ip = str(addr[0])\n```\n\nWe have to be careful about `add_onion`. We should not allow `add_onion` by default anyhow, because an open Tor hidden service makes certain attacks easier. So onionshare and similar applications will always need manual configuration. (Could be simplified one day with guis and whatnot.)\n\nWe have to be careful about `add_onion`. For those who enabled it... A possible attack:\n\n> A compromised Whonix-Workstation could open a Tor Hidden Service and then have it terminate on Whonix-Gateway, thereby connect to Tor's real control port. (credits: David Stainton)\n\nTherefore and for other reasons, Tor ControlPort will be disabled in Whonix 14. ([commit](https://github.com/Whonix/anon-gw-anonymizer-config/commit/49ce21f97965609e4fe06af20005637878324fcc)) CPFPY will authenticate to Tor using the Tor cookie authentication file method.\n\nAlso other ports that are normally firewalled matter.\n\n```\nsudo netstat -tulpen\n```\n\n```\nActive Internet connections (only servers)\nProto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode       PID/Program name\ntcp        0      0 10.137.6.1:9052         0.0.0.0:*               LISTEN      106        207067      32250/python    \ntcp        0      0 127.0.0.1:4101          0.0.0.0:*               LISTEN      0          8599        219/brltty      \ntcp        0      0 0.0.0.0:8082            0.0.0.0:*               LISTEN      0          12776       852/tinyproxy\n```\n\n* 9052 cpfpy itself, ok.\n* 4101 brltty, bad. Perhaps no longer install brltty by default and sort that out once we work on accessibility support. (related: T457)\n* 9052 tinyproxy [Qubes only], not great.\n\nPerhaps we could restrict Tor from connecting to these ports? Limiting where user `debian-tor` may connect?\n\nother TODO:\n\n- log uncaught exceptions\n- ~~enforce max string length for incoming connections (done)~~\n- ~~option to use/not use add_onion IP injection feature (done)~~\n- reject request if add_onion contains and IP of Whonix-Gateway (that includes 127.0.0.1)\n- anything else?"},{"author":"Patrick","date_created":1474607707,"date_modified":1474607707,"content":"- (Updated above post.)\n- https://github.com/Whonix/control-port-filter-python/commit/f5a12054e9e63ee49cf35ba6c91b501b82b1c73c\n- https://github.com/Whonix/control-port-filter-python/commit/ab11f9aeb122a5879ad70fec3b51cc81697c058f\n\n-----\n\nTails is having an interesting discussion about `add_onion` which really can be dangerous if not tamed:\nhttps://labs.riseup.net/code/issues/7870#note-28\n"},{"author":"marmarek","date_created":1474628429,"date_modified":1474628429,"content":">>! In T448#10396, @Patrick wrote:\n> Security aspects...\n> \n> Do you think Whonix-Workstation could spoof its client_ip and therefore lead to an security issue?\n\nShould be prevented by firewall. At least in Qubes case it is (in `raw` table, based on incoming interface).\n\nAlso make sure that `add_onion` is properly filtered/transformed. Some test cases:\n - `port` parameter already contains IP\n - multiple `port` parameters\n - invalid/unknown parameters (should be filtered? rejected?), some could be harmful, if not now, maybe in future protocol versions\n\n> Also other ports that are normally firewalled matter.\n> \n> ```\n> sudo netstat -tulpen\n> ```\n> \n> ```\n> Active Internet connections (only servers)\n> Proto Recv-Q Send-Q Local Address           Foreign Address         State       User       Inode       PID/Program name\n> tcp        0      0 10.137.6.1:9052         0.0.0.0:*               LISTEN      106        207067      32250/python    \n> tcp        0      0 127.0.0.1:4101          0.0.0.0:*               LISTEN      0          8599        219/brltty      \n> tcp        0      0 0.0.0.0:8082            0.0.0.0:*               LISTEN      0          12776       852/tinyproxy\n> ```\n> \n> * 9052 cpfpy itself, ok.\n> * 4101 brltty, bad. Perhaps no longer install brltty by default and sort that out once we work on accessibility support. (related: T457)\n> * 8082 tinyproxy [Qubes only], not great.\n\nShould it be limited to templates only? This is normally done using qubes-firewall, but it is disabled on Whonix Gateway.\n\n> Perhaps we could restrict Tor from connecting to these ports? Limiting where user `debian-tor` may connect?\n\nGood idea."},{"author":"Patrick","date_created":1474645453,"date_modified":1474645453,"content":"Do you think DaemonRunner is still of any use or could be removed?\n\n>>! In T448#10402, @marmarek wrote:\n> Also make sure that `add_onion` is properly filtered/transformed. Some test cases:\n>  - `port` parameter already contains IP\n>  - multiple `port` parameters\n>  - invalid/unknown parameters (should be filtered? rejected?), some could be harmful, if not now, maybe in future protocol versions\n\nAnother test case: spaces in IP address. (Probably rejected by Tor.)\n\nI am going to implement matching add_onion command (after IP injection) for all of Whonix-Gateway's IPs (which must include 127.0.0.1). If found, control command will be rejected. That way it should not be opening a listener on Whonix-Gateway. That should suffice?\n\nFuture protocol versions: we already do control what major Tor version flow into Whonix due to updates. And Tor control protocol updates fortunately only happen during major versions. It's on my list to keep reading Tor changelogs and monitor them for anything that effects Whonix / cpfpy.\n\n>> * 8082 tinyproxy [Qubes only], not great.\n> \n> Should it be limited to templates only? This is normally done using qubes-firewall, but it is disabled on Whonix Gateway.\n\nEven if I have not heard and argument tinyproxy is easily exploited, I always thought it is a good idea to limit access to tinyproxy to TemplateVMs. This is not the case currently in Whonix. So not a big deal in the scope of this ticket. (We have existing Qubes tickets to improve that, qrexec based updates proxy / new firewall interface.)"},{"author":"Patrick","date_created":1474653349,"date_modified":1474653349,"content":"I am looking for code to find out all local IPv4 and IPv6 addresses.\n\nDoes http://stackoverflow.com/a/10377262/2605155 look sane?"},{"author":"HulaHoop","date_created":1474654432,"date_modified":1474654432,"content":"Just to be sure, flags sent by the WS are ignored/rewritten right?\n\nFor example the \"NonAnonymous\" flag will cause creation of a single hop service that is encrypted but not hidden.\n\n\nhttps://gitweb.torproject.org/torspec.git/tree/control-spec.txt\n\n\nFor port choice do you think a port range whitelist is a good idea for more defense?"},{"author":"marmarek","date_created":1474659030,"date_modified":1474659030,"content":">>! In T448#10419, @Patrick wrote:\n> Do you think DaemonRunner is still of any use or could be removed?\n\nIn theory it should handle things like \"start\"/\"stop\" actions, pid file, sigterm etc.  But if we don't use any of this, probably can be removed. Also if it's always started from systemd, better let systemd manage it (i.e. run as foreground process, pidfile not needed).\n\n>>>! In T448#10402, @marmarek wrote:\n>> Also make sure that `add_onion` is properly filtered/transformed. Some test cases:\n>>  - `port` parameter already contains IP\n>>  - multiple `port` parameters\n>>  - invalid/unknown parameters (should be filtered? rejected?), some could be harmful, if not now, maybe in future protocol versions\n> \n> Another test case: spaces in IP address. (Probably rejected by Tor.)\n\nYes. Probably this could fool filtering - like using `127` as address (which most software recognize as valid representation of 127.0.0.0).\n\n> I am going to implement matching add_onion command (after IP injection) for all of Whonix-Gateway's IPs (which must include 127.0.0.1). If found, control command will be rejected. That way it should not be opening a listener on Whonix-Gateway. That should suffice?\n\nI'm not fully following. But isn't it better to do the other way around - allow only client IP and reject anything else?\n\n> Future protocol versions: we already do control what major Tor version flow into Whonix due to updates. And Tor control protocol updates fortunately only happen during major versions. It's on my list to keep reading Tor changelogs and monitor them for anything that effects Whonix / cpfpy.\n\nYes, that's important. But having a code to actually prevent such commands/options even when you miss some changelog entry would be better. Whitelisting better than blacklisting.\n\n>>> * 8082 tinyproxy [Qubes only], not great.\n>> \n>> Should it be limited to templates only? This is normally done using qubes-firewall, but it is disabled on Whonix Gateway.\n> \n> Even if I have not heard and argument tinyproxy is easily exploited, I always thought it is a good idea to limit access to tinyproxy to TemplateVMs. This is not the case currently in Whonix. So not a big deal in the scope of this ticket. (We have existing Qubes tickets to improve that, qrexec based updates proxy / new firewall interface.)\n\nYes."},{"author":"Patrick","date_created":1474659529,"date_modified":1474659529,"content":"```\n- new configuration option ONION_REJECT_OWN_IPS (default: true), that will\n  reject any add_onion requests that contain any IP that the gateway has\n- reject request if add_onion IP injection failed rather than passing non-transformed request\n- fix config parsing bug\n  (fixed case when there is a config file but still some value undefined)\n- log to stdout rather than /var/log/control-port-filter-python.log, so cpfpy\n  output ends up in journal\n- deprecated /var/log/control-port-filter-python.log\n- no longer use DaemonRunner, no longer fork, leave that to systemd\n- remove unused class UnexpectedAnswer(Exception)\n```\nhttps://github.com/Whonix/control-port-filter-python/commit/88aafe059bb05dd1175148d00f635db6ff020cbd\n\n-----\n\n>>! In T448#10422, @HulaHoop wrote:\n> Just to be sure, flags sent by the WS are ignored/rewritten right?\n\nExcellent point!\n \n> For example the \"NonAnonymous\" flag will cause creation of a single hop service that is encrypted but not hidden.\n\nRewrite not for now. Will reject NonAnonymous. If there ever are any legitimate applications using flag NonAnonymous by default where upstream cooperation fails, we can still purge NonAnonymous from the request string.\n\nAny other flags we should block?\n\n> For port choice do you think a port range whitelist is a good idea for more defense?\n\nNot sure. I want to limit the amount of string parsing and string manipulation. Not for security, but to keep the code simpler. These ports are very application specific. Now that we have `ONION_REJECT_OWN_IPS`, that should not be necessary."},{"author":"Patrick","date_created":1474671340,"date_modified":1474671340,"content":">>! In T448#10436, @marmarek wrote:\n>>> Also make sure that `add_onion` is properly filtered/transformed. Some test cases:\n>>>  - `port` parameter already contains IP\n>>>  - multiple `port` parameters\n>>>  - invalid/unknown parameters (should be filtered? rejected?), some could be harmful, if not now, maybe in future protocol versions\n>> \n>> Another test case: spaces in IP address. (Probably rejected by Tor.)\n> \n> Yes. Probably this could fool filtering - like using `127` as address (which most software recognize as valid representation of 127.0.0.0).\n\n\n>> I am going to implement matching add_onion command (after IP injection) for all of Whonix-Gateway's IPs (which must include 127.0.0.1). If found, control command will be rejected. That way it should not be opening a listener on Whonix-Gateway. That should suffice?\n> \n> I'm not fully following. But isn't it better to do the other way around - allow only client IP and reject anything else?\n\nIt's better, but also harder. Then it is needed to fully parse and understand the add_onion command from within python. Originally I wanted to prevent going into the deepness of the protocol from within cpfpy.\n\n>> Future protocol versions: we already do control what major Tor version flow into Whonix due to updates. And Tor control protocol updates fortunately only happen during major versions. It's on my list to keep reading Tor changelogs and monitor them for anything that effects Whonix / cpfpy.\n> \n> Yes, that's important. But having a code to actually prevent such commands/options even when you miss some changelog entry would be better. Whitelisting better than blacklisting.\n\nRight. I will work on fully parsing the add_onion command and only sent what has been sanitized and reconstructed."},{"author":"HulaHoop","date_created":1474677390,"date_modified":1474677626,"content":"> I'm not fully following. But isn't it better to do the other way around - allow only client IP and reject anything else?\n\n+1\n\nI think whitelisting is much safer than blacklisting anywhere. Imagine supporting IPv6 addresses someday and not updating the blacklist, then things can easily get by it or there is some obscure way to represent local addresses that we don't know about yet.\n\nManually hardcoding some subset of the 10.152.152.10 address range is better. I doubt users need more than 100 IPs on the internal network.\n\n> Any other flags we should block?\n\nLets do it with whitelists:\n\n\n* KeyType - only allow NEW\n* KeyBlob - only allow BEST\n* Flag - only allow DiscardPK, Detach, BasicAuth\n\n* VirtPort - port ranges are useful so an attacker cannot use up resources by enabling every port on the GW. IMO having this configurable .d style is good for customization.\n\n* ClientName - only allow input formatted like so: \"An identifier 1 to 16 characters long, using only characters in A-Za-z0-9+-_ (no spaces).\"\n\n* ClientBlob - need more info to make decisions about expected input size.\n\nI think there should be some way to put an upper bound on the number of ephemeral HSes allowed to be created. A DoS that can exhaust the GW resources by spamming ADD_ONION until its RAM/CPU is used up is very bad and can eventually have network visible consequences.\n\n\n*** \n\nI think by this point users should be warned not to run multiple internal nets with different trust levels behind the same GW because its not possible to stop a malicious process in one internal net asking about the ephemeral service of a process in the other. This affects Qubes-Whonix where such a feature is possible."},{"author":"Patrick","date_created":1474680492,"date_modified":1474680492,"content":"Parsing the whole add_onion command seems incredibly complex. There are too many combinations. I am not sure I can implement all sane features or if we should do that. Perhaps just a subset. Perhaps it just be tailored for real world applications.\n\n>>! In T448#10441, @HulaHoop wrote:\n>> I'm not fully following. But isn't it better to do the other way around - allow only client IP and reject anything else?\n> \n> +1\n> \n> I think whitelisting is much safer than blacklisting anywhere. Imagine supporting IPv6 addresses someday and not updating the blacklist, then things can easily get by it or there is some obscure way to represent local addresses that we don't know about yet.\n\nCurrently IPv6 addresses are already enumerated. But the obscure representations are indeed an issue.\n\n> Manually hardcoding some subset of the 10.152.152.10 address range is better. I doubt users need more than 100 IPs on the internal network.\n> \n>> Any other flags we should block?\n> \n> Lets do it with whitelists:\n> \n> \n> * KeyType - only allow NEW\n> * KeyBlob - only allow BEST\n\nThat would mean, no support for getting hidden services with saved private keys back online. I guess it's not what you had in mind?\n\nFrom the examples: `ADD_ONION RSA1024:[Blob Redacted] Port=80,192.168.1.1:8080`\n\n> * Flag - only allow DiscardPK, Detach, BasicAuth\n> \n> * VirtPort - port ranges are useful so an attacker cannot use up resources by enabling every port on the GW. IMO having this configurable .d style is good for customization.\n\nVirtPort is the port at the Tor hidden service, not on the gateway. You are suggesting to limit target ports?\n\n> I think there should be some way to put an upper bound on the number of ephemeral HSes allowed to be created. A DoS that can exhaust the GW resources by spamming ADD_ONION until its RAM/CPU is used up is very bad and can eventually have network visible consequences.\n\nMakes sense but seems hard to implement. cpfpy would have to globally track the number of HSes and make that somehow survive cpfpy restarts.\n \n> *** \n> \n> I think by this point users should be warned not to run multiple internal nets with different trust levels behind the same GW because its not possible to stop a malicious process in one internal net asking about the ephemeral service of a process in the other. \n\nAs far I understand, Tor ephemeral HSes in one Tor control connection (from ws one) cannot be touched from another Tor control connection. The flag `Detach` may or may not influence that.\n\nYes. I would go as far recommending against using the same gateway for hosting hidden services (let alone ephemeral hidden services)  for other tasks such as simple browsing."},{"author":"HulaHoop","date_created":1474685174,"date_modified":1474685174,"content":"\n> Parsing the whole add_onion command seems incredibly complex. There are too many combinations. I am not sure I can implement all sane features or if we should do that. Perhaps just a subset. Perhaps it just be tailored for real world applications.\n\nAgreed. I think it only makes sense to accept predefined strings that have parameters ordered a certain way - there is a few of those in use right now anyway.\n\n> That would mean, no support for getting hidden services with saved private keys back online. I guess it's not what you had in mind?\n\nDo you know if any onion apps use these older ciphers? I thought the ECC keys allowed completely offline HS keys. The idea here is to prevent a malicious process from downgrading the crypto used. If that has little realworld use then sure add support for RSA1024 too.\n\n>  You are suggesting to limit target ports?\n\nYes.\n\n> Makes sense but seems hard to implement. cpfpy would have to globally track the number of HSes and make that somehow survive cpfpy restarts.\n\nI thought about it more and it should be Tor that handles this not cpfpy. For example Tor rate limits newnym requests that are made too soon. I think this needs to be discussed with upstream."},{"author":"Patrick","date_created":1474987224,"date_modified":1474987224,"content":"I guess we don't get around unit testing now. Do you have any examples where I can define function names, inputs and expected outputs?\n\nWrote a test script for this purpose. Now everything is white listed. This is how I'd built it into cpfpy soon. More maliciously formed add_onion request string suggestions appreciated.\n\n```\n#!/usr/bin/python\n\nimport logging\nimport os\nimport sys\n\nclient_ip = \"555.555.555.555\"\nADD_ONION_INJECT_IP = True\n\n#\"ADD_ONION RSA1024:[Blob Redacted] Port=80,192.168.1.1:8080\",\n\nadd_onion_test = [\n \"ADD_ONION NEW:BEST Flags=DiscardPK Port=80\",\n \"ADD_ONION NEW:BEST Port=22 Port=80,8080\",\n \"ADD_ONION NEW:BEST Flags=DiscardPK,BasicAuth Port=22\",\n \"ADD_ONION NEW:BEST Flags=DiscardPK Port=22\",\n \"ADD_ONION NEW:BEST Flags=DiscardPK,NonAnonymous Port=22\",\n \"ADD_ONION NEW:BEST Flags=DiscardPK Port=22\",\n \"ADD_ONION NEW:BEST Flags=DiscardPK,NonAnonymous Port=22\",\n \"add_onion new:best port=80,17600\",\n \"add_onion new:best port=80,127.0.0.1:17600\",\n \"add_onion new:best port=8 0,17600\"\n \"add_onion new:best port=80 : 17600\",\n \"add_onion new:best port=80 : 17600 Flags=DiscardPK\",\n \"add_onion new:best port= 80:17600 Flags=DiscardPK\",\n];\n\n## TODO: blob support\n## TODO: do not lower KeyBlob\n## TODO: do not lower ClientBlob\ndef add_onion_parse(request, client_ip, inject):\n    ## ADD_ONION KeyType:KeyBlob\n    ## Flags=Flag,Flag\n    ## Port=VirtPort,TargetIP:TargetPort\n    ## ClientAuth=ClientName\n    ## ClientAuth=ClientName:ClientBlob\n\n    request_processed = \"\"\n\n    block_counter = 0\n    for block in request.split(\" \"):\n        block_counter = block_counter + 1\n        #logger.info('block %s: %s' % (str(block_counter), block))\n        if block_counter == 1 and block == \"add_onion\":\n           request_processed = \"add_onion\"\n           continue\n        if block_counter == 2:\n           KeyTyp = block.split(\":\")[0]\n           KeyBlob = block.split(\":\")[1]\n           if KeyTyp == \"new\":\n               request_processed = request_processed + \" \" + \"new\"\n           elif KeyTyp == \"rsa1024\":\n               request_processed = request_processed + \" \" + \"rsa1024\"\n           else:\n               logger.error('KeyType not whitelisted! KeyTyp: %s' % (KeyType))\n               return False\n           request_processed = request_processed + \":\" + KeyBlob\n           continue\n\n        first = block.split(\"=\")[0]\n        second = block.split(\"=\")[1]\n        if first == \"flags\":\n            request_processed = request_processed + \" \" + \"flags=\"\n            for single_flag in second.split(\",\"):\n                #logger.info('single_flag: %s' % (single_flag))\n                if single_flag == \"discardpk\":\n                   request_processed = request_processed + \"discardpk,\"\n                elif single_flag == \"detach\":\n                   request_processed = request_processed + \"detach,\"\n                elif single_flag == \"basicauth\":\n                   request_processed = request_processed + \"detach,\"\n                else:\n                   logger.error('Flag not whitelisted! flag: %s' % (single_flag))\n                   return False\n\n            ## Remove extraneous ',' at the end.\n            request_processed = request_processed[:-1]\n        elif first == \"port\":\n           request_processed = request_processed + \" \" + \"port=\"\n           port = second\n\n           ##    port=22\n           ## vs port=80,17600\n\n           ## Format such as 'Port=80,192.168.1.1:8080' not yet supported.\n\n           if len(port.split(\",\")) == 1:\n               if not port.isdigit():\n                   logger.error('port is no digit! port: %s' % (str(port)))\n                   return False\n               request_processed = request_processed + port + \",\"\n           elif len(port.split(\",\")) == 2:\n               port_counter = 0\n               for port_single in port.split(\",\"):\n                  if not port_single.isdigit():\n                     logger.error('port_single is no digit! port_single: %s' % (str(port_single)))\n                     return False\n\n                  #logger.info('port_single %s: %s' % (str(port_counter), port_single))\n                  port_counter = port_counter + 1\n                  if port_counter == 1:\n                      request_processed = request_processed + port_single + \",\"\n                  elif port_counter == 2:\n                      if inject == True:\n                          request_processed = request_processed + client_ip + \":\" + port_single + \",\"\n                      else:\n                          request_processed = request_processed + \":\" + port_single + \",\"\n                  else:\n                     logger.error('len(port.split(\",\")) too long!')\n                     return False\n\n           ## Remove extraneous ',' at the end.\n           request_processed = request_processed[:-1]\n\n    return request_processed\n\n\nmypid = os.getpid()\nlog_prefix = \"CPFP \" + str(mypid) + \" log\"\nlogger = logging.getLogger(log_prefix)\nlogger.setLevel(logging.DEBUG)\n\nformatter = logging.Formatter(\"%(asctime)s - %(name)s - %(levelname)s - %(message)s\")\nhandler = logging.StreamHandler(sys.stdout)\nhandler.setFormatter(formatter)\nlogger.addHandler(handler)\n\nfor request in add_onion_test:\n    logger.info('request_requested: %s' % (request))\n    request = request.lower().strip()\n    request_startswith = request.split(' ', 1)[0]\n    if request_startswith == \"add_onion\":\n        try:\n            request_processed = add_onion_parse(request, client_ip, ADD_ONION_INJECT_IP)\n        except:\n            exception_msg = str(sys.exc_info()[0])\n            logger.error('exception_msg: %s' % (exception_msg))\n            request_processed = False\n        logger.info('request_processed: %s' % (request_processed))\n        print \"\"\n```\n\n-----\n\n```\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Flags=DiscardPK Port=80\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_processed: add_onion new:best flags=discardpk port=80\n\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Port=22 Port=80,8080\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_processed: add_onion new:best port=22 port=80,555.555.555.555:8080\n\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Flags=DiscardPK,BasicAuth Port=22\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_processed: add_onion new:best flags=discardpk,detach port=22\n\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Flags=DiscardPK Port=22\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_processed: add_onion new:best flags=discardpk port=22\n\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Flags=DiscardPK,NonAnonymous Port=22\n2016-09-27 16:26:19,283 - CPFP 9680 log - ERROR - Flag not whitelisted! flag: nonanonymous\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_processed: False\n\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Flags=DiscardPK Port=22\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_processed: add_onion new:best flags=discardpk port=22\n\n2016-09-27 16:26:19,283 - CPFP 9680 log - INFO - request_requested: ADD_ONION NEW:BEST Flags=DiscardPK,NonAnonymous Port=22\n2016-09-27 16:26:19,283 - CPFP 9680 log - ERROR - Flag not whitelisted! flag: nonanonymous\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_processed: False\n\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_requested: add_onion new:best port=80,17600\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_processed: add_onion new:best port=80,555.555.555.555:17600\n\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_requested: add_onion new:best port=80,127.0.0.1:17600\n2016-09-27 16:26:19,284 - CPFP 9680 log - ERROR - port_single is no digit! port_single: 127.0.0.1:17600\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_processed: False\n\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_requested: add_onion new:best port=8 0,17600add_onion new:best port=80 : 17600\n2016-09-27 16:26:19,284 - CPFP 9680 log - ERROR - exception_msg: <type 'exceptions.IndexError'>\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_processed: False\n\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_requested: add_onion new:best port=80 : 17600 Flags=DiscardPK\n2016-09-27 16:26:19,284 - CPFP 9680 log - ERROR - exception_msg: <type 'exceptions.IndexError'>\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_processed: False\n\n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_requested: add_onion new:best port= 80:17600 Flags=DiscardPK\n2016-09-27 16:26:19,284 - CPFP 9680 log - ERROR - port is no digit! port: \n2016-09-27 16:26:19,284 - CPFP 9680 log - INFO - request_processed: False\n```"},{"author":"Patrick","date_created":1474987573,"date_modified":1474987573,"content":">>! In T448#10444, @HulaHoop wrote:\n\n>> That would mean, no support for getting hidden services with saved private keys back online. I guess it's not what you had in mind?\n> \n> Do you know if any onion apps use these older ciphers? I thought the ECC keys allowed completely offline HS keys. The idea here is to prevent a malicious process from downgrading the crypto used. If that has little realworld use then sure add support for RSA1024 too.\n\nIt doesn't look like ECC HS keys are implemented yet.\n\n>>  You are suggesting to limit target ports?\n> \n> Yes.\n\nWhy? If we make double sure the target IP will be the client IP who sent the add_onion command...\n\nPort ranges are very application specific.\n\nAnd limiting them does not help. The adversary could also bind to an allowed port and then just using something like socat to redirect it to a port of his choice.\n\n>> Makes sense but seems hard to implement. cpfpy would have to globally track the number of HSes and make that somehow survive cpfpy restarts.\n> \n> I thought about it more and it should be Tor that handles this not cpfpy. For example Tor rate limits newnym requests that are made too soon. I think this needs to be discussed with upstream.\n\nYes. Can you take this upstream please?"},{"author":"HulaHoop","date_created":1474991699,"date_modified":1474991699,"content":"The list_ephemeral_hidden_services parameter can be used to ask Tor to list all ephemeral services. By default it shows those created by a controller with the detached boolean as optionally including services who's continuation isn't tied to a controller.\n\nDown the page:\ndetached (bool) -- continue this hidden service even after this control connection is closed if True\n\nSo if detached is allowed in cpfp-py, the number of services including them must be queried.\n\nhttps://stem.torproject.org/api/control.html\n\n***\n\nIdea: Every time an ADD_ONION request hits cpfp, it checks the list to see how many ephemeral services are active and if the number exceeds a preconfigured limit, the request is silently dropped (optionally with a generic log message if you think that is useful).\n\nIf this is implemented successfully you can parse the number of ports provided in an ADD_ONION request and make sure they are not excessive - only 3 or 4 allowed per request and a total of 10 services allowed - 30-40 ports maximum open at any time is not so bad and is more flexible than an arbitrarily fixed port range."},{"author":"marmarek","date_created":1474997999,"date_modified":1474997999,"content":">>! In T448#10482, @Patrick wrote:\n> I guess we don't get around unit testing now. Do you have any examples where I can define function names, inputs and expected outputs?\n\nTake a look at https://docs.python.org/2/library/unittest.html\nGenerally, add a new class inheriting from `unittest.TestCase`, then add method(s) named `test_something` and use `self.assertEqual(expected_result, actual_result)` (or other method - see linked documentation). Then call it: `python -m unittest path/to/file`\n\nSome example: https://github.com/marmarek/qubes-core-admin/blob/core3-firewall/qubes/tests/firewall.py\n\nIt's easier to write unit tests when code is sufficiently divided to functions: for example have separate `prepare_response` and `send_response` instead of `prepare_and_send_response`. But even in the later case, you can create wrapper class (just for testing purpose) to override `self.send` with something that will just save the data for later checking.\n\nIt is common practice to have tests in separate file, but that is possible only when the actual code is installed as a python module, not directly in executable. Not sure if worth changing it here, probably not."},{"author":"HulaHoop","date_created":1475071442,"date_modified":1475071442,"content":"Unit test suggestions:\n\nInclude some strings with:\n\n* excessive characters for each parameter - imagine case of adversary injecting a load of rubbish when keyblob is supported\n* invalid port numbers - ports that don't exist\n* a query stress test - bombarding cpfp with a very high volume of valid requests. Does cpfp fail gracefully? How does it cope with a simulated DDoS?"},{"author":"HulaHoop","date_created":1475153094,"date_modified":1475159783,"content":"https://lists.torproject.org/pipermail/tor-dev/2016-September/011477.html\n\nEDIT:\n\nHow to change the number of open files limit in Linux:\n\nhttps://stackoverflow.com/a/923369"},{"author":"Patrick","date_created":1475200303,"date_modified":1475200303,"content":">>! In T448#10484, @HulaHoop wrote:\n> Idea: Every time an ADD_ONION request hits cpfp, it checks the list to see how many ephemeral services are active and if the number exceeds a preconfigured limit, the request is silently dropped (optionally with a generic log message if you think that is useful).\n\nCreated T564 for it.\n\n> If this is implemented successfully you can parse the number of ports provided in an ADD_ONION request and make sure they are not excessive - only 3 or 4 allowed per request and a total of 10 services allowed - 30-40 ports maximum open at any time is not so bad and is more flexible than an arbitrarily fixed port range.\n\nOnly 5 concurrent connections at the same time are allowed:\nhttps://github.com/Whonix/control-port-filter-python/blob/6a131266a8dc8f98ff22a3b83fae9d43e38b3127/usr/sbin/cpfpd#L468-L470\n\nI don't think I'll implement creating multiple virtual ports or multiple target ports in a single add_onion command at this time. Gets too complex.  And there is no incentive since no real world applications are doing this. Let's move add_onion command parsing to T562."},{"author":"Patrick","date_created":1475201853,"date_modified":1475201853,"content":">>! In T448#10490, @HulaHoop wrote:\n> Unit test suggestions:\n> \n> Include some strings with:\n> \n> * excessive characters for each parameter - imagine case of adversary injecting a load of rubbish when keyblob is supported\n\nExcessively long inputs are already rejected earlier than parsing add_onion.\n\nhttps://github.com/Whonix/control-port-filter-python/blob/6a131266a8dc8f98ff22a3b83fae9d43e38b3127/usr/sbin/cpfpd#L272\n\n`KeyBlob` won't be supported soon since no real world applications are using it. Also probably neither `ClientName` / `ClientBlob` will be supported. But I added a comment so we not forget to impose maximum string lengths for them if/when it gets implemented.\n\n> * invalid port numbers - ports that don't exist\n\nGood idea. Added to T562.\n\n> * a query stress test - bombarding cpfp with a very high volume of valid requests. Does cpfp fail gracefully? How does it cope with a simulated DDoS?\n\nCreated T565 for it."},{"author":"Patrick","date_created":1475202077,"date_modified":1475202077,"content":"The original todo of this was implemented. Loosing overview, and forgetting stuff. Therefore reorganization. For all remaining, actually off-topic issues, new tickets have been created.\n\n* T561\n* T562\n* T563\n* T564\n* T565\n* T566\n"}]},"PHID-TASK-5n7xgzlyifnnkc7kf6zp":{"id":"447","title":"document torified dom0 and any TemplateVM upgrades","status":"resolved","priority":"Normal","author":"Patrick","description":"I was going to create a page https://www.whonix.org/wiki/Qubes/Torify_dom0_Upgrades. But not sure.\n\n`dom0` is going to be renamed to `admin`. (https://github.com/QubesOS/qubes-issues/issues/1382)\n\nBut `Torify admin Upgrades`, https://www.whonix.org/wiki/Qubes/Torify_admin_Upgrades as title sounds strange?\n\nThe documentation is basically ready. Just one simple small chapter that waits to be moved to a proper place:\nhttps://www.whonix.org/wiki/Next#Torified_dom0_Updates\n\nAlso any TemplateVM, StandaloneVM, ... can be upgraded through sys-whonix. That should be documented also.\n\nShould that be added here https://www.whonix.org/wiki/Qubes/Update?\n\nBasically, I am just looking for title suggestions. And where to put the instructions.","comments":[{"author":"Patrick","date_created":1452276350,"date_modified":1452276350,"content":"Done:\nhttps://github.com/QubesOS/qubes-doc/pull/86\n\nThanks to @bnvk for suggesting where to add this."},{"author":"Patrick","date_created":1460950202,"date_modified":1460950202,"content":"On https://www.qubes-os.org/doc/software-update-dom0/ there is now a chapter \"Upgrading over Tor\"."}]},"PHID-TASK-p6abrrzk7pgekzkzulfq":{"id":"446","title":"research control port filter proxy whiltelist wildcard security implications","status":"resolved","priority":"Normal","author":"Patrick","description":"We now have control port filter proxy whiltelist wildcard support. (T445)\n\n(Variable `CONTROL_PORT_FILTER_ALLOW_WILDCARDS`. It's disabled by default, but by the time it gets enabled for example by users on onionshare or ricochet, we need to know about the security implications.)\n\nThis ticket is for researching the security implications.\n\nIf we whilte listed the wildcard `add_onion *`, we don't want it to match some hypothetical feature `add_onion * ; ...`. I.e. not `add_onion * ; GETINFO address`.\n\nTo be researched, if Tor's control protocol actually supports something like `;`. If it does, then this would complicate the wildcard feature.\n\n(If it was the case, then we would have to limit the wildcard (`*`) from example `SETCONF HiddenServicePort *` to exactly one [numeric] argument etc. Or better, correctly parse multi lined commands.)\n\nTor Control Protocol description:\nhttps://gitweb.torproject.org/torspec.git/tree/control-spec.txt","comments":[{"author":"HulaHoop","date_created":1449347506,"date_modified":1449347506,"content":"I don't think we should ever add a wildcard feature it seems very risky. Even if there are no dangerous Tor HS commands now this may change in the future. The point of a whitelist was to prevent the problem of unforeseen extensions to the protocol having negative security implications.\n\nThe safest option is to hardcode the ports needed by any Tor based software we want to support and to only enable this subset of the whitelist when a user explicitly switches on a boolean on the Gateway.\n\n"},{"author":"Patrick","date_created":1449407410,"date_modified":1449407410,"content":"No wildcard feature would almost equal a wontfix for Ricochet (T444), onionshare, and potentially other software (bitcoin, globaleaks, securedrop).\n\nIt's not just about the port number. That would be too simple.\n\nSee https://gitweb.torproject.org/torspec.git/tree/control-spec.txt and have a look at the syntax of the `ADD_ONION` Tor control protocol command. The command will be used by Ricochet / onionshare / etc. to create a Tor hidden service without using the file system. I.e. not using /var/lib/tor on the gateway to store the hidden service key.\n\nExample:\n```\nADD_ONION RSA1024:cryptographic-key-long-blob-of-binary-data Port=80,192.168.1.1:8080\n```\n"},{"author":"HulaHoop","date_created":1449500114,"date_modified":1449500114,"content":"I see. Then as long as wildcards can be safely implemented even if something like `;` is around it should be OK.\n\nWhat about the other point about making this part of the whitelist need activation by the user? The idea is for defense in depth so only some of the users would be affected in the unlikely chance there is something instead of all Whonix installations."},{"author":"Patrick","date_created":1449500618,"date_modified":1449500618,"content":"HulaHoop (HulaHoop):\n> What about the other point about making this part of the whitelist\n> need activation by the user? The idea is for defense in depth so only\n> some of the users would be affected in the unlikely chance there is\n> something instead of all Whonix installations.\n\nYes.\n\n(At time of writing, none of the tickets does argue about allowing\n'add_onion *' by default to make onionshare etc. work out of the box.)\n\nA related point is, if adding a Tor hidden service from a compromised\nWhonix-Workstation (add_onion) raises more risk than a compromised\nWhonix-Workstation without add_onion capability."},{"author":"HulaHoop","date_created":1451586565,"date_modified":1451586594,"content":"After looking at the spec I think the protocol has the ; equivalent CRLF. Carriage Return and Line Feed signifying newline. \\n \\t \\r and \\0 ... \\377 are treated as C escapes (Section 2 is of interest).\n\nAlso relevant is multiline commands support with '+' characters.\n\nI think these could allow combining different commands with negative effects we are trying to block."},{"author":"Patrick","date_created":1451773854,"date_modified":1451773854,"content":"Can you please post examples of multi lined commands?"},{"author":"HulaHoop","date_created":1451835099,"date_modified":1451835099,"content":"The only generic example I can find:\n\n```\nCommand = Keyword OptArguments CRLF / \"+\" Keyword OptArguments CRLF CmdData\n"},{"author":"Patrick","date_created":1451835444,"date_modified":1451835444,"content":"Did you manage to get a non-generic, specific to work? I.e. do you have\nan actually working example?\n\nOnce we have examples for every cases, we can handle those in the code."},{"author":"HulaHoop","date_created":1451862152,"date_modified":1451862180,"content":"The only example I can find in the spec:\n\n\"650\" \"+\" \"HS_DESC_CONTENT\" SP HSAddress SP DescId SP HsDir CRLF Descriptor CRLF \".\" CRLF \"650\" SP \"OK\" CRLF\n\nbut note that the clockskew command uses an escaped +. Understanding the spec is over my head and it would be better to consult TPO directly with these questions and the TAILS guys since they have a shared interest in this."},{"author":"HulaHoop","date_created":1452438582,"date_modified":1452438582,"content":"I tried posting this message to the Tor developer's list yesterday but it was rejected:\n\nControl port filter and wildcards\n\nAt the moment we are implementing support for whitelisting wildcards in the controlport filter to support Onionshare and Ricochet.\n\nDoes Tor's control protocol actually support something like ; ? If it does, then this would complicate the wildcard feature.\n\nIf we whitelisted the wildcard add_onion *, we don't want it to match some hypothetical feature add_onion * ; .... I.e. not add_onion * ; GETINFO address.\n\n(If it was the case, then we would have to limit the wildcard (*) from example SETCONF HiddenServicePort * to exactly one [numeric] argument etc. Or better, correctly parse multi lined commands.)"},{"author":"Patrick","date_created":1452438966,"date_modified":1452438966,"content":"Rejected? Not signed up for the list or rejected by a human list manager? I'll work on an improved version of the draft."},{"author":"Patrick","date_created":1452439666,"date_modified":1452439666,"content":"```\nTor Control Protocol: multiple commands in a single line possible?\n```\n\n```\nTLDR:\nDoes Tor's control protocol actually support something like ; ?\nI.e. something like\nsignal newnym ; getinfo address\n?\nHow many of there separators are there?\nCan you provide examples please?\n\nBackground:\nAt the moment we are implementing support for whitelisting wildcards for control-port-filter-proxy-python [0] to support Onionshare and Ricochet. [1] [2] [3] [4]\n\nDoes Tor's control protocol actually support something like ; ? If it does, then this would complicate the wildcard feature.\n\nIf we whitelisted the wildcard add_onion *, we don't want it to match some hypothetical feature add_onion * ; .... I.e. not add_onion * ; GETINFO address.\n\n(If it was the case, then we would have to limit the wildcard (*) from example SETCONF HiddenServicePort * to exactly one [numeric] argument etc. Or better, correctly parse multi lined commands. Or as stopgap, reject these separators since no applications using Tor's control protocol are currently using those.)\n\n[0] https://github.com/Whonix/control-port-filter-python\nhttps://www.whonix.org/wiki/Dev/Control_Port_Filter_Proxy\n[1] https://phabricator.whonix.org/T446\n[2] https://phabricator.whonix.org/T445\n[3] https://www.whonix.org/wiki/Next#onionshare\n[4] https://phabricator.whonix.org/T448\n```\n"},{"author":"Patrick","date_created":1452445294,"date_modified":1452445294,"content":"Posted on tor-dev:\nhttps://lists.torproject.org/pipermail/tor-dev/2016-January/010158.html"},{"author":"Patrick","date_created":1452448546,"date_modified":1452448546,"content":"Roger said per mail, 'there isn't any \";\" support in the control protocol.'"},{"author":"Patrick","date_created":1452695594,"date_modified":1452695594,"content":"No one else on the mailing list either claimed it supports this."}]},"PHID-TASK-d4nu3ndt576pqgqgcwvx":{"id":"445","title":"CONTROL_PORT_FILTER_WHITELIST wildcard feature","status":"resolved","priority":"Normal","author":"Patrick","description":"onionshare, ricochet, etc. would need something like this.\n\n```\nCONTROL_PORT_FILTER_WHITELIST=PROTOCOLINFO 1,add_onion *,del_onion *\n```\n\nSo it would be nice if we had a wildcard matching feature. So stuff like:\n\n* `add_onion new:best port=80,60132`\n* i.e. `add_onion *:* port=*,*`\n* or `add_onion *`\n* `del_onion ...`\n* `list_onion ...`\n\nAll would be accepted.","comments":[{"author":"HulaHoop","date_created":1449717541,"date_modified":1449717541,"content":"Some interesting projects that are related:\n\nhttps://lists.torproject.org/pipermail/tor-dev/2015-December/010049.html\nhttps://lists.torproject.org/pipermail/tor-dev/2015-December/010051.html"},{"author":"Patrick","date_created":1451500365,"date_modified":1451500365,"content":"troubadour has implemented this.\n\n```\nAdd wildcard support\n\nNew variable CONTROL_PORT_FILTER_ALLOW_WILDCARDS. If set, commands containing\nrandom data (ex hidden service ID:port) are passed if an wildcard alias exists\nin the commands whitelist (ex 'add_onion *')\n```\nhttps://github.com/Whonix/control-port-filter-python/commit/96a8c164e44269c7ffd9e8c715b92a84f3359c59"}]},"PHID-TASK-ve2v3fkrnup65ap7deag":{"id":"444","title":"test if Ricochet IM instructions are functional","status":"invalid","priority":"Normal","author":"HulaHoop","description":"https://www.whonix.org/wiki/Chat#Ricochet_IM\n","comments":[{"author":"HulaHoop","date_created":1459710882,"date_modified":1459710882,"content":"\n\nSome major commits made to Ricochet recently. May affect CPFP whitelist:\n\n*  Allow configuring external Tor in the environment\n\nIf the TOR_CONTROL_PORT environment variable is present, use that\nexternal instance of Tor instead of launching a bundled one.\n\nTOR_CONTROL_HOST and TOR_CONTROL_PASSWD are also available for the\ncontrol hostname and password respectively. These variables match\nthe names used by Tor Browser.\n\nThere is no need to configure the SOCKS address; Ricochet will discover\nit automatically.\n\nhttps://github.com/ricochet-im/ricochet/commit/fe8f24aad1779cc798926d980f55f81b52f71683\n\n\n*    Store identity keys in configuration when possible\n\nFor Tor >= 0.2.7, we can use ADD_ONION to configure hidden services, so\nprivate keys no longer need to be in separate files on disk. When\npossible, stop using those files and store keys only in our\nconfiguration file.\n\nExisting profiles will copy their keys into the configuration file, but\nthe old files will not be removed yet. Older versions of Tor remain\nsupported as well, and will always use the filesystem.\n\nhttps://github.com/ricochet-im/ricochet/commit/f8aeff2f62ed6248e1fa997d06be4000f73b4d16\n\n\n*    Use the ADD_ONION command when Tor is new enough\n\nFor versions of Tor that support it, use ADD_ONION instead of SETCONF to\nconfigure hidden services.\n\nhttps://github.com/ricochet-im/ricochet/commit/f38b266e5e266d9928e0cdafa53edba5e9b93a36\n\n\n*  Allow HiddenService to configure ephemeral services\n\nRefactored the HiddenService class API to handle services that have no\nfilesystem representation.\n\nhttps://github.com/ricochet-im/ricochet/commit/4e2a97d0a3107f1b13199fe6e6685893afc474bd"},{"author":"HulaHoop","date_created":1465076822,"date_modified":1465076862,"content":"> There is a ricochet-im package in debian repos for testing and unstable now: https://packages.debian.org/search?keywords=ricochet-im&searchon=names&suite=all&section=all\n\nhttps://github.com/ricochet-im/ricochet/issues/415#issuecomment-220178419"},{"author":"Patrick","date_created":1484071355,"date_modified":1484071355,"content":"Got it working for a while, but now having issues. Either firewall issues or issue due to mixing jessie / stretch packages.\n\n- https://github.com/Whonix/control-port-filter-python/commit/611c974a9f349ad4a136a2baf479e86276690eca\n- https://github.com/Whonix/control-port-filter-python/commit/c7231b54fe0a17cad68342a8385eb2035bea61d3\n- https://github.com/Whonix/control-port-filter-python/blob/master/usr/share/tor-controlport-filter/examples/40_ricochet.yml\n- https://github.com/Whonix/whonix-ws-firewall/commit/389b4894773bd959c5f98e5fdadc2f9b0753abfa\n- https://github.com/Whonix/uwt/commit/2a516b92849f3dd55c0d5cec6a01510f13268c33\n- https://github.com/Whonix/uwt/commit/20f9e00db8f8ad9ace67b8aa4626f90b2e9bd9a7\n- https://www.whonix.org/wiki/Next#ricochet\n\n----\n\nProblem is, ricochet picks a random high local port so we actually have to open all incoming workstation ports. Posted a feature request upstream:\nhttps://github.com/ricochet-im/ricochet/issues/30#issuecomment-271646818\n"},{"author":"Patrick","date_created":1484086251,"date_modified":1484086251,"content":"Works."},{"author":"Patrick","date_created":1484631624,"date_modified":1484631624,"content":"TODO:\n\n* answer https://github.com/ricochet-im/ricochet/issues/30#issuecomment-272745183"},{"author":"Patrick","date_created":1486077170,"date_modified":1486077170,"content":"Answered:\nhttps://github.com/ricochet-im/ricochet/issues/512#issuecomment-277114411\n"},{"author":"Tibo","date_created":1524173896,"date_modified":1524173896,"content":"I got Ricochet properly working.\nI had some troubles with onion-grater which filtered commands needed by Ricochet.\nEven with the config file provided in example :\n https://github.com/Whonix/onion-grater/blob/master/usr/share/onion-grater-merger/examples/40_ricochet.yml\n\nSo I used --complain option to allow all commands.\nI'm going to look how onion grater works and make a config file.\nI will update this task soon.\n\n"},{"author":"Tibo","date_created":1524516742,"date_modified":1524516742,"content":"So here are all the steps to make ricochet working :\n\nOpen Ricochet and close it (it will create all the config files and folders).\nThen edit :   **$HOME/.local/share/Ricochet/ricochet.anondist-orig/ricochet.json** :\n```\n{\n    \"identity\": {\n        \"dataDirectory\": \"data-0\",\n        \"localListenAddress\": \"10.152.152.11\",\n        \"localListenPort\": 12345\n    },\n    \"tor\": {\n        \"controlAddress\": \"127.0.0.1\",\n        \"controlPort\": 9151,\n        \"socksAddress\": \"127.0.0.1\",\n        \"socksPort\": 9050\n    },\n    \"ui\": {\n        \"combinedChatWindow\": true,\n        \"language\": \"\",\n        \"notificationVolume\": 0.75\n    }\n}\n```\nDon't forget to open the port 12345 on the workstation firewall.\n\nOn the gateway create the file **/usr/local/etc/onion-grater-merger.d/40_ricochet.yml**\n\n\n```\n---\n- exe-paths:\n    - '*'\n  users:\n    - '*'\n  hosts:\n    - '*'\n  commands:\n    GETINFO:\n      - pattern: 'status/circuit-established status/bootstrap-phase'\n        response:\n        - pattern:     '250-status/circuit-established=*'\n          replacement: '250-status/bootstrap-phase=NOTICE BOOTSTRAP PROGRESS=100 TAG=done SUMMARY=\"Done\"'\n    GETCONF:\n      - 'DisableNetwork'\n    ADD_ONION:\n      - pattern:     'NEW:(\\S+) Port=12345,\\S+:(\\S+)'\n        replacement: 'NEW:{} Port=12345,{client-address}:{}'\n      - pattern:     '(\\S+):(\\S+) Port=12345,\\S+:(\\S+)'\n        replacement: '{}:{} Port=12345,{client-address}:{}'\n    DEL_ONION:\n      - '.+'\n  events:\n    STATUS_CLIENT:\n      suppress: true\n```\nEdit torrc and create a new onion service :\n```\nHiddenServiceDir /var/lib/tor/ricochet/\nHiddenServicePort 12345 10.152.152.11:12345\nDisableNetwork 1\n```\n\nrestart onion-grater and tor.\nRicochet should work now.\n\nWhat's after :) ?\n"},{"author":"Patrick","date_created":1524558523,"date_modified":1524558523,"content":"Tibo (Tibo):\n> Tibo added a comment.\n> \n> \n> So here are all the steps to make ricochet working :\n> \n> Open Ricochet and close it (it will create all the config files and folders).\n> Then edit : *$HOME/.local/share/Ricochet/ricochet.anondist-orig/ricochet.json* :\n> \n> {\n>      \"identity\": {\n>          \"dataDirectory\": \"data-0\",\n>          \"localListenAddress\": \"10.152.152.11\",\n>          \"localListenPort\": 12345\n>      },\n>      \"tor\": {\n>          \"controlAddress\": \"127.0.0.1\",\n>          \"controlPort\": 9151,\n>          \"socksAddress\": \"127.0.0.1\",\n>          \"socksPort\": 9050\n>      },\n>      \"ui\": {\n>          \"combinedChatWindow\": true,\n>          \"language\": \"\",\n>          \"notificationVolume\": 0.75\n>      }\n> }\n\nProbably a manual config is required because otherwise\nlocalListenAddress is set to localhost.\n\nManual config is not how it is supposed to work. It worked before. This\nmeans there could be a bug in #uwt and/or #bindp.\n\n- https://github.com/Whonix/uwt/blob/master/usr/lib/uwtwrapper (see\nreferences to `bindp`)\n- https://github.com/Whonix/uwt/blob/master/usr/bin/ricochet.anondist\n- https://github.com/Whonix/bindp\n\n> Don't forget to open the port 12345 on the workstation firewall.\n> \n> On the gateway create the file \n> */usr/local/etc/onion-grater-merger.d/40_ricochet.yml*\n> \n> ---\n> - exe-paths:\n>      - '*'\n>    users:\n>      - '*'\n>    hosts:\n>      - '*'\n>    commands:\n>      GETINFO:\n>        - pattern: 'status/circuit-established status/bootstrap-phase'\n>          response:\n>          - pattern:     '250-status/circuit-established=*'\n>            replacement: '250-status/bootstrap-phase=NOTICE BOOTSTRAP PROGRESS=100 TAG=done SUMMARY=\"Done\"'\n>      GETCONF:\n>        - 'DisableNetwork'\n>      ADD_ONION:\n>        - pattern:     'NEW:(\\S+) Port=12345,\\S+:(\\S+)'\n>          replacement: 'NEW:{} Port=12345,{client-address}:{}'\n>        - pattern:     '(\\S+):(\\S+) Port=12345,\\S+:(\\S+)'\n>          replacement: '{}:{} Port=12345,{client-address}:{}'\n>      DEL_ONION:\n>        - '.+'\n>    events:\n>      STATUS_CLIENT:\n>        suppress: true\n\n\n> Edit torrc and create a new onion service :\n> \n> HiddenServiceDir /var/lib/tor/ricochet/\n> HiddenServicePort 12345 10.152.152.11:12345\n> DisableNetwork 1\n\nThat should not be required because the onion service is supposed to be\nan ephermal Tor onion services created by ricochet which is using Tor\ncontrol protocol `ADD_ONION` to do it (which then is actually talking to\n#onion-grater).\n\n> What's after :) ?\n\nIf you can fix this one, please fix this one."},{"author":"Tibo","date_created":1524697851,"date_modified":1524697851,"content":"Oh, my bad...\n\n\n> Probably a manual config is required because otherwise\n> localListenAddress is set to localhost.\n> \n> Manual config is not how it is supposed to work. It worked before\n\nYes exactly, and also to set the localListenPort.\nSorry if my question is stupid but, is there a reason to use bindp instead of providing the configuration file ? \n\nI notice that when i'm using bindp :\n\n```\nBIND_PORT=12345 BIND_ADDR=\"10.152.152.11\" LD_PRELOAD=/usr/lib/libindp.so ricochet\n\n```\nI don't see the ADD_ONION command on onion-grater logs and ricochet doesn't work.\n\n```\n 10.152.152.11:53654 (filter: 30_autogenerated): -> PROTOCOLINFO 1\n 10.152.152.11:53654 (filter: 30_autogenerated): <- 250-PROTOCOLINFO 1\n 10.152.152.11:53654 (filter: 30_autogenerated): <- 250-AUTH METHODS=NULL\n 10.152.152.11:53654 (filter: 30_autogenerated): <- 250-VERSION Tor=\"0.3.2.10 (git-0edaa32732ec8930)\"\n 10.152.152.11:53654 (filter: 30_autogenerated): <- 250 OK\n 10.152.152.11:53654 (filter: 30_autogenerated): -> AUTHENTICATE\n 10.152.152.11:53654 (filter: 30_autogenerated): <- 250 OK\n 10.152.152.11:53654 (filter: 30_autogenerated): -> GETCONF DisableNetwork\n 10.152.152.11:53654 (filter: 30_autogenerated): <- 250 DisableNetwork=0\n 10.152.152.11:53654 (filter: 30_autogenerated): -> SETEVENTS STATUS_CLIENT\n 10.152.152.11:53654 (filter: 30_autogenerated): subscribed to event 'STATUS_CLIENT'\n 10.152.152.11:53654 (filter: 30_autogenerated): <- 250 OK\n 10.152.152.11:53654 (filter: 30_autogenerated): -> GETINFO status/circuit-established status/bootstrap-phase net/listeners/socks\n 10.152.152.11:53654 (filter: 30_autogenerated): rewrote response:\n     250-status/circuit-established=1\n     250-status/bootstrap-phase=NOTICE BOOTSTRAP PROGRESS=100 TAG=done SUMMARY=\"Done\"\n     250-net/listeners/socks=\"127.0.0.1:9050\" \"10.152.152.10:9050\" \"10.152.152.10:9100\" \"10.152.152.10:9101\" \"10.152.152.10:9102\" \"10.152.152.10:9103\" \"10.152.152.10:9104\" \"10.152.152.10:9105\" \"10.152.152.10:9106\" \"10.152.152.10:9107\" \"10.152.152.10:9108\" \"10.152.152.10:9109\" \"10.152.152.10:9110\" \"10.152.152.10:9111\" \"10.152.152.10:9112\" \"10.152.152.10:9113\" \"10.152.152.10:9114\" \"10.152.152.10:9115\" \"10.152.152.10:9116\" \"10.152.152.10:9117\" \"10.152.152.10:9118\" \"10.152.152.10:9119\" \"10.152.152.10:9120\" \"10.152.152.10:9121\" \"10.152.152.10:9122\" \"10.152.152.10:9123\" \"10.152.152.10:9124\" \"10.152.152.10:9125\" \"10.152.152.10:9150\" \"10.152.152.10:9152\" \"10.152.152.10:9153\" \"10.152.152.10:9154\" \"10.152.152.10:9155\" \"10.152.152.10:9156\" \"10.152.152.10:9157\" \"10.152.152.10:9158\" \"10.152.152.10:9159\" \"10.152.152.10:9160\" \"10.152.152.10:9161\" \"10.152.152.10:9162\" \"10.152.152.10:9163\" \"10.152.152.10:9164\" \"10.152.152.10:9165\" \"10.152.152.10:9166\" \"10.152.152.10:9167\" \"10.152.152.10:9168\" \"10.152.152.10:9169\" \"10.152.152.10:9170\" \"10.152.152.10:9171\" \"10.152.152.10:9172\" \"10.152.152.10:9173\" \"10.152.152.10:9174\" \"10.152.152.10:9175\" \"10.152.152.10:9176\" \"10.152.152.10:9177\" \"10.152.152.10:9178\" \"10.152.152.10:9179\" \"10.152.152.10:9180\" \"10.152.152.10:9181\" \"10.152.152.10:9182\" \"10.152.152.10:9183\" \"10.152.152.10:9184\" \"10.152.152.10:9185\" \"10.152.152.10:9186\" \"10.152.152.10:9187\" \"10.152.152.10:9188\" \"10.152.152.10:9189\" \"127.0.0.1:9100\" \"127.0.0.1:9101\" \"127.0.0.1:9102\" \"127.0.0.1:9103\" \"127.0.0.1:9104\" \"127.0.0.1:9105\" \"127.0.0.1:9106\" \"127.0.0.1:9107\" \"127.0.0.1:9108\" \"127.0.0.1:9109\" \"127.0.0.1:9110\" \"127.0.0.1:9111\" \"127.0.0.1:9112\" \"127.0.0.1:9113\" \"127.0.0.1:9114\" \"127.0.0.1:9115\" \"127.0.0.1:9116\" \"127.0.0.1:9117\" \"127.0.0.1:9118\" \"127.0.0.1:9119\" \"127.0.0.1:9120\" \"127.0.0.1:9121\" \"127.0.0.1:9122\" \"127.0.0.1:9123\" \"127.0.0.1:9124\" \"127.0.0.1:9125\" \"127.0.0.1:9150\" \"unix:/var/run/tor/socks\"\n     250 OK\n to:\n     250-status/circuit-established=1\n     250-status/bootstrap-phase=NOTICE BOOTSTRAP PROGRESS=100 TAG=done SUMMARY=\"Done\"\n     250-net/listeners/socks=\"127.0.0.1:9150\"\n     250 OK\n 10.152.152.11:53654 (filter: 30_autogenerated): <- (multi-line)\n     250-status/circuit-established=1\n     250-status/bootstrap-phase=NOTICE BOOTSTRAP PROGRESS=100 TAG=done SUMMARY=\"Done\"\n     250-net/listeners/socks=\"127.0.0.1:9150\"\n     250 OK\n```\n\nHowever when I'm using the manual config to set the listening port and address I see the ADD_ONION command, and ricochet works:\n```\n10.152.152.11:53658 (filter: 30_autogenerated): -> PROTOCOLINFO 1\n10.152.152.11:53658 (filter: 30_autogenerated): <- 250-PROTOCOLINFO 1\n10.152.152.11:53658 (filter: 30_autogenerated): <- 250-AUTH METHODS=NULL\n10.152.152.11:53658 (filter: 30_autogenerated): <- 250-VERSION Tor=\"0.3.2.10 (git-0edaa32732ec8930)\"\n10.152.152.11:53658 (filter: 30_autogenerated): <- 250 OK\n10.152.152.11:53658 (filter: 30_autogenerated): -> AUTHENTICATE\n10.152.152.11:53658 (filter: 30_autogenerated): <- 250 OK\n 10.152.152.11:53658 (filter: 30_autogenerated): -> GETCONF DisableNetwork\n 10.152.152.11:53658 (filter: 30_autogenerated): <- 250 DisableNetwork=0\n 10.152.152.11:53658 (filter: 30_autogenerated): -> SETEVENTS STATUS_CLIENT\n 10.152.152.11:53658 (filter: 30_autogenerated): subscribed to event 'STATUS_CLIENT'\n 10.152.152.11:53658 (filter: 30_autogenerated): <- 250 OK\n 10.152.152.11:53658 (filter: 30_autogenerated): -> GETINFO status/circuit-established status/bootstrap-phase\n 10.152.152.11:53658 (filter: 30_autogenerated): <- (multi-line)\n     250-status/circuit-established=1\n     250-status/bootstrap-phase=NOTICE BOOTSTRAP PROGRESS=100 TAG=done SUMMARY=\"Done\"\n     250 OK\n 10.152.152.11:53658 (filter: 30_autogenerated): -> ADD_ONION NEW:RSA1024 Port=9878,10.152.152.11:12345\n 10.152.152.11:53658 (filter: 30_autogenerated): <- (multi-line)\n     250-ServiceID=qnt5ga7x3ik3oucj\n     250-PrivateKey=RSA1024:****\n     250 OK\n\n```"},{"author":"Patrick","date_created":1524726577,"date_modified":1524726577,"content":"Tibo (Tibo):\n> Tibo added a comment.\n> \n> \n> Oh, my bad...\n> \n>     Probably a manual config is required because otherwise\n>     localListenAddress is set to localhost.\n> \n>     Manual config is not how it is supposed to work. It worked before\n> \n> Yes exactly, and also to set the localListenPort.\n\nThat is also supposed to be automatic.\n\nWhatever ricochet chooses should work due to `EXTERNAL_OPEN_ALL=true`.\nSo uwt / bindp does not have to set BIND_PORT.\n\n> Sorry if my question is stupid but, is there a reason to use bindp instead of \n> providing the configuration file ?\n\nUsability. Much shorter and easier instructions.\n\n\"Just start the application\" vs \"follow all of this\".\n\n> I notice that when i'm using bindp :\n> \n> BIND_PORT=12345 BIND_ADDR=\"10.152.152.11\" LD_PRELOAD=/usr/lib/libindp.so ricochet\n\n(This is good for testing however later needs to be done by uwt.)\n\nhttps://github.com/Whonix/uwt/blob/master/usr/lib/uwtwrapper did not use\nBIND_PORT. So probably doesn't have to be invented.\n\nWhat command uwtwrapper is actually executing to run bindp / ricochet?\nDoes that look sensible?"},{"author":"Tibo","date_created":1524730441,"date_modified":1524746206,"content":"I think I misunderstood something.\nI thought that the goal was to not use EXTERNAL_OPEN_ALL=true and just open one port on the workstation firewall.\n\nI also thought that we could create the file `$HOME/.local/share/Ricochet/ricochet.anondist-orig/ricochet.json` with the config inside.\nExactly like the VLC config file I worked on.\nSo ricochet will be ready to use and the user will just have to open it."},{"author":"Patrick","date_created":1524760166,"date_modified":1524760166,"content":"Tibo (Tibo):\n> Tibo added a comment.\n> \n> \n> I think I misunderstood something.\n\nYes.\n\n> I thought that the goal was to not use EXTERNAL_OPEN_ALL=true and just open one \n> port on the workstation firewall.\n\nHow did you get that idea?\n\n`EXTERNAL_OPEN_ALL=true` is uncool indeed but at least instructions are\nsimple.\n\nThis ticket is in status \"needs review\". Meaning, implementation is\ndone, but should be tested in next build.\n\nThis status is confusing and for ticket changes we'll be using\n`testing-in-next-build-required` as status.\n\n> This ticket is in status \"needs review\". Meaning, implementation is\ndone, but should be tested in next build.\n\nSo the only remaining work here before you started working on this\nticket was:\nDo the instructions in the wiki work as is? If yes, the ticket is done.\n\nSorry for the confusion!\n\n> I also thought that we can create the file \n> $HOME/.local/share/Ricochet/ricochet.anondist-orig/ricochet.json with the config \n> inside.\n> Exactly like the VLC config file I worked on.\n> So ricochet will be ready to use and the user will just have to open it.\n\nI see.\n\nHowever, then one still would have to modify Whonix-Gateway to create\nthe onion service. Resulting in ricochet in Whonix being more difficult\nto set up than outside of Whonix. And very most users are deterred and\nconfused by a lot easier things already."},{"author":"Tibo","date_created":1524770378,"date_modified":1524770943,"content":"\n>\n> This ticket is in status \"needs review\". Meaning, implementation is\n> done, but should be tested in next build.\n> \n> This status is confusing and for ticket changes we'll be using\n> testing-in-next-build-required as status.\n> \n> This ticket is in status \"needs review\". Meaning, implementation is\n> \n> done, but should be tested in next build.\n> \n> So the only remaining work here before you started working on this\n> ticket was:\n> Do the instructions in the wiki work as is? If yes, the ticket is done.\n\nThank you for the explanation ! It's now much clearer.\n\n>> I thought that the goal was to not use EXTERNAL_OPEN_ALL=true and just open one \n>> port on the workstation firewall.\n> \n> How did you get that idea?\n> \n> EXTERNAL_OPEN_ALL=true is uncool indeed but at least instructions are\n> simple.\n> \n\nI got this idea with  : \n\n> Problem is, ricochet picks a random high local port so we actually have to open all incoming workstation ports. Posted a feature request upstream:\n> https://github.com/ricochet-im/ricochet/issues/30#issuecomment-271646818\n\n> It's also useful so users don't have to open all incoming ports in Whonix-Workstation firewall\n\n\nBut let's start with the beginning :\nI followed the instructions in the wiki, and it's almost working.\nThe only thing missing is to set environment variable `TOR_CONTROL_PORT=9151` and `TOR_CONTROL_HOST=\"127.0.0.1\"`.\nThat's all :).\n\n\n\n\n\n"},{"author":"Patrick","date_created":1525075032,"date_modified":1525075032,"content":">>! In T444#15959, @Tibo wrote:\n> The only thing missing is to set environment variable `TOR_CONTROL_PORT=9151` and `TOR_CONTROL_HOST=\"127.0.0.1\"`.\n> That's all :).\n\nHm. Good catch.\n\nAny idea why that is required?\n\n* `TOR_CONTROL_HOST=\"127.0.0.1\"`: Shouldn't that be the default anyhow? Really doesn't work without it?\n\n* `TOR_CONTROL_PORT=9151`: What does ricochet use by default? Port `9051`? But that should work?\n\nCould be a bug in #anon-ws-disable-stacked-tor Tor emulation.\n\nWe used to set these variables.\n\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/usr/lib/anon-ws-disable-stacked-tor/torbrowser.sh\n\nBut not anymore. Goals:\n\n* stick with the defaults as much as possible to cause as little as breakage as possible\n* maximum compatibility\n* Tor emulation on Whonix-Workstation so most applications are working\n* as few unneeded environment variables as possible\n* not confuse Tor Browser with global environment variables (uses IPC and in future only IPC. Other environment variables could leak to some bug which makes it fail to connect in future.)\n\nYou think this can be fixed in #anon-ws-disable-stacked-tor Tor emulation without setting a global environment variable?"},{"author":"Tibo","date_created":1525111027,"date_modified":1525111027,"content":"> Any idea why that is required?\n\nYes, ricochet is looking if a control port is defined in the config file or in the environment.\nIf a control port is defined, ricochet will not launch tor and will directly connect to the control host.\n\n> You think this can be fixed in anon-ws-disable-stacked-tor Tor emulation without setting a global environment variable?\nYes by creating the file `etc/skel/.local/share/Ricochet/ricochet.anondist-orig/ricochet.json` in `anon-ws-disable-stacked-tor` and specifying the control port inside it.\n\nAnother simple solution could be to edit the menu entry of ricochet to run it in a modified environment, which will not affect the global environment and not cause any breakage:\n`env TOR_CONTROL_PORT=9151 TOR_CONTROL_HOST=\"127.0.0.1\" ricochet`\n\nAt this point I don't know what is the best solution.\nWhat do you think ?\n"},{"author":"Patrick","date_created":1525170194,"date_modified":1525170194,"content":"Tibo (Tibo):\n> Tibo added a comment.\n> \n> \n>     Any idea why that is required?\n> \n> Yes, ricochet is looking if a control port is defined in the config file or in \n> the environment.\n> If a control port is defined, ricochet will not launch tor and will directly \n> connect to the control host.\n\nI see. So without these variables set, ricochet tries to to start its\nown Tor client?\n\nIs that startup prevented? (That is a goal of #anon-ws-disable-stacked-tor.)\n\nAnd if it fails to start its own Tor client, ricochet will terminate? Or\nnot try to use any connections?\n\nI guess the upstream bug in ricochet here is: \"ricochet ignores\n...IPC... variables\".\n\n>     You think this can be fixed in anon-ws-disable-stacked-tor Tor emulation\n>     without setting a global environment variable?\n> \n> Yes by creating the file \n> etc/skel/.local/share/Ricochet/ricochet.anondist-orig/ricochet.json in \n> anon-ws-disable-stacked-tor and specifying the control port inside it.\n\n(That would go into anon-apps-config package.)\n\nI see. I want to avoid configs in home folders. These are a rabbit hole.\n\n- works for new builds\n- does not work for users who upgraded from earlier versions (unless we\ninvent a mechanism that might break)\n- hard to update in future (distribution changes vs upstream config changes)\n\n> Another simple solution could be to edit the menu entry of ricochet to run it in \n> a modified environment, which will not affect the global environment and not \n> cause any breakage:\n> env TOR_CONTROL_PORT=9151 TOR_CONTROL_HOST=\"127.0.0.1\" ricochet\n\nhttps://github.com/Whonix/uwt/blob/master/usr/bin/ricochet.anondist\n\nAdd on top of `export uwtwrapper_parent=\"${BASH_SOURCE[0]}\"`\n\n```\nTOR_CONTROL_PORT=\"9151\"\nTOR_CONTROL_HOST=\"127.0.0.1\"\nexport TOR_CONTROL_PORT\nexport TOR_CONTROL_HOST\n```\n\nI think that place would be better. Then we don't need to\nconfig-package-dev displace another file and it also works from command\nline.\n\n(Working from start menu vs not working from command line would be\nanother strange bug that we would introduce by modifying the launcher.\nAlso then we'll easily miss out on upstream launcher code changes.)"},{"author":"Tibo","date_created":1525643690,"date_modified":1525643690,"content":"> I see. So without these variables set, ricochet tries to to start its\n> own Tor client?\nYes exactly !\n\n> Is that startup prevented? (That is a goal of anon-ws-disable-stacked-tor.)\nYes it is.\n\n> And if it fails to start its own Tor client, ricochet will terminate? Or\n> not try to use any connections?\n\nRicochet will print this error message and terminate  :\n{F8429521}\n\n\n\n> Add on top of export uwtwrapper_parent=\"${BASH_SOURCE[0]}\"\n> TOR_CONTROL_PORT=\"9151\"\n> TOR_CONTROL_HOST=\"127.0.0.1\"\n> export TOR_CONTROL_PORT\n> export TOR_CONTROL_HOST\n> I think that place would be better. Then we don't need to\n> config-package-dev displace another file and it also works from command\n> line.\n\nOkay :), should I make a pull request ?\nSorry that it took so much for such a simply thing."},{"author":"Patrick","date_created":1525669252,"date_modified":1525669252,"content":"Yes, please."},{"author":"Patrick","date_created":1525859329,"date_modified":1525859329,"content":"https://github.com/Whonix/uwt/commit/907f8e1ee93a0ec47febecce3e86266c681764fa"},{"author":"Patrick","date_created":1532425633,"date_modified":1532425633,"content":"There are up to date Whonix 14 testers versions available.\n\n* https://www.whonix.org/wiki/VirtualBox_Testers_Only_Version\n* https://www.whonix.org/wiki/Qubes/Install/Testing\n\nCould you test if ricochet works in these please? @Tibo"},{"author":"Patrick","date_created":1573007604,"date_modified":1573007604,"content":"https://www.whonix.org/wiki/Chat#Ricochet_IM"}]},"PHID-TASK-psv32cdt6qlqo2pjt4pp":{"id":"443","title":"Switching Whonix Website to Let's Encrypt SSL","status":"resolved","priority":"Normal","author":"HulaHoop","description":"The EEF's Let's Encrypt initiative is out of beta. They provide free SSL certs recognized across all major browsers. They are a trusted replacement for current CAs. \n\nI'm thinking Whonix website and mirror can benefit from the switch:\n\nhttps://letsencrypt.org/\n\nhttps://en.wikipedia.org/wiki/Let%27s_Encrypt","comments":[{"author":"fortasse","date_created":1449293351,"date_modified":1449293351,"content":"This is on my radar as well. I don't really want to replace our current certs without reason, but I will definitely look at LE when it comes time to renew."},{"author":"fortasse","date_created":1462125227,"date_modified":1462125227,"content":"This is now implemented! :D"},{"author":"fortasse","date_created":1462468449,"date_modified":1462468486,"content":""}]},"PHID-TASK-viegjh47wwndhdz4xpr5":{"id":"442","title":"make Qubes-Whonix-Gateway able to function as UpdateVM out of the box with dnf","status":"open","priority":"Normal","author":"Patrick","description":"dnf has not landed in Debian yet. This ticket may have to wait until #Debian_Stretch.\n\nJust an uwt wrapper is missing, but it's difficult to add one as of now without knowing the path to dnf.\n\nAlternatively, and better, we would we would configure dnf to use Tor socks proxy settings. This is supported by dnf since version 1.1.6. ([source 1](https://github.com/rpm-software-management/dnf/pull/429#issuecomment-230120671) [source 2](http://dnf.readthedocs.io/en/latest/release_notes.html#id4)) Not great since dnf does not support /etc/dnf.conf.d yet. [1]\n\n(Similar to T401.)\n\n-----\n\n[1] upstream feature request: [implement /etc/dnf.conf.d drop-in configuration folder](https://bugzilla.redhat.com/show_bug.cgi?id=1352234)\n\n-----\n\n__deprecated__:\n\n* [dnf doesn't work with SOCKS](https://bugzilla.redhat.com/show_bug.cgi?id=1167025)\n* [The proxy option in dnf.conf doesn't support socks5](https://bugzilla.redhat.com/show_bug.cgi?id=1256587)\n","comments":[{"author":"marmarek","date_created":1449005706,"date_modified":1449005706,"content":"I don't think dnf is needed for UpdateVM. Dom0 is still based on Fedora\n20, and even if it wasn't, you can simply use yum to download the\npackages - RPMs are the same, repository metadata too. Is there any\nparticular problem? Or just following new versions?"},{"author":"Patrick","date_created":1449005909,"date_modified":1449005909,"content":"Only motivation: making sure it does not break in future. Just following\nnew versions and new (potential) Qubes developments.\n\nI had the assumption, that in future qubes-dom0-update migth replace yum\nwith dnf. If that was the case, I would want to not break UpdateVM\nfunctionality. But if this isn't the case, then the priority for this\nticket is very low."},{"author":"Patrick","date_created":1467482979,"date_modified":1467482979,"content":"https://github.com/adrelanos/uwt/tree/dnf"},{"author":"Patrick","date_created":1488326541,"date_modified":1488326541,"content":"Debian stretch comes without `dnf`.\n\n* https://packages.debian.org/search?searchon=contents&keywords=dnf&mode=path&suite=testing&arch=any\n* https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=827108#10\n\nRechecking this ticket when later at #debian_version_10_codename_buster etc."}]},"PHID-TASK-mjmskr6okm3qbxfdsxi6":{"id":"441","title":"run cmd graphical user interface [ / service restart graphical user interface ]","status":"open","priority":"Normal","author":"Patrick","description":"The start menu entries for restart Tor, restart Whonix Firewall, and so forth are not looking good. They're opening a terminal window.\n\nA (python) gui would be nicer.\n\n```\nrun-cmd-gui \\\n   --command \"sudo service tor@default reload && sudo service tor@default status\" \\\n   --success-message \"Reloading Tor succeeded.\" \\\n   --failure message \"Reloading Tor failed.\" \\\n   --failure-help \"/path/to/file\"\n```\n\n* Different icons for success and failure (exit non-zero).\n* Have a details button to show the terminal output.\n* Have a help button if it failed which would open a help file.\n* Passive popup only if it succeeded.\n\nIt could be made a standalone package, but for simplicity, let's add it to whonix-setup-wizard.","comments":[{"author":"Patrick","date_created":1448719046,"date_modified":1448719046,"content":"Is this something you would like to work on? @goldstein"}]},"PHID-TASK-khrsuf7uo2lh2exifsla":{"id":"440","title":"set random clock offset for Qubes-Whonix VMs using mgmt to prevent clock correlation attacks","status":"open","priority":"Normal","author":"Patrick","description":"Edit the VM xml and change:\n\n```\n<clock offset='utc'>\n```\n\nto\n\n```\n<clock offset='variable' adjustment='123456' basis='utc'>\n```\n\nThe adjustment attribute takes any arbitrary value of seconds. Pick a random number of seconds from 0 to 900 (15 minute range). Let's see if also negative values are possible. I.e. a random number between + and - 900.\n\nWhy?\npreventing [Clock Correlation Attacks](https://www.whonix.org/wiki/Dev/TimeSync#Clock_Correlation_Attack)\n\nRelated to:\n[make sure Qubes-Whonix has no access to clocksource=xen](https://phabricator.whonix.org/T389) (T389)\n\nRelated Qubes upstream bug:\n[libvirt domain validation error; virsh edit issue](https://github.com/QubesOS/qubes-issues/issues/1430)\n","comments":[{"author":"Patrick","date_created":1458643378,"date_modified":1458643378,"content":"Looks like unsupported by xen. Therefore cannot be implemented.\n\nT389#8142"}]},"PHID-TASK-a64vscppvmc7uuqjy3x5":{"id":"439","title":"feature request clock offset adjustment random value from KVM upstream","status":"resolved","priority":"Normal","author":"Patrick","description":"To stop [clock correlation attacks](https://www.whonix.org/wiki/Dev/TimeSync#Clock_Correlation_Attack) it would be good, if we could automate the advice from advanced security guide, [Spoof the Initial Virtual Hardware Clock Offset](https://www.whonix.org/wiki/Advanced_Security_Guide#Spoof_the_Initial_Virtual_Hardware_Clock_Offset). Currently the offset can only be set to a fixed value, that's why we cannot deploy this setting by default.\n\nTODO:\npost a feature request upstream that allows setting a random value with a configurable minimum, maximum value\n","comments":[{"author":"HulaHoop","date_created":1448494183,"date_modified":1448494183,"content":"Even if the feature exists there are some questions that need to be answered so we introduce something that has real security vs security theater.\n\nHow many bits of randomness does some range of seconds add? How coarse is the clock resolution before the information it provides is no longer useful to an attacker? Depending on the answers a known offset may be enough.\n\nNote that from previous tests the clock always differed from the host's when I checked hwclock's numbers. hwclock in the VM was UTC by the way. Despite the best attempts to keep both clocks synced they always differed. \n\nI am not optimistic about upstream feature requests. They never have an effect. "},{"author":"Patrick","date_created":1448501173,"date_modified":1448501173,"content":"HulaHoop (HulaHoop):\n>   Even if the feature exists there are some questions that need to be answered so we introduce something that has real security vs security theater.\n\nSure.\n\n>   How many bits of randomness does some range of seconds add? How coarse is the clock resolution before the information it provides is no longer useful to an attacker?\n\nGood question. Some speculative thoughts...\n\nIt depends on so many things. For one on adversary capabilities. And on\nhow many clocks are how much slow or fast.\n\nIf the host clock is off by two hours, then I think it's save to\nconclude that adding or removing a 15 minutes offset would not help to\nhave company.\n\nLet's say, there are,\n\n- x people who's clock is 10 second fast.\n- y people who's clock is 60 seconds fast.\n- z people who's clock is 1000 seconds fast.\n\nAnd so forth.\n\nHaving an independent VM clock with a secret offset of plus 30 seconds.\n\nx: measure host: 10\nx: measure VM  : 30\n\ny: measure host: 60\ny: measure VM  : 90\n\nz: measure host: 1000\nz: measure VM  : 1030\n\nx would stand out least.\ny would stand out more.\nz would stand out most.\n\nThis speaks for huge random offsets, so those can obscure host clocks\nthat are off a lot.\n\nOn the gateway the offset may not be too big, otherwise Tor will no\nlonger be able to connect. So sdwdate cannot connect, cannot take over.\nA drift host clock plus too big offset could introduce a Tor\nconnectivity issue where otherwise none would have been.\n\nOn the workstation the offset can be bigger. Not sure how big. One\ncondition is not being that big, so sdwdate would get confused. Requires\nresearch. Another issue with too big offsets could be the system getting\nconfused by it. Messed up logs. Confused server software. Requires\nresearch what else. Perhaps most of this could be prevented with some\nclever systemd dependencies. On the workstation also the offset is more\nimportant, because it is more likely to get compromised.\n\nWe can prevent strange web fingerprints with hugely offset clocks by\nblocking all traffic except sdwdate until sdwdate finished after boot.\nThis was the plan anyhow.\n\nMy hope is explaining clock correlation attacks real well, and having an\nindependent VM clocks becoming the standard, so adversaries won't even\nattempt clock correlation attacks anymore, because there hopefully will\nbe random offsets everywhere.\n\n> Depending on the answers a known offset may be enough.\n\nI don't think a public known offset would work. Because then adversaries\nwould always do a calculation with public known offset removed.\n\n>   Note that from previous tests the clock always differed from the host's when I checked hwclock's numbers. hwclock in the VM was UTC by the way. Despite the best attempts to keep both clocks synced they always differed.\n\nDid you disable boot clock randomization? Not using it will surely mess\nup this test.\n\nDid you try test with non-Whonix, Debian VMs?"},{"author":"HulaHoop","date_created":1448502538,"date_modified":1448502538,"content":"I will update this ticket when I try this. Can you post instructions for disabling biosoffset?\n\nWhile I understand the rationale for offsets for the workstation (on regular hosts whose users don't care about security) I don't see why the gateway should have it too. The gateway doesn't run any leaky applications nor have anything that exposes its view of time. My goal is to have it auto sync clocks with the host upon resume so Tor can connect."},{"author":"Patrick","date_created":1448558303,"date_modified":1448558303,"content":"HulaHoop (HulaHoop):\n>   I will update this ticket when I try this. Can you post instructions for disabling biosoffset?\n\nDisable biosoffset? I don't think there is such as thing, since enabling\nbiosoffset is an optional change. Anyhow...\n\nVirtualBox:\n\nVBoxManage modifyvm <name> --biossystemtimeoffset 0\n\nKVM:\n\nChange\n\n<clock offset='variable' adjustment='123456' basis='utc'>\n\nback to\n\n<clock offset='utc'>\n\nBut you probably meant how to disable other influences on the clock. You\ncan disable bootclockrandomization and sdwdate just like as any other\n[systemd] service. To disable those:\n\nsudo systemctl mask bootclockrandomization\n\nsudo systemctl mask sdwdate\n\nTo re-enable those:\n\nsudo systemctl unmask bootclockrandomization\n\nsudo systemctl unmask sdwdate\n\n>   While I understand the rationale for offsets for the workstation (on regular hosts whose users don't care about security) I don't see why the gateway should have it too. The gateway doesn't run any leaky applications nor have anything that exposes its view of time.\n\nI can understand this, since reading the host clock from within the VM\n(VM's wall clock) would require [root] compromise anyhow. And since a\ncompromised gateway exposes the real external IP anyhow.\n\nHowever, this is useful as defense in depth. When combining\nWhonix-Gateway with further tunnels/gateways behind it, it's best if\neven a compromised Whonix-Gateway would not leak the host's time.\n\nAnother reason is, that on a system that happens to be successfully\nconfigured to prevent any local clock leaks, a compromised\nWhonix-Gateway ideally could not access the host's clock.\n\n> My goal is to have it auto sync clocks with the host upon resume so\nTor can connect.\n\nThat doesn't conflict with clock offsets as long those aren't too big."},{"author":"HulaHoop","date_created":1456863302,"date_modified":1456863302,"content":"Feature request filed:\n\nhttps://www.redhat.com/archives/libvir-list/2016-March/msg00063.html"},{"author":"HulaHoop","date_created":1456938367,"date_modified":1456938367,"content":"The Libvirt developers said that such functionality should not be implemented into the stack itself but is already possible thru scripting. \n\nThe suggested virDomainSetTime API may need guest agent to be installed (which we can't do for security reasons).\n\nAnother idea is to implement a script in a hypothetical whonix-host package that appends some randomly chosen value for the offset in Whonix xml files."},{"author":"HulaHoop","date_created":1473084239,"date_modified":1473084524,"content":"Now that I've disabled rtc timer this is no longer possible. However no accurate timers exist for the guest. Another side effect was that you can't do graceful shutdowns (necessary to remove acpi_pm timer - acpi had to be disabled)."},{"author":"Patrick","date_created":1473084948,"date_modified":1473084948,"content":"The original scope of this ticket (writing the feature request) is done.\nCould you please close this ticket and open a follow up one should there\nbe anything left to do?"}]},"PHID-TASK-j7nrohtjwvow7pmyjrsm":{"id":"438","title":"have Qubes Builder build Whonix packages so build dependencies do not get installed inside the template","status":"wontfix","priority":"Normal","author":"Patrick","description":"Currently #Whonix is mostly #build in #Qubes Builder terms in [04_install_qubes_post.sh](https://github.com/adrelanos/qubes-template-whonix/blob/c4a641c58cf31c92f13a57116937779fdf51e77a/whonix-gateway/04_install_qubes_post.sh). And Whonix is installed using `--target qubes`, which is very similar to `--target root`. (Very similar to physical isolation builds.) This is suboptimal, because therefore currently all the build dependencies get installed inside the chroot/template.\n\nIt would be cleaner and reduce the template size by having Qubes Builder build all Whonix packages.\n\nThere was some related discussion on that in T402.\n\nThis is difficult. [Unsure if @Patrick can implement this.] [For #Whonix_13 .]\n\n-----\n\n??_??_??_??.sh running inside the Debian package building chroot:\n* [1100_prepare-build-machine](https://github.com/Whonix/Whonix/blob/master/build-steps.d/1100_prepare-build-machine)\n* [1200_create-debian-packages](https://github.com/Whonix/Whonix/blob/master/build-steps.d/1200_create-debian-packages)\n\n04_install_qubes_post.sh running inside the Qubes-Whonix chroot:\n* [1700_install-packages](https://github.com/Whonix/Whonix/blob/master/build-steps.d/1700_install-packages)\n* [2300_run-chroot-scripts-post-d](https://github.com/Whonix/Whonix/blob/master/build-steps.d/2300_run-chroot-scripts-post-d)\n","comments":[{"author":"marmarek","date_created":1448375924,"date_modified":1448375924,"content":"Yes, it's probably difficult. I see two sensible ways;\n1. Use `builder-debian`, which means setting `DEBIAN_BUILD_DIRS` in\nMakefile.builder to a list of debian packages (since a Whonix is seen as\na single component - with submodules). And handle all Whonix-specific\nsteps (if any) in `SOURCE_COPY_IN`. If building Whonix packages is just\nlike any other Debian packages - it should be just enough.\n2. Ignore `builder-debian` and create separate builder plugin to just\nbuild Whonix.\n\nThe later probably will be less work (can just call the current build\nscript, then retrieve deb packages), but not sure if that would be a\nbetter solution."},{"author":"marmarek","date_created":1449099855,"date_modified":1449099855,"content":"Actually there is another option - do not do this at all!\nAnd simply use apt repository with binary packages you've built. Then work on getting them build reproducible instead. Since Whonix is based on Debian, and Debian have a lot of progress in reproducible builds, it shouldn't be that hard.\n\nThis, besides solving original problem, will also greatly improve template build time."},{"author":"Patrick","date_created":1449149149,"date_modified":1449149149,"content":"[Whonix's build script currently already does set up an apt repository. A local one. First packages are build, then added to the local Whonix apt repository. Then installed from the local apt repository.]\n\nmarmarek (Marek Marczykowski-Górecki):\n>   Actually there is another option - do not do this at all!\n>   And simply use apt repository with binary packages you've built. Then work on getting them build reproducible instead.\n\nThen the build system would rely on Whonix's official binary and remote apt repository?\n\nThen, if the repository was down, building Whonix would be no longer possible. So I guess the would have to be configurable so someone can point at another, apt repository? Remote one or also local one? Local one by running a local web server?\n\nHm. Even if packages were reproducible, this looks kinda untransparent to me. Builders would have hard time to know which package versions they get. TOCTOU issue. Even if they check before the build, it could change by the time they started the build as the remote repository is not under their control. Trust issues. Until now, it has always been a goal for me, to build every code that was created under the Whonix umbrella, gets build from source code without touching any remote repositories.\n\nEven if packages were reproducible, the build script or builder wouldn't check if they get the right packages. It would only verify the package using the usual apt package verification. To check they are actually using the package version they think they are using, they would have to actually create the packages themselves. [But then, back to root one.] Then have a script that does the comparison.\n\nI was wondering about that. Even if packages were reproducible, it would also require a package verification daemon? A daemon that keeps locally building packages, fetching remote packages over Tor (to prevent sending backdoor infected packages to targeted builders), and comparing them.\n\nWe certainly have a double standard here. Being harsher with Whonix than Debian. Having a higher security standard for building Whonix packages. If you compare how Debian base images are build, we are trusting apt verification only. Building all Debian packages from source code is not even fully developed. And a hard issue. (Source: See this ticket/3k USD bounty. [1]) Also Debian upstream package versions do change. [2] But Whonix isn't a big distribution as Debian that is historically grown that way. If you look closer at Debian build security... Oh well. Who has access to the machines running the build daemons. Last time I checked, some were hosted at some Debian Developers home. However, making this argument is difficult for social, not technical reasons. Debian is a huge distribution and subject to more leniency. If Whonix did it like this, it could result in FUD. And someone could rightly make the argument, that Whonix can with acceptable effort prevent these issues, while that is not so simple for whole Debian.\n\n[1] https://www.bountysource.com/issues/9115540-build-debian-packages-from-source-code\n[2] unless using the frozen http://snapshot.debian.org repository. But then you're also just trusting they keep sending the frozen versions. It's not enforced by version pinning / verification.\n\n"},{"author":"marmarek","date_created":1449186390,"date_modified":1449186390,"content":">   Then the build system would rely on Whonix's official binary and remote apt repository?\n\nBy default - yes. But that shouldn't be a problem to have it\nconfigurable.\n\n>   Hm. Even if packages were reproducible, this looks kinda untransparent to me. Builders would have hard time to know which package versions they get. \n\nYou can specify versions implicitly if that's an issue.\n\n>   Even if packages were reproducible, the build script or builder wouldn't check if they get the right packages. It would only verify the package using the usual apt package verification. To check they are actually using the package version they think they are using, they would have to actually create the packages themselves. [But then, back to root one.] Then have a script that does the comparison.\n\nYes, that would need some additional means to verify the package - not\nonly with apt metadata, but also with some external signature(s).\n\n>   I was wondering about that. Even if packages were reproducible, it would also require a package verification daemon? A daemon that keeps locally building packages, fetching remote packages over Tor (to prevent sending backdoor infected packages to targeted builders), and comparing them.\n\nActually it may be simply enough to compare with others. So is all of\ntrusted builders get the same results, it should be fine. But if any of\nthem got different result, you should investigate that carefully - you\ndon't know which one is bad (even the majority may be wrong here).\n\nOk, lets settle now on building packages locally. But generally I think\nthe idea worth some further discussion (CCC?)."},{"author":"Patrick","date_created":1449186799,"date_modified":1449186799,"content":"Marek, do you know my argument \"just because lots of Debian packages are\nreproducible, it won't mean, that we can get reproducible raw images\nanytime soon\"? [Because they keep care of deterministic package builds\nfor now. Not deterministic installed packages. During installation a lot\nof packages create entropy.]\n\nmarmarek (Marek Marczykowski-Górecki):\n>   But generally I think\n>   the idea worth some further discussion (CCC?).\n\nSure thing. Just made a note."},{"author":"marmarek","date_created":1449187612,"date_modified":1449187612,"content":">   Marek, do you know my argument \"just because lots of Debian packages are\n>   reproducible, it won't mean, that we can get reproducible raw images\n>   anytime soon\"? [Because they keep care of deterministic package builds\n>   for now. Not deterministic installed packages. During installation a lot\n>   of packages create entropy.]\n\nYes, we have the same problem with templates. But in case of Whonix\ninstallation, you don't use any of this as an input."},{"author":"marmarek","date_created":1449232279,"date_modified":1449232279,"content":"Hmm, maybe we can somehow distinguish release builds from user builds?\n1. Release build: made by maintainer(s), so basically you have full control over apt repository. And you are building and uploading (the same) packages there anyway.\n2. User build: made by non-maintainer(s), a way to have some assurance (other than binaries signatures) that the product is really built from that source code.\n\nIn the first case, it's really frustrating that you build the packages twice, including preparation of the whole build environment. Waste of time, especially when building over Tor.\n\nSo maybe we could have two builder modes:\n1. Use network (upstream) apt repository\n2. Use local apt repository\n\nIn the first case, you may skip packages build phase. It should be as small change as possible in template-builder to make sure that the output template will be (functionally) the same. Something like \"WHONIX_APT_REPOSITORY\" settings with either network path or local path.\nSupporting the second case still require integrating Whonix package build into qubes-builder.\n\nBTW Hold on with implementing this. We're considering some rework of package build scripts (both Debian and Fedora) to make it as close to the upstream process as possible. To be able to reuse their code/fixes. This is probably mostly about preparing chroot environment, but needs some research."},{"author":"Patrick","date_created":1461213690,"date_modified":1461213690,"content":"I've commented on building Qubes-Whonix templates with Whonix packages build from source here:\nT498#8823\n\nI guess we don't want this ticket `have Qubes Builder build Whonix packages` anymore. And `no longer install Whonix build dependencies inside Qubes-Whonix templates` has been covered by T461 and T498. Therefore closing as wontfix."}]},"PHID-TASK-xxyt2zmrmrm5i3mjkkcp":{"id":"437","title":"sort out clocksource and wall clock for VirtualBox to prevent Clock Correlation Attack","status":"open","priority":"Normal","author":"Patrick","description":"Clock Correlation Attack:\nhttps://www.whonix.org/wiki/Dev/TimeSync#Clock_Correlation_Attack\n\nSimilar to tickets which are specific to other virtualizers.\n\n* Qubes: T389\n* KVM: T431\n\nThis ticket is for VirtualBox.\n\nPerhaps split this ticket into sorting out clocksource and sorting out wall clock.\n\nA user had issues with the whonixcheck pvclock test:\nhttp://forums.whonix.org/t/recurring-time-error-within-gateway-11-under-virtualbox-5-error-unwanted-pvclock-kvm-clock-tsc-acpi-pm-detected/1671/7\n","comments":[]},"PHID-TASK-fa5q4ekdimjochvru7al":{"id":"436","title":"versioned Depends: tor (>= 0.2.7.3) once based on Debian Stretch","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/anon-gw-anonymizer-config/blob/70b9436b9178e0b8b79b42625ec7ff2886be017b/debian/control#L17-L25\n\n```\n## Workaround: Not using versioned 'Depends:' on 'tor'.\n## Ideally we would depend on 'tor (>= 0.2.7.3)' because we are using,\n## 'KeepAliveIsolateSOCKSAuth' which is not available in earlier versions.\n## It would break the build. Debian jessie only has 'tor' '0.2.5'. Which is\n## the only available repository at anon-gw-anonymizer install time.\n## (1700_install-packages) The Tor Project's deb repository with Tor 0.2.7 is\n## added only afterwards. (2300_run-chroot-scripts-post-d) This workaround can\n## likely be removed once Whonix is based on Debian stretch.\nDepends: anon-shared-helper-scripts, tor, sudo, anon-base-files,\n```\n","comments":[{"author":"Patrick","date_created":1484727619,"date_modified":1484727619,"content":"https://github.com/Whonix/anon-gw-anonymizer-config/commit/13fadb99bade549d356d45c9339b23a3c4831697"}]},"PHID-TASK-gffypuxun4hlt2jrbonv":{"id":"435","title":" enable Transparent Proxy Ports for Whonix-Gateway by default [but not in Whonix-Firewall]","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1448235758,"date_modified":1448235758,"content":"```\nenable Transparent Proxy Ports for Whonix-Gateway by default\n\nTransPort 127.0.0.1:9041\nDnsPort 127.0.0.1:5400\n\nBut still not enable transparent proxying by default in Whonix-Gateway firewall\nsettings. This is required so we can\n'redirect tinyproxy traffic to 127.0.0.1 instead to qubes-netvm-gateway'.\n\nhttps://phabricator.whonix.org/T434\n```\nhttps://github.com/Whonix/anon-gw-anonymizer-config/commit/5d78a39d975a8e586c824c44630c97d2a3a779fa\n"}]},"PHID-TASK-zwxwtuelldm6asf23w45":{"id":"434","title":"redirect tinyproxy traffic to 127.0.0.1 instead to qubes-netvm-gateway","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1448235944,"date_modified":1448235944,"content":"```\nredirect tinyproxy traffic to 127.0.0.1 instead to qubes-netvm-gateway\n\nThis saves one call 'qubesdb-read /qubes-netvm-gateway' and is more robust\nin case of IP changes, hypothetical failure or strange output of that command.\n\nhttps://phabricator.whonix.org/T434\n```\nhttps://github.com/Whonix/whonix-gw-firewall/commit/a6f430d7bc8f8bf47c2eb3e2979fce3d3890d86e\n"}]},"PHID-TASK-rwqhvmfemukyeu74wjkz":{"id":"433","title":"remove/upstream qubes-update-check systemd service Whonix specificness","status":"resolved","priority":"Normal","author":"Patrick","description":"* https://github.com/Whonix/qubes-whonix/blob/master/lib/systemd/system/qubes-update-check.service.d/40_qubes.conf\n* https://github.com/Whonix/qubes-whonix/blob/master/lib/systemd/system/qubes-update-check.timer.d/40_qubes.conf\n\nWhile working on T432, I was wondering...\n\nWhy should the [qubes-update-check.service](https://github.com/marmarek/qubes-core-agent-linux/blob/master/vm-systemd/qubes-update-check.service) work differently in Qubes-Whonix TemplateVMs as opposed to other [Debian] TemplateVMs? (This is still inherited from @nrgaway. Please advice.)\n","comments":[{"author":"Patrick","date_created":1448226032,"date_modified":1448226032,"content":"Since I reworked `qubes-update-check.service` in [Improved upgrade notifications sent to QVMM](https://github.com/marmarek/qubes-core-agent-linux/pull/39), I don't see why this should be required for anything."},{"author":"marmarek","date_created":1448228460,"date_modified":1448228460,"content":"I guest that was about accessing (torified) updates proxy, which should work just fine now. Not sure."},{"author":"Patrick","date_created":1448229020,"date_modified":1448229020,"content":"Removed.\n\nhttps://github.com/Whonix/qubes-whonix/commit/8fb3a6e0fb9e879c8d46fa4525aa2d0821c53959"}]},"PHID-TASK-zmtaguosjtvu3d5un7if":{"id":"432","title":"get rid of /var/run/qubes-service/whonix-... gateway, workstation, template status files","status":"open","priority":"Normal","author":"Patrick","description":"That way we could get rid of [`/lib/systemd/system/qubes-whonix-sysinit.service`](https://github.com/Whonix/qubes-whonix/blob/master/lib/systemd/system/qubes-whonix-sysinit.service) use of `ExecStartPre=` [`/usr/lib/qubes-whonix/init/enable-services`](https://github.com/Whonix/qubes-whonix/blob/master/usr/lib/qubes-whonix/init/enable-services).\n\n\n```\ntb-updater/usr/bin/update-torbrowser:   if [ -e \"/var/run/qubes-service/whonix-template\" ]; then\ntb-updater/usr/bin/update-torbrowser:      if [ -e \"/var/run/qubes-service/whonix-template\" ]; then\nqubes-whonix/lib/systemd/system/qubes-update-check.service.d/40_qubes.conf:ConditionPathExists=!/var/run/qubes-service/whonix-template\nqubes-whonix/lib/systemd/system/qubes-update-check.timer.d/40_qubes.conf:ConditionPathExists=!/var/run/qubes-service/whonix-template\nqubes-whonix/lib/systemd/system/qubes-whonix-sysinit.service:## - /var/run/qubes-service/whonix-template\nqubes-whonix/lib/systemd/system/qubes-whonix-firewall.service:## When running in a TemplateVM (if /var/run/qubes-service/whonix-template exists),\nqubes-whonix/lib/systemd/system/control-port-filter-python.service.d/40_qubes.conf:ConditionPathExists=!/var/run/qubes-service/whonix-template\nqubes-whonix/usr/lib/qubes-whonix/init/enable-firewall:if [ -e /var/run/qubes-service/whonix-template ]; then\nqubes-whonix/usr/lib/qubes-whonix/init/enable-services:    touch /var/run/qubes-service/whonix-template\nqubes-whonix/usr/lib/qubes-whonix/qubes-whonixsetup:elif [ -e /var/run/qubes-service/whonix-template ]; then\nqubes-whonix/usr/lib/qubes-whonix/replace-ips:    if os.path.exists('/var/run/qubes-service/whonix-template'):\nwhonix-gw-firewall/usr/bin/whonix_firewall:if [ -e /var/run/qubes-service/whonix-template ]; then\n```\n\n```\nqubes-whonix/lib/systemd/system/tor.service.d/40_qubes.conf:ConditionPathExists=/var/run/qubes-service/whonix-gateway\nqubes-whonix/lib/systemd/system/qubes-whonix-postinit.service:## On Whonix-Gateway or Whonix-Workstation (if /var/run/qubes-service/whonix-gateway or\nqubes-whonix/lib/systemd/system/qubes-whonix-postinit.service:## /var/run/qubes-service/whonix-gateway) exits, and if\nqubes-whonix/lib/systemd/system/qubes-whonix-postinit.service:ConditionPathExists=|/var/run/qubes-service/whonix-gateway\nqubes-whonix/lib/systemd/system/qubes-whonix-sysinit.service:## - /var/run/qubes-service/whonix-gateway\nqubes-whonix/lib/systemd/system/qubes-whonix-sysinit.service:## /var/run/qubes-service/whonix-gateway) exits, add 'tor' to tinyproxy's\nqubes-whonix/lib/systemd/system/qubes-whonix-firewall.service:## On Whonix-Gateway or Whonix-Workstation (if /var/run/qubes-service/whonix-gateway or\nqubes-whonix/usr/lib/qubes-whonix/init/qubes-whonix-postinit:if [ -e /var/run/qubes-service/whonix-gateway ] || [ -e /var/run/qubes-service/whonix-workstation ]; then\nqubes-whonix/usr/lib/qubes-whonix/init/qubes-whonix-postinit:if [ -e /var/run/qubes-service/whonix-gateway ]; then\nqubes-whonix/usr/lib/qubes-whonix/init/enable-firewall:elif [ -e /var/run/qubes-service/whonix-gateway ] || [ -e /var/run/qubes-service/whonix-workstation ]; then\nqubes-whonix/usr/lib/qubes-whonix/init/enable-services:        touch /var/run/qubes-service/whonix-gateway\nqubes-whonix/usr/lib/qubes-whonix/init/qubes-whonix-sysinit:if [ -e /var/run/qubes-service/whonix-gateway ]; then\nqubes-whonix/usr/lib/qubes-whonix/init/network-proxy-setup:if [ -e /var/run/qubes-service/whonix-gateway ]; then\nqubes-whonix/usr/lib/qubes-whonix/bind-directories:if [ -e \"/var/run/qubes-service/whonix-gateway\" ] || [ -e \"/var/run/qubes-service/whonix-workstation\" ]; then\nqubes-whonix/usr/lib/qubes-whonix/qubes-whonixsetup:if [ -e /var/run/qubes-service/whonix-gateway ]; then\nqubes-whonix/usr/lib/qubes-whonix/replace-ips:    elif os.path.exists('/var/run/qubes-service/whonix-gateway'):\nwhonix-gw-firewall/usr/bin/whonix_firewall:if [ -e /var/run/qubes-service/whonix-gateway ]; then\nwhonix-gw-firewall/usr/bin/whonix_firewall:if [ -e /var/run/qubes-service/whonix-gateway ]; then\n```\n\n```\nqubes-whonix/lib/systemd/system/qubes-whonix-postinit.service:## /var/run/qubes-service/whonix-workstation exists),\nqubes-whonix/lib/systemd/system/qubes-whonix-postinit.service:ConditionPathExists=|/var/run/qubes-service/whonix-workstation\nqubes-whonix/lib/systemd/system/qubes-whonix-sysinit.service:## - /var/run/qubes-service/whonix-workstation\nqubes-whonix/lib/systemd/system/qubes-whonix-firewall.service:## /var/run/qubes-service/whonix-workstation exists), loads Whonix Firewall.\nqubes-whonix/usr/lib/qubes-whonix/init/qubes-whonix-postinit:if [ -e /var/run/qubes-service/whonix-gateway ] || [ -e /var/run/qubes-service/whonix-workstation ]; then\nqubes-whonix/usr/lib/qubes-whonix/init/enable-firewall:elif [ -e /var/run/qubes-service/whonix-gateway ] || [ -e /var/run/qubes-service/whonix-workstation ]; then\nqubes-whonix/usr/lib/qubes-whonix/init/enable-services:        touch /var/run/qubes-service/whonix-workstation\nqubes-whonix/usr/lib/qubes-whonix/bind-directories:if [ -e \"/var/run/qubes-service/whonix-gateway\" ] || [ -e \"/var/run/qubes-service/whonix-workstation\" ]; then\nqubes-whonix/usr/lib/qubes-whonix/replace-ips:    elif os.path.exists('/var/run/qubes-service/whonix-workstation'):\n```","comments":[{"author":"marmarek","date_created":1448224436,"date_modified":1448224436,"content":"What is wrong with `ExecStartPre=`? If that's the only problem, maybe that code can be simply merged into that `ExecStart=` script?"},{"author":"Patrick","date_created":1448224572,"date_modified":1448224572,"content":"I want to get rid of the many Whonix specific services by upstreaming (to Qubes or Whonix) everything that makes sense."},{"author":"Patrick","date_created":1448225404,"date_modified":1448225404,"content":"Is there in Qubes a common / recommended sytemd way using `ConditionPathExists` [or alike] way for detecting being run inside a TemplateVM?"},{"author":"Patrick","date_created":1448227342,"date_modified":1448227342,"content":">>! In T432#7206, @Patrick wrote:\n> Is there in Qubes a common / recommended sytemd way using `ConditionPathExists` [or alike] way for detecting being run inside a TemplateVM?\n\n`ExecStartPre=/bin/sh -c if [ \"$(qubesdb-read /qubes-vm-type)\" = \"TemplateVM\" ]; then exit 1 ; fi` would work, but it's not great. The service would be registered as failed rather then skipped because a condition wasn't me."},{"author":"Patrick","date_created":1448228596,"date_modified":1448228596,"content":">>! In T432#7206, @Patrick wrote:\n> Is there in Qubes a common / recommended sytemd way using `ConditionPathExists` [or alike] way for detecting being run inside a TemplateVM?\n\nCreated https://github.com/marmarek/qubes-core-agent-linux/pull/52 for it."},{"author":"marmarek","date_created":1448228644,"date_modified":1448228644,"content":"Yes, and failed service would break dependencies.\nSome flag file would be better. `/var/run/qubes-service` is meant to be controlled from Dom0 based on `qvm-service` settings, so not the best place. Maybe simply `/var/run/qubes/this-is-template`?\n"},{"author":"Patrick","date_created":1448229625,"date_modified":1448229625,"content":"Right. Closed https://github.com/marmarek/qubes-core-agent-linux/pull/52; and opened https://github.com/marmarek/qubes-core-agent-linux/pull/53 for it."},{"author":"Patrick","date_created":1448230520,"date_modified":1448230520,"content":"```\nno longer depend on /var/run/qubes-service/whonix-template\n\nhttps://phabricator.whonix.org/T432\n```\nhttps://github.com/Whonix/tb-updater/commit/ab3d60d58ab1e2ae87b1ecbe68d2b2e9a4147177"},{"author":"Patrick","date_created":1448233559,"date_modified":1448233559,"content":"```\nno longer depend on /var/run/qubes-service status files\n\nhttps://phabricator.whonix.org/T432\n```\nhttps://github.com/Whonix/whonix-gw-firewall/commit/11e30d99b5f866e3be73253fa5f1c11eb1165925"},{"author":"Patrick","date_created":1448236997,"date_modified":1448236997,"content":"```\nusr/lib/qubes-whonix/replace-ips: no longer depend on /var/run/qubes-service/\n\nhttps://phabricator.whonix.org/T432\n```\nhttps://github.com/Whonix/qubes-whonix/commit/201b50cba24d19639d69cdf172f1f5483897ed5f"},{"author":"Patrick","date_created":1448273984,"date_modified":1448273984,"content":"```\nless dependency on /var/run/qubes-service status files\n\nhttps://phabricator.whonix.org/T432\n```\nhttps://github.com/Whonix/qubes-whonix/commit/5696071c29eb854dc3161797d7fdcef9377116f5\n"},{"author":"Patrick","date_created":1448274695,"date_modified":1448274695,"content":">>! In T432#7256, @Patrick wrote:\n> ```\n> less dependency on /var/run/qubes-service status files\n> \n> https://phabricator.whonix.org/T432\n> ```\n> https://github.com/Whonix/qubes-whonix/commit/5696071c29eb854dc3161797d7fdcef9377116f5\n\nThe github diff viewer isn't great. The diff looks much simpler in `kdiff3`."}]},"PHID-TASK-c4ijkloku4sduej5ngb4":{"id":"431","title":"wall clock likely readable by VMs allowing Clock Correlation Attacks","status":"open","priority":"Normal","author":"Patrick","description":"Upon start of a VM, it gets its initial time from the host.* Therefore we can conclude by logic, that the virtualizer must somehow provide access of the information (the host time) to the VM.\n\nThere are two different mechanisms not to be confused\n\n* kvmclock - which Whonix KVM libvirt xml files are explicitly not using because of this\n* wall clock\n\nQuote http://lists.xen.org/archives/html/xen-users/2015-08/msg00019.html\n\n> there is also a pv wallclock (i.e. date and time) interface, but I don't think that's what Linux's clocksource is about\n\nAn adversary with the capability to compromise a Whonix-Workstation VM + observer [local clock leaks](https://www.whonix.org/wiki/Dev/TimeSync#Local_Clock_Leaks) can run a clock correlation attack. Described in more detail here:\nhttps://www.whonix.org/wiki/Dev/TimeSync#Clock_Correlation_Attack\n\n-----\n\n*Unless advanced users reading advanced security guide apply [Spoof the Initial Virtual Hardware Clock Offset](https://www.whonix.org/wiki/Advanced_Security_Guide#Spoof_the_Initial_Virtual_Hardware_Clock_Offset) instructions. (Probably very few are doing this.)\n\n-----\n\nTODO #research:\n\n* gather more information on the wall clock interface\n* find out if the wall clock information is only provided to the VM upon start of the VM or if the wall clock is continuously updated\n* figure out what can be done about this\n* perhaps enable some \"only update wallclock at VM start time\" feature if available\n* see if #KVM has something similar to what Xen [had|has](?) `/proc/sys/xen/independent_wallclock`\n* if applicable, explain upstream and write feature requests","comments":[{"author":"HulaHoop","date_created":1448067032,"date_modified":1448067123,"content":"http://www.tldp.org/HOWTO/Clock-2.html\n\n\" A Linux system actually has two clocks: One is the battery powered \"Real Time Clock\" (also known as the \"RTC\", \"CMOS clock\", or \"Hardware clock\") which keeps track of time when the system is turned off but is not used when the system is running. The other is the \"system clock\" (sometimes called the \"kernel clock\" or \"software clock\") which is a software counter based on the timer interrupt. It does not exist when the system is not running, so it has to be initialized from the RTC (or some other time source) at boot time. \"\n\nhttp://lists.gnu.org/archive/html/qemu-devel/2011-09/msg01249.html\n\n\" By default the RTC is driven by the host system time. This allows to use the RTC as accurate reference clock inside the guest, specifically if the host time is smoothly following an accurate external reference clock, e.g. via NTP.  If you want to isolate the guest time from the host, even prevent it from progressing during suspension, you can set clock to \"vm\" instead. \"\n\n***\n\nYes the wall clock and kvmclock are not mutually exclusive. Both are taken care of by the current configuration because kvm-clock is disabled and the rtc timer is set to track the guest clock instead of the host."},{"author":"Patrick","date_created":1448069381,"date_modified":1448069381,"content":"Hardware clock is yet another thing. What is the output of `sudo hwclock`? I suppose, probably it's not accessible, right?\n\n-----\n\nI don' think we sufficiently understand the wall clock mechanism. Even if the rtc timer is set to track the guest clock...\n\nUpon start of the VM, the VM must somehow figure out the time. Is it,\n\n* a) Sat Nov 21 01:16:31 UTC 2000\n* b) Sat Nov 21 01:16:31 UTC 2015\n* c) Sat Nov 21 01:16:31 UTC 2030\n* d) etc.?\n\nLikely the virtualizer has written this information into a memory page. Questions:\n\na) Can we access this information (date / time)?\nb) How to access this information (date / time)?\nc) Is this information (date / time) set to a fixed value (time of start of the VM) or sometimes updated (always same like host)?\nd) Does this information (date / time) get deleted after using it for setting the kernel clock?\n\n-----\n\nPhrased differently...\n\ne) From which source does the kernel initially obtain the time to set the kernel clock?"},{"author":"HulaHoop","date_created":1448403033,"date_modified":1448403033,"content":"I'll look into hwclock later. True, any guest on any virtualizer bootstraps its time initially from the host because it has to get it from *somewhere*. There is no way around that besides configuring an offset but then the attacker can just shave off the offset if they detect they're in a VM. I thought we agreed that the only effective solution for this was to stop time leaks from the host which is possible.\n\nLinux documentation for timekeeping virtual and physical:\n\nhttp://lxr.free-electrons.com/source/Documentation/virtual/kvm/timekeeping.txt"},{"author":"Patrick","date_created":1448406289,"date_modified":1448406289,"content":"How can an attacker shave off the offset? [assumption: contained inside VM / no VM break out]"},{"author":"HulaHoop","date_created":1448421490,"date_modified":1448421490,"content":"It will be known from the configuration files we distribute. Then all they have to do is deduct that number from whatever time they see inside the workstation to estimate the host time. "},{"author":"Patrick","date_created":1448457746,"date_modified":1448457746,"content":">>! In T431#7301, @HulaHoop wrote:\n> It will be known from the configuration files we distribute. Then all they have to do is deduct that number from whatever time they see inside the workstation to estimate the host time. \n\nAh. Yes. That's why we don't distribute configuration files with time offset to a public known fixed value. And currently only have this advice in advanced security guide [Spoof the Initial Virtual Hardware Clock Offset](https://www.whonix.org/wiki/Advanced_Security_Guide#Spoof_the_Initial_Virtual_Hardware_Clock_Offset). Without #whonix-host-additions for KVM, this task cannot be automated. Unfortunately there is no randomization feature. It would be worthwhile requesting one upstream. (Created T439 for it.)"},{"author":"HulaHoop","date_created":1473084637,"date_modified":1473084637,"content":"Same as T439 no wall-clock guest or otherwise provided any longer."}]},"PHID-TASK-dpw7or3c75755dmglepc":{"id":"430","title":"review enabling proxy arp impact on Qubes-Whonix Firewall","status":"resolved","priority":"Normal","author":"Patrick","description":"Do you think there are situations, where [`/etc/xen/vif-route-qubes`](https://github.com/marmarek/qubes-core-agent-linux/blob/2eb0ed2be14350d6df1fce2af855805133a4a416/network/vif-route-qubes)'s enabling of proxy arp ([`echo 1 >/proc/sys/net/ipv4/conf/${vif}/proxy_arp`](https://github.com/marmarek/qubes-core-agent-linux/blob/2eb0ed2be14350d6df1fce2af855805133a4a416/network/vif-route-qubes#L32)) could lead to proxy bypass, leaks?\n\n(Related: T426)","comments":[{"author":"marmarek","date_created":1447447805,"date_modified":1447447805,"content":"I don't think so. But also I think it isn't needed anymore (since each\nVM have proper routing set)."},{"author":"Patrick","date_created":1447448762,"date_modified":1447448762,"content":">>! In T430#7153, @marmarek wrote:\n> I don't think so.\n\nThank you, Marek! Done. Closing.\n\n> But also I think it isn't needed anymore (since each\n> VM have proper routing set).\n\nCreated https://github.com/QubesOS/qubes-issues/issues/1421 for it."}]},"PHID-TASK-bpwkah2pn4pcj2lqbgub":{"id":"429","title":"rework / reduce installed packages in Qubes-Whonix","status":"resolved","priority":"Normal","author":"Patrick","description":"__Introduction__:\n\nThere are probably a few packages, that are useful or even required for a Non-Qubes-Whonix desktop, but that are unneeded in Qubes-Whonix. For example:\n\n* plasma-widget-folderview (user doesn't get to see the desktop, unless in rare cases such as using VNC)\n* kde-kdm-autologin (Qubes already handles this)\n* ...\n\n__latest anon-meta-packages debian/control file__:\nhttps://github.com/Whonix/anon-meta-packages/blob/master/debian/control\n\n__snapshot at time of writing of anon-meta-packages debian/control file__:\nhttps://github.com/Whonix/anon-meta-packages/blob/3f864c653c8fa751386ddd2aa39a7d265b1a89c1/debian/control\n\n__reasoning why package X is installed__:\n\n* https://github.com/Whonix/whonix-developer-meta-files/blob/master/package_documentation/Whonix-Shared_packages\n* https://github.com/Whonix/whonix-developer-meta-files/blob/master/package_documentation/Whonix-Gateway_packages\n* https://github.com/Whonix/whonix-developer-meta-files/blob/master/package_documentation/Whonix-Workstation_packages\n\n__Technical background on `Recommends:` vs `Depends:`__:\nhttps://www.whonix.org/wiki/Whonix_Debian_Packages\n\n__TODO__:\n\n* 1) make a list of packages that are unneeded in Qubes-Whonix\n* 2) refactor the #anon-meta-packages package to apply these changes","comments":[{"author":"Patrick","date_created":1456142365,"date_modified":1456142365,"content":"```\nsplit anon-shared-desktop-kde package\n\ninto anon-shared-desktop-kde and anon-shared-applications-kde\n```\nhttps://github.com/Whonix/anon-meta-packages/commit/fb707a683bec3f23ae393624130db09e654d68ac"},{"author":"Patrick","date_created":1456438690,"date_modified":1456438690,"content":"```\n split whonix-(gateway|workstation) packages\n\ninto:\n- qubes-whonix-(gateway|workstation)\n- non-qubes-whonix-(gateway|workstation)\n\nThe Qubes-Whonix version does not depend on the anon-shared-desktop package,\nwhile the Non-Qubes-Whonix package does. This is to spare Qubes-Whonix users\nfrom installing packages that are only required to set up a desktop environment\nfor Non-Qubes-Whonix users. (Qubes dom0 hosts these packages such as kdm etc.)\n```\nhttps://github.com/Whonix/anon-meta-packages/commit/fc23e40a181c182391be03a4cd1f9774592b379e"},{"author":"Patrick","date_created":1456438965,"date_modified":1456438965,"content":"`install (non-)qubes-whonix-(gateway|workstation) packages accordingly`\nhttps://github.com/Whonix/Whonix/commit/889aa29b530ed2afd86c981b92f0f06414fe59e0"},{"author":"Patrick","date_created":1458561219,"date_modified":1458561219,"content":"```\nRemoved polkit-kde-1 as dependency from anon-shared-desktop-kde and added it to anon-shared-applications-kde.\n\npolkit-kde-1 is important as long as Whonix is kde-ish, uses kdesudo, otherwise\nleads to issues with kdesudo authentication.\n\nThis is required for a clean separation so the anon-shared-desktop-kde package\nis no longer required to be installed by default on Qubes.\n\nhttps://phabricator.whonix.org/T429\n```\nhttps://github.com/Whonix/anon-meta-packages/commit/c10485620cf8859bc6394b942fe17ff04f844274"},{"author":"Patrick","date_created":1458561802,"date_modified":1458561802,"content":"```\nremoved anon-shared-desktop-kde from whonix-[gateway|workstation]-shared-packages-shared-meta\n\nso it no longer gets installed by default in Qubes-Whonix.\nAnd readded it to non-qubes-whonix-[gateway|workstation].\n\nThis results in no longer installing kde-workspace, kdm,\nplasma-widget-folderview, kde-baseapps-bin in Qubes by default.\n\nhttps://phabricator.whonix.org/T429\n```\nhttps://github.com/Whonix/anon-meta-packages/commit/2f67cb5530030715825ffe07af115a6b828dd4ca"},{"author":"Patrick","date_created":1458562116,"date_modified":1458562116,"content":"If someone else wants to think this through also...\n\n```\napt-cache show kde-baseapps-bin\n```\nProbably alright.\n\n```\napt-cache show kde-workspace\n```\nMostly note able, we won't be having installed by default anymore...\n\n- phonon\n- klipper (clipboard manager)\n- ksysguard (process monitor)\n- KDE systemsettings\n\nIf any of these should be re-added..."},{"author":"marmarek","date_created":1458562306,"date_modified":1458562306,"content":">   Mostly note able, we won't be having installed by default anymore...\n>   \n>   - phonon\n>   - klipper (clipboard manager)\n>   - ksysguard (process monitor)\n>   - KDE systemsettings\n\nLooks ok on Qubes, even without moving away from KDE (maybe\nsystemsettings would be useful on KDE-based Qubes)."},{"author":"Patrick","date_created":1458564255,"date_modified":1458564255,"content":"ksysguard gets still [already] installed by anon-shared-applications-kde.\n\n`added systemsettings to anon-shared-applications-kde`:\nhttps://github.com/Whonix/anon-meta-packages/commit/9bf7e5764d80bc449de285552acb2c33b839aa15\n\nWe can also revisit what applications to be installed by default once Whonix default applications are migrated to being gnome-ish. (T467 / #gnome )"}]},"PHID-TASK-wmv455shpixr6osnadku":{"id":"428","title":"no longer show default username and password in terminal in Qubes","status":"resolved","priority":"Normal","author":"Patrick","description":"Because not required in Qubes.\n\n* https://github.com/Whonix/whonix-base-files/blob/master/etc/skel/.bashrc.whonix\n* https://github.com/Whonix/whonix-base-files/blob/master/etc/motd.whonix\n\nReported by @mfc.\n\nMigrated from https://github.com/QubesOS/qubes-issues/issues/1397.","comments":[{"author":"Patrick","date_created":1449692614,"date_modified":1449692614,"content":"https://github.com/Whonix/whonix-base-files/commit/dc4abe4c01d09b596518a4557c7143a373dea861"}]},"PHID-TASK-g4c26h56hfcbuphn5liv":{"id":"427","title":"prevent qubes-updates-proxy.service from possibly modifying Whonix's firewall","status":"resolved","priority":"Normal","author":"Patrick","description":"* [qubes-updates-proxy.service](https://github.com/QubesOS/qubes-core-agent-linux/blob/65e9e4c72cbbd188cd5c83f5dab2d63acf5efd4f/vm-systemd/qubes-updates-proxy.service)\n* [/usr/lib/qubes/iptables-updates-proxy](https://github.com/QubesOS/qubes-core-agent-linux/blob/65e9e4c72cbbd188cd5c83f5dab2d63acf5efd4f/network/iptables-updates-proxy)\n\n-----\n\nDo you think the following seems like a sound solution?\n\n```\n/lib/systemd/system/qubes-updates-proxy.service.d/40_qubes-whonix.conf\n```\n```\n## This file is part of Whonix.\n## Copyright (C) 2012 - 2015 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\n[Service]\n\n## Clear the 'ExecStartPre' list.\n## Prevent loading firewall rules: ExecStartPre=/usr/lib/qubes/iptables-updates-proxy start\nExecStartPre=\n\n## Clear the 'ExecStopPost' list.\n## Prevent removing firewall rules: ExecStopPost=/usr/lib/qubes/iptables-updates-proxy stop\nExecStopPost=\n\n## XXX: Workaround.\n## Re-adding a required 'ExecStartPre' item.\n## Required until, qubes-core-agent 3.1.3 hits stable and everyone\n## upgraded, i.e. until /usr/lib/tmpfiles.d/qubes-core-agent-linux.conf\n## is in place.\n## https://github.com/QubesOS/qubes-issues/issues/1401\nExecStartPre=/usr/bin/install -d --owner tinyproxy --group tinyproxy /var/run/tinyproxy\n```\n\n-----\n\nAlternatively, I was wondering if I rather should produce a pull request against QubesOS either,\n\n* a) split `qubes-updates-proxy` into `qubes-updates-proxy` and `qubes-updates-proxy-iptables` or,\n* b) allow `iptables-updates-proxy` to be turned of by `/etc/qubes/settings.d`\n\n-----\n\nWhat do you think?","comments":[{"author":"Patrick","date_created":1447343906,"date_modified":1447343906,"content":"Implemented the above `/lib/systemd/system/qubes-updates-proxy.service.d/40_qubes-whonix.conf` solution for now...\n\n`prevent qubes-updates-proxy.service from possibly modifying Whonix's firewall`:\nhttps://github.com/Whonix/qubes-whonix/commit/d386885db0e666f4011f892e2be8c2049de3b077\n\n...until/if there is a better solution suggested."},{"author":"marmarek","date_created":1447348895,"date_modified":1447348895,"content":"I think the current solution (overriding 'ExecStartPre' and 'ExecStopPost') is ok. Do you include those firewall rules in Whonix firewall? Without such redirection, VMs will not be able to connect to the updates proxy."},{"author":"Patrick","date_created":1447349750,"date_modified":1447349750,"content":">>! In T427#7103, @marmarek wrote:\n> Do you include those firewall rules in Whonix firewall?\n\nYes. Qubes specific rules:\nhttps://github.com/Whonix/whonix-gw-firewall/blob/c30ad852911856051f43205f822446cc2a032fec/usr/bin/whonix_firewall#L285-L310\n\n(Tested and working.)"}]},"PHID-TASK-6fc6nr4zscsqhqpwu6wa":{"id":"426","title":"review /etc/xen/vif-route-qubes impact on Qubes-Whonix Firewall","status":"resolved","priority":"High","author":"Patrick","description":"Do you think there are situations, where [`/etc/xen/vif-route-qubes`](https://github.com/marmarek/qubes-core-agent-linux/blob/2eb0ed2be14350d6df1fce2af855805133a4a416/network/vif-route-qubes)'s use of [`iptables-restore`](https://github.com/marmarek/qubes-core-agent-linux/blob/2eb0ed2be14350d6df1fce2af855805133a4a416/network/vif-route-qubes#L57-L58) could interfere with Whonix's firewall?","comments":[{"author":"marmarek","date_created":1447282190,"date_modified":1447282190,"content":"Depending what you mean by \"interfere\". In terms of rules itself - as\nlong as Whonix doesn't use \"raw\" table (I guess it doesn't), it\nshouldn't be a problem. But some race condition making either of\n`iptables-restore` call fail may be possible.\nTheoretically `iptables-restore` is used instead of `iptables` exactly\nto prevent such problem\n(https://github.com/QubesOS/qubes-issues/issues/42), but it isn't clear\nto me that it is really effective. We have `flock` in `vif-route-qubes`\nbecause of this uncertainty. Maybe `iptables --wait` would be a better\noption - now it is available in Debian too (>=jessie). But according to\niptables sources, I think `iptables --wait` still could race against\n`iptables-restore` - the later doesn't use any locking.\n\nWhat is Debian solution for such problem (different programs/startup\nscripts adding iptables rules simultaneously)? The Fedora way is to use\n`firewalld`..."},{"author":"Patrick","date_created":1447338424,"date_modified":1447338424,"content":"marmarek (Marek Marczykowski-Górecki):\n> Depending what you mean by \"interfere\".\n\nI mean by \"interfere\" here:\n\"Somehow loading firewall rules inappropriate to Whonix that could in\nworst case lead to leaks.\"\n\n> as\n> long as Whonix doesn't use \"raw\" table (I guess it doesn't)\n\nWhonix doesn't use the \"raw\" table indeed.\n\n> What is Debian solution for such problem (different programs/startup\n> scripts adding iptables rules simultaneously)?\n\nDunno if there is...\n\nAsked on debian-users mailing list:\n\"Are there packages that modify iptables rules?\"\nhttps://lists.debian.org/debian-user/2015/11/msg00416.html\n\nAnswer for now:\nfail2ban\nminiupnpd\n\nAsked a follow up question on debian-users mailing list:\n\"How do packages that modify iptables rules prevent race conditions?\"\nhttps://lists.debian.org/debian-user/2015/11/msg00418.html"},{"author":"marmarek","date_created":1447349167,"date_modified":1447349167,"content":"> Whonix doesn't use the \"raw\" table indeed.\n\nSo I think it is safe.\n\n> Asked a follow up question on debian-users mailing list:\n> \"How do packages that modify iptables rules prevent race conditions?\"\n> https://lists.debian.org/debian-user/2015/11/msg00418.html\n\nBut the answer for this question would be helpful for bugs like this:\nhttps://github.com/QubesOS/qubes-issues/issues/1067\nhttps://github.com/QubesOS/qubes-issues/issues/740"},{"author":"Patrick","date_created":1447436686,"date_modified":1447436686,"content":">>! In T426#7104, @marmarek wrote:\n>> Asked a follow up question on debian-users mailing list:\n>> \"How do packages that modify iptables rules prevent race conditions?\"\n>> https://lists.debian.org/debian-user/2015/11/msg00418.html\n> \n> But the answer for this question would be helpful for bugs like this:\n> https://github.com/QubesOS/qubes-issues/issues/1067\n> https://github.com/QubesOS/qubes-issues/issues/740\n\nThere have been some answers."},{"author":"Patrick","date_created":1447436754,"date_modified":1447436754,"content":"Thank you, Marek! Done. Closing."}]},"PHID-TASK-bwwhplhetqyb2liiaidq":{"id":"425","title":"Tor Browser folder change Whonix 11 -> Whonix 12 migration path","status":"resolved","priority":"High","author":"Patrick","description":"As [mentioned](https://www.whonix.org/forum/index.php/topic,1910.0.html)... A follow up task of T338.\n\nWe need to move Tor Browser from the old location(s) to the new ones. Otherwise existing users who upgrade would be notified \"Tor Browser not installed\" and asked \"want to install Tor Browser?\".\n\n```\nmv /home/user/tor-browser_en-US /home/user/.tb/tor-browser\n```\n```\nmv /home/user/.tb/tor-browser_en-US /home/user/.tb/tor-browser\n```\n\nVarious things to adhere:\n\n* check if old folder even exists\n* check if new folder does not already exist\n* preventing permission issues, doing it as user, not root\n* perhaps leave a symlink from the old location to preven confusion?\n\nThis is specifically difficult in Qubes. It cannot be done from a Debian mainstainer script, because TemplateBasedVM's home folder is unaffected by what the TemplateVM changes in home.\n\nDo we let existing users bite the bullet, let them manually move Tor Browser or download a new one or invent some mechanism, that during boot up, doing this migration task?\n\nBtw, for now, this should be the last issue before releasing #Whonix_12 as stable.","comments":[{"author":"marmarek","date_created":1446903582,"date_modified":1446903582,"content":"In Qubes we use qubes-misc-post.service for such /home/user fixups. For\nexample:\nhttps://github.com/QubesOS/qubes-core-agent-linux/commit/e5c77507a158f4184cb47d3040a89de9b809cfce\n\nWhonix can have another one, with dependencies set\nAfter=qubes-dvm.service qubes-mount-dirs.service\nqubes-mount-home.service\n\nand maybe \"Before=qubes-mount-dirs.service qubes-mount-home.service\",\nbut not sure about that. It shouldn't harm to move tor-browser directory\neven when GUI agent is already running. As long as it happens before\nuser tries to launch it.\n\nBTW Both qubes-mount-dirs.service and qubes-mount-home.service to have it\nworking on both R3.0 and R3.1."},{"author":"Patrick","date_created":1446986701,"date_modified":1446986701,"content":"- https://github.com/QubesOS/qubes-core-agent-linux/blob/master/vm-systemd/qubes-misc-post.service\n- https://github.com/QubesOS/qubes-core-agent-linux/blob/master/vm-systemd/misc-post.sh\n"},{"author":"Patrick","date_created":1447354075,"date_modified":1447354075,"content":"`implemented Tor Browser folder change Whonix 11 -> Whonix 12 migration path`:\nhttps://github.com/Whonix/whonix-legacy/commit/abf5b1d14184effb5d020dc31142c8f5acec254e\n"},{"author":"Patrick","date_created":1447355597,"date_modified":1447355597,"content":"```\nadded 'After=qubes-whonix-postinit.service' to whonix-legacy.service\n\nWe need to wait until qubes-whonix-postinit.service is done, since\n/usr/lib/qubes-whonix/bind-directories is still run by\nqubes-whonix-postinit.service. bind-directories has not been\nupstreamed to Qubes yet. - https://phabricator.whonix.org/T414\n\nhttps://phabricator.whonix.org/T425\n```\nhttps://github.com/Whonix/whonix-legacy/commit/bdf24f9988d3c1329e38ea4e8709055daf679387"},{"author":"Patrick","date_created":1447436015,"date_modified":1447436015,"content":"Hm. Not sure if adding a symlink was a mistake. If they copy/paste the folder using dolphin, they won't create a backup, just copy the symlink. Wonder if that could lead to some confusion and possibly data loss."},{"author":"Patrick","date_created":1447437287,"date_modified":1447437287,"content":"Better to have some confusion and asking where it's located now or if it's gone than any users who copied the symlink as backup.\n\n```\nDeactivated symlink creation from old to new Tor Browser folder location.\n\nCould lead to confusion and in worst case, data loss, if users just copy the\nsymlink rather than whole folder.\n\nhttps://phabricator.whonix.org/T425\n```\nhttps://github.com/Whonix/whonix-legacy/commit/c2cc7d47e6f4428e60498f3e39a406aa9372ce64"},{"author":"marmarek","date_created":1447448526,"date_modified":1447448526,"content":"What about leaving some README.txt in old location? Or indeed ignore the\nproblem."}]},"PHID-TASK-xsqvcnluesqlbbx7bad6":{"id":"424","title":"fix /etc/xdg/autostart vs systemd race condition","status":"open","priority":"Normal","author":"Patrick","description":"TLDR:\n\nHow to have a `/etc/xdg/autostart/app.desktop` service wait for a systemd service?\n\nLong:\n\n`qubes-whonix-firewall.service` runs `enable-firewall` and conditionally creates the `/var/run/qubes-service/whonix-secure-proxy` status file.\n\n`/etc/xdg/autostart/qubes-whonixsetup.desktop` runs `/usr/lib/qubes-whonix/qubes-whonixsetup`. Sometimes `/etc/xdg/autostart/qubes-whonixsetup.desktop` runs faster than `qubes-whonix-firewall.service`. The status file does not exist at that point, which results in an \"This TemplateVM needs a Whonix-Gateway NetVM\" error popup.\n\nI would like to avoid some sleep/wait/custom code if there is an existing tool for such purposes.\n\n-----\n\nReferences:\n\n* https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=820111\n* https://github.com/systemd/systemd/issues/3513\n* https://lists.freedesktop.org/archives/systemd-devel/2016-June/036923.html\n* https://groups.google.com/d/msg/qubes-users/Verq_0ceE04/rRqEiYrzPwAJ\n* https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=764678\n* https://lists.freedesktop.org/archives/systemd-devel/2017-February/038361.html\n* https://lists.freedesktop.org/archives/systemd-devel/2017-February/038361.html\n* https://github.com/systemd/systemd/issues/5462\n** https://github.com/systemd/systemd/issues/3312#issuecomment-282593241\n* https://lists.freedesktop.org/archives/systemd-devel/2017-February/038365.html\n* https://github.com/systemd/systemd/issues/5481\n\n-----\n\nA `systemd --user` instance knows nothing about the `systemd --system` instance. I.e. a `systemd --user` instance cannot reference `After=some-system.service`. Source:\n\nhttps://lists.freedesktop.org/archives/systemd-devel/2017-February/038361.html\n\nSo we cannot use `qubes-whonixsetup.service` `After=qubes-gui-agent.service`.\n\nsystemd feature request - `systemd --user instance ability to reference systemd --system services with After= etc.`:\nhttps://github.com/systemd/systemd/issues/5462","comments":[{"author":"Patrick","date_created":1446742638,"date_modified":1446742638,"content":"`How to have an /etc/xdg/autostart/app.desktop service wait for a (systemd) service?`\nhttp://unix.stackexchange.com/questions/241058/how-to-have-an-etc-xdg-autostart-app-desktop-service-wait-for-a-systemd-servi"},{"author":"marmarek","date_created":1446748984,"date_modified":1446748984,"content":"The easiest (but maybe not the most efficient) way would be adding\n`Before=` ordering in service. In Qubes case, it would be\n`Before=qubes-gui-agent.service`."},{"author":"Patrick","date_created":1446750097,"date_modified":1446750097,"content":"That's alright as a workaround for #Whonix_12. Let's see if there is a more efficient solution."},{"author":"Patrick","date_created":1446750307,"date_modified":1446750307,"content":"`qubes-whonix-firewall: Preventing race condition with Qubes Whonix Setup.`:\nhttps://github.com/Whonix/qubes-whonix/commit/790679d88bba74a587dbaedaae1ea166dcdf0989"},{"author":"Patrick","date_created":1447335170,"date_modified":1447335170,"content":"Asked also on the pkg-systemd-maintainers mailing list:\n`How to have an /etc/xdg/autostart/app.desktop service wait for a (systemd) service?`\nhttp://lists.alioth.debian.org/pipermail/pkg-systemd-maintainers/2015-November/009434.html"},{"author":"Patrick","date_created":1459870869,"date_modified":1459870869,"content":"I didn't figure out how to use per-user systemd --user services in plain Debian (let alone in Qubes Debian template).\n\n`document how to use per-user systemd --user services`:\nhttp://bugs.debian.org/cgi-bin/bugreport.cgi?bug=820111\n"},{"author":"HulaHoop","date_created":1459898183,"date_modified":1459898183,"content":"Seems explained here:\n\nhttps://wiki.archlinux.org/index.php/Systemd/User"},{"author":"Patrick","date_created":1459904642,"date_modified":1459904642,"content":"I've found that before. Doesn't help."},{"author":"Patrick","date_created":1460056606,"date_modified":1460056606,"content":"Status...\nWIP: https://github.com/adrelanos/qubes-whonix/tree/T424\nWaiting for instructions on how to use per-user systemd --user services in Debian."},{"author":"Patrick","date_created":1460744247,"date_modified":1460744247,"content":"Cannot be implemented now therefore. Rechecking when porting to Debian stretch."},{"author":"Patrick","date_created":1487634992,"date_modified":1487634992,"content":"One step closer.\n\nBy Debian stretch default, there are some default systemd user unit files in `/usr/lib/systemd/user/`.\n\n`/usr/lib/systemd/user/mytest.service`:\n\n```\n[Unit]\nDescription=mytest\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStart=/bin/true\n\n[Install]\nWantedBy=default.target\n```\n\n    systemctl --user enable mytest\n\nWorked for me.\n\n> `Created symlink /home/user/.config/systemd/user/default.target.wants/mytest.service → /usr/lib/systemd/user/mytest.service.`\n\nI haven't figured out yet how to cleanly (or uncleanly) enable systemd user services using Debian packaging. `sudo -u user systemctl --user enable mytest` will probably not work (apt-get somehow does not like `sudo -u user` anymore since Debian stretch), and that would not be a clean solution either.\n"},{"author":"Patrick","date_created":1487636022,"date_modified":1487636022,"content":">>! In T424#12408, @Patrick wrote:\n> I haven't figured out yet how to cleanly (or uncleanly) enable systemd user services using Debian packaging. `sudo -u user systemctl --user enable mytest` will probably not work (apt-get somehow does not like `sudo -u user` anymore since Debian stretch), and that would not be a clean solution either.\n\nExisting Debian feature request `dh-systemd: Please support systemd user services`:\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=764678"},{"author":"Patrick","date_created":1487636624,"date_modified":1487636624,"content":"As per\n\n> Existing Debian feature request `dh-systemd: Please support systemd user services`:\n> https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=764678\n\na symlink `/usr/lib/systemd/user/default.target.wants/qubes-whonixsetup.service` using `debian/qubes-whonix.links` might be a workable acceptable solution for strretch until Debian feature 764678 gets implemented."},{"author":"Patrick","date_created":1487696047,"date_modified":1487696047,"content":"https://github.com/Whonix/qubes-whonix/commit/170cd1dbcee09119e171b7d930d4be7f5f3e14b3\n\nThat worked. Somewhat. Now I need to figure out if there is a sane way to sort out the environment variables.\n\n> Feb 21 03:06:56 host qubes-whonixsetup[1104]: kdesudo: cannot connect to X server :0\n"},{"author":"Patrick","date_created":1488131606,"date_modified":1488131606,"content":"A `systemd --user` instance knows nothing about the `systemd --system` instance. I.e. a `systemd --user` instance cannot reference `After=some-system.service`. Source:\n\nhttps://lists.freedesktop.org/archives/systemd-devel/2017-February/038361.html\n\nSo we cannot use `qubes-whonixsetup.service` `After=qubes-gui-agent.service`.\n\nsystemd feature request - `systemd --user instance ability to reference systemd --system services with After= etc.`:\nhttps://github.com/systemd/systemd/issues/5462"},{"author":"Patrick","date_created":1488244274,"date_modified":1488244274,"content":"Asked about how to set the environment variables and got some answers:\nhttps://lists.freedesktop.org/archives/systemd-devel/2017-February/038365.html\n\nPerhaps `ExecStartPre=systemctl --user import-environment` would do.\n\nHowever, that is currently not possible.\n\nEnvironment variable `QUBES_KEYMAP` breaks `systemctl --user import-environment`.\n\nsystemd bug report - `systemctl --user import-environment fails on complex environment variable with Failed to import environment: Invalid environment assignments`:\nhttps://github.com/systemd/systemd/issues/5481"},{"author":"Patrick","date_created":1488402350,"date_modified":1488402350,"content":">>! In T424#12530, @Patrick wrote:\n> A `systemd --user` instance knows nothing about the `systemd --system` instance. I.e. a `systemd --user` instance cannot reference `After=some-system.service`. Source:\n> \n> https://lists.freedesktop.org/archives/systemd-devel/2017-February/038361.html\n> \n> So we cannot use `qubes-whonixsetup.service` `After=qubes-gui-agent.service`.\n> \n> systemd feature request - `systemd --user instance ability to reference systemd --system services with After= etc.`:\n> https://github.com/systemd/systemd/issues/5462\n\n`/lib/systemd/system/user@.service` does `ExecStart=-/lib/systemd/systemd --user`. In theory we could add a systemd drop-in adding: `After=qubes-gui-agent.service` but that looks like an awful hack.\n\n`ExecStartPre=systemctl --user import-environment` also looks like an awful hack. Doing something as the distribution that should really be only done by the user.\n\nGiven all these issues referenced above, I don't think systemd is ready to replace `/etc/xdg/autostart`. We'll probably need to wait until the X (or by that time perhaps wayland) session gets started by the `systemctl --user` session.\n\nRechecking the status of systemd's capabilities at a later release."}]},"PHID-TASK-h2f23sjo77vyckt3nay7":{"id":"423","title":"no longer show already collected output in whonixcheck when canceling","status":"resolved","priority":"Normal","author":"Patrick","description":"When the user presses cancel in the progress bar (when #whonixcheck was manually run), do not show already collected text. It is a bit annoying to press cancel to be awarded by a popup. Therefore dismiss the existing collected text and just exit.\n\nThis might need a new `--clear` feature in #msgcollector.","comments":[{"author":"Patrick","date_created":1449692857,"date_modified":1449692857,"content":"https://github.com/Whonix/whonixcheck/commit/46766fabfa480e09057a84a0a61226c713c68cc7"}]},"PHID-TASK-ux2ode3es4pwsd7wipxx":{"id":"422","title":"keep an eye on tor-monitor","status":"invalid","priority":"Normal","author":"Patrick","description":"There is now also https://github.com/satta/tor-monitor:\n\n* doesn't do a lot yet\n* does one thing... \"Displays Tor circuits and streams\"\n* looks like they are going to package it for official Debian\n* I guess there is no need to replicate that functionality then.\n* As soon as it's installable from Debian, we can consider installing it by default.","comments":[{"author":"Patrick","date_created":1516537264,"date_modified":1516537264,"content":"Now called onion-circuits which is installed by default in Whonix 14 Gateway."}]},"PHID-TASK-jxo2sj7oetlfm2se45cx":{"id":"421","title":"check if whonix-gw ProxyVM (sys-whonix)'s NetVM is set to 'none'","status":"resolved","priority":"Normal","author":"Patrick","description":"Is it possible to check from within `sys-whonix` to check if its NetVM is set to `none` using `qubesdb-read` (or similar)?\n\nOr should just `/sbin/ifconfig eth0` be used?","comments":[{"author":"Patrick","date_created":1445262540,"date_modified":1445262540,"content":"* If a NetVM is set, `qubesdb-read /qubes-gateway` works.\n* If NetVM is set to `none`, `qubesdb-read /qubes-gateway` fails.\n\nIs this a sane way to test for it?\n"},{"author":"marmarek","date_created":1445291593,"date_modified":1445291593,"content":"I think better would be checking `qubesdb-read /qubes-ip`. Also checking\neth0 existence should be fine (but only existence, not its configuration\n- as the interface may simply not be yet configured)."},{"author":"Patrick","date_created":1449892993,"date_modified":1449892993,"content":"`improved Qubes settings checks; show a warning if NetVM is set to none`:\nhttps://github.com/Whonix/whonixcheck/commit/a5407b75a575af4aaf9a46ce396e8b48a505af19"},{"author":"Patrick","date_created":1461266251,"date_modified":1461266251,"content":"gateway test: succeeded\nworkstation test: todo"},{"author":"Patrick","date_created":1461779451,"date_modified":1461779451,"content":"workstation test: succeeded"}]},"PHID-TASK-borftxlqobreptndkrbf":{"id":"420","title":"CodeSelect template / widget unusably slow on big pages","status":"resolved","priority":"High","author":"Patrick","description":"CodeSelect (T93) is causing issues.\n\n{F27}\n\nUnusably slow on big pages. Cannot be used on pages such as https://www.whonix.org/wiki/Using_Tunnels_with_Whonix or https://www.whonix.org/wiki/KVM.\n\nWiki markup source:\n\n* https://www.whonix.org/wiki/Template:CodeSelect\n* https://www.whonix.org/w/index.php?title=Template:CodeSelect&action=edit\n* https://www.whonix.org/wiki/Widget:CodeSelect\n* https://www.whonix.org/w/index.php?title=Widget:CodeSelect&action=edit\n\nSpeed comparison:\n\n* without CodeSelect - https://www.whonix.org/w/index.php?title=Using_Tunnels_with_Whonix&oldid=17636 - https://gtmetrix.com/reports/www.whonix.org/rHQTqAU2 - `2,9` s\n* with CodeSelect - https://www.whonix.org/w/index.php?title=Using_Tunnels_with_Whonix&oldid=18784 - https://gtmetrix.com/reports/www.whonix.org/TfndWzSF - `80,3` s\n\nDoes anyone have any idea how to fix this?\n\nWhich part of the javascript makes it so slow? Can it be refactored to execute faster?","comments":[{"author":"Lobster","date_created":1467550726,"date_modified":1467550726,"content":"The problem is that the JS and CSS code is included in Widget:CodeSelect which duplicates and executes the code many times. The obvious solution would be to place the CSS and JS codes in external files."},{"author":"Patrick","date_created":1467550819,"date_modified":1467550819,"content":"Could you do that please with mediawiki?"},{"author":"Lobster","date_created":1467554238,"date_modified":1467554238,"content":"I split the code in 3 files and made use of the client-(no)js css class. The codeselect.js has to be loaded after jQuery because it is used do determine when the DOM is ready.\n\n{F37699} (<link rel=\"stylesheet\" href=\"/path/to/codeselect.css\" /> in wiki header)\n\n{F37701}  (<script src=\"/path/to/codeselect.js\"></script> after jQuery)\n\n{F37700} (content of Widget:CodeSelect)"},{"author":"Lobster","date_created":1467555093,"date_modified":1467555093,"content":"In MediaWiki custom css and js can be added as explained here:\nhttps://www.mediawiki.org/wiki/Manual:Interface/Stylesheets\nhttps://www.mediawiki.org/wiki/Manual:Interface/JavaScript\n\nAppend codeselect.css to:\nhttps://www.whonix.org/wiki/MediaWiki:Common.css\n\nAnd append codeselect.js to:\nhttps://www.whonix.org/wiki/MediaWiki:Common.js"},{"author":"Patrick","date_created":1467559358,"date_modified":1467559358,"content":"Awesome!\n\nwith CodeSelect - https://www.whonix.org/w/index.php?title=Using_Tunnels_with_Whonix&oldid=18784 - https://gtmetrix.com/reports/www.whonix.org/jizvabJd - `3,0` s\n\nDown from `80,3` s to `3,0` s.  Ignoring the measurement inaccuracy, it is safe to say, that the new CodeSelect is as fast as without CodeSelect. In other words, the CodeSelect slow down bug is fixed!"},{"author":"Patrick","date_created":1467559680,"date_modified":1467559680,"content":"I missed some new bugs... With javascript disabled now it got worse.\n\n* it shows a defunct select code button\n* it duplicates the contents (it now shows the `<pre></pre>` box as well as the javascript box which is much too small... Could the javascript box be hidden if javascript is disabled?)\n\nCould you fix that please?"},{"author":"Lobster","date_created":1467560883,"date_modified":1467560883,"content":"Somehow the styles from https://www.whonix.org/wiki/MediaWiki:Common.css don't get loaded, which would hide the select code button and the textarea"},{"author":"Lobster","date_created":1467562596,"date_modified":1467562614,"content":"It seems like the current skin (Strapping) is not using these MediaWiki styles, but it should work by modifying the screen.css and theme.css as explained here: https://github.com/OSAS/strapping-mediawiki/#themecss"},{"author":"Patrick","date_created":1467563520,"date_modified":1467563520,"content":"https://github.com/OSAS/strapping-mediawiki/blob/master/screen.css\n\n> In the screen.css file, uncomment the theme.css import.\n\nHow do I do that?"},{"author":"Lobster","date_created":1467563886,"date_modified":1467563886,"content":"Oh, sorry, the github page seems to be incorrect, theme.css gets loaded directly (at least in our case):\n\n```\n<link rel=\"stylesheet\" href=\"/w/skins/strapping/theme.css?303\" media=\"screen\" />\n```\nSo inserting the codeselect.css into the theme.css should be enough."},{"author":"Patrick","date_created":1467564222,"date_modified":1467564222,"content":"This works. Awesome!"}]},"PHID-TASK-satzm5cagfdqrtkqwmas":{"id":"419","title":"no longer write to home folder directly; use /etc/skel","status":"resolved","priority":"Normal","author":"Patrick","description":"rationale:\n\n* for example https://github.com/Whonix/anon-gpg-tweaks/blob/3ebe733fa5198bc88de1af659d309f121d032205/debian/anon-gpg-tweaks.postinst#L23-L31 is non-ideal.\n** hardcoded to user `user`, other created users won't profit from these\n** using `sudo -u` in maintainer script\n** won't work anymore in Qubes, once TemplateBasedVMs no longer inherits their TemplateVMs home (https://github.com/QubesOS/qubes-issues/issues/1335)\n\nTODO:\n* ~~no longer have packages (maintainer scripts) directly write to /home~~\n* ~~use /etc/skel instead~~\n* ~~copy files from /etc/skel to /home/user at first boot~~\n\nRelated, separate ticket:\n`ship Tor Browser tarballs in Qubes TemplateVMs in /var/cache/tb-binary and extract in AppVMs at boot time to user's home folder` (T417)\n","comments":[{"author":"Patrick","date_created":1449180668,"date_modified":1449180668,"content":"```\nno longer write to home folder directly; use /etc/skel;\n\nhttps://phabricator.whonix.org/T419\n\nproper error handling in xchat-reset\n```\nhttps://github.com/Whonix/xchat-improved-privacy/commit/aadea76e21b3804c053338bc9449b6c7962a91dd"},{"author":"Patrick","date_created":1449182022,"date_modified":1449182022,"content":"```\nno longer write to home folder directly; use /etc/skel;\n\nhttps://phabricator.whonix.org/T419\n```\nhttps://github.com/Whonix/anon-mixmaster/commit/29105ddaecd1280ca706a7dfd7a19a53acf3ccdf\nhttps://github.com/Whonix/whonix-base-files/commit/c34f29f700eaf354e3bf1f64694b4bc89670b06c\nhttps://github.com/Whonix/whonix-base-files/commit/1a5ef1f0a16a65d83fc128af41f768795d20aab9\nhttps://github.com/Whonix/whonix-base-files/commit/b58518c8de3ded6e33eec574ccfb226c1d46d5e2\nhttps://github.com/Whonix/anon-torchat/blob/master/etc/skel/.torchat/torchat.ini\nhttps://github.com/Whonix/anon-gpg-tweaks/commit/2ace0c0768d7f44fae12df48ac4b29287349b993\n"},{"author":"Patrick","date_created":1449183248,"date_modified":1449183248,"content":"`chmod 700 /etc/skel/.gnupg in postinst to prevent gpg permission warning`:\nhttps://github.com/Whonix/anon-gpg-tweaks/commit/55b727974acf10ed76ed99c84fa560260d36e540"},{"author":"Patrick","date_created":1449783296,"date_modified":1449783296,"content":"```\npopulate /home/user from /etc/skel at first boot\n\nhttps://phabricator.whonix.org/T419\n```\nhttps://github.com/Whonix/whonix-base-files/commit/4ee7f32ba8b7dcf87d9ae31d1ade8b00468520af"},{"author":"Patrick","date_created":1452206430,"date_modified":1452206430,"content":"```\nfix / code simplification\n\nhttps://phabricator.whonix.org/T419\n```\nhttps://github.com/Whonix/whonix-base-files/commit/9d7da269be22114737317051c5f4c6bce6ca4253\n\n```\nseparate done file for Qubes TemplateVMs to make this work with the\ncurrent home folder population for Qubes DispVMs.\nhttps://github.com/QubesOS/qubes-core-agent-linux/blob/f380c346cf9af3f058b8ece853d7d4a5ece28815/misc/dispvm-prerun.sh#L6-L12\n\nhttps://phabricator.whonix.org/T419\nhttps://phabricator.whonix.org/T463\n```\nhttps://github.com/Whonix/whonix-base-files/commit/9ade708ed7288a1fec4a662b2bf062a8ebffc15c"},{"author":"Patrick","date_created":1452207164,"date_modified":1452207164,"content":"`do not needlessly copy .bashrc.whonix-orig from skel to home`\nhttps://github.com/Whonix/whonix-base-files/commit/63ed2423f4b6303af32d1daa8affb3e5006e6837\n"},{"author":"Patrick","date_created":1452207357,"date_modified":1452207357,"content":"`first-boot-skel: hide needless output of diff in the logs`\nhttps://github.com/Whonix/whonix-base-files/commit/d3d7da44e1e0ca1d8059c202abefce7e1181ce16\n"},{"author":"Patrick","date_created":1461274951,"date_modified":1461274951,"content":"https://github.com/Whonix/whonix-base-files/commit/da56e3338e1eb802d956f0e55c6debd270cdfa3f\nhttps://github.com/Whonix/whonix-base-files/commit/e87191e2ae8833cadad08d1949ab36198f9eb239\nhttps://github.com/Whonix/qubes-whonix/commit/65fac1f6eb3fd0cfa1d5beb47b757ac4263a5537"},{"author":"Patrick","date_created":1461700909,"date_modified":1461700909,"content":"There is a problem with the script which runs as root - https://github.com/Whonix/whonix-base-files/blob/master/usr/lib/anon-base-files/first-boot-skel - with the following commands.\n\n```\nsudo -u \"$user_name\" cp --verbose --no-clobber --archive --parents --recursive \"$fso_basename\" \"$home_dir\"\nsudo -u \"$user_name\" cp --verbose --no-clobber --archive \"$fso_basename\" \"$home_dir\"\nsudo -u \"$user_name\" cp --verbose --archive \"$skel_folder/.bashrc.whonix\" \"$home_dir/.bashrc\"\n```\n\n`sudo -u user` is problematic. It's useful to not have files within `/home/user` being owned by root. But when using `sudo -u user` we cannot read files from folder `/etc/skel/.gnupg`, since these are owned by root. This could be solved by using `cp` as root and the fixing ownership using `chown`. It's not great since in corner cases (power loss; race conditions) the execution could stop after `cp` ending up with files owned by root in users's home."},{"author":"Patrick","date_created":1461705616,"date_modified":1461705616,"content":"https://github.com/Whonix/whonix-base-files/commit/7dca3e197a2dce1fae27363eb412ee63f54e0b27"}]},"PHID-TASK-j2u66jubddgndchzlxab":{"id":"418","title":"create a security-misc package that turn off nautilus and dolphin file preview by default","status":"resolved","priority":"Normal","author":"Patrick","description":"As per https://github.com/QubesOS/qubes-issues/issues/1108.\n","comments":[{"author":"Patrick","date_created":1450153159,"date_modified":1450153159,"content":"https://github.com/Whonix/security-misc"},{"author":"Patrick","date_created":1450153445,"date_modified":1450153445,"content":"* https://github.com/Whonix/Whonix/commit/6994124a23d15513ebae30cda96e7eacc1b92ece\n* https://github.com/Whonix/anon-meta-packages/commit/8fe50b009a90c991e936bcec41c3b53652b8c75e\n"},{"author":"Patrick","date_created":1461267057,"date_modified":1461267057,"content":"For reference...\n`Package security-misc from Whonix to Qubes`:\nhttps://github.com/QubesOS/qubes-issues/issues/1885\n\n-----\n\ndolphin test: success\nnautilus: TODO -> T500"}]},"PHID-TASK-rkeigwhbn4le6kau32jg":{"id":"417","title":"up to date versions of Tor Browsers in newly created AppVMs inherited from updated TemplateVMs","status":"resolved","priority":"Normal","author":"Patrick","description":"Prerequisite knowledge:\nhttps://www.whonix.org/wiki/Dev/Qubes#tb-updater_vs_TemplateVM\n\nGoal:\nAfter updating the TemplateVM, at least newly created AppVMs based on the updated TemplateVM should come with an up to date version of Tor Browser.\n\nNon-goal:\nUpdating existing installations of Tor Browser in existing AppVMs. [Economically impossible in the absence of The Tor Project maintaining a proper Debian package while preserving user data (bookmarks, etc.).] Those still have to be updated with [Tor Browser's internal updater](https://www.whonix.org/wiki/Tor_Browser#Tor_Browser_Internal_Updater). If further discussion on this non-goal is required, a separate discussion should be opened.\n\nAlternative technical task title:\n`ship Tor Browser tarballs in Qubes TemplateVMs in /var/cache/tb-binary and extract in AppVMs at boot time to user's home folder`\n\nImplementation:\n\n* in tb-updater postinst / update-torbrowser\n\nDeprecated:\n\n* ~~Create a package tb-binary, that ships a folder `/var/cache/tb-binary` that includes the Tor Browser tarball `tor-browser-linux64-x.x_en-US.tar.xz` as well as signature `tor-browser-linux64-x.x_en-US.tar.xz.asc`.~~\n* ~~During boot of AppVMs, a script should check if Tor Browser is already installed in user's home folder. And if not, verify [reusing tb-updater code] and extract Tor Browser from `/var/cache/tb-binary` to user's home folder.~~\n**  ~~[The verification makes shipping malicious files in the tb-binary package less attractive.~~]\n* ~~Configurable through `/etc/torbrowser.d` folder (can be turned off).~~\n\n~~Questions~~:\n* ~~Is there any more appropriate folder than `/var/cache/tb-binary` as per FHS?~~","comments":[{"author":"Patrick","date_created":1450222091,"date_modified":1450222091,"content":"```\nallow storing downloaded archives in arbitrary folders\n\nhttps://phabricator.whonix.org/T417\n```\nhttps://github.com/Whonix/tb-updater/commit/1c85166a20af638ceab25900fb75b9f62a9645d7"},{"author":"Patrick","date_created":1451061412,"date_modified":1451061412,"content":"I can't host Tor Browser binaries.\n\nA new package has been created, but it's still boilerplate without binaries:\nhttps://github.com/adrelanos/tb-binary\n\nI can't host this for __trademark issues__, see:\nhttps://www.whonix.org/wiki/Tor_Browser#Not_installed_by_Default_Footnote\n\nAlso __source code license__ is too difficult to get right, see:\nhttps://github.com/adrelanos/tb-binary/blob/master/debian/copyright\n\nAnd I don't know if there is such a thing as a __compilation license__ of the binary itself.\n\nThis is going to be very ugly. This will __bloat Whonix source code size__. All the old binaries of Tor Browser will be kept by git as newer versions are added. Removing them, rewriting git history, would require to use ugly things such as `git push --force` and `git merge --force`. I really appreciated suggestions on how this could be implemented less ugly."},{"author":"Patrick","date_created":1452010667,"date_modified":1452010667,"content":"As discussed at 32c3, a tb-binary package is the wrong way to implement this. Instead, Tor Browser will be downloaded during postinst of tb-updater. Will be done in T461."},{"author":"Patrick","date_created":1452011402,"date_modified":1452011402,"content":"This isn't done. Just the implementation details changed."},{"author":"Patrick","date_created":1452035940,"date_modified":1452035940,"content":"`work on up to date versions of Tor Browser in newly created AppVMs`:\nhttps://github.com/Whonix/tb-updater/commit/cbdb6924e6deeae1381e8e4c3a6812ba71bacd46"},{"author":"Patrick","date_created":1452036081,"date_modified":1452036081,"content":"TLDR:\nWould installation of Whonix packages to build Qubes-Whonix happen inside a Qubes TemplateVM* or inside a chroot? @marmarek\n\n*Or StandaloneVM. [Or TemplateBasedVM for testing purposes.]\n\nLong:\nBackground:\nI need to know this for  T461 (`Installation from Repository / proverbial \"sudo apt-get install whonix\"`). The initial installation of Tor Browser either happens inside a TemplateVM or a chroot.\n\nMore background:\nThe tb-updater postinst mechanism to download Tor Browser archives to `/var/cache/tb-binary` makes only sense in a TemplateVM. So I will detect this from the tb-updater postinst script. Building Whonix may be a special case. The initial installation of Tor Browser might happen from within a chroot. Depending on how we want this ticket to work out.\n\nEven more background:\nThe tb-updater postinst mechanism to download Tor Browser archives to /var/cache/tb-binary makes only sense in a TemplateVM.\n* TemplateBased or Standalone AppVMs would just update using Tor Browser's internal updater. Or download a new Tor Browser using tb-updater to the home folder.\n* TempalteVMs would store Tor Browser archives to `/var/cache/tb-binary`, so newly created TemplateBased [or Standalone] AppVMs would start with an update to date version of Tor Browser, which is the goal of this ticket."},{"author":"marmarek","date_created":1452040398,"date_modified":1452040398,"content":">   Would installation of Whonix packages to build Qubes-Whonix happen inside a Qubes TemplateVM* or inside a chroot? @marmarek\n\nchroot."},{"author":"Patrick","date_created":1452098034,"date_modified":1452098034,"content":"`work on up to date versions of Tor Browser in newly created AppVMs`:\nhttps://github.com/Whonix/tb-updater/commit/b2b79121d7149d09ce7d5d20dec766e231db4223\n\nThis feature is being documented here:\nhttps://www.whonix.org/wiki/Tor_Browser#tb-updater_postinst\n"},{"author":"Patrick","date_created":1452101052,"date_modified":1452101052,"content":"Please leave some feedback on the #usability impact here. I appreciated a small \"okay\" message. @bnvk @mfc @marmarek\n(To avoid spending time on implementing something we later decide to not enable by default.)\n\nImplementing this feature would make upgrading the Qubes-Whonix-Workstation on every #tb-updater package upgrade (on new Tor Browser releases) at least 6 minutes slower. On slower [Tor] connections it could easily take 12 or more minutes.\n\nThe worst case here would be users that only use a single Qubes-Whonix-Workstation TemplateBased AppVM and sticking with it for a long time. These would not benefit from this feature.\n\n[Presuppose they keep their TempalteVM up to date.]\nUsers who would benefit from this feature would be users who often create new AppVMs. These would start with an up to date version of Tor Browser when they create new AppVMs. Therefore would not need to update Tor Browser using Tor Browser's internal updater in newly created AppVMs.\n\nVery likely (depending on how DispVMs will be implemented in future), this feature is required to have Qubes-Whonix-Workstation based DispVMs start with up to date versions of Tor Browser.\n\nSpeaking here about the default settings. This could be disabled by advanced users as [documented](https://www.whonix.org/wiki/Tor_Browser#tb-updater_postinst).\n\nDon't worry. It's not rocket science to implement this. And fun work.\n"},{"author":"mfc","date_created":1452101810,"date_modified":1452101810,"content":"Patrick (Patrick Schleizer):\n>   Very likely (depending on how DispVMs will be implemented in future), this feature is required to have Qubes-Whonix-Workstation based DispVMs start with up to date versions of Tor Browser.\n\nIs this the case with how DispVMs are currently implemented? It would be\nideal to get to the state where the user can create Tor Browser DispVMs\nthat are up-to-date."},{"author":"Patrick","date_created":1452102106,"date_modified":1452107538,"content":"mfc (mfc):\n> Is this the case with how DispVMs are currently implemented?\n\nYes.\n\n> It would be ideal to get to the state where the user can create Tor Browser DispVMs that are up-to-date.\n\nIf nothing goes wrong, this is close (Whonix 13)."},{"author":"marmarek","date_created":1452118648,"date_modified":1452118648,"content":">>! In T417#7845, @Patrick wrote:\n> Implementing this feature would make upgrading the Qubes-Whonix-Workstation on every #tb-updater package upgrade (on new Tor Browser releases) at least 6 minutes slower. On slower [Tor] connections it could easily take 12 or more minutes.\n\nIMHO not a big problem. And if it is, user can disable this feature (as you pointed in documentation).\n\n> The worst case here would be users that only use a single Qubes-Whonix-Workstation TemplateBased AppVM and sticking with it for a long time. These would not benefit from this feature.\n\nHow does Tor Browser internal updater work? Maybe it can be configured to look for a package downloaded by `tb-updater` package first? Just an idea, ignore if not trivial.\n\n> Very likely (depending on how DispVMs will be implemented in future), this feature is required to have Qubes-Whonix-Workstation based DispVMs start with up to date versions of Tor Browser.\n\nYour idea of DispVMs (read-only private image, instead of no private image) makes it not so obvious. If DispVM could be started out of any AppVM, then user could have already installed Tor Browser in that VM (used for DispVM).\nBut generally IMHO we should think how to make use of already downloaded Tor Browser in that case. To simplify update procedure. It would be terrible UX if user is required to update some applications separately (->manually) from package manager (->done by management stack in the future as one-click button for the whole system).\n\nSo, generally I like the approach presented here."},{"author":"Patrick","date_created":1452119147,"date_modified":1452119147,"content":"Thanks! So I will work on completing this feature.\n\n>>! In T417#7852, @marmarek wrote:\n> How does Tor Browser internal updater work? Maybe it can be configured to look for a package downloaded by `tb-updater` package first? Just an idea, ignore if not trivial.\n\nIt uses different files for that. `.mar` files. And Firefox's update magic. Really non-trivial. Unfortunately. Otherwise I also had in mind to initiate updating Tor Browser automatically in AppVMs [in background] by starting/scripting its updater. Too fragile/difficult. (rejected ticket: https://trac.torproject.org/projects/tor/ticket/17136) Would have to manually figure out the correct `.mar` file. Could not use the internal logic to fetch the right one as this is not provided by the command line interface.\n"},{"author":"Patrick","date_created":1452119780,"date_modified":1452119780,"content":"```\navoid requirement for sudoers exception thanks to suggestion by @marmarek ;\nwork on up to date versions of Tor Browser in newly created AppVMs\n```\nhttps://github.com/Whonix/tb-updater/commit/e3c3b0b816cba1a65992b8810517f9f2c76b181e"},{"author":"Patrick","date_created":1452190920,"date_modified":1452190920,"content":"Do you think it would be crazy to download and extract Tor Browser to `/etc/skel` rather than `/var/cache/tb-binary`? It would violate Debian policy. (Non-packaging software writing to `/etc`.) But it would be a bit simpler. Then [/usr/lib/anon-base-files/first-boot-skel](https://github.com/Whonix/whonix-base-files/blob/master/usr/lib/anon-base-files/first-boot-skel) would automagically keep care of copying Tor Browser to the user's home. No separate tb-updater specific `/var/cache/tb-binary` to user home population systemd service required then. @marmarek"},{"author":"marmarek","date_created":1452207293,"date_modified":1452207293,"content":"I'm not sure. Technically it sounds good, but I feel it's something wrong..."},{"author":"Patrick","date_created":1452220468,"date_modified":1452220468,"content":"Alright. tb-updater got its own first-boot-home-population systemd service.\n\nhttps://github.com/Whonix/tb-updater/commit/b51d4580dc2f056e78ea7d83a65d0dd2f763c492"},{"author":"Patrick","date_created":1452220696,"date_modified":1452220696,"content":"`systemd packaging`\nhttps://github.com/Whonix/tb-updater/commit/2324576595df433cd6614d591f777ec9e7244bde"},{"author":"Patrick","date_created":1452221733,"date_modified":1452221733,"content":"It works! We have Tor Browser in Qubes-Whonix-Workstation DispVMs now!"},{"author":"mfc","date_created":1452253550,"date_modified":1452253550,"content":"niiiiiiiiice!!"},{"author":"Patrick","date_created":1460149585,"date_modified":1460149585,"content":"```\nmoved hardcoded version for postinst into its own file for easier maintenance\n\n/usr/share/tb-updater/tbb_hardcoded_version\n\nhttps://phabricator.whonix.org/T417\n```\nhttps://github.com/Whonix/tb-updater/commit/e9469d65c457dec971a2ce31521f1707a7d69deb"},{"author":"Patrick","date_created":1461648158,"date_modified":1461648158,"content":"https://github.com/Whonix/qubes-whonix/commit/8438d13d75822e9ea800b9eb6024063f476636ff\nhttps://github.com/Whonix/tb-updater/commit/1620a4361ca719089be43bb717dcbd4536198e10\n"},{"author":"Patrick","date_created":1461905737,"date_modified":1461905737,"content":"TODO\n\n`1)` \n\nOn manual run of update-torbrowser in TemplateVM stores Tor Browser still in the home folder, so up to date versions of Tor Browsers in newly created AppVMs are not inherited from updated TemplateVMs.\n\n(Currently only works when update-torbrowser is run during tb-updater package upgrade.)\n\nSomewhat counter intuitive. Probably. And should be fixed.\n\n`2)`\n\nMinor, cli output should explain hardcoded version number."},{"author":"Patrick","date_created":1461976927,"date_modified":1461976927,"content":"That is done.\n\nhttps://github.com/Whonix/tb-updater/commit/0f116907a9911161e4ae9837a2f1766c674313c4\nhttps://github.com/Whonix/tb-updater/commit/aec876116f900c6450325f5896b09349a92a5e88\nhttps://github.com/Whonix/tb-updater/commit/5424e6bad9175dc5fc917865792a649f6450e604\nhttps://github.com/Whonix/tb-updater/commit/90bc9f530ec132255248509095b664540acf1527\nhttps://github.com/Whonix/tb-updater/commit/0991750e8255fb80d94b9cb41249fadbd2c2753c\nhttps://github.com/Whonix/tb-updater/commit/38881d0ee10a62182637a632c4dba48ee717ac88\nhttps://github.com/Whonix/tb-updater/commit/a7d5e57884ced88f9dc7a733638312e94d135870\n"},{"author":"Patrick","date_created":1461977575,"date_modified":1461977575,"content":"Problem:\n\nUpgraded TemplateVMs - i.e. installed prior Whonix 13 - will still have Tor Browser installed in their home folder. Since the home folder of TemplateVMs is still always and by default inherited by TemplateBasedVMs as of Qubes R3.1 (R3.2 probably also), this feature does not work. (Because TemplateVM home contains old version, which gets inherted by TemplateBasedVM and the new tb-updater first boot population systemd service will not touch existing folders.)\n\nTODO:\n\n* 1) Decide how to resolve the station. Either\n** a) delete folders ~/.tb and ~/cache/tb using a maintainer script during template upgrade\n** b) or better move these folders somewhere out of the way, to avoid the user having data loss (customized Tor Browser in TemplateVM) [and avoid eventual bugs from causing damage such as running the deletion code in a non-TemplateVM]\n** c) not automate it, but inform the user about this inside the tb-updater output\n** d) do nothing about it, wait and see if Qubes R4 will no longer inherit TemplateVMs home folder\n* 2) Implement the solution.\n"},{"author":"Patrick","date_created":1462398703,"date_modified":1462398703,"content":"chosen c)\n\nhttps://github.com/Whonix/tb-updater/commit/dd33b036ac8a5c0d0466983ed1e6c52ae1684eda"}]},"PHID-TASK-y2qhysozeqruwaghym3t":{"id":"416","title":"allow running Whonix build script as root, rework user_name","status":"resolved","priority":"Normal","author":"Patrick","description":"* https://github.com/Whonix/Whonix: `grep -r user_name`\n* https://github.com/adrelanos/qubes-template-whonix/blob/a6930867927f97eb869b9bf01f63a9d9ba1ad728/whonix-gateway/04_install_qubes_post.sh#L129-L134\n* https://github.com/Whonix/anon-shared-build-inst-tb/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/70_torbrowser\n** `sudo -E -u user /usr/bin/update-torbrowser --devbuildpassthrough`:\n*** `rm: cannot remove '/root/.cache/tb/temp_dir': Permission denied`\n*** `mkdir: cannot create directory '/root': Permission denied`","comments":[{"author":"Patrick","date_created":1461104312,"date_modified":1461104312,"content":"This is covered by T498."}]},"PHID-TASK-y6zleeqwgh4juuf2iydh":{"id":"415","title":"rerunning 'make get-sources' breaks Qubes Builder","status":"resolved","priority":"High","author":"Patrick","description":"When rerunning `make get-sources`, it breaks for the Whonix folder (https://github.com/Whonix/Whonix).\n\n```\n--> Downloading additional sources for Whonix...\n+ make --quiet -C qubes-src/Whonix get-sources\n```\n\nI could implement a dummy in #makefile-generic-packages (genmkfile). Easy.\n\nDo you think there is a more appropriate solution? And anything else that should be implemented?\n\n(There already is an empty Makefile.builder [https://github.com/Whonix/Whonix/blob/master/Makefile.builder].)\n","comments":[{"author":"Patrick","date_created":1444564244,"date_modified":1444564244,"content":"Workaround for now.\n\n* https://github.com/Whonix/genmkfile/commit/a3d12835eee3f51b10356ee9735c46a4c50db4e2\n* https://github.com/Whonix/Whonix/commit/4edfb4fb1847a9cf6862d2df042d8a21e8b45d89\n"},{"author":"Patrick","date_created":1444811485,"date_modified":1444811485,"content":"@marmarek what do you think?"},{"author":"marmarek","date_created":1444847653,"date_modified":1444847653,"content":"qubes builder check if `get-sources` and `verify-sources` targets exist\n(with `make -n get-sources verify-sources`), so if genmkfile creates a\nwildcard one, it needs to be somehow handled. I think creating empty\n(`true`) `get-sources` and `verify-sources` targets is ok. Or maybe you\nhave some better idea?"},{"author":"Patrick","date_created":1444849095,"date_modified":1444849095,"content":"That's fine.\n\n* https://github.com/Whonix/Whonix/commit/06544ed1c32bd2721df00ee7feae940b3b535b51\n* https://github.com/Whonix/genmkfile/commit/bbe8e989a29f1620a71e13b2ed6717ceb09d8825\n"}]},"PHID-TASK-djsva3n7qdfaip6rf3im":{"id":"414","title":"upstream bind-directories functionality to Qubes","status":"resolved","priority":"High","author":"Patrick","description":"(As discussed in https://github.com/QubesOS/qubes-issues/issues/1306#issuecomment-147111523.)\n\nUpstream https://github.com/Whonix/qubes-whonix/blob/master/usr/lib/qubes-whonix/bind-directories to Qubes.","comments":[{"author":"Patrick","date_created":1444811753,"date_modified":1444811753,"content":"Must this become a generic package? Or can this be added to qubes-core-agent?\n\nWrt [/bin/sync hangs forever in whonix-ws-dvm #1328](https://github.com/QubesOS/qubes-issues/issues/1328#issuecomment-147951214), where would be the proper place to implement this? The [`mount-home.sh`](https://github.com/QubesOS/qubes-core-agent-linux/blob/master/vm-systemd/mount-home.sh#L77-L89) script would become a `mount-dirs.sh` script?"},{"author":"marmarek","date_created":1444812776,"date_modified":1444812776,"content":"> Must this become a generic package? Or can this be added to qubes-core-agent?\n\nCan be in qubes-core-agent.\n\n> Wrt /bin/sync hangs forever in whonix-ws-dvm #1328 <https://github.com/QubesOS/qubes-issues/issues/1328#issuecomment-147951214>, where would be the proper place to implement this? The `mount-home.sh` <https://github.com/QubesOS/qubes-core-agent-linux/blob/master/vm-systemd/mount-home.sh#L77-L89> script would become a `mount-dirs.sh` script?\n\nGood idea."},{"author":"Patrick","date_created":1444818534,"date_modified":1444818534,"content":"`mount-home.sh` currently also processes `/rw/usrlocal`. Another reason to rename it to `mount-dirs.sh`.\n\nRelated to `Bind mount /rw/usrlocal -> /usr/local instead of symlink`:\nhttps://github.com/QubesOS/qubes-issues/issues/1150\n"},{"author":"Patrick","date_created":1444925305,"date_modified":1444925305,"content":"* https://github.com/marmarek/qubes-core-agent-linux/pull/35\n* https://github.com/marmarek/qubes-core-agent-linux/pull/36\n"},{"author":"Patrick","date_created":1445291176,"date_modified":1445291176,"content":"Where should this feature be configureable?\n\n* a) from TemplateVM only -> `/etc/qubes-bind-dirs.d/`, or\n* b) from TemplateBasedVM only -> `/rw/config/qubes-bind-dirs.d/`, or\n* c) both, a) and b)?\n"},{"author":"marmarek","date_created":1445291361,"date_modified":1445291361,"content":"I think both.\n\nSomehow offtopic: for per-VM configuration would you prefer `/rw/config`\n(Qubes-specific path), or `/usr/local/etc` (somehow more standard)?\nMaybe those two should be merged (using symlink)?"},{"author":"Patrick","date_created":1445293471,"date_modified":1445293471,"content":"marmarek (Marek Marczykowski-Górecki):\n> I think both.\n\nOk.\n\n> Somehow offtopic: for per-VM configuration would you prefer `/rw/config`\n> (Qubes-specific path), or `/usr/local/etc` (somehow more standard)?\n> Maybe those two should be merged (using symlink)?\n\nHm. This is an important decision. I am always having in mind and\nhoping, that some day, packages such as qubes-core-agent etc. will be\nuploaded to the official Debian archive. [So distributions such as Tails\ncould simply install it.]\n\nNeither. `/rw/` clearly violates FHS. `/usr/local/etc/` looks even more\nstrange. Debian policy forbids packages to write into `local`.\n\nWhat about `/home/config/`? Hehe. No. Same.\n\nWhat about something like `/etc/qubes/rw/`?\n\nCompatibility symlink [or better, if possible, bind-mount] is a good idea.\n\nLet's also ask at least another person. @bnvk\n\nAlso imho low priority, but okay to change."},{"author":"marmarek","date_created":1445294157,"date_modified":1445294157,"content":"> Hm. This is an important decision. I am always having in mind and\n> hoping, that some day, packages such as qubes-core-agent etc. will be\n> uploaded to the official Debian archive. [So distributions such as Tails\n> could simply install it.]\n\nI don't that would happen, at least not anytime soon. There are\nmultiple problems with that. For example need for different version\nbased on Qubes version, even on the same Debian release. But also a lot\nof work to not break the system when installed in non-Qubes environment\n(where services like qubesdb, qrexec-agent etc would fail to start).\n\n> Also imho low priority, but okay to change.\n\nYes."},{"author":"Patrick","date_created":1447360233,"date_modified":1447360233,"content":">>! In T414#7005, @Patrick wrote:\n> Where should this feature be configureable?\n> \n> * a) from TemplateVM only -> `/etc/qubes-bind-dirs.d/`, or\n> * b) from TemplateBasedVM only -> `/rw/config/qubes-bind-dirs.d/`, or\n> * c) both, a) and b)?\n\n>>! In T414#7006, @marmarek wrote:\n> I think both.\n\n1) Wrong/non-existing entries should not make the script fail, right?\n\n2) I guess, parse `/etc/qubes-bind-dirs.d/` first (lower priority), parse `/rw/config/qubes-bind-dirs.d/`afterwards (higher priority)?\n\n3) Should higher named/priority files (example: `50_user`) in `qubes-bind-dirs.d` be capable to disable items by lower priority files (example: `30_qubes`)?\n\nI assume yes for now.\n\nThis is my far from prototype test script for now.\n\n```\n#!/bin/bash\n\n#set -x\nset -e\n\nbind_directories+=('test file')\nbind_directories+=('another one')\nbind_directories+=('bar test')\n\ndelete() {\n   bind_directories=( \"${bind_directories[@]/'another one'}\" )\n}\n\n#delete\n\narray_length=\"${#bind_directories[@]}\"\ni=-1\n\nwhile true; do\n   i=$(( i + 1))\n\n   if [ \"$i\" -ge \"$array_length\" ]; then\n      break\n   fi\n\n   if [ \"${bind_directories[$i]}\" = \"\" ]; then\n      ## Fix empty or removed ones.\n      continue\n   fi\n   echo \"${bind_directories[$i]}\"\n\ndone\n```\n\nIn the `qubes-bind-dirs.d` config folders, packages or users could drop bash snippets in the following form.\n\nFor adding:\n\n```\nbind_directories+=('test file')\nbind_directories+=('another one')\nbind_directories+=('bar test')\n```\n\nOr the more difficult case of removal:\n\n```\nbind_directories=( \"${bind_directories[@]/'another one'}\" )\n```\n"},{"author":"marmarek","date_created":1447361540,"date_modified":1447361540,"content":">   1. Wrong/non-existing entries should not make the script fail, right?\n\nRight. Maybe entries like `/etc/something` -> `/rw/config/something`\nshould try to create `/rw/config/something`? Or even initialize with\noriginal `/etc/something` content? That would make per-VM configuration\nof virtually any service really easy.\n\n>   2. I guess, parse `/etc/qubes-bind-dirs.d/` first (lower priority), parse `/rw/config/qubes-bind-dirs.d/`afterwards (higher priority)?\n\nYes. Or even follow systemd practice and have\n`/usr/lib/qubes-bind-dirs.d` with lowest priority? Not sure about that.\n\n>   3. Should higher named/priority files (example: `50_user`) in `qubes-bind-dirs.d` be capable to disable items by lower priority files (example: `30_qubes`)?\n>   \n>   I assume yes for now.\n\nI think `30_qubes` in higher priority dir should override `30_qubes` in\nlower priority dir.\n\nIf we'd have `/usr/lib/qubes-bind-dirs.d` (or simply\n`/usr/lib/qubes-bind-dirs`?), then user may override it with file in\neither `/etc` (Template wide), or `/rw/config` (only one VM)."},{"author":"Patrick","date_created":1447362580,"date_modified":1447362580,"content":"marmarek (Marek Marczykowski-Górecki):\n> marmarek added a comment.\n> \n> \n>   > 1. Wrong/non-existing entries should not make the script fail, right?\n>   \n>   Right. Maybe entries like `/etc/something` -> `/rw/config/something`\n>   should try to create `/rw/config/something`?\n\nSorry, I am not getting it.\n\nYou mean it should be a simpler config file format such as\n`/etc/something1`\n`/etc/something2`\n`/etc/something3`\n?\n\nNot using the `variable+=` syntax?\n\nNot sure if I could implement that. Perhaps. Then the config parsing\ncode would be more complicated than a simple `source`.\n\n> Or even initialize with\n>   original `/etc/something` content? That would make per-VM configuration\n>   of virtually any service really easy.\n\nI am not following either.\n\n>   > 2. I guess, parse `/etc/qubes-bind-dirs.d/` first (lower priority), parse `/rw/config/qubes-bind-dirs.d/`afterwards (higher priority)?\n>   \n>   Yes. Or even follow systemd practice and have\n>   `/usr/lib/qubes-bind-dirs.d` with lowest priority? Not sure about that.\n\nCan do. Only minimally more code. (One more entry in a `for` loop.)\n\n>   > 3. Should higher named/priority files (example: `50_user`) in `qubes-bind-dirs.d` be capable to disable items by lower priority files (example: `30_qubes`)?\n>   > \n>   >   I assume yes for now.\n>   \n>   I think `30_qubes` in higher priority dir should override `30_qubes` in\n>   lower priority dir.\n\nYes. Higher priority dirs always overwrite lower priority dirs\nindependently of lexical order. (That's seemingly happening mostly\nnowadays.)\n\n>   If we'd have `/usr/lib/qubes-bind-dirs.d` (or simply\n>   `/usr/lib/qubes-bind-dirs`?),\n\nWith '.d' is better.\n\n> then user may override it with file in\n>   either `/etc` (Template wide), or `/rw/config` (only one VM).\n\nSounds good."},{"author":"marmarek","date_created":1447364399,"date_modified":1447364399,"content":"I was thinking about simple config format, very similar to the current list:\n\n```\n/rw/config/something1:/etc/something1\n/rw/config/something2:/etc/something2\n/rw/config/something3:/var/lib/something3\n```\n\nThen load them with something like:\n```\nbind_dirs=\"\"\nfor f in $(ls /usr/lib/qubes-bind-dirs.d /etc/qubes-bind-dirs.d /rw/config/qubes-bind-dirs.d | sort | uniq); do\n  if [ -r \"/rw/config/qubes-bind-dirs.d/$f\" ]; then\n    bind_dirs+=$(grep -v '^#' \"/rw/config/qubes-bind-dirs.d/$f\")\n  elif [ -r \"/etc/qubes-bind-dirs.d/$f\" ]; then\n    bind_dirs+=$(grep -v '^#' \"/etc/qubes-bind-dirs.d/$f\")\n  elif [ -r \"/usr/lib/qubes-bind-dirs.d/$f\" ]; then\n    bind_dirs+=$(grep -v '^#' \"/usr/lib/qubes-bind-dirs.d/$f\")\n  else\n    echo \"WAT?!\"\n    exit 1\n  fi\ndone\n\n# Then process loaded entries:\nfor entry in ${bind_dirs}; do\n ...\ndone\n```\nMaybe better make `${bind_dirs}` an array to better handle spaces. You're much better bash wizard than me, you'll do it right :)"},{"author":"Patrick","date_created":1448907129,"date_modified":1448907129,"content":"This is what I have for now.\n\n- https://github.com/adrelanos/qubes-core-agent-linux/tree/bind-dirs\n- https://github.com/adrelanos/qubes-core-agent-linux/commit/ad99a0ae75eb048b309d435601bba81d93af19ae\n\n- no longer requires rsync\n- now works also for files, not just folders\n- `sync` removed, should not be required\n- sorted out user access rights issues\n\nA detailed review is not required yet. It's not fully tested yet. Only a glimpse would be nice.\n\nHowever, I am wondering about the following...\n\n* 1) What to do about symlinks? Copying them as symlink is possible and implemented. But mount fails. Example.\n\n```\nmount --bind /rw/bind-dirs/etc/hosts /etc/hosts\n```\n```\nmount: special device /rw/bind-dirs/etc/hosts does not exist\n```\n\nSo we could just skip mounting for symlinks. The symlinks that are copied to `/rw/bind-dirs` do link the the proper files in the system.\n\nBut then modifications to for example `/etc/some-sym-link` would not end up in `/rw/bind-dirs`.\n\nMaybe bind-dirs should delete the old symlink `/etc/some-sym-link`. And create a new symlink for its place to `/rw/bind-dirs/etc/some-sym-link`?\n\nThe same in other words.\n\nOriginalls /etc/hosts is a symlink to /etc/hosts.anondist.\nNow the user adds /etc/hosts to bind-dirs configuration.\nbind-dirs will\n\"`unlink /etc/hosts`\"\n\"`ln -s /etc/hosts.anondist /rw/bind-dirs/etc/hosts`\"\n\"`ln -s /rw/bind-dirs/etc/hosts /etc/hosts`.\"\n\n(Cannot `mv` symlinks - would not work for relative symlinks.)\n\nA two layered symlink. But I guess that could cause some issues.\n\nAnother option would be follow the symlink. Copy the file it links to to /rw/bind-dirs. Then mount it as usual. However, I don't know if that could also cause issues. Perhaps if any scripts check if they got the symlink or otherwise. Probably less issues than above.\n\n* 2) What about file system objects added to bind-dirs list, that do not exist? Fail closed, abort, exit error? Fail silent, open? Write to stderr, continue, fail open?\n\n* 3) What about other file system objects such as block, character, fifo, special, device, ... (?)?"},{"author":"Patrick","date_created":1448919700,"date_modified":1448919700,"content":"Posting the old [notes](https://github.com/Whonix/qubes-whonix/blob/0b3952c8aebb16238731002e8f5baac5e8c4e4bf/NOTES#L3-L24) by @nrgaway here.\n\n>     'bind-directories' will automatically bind important Whonix configuration\n>     directories within root image filesystem to the users /rw/ filesystem so the\n>     changes will persist upon reboot eliminating the need to have Whonix be a\n>     standalone VM.\n> \n>     The first time an AppVM is started the original content from the root image\n>     are copied to the users /rw directory (one-time) to make sure any changes\n>     that have already been made in template are reflected in AppVM.\n> \n>     Any further changes, like enabling 'Tor' are stored directly in the 'rw'\n>     filesystem.  For example '/etc/tor' is bound to '/rw/Whonix/etc/tor'.\n> \n>     If a user then makes any changes in the TemplateVM, those changes will not\n>     be reflected in the AppVM after the initial bind which may cause confusion\n>     if a user is attempting to make configuration changes in the TemplateVM.\n> \n>     Possible solutions:\n>       - track original date / shasum of files when originally copying defaults to /rw\n>       - store that in /rw as .bind-dirs/filename ?\n>       - before binding; check for changes; update rw if there are changes; maybe\n>         just using file date would work?\n\n"},{"author":"Patrick","date_created":1448922482,"date_modified":1448922482,"content":">>! In T414#7386, @Patrick wrote:\n> Posting the old [notes](https://github.com/Whonix/qubes-whonix/blob/0b3952c8aebb16238731002e8f5baac5e8c4e4bf/NOTES#L3-L24) by @nrgaway here.\n> \n>>     'bind-directories' will automatically bind important Whonix configuration\n>>     directories within root image filesystem to the users /rw/ filesystem so the\n>>     changes will persist upon reboot eliminating the need to have Whonix be a\n>>     standalone VM.\n>> \n>>     The first time an AppVM is started the original content from the root image\n>>     are copied to the users /rw directory (one-time) to make sure any changes\n>>     that have already been made in template are reflected in AppVM.\n>> \n>>     Any further changes, like enabling 'Tor' are stored directly in the 'rw'\n>>     filesystem.  For example '/etc/tor' is bound to '/rw/Whonix/etc/tor'.\n>> \n>>     If a user then makes any changes in the TemplateVM, those changes will not\n>>     be reflected in the AppVM after the initial bind which may cause confusion\n>>     if a user is attempting to make configuration changes in the TemplateVM.\n\nRight. I recognize the issue. We're adding another layer of complexity. Not great. Likely to cause confusion. However, I don't think there can be a solution to this issue. What we could consider would be something more drastic. [1]\n\n>>     Possible solutions:\n>>       - track original date / shasum of files when originally copying defaults to /rw\n>>       - store that in /rw as .bind-dirs/filename ?\n>>       - before binding; check for changes; update rw if there are changes; maybe\n>>         just using file date would work?\n\nOkay, let's say you somehow found a modification. Was it done by the user or by the package manager? To my knowledge, there is no way to reliably distinguish this. But let's put that aside for now. Let's say the user made a modification. Now, we might have two modified versions. For example a modified /etc/tor/torrc in the Whonix-Gateway TemplateBasedProxyVM, and a different modified /etc/tor/torrc inside the whonix-gw TemplateVM. Which changes we keep, which ones we discard? Do we [silently] discard settings that were made in the TemplateBasedVM? Sounds confusing. Ask the user to merge them? Probably not. Do we try something as crazy as automatically merging them? Probably not. I don' think this is solvable, but I am happy to hear ideas.\n\nWhat however might be doable, would be the following.\n- somehow track the file hashes of the files from non-persistent\n- track the file hashes of rw once we initially copy them over from non-persistent to rw\n- notice changes in the non-persistent folders (after TemplateVM upgrades)\n- now if the file in rw is still unmodified, we could copy over the modified version from non-persistent to rw to update the stale one on rw\n\nBut I think instead of making things easier, it would only add even more complexity and confusion.\n\n-----\n\n[1] two different drastic ideas that do not rely on bind-directories\n\n* 1) Making Whonix-Gateway ProxyVM a standalone VM by default. Not great for backups. Would waste space using Qubes usual backups. But while Whonix-Gateway backups are useful - keeping [Tor entry guards](https://www.torproject.org/docs/faq.html.en#EntryGuards); keeping Tor/Firewall config, perhaps keeping misc other config - is not super important. And also not well documented/encouraged at the moment.\n\n* 2) Configure/hack Tor running as user `user` rather than system user `debian-tor`. Then Tor persistent data would be stored in the user's home folder. Other stuff such as Whonix Firewall settings are much less problematic and could also be stored in the user's home folder instead.\n\nMaybe these are some interesting future directions. If this sounds interesting, we can move that discussion into a separate ticket.\n\n(Even in case we decided to not use bind-directories by default it would be useful to finish this tool even if it will not be used by default.)"},{"author":"marmarek","date_created":1449364719,"date_modified":1449364719,"content":">   [1] two different drastic ideas that do not rely on bind-directories\n>   \n>   - 1) Making Whonix-Gateway ProxyVM a standalone VM by default. Not great for backups. Would waste space using Qubes usual backups. But while Whonix-Gateway backups are useful - keeping Tor entry guards <https://www.torproject.org/docs/faq.html.en#EntryGuards>; keeping Tor/Firewall config, perhaps keeping misc other config - is not super important. And also not well documented/encouraged at the moment.\n\nIt isn't only about backups. It's also about disk space on actual\nsystem.\n\n>   - 2) Configure/hack Tor running as user `user` rather than system user `debian-tor`. Then Tor persistent data would be stored in the user's home folder. Other stuff such as Whonix Firewall settings are much less problematic and could also be stored in the user's home folder instead.\n\nThis doesn't solve anything. Still that config will initialized from\nsomewhere, then stored in home directory and not updated (from initial\nsource) ever. So basically you have the same \"problem\" as with bind\ndirectory, but moved to home.\n\nI think the one time synchronization (at the first VM start time) is the way\nto go."},{"author":"Patrick","date_created":1449404962,"date_modified":1449404962,"content":"marmarek (Marek Marczykowski-Górecki):\n>   This doesn't solve anything. Still that config will initialized from\n>   somewhere, then stored in home directory and not updated (from initial\n>   source) ever. So basically you have the same \"problem\" as with bind\n>   directory, but moved to home.\n\nRight. But such an implementation wouldn't require the bind-dirs script.\nAnd from perspective of a user trying to grasp this, it's a bit simpler,\nI suppose."},{"author":"Patrick","date_created":1449421292,"date_modified":1449421292,"content":"marmarek (Marek Marczykowski-Górecki):\n>   It isn't only about backups. It's also about disk space on actual\n>   system.\n\nYes. However, in case of the Whonix-Gateway ProxyVM, I don't think one\nneeds that many of them. Creating a TemplateBased one doens't give that\nmany advantages. It's just easier purging them and creating a new one.\nIn case of the workstation however, TemplateBased VMs are more useful."},{"author":"Patrick","date_created":1450396845,"date_modified":1450396845,"content":"Implemented a simple way to handle symlinks pointing to files.\n1) see where it really links to\n2) unlink the original symlink\n3) copy the target where it really links to\n4) then handle that file normally\n\nhttps://github.com/adrelanos/qubes-core-agent-linux/commit/4b46a658dbe0e0d7b6e11a8625161525cf82e60f"},{"author":"Patrick","date_created":1450398050,"date_modified":1450398050,"content":"Undone the above approach. Trying to implement the same for symlinks pointing to directories was a mess. (And writing to rw was strange anyhow.)\n\nUsing an even simpler mechanism now. Resolving where there symlink points to, and using for bind mount instead.\n\nhttps://github.com/adrelanos/qubes-core-agent-linux/commit/eed39067adc24d825d124eb12d91bd65a61e65ee\n"},{"author":"Patrick","date_created":1451047203,"date_modified":1451047203,"content":"https://github.com/marmarek/qubes-core-agent-linux/pull/58\n\n-----\n\nOptional debug script that may be useful.\n\n```\n#!/bin/bash\nset -x\nset -e\n\numount /etc/testdir || true\numount /etc/testsymlink || true\nrm -r /etc/testsymlink || true\nrm -r /etc/testdir || true\nmkdir /etc/testdir\necho test > /etc/testdir/a\nln -s /etc/testdir /etc/testsymlink\nls -la /etc/testsymlink\nls -la /etc/testsymlink/\n\nsleep 1\n\nsudo ./misc/bind-dirs 1\nsudo rm -r /rw/bind-dirs\nsudo ./misc/bind-dirs\nls -la /etc/hosts\nls -la /rw/bind-dirs/etc/hosts\n```\n"},{"author":"Patrick","date_created":1461273365,"date_modified":1461273365,"content":"`upstream bind-directories functionality to Qubes` is done. Follow up task: T501"}]},"PHID-TASK-liwnnmvkkdmidgz7qxht":{"id":"413","title":"no more whonixcheck bootstrap progress bar on autostart","status":"resolved","priority":"Normal","author":"Patrick","description":"As discussed with @bnvk and @mfc the new plan for #whonixcheck is.\n\n* no progress bars at all during autostart\n* passive popup ok after Tor connected in all cases\n\nI.e. the following passive popups will be shown.\n\n1. starting sys-whonix (by Qubes VM Manager)\n2. sys-whonix started (by Qubes VM Manager)\n3. Tor bootstrap in progress. (by sys-whonix)\n4. Tor bootstrap done. (by sys-whonix)\n\nThis is currently blocked by a missing Qubes feature:\n[Centralized Tray Notifications](https://github.com/QubesOS/qubes-issues/issues/889)\n([explaination](https://github.com/QubesOS/qubes-issues/issues/889#issuecomment-146577801))\n\nThis is done in whonixcheck. Branch:\nhttps://github.com/Whonix/whonixcheck/tree/only_two_passive_popups_on_autostart\n","comments":[{"author":"Patrick","date_created":1444327304,"date_modified":1444327304,"content":"Thanks to @marmarek's suggestion (https://github.com/QubesOS/qubes-issues/issues/889#issuecomment-146583491) this has been implemented for #Whonix_12 using `notify-send`.\n\n`- use notify-send in Qubes by default, because that looks better in Qubes than kdialog (thanks to @marmarek for the suggestion) - https://github.com/QubesOS/qubes-issues/issues/889#issuecomment-146583491`\n`- fixed usage of notify-send, it uses milliseconds rather than seconds (thanks to @marmarek for the suggestion)`\n`- refactoring`:\nhttps://github.com/Whonix/msgcollector/commit/87d0d8fa4f494a77dcf16b2a62e0eea82db6fc79\n\n`no more progress bars, only two passive popups on autostart`:\nhttps://github.com/Whonix/whonixcheck/commit/600478aeb8f4b0be8077cd6dfe47d63d9dc3e1f2\n"}]},"PHID-TASK-mc2dfou746tpretsy3lo":{"id":"412","title":"KVM: document qxl slowness fix","status":"resolved","priority":"Normal","author":"Patrick","description":"Add https://www.whonix.org/forum/index.php/topic,1454.msg9178.html#msg9178 to KVM documentation https://www.whonix.org/wiki/KVM.","comments":[{"author":"HulaHoop","date_created":1449603134,"date_modified":1449603134,"content":"Package cleaned up, tested and merged. Should be available in Whonix 13."},{"author":"Patrick","date_created":1449604026,"date_modified":1449604026,"content":"This ticket is for documenting it in meanwhile. Not the package level fix."},{"author":"HulaHoop","date_created":1449890463,"date_modified":1449890463,"content":"Pinned topic in subforum. I don't think it should be officially documented because its not a long term problem.\n\nClosing."}]},"PHID-TASK-6qn7vlmnayhy2zba4peh":{"id":"411","title":"Alternative TLD Proposal Impact on Whonix","status":"open","priority":"Normal","author":"HulaHoop","description":"This is a proposal for accessing the alternative TLD space by Tor users:\n\nhttps://lists.torproject.org/pipermail/tor-dev/2015-September/009600.html\n\nTODO:\n\nAsk if the the choice of localhost address for running anycast daemons will affect Whonix Gateway and its impact on security.","comments":[{"author":"Patrick","date_created":1458644304,"date_modified":1458644304,"content":"This does not appear to have gotten any interest from the Tor developers?"},{"author":"HulaHoop","date_created":1458659148,"date_modified":1458659148,"content":"Agreed. This hasn't been finalized into a proposal."},{"author":"Patrick","date_created":1459368179,"date_modified":1459368179,"content":"Let's recheck this later."},{"author":"HulaHoop","date_created":1475618825,"date_modified":1475618825,"content":"a name resolution agnostic API supported by Tor is planned and proposals soon suggested.\n\nhttps://phabricator.whonix.org/T376#10672"}]},"PHID-TASK-r2p7xctyrs5szvab535t":{"id":"410","title":"grsecurity: whonixcheck pops up warnings when it can't see tor's pid in /proc","status":"wontfix","priority":"Wishlist","author":"hitithard","description":"This is horribly annoying. With grsecurity or hidepid=2 --which imo should be the default in any security-focused distro--whonixcheck generates periodic warnings that Tor's pid hasn't been found.\n\nA libnotify-style notification would be less annoying.","comments":[{"author":"hitithard","date_created":1444933496,"date_modified":1444933496,"content":"hidepid=2 isn't a grsecurity feature (though it was inspired by grsecurity)."},{"author":"Patrick","date_created":1444937895,"date_modified":1444937895,"content":"We currently don't have a maintainer dedicated to grsecurity. The only way for now to make this happen is suggesting a patch."}]},"PHID-TASK-33twdtccuyx65j24qxgv":{"id":"409","title":"qubes-whonix-network.service doesn't provide helpful error message when !CONFIG_DUMMY","status":"invalid","priority":"Wishlist","author":"hitithard","description":"General background:\n\nhttps://github.com/EFForg/https-everywhere/commit/79d6ffdb8a9a48220efb0f0a39160cc4e6f9aa2c\nhttps://github.com/EFForg/https-everywhere/issues/2842#issuecomment-143905350\n(The DoS was from Tor's control port).\n\nThere are a few problems that are making me weary of using whonix-gw again, and the first prerequisite is this.\n\nRemoving the modprobe line in network-proxy-setup doesn't fix this.\n\nsys-net, sys-firewall, and whonix-ws all work fine with grsecurity enabled and the rootkit interface disabled.","comments":[{"author":"Patrick","date_created":1444129469,"date_modified":1444129469,"content":"> General background:\n\nSorry, I don't understand the general background.\n\n> the rootkit interface disabled\n\nWhich rootkit interface?\n\n-----\n\nPlease provide steps to reproduce, expected result and actual result."},{"author":"hitithard","date_created":1444933058,"date_modified":1444933058,"content":">>! In T409#6836, @Patrick wrote:\n>> General background:\n> \n> Sorry, I don't understand the general background.\nThe general background is that ~10 minutes after contacting my own coutry's intelligence agency about another country's intelligence agency I recieved a DoS from tor's control port (whonix-gw on Qubes vanilla kernel) to whonix-ws (using grsecurity). After talking to Peter (pde) at the EFF about the logs, which showed searching for some magic sequence (similar to SYNful ACK, but different), my Qubes machine was wiped overnight.\n> \n>> the rootkit interface disabled\n> \n> Which rootkit interface?\n\"rootkit interface\" is a sarcastic reference to CONFIG_MODULES, since that is what it serves as.\n> -----\n> \n> Please provide steps to reproduce, expected result and actual result.\n\nSorry, I was wrong. It wasn't a problem with CONFIG_MODULES, I simply hadn't tested every combination (kernel recompilation fatigue).\n\nThe actual problem was not having DUMMY. I think perhaps there should be a specific error message for that case.\n\nI also noticed that when either ipv6 is disabled or some tables that whonix-gw doesn't use but does flush aren't in the kernel, the firewall script fails. I think the firewall script ought to use sysctl to check whether related sysfs entries exist and continue (not fail) if they don't exist."},{"author":"Patrick","date_created":1444938286,"date_modified":1444938286,"content":"We currently don't have a maintainer dedicated to grsecurity. The only way for now to make this happen is suggesting a patch.\n\n> I also noticed that when either ipv6 is disabled or some tables that whonix-gw doesn't use but does flush aren't in the kernel, the firewall script fails. I think the firewall script ought to use sysctl to check whether related sysfs entries exist and continue (not fail) if they don't exist.\n\nIt works good enough for us for now. Should be posted in separate issue. Patches are happily considered."},{"author":"Patrick","date_created":1550479068,"date_modified":1550479068,"content":"Since #grsecurity is not a thing anymore, closing this as invalid."}]},"PHID-TASK-epod6nvhe4jindlomc7y":{"id":"408","title":"--synthcpu was removed from VirtualBox, use --cpuid-portability-level or --cpuidremoveall?","status":"resolved","priority":"Normal","author":"Patrick","description":"`--synthcpu` was removed in VirtualBox `5`?\n\nLet's try some likely newly available options.\n\n* `--cpuid-portability-level 3`\n* `--cpuid-portability-level 999`\n* `--cpuidremoveall`\n\nInfo:\n\n* https://github.com/Whonix/Whonix/blob/f6450d0bf562d32d8bc63b77ef61ae08f36b1cf4/build-steps.d/2600_create-vbox-vm#L53\n* https://forums.whonix.org/t/guest-systems-sees-cpu-of-the-host/1413/11\n\nTODO:\n\n\n* Set the new option for exiting VMs.\n** See if it works.\n** See if there are any negative implications performance or stability wise (some applications no longer working).\n* Set the new option during build.\n* Test.\n","comments":[{"author":"Patrick","date_created":1449321925,"date_modified":1449321925,"content":"TNT_BOM_BOM tested out in the forums, that `--cpuidremoveall` fails to result in the desired effect. Hence nothing can be done about this."},{"author":"Patrick","date_created":1484647376,"date_modified":1484647376,"content":"https://github.com/Whonix/Whonix/commit/6db3c345c80ee9841fcae57621cafbfcdd000a0f"},{"author":"dumbmouse","date_created":1484715583,"date_modified":1484715583,"content":"After much research this is the best way to hide the CPU using VirtualBox:\n\n# Set vendor_id to \"GenuineIntel\"\n--cpuidset 00000000 0x00000005 0x756e6547 0x49656e69 0x6c65746e\n--cpuidset 80000000 0x80000008 0x756e6547 0x49656e69 0x6c65746e\n\n# Set family/model/stepping (15/4/3), and feature flags (most are overridden by cpuid-portability-level any way)\n--cpuidset 00000001 0x00000f43 0x00020800 0x0000649d 0xbfebfbff\n--cpuidset 80000001 0x00000f43 0x00020800 0x0000649d 0xbfebfbff\n\n# Set model name to \"Intel(R) Pentium(R) 4 CPU 3.00GHz\"\n--cpuidset 80000002 0x20202020 0x20202020 0x20202020 0x6e492020\n--cpuidset 80000003 0x286c6574 0x50202952 0x69746e65 0x52286d75\n--cpuidset 80000004 0x20342029 0x20555043 0x30302e33 0x007a4847\n\n# Remove most feature flags\n--cpuid-portability-level 3\n\nThis should work on all host x86 CPUs. I have tested on only Intel. Performance impact should be the same as --synthcpu (no different to now).\n\n\n-------\n\nReference notes for anyone investigates this later:\n\n--cpuid-portability-level is the successor of --synthcpu and does all/most of the same things\n\n--cpuidremoveleaf and --cpuidremoveall modify the .vbox config file only. They remove CPUID overrides added by --cpuidset. Beside that they have no effect.\n\nA better solution if it worked would be to set VBoxInternal/CPUM/GuestCpuName to \"Intel(R) Pentium(R) 4 CPU 3.00GHz\". GuestCpuName makes VirtualBox load all CPUID leaves and MSRs from its internal database of CPUs and their data, overriding all host CPU data. Unfortunately in testing only about 25% of CPUs actually work and whether they work or not probably depends on the host CPU so it is not suitable for general distribution. Maybe GuestCpuName will improve some time.\n\nTo change the vendor_id or model name hex use the scripts here:\nhttps://superuser.com/questions/625648/virtualbox-how-to-force-a-specific-cpu-to-the-guest\n\nSetting VBoxInternal/CPUM/HostCPUID/... has the same affect as --cpuidset but --cpuidset is documented and better to use.\n\nRelated source files:\n\n# Primary file. Reads host CPU info and configuration overrides and passes it through or masks it\nVBox/VMM/VMMR3/CPUMR3CpuId.cpp\n\n# Related to GuestCpuName\nVBox/VMM/VMMR3/CPUMR3Db.cpp\nVBox/VMM/VMMR3/cpus/\nVBox/VMM/VMMR3/cpus/Intel_Pentium_4_3_00GHz.h\n\n# Pretty obvious\nVBox/Frontends/VBoxManage/VBoxManageHelp.cpp\nVBox/Frontends/VBoxManage/VBoxManageModifyVM.cpp"},{"author":"Patrick","date_created":1484717367,"date_modified":1484717367,"content":"Thanks! Without your research, this almost certainly would not have had a chance to make it into #whonix_14. Can you commit your changes to git please? (And/or create a github pull request?)\n\nhttps://github.com/Whonix/Whonix/blob/master/build-steps.d/2600_create-vbox-vm\n\nThen I can try out your suggested changes in the next build."},{"author":"dumbmouse","date_created":1484719450,"date_modified":1484719450,"content":"Actually I need to test this more. I will fine tune it and add another comment here in couple of days."},{"author":"Patrick","date_created":1484721358,"date_modified":1484721358,"content":"Alright, great!"},{"author":"dumbmouse","date_created":1485028799,"date_modified":1485028799,"content":"Here is a more limited version, but better for general distribution:\n\n```# Clear existing (not necessary for initial install)\nvboxmanage modifyvm <uuid> --cpuidremoveall\n\n# GenuineIntel\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/00000000/ebx 0x756e6547\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/00000000/ecx 0x6c65746e\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/00000000/edx 0x49656e69\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000000/ebx 0x756e6547\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000000/ecx 0x6c65746e\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000000/edx 0x49656e69\n\n# Model/Family/Stepping\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/00000001/eax 0x00000f43\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000001/eax 0x00000f43\n\n# Pentium model name\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000002/eax 0x20202020\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000002/ebx 0x20202020\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000002/ecx 0x20202020\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000002/edx 0x6e492020\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000003/eax 0x286c6574\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000003/ebx 0x50202952\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000003/ecx 0x69746e65\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000003/edx 0x52286d75\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000004/eax 0x20342029\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000004/ebx 0x20555043\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000004/ecx 0x30302e33\nvboxmanage setextradata <uuid> VBoxInternal/CPUM/HostCPUID/80000004/edx 0x007a4847```\n\nThis version only changes registers controlling vendor, family/model/stepping and model name. The last version used `--cpuidset` which requires all registers be passed (eax...edx) which means overriding some flags and that makes problems.\n\nAlso `--cpuid-portability-level` even at `1` (the lowest level) removes too many flags and gives compatibility and performance problems.\n\nWith this version only text strings and family/model/stepping are changed. Flags are passed from host CPU but the likelyhood of profiling a user by looking at flags is low. VirtualBox sanitizes the flags and only passes those it supports. The host and guest CPU flags will be different and most guests will have the same or almost the same flags.\n\nMost other CPU leaves are sanitized, removed or zero'd by VirtualBox. There will be differences in cache sizes, TLB and maybe a few others. I have not researched every single thing but I believe the most an attacker could determine would be a CPU series (i-3, Broadwell, Athlon, ..). I don't see anything indicating a specific model.\n\nI mentioned in my last comment but for anyone researching later, test `GuestCpuName` and check if it has improved and is usable. If it works and is reliable that is a better choice than setting these registers.\n\nNote: `/proc/cpuinfo` does not show all of the information. A tool like `cpuid` is needed.\n\nUnfortunately I do not have a Whonix build set up and don't know anything about that. The build could either run the commands above or include the extra data in the configuration file like this:\n\n```<Machine ...>\n    <ExtraData>\n      ...\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/00000000/ebx\" value=\"0x756e6547\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/00000000/ecx\" value=\"0x6c65746e\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/00000000/edx\" value=\"0x49656e69\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/00000001/eax\" value=\"0x00000f43\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000000/ebx\" value=\"0x756e6547\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000000/ecx\" value=\"0x6c65746e\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000000/edx\" value=\"0x49656e69\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000001/eax\" value=\"0x00000f43\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000002/eax\" value=\"0x20202020\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000002/ebx\" value=\"0x20202020\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000002/ecx\" value=\"0x20202020\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000002/edx\" value=\"0x6e492020\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000003/eax\" value=\"0x286c6574\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000003/ebx\" value=\"0x50202952\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000003/ecx\" value=\"0x69746e65\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000003/edx\" value=\"0x52286d75\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000004/eax\" value=\"0x20342029\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000004/ebx\" value=\"0x20555043\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000004/ecx\" value=\"0x30302e33\"/>\n      <ExtraDataItem name=\"VBoxInternal/CPUM/HostCPUID/80000004/edx\" value=\"0x007a4847\"/>\n    <ExtraData>\n</Machine>\n```"},{"author":"anonymous1","date_created":1485069786,"date_modified":1485069786,"content":"Works for me, hid my cpu name"},{"author":"Patrick","date_created":1489107693,"date_modified":1489107693,"content":"Added. Not yet tested by me but will test in the next build.\n\nhttps://github.com/Whonix/Whonix/commit/fb02a8a517fdea8f38613d0e43f90e5b334440fd\n"},{"author":"Patrick","date_created":1535394734,"date_modified":1535394734,"content":"\"Hiding CPU model is futile.\" Any reference for that? @HulaHoop "},{"author":"Patrick","date_created":1535394768,"date_modified":1535394768,"content":"Regarding the spectre vulnerability and its effect on VirtualBox your input is desired. @dumbmouse \n\nhttps://forums.whonix.org/t/whonix-vulerable-due-to-missing-processor-microcode-packages/5739/22"},{"author":"Patrick","date_created":1543387462,"date_modified":1543387462,"content":"This will be undone. Ticket:\n\n`remove attempts to hide CPU information from VM in VirtualBox`\nT881"}]},"PHID-TASK-7c7hyihcrb3hisgulnwj":{"id":"407","title":"qubes-template-whonix: make[1]: *** No rule to make target 'rpms-vm'.  Stop.","status":"resolved","priority":"High","author":"Patrick","description":"Excerpt.\n\n```\nmake qubes-vm --debug=v\n\n+ sudo -E chroot chroot-jessie su -p -c 'cd /home/user/qubes-src/template-whonix; NO_SIGN='\\''1'\\'' make  -s rpms-vm' user\nGNU Make 4.0\nBuilt for x86_64-pc-linux-gnu\nCopyright (C) 1988-2013 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\nReading makefiles...\nReading makefile 'Makefile'...\nReading makefile '/home/user/qubes-src/template-whonix/components.conf' (search path) (don't care) (no ~ expansion)...\nUpdating goal targets....\nConsidering target file 'rpms-vm'.\n File 'rpms-vm' does not exist.\n Finished prerequisites of target file 'rpms-vm'.\nMust remake target 'rpms-vm'.\nmake[1]: *** No rule to make target 'rpms-vm'.  Stop.\n+ BUILD_RETCODE=2\n+ '[' 2 -gt 0 ']'\n+ echo '--> build failed!'\n--> build failed!\n+ '[' -n '' ']'\n+ exit 1\nMakefile:193: recipe for target 'template-whonix-vm' failed\nmake: *** [template-whonix-vm] Error 1\nuser@host:~/qubes-builder\n```\n","comments":[{"author":"Patrick","date_created":1443206264,"date_modified":1443206264,"content":"I guess adding\n\n```\nrpms-vm::\n\t@true\n```\n\nto https://github.com/adrelanos/qubes-template-whonix/blob/master/builder.conf would suffice?\n\nAre there any other targets that should be provided?"},{"author":"marmarek","date_created":1443208823,"date_modified":1443208823,"content":"Better create empty `Makefile.builder`. The `rpms-vm` target (and\n`rpms-dom0`) is support for legacy components."},{"author":"Patrick","date_created":1444303524,"date_modified":1444303524,"content":"`fixed 'qubes-template-whonix: make[1]: *** No rule to make target 'rpms-vm'. Stop.' - Thanks to @marmarek for suggesting the fix! - https://phabricator.whonix.org/T407`:\nhttps://github.com/adrelanos/qubes-template-whonix/commit/1d3700bce1737e2dedbaa1b3d17430ec983cb752\n"},{"author":"Patrick","date_created":1446140489,"date_modified":1446140489,"content":"Got a #build issue with Qubes Builder.\n\n```\nmake qubes-vm\n```\n\n```\n DEBUG \n Repo Variables\n───────────────────────────────────────────────────────────────────────────────\n SRC_DIR:             qubes-src\n CHROOT_DIR:          /home/user/qubes-builder/chroot-jessie\n CHROOT_REPO_DIR:     chroot-debian\n CHROOT_DEBIAN_DIR:   /home/user/qubes-builder/chroot-jessie//\n BUILDER_REPO_DIR:    /home/user/qubes-builder/qubes-packages-mirror-repo/jessie\n───────────────────────────────────────────────────────────────────────────────\n Chroot Variables\n───────────────────────────────────────────────────────────────────────────────\n DIST_BUILD_DIR:      /home/user\n DIST_SRC:            \n DIST_SRC_DEBIAN_DIR: /\n───────────────────────────────────────────────────────────────────────────────\n Build Variables\n───────────────────────────────────────────────────────────────────────────────\n DEBIAN_PARSER:       /home/user/qubes-builder/qubes-src/builder-debian//scripts/debian-parser\n DEBIAN_PLUGIN_DIR:   /home/user/qubes-builder/qubes-src/builder-debian/\n OUTPUT_DIR:          pkgs/jessie\n PACKAGE_LIST:        \n DISTRIBUTION:        debian\n DIST:                jessie\n DEBIANVERSION:       jessie\n DEBIAN_DEPENDENCIES: dpkg-dev debootstrap\n UPDATE_REPO:         \n REPO_SUFFIX:         \n DISTRIBUTION_CAP:    Debian\n REPO_PROXY:          http://127.0.0.1:3142\n APT_GET_OPTIONS:     -o Acquire::http::Proxy=http://127.0.0.1:3142\n CHROOT_ENV:          BACKEND_VMM=xen\n\n-> ERROR: Wrong branch (detached from 12.0.0.2.6-developers-only) (expected 12.0.0.2.6-developers-only)\nMakefile:193: recipe for target 'Whonix-vm' failed\nmake: *** [Whonix-vm] Error 1\n```\n\nThere is an empty `Makefile.builder` now:\nhttps://github.com/Whonix/Whonix/blob/12.0.0.2.6-developers-only/Makefile.builder\n\nBuilding from `QubesOS/qubes-   Stable - Default Repo`.\n\nLooks like two different issues here.\n\n* a) `-> ERROR: Wrong branch (detached from 12.0.0.2.6-developers-only) (expected 12.0.0.2.6-developers-only`\n* b) `Makefile:193: recipe for target 'Whonix-vm' failed`\n\nBtw this is the last blocker before an #Whonix_12 RC.\n\nAny idea how to fix @marmarek?"},{"author":"marmarek","date_created":1446157950,"date_modified":1446157950,"content":"Generally the message is because you have `CHECK_BRANCH` safeguard\nenabled. The easiest thing to do is to just disable it (unset in\nbuilder.conf, or set to \"0\").\n\nIt all looks like this safeguard doesn't play nice when setting tag in\nBRANCH setting. Do you need CHECK_BRANCH feature here? If so, I'll fix\nit, otherwise - add appropriate note to documentation."},{"author":"Patrick","date_created":1446158820,"date_modified":1446158820,"content":"marmarek (Marek Marczykowski-Górecki):\n> marmarek added a comment.\n> \n> Generally the message is because you have `CHECK_BRANCH` safeguard\n> enabled. The easiest thing to do is to just disable it (unset in\n> builder.conf, or set to \"0\").\n\nOk.\n\n> It all looks like this safeguard doesn't play nice when setting tag in\n> BRANCH setting. Do you need CHECK_BRANCH feature here? If so, I'll fix\n> it, otherwise - add appropriate note to documentation.\n\nI don't urgently require it, but for high quality builds, I would be\nglad if you could fix it."},{"author":"marmarek","date_created":1446159945,"date_modified":1446159945,"content":"Ok, fix in my repo :)"},{"author":"Patrick","date_created":1446665896,"date_modified":1446665896,"content":"There is still an issue.\n\nI guess the fix was this one:\nhttps://github.com/marmarek/qubes-builder/commit/577b9fc54b6ec69213132907677531fcc1f7d0dd\n\n```\nfatal: no tag exactly matches '117fca6cc836ea5c8d2ea3f7e87611d2d83c1857'\n-> ERROR: Wrong branch  (expected 12.0.0.2.7-developers-only)\nMakefile:193: recipe for target 'Whonix-vm' failed\nmake: *** [Whonix-vm] Error 1\n```\n\nSome debug output.\n\n```\nuser@qubes-build:~/qubes-builder/qubes-src/Whonix$ git symbolic-ref --short HEAD\nfatal: ref HEAD is not a symbolic ref\n```\n\n```\nuser@qubes-build:~/qubes-builder/qubes-src/Whonix$ git describe --tags --exact-match HEAD\nfatal: no tag exactly matches '117fca6cc836ea5c8d2ea3f7e87611d2d83c1857'\n```\n\n```\nuser@qubes-build:~/qubes-builder/qubes-src/Whonix$ git describe \n12.0.0.2.7-developers-only-1-g117fca6\n```\n\nI speculate, the problem is that `make do-merge` creates a merge commit?\n\n```\ngit log\ncommit 117fca6cc836ea5c8d2ea3f7e87611d2d83c1857\nMerge: 67f8996 321c0ac\nAuthor: Your Name <you@example.com>\nDate:   Wed Nov 4 00:33:28 2015 +0100\n\n    Merge tag '12.0.0.2.7-developers-only' of https://github.com/Whonix/Whonix into HEAD\n    \n    .\n    \n    # gpg: Signature made Wed 04 Nov 2015 12:22:32 AM CET using RSA key ID 77BB3C48\n    # gpg: Good signature from \"Patrick Schleizer <adrelanos@riseup.net>\n```\n\nWould `git merge` using `--ff-only` in `make do-merge` be a solution?"},{"author":"marmarek","date_created":1446668273,"date_modified":1446668273,"content":"Actually `make do-merge` is supposed to do a merge when needed. Maybe\n`git merge --ff`?"},{"author":"Patrick","date_created":1446668527,"date_modified":1446668527,"content":"That should do also. Be an improvement. We'll notice should there are\ncorner cases. :)"},{"author":"Patrick","date_created":1446903177,"date_modified":1446903177,"content":">>! In T407#7042, @Patrick wrote:\n> There is still an issue.\n> \n> I guess the fix was this one:\n> https://github.com/marmarek/qubes-builder/commit/577b9fc54b6ec69213132907677531fcc1f7d0dd\n> \n> ```\n> fatal: no tag exactly matches '117fca6cc836ea5c8d2ea3f7e87611d2d83c1857'\n> -> ERROR: Wrong branch  (expected 12.0.0.2.7-developers-only)\n> Makefile:193: recipe for target 'Whonix-vm' failed\n> make: *** [Whonix-vm] Error 1\n> ```\n> \n> Some debug output.\n> \n> ```\n> user@qubes-build:~/qubes-builder/qubes-src/Whonix$ git symbolic-ref --short HEAD\n> fatal: ref HEAD is not a symbolic ref\n> ```\n> \n> ```\n> user@qubes-build:~/qubes-builder/qubes-src/Whonix$ git describe --tags --exact-match HEAD\n> fatal: no tag exactly matches '117fca6cc836ea5c8d2ea3f7e87611d2d83c1857'\n> ```\n> \n> ```\n> user@qubes-build:~/qubes-builder/qubes-src/Whonix$ git describe \n> 12.0.0.2.7-developers-only-1-g117fca6\n> ```\n> \n> I speculate, the problem is that `make do-merge` creates a merge commit?\n> \n> ```\n> git log\n> commit 117fca6cc836ea5c8d2ea3f7e87611d2d83c1857\n> Merge: 67f8996 321c0ac\n> Author: Your Name <you@example.com>\n> Date:   Wed Nov 4 00:33:28 2015 +0100\n> \n>     Merge tag '12.0.0.2.7-developers-only' of https://github.com/Whonix/Whonix into HEAD\n>     \n>     .\n>     \n>     # gpg: Signature made Wed 04 Nov 2015 12:22:32 AM CET using RSA key ID 77BB3C48\n>     # gpg: Good signature from \"Patrick Schleizer <adrelanos@riseup.net>\n> ```\n> \n> Would `git merge` using `--ff-only` in `make do-merge` be a solution?\n\n>>! In T407#7043, @marmarek wrote:\n> Actually `make do-merge` is supposed to do a merge when needed. Maybe\n> `git merge --ff`?\n\n>>! In T407#7044, @Patrick wrote:\n> That should do also. Be an improvement. We'll notice should there are\n> corner cases. :)\n\nCreated https://github.com/marmarek/qubes-builder/pull/1 for it."}]},"PHID-TASK-il46yrzs2zxtoo7wf5bm":{"id":"406","title":"whonixcheck in Qubes should check if running in right type of VM","status":"resolved","priority":"Normal","author":"Patrick","description":"#whonixcheck, should check, if:\n\n* Whonix-Gateway is running in a `NetVM` or `ProxyVM`\n* Whonix-Workstation is running in an `AppVM`\n* TemplateVM: skip this test\n","comments":[{"author":"Patrick","date_created":1442930026,"date_modified":1442930026,"content":"I am not sure, if checking if `Whonix-Workstation is running in an AppVM` is useful.\n\nCan you think of any situations, where it would make sense to configure Whonix-Workstation as a ProxyVM or NetVM?"},{"author":"Patrick","date_created":1442952249,"date_modified":1442952249,"content":"```\n- check if Qubes-Whonix-Gateway is running in the right type of VM (ProxyVM)\n- report if Whonix-Workstation or TemplateVM is connected to netvm 'none'\n```\nhttps://github.com/Whonix/whonixcheck/commit/9949235e969a55e33f3098996a7440b6aabf0ffd\n"},{"author":"marmarek","date_created":1443208637,"date_modified":1443208637,"content":"> Can you think of any situations, where it would make sense to configure Whonix-Workstation as a ProxyVM or NetVM?\n\nIs it supported by for example iptables settings? I think it's save to\ntreat such situation as an error."},{"author":"Patrick","date_created":1443208775,"date_modified":1443208775,"content":"marmarek (Marek Marczykowski-Górecki):\n>> Can you think of any situations, where it would make sense to configure Whonix-Workstation as a ProxyVM or NetVM?\n> \n> \n> Is it supported by for example iptables settings?\n\nNot at all.\n\n> I think it's save to\n> treat such situation as an error.\n\nAgreed."},{"author":"Patrick","date_created":1449894180,"date_modified":1449894180,"content":"```\ncheck if Qubes-Whonix-Workstation is running in the right type of VM\n\nAppVM or TemplateVM\n```\nhttps://github.com/Whonix/whonixcheck/commit/f8292d62efc419acef4cd677363191edeea29014"},{"author":"Patrick","date_created":1461687196,"date_modified":1461687196,"content":"https://github.com/Whonix/whonixcheck/commit/877900240ce2f504d1892f078002954352aa576a"}]},"PHID-TASK-pyjfpqo42akmcrejqzvy":{"id":"405","title":"new qubes-whonix-gateway-packages-dependencies package required","status":"invalid","priority":"Normal","author":"Patrick","description":"The qubes-whonix-gateway-packages-recommended package (https://github.com/Whonix/qubes-whonix/blob/3f06a183f2030578259b456836a651cd766ffa37/debian/control#L75-L86) does not suffice. On the gateway, tinyproxy is not a recommended package. It can be considered a dependency. Without it, TemplateVM apt-get updates are not possible. At least not without deconfiguring updates through tinyproxy. It cannot be added as dependency of the qubes-whonix package, because there is no need to install tinyproxy on the workstation. The best solution seems to be to create a qubes-whonix-gateway-packages-dependencies package. As of now, it's good enough for Whonix 12. But something worth fixing in Whonix 13.","comments":[{"author":"Patrick","date_created":1452277158,"date_modified":1452277158,"content":"The qubes-whonix-gateway-packages-recommended package suffices. If anything, it could be renamed to The qubes-whonix-gateway-packages-dependencies. Little point in it. Not installing yum would result in breaking dom0 upgrades. Any of these can be omitted if the user reconfigured / has special use cases. Probably fine as is."}]},"PHID-TASK-oq6y7ararxff2jtzjwhs":{"id":"404","title":"qubes-builder trying to build component Whonix causes build error","status":"resolved","priority":"High","author":"Patrick","description":"qubes-builder tries to build https://github.com/Whonix/Whonix.\n\nUntil T402 is fully implemented which won't be before Whonix 13, this causes various build issues.\n\n1.)\n```\n+ DIST=jessie\n+ COMPONENT=Whonix\n+ RUN_AS_USER=user\n+ '[' 2 -gt 2 ']'\n+ SCRIPT_DIR=/home/user/qubes-builder\n+ : rpms-vm\n+ ORIG_SRC=/home/user/qubes-builder/qubes-src/Whonix\n+ DIST_SRC_ROOT=/home/user/qubes-builder/chroot-jessie/home/user/qubes-src/\n+ DIST_SRC=/home/user/qubes-builder/chroot-jessie/home/user/qubes-src//Whonix\n+ BUILDER_REPO_DIR=/home/user/qubes-builder/qubes-rpms-mirror-repo/jessie\n+ MAKE_TARGET_ONLY=rpms-vm\n+ REQ_PACKAGES=build-pkgs-Whonix.list\n+ '[' -r build-pkgs-Whonix-rpms-vm.list ']'\n+ '[' -r /home/user/qubes-builder/qubes-src/Whonix/build-deps.list ']'\n+ '[' -r /home/user/qubes-builder/qubes-src/Whonix/build-deps-rpms-vm.list ']'\n+ export USER_UID=1000\n+ USER_UID=1000\n+ '[' -d chroot-jessie ']'\n+ '[' -r build-pkgs-Whonix.list ']'\n+ '[' -r /home/user/qubes-builder/chroot-jessie/proc/cpuinfo ']'\n+ '[' -d /home/user/qubes-builder/chroot-jessie/sys/devices ']'\n+ sudo mount -t sysfs sysfs /home/user/qubes-builder/chroot-jessie/sys\n+ mkdir -p /home/user/qubes-builder/chroot-jessie/home/user/qubes-src/\n+ sudo rm -rf /home/user/qubes-builder/chroot-jessie/home/user/qubes-src//Whonix\n+ cp -alt /home/user/qubes-builder/chroot-jessie/home/user/qubes-src/ /home/user/qubes-builder/qubes-src/Whonix\ncp: cannot create hard link ‘/home/user/qubes-builder/chroot-jessie/home/user/qubes-src/Whonix/.git/index’ to ‘/home/user/qubes-builder/qubes-src/Whonix/.git/index’: Operation not permitted\n```\n\n2.)\nTries to run `make update-repo-template`.\n\nCan you advice please how qubes-builder could be made ignore that component?","comments":[{"author":"marmarek","date_created":1441572144,"date_modified":1441572144,"content":"Creating empty `Makefile.builder` should do."},{"author":"Patrick","date_created":1441629993,"date_modified":1441629993,"content":"```\nAdded empty Makefile.builder to prevent Qubes Builder from trying to build this and failing. - https://phabricator.whonix.org/T404\nUsing this workaround until Qubes Builder supports building Whonix packages. - https://phabricator.whonix.org/T402\nThanks to @marmarek for helping with this!\n```\nhttps://github.com/Whonix/Whonix/commit/533c9772236b08fcc2e19f67dc39d26255d7a5f0\n"}]},"PHID-TASK-lzv7b52oflvsq7bw2u7x":{"id":"403","title":"Support hidden service debian mirror","status":"invalid","priority":"Needs Triage","author":"wax","description":"Give an option to allow updates via .onion\n\n\n\nhttp://richardhartmann.de/blog/posts/2015/08/24-Tor-enabled_Debian_mirror/\n\n>This service is not redundant, it uses a key which is stored on the local drive, the .onion will change, and things are expected to break.\n>But at least this service exists now and can be used, tested, and put under some load\n\nhttp://vwakviie2ienjx6t.onion/","comments":[{"author":"Patrick","date_created":1441496971,"date_modified":1441496971,"content":"Duplicate of T399.\n"}]},"PHID-TASK-u7mohhjyh3pwjh4lpxxf":{"id":"402","title":"install Whonix packages in 04","status":"resolved","priority":"Normal","author":"Patrick","description":"https://groups.google.com/d/msg/qubes-devel/dx4hfsUwGU8/bSPqTu8EAgAJ\n","comments":[{"author":"Patrick","date_created":1441473040,"date_modified":1441473040,"content":"Proposal:\n\n* 00* - [1100_prepare-build-machine](https://github.com/Whonix/Whonix/blob/master/build-steps.d/1100_prepare-build-machine)\n* 01* - Qubes only, nothing Whonix specific\n* 02* - Qubes only, nothing Whonix specific\n* (virtual) 03* - Qubes only, nothing Whonix specific\n* 04* - take [02_install_groups_pre.sh](https://github.com/adrelanos/qubes-template-whonix/blob/master/whonix-gateway/02_install_groups_pre.sh) and rename it to 04_install_qubes_post.sh (all inside chroot: [creates packages](https://github.com/Whonix/Whonix/blob/master/build-steps.d/1200_create-debian-packages), [installs packages](https://github.com/Whonix/Whonix/blob/master/build-steps.d/1700_install-packages), [run](https://github.com/Whonix/Whonix/blob/master/build-steps.d/2300_run-chroot-scripts-post-d) the [chroot scripts](https://www.whonix.org/wiki/Dev/Source_Code_Intro#Chroot_Scripts))\n* 09* - [09_cleanup_post.sh](https://github.com/marmarek/qubes-template-whonix/blob/master/whonix-gateway/09_cleanup_post.sh)\n\nWould that be better?\n\n-----\n\nStill non-ideal. Ideally, packages would be build outside the chroot so the build dependencies do not get installed inside the image. Combining the two build systems in a non-hacky, non-complex way seems difficult. Would it be better if qubes-builder would build all the Whonix packages? I wonder if that could be done without a giant `components.conf` listing all the packages git repos. And without adding a `Makefile.builder ` to each and every Whonix package.\n\nPerhaps #makefile-generic-packages (genmkfile) could be extended to implement all make targets, that qubes-builder requires. "},{"author":"marmarek","date_created":1441494811,"date_modified":1441494811,"content":"> Proposal:\n> \n> - 00* - 1100_prepare-build-machine <https://github.com/Whonix/Whonix/blob/master/build-steps.d/1100_prepare-build-machine>\n> - 01* - Qubes only, nothing Whonix specific\n> - 02* - Qubes only, nothing Whonix specific\n> - (virtual) 03* - Qubes only, nothing Whonix specific\n> - 04* - take 02_install_groups_pre.sh <https://github.com/adrelanos/qubes-template-whonix/blob/master/whonix-gateway/02_install_groups_pre.sh> and rename it to 04_install_qubes_post.sh (all inside chroot: creates packages <https://github.com/Whonix/Whonix/blob/master/build-steps.d/1200_create-debian-packages>, installs packages <https://github.com/Whonix/Whonix/blob/master/build-steps.d/1700_install-packages>, run <https://github.com/Whonix/Whonix/blob/master/build-steps.d/2300_run-chroot-scripts-post-d> the chroot scripts <https://www.whonix.org/wiki/Dev/Source_Code_Intro#Chroot_Scripts>)\n> - 09* - 09_cleanup_post.sh <https://github.com/marmarek/qubes-template-whonix/blob/master/whonix-gateway/09_cleanup_post.sh>\n> \n> Would that be better?\n\nYes, exactly.\n\n> Still non-ideal. Ideally, packages would be build outside the chroot\n> so the build dependencies do not get installed inside the image.\n> Combining the two build systems in a non-hacky, non-complex way seems\n> difficult. Would it be better if qubes-builder would build all the\n> Whonix packages? I wonder if that could be done without a giant\n> `components.conf` listing all the packages git repos. And without\n> adding a `Makefile.builder ` to each and every Whonix package.\n\nWhonix uses submodules for all the components, right? So it can be\nconsidered a single component to qubes-builder, which produces a lot of\npackages. Are some Whonix-specific steps required to build the\ncomponents, or generic `dpkg-buildpackage` is enough? In case of the\nlater, it would be enough to place single `Makefile.builder` in main\nWhonix repository which lists all the components in `DEBIAN_BUILD_DIRS`\n(list can be easily generated based on submodules list, or some script\noutput). Note that the order is important to satisfy build depends.  If\nsomething more than `dpkg-buildpackage` is required, it may be enough to\nplace it in `SOURCE_COPY_IN` step, or some more flexible mechanism\nshould be designed."},{"author":"marmarek","date_created":1441495066,"date_modified":1441495066,"content":">>! In T402#6662, @marmarek wrote:\n> Whonix uses submodules for all the components, right? So it can be\n> considered a single component to qubes-builder, which produces a lot of\n> packages. Are some Whonix-specific steps required to build the\n> components, or generic `dpkg-buildpackage` is enough? In case of the\n> later, it would be enough to place single `Makefile.builder` in main\n> Whonix repository which lists all the components in `DEBIAN_BUILD_DIRS`\n> (list can be easily generated based on submodules list, or some script\n> output). Note that the order is important to satisfy build depends.  If\n> something more than `dpkg-buildpackage` is required, it may be enough to\n> place it in `SOURCE_COPY_IN` step, or some more flexible mechanism\n> should be designed.\n\nThis would mean that it isn't possible to build a single Whonix package, only all of them. If that's a big issue, we could either introduce some qubes-builder mechanism to build a single package of multi-package component (IMO preferred, useful not only here), or consider each Whonix package as a separate components (as you've noted, not ideal)."},{"author":"Patrick","date_created":1441503294,"date_modified":1441503294,"content":"> Whonix uses submodules for all the components, right?\n\nYes.\n\n> In case of the\n> later, it would be enough to place single Makefile.builder in main\n> Whonix repository which lists all the components in DEBIAN_BUILD_DIRS\n> (list can be easily generated based on submodules list, or some script\n> output). Note that the order is important to satisfy build depends. If\n> something more than dpkg-buildpackage is required, it may be enough to\n> place it in SOURCE_COPY_IN step, or some more flexible mechanism\n> should be designed.\n\nOk.\n\n> This would mean that it isn't possible to build a single Whonix package, only all of them. If that's a big issue, \n\nI don't think this is an issue."},{"author":"Patrick","date_created":1441504667,"date_modified":1448372436,"content":"Looks like I'll be working on the 02 to 04 transition now. Required for other purposes. My experiments show, that [this](https://github.com/adrelanos/qubes-template-whonix/blob/ffff8457a0241b9e799c0f9d31dac0444a9b3132/whonix-gateway/09_cleanup_post.sh#L15-L20) use of apt-get in `09_cleanup_post.sh` does not work. (No proper chroot anymore at that stage?)\n\nIf `qubes-builder-debian` provides [04_install_qubes.sh](https://github.com/marmarek/qubes-builder-debian/blob/master/template_debian/04_install_qubes.sh), then `qubes-template-whonix` cannot provide an additionally executed `04_install_qubes.sh`, right? At least, that seems so in my experiments. Is this a bug or feature?\n\nThat would also mean, that likely `qubes-builder-debian` and `qubes-template-whonix`'s `09_cleanup_post.sh` would also conflict, i.e. only `qubes-builder-debian` one would run."},{"author":"Patrick","date_created":1441568848,"date_modified":1441568848,"content":"```\n- build Whonix in 04_ instead of 02_ as suggested by @marmarek - https://phabricator.whonix.org/T402\n- removed many hacks\n```\nhttps://github.com/adrelanos/qubes-template-whonix/commit/4dc8648e5d3e3a1004565f0bb73d19f2ceec2215"},{"author":"Patrick","date_created":1448572691,"date_modified":1448572691,"content":"This is done."}]},"PHID-TASK-lm6pj7hotfoslhwrmrza":{"id":"401","title":"make Qubes-Whonix-Gateway able to function as UpdateVM out of the box","status":"resolved","priority":"Normal","author":"Patrick","description":"Currently still manual tweaking is required.\n\n-----\n\na) `qubes-prefs --set updatevm whonix-gw`\nb) Using `whonix-gw` as `ProxyVM` for `TemplateVMs`.\n\nFor a), to implement this, creating a #uwt wrapper for `yum` could be sufficient.\n\nFor b), not sure yet.\n\n-----\n\nRecent forum discussion:\nhttps://www.whonix.org/forum/index.php/topic,1578.0.html\n\nRelated Qubes ticket:\nhttps://github.com/QubesOS/qubes-issues/issues/1159\n\nDev wiki:\nhttps://www.whonix.org/wiki/Dev/Qubes#UpdateVM\n","comments":[{"author":"Patrick","date_created":1441285854,"date_modified":1441285854,"content":"`added Tor SocksPort 9125 for yum`:\nhttps://github.com/Whonix/anon-gw-anonymizer-config/commit/a2aa9e90b344cb4fc01cacc73ac2007b47e3f42e\n\n`added Tor SocksPort 9125 for yum`:\nhttps://github.com/Whonix/whonix-gw-firewall/commit/d6401bb5e310504a454ee2d65b8b3d46b4dbfdb3\n\n`added stream isolation wrapper for yum`:\nhttps://github.com/Whonix/uwt/commit/e86f3497832626f16721cd0fc493fb4ba4a12ee6\n"},{"author":"Patrick","date_created":1441287419,"date_modified":1441287419,"content":"`added stream isolation wrapper for yumdownloader`:\nhttps://github.com/Whonix/uwt/commit/ddc9fbc6822b643ff0bbf1cac872d65a86ff8c70\n"},{"author":"Patrick","date_created":1441292921,"date_modified":1441292921,"content":"I think the 4 above commits made a), `qubes-prefs --set updatevm whonix-gw` possible. I was able to use dom0 `sudo qubes-dom0-update` now. Needs more testing. `yum` and `yumdownloader` can now connect through Tor on Qubes-Whonix-Gateway without manual configuration. (Whonix-Gateway does not provide a TransPort, i.e. there is no default fallback system DNS / TCP. All applications need to be configured to use a Tor SocksPort or be forced by uwt.) [I might have run into unrelated issues. (https://github.com/marmarek/qubes-core-agent-linux/pull/25)]\n\nFor this to work, the only things requiring network access, are only `yum` and `yumdownloader` in `qubes-download-dom0-updates.sh`, right? @marmarek"},{"author":"Patrick","date_created":1441299477,"date_modified":1441299477,"content":"a) Works. `sudo qubes-dom0-update` works now. Installing an arbitrary package `sudo qubes-dom0-update qubes-template-debian-7` also worked.\n\nb) Already worked. As one would expect. Configured the Debian and Fedora TemplateVMs to use Qubes-Whonix-Gateway as NetVM. Updates were possible.\n\nAre there any other test cases I should cover?"},{"author":"marmarek","date_created":1441299616,"date_modified":1441299616,"content":"(resending)\n\nre: yum + yumdownloader the only network accessing tool:\n\nYes, but note that there are more call to them there. How that wrapper\nworks? Is it placed instead of `/usr/bin/yum`?\n\nAh, `qubes-dom0-update` calls `qvm-sync-clock` first, but this is\nprobably irrelevant here. And independent thing to rework."},{"author":"Patrick","date_created":1441300421,"date_modified":1441300421,"content":">>! In T401#6629, @marmarek wrote:\n> (resending)\n> \n> re: yum + yumdownloader the only network accessing tool:\n> \n> Yes, but note that there are more call to them there. How that wrapper\n> works? Is it placed instead of `/usr/bin/yum`?\n\nShort answer:\nNo modifications of any Qubes scripts required. /usr/bin/yum gets replaced.\n\nLonger answer:\n\"Like other #uwt wrappers.\" /usr/bin/yum is a symlink to /usr/bin/yum.anondist.\n(https://github.com/Whonix/uwt/blob/master/usr/bin/yum.anondist)\n(using config-package-dev)\nIt will exec to uwtwrapper.\n(https://github.com/Whonix/uwt/blob/master/usr/lib/uwtwrapper)\nIt determines destination ip/port, config and other relevant stuff.\nWhich will then exec to uwt, which will then exec to torsocks.\n(uwt is required, because torsocks does not support stream isolation by ip/destination port. [upstream feature request existing])\n \n> Ah, `qubes-dom0-update` calls `qvm-sync-clock` first, but this is\n> probably irrelevant here. And independent thing to rework.\n\nYes. This doesn't interfere here, because T384 was implemented. T397 remains TODO, but is an issue on a different level.\n"},{"author":"Patrick","date_created":1441312078,"date_modified":1441312199,"content":"There is an issue with `qubes-dom0-update` with user output. (Purposely set the time into future for unrelated tests while testing this.) During...\n\n```\nqvm-run -p sys-whonix 'tar x -C /var/lib/qubes/dom0-updates'\n```\n\nIt may show multiple times (in red color)...\n\n```\ntar: var/lib/rpm/__db.01: time stamp 2015-09-03 19:47:29 is 63.278026948 s in future\n```\n"},{"author":"Patrick","date_created":1441312373,"date_modified":1441312373,"content":"I thought, why not just add `2>/dev/null`. That hides it. Created a pull request...\nhttps://github.com/marmarek/qubes-core-admin-linux/pull/1\nWhat do you think?"},{"author":"marmarek","date_created":1441313275,"date_modified":1441313275,"content":"I think it isn't the best option - indeed such warning are not really\nuseful, but that would hide also errors (for example \"No space left on\ndevice\"), so would be harder to find out what failed.\n\nAlso, this is exactly why there is `qvm-sync-clock` call.\n\nMaybe there is a way to filter out just those messages? I can't find an\noption for that. Some grep (and make sure `LC_MESSAGES=C`)?"},{"author":"Patrick","date_created":1441326183,"date_modified":1441326183,"content":"Agreed.\n\nHere is a proof of concept filtering this out using grep. (Missing `LC_MESSAGES=C`.)\nhttps://github.com/marmarek/qubes-core-admin-linux/pull/2\n\nBut using grep increases dom0 attack surface or are there already other cases where dom0 grep processes VM data so this does not matter?\n\nIf so, I could try write a tar wrapper that runs within the VM that filters out that message."},{"author":"Patrick","date_created":1441328262,"date_modified":1441328262,"content":"New pull request:\nhttps://github.com/marmarek/qubes-core-admin-linux/pull/3\n"}]},"PHID-TASK-t6vg3vkkj5b55ecvv5et":{"id":"400","title":"re-implement Tor Browser local version number detection","status":"resolved","priority":"Wishlist","author":"Patrick","description":"__prerequisite knowledge__:\n\nRecent changes...\n\n> removed broken local version detection code due to upstream changes\n\nhttps://github.com/Whonix/tb-updater/commit/fa50399fbd360a744709b53ac2c98f6a039d4929\n\n> - explain that if users want to keep their user data, they are better off using TBB's automatic internal updater\n> - fix if local version detection failed\n> - renamed update-torbrowser to torbrowser-downloader\n\nhttps://github.com/Whonix/tb-updater/commit/ae368f0541a3676df1e2befa738ed673e4703619\n\n> Tor Browser update check has been deprecated, because local version detection code was broken since Tor Browser got its own internal updater. Also since Tor Browser now automatically updates itself without asking, there is less need for this test.\n\nhttps://github.com/Whonix/whonixcheck/commit/75d411b4adaaf866e9b50d87fd1b4f519a535ddd\n\n-----\n\n__Screenshot__:\n\nThis is what tb-updater's confirmation screen will look like if TBB is already installed.\n\n{F327, size=full}\n\n-----\n\n__Priority__:\n\nFor me, @Patrick:\n\n* Low. Wishlist.\n* Because whonixcheck no longer checks Tor Browser's version number.\n* TBB is automatically updating itself.\n* TBB is installed in Qubes by default.\n* Nowhere the user gets asked to start tb-updater anymore.\n* For re-downloading / re-installation of TBB if the user wishes to start with a new browser profile, tb-updater still works. In that case, determining the locally installed TBB version is unimportant.\n* Non-trivial to implement.\n\n-----\n\n__Off-topic__:\n\n* making folder names clickable -> https://www.whonix.org/forum/index.php/topic,261.msg9776.html#msg9776\n* superfluous scrollbar on the right side -> https://www.whonix.org/forum/index.php/topic,261.msg9777.html#msg9777\n\n-----\n\n__TODO__:\n\nWrite a script capable of detecting the version number of a locally installed Tor Browser.\n(Some hints in this comment T118#6551 to get started.)\n","comments":[{"author":"Patrick","date_created":1561086304,"date_modified":1561086304,"content":"https://github.com/Whonix/tb-updater/commit/36561b7f8b54605ea33f4842930f2cdabcd17365"}]},"PHID-TASK-w4rl5hkpeblvwvgpm4dv":{"id":"399","title":"Switch Debian links in sources.list to .onion ","status":"resolved","priority":"Normal","author":"HulaHoop","description":"Jacob is working with Debian to run their repositories as .onion \n\nOnce they're up and running I recommend switching Whonix to using them. \n\nWhonix's own repos should follow their lead depending on the resources you can invest in running a .onion on the infrastructure. ","comments":[{"author":"HulaHoop","date_created":1440639879,"date_modified":1440639879,"content":"Trial in progress. Debian planning domain wide .onion roll out:\n\nhttp://richardhartmann.de/blog/posts/2015/08/24-Tor-enabled_Debian_mirror/"},{"author":"Patrick","date_created":1440641085,"date_modified":1440641085,"content":"http://richardhartmann.de/blog/posts/2015/08/25-Tor-enabled_Debian_mirror_part_2/"},{"author":"HulaHoop","date_created":1440973271,"date_modified":1440973271,"content":"apt-transport-tor instructions:\n\n https://retout.co.uk/blog/2014/07/21/apt-transport-tor"},{"author":"Patrick","date_created":1441496980,"date_modified":1441496980,"content":"Related issue recently raised on Qubes tracker:\n`high-level target: templates should default update over Tor`\nhttps://github.com/QubesOS/qubes-issues/issues/1159\n"},{"author":"Patrick","date_created":1451062465,"date_modified":1451062465,"content":"`create a Tor hidden service for deb.torproject.org [ .onion apt-get ]`:\nhttps://trac.torproject.org/projects/tor/ticket/17937"},{"author":"HulaHoop","date_created":1459989939,"date_modified":1459989939,"content":"I was thinking about changing the main repo URLs to the optimized one but is it worth it when changing to .onion is better?\n\n\"Note the use of http.debian.net in order to pick a mirror near to whichever Tor exit node. Throughput is surprisingly good.\"\n\nhttps://retout.co.uk/blog/2014/07/21/apt-transport-tor\n\n***\n\nRelated files:\n\nhttps://github.com/Whonix/anon-apt-sources-list/blob/master/etc/apt/sources.list.d/debian.list\nhttps://github.com/Whonix/Whonix/tree/master/build_sources\n"},{"author":"Patrick","date_created":1459990721,"date_modified":1459990721,"content":"As per Tails... httpredir.debian.net is not a great idea. Source:\nhttps://labs.riseup.net/code/issues/9235\n\n> https://github.com/Whonix/Whonix/tree/master/build_sources\n\nBtw changing these to onion not trivial. Requires Tor access during build."},{"author":"marmarek","date_created":1460020430,"date_modified":1460020430,"content":"> Btw changing these to onion not trivial. Requires Tor access during build.\n\nFWIW for Qubes templates (release builds) it isn't a problem - I always build them in DispVM behind Tor.\nBut it may be a problem for devel builds and it may slow them down..."},{"author":"Patrick","date_created":1460391698,"date_modified":1460391698,"content":"Once we stop using deb.torproject.org (T472), implementing this ticket gets more attractive. (since they [do not yet host a .onion for deb.torproject.org](https://trac.torproject.org/projects/tor/ticket/17937)) (And we would need to get our onion for whonix.org back up. (T494))"},{"author":"HulaHoop","date_created":1470063921,"date_modified":1470063921,"content":"That day has finally come. Both Tor and Debian have onion repos;\n\nhttp://forums.whonix.org/t/debian-starts-onionizing/2797"},{"author":"HulaHoop","date_created":1470091212,"date_modified":1470091212,"content":"IMHO restoring Whonix onion repos should be part of this to achieve complete protection."},{"author":"Patrick","date_created":1470177056,"date_modified":1470177056,"content":"Already up.\n\nhttps://www.whonix.org/wiki/Whonix-APT-Repository#Repository_Location_URI"},{"author":"Patrick","date_created":1471566805,"date_modified":1471566805,"content":"- https://github.com/Whonix/whonix-repository/commit/231198f47005c03b93ad425918b3134c13184329\n- https://github.com/Whonix/anon-apt-sources-list/commit/df5279b6d34ea9d2819dee81a00721bbcbfb0870\n- https://github.com/Whonix/Whonix/commit/21bec3f27ee4d0d2e8147366342eae3b3a975072\n"}]},"PHID-TASK-lpuaf37yukhobw4izkj5":{"id":"398","title":"Qubes-Whonix whonixcheck sanity test for 'prevent dom0 telling Qubes-Whonix VMs the time'","status":"resolved","priority":"Normal","author":"Patrick","description":"When `prevent dom0 telling Qubes-Whonix VMs the time` T397 is implemented, #whonixcheck should add a sanity test to see if that won't break over time.\n\nImplementation:\n\n* #qubes-whonix_12's `/etc/qubes-rpc/qubes.SetDateTime`[`.anondist`] can forward everything dom0 is [not] telling to a file.\n* From there #whonixcheck can check if that file exists. If it exists, then T397 is either broken or not yet implemented.\n","comments":[{"author":"Patrick","date_created":1439862531,"date_modified":1439862531,"content":"`/etc/qubes-rpc/qubes.SetDateTime.anondist: dom0 should not tell us its time. But if it does, create a file /var/run/qubes-whonix/qubes.SetDateTime so whonixcheck could warn in case this file exists. - https://phabricator.whonix.org/T398`:\nhttps://github.com/Whonix/qubes-whonix/commit/300d09b2514019e67fec16403177092f14504ba2\n"},{"author":"Patrick","date_created":1439863262,"date_modified":1439863262,"content":"`Added an info level message when running with --verbose if dom0 is telling us the time. As long as https://phabricator.whonix.org/T397 is unsolved. - https://phabricator.whonix.org/T398`:\nhttps://github.com/Whonix/whonixcheck/commit/0019e00e28ef85cdd95937d4d1e134335a03af18"}]},"PHID-TASK-527plg47z3qm2z6x2vf6":{"id":"397","title":"prevent dom0 telling Qubes-Whonix VMs the time by using the mgmt stack for that / disable Qubes dom0 /etc/qubes-rpc/qubes.SetDateTime","status":"open","priority":"Normal","author":"Patrick","description":"We do not want dom0 telling Qubes-Whonix VMs the time. Because in case of a compromised Whonix VM, we do not want the adversary replace/restore the `/etc/qubes-rpc/qubes.SetDateTime` script. To avoid [time related](https://www.whonix.org/wiki/Dev/TimeSync) deanoymization. We need to stop dom0's `/usr/bin/qvm-sync-clock` from running that hook for Qubes-Whonix VMs.\n\nIn T384#6287 @marmarek said we should use the mgmt stack for that.\n\nmgmt should keep configuring qvm-sync-clock disabled for Qubes-Whonix VMs. For freshly downloaded templates as well as for user custom created new Whonix VMs based on Qubes-Whonix templates.","comments":[{"author":"Patrick","date_created":1458643676,"date_modified":1533658340,"content":"~~Waiting for Qubes 4, feature [Template policy, services->features, core plugins](https://github.com/QubesOS/qubes-issues/issues/1637) to be implemented.~~"}]},"PHID-TASK-qgyrfm4fg4iqljkuixjp":{"id":"396","title":"Qubes-Whonix obfsproxy AppArmor issue","status":"resolved","priority":"Normal","author":"Patrick","description":"Found in Qubes-Whonix 11. (Other versions untested.)\n\n```\nuser@host:~$ obfsproxy -h\nTraceback (most recent call last):\n  File \"/usr/bin/obfsproxy\", line 5, in <module>\n    from pkg_resources import load_entry_point\n  File \"/usr/lib/python2.7/dist-packages/pkg_resources.py\", line 2876, in <module>\n    working_set = WorkingSet._build_master()\n  File \"/usr/lib/python2.7/dist-packages/pkg_resources.py\", line 440, in _build_master\n    ws = cls()\n  File \"/usr/lib/python2.7/dist-packages/pkg_resources.py\", line 433, in __init__\n    self.add_entry(entry)\n  File \"/usr/lib/python2.7/dist-packages/pkg_resources.py\", line 489, in add_entry\n    for dist in find_distributions(entry, True):\n  File \"/usr/lib/python2.7/dist-packages/pkg_resources.py\", line 1902, in find_on_path\n    for entry in os.listdir(path_item):\nOSError: [Errno 13] Permission denied: '/rw/usrlocal/lib/python2.7/dist-packages'\n```\n\n```\naudit: type=1400 audit(1439566453.497:15): apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/obfsproxy\" name=\"/rw/usrlocal/lib/python2.7/dist-packages/\" pid=4078 comm=\"obfsproxy\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n```\n\nI have no idea why obfsproxy or some lib it is using tries to access /usr/local.\n\nin Qubes, /usr/local is a symlink to /rw/usrlocal.\n","comments":[{"author":"Patrick","date_created":1439570979,"date_modified":1439664580,"content":"Related:\n\n* https://debathena.mit.edu/trac/ticket/166\n* http://mailman.mit.edu/pipermail/config-package-dev/2013-July/000008.html\n\nA real fix would require having an AppArmor option to follow symlinks.\n\nWorkaround...\n`fixed obfsproxy AppArmor issue \"OSError: [Errno 13] Permission denied: '/rw/usrlocal/lib/python2.7/dist-packages'\" - https://phabricator.whonix.org/T396`:\nhttps://github.com/Whonix/apparmor-profile-anondist/commit/d8a5faec3a71a52b5dab79e092dcbaeeb99c6f7d\n"},{"author":"Patrick","date_created":1439571391,"date_modified":1439571391,"content":"AppArmor upstream feature request - `symlink support`:\nhttps://bugs.launchpad.net/apparmor/+bug/1485055\n"},{"author":"Patrick","date_created":1439589256,"date_modified":1439589256,"content":">>! In T396#6413, @Patrick wrote:\n> AppArmor upstream feature request - `symlink support`:\n> https://bugs.launchpad.net/apparmor/+bug/1485055\n\nGot `Won't Fix`.\n\n> Seth Arnold:\n>> This is not a design choice that can be revisited; this is a consequence of the kernel internal implementation. Sorry.\n"},{"author":"Patrick","date_created":1439648374,"date_modified":1439648374,"content":"Got another answer.\n\nChristian Boltz (cboltz):\n>You can use alias rules for directory symlinks - add them to /etc/apparmor.d/tunables/alias. This avoids the need to modify all profiles.\n>\n>For example, my /tmp/ is a symlink to /home/sys-tmp/, and the alias rule for it is\n>    alias /tmp/ -> /home/sys-tmp/,\n>\n>Another possible solution is using mount --bind instead of symlinks.\n"},{"author":"Patrick","date_created":1439664083,"date_modified":1439664083,"content":"Actually, that's a much better solution.\n\n`/etc/apparmor.d/tunables/home.d/qubes-whonix`:\n```\nalias /usr/local -> /rw/usrlocal/,\n```\n\nTested. Works. Will revert the above commit (T396#6412). And use this solution instead. Does `/etc/apparmor.d/tunables/home.d/qubes-whonix` fit better into the qubes-whonix or the apparmor-profile-anondist package? @troubadour\n\nAlso suggested to Qubes to fix this at a higher level... (But in meanwhile we need the quicker above fix.)\n`Qubes /usr/local symlink /rw/usrlocal AppArmor issue`:\nhttps://github.com/QubesOS/qubes-issues/issues/1122\n"},{"author":"Patrick","date_created":1440006350,"date_modified":1440006350,"content":"Reverted:\nhttps://github.com/Whonix/apparmor-profile-anondist/commit/da380cfe87c53aab16c9c4a60ccb396752a5b3c6\n\n`fixed obfsproxy AppArmor issue \"OSError: [Errno 13] Permission denied: '/rw/usrlocal/lib/python2.7/dist-packages'\" using superior /etc/apparmor.d/tunables/home.d/qubes-whonix-anondist solution - https://phabricator.whonix.org/T396`:\nhttps://github.com/Whonix/apparmor-profile-anondist/commit/8785d3124c75dc39c6da2f1753e19b02d625a987\n"}]},"PHID-TASK-3w5d42fz5y3omduoxrzd":{"id":"395","title":"integrate whonix-firewall-plugin.sh into whonix-gw-firewall","status":"resolved","priority":"Normal","author":"Patrick","description":"During cleanup / refactoring of the qubes-whonix package, I was wondering...\n\nFor #Whonix_12, I intent to move\nhttps://github.com/adrelanos/qubes-whonix/blob/master/usr/lib/qubes-whonix/init/whonix-firewall-plugin.sh\ndirectly into\nhttps://github.com/Whonix/whonix-gw-firewall/blob/master/usr/bin/whonix_firewall\n\nIs there any reason against that?\n\nThen the GATEWAY_IPv4_DROP_INVALID_INCOMING_PACKAGES_POST_HOOK (https://github.com/adrelanos/qubes-whonix/blob/master/etc/whonix_firewall.d/40_qubes) could be deprecated.\n\nI would find that easier to grasp and maintain. From perspective of upgrading packages, time required for that, nothing would change.\n\n@nrgaway","comments":[{"author":"nrgaway","date_created":1439369416,"date_modified":1439369416,"content":"It would be nice to eliminate anything that is not Qubes specific in qubes-whonix pacakge completely, or as much as possible.  Anything you can take out of it by intergrating into Whonix would be a good thing. \n\nI also think `template-whonix` should be replaced by Whonix in two stages.\n\nStage 1:\nMerge `template-whonix` into Whonix; directory structure can easily be re-worked for `template-whonix`\nInclude `qubes-whonix` package in your packages\n\nStage 2:\n`qubes-builder` could then build the Whonix pacakges in the build stage (`make qubes-vm`) and they would then be available to install in the build-template stage (`make template`) thus allowing for a fully integrated Whonix build.  This involves adding the Whonix packages to `COMPONENTS` in the `builder.conf` file in `template-whonix` and then they will be downloaded to `qubes-src` directory"},{"author":"Patrick","date_created":1439387122,"date_modified":1439387122,"content":"Stage 1 sounds good.\n\nNot sure about Stage 2. Building all packages in the (jessie) chroot so build dependencies are not installed within the image would be nice. No idea how much work that would be. qubes-builder would have to be modified to be able to build Whonix's packages. (With dynamic replace of debian/rules hack - building the same packages using two different ways is inviting trouble.) qubes-builder could even build those packages using genmkfile - since genmkfile is usable without installing it on the build machine. (Thanks to environment variable `GENMKFILE_PATH`.)\n\nAnyhow. Implemented this ticket.\n\n-----\n\n`integrated Qubes-Whonix firewall rules (only load when run in Qubes) so those can be removed from the qubes-whonix package, deprecated GATEWAY_IPv4_DROP_INVALID_INCOMING_PACKAGES_POST_HOOK - https://phabricator.whonix.org/T395`:\nhttps://github.com/Whonix/whonix-gw-firewall/commit/e0b5d9e2e9d60c634b48584961c7493adc517ead\n\n`merged whonix-firewall-plugin.sh into whonix-gw-firewall - https://phabricator.whonix.org/T395`:\nhttps://github.com/adrelanos/qubes-whonix/commit/d0ff132edb201deca855f351c81da48d797d6a3f\n\n`integrated Qubes-Whonix firewall rules (only load when run in Qubes) so those can be removed from the qubes-whonix package, deprecated GATEWAY_IPv4_DROP_INVALID_INCOMING_PACKAGES_POST_HOOK - https://phabricator.whonix.org/T395 `:\nhttps://github.com/Whonix/whonix-gw-firewall/commit/e0b5d9e2e9d60c634b48584961c7493adc517ead\n\n`refactoring Qubes firewall rules, 'export' for variables INT_IF and INT_TIF not required, therefore removed`:\nhttps://github.com/Whonix/whonix-gw-firewall/commit/a88586071ba4026fdb3b025c393ff9a8d7dba355\n\n`whonix-gw-firewall: refactoring, set INT_IF and INT_TIF for Qubes earlier (below the regular setting of these variables)`:\nhttps://github.com/Whonix/whonix-gw-firewall/commit/907f999c9ddc6d9b7bec9eb04c8a5f503cd87c2f\n"}]},"PHID-TASK-esuomve7toexv5cv6mbk":{"id":"394","title":"let Whonix's build script instead of Qubes Builder keep care of building the qubes-whonix package","status":"resolved","priority":"Normal","author":"Patrick","description":"During cleanup / refactoring of the qubes-whonix package, I was wondering...\n\nFor #Whonix_12, I intent to have Whonix's build script build and install the qubes-whonix package. Is there any reason against that?\n\nMust Qubes Builder be capable of building the qubes-whonix package for some reason?\n\n@nrgaway","comments":[{"author":"Patrick","date_created":1439565621,"date_modified":1439565621,"content":"I've succeeding having the qubes-whonix package build and install using Whonix's build script. It's dependencies, Qubes' packages such as qubes-core-agent are created by Qubes Builder (by the usual 'make qubes-vm') and installed from Qubes' local apt repository by Whonix's build script. Qubes' local apt repository gets added before Whonix's build script gets executed by installQubesRepo."}]},"PHID-TASK-na4gzzyrjscttjrsdqhn":{"id":"393","title":"scale down firewall.png to avoid triggering qrexec bug","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/whonix-gw-firewall/blob/master/usr/share/applications/gateway-firewall30default.desktop#L12\n\nhttps://github.com/Whonix/anon-icon-pack/blob/master/usr/share/icons/anon-icon-pack/firewall.png\n\nhttps://github.com/QubesOS/qubes-issues/issues/1095#issuecomment-129236062","comments":[{"author":"Patrick","date_created":1439599019,"date_modified":1439599019,"content":"`scaled down firewall.png from 720x720 to 256x256 using 'convert -resize 256x256 firewall.png firewall.png_' because it was triggering a qrexec bug - https://phabricator.whonix.org/T393`\nhttps://github.com/Whonix/anon-icon-pack/commit/5dd1d2c71e6b0f1648316a3dfa7b85841e5f93de\n"}]},"PHID-TASK-tjv2wijxqjeibbxzbccs":{"id":"392","title":"Qubes-Whonix-Workstation 11 build breaks during qubes package standard list installation","status":"resolved","priority":"High","author":"Patrick","description":"```\n+ debug 'Installing extra packages from: /home/user/qubes-builder/qubes-src/builder-debian/template_debian/packages_qubes_standard.list'\n+ output 'DEBUG: Installing' extra packages from: '/home/user/qubes-builder/qubes-src/builder-debian/template_debian/packages_qubes_standard.list'\n+ '[' 2 -ge 1 ']'\n+ [[ -z '' ]]\n+ [[ ehB != ehxB ]]\n+ declare -a packages\n+ readarray -t packages\n+ info 'Packages: xdg-user-dirs' gnome-themes-standard xsettingsd gnome-packagekit qubes-pdf-converter qubes-gpg-split qubes-thunderbird ''\n+ output 'INFO: Packages:' xdg-user-dirs gnome-themes-standard xsettingsd gnome-packagekit qubes-pdf-converter qubes-gpg-split qubes-thunderbird ''\n+ '[' 2 -ge 1 ']'\n+ [[ -z '' ]]\n+ [[ ehB != ehxB ]]\n+ aptInstall xdg-user-dirs gnome-themes-standard xsettingsd gnome-packagekit '' qubes-pdf-converter qubes-gpg-split qubes-thunderbird ''\n+ files='xdg-user-dirs gnome-themes-standard xsettingsd gnome-packagekit  qubes-pdf-converter qubes-gpg-split qubes-thunderbird '\n+ DEBIAN_FRONTEND=noninteractive\n+ DEBIAN_PRIORITY=critical\n+ DEBCONF_NOWARNINGS=yes\n+ chroot eatmydata apt-get -o Dpkg::Options::=--force-confnew --yes -o Acquire::Retries=3 -o Dpkg::Options::=--force-unsafe-io install xdg-user-dirs gnome-themes-standard xsettingsd gnome-packagekit qubes-pdf-converter qubes-gpg-split qubes-thunderbird\n+ local retval\n+ true ''\n+ '[' '' == 1 ']'\n+ /usr/sbin/chroot mnt eatmydata apt-get -o Dpkg::Options::=--force-confnew --yes -o Acquire::Retries=3 -o Dpkg::Options::=--force-unsafe-io install xdg-user-dirs gnome-themes-standard xsettingsd gnome-packagekit qubes-pdf-converter qubes-gpg-split qubes-thunderbird\nReading package lists... Done\nBuilding dependency tree       \nReading state information... Done\nxdg-user-dirs is already the newest version.\nxdg-user-dirs set to manually installed.\nThe following extra packages will be installed:\n  at-spi2-core desktop-file-utils dosfstools eject fuse gcr gdebi-core gdisk ghostscript gir1.2-clutter-1.0 gir1.2-clutter-gst-2.0 gir1.2-cogl-1.0\n  gir1.2-coglpango-1.0 gir1.2-evince-3.0 gir1.2-gst-plugins-base-1.0 gir1.2-gstreamer-1.0 gir1.2-gtkclutter-1.0 gir1.2-gtksource-3.0\n  gir1.2-javascriptcoregtk-3.0 gir1.2-json-1.0 gir1.2-nautilus-3.0 gir1.2-soup-2.4 gir1.2-webkit-3.0 gnome-accessibility-themes gnome-desktop3-data\n  gnome-icon-theme gnome-icon-theme-symbolic gnome-keyring gnome-packagekit-data gnome-packagekit-session gnome-settings-daemon gnome-sushi\n  gnome-themes-standard-data gsfonts gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-x gtk2-engines-pixbuf gvfs gvfs-backends gvfs-common\n  gvfs-daemons gvfs-libs hwdata icedove imagemagick imagemagick-6.q16 imagemagick-common libasound2-plugins libavahi-glib1 libcanberra-gtk3-0\n  libcanberra-gtk3-module libcdio-cdda1 libcdio-paranoia1 libcdparanoia0 libclutter-1.0-0 libclutter-1.0-common libclutter-gst-2.0-0 libclutter-gtk-1.0-0\n  libcogl-common libcogl-pango20 libcogl-path20 libcogl20 libdjvulibre-text libdjvulibre21 libdv4 libelfg0 libevdocument3-4 libevview3-3 libexempi3\n  libexif12 libfftw3-double3 libfftw3-single3 libgail-3-0 libgck-1-0 libgcr-3-common libgcr-base-3-1 libgcr-ui-3-1 libgd3 libgeocode-glib0 libgjs0e\n  libglib2.0-bin libglu1-mesa libgnome-desktop-3-10 libgoa-1.0-0b libgoa-1.0-common libgphoto2-6 libgphoto2-l10n libgphoto2-port10 libgtksourceview-3.0-1\n  libgtksourceview-3.0-common libgweather-3-6 libgweather-common libgxps2 libiec61883-0 libinput5 libiptcdata0 libkpathsea6 liblqr-1-0\n  libmagickcore-6.q16-2 libmagickcore-6.q16-2-extra libmagickwand-6.q16-2 libmediaart-1.0-0 libmozjs-24-0 libmusicbrainz5-1 libnautilus-extension1a\n  libneon27-gnutls libnetpbm10 libnspr4 libnss3 libpackagekit-glib2-18 libpam-gnome-keyring libpulsedsp libtracker-sparql-1.0-0 libudisks2-0 libv4l-0\n  libv4lconvert0 libvisual-0.4-0 libvisual-0.4-plugins libwacom-common libwacom2 libwavpack1 libwebrtc-audio-processing-0 libwmf0.2-7 myspell-en-us\n  nautilus nautilus-data netpbm ntfs-3g p11-kit p11-kit-modules packagekit packagekit-tools parted policykit-1-gnome poppler-utils pulseaudio\n  pulseaudio-module-x11 pulseaudio-utils python-nautilus rtkit udisks2\nSuggested packages:\n  cdtool setcd ghostscript-x gnome-screensaver gstreamer1.0-libav obex-data-server samba-common fonts-lyx imagemagick-doc autotrace cups-bsd lpr lprng\n  enscript ffmpeg gimp gnuplot grads graphviz hp2xx html2ps libwmf-bin mplayer povray radiance sane-utils texlive-base-bin transfig ufraw-batch libdv-bin\n  oss-compat libfftw3-bin libfftw3-dev libgd-tools gphoto2 gtkam inkscape brasero eog tracker appstream-index parted-doc pavumeter pavucontrol paman\n  paprefs avahi-daemon xfsprogs reiserfsprogs exfat-utils btrfs-tools mdadm\nThe following NEW packages will be installed:\n  at-spi2-core desktop-file-utils dosfstools eject fuse gcr gdebi-core gdisk ghostscript gir1.2-clutter-1.0 gir1.2-clutter-gst-2.0 gir1.2-cogl-1.0\n  gir1.2-coglpango-1.0 gir1.2-evince-3.0 gir1.2-gst-plugins-base-1.0 gir1.2-gstreamer-1.0 gir1.2-gtkclutter-1.0 gir1.2-gtksource-3.0\n  gir1.2-javascriptcoregtk-3.0 gir1.2-json-1.0 gir1.2-nautilus-3.0 gir1.2-soup-2.4 gir1.2-webkit-3.0 gnome-accessibility-themes gnome-desktop3-data\n  gnome-icon-theme gnome-icon-theme-symbolic gnome-keyring gnome-packagekit gnome-packagekit-data gnome-packagekit-session gnome-settings-daemon\n  gnome-sushi gnome-themes-standard gnome-themes-standard-data gsfonts gstreamer1.0-plugins-base gstreamer1.0-plugins-good gstreamer1.0-x\n  gtk2-engines-pixbuf gvfs gvfs-backends gvfs-common gvfs-daemons gvfs-libs hwdata icedove imagemagick imagemagick-6.q16 imagemagick-common\n  libasound2-plugins libavahi-glib1 libcanberra-gtk3-0 libcanberra-gtk3-module libcdio-cdda1 libcdio-paranoia1 libcdparanoia0 libclutter-1.0-0\n  libclutter-1.0-common libclutter-gst-2.0-0 libclutter-gtk-1.0-0 libcogl-common libcogl-pango20 libcogl-path20 libcogl20 libdjvulibre-text libdjvulibre21\n  libdv4 libelfg0 libevdocument3-4 libevview3-3 libexempi3 libexif12 libfftw3-double3 libfftw3-single3 libgail-3-0 libgck-1-0 libgcr-3-common\n  libgcr-base-3-1 libgcr-ui-3-1 libgd3 libgeocode-glib0 libgjs0e libglib2.0-bin libglu1-mesa libgnome-desktop-3-10 libgoa-1.0-0b libgoa-1.0-common\n  libgphoto2-6 libgphoto2-l10n libgphoto2-port10 libgtksourceview-3.0-1 libgtksourceview-3.0-common libgweather-3-6 libgweather-common libgxps2\n  libiec61883-0 libinput5 libiptcdata0 libkpathsea6 liblqr-1-0 libmagickcore-6.q16-2 libmagickcore-6.q16-2-extra libmagickwand-6.q16-2 libmediaart-1.0-0\n  libmozjs-24-0 libmusicbrainz5-1 libnautilus-extension1a libneon27-gnutls libnetpbm10 libnspr4 libnss3 libpackagekit-glib2-18 libpam-gnome-keyring\n  libpulsedsp libtracker-sparql-1.0-0 libudisks2-0 libv4l-0 libv4lconvert0 libvisual-0.4-0 libvisual-0.4-plugins libwacom-common libwacom2 libwavpack1\n  libwebrtc-audio-processing-0 libwmf0.2-7 myspell-en-us nautilus nautilus-data netpbm ntfs-3g p11-kit p11-kit-modules packagekit packagekit-tools parted\n  policykit-1-gnome poppler-utils pulseaudio pulseaudio-module-x11 pulseaudio-utils python-nautilus qubes-gpg-split qubes-pdf-converter qubes-thunderbird\n  rtkit udisks2 xsettingsd\n0 upgraded, 148 newly installed, 0 to remove and 1 not upgraded.\nNeed to get 93.4 MB/93.4 MB of archives.\nAfter this operation, 288 MB of additional disk space will be used.\nGet:1 http://security.debian.org/ jessie/updates/main libwmf0.2-7 amd64 0.2.8.4-10.3+deb8u1 [164 kB]\nGet:2 http://security.debian.org/ jessie/updates/main fuse amd64 2.9.3-15+deb8u1 [70.4 kB]\nGet:3 http://ftp.us.debian.org/debian/ jessie/main gnome-themes-standard-data all 3.14.2.2-1 [533 kB]\nGet:4 http://security.debian.org/ jessie/updates/main ntfs-3g amd64 1:2014.2.15AR.2-1+deb8u2 [488 kB]\nGet:5 http://security.debian.org/ jessie/updates/main ghostscript amd64 9.06~dfsg-2+deb8u1 [84.0 kB]\nGet:6 http://security.debian.org/ jessie/updates/main icedove amd64 31.8.0-1~deb8u1 [30.5 MB]\nGet:7 http://ftp.us.debian.org/debian/ jessie/main gnome-themes-standard amd64 3.14.2.2-1 [484 kB]\nGet:8 http://ftp.us.debian.org/debian/ jessie/main imagemagick-common all 8:6.8.9.9-5 [148 kB]\nGet:9 http://ftp.us.debian.org/debian/ jessie/main libasound2-plugins amd64 1.0.28-1+b1 [71.7 kB]\nGet:10 http://ftp.us.debian.org/debian/ jessie/main libavahi-glib1 amd64 0.6.31-5 [36.4 kB]\nGet:11 http://ftp.us.debian.org/debian/ jessie/main libcanberra-gtk3-0 amd64 0.30-2.1 [14.9 kB]\nGet:12 http://ftp.us.debian.org/debian/ jessie/main libcdparanoia0 amd64 3.10.2+debian-11 [56.6 kB]\nGet:13 http://ftp.us.debian.org/debian/ jessie/main libcogl20 amd64 1.18.2-3 [267 kB]\nGet:14 http://ftp.us.debian.org/debian/ jessie/main libcogl-pango20 amd64 1.18.2-3 [39.8 kB]\nGet:15 http://ftp.us.debian.org/debian/ jessie/main libcogl-path20 amd64 1.18.2-3 [56.1 kB]\nGet:16 http://ftp.us.debian.org/debian/ jessie/main libinput5 amd64 0.6.0+dfsg-2 [28.7 kB]\nGet:17 http://ftp.us.debian.org/debian/ jessie/main libclutter-1.0-0 amd64 1.20.0-1 [546 kB]\nGet:18 http://ftp.us.debian.org/debian/ jessie/main libclutter-gst-2.0-0 amd64 2.0.12-1 [37.2 kB]\nGet:19 http://ftp.us.debian.org/debian/ jessie/main libclutter-gtk-1.0-0 amd64 1.6.0-1 [26.2 kB]\nGet:20 http://ftp.us.debian.org/debian/ jessie/main libdjvulibre-text all 3.5.25.4-4 [59.8 kB]\nGet:21 http://ftp.us.debian.org/debian/ jessie/main libdjvulibre21 amd64 3.5.25.4-4+b1 [578 kB]\nGet:22 http://ftp.us.debian.org/debian/ jessie/main libdv4 amd64 1.0.0-6 [82.7 kB]\nGet:23 http://ftp.us.debian.org/debian/ jessie/main libelfg0 amd64 0.8.13-5 [51.6 kB]\nGet:24 http://ftp.us.debian.org/debian/ jessie/main libexempi3 amd64 2.2.1-2 [395 kB]\nGet:25 http://ftp.us.debian.org/debian/ jessie/main libexif12 amd64 0.6.21-2 [324 kB]\nGet:26 http://ftp.us.debian.org/debian/ jessie/main libfftw3-double3 amd64 3.3.4-2 [722 kB]                                                                 \nGet:27 http://ftp.us.debian.org/debian/ jessie/main libfftw3-single3 amd64 3.3.4-2 [754 kB]                                                                 \nGet:28 http://ftp.us.debian.org/debian/ jessie/main at-spi2-core amd64 2.14.0-1 [46.6 kB]                                                                   \nGet:29 http://ftp.us.debian.org/debian/ jessie/main libgail-3-0 amd64 3.14.5-1 [66.8 kB]                                                                    \nGet:30 http://ftp.us.debian.org/debian/ jessie/main libgck-1-0 amd64 3.14.0-2 [88.2 kB]                                                                     \nGet:31 http://ftp.us.debian.org/debian/ jessie/main libgcr-3-common all 3.14.0-2 [18.6 kB]                                                                  \nGet:32 http://ftp.us.debian.org/debian/ jessie/main libgcr-base-3-1 amd64 3.14.0-2 [203 kB]                                                                 \nGet:33 http://ftp.us.debian.org/debian/ jessie/main libgcr-ui-3-1 amd64 3.14.0-2 [157 kB]                                                                   \nGet:34 http://ftp.us.debian.org/debian/ jessie/main libgd3 amd64 2.1.0-5 [147 kB]                                                                           \nGet:35 http://ftp.us.debian.org/debian/ jessie/main libglu1-mesa amd64 9.0.0-2 [163 kB]                                                                     \nGet:36 http://ftp.us.debian.org/debian/ jessie/main libgoa-1.0-common all 3.14.2-1 [289 kB]                                                                 \nGet:37 http://ftp.us.debian.org/debian/ jessie/main libgoa-1.0-0b amd64 3.14.2-1 [70.2 kB]                                                                  \nGet:38 http://ftp.us.debian.org/debian/ jessie/main libgphoto2-port10 amd64 2.5.4-1.1+b2 [146 kB]                                                           \nGet:39 http://ftp.us.debian.org/debian/ jessie/main libgphoto2-6 amd64 2.5.4-1.1+b2 [823 kB]                                                                \nGet:40 http://ftp.us.debian.org/debian/ jessie/main libgtksourceview-3.0-common all 3.14.1-1 [621 kB]                                                       \nGet:41 http://ftp.us.debian.org/debian/ jessie/main libgtksourceview-3.0-1 amd64 3.14.1-1 [201 kB]                                                          \nGet:42 http://ftp.us.debian.org/debian/ jessie/main libgxps2 amd64 0.2.2-3+b2 [53.5 kB]                                                                     \nGet:43 http://ftp.us.debian.org/debian/ jessie/main libiec61883-0 amd64 1.2.0-0.2 [30.2 kB]                                                                 \nGet:44 http://ftp.us.debian.org/debian/ jessie/main liblqr-1-0 amd64 0.4.2-2 [24.6 kB]                                                                      \nGet:45 http://ftp.us.debian.org/debian/ jessie/main libmagickcore-6.q16-2 amd64 8:6.8.9.9-5 [1677 kB]                                                       \nGet:46 http://ftp.us.debian.org/debian/ jessie/main libmagickwand-6.q16-2 amd64 8:6.8.9.9-5 [404 kB]                                                        \nGet:47 http://ftp.us.debian.org/debian/ jessie/main libmediaart-1.0-0 amd64 0.7.0-2 [21.0 kB]                                                               \nGet:48 http://ftp.us.debian.org/debian/ jessie/main libneon27-gnutls amd64 0.30.1-1 [133 kB]                                                                \nGet:49 http://ftp.us.debian.org/debian/ jessie/main libmusicbrainz5-1 amd64 5.1.0-2 [125 kB]                                                                \nGet:50 http://ftp.us.debian.org/debian/ jessie/main libnspr4 amd64 2:4.10.7-1 [116 kB]                                                                      \nGet:51 http://ftp.us.debian.org/debian/ jessie/main libnss3 amd64 2:3.17.2-1.1 [1130 kB]                                                                    \nGet:52 http://ftp.us.debian.org/debian/ jessie/main libpackagekit-glib2-18 amd64 1.0.1-2 [111 kB]                                                           \nGet:53 http://ftp.us.debian.org/debian/ jessie/main libpulsedsp amd64 5.0-13 [38.4 kB]                                                                      \nGet:54 http://ftp.us.debian.org/debian/ jessie/main libiptcdata0 amd64 1.0.4-4 [27.9 kB]                                                                    \nGet:55 http://ftp.us.debian.org/debian/ jessie/main libtracker-sparql-1.0-0 amd64 1.2.4-2 [604 kB]                                                          \nGet:56 http://ftp.us.debian.org/debian/ jessie/main libudisks2-0 amd64 2.1.3-5 [96.6 kB]                                                                    \nGet:57 http://ftp.us.debian.org/debian/ jessie/main libv4lconvert0 amd64 1.6.0-2 [108 kB]                                                                   \nGet:58 http://ftp.us.debian.org/debian/ jessie/main libv4l-0 amd64 1.6.0-2 [71.8 kB]                                                                        \nGet:59 http://ftp.us.debian.org/debian/ jessie/main libvisual-0.4-0 amd64 0.4.0-6 [121 kB]                                                                  \nGet:60 http://ftp.us.debian.org/debian/ jessie/main libwacom-common all 0.8-1 [19.6 kB]                                                                     \nGet:61 http://ftp.us.debian.org/debian/ jessie/main libwacom2 amd64 0.8-1 [15.9 kB]                                                                         \nGet:62 http://ftp.us.debian.org/debian/ jessie/main libwavpack1 amd64 4.70.0-1 [81.2 kB]                                                                    \nGet:63 http://ftp.us.debian.org/debian/ jessie/main libwebrtc-audio-processing-0 amd64 0.1-3 [97.8 kB]                                                      \nGet:64 http://ftp.us.debian.org/debian/ jessie/main desktop-file-utils amd64 0.22-1 [76.0 kB]                                                               \nGet:65 http://ftp.us.debian.org/debian/ jessie/main dosfstools amd64 3.0.27-1 [87.8 kB]                                                                     \nGet:66 http://ftp.us.debian.org/debian/ jessie/main eject amd64 2.1.5+deb1+cvs20081104-13.1 [50.7 kB]                                                       \nGet:67 http://ftp.us.debian.org/debian/ jessie/main gcr amd64 3.14.0-2 [218 kB]                                                                             \nGet:68 http://ftp.us.debian.org/debian/ jessie/main gdebi-core all 0.9.5.5+nmu1 [134 kB]                                                                    \nGet:69 http://ftp.us.debian.org/debian/ jessie/main gsfonts all 1:8.11+urwcyr1.0.7~pre44-4.2 [3364 kB]                                                      \nGet:70 http://ftp.us.debian.org/debian/ jessie/main gir1.2-cogl-1.0 amd64 1.18.2-3 [57.0 kB]                                                                \nGet:71 http://ftp.us.debian.org/debian/ jessie/main gir1.2-coglpango-1.0 amd64 1.18.2-3 [29.7 kB]                                                           \nGet:72 http://ftp.us.debian.org/debian/ jessie/main gir1.2-json-1.0 amd64 1.0.2-1 [114 kB]                                                                  \nGet:73 http://ftp.us.debian.org/debian/ jessie/main gir1.2-clutter-1.0 amd64 1.20.0-1 [209 kB]                                                              \nGet:74 http://ftp.us.debian.org/debian/ jessie/main gir1.2-gstreamer-1.0 amd64 1.4.4-2 [885 kB]                                                             \nGet:75 http://ftp.us.debian.org/debian/ jessie/main gir1.2-gst-plugins-base-1.0 amd64 1.4.4-2 [819 kB]                                                      \nGet:76 http://ftp.us.debian.org/debian/ jessie/main gir1.2-clutter-gst-2.0 amd64 2.0.12-1 [11.4 kB]                                                         \nGet:77 http://ftp.us.debian.org/debian/ jessie/main libkpathsea6 amd64 2014.20140926.35254-6 [154 kB]                                                       \nGet:78 http://ftp.us.debian.org/debian/ jessie/main libevdocument3-4 amd64 3.14.1-2 [773 kB]                                                                \nGet:79 http://ftp.us.debian.org/debian/ jessie/main libevview3-3 amd64 3.14.1-2 [708 kB]                                                                    \nGet:80 http://ftp.us.debian.org/debian/ jessie/main gir1.2-evince-3.0 amd64 3.14.1-2 [616 kB]                                                               \nGet:81 http://ftp.us.debian.org/debian/ jessie/main gir1.2-gtkclutter-1.0 amd64 1.6.0-1 [11.3 kB]                                                           \nGet:82 http://ftp.us.debian.org/debian/ jessie/main gir1.2-gtksource-3.0 amd64 3.14.1-1 [32.8 kB]                                                           \nGet:83 http://ftp.us.debian.org/debian/ jessie/main gir1.2-javascriptcoregtk-3.0 amd64 2.4.8-2 [117 kB]                                                     \nGet:84 http://ftp.us.debian.org/debian/ jessie/main libnautilus-extension1a amd64 3.14.1-2 [71.6 kB]                                                        \nGet:85 http://ftp.us.debian.org/debian/ jessie/main gir1.2-nautilus-3.0 amd64 3.14.1-2 [63.8 kB]                                                            \nGet:86 http://ftp.us.debian.org/debian/ jessie/main gir1.2-soup-2.4 amd64 2.48.0-1 [75.1 kB]                                                                \nGet:87 http://ftp.us.debian.org/debian/ jessie/main gir1.2-webkit-3.0 amd64 2.4.8-2 [167 kB]                                                                \nGet:88 http://ftp.us.debian.org/debian/ jessie/main gnome-accessibility-themes all 3.14.2.2-1 [2920 kB]                                                     \nGet:89 http://ftp.us.debian.org/debian/ jessie/main gnome-desktop3-data all 3.14.1-1 [525 kB]                                                               \nGet:90 http://ftp.us.debian.org/debian/ jessie/main gnome-icon-theme all 3.12.0-1 [9898 kB]                                                                 \nGet:91 http://ftp.us.debian.org/debian/ jessie/main gnome-icon-theme-symbolic all 3.12.0-1 [145 kB]                                                         \nGet:92 http://ftp.us.debian.org/debian/ jessie/main p11-kit-modules amd64 0.20.7-1 [72.9 kB]                                                                \nGet:93 http://ftp.us.debian.org/debian/ jessie/main p11-kit amd64 0.20.7-1 [103 kB]                                                                         \nGet:94 http://ftp.us.debian.org/debian/ jessie/main gnome-keyring amd64 3.14.0-1+b1 [962 kB]                                                                \nGet:95 http://ftp.us.debian.org/debian/ jessie/main gnome-packagekit-data all 3.14.0-1 [1302 kB]                                                            \nGet:96 http://ftp.us.debian.org/debian/ jessie/main libgeocode-glib0 amd64 3.14.0-1 [66.9 kB]                                                               \nGet:97 http://ftp.us.debian.org/debian/ jessie/main libgnome-desktop-3-10 amd64 3.14.1-1 [238 kB]                                                           \nGet:98 http://ftp.us.debian.org/debian/ jessie/main libgweather-common all 3.14.1-1 [2201 kB]                                                               \nGet:99 http://ftp.us.debian.org/debian/ jessie/main libgweather-3-6 amd64 3.14.1-1 [66.3 kB]                                                                \nGet:100 http://ftp.us.debian.org/debian/ jessie/main nautilus-data all 3.14.1-2 [1697 kB]                                                                   \nGet:101 http://ftp.us.debian.org/debian/ jessie/main gnome-settings-daemon amd64 3.14.2-3 [1177 kB]                                                         \nGet:102 http://ftp.us.debian.org/debian/ jessie/main libglib2.0-bin amd64 2.42.1-1 [1335 kB]                                                                \nGet:103 http://ftp.us.debian.org/debian/ jessie/main packagekit amd64 1.0.1-2 [544 kB]                                                                      \nGet:104 http://ftp.us.debian.org/debian/ jessie/main gnome-packagekit-session amd64 3.14.0-1 [340 kB]                                                       \nGet:105 http://ftp.us.debian.org/debian/ jessie/main gnome-packagekit amd64 3.14.0-1 [398 kB]                                                               \nGet:106 http://ftp.us.debian.org/debian/ jessie/main gstreamer1.0-plugins-base amd64 1.4.4-2 [1284 kB]                                                      \nGet:107 http://ftp.us.debian.org/debian/ jessie/main gstreamer1.0-plugins-good amd64 1.4.4-2 [2365 kB]                                                      \nGet:108 http://ftp.us.debian.org/debian/ jessie/main gstreamer1.0-x amd64 1.4.4-2 [830 kB]                                                                  \nGet:109 http://ftp.us.debian.org/debian/ jessie/main gtk2-engines-pixbuf amd64 2.24.25-3 [544 kB]                                                           \nGet:110 http://ftp.us.debian.org/debian/ jessie/main parted amd64 3.2-7 [195 kB]                                                                            \nGet:111 http://ftp.us.debian.org/debian/ jessie/main udisks2 amd64 2.1.3-5 [263 kB]                                                                         \nGet:112 http://ftp.us.debian.org/debian/ jessie/main gvfs-common all 1.22.2-1 [739 kB]                                                                      \nGet:113 http://ftp.us.debian.org/debian/ jessie/main gvfs-libs amd64 1.22.2-1 [333 kB]                                                                      \nGet:114 http://ftp.us.debian.org/debian/ jessie/main gvfs-daemons amd64 1.22.2-1 [353 kB]                                                                   \nGet:115 http://ftp.us.debian.org/debian/ jessie/main gvfs amd64 1.22.2-1 [334 kB]                                                                           \nGet:116 http://ftp.us.debian.org/debian/ jessie/main libcdio-cdda1 amd64 0.83-4.2 [132 kB]                                                                  \nGet:117 http://ftp.us.debian.org/debian/ jessie/main libcdio-paranoia1 amd64 0.83-4.2 [132 kB]                                                              \nGet:118 http://ftp.us.debian.org/debian/ jessie/main gvfs-backends amd64 1.22.2-1 [533 kB]                                                                  \nGet:119 http://ftp.us.debian.org/debian/ jessie/main hwdata all 0.267-1 [32.9 kB]                                                                           \nGet:120 http://ftp.us.debian.org/debian/ jessie/main imagemagick-6.q16 amd64 8:6.8.9.9-5 [512 kB]                                                           \nGet:121 http://ftp.us.debian.org/debian/ jessie/main imagemagick amd64 8:6.8.9.9-5 [155 kB]                                                                 \nGet:122 http://ftp.us.debian.org/debian/ jessie/main libcanberra-gtk3-module amd64 0.30-2.1 [16.8 kB]                                                       \nGet:123 http://ftp.us.debian.org/debian/ jessie/main libclutter-1.0-common all 1.20.0-1 [433 kB]                                                            \nGet:124 http://ftp.us.debian.org/debian/ jessie/main libcogl-common all 1.18.2-3 [259 kB]                                                                   \nGet:125 http://ftp.us.debian.org/debian/ jessie/main libmozjs-24-0 amd64 24.2.0-2 [1663 kB]                                                                 \nGet:126 http://ftp.us.debian.org/debian/ jessie/main libgjs0e amd64 1.42.0-1 [161 kB]                                                                       \nGet:127 http://ftp.us.debian.org/debian/ jessie/main libgphoto2-l10n all 2.5.4-1.1 [440 kB]                                                                 \nGet:128 http://ftp.us.debian.org/debian/ jessie/main libmagickcore-6.q16-2-extra amd64 8:6.8.9.9-5 [168 kB]                                                 \nGet:129 http://ftp.us.debian.org/debian/ jessie/main libnetpbm10 amd64 2:10.0-15.2 [84.4 kB]                                                                \nGet:130 http://ftp.us.debian.org/debian/ jessie/main libpam-gnome-keyring amd64 3.14.0-1+b1 [287 kB]                                                        \nGet:131 http://ftp.us.debian.org/debian/ jessie/main libvisual-0.4-plugins amd64 0.4.0.dfsg.1-7 [147 kB]                                                    \nGet:132 http://ftp.us.debian.org/debian/ jessie/main myspell-en-us all 1:3.3.0-4 [233 kB]                                                                   \nGet:133 http://ftp.us.debian.org/debian/ jessie/main nautilus amd64 3.14.1-2 [552 kB]                                                                       \nGet:134 http://ftp.us.debian.org/debian/ jessie/main netpbm amd64 2:10.0-15.2 [994 kB]                                                                      \nGet:135 http://ftp.us.debian.org/debian/ jessie/main packagekit-tools amd64 1.0.1-2 [43.3 kB]                                                               \nGet:136 http://ftp.us.debian.org/debian/ jessie/main policykit-1-gnome amd64 0.105-2 [89.1 kB]                                                              \nGet:137 http://ftp.us.debian.org/debian/ jessie/main poppler-utils amd64 0.26.5-2 [140 kB]                                                                  \nGet:138 http://ftp.us.debian.org/debian/ jessie/main pulseaudio-utils amd64 5.0-13 [68.4 kB]                                                                \nGet:139 http://ftp.us.debian.org/debian/ jessie/main pulseaudio amd64 5.0-13 [971 kB]                                                                       \nGet:140 http://ftp.us.debian.org/debian/ jessie/main pulseaudio-module-x11 amd64 5.0-13 [33.4 kB]                                                           \nGet:141 http://ftp.us.debian.org/debian/ jessie/main python-nautilus amd64 1.1-4 [18.3 kB]                                                                  \nGet:142 http://ftp.us.debian.org/debian/ jessie/main rtkit amd64 0.11-2 [29.4 kB]                                                                           \nGet:143 http://ftp.us.debian.org/debian/ jessie/main xsettingsd amd64 0.0.20121210+72+g474f18a-1 [20.9 kB]                                                  \nGet:144 http://ftp.us.debian.org/debian/ jessie/main gdisk amd64 0.8.10-2 [197 kB]                                                                          \nGet:145 http://ftp.us.debian.org/debian/ jessie/main gnome-sushi amd64 3.12.0-2+b1 [68.5 kB]                                                                \nFetched 93.4 MB in 1min 18s (1189 kB/s)                                                                                                                     \nExtracting templates from packages: 100%\nE: Can not write log (Is /dev/pts mounted?) - posix_openpt (2: No such file or directory)\nSelecting previously unselected package gnome-themes-standard-data.\n(Reading database ... 74216 files and directories currently installed.)\nPreparing to unpack .../gnome-themes-standard-data_3.14.2.2-1_all.deb ...\nUnpacking gnome-themes-standard-data (3.14.2.2-1) ...\nSelecting previously unselected package gnome-themes-standard:amd64.\nPreparing to unpack .../gnome-themes-standard_3.14.2.2-1_amd64.deb ...\nUnpacking gnome-themes-standard:amd64 (3.14.2.2-1) ...\nSelecting previously unselected package imagemagick-common.\nPreparing to unpack .../imagemagick-common_8%3a6.8.9.9-5_all.deb ...\nUnpacking imagemagick-common (8:6.8.9.9-5) ...\nSelecting previously unselected package libasound2-plugins:amd64.\nPreparing to unpack .../libasound2-plugins_1.0.28-1+b1_amd64.deb ...\nUnpacking libasound2-plugins:amd64 (1.0.28-1+b1) ...\nSelecting previously unselected package libavahi-glib1:amd64.\nPreparing to unpack .../libavahi-glib1_0.6.31-5_amd64.deb ...\nUnpacking libavahi-glib1:amd64 (0.6.31-5) ...\nSelecting previously unselected package libcanberra-gtk3-0:amd64.\nPreparing to unpack .../libcanberra-gtk3-0_0.30-2.1_amd64.deb ...\nUnpacking libcanberra-gtk3-0:amd64 (0.30-2.1) ...\nSelecting previously unselected package libcdparanoia0:amd64.\nPreparing to unpack .../libcdparanoia0_3.10.2+debian-11_amd64.deb ...\nUnpacking libcdparanoia0:amd64 (3.10.2+debian-11) ...\nSelecting previously unselected package libcogl20:amd64.\nPreparing to unpack .../libcogl20_1.18.2-3_amd64.deb ...\nUnpacking libcogl20:amd64 (1.18.2-3) ...\nSelecting previously unselected package libcogl-pango20:amd64.\nPreparing to unpack .../libcogl-pango20_1.18.2-3_amd64.deb ...\nUnpacking libcogl-pango20:amd64 (1.18.2-3) ...\nSelecting previously unselected package libcogl-path20:amd64.\nPreparing to unpack .../libcogl-path20_1.18.2-3_amd64.deb ...\nUnpacking libcogl-path20:amd64 (1.18.2-3) ...\nSelecting previously unselected package libinput5:amd64.\nPreparing to unpack .../libinput5_0.6.0+dfsg-2_amd64.deb ...\nUnpacking libinput5:amd64 (0.6.0+dfsg-2) ...\nSelecting previously unselected package libclutter-1.0-0:amd64.\nPreparing to unpack .../libclutter-1.0-0_1.20.0-1_amd64.deb ...\nUnpacking libclutter-1.0-0:amd64 (1.20.0-1) ...\nSelecting previously unselected package libclutter-gst-2.0-0:amd64.\nPreparing to unpack .../libclutter-gst-2.0-0_2.0.12-1_amd64.deb ...\nUnpacking libclutter-gst-2.0-0:amd64 (2.0.12-1) ...\nSelecting previously unselected package libclutter-gtk-1.0-0:amd64.\nPreparing to unpack .../libclutter-gtk-1.0-0_1.6.0-1_amd64.deb ...\nUnpacking libclutter-gtk-1.0-0:amd64 (1.6.0-1) ...\nSelecting previously unselected package libdjvulibre-text.\nPreparing to unpack .../libdjvulibre-text_3.5.25.4-4_all.deb ...\nUnpacking libdjvulibre-text (3.5.25.4-4) ...\nSelecting previously unselected package libdjvulibre21:amd64.\nPreparing to unpack .../libdjvulibre21_3.5.25.4-4+b1_amd64.deb ...\nUnpacking libdjvulibre21:amd64 (3.5.25.4-4+b1) ...\nSelecting previously unselected package libdv4:amd64.\nPreparing to unpack .../libdv4_1.0.0-6_amd64.deb ...\nUnpacking libdv4:amd64 (1.0.0-6) ...\nSelecting previously unselected package libelfg0:amd64.\nPreparing to unpack .../libelfg0_0.8.13-5_amd64.deb ...\nUnpacking libelfg0:amd64 (0.8.13-5) ...\nSelecting previously unselected package libexempi3:amd64.\nPreparing to unpack .../libexempi3_2.2.1-2_amd64.deb ...\nUnpacking libexempi3:amd64 (2.2.1-2) ...\nSelecting previously unselected package libexif12:amd64.\nPreparing to unpack .../libexif12_0.6.21-2_amd64.deb ...\nUnpacking libexif12:amd64 (0.6.21-2) ...\nSelecting previously unselected package libfftw3-double3:amd64.\nPreparing to unpack .../libfftw3-double3_3.3.4-2_amd64.deb ...\nUnpacking libfftw3-double3:amd64 (3.3.4-2) ...\nSelecting previously unselected package libfftw3-single3:amd64.\nPreparing to unpack .../libfftw3-single3_3.3.4-2_amd64.deb ...\nUnpacking libfftw3-single3:amd64 (3.3.4-2) ...\nSelecting previously unselected package at-spi2-core.\nPreparing to unpack .../at-spi2-core_2.14.0-1_amd64.deb ...\nUnpacking at-spi2-core (2.14.0-1) ...\nSelecting previously unselected package libgail-3-0:amd64.\nPreparing to unpack .../libgail-3-0_3.14.5-1_amd64.deb ...\nUnpacking libgail-3-0:amd64 (3.14.5-1) ...\nSelecting previously unselected package libgck-1-0:amd64.\nPreparing to unpack .../libgck-1-0_3.14.0-2_amd64.deb ...\nUnpacking libgck-1-0:amd64 (3.14.0-2) ...\nSelecting previously unselected package libgcr-3-common.\nPreparing to unpack .../libgcr-3-common_3.14.0-2_all.deb ...\nUnpacking libgcr-3-common (3.14.0-2) ...\nSelecting previously unselected package libgcr-base-3-1:amd64.\nPreparing to unpack .../libgcr-base-3-1_3.14.0-2_amd64.deb ...\nUnpacking libgcr-base-3-1:amd64 (3.14.0-2) ...\nSelecting previously unselected package libgcr-ui-3-1:amd64.\nPreparing to unpack .../libgcr-ui-3-1_3.14.0-2_amd64.deb ...\nUnpacking libgcr-ui-3-1:amd64 (3.14.0-2) ...\nSelecting previously unselected package libgd3:amd64.\nPreparing to unpack .../libgd3_2.1.0-5_amd64.deb ...\nUnpacking libgd3:amd64 (2.1.0-5) ...\nSelecting previously unselected package libglu1-mesa:amd64.\nPreparing to unpack .../libglu1-mesa_9.0.0-2_amd64.deb ...\nUnpacking libglu1-mesa:amd64 (9.0.0-2) ...\nSelecting previously unselected package libgoa-1.0-common.\nPreparing to unpack .../libgoa-1.0-common_3.14.2-1_all.deb ...\nUnpacking libgoa-1.0-common (3.14.2-1) ...\nSelecting previously unselected package libgoa-1.0-0b:amd64.\nPreparing to unpack .../libgoa-1.0-0b_3.14.2-1_amd64.deb ...\nUnpacking libgoa-1.0-0b:amd64 (3.14.2-1) ...\nSelecting previously unselected package libgphoto2-port10:amd64.\nPreparing to unpack .../libgphoto2-port10_2.5.4-1.1+b2_amd64.deb ...\nUnpacking libgphoto2-port10:amd64 (2.5.4-1.1+b2) ...\nSelecting previously unselected package libgphoto2-6:amd64.\nPreparing to unpack .../libgphoto2-6_2.5.4-1.1+b2_amd64.deb ...\nUnpacking libgphoto2-6:amd64 (2.5.4-1.1+b2) ...\nSelecting previously unselected package libgtksourceview-3.0-common.\nPreparing to unpack .../libgtksourceview-3.0-common_3.14.1-1_all.deb ...\nUnpacking libgtksourceview-3.0-common (3.14.1-1) ...\nSelecting previously unselected package libgtksourceview-3.0-1:amd64.\nPreparing to unpack .../libgtksourceview-3.0-1_3.14.1-1_amd64.deb ...\nUnpacking libgtksourceview-3.0-1:amd64 (3.14.1-1) ...\nSelecting previously unselected package libgxps2:amd64.\nPreparing to unpack .../libgxps2_0.2.2-3+b2_amd64.deb ...\nUnpacking libgxps2:amd64 (0.2.2-3+b2) ...\nSelecting previously unselected package libiec61883-0:amd64.\nPreparing to unpack .../libiec61883-0_1.2.0-0.2_amd64.deb ...\nUnpacking libiec61883-0:amd64 (1.2.0-0.2) ...\nSelecting previously unselected package liblqr-1-0:amd64.\nPreparing to unpack .../liblqr-1-0_0.4.2-2_amd64.deb ...\nUnpacking liblqr-1-0:amd64 (0.4.2-2) ...\nSelecting previously unselected package libmagickcore-6.q16-2:amd64.\nPreparing to unpack .../libmagickcore-6.q16-2_8%3a6.8.9.9-5_amd64.deb ...\nUnpacking libmagickcore-6.q16-2:amd64 (8:6.8.9.9-5) ...\nSelecting previously unselected package libmagickwand-6.q16-2:amd64.\nPreparing to unpack .../libmagickwand-6.q16-2_8%3a6.8.9.9-5_amd64.deb ...\nUnpacking libmagickwand-6.q16-2:amd64 (8:6.8.9.9-5) ...\nSelecting previously unselected package libmediaart-1.0-0:amd64.\nPreparing to unpack .../libmediaart-1.0-0_0.7.0-2_amd64.deb ...\nUnpacking libmediaart-1.0-0:amd64 (0.7.0-2) ...\nSelecting previously unselected package libneon27-gnutls.\nPreparing to unpack .../libneon27-gnutls_0.30.1-1_amd64.deb ...\nUnpacking libneon27-gnutls (0.30.1-1) ...\nSelecting previously unselected package libmusicbrainz5-1:amd64.\nPreparing to unpack .../libmusicbrainz5-1_5.1.0-2_amd64.deb ...\nUnpacking libmusicbrainz5-1:amd64 (5.1.0-2) ...\nSelecting previously unselected package libnspr4:amd64.\nPreparing to unpack .../libnspr4_2%3a4.10.7-1_amd64.deb ...\nUnpacking libnspr4:amd64 (2:4.10.7-1) ...\nSelecting previously unselected package libnss3:amd64.\nPreparing to unpack .../libnss3_2%3a3.17.2-1.1_amd64.deb ...\nUnpacking libnss3:amd64 (2:3.17.2-1.1) ...\nSelecting previously unselected package libpackagekit-glib2-18:amd64.\nPreparing to unpack .../libpackagekit-glib2-18_1.0.1-2_amd64.deb ...\nUnpacking libpackagekit-glib2-18:amd64 (1.0.1-2) ...\nSelecting previously unselected package libpulsedsp:amd64.\nPreparing to unpack .../libpulsedsp_5.0-13_amd64.deb ...\nUnpacking libpulsedsp:amd64 (5.0-13) ...\nSelecting previously unselected package libiptcdata0.\nPreparing to unpack .../libiptcdata0_1.0.4-4_amd64.deb ...\nUnpacking libiptcdata0 (1.0.4-4) ...\nSelecting previously unselected package libtracker-sparql-1.0-0:amd64.\nPreparing to unpack .../libtracker-sparql-1.0-0_1.2.4-2_amd64.deb ...\nUnpacking libtracker-sparql-1.0-0:amd64 (1.2.4-2) ...\nSelecting previously unselected package libudisks2-0:amd64.\nPreparing to unpack .../libudisks2-0_2.1.3-5_amd64.deb ...\nUnpacking libudisks2-0:amd64 (2.1.3-5) ...\nSelecting previously unselected package libv4lconvert0:amd64.\nPreparing to unpack .../libv4lconvert0_1.6.0-2_amd64.deb ...\nUnpacking libv4lconvert0:amd64 (1.6.0-2) ...\nSelecting previously unselected package libv4l-0:amd64.\nPreparing to unpack .../libv4l-0_1.6.0-2_amd64.deb ...\nUnpacking libv4l-0:amd64 (1.6.0-2) ...\nSelecting previously unselected package libvisual-0.4-0:amd64.\nPreparing to unpack .../libvisual-0.4-0_0.4.0-6_amd64.deb ...\nUnpacking libvisual-0.4-0:amd64 (0.4.0-6) ...\nSelecting previously unselected package libwacom-common.\nPreparing to unpack .../libwacom-common_0.8-1_all.deb ...\nUnpacking libwacom-common (0.8-1) ...\nSelecting previously unselected package libwacom2:amd64.\nPreparing to unpack .../libwacom2_0.8-1_amd64.deb ...\nUnpacking libwacom2:amd64 (0.8-1) ...\nSelecting previously unselected package libwavpack1:amd64.\nPreparing to unpack .../libwavpack1_4.70.0-1_amd64.deb ...\nUnpacking libwavpack1:amd64 (4.70.0-1) ...\nSelecting previously unselected package libwmf0.2-7:amd64.\nPreparing to unpack .../libwmf0.2-7_0.2.8.4-10.3+deb8u1_amd64.deb ...\nUnpacking libwmf0.2-7:amd64 (0.2.8.4-10.3+deb8u1) ...\nSelecting previously unselected package fuse.\nPreparing to unpack .../fuse_2.9.3-15+deb8u1_amd64.deb ...\nUnpacking fuse (2.9.3-15+deb8u1) ...\nProcessing triggers for libglib2.0-0:amd64 (2.42.1-1) ...\nProcessing triggers for udev (215-17+deb8u1) ...\nProcessing triggers for libgdk-pixbuf2.0-0:amd64 (2.31.1-2+b1) ...\nProcessing triggers for man-db (2.7.0.2-5) ...\nSetting up fuse (2.9.3-15+deb8u1) ...\nMAKEDEV not installed, skipping device node creation.\nupdate-initramfs: deferring update (trigger activated)\nProcessing triggers for initramfs-tools (0.120) ...\nSelecting previously unselected package ntfs-3g.\n(Reading database ... 75841 files and directories currently installed.)\nPreparing to unpack .../ntfs-3g_1%3a2014.2.15AR.2-1+deb8u2_amd64.deb ...\nUnpacking ntfs-3g (1:2014.2.15AR.2-1+deb8u2) ...\nSelecting previously unselected package libwebrtc-audio-processing-0:amd64.\nPreparing to unpack .../libwebrtc-audio-processing-0_0.1-3_amd64.deb ...\nUnpacking libwebrtc-audio-processing-0:amd64 (0.1-3) ...\nSelecting previously unselected package desktop-file-utils.\nPreparing to unpack .../desktop-file-utils_0.22-1_amd64.deb ...\nUnpacking desktop-file-utils (0.22-1) ...\nSelecting previously unselected package dosfstools.\nPreparing to unpack .../dosfstools_3.0.27-1_amd64.deb ...\nUnpacking dosfstools (3.0.27-1) ...\nSelecting previously unselected package eject.\nPreparing to unpack .../eject_2.1.5+deb1+cvs20081104-13.1_amd64.deb ...\nUnpacking eject (2.1.5+deb1+cvs20081104-13.1) ...\nSelecting previously unselected package gcr.\nPreparing to unpack .../gcr_3.14.0-2_amd64.deb ...\nUnpacking gcr (3.14.0-2) ...\nSelecting previously unselected package gdebi-core.\nPreparing to unpack .../gdebi-core_0.9.5.5+nmu1_all.deb ...\nUnpacking gdebi-core (0.9.5.5+nmu1) ...\nSelecting previously unselected package gsfonts.\nPreparing to unpack .../gsfonts_1%3a8.11+urwcyr1.0.7~pre44-4.2_all.deb ...\nUnpacking gsfonts (1:8.11+urwcyr1.0.7~pre44-4.2) ...\nSelecting previously unselected package ghostscript.\nPreparing to unpack .../ghostscript_9.06~dfsg-2+deb8u1_amd64.deb ...\nUnpacking ghostscript (9.06~dfsg-2+deb8u1) ...\nSelecting previously unselected package gir1.2-cogl-1.0.\nPreparing to unpack .../gir1.2-cogl-1.0_1.18.2-3_amd64.deb ...\nUnpacking gir1.2-cogl-1.0 (1.18.2-3) ...\nSelecting previously unselected package gir1.2-coglpango-1.0.\nPreparing to unpack .../gir1.2-coglpango-1.0_1.18.2-3_amd64.deb ...\nUnpacking gir1.2-coglpango-1.0 (1.18.2-3) ...\nSelecting previously unselected package gir1.2-json-1.0.\nPreparing to unpack .../gir1.2-json-1.0_1.0.2-1_amd64.deb ...\nUnpacking gir1.2-json-1.0 (1.0.2-1) ...\nSelecting previously unselected package gir1.2-clutter-1.0.\nPreparing to unpack .../gir1.2-clutter-1.0_1.20.0-1_amd64.deb ...\nUnpacking gir1.2-clutter-1.0 (1.20.0-1) ...\nSelecting previously unselected package gir1.2-gstreamer-1.0.\nPreparing to unpack .../gir1.2-gstreamer-1.0_1.4.4-2_amd64.deb ...\nUnpacking gir1.2-gstreamer-1.0 (1.4.4-2) ...\nSelecting previously unselected package gir1.2-gst-plugins-base-1.0.\nPreparing to unpack .../gir1.2-gst-plugins-base-1.0_1.4.4-2_amd64.deb ...\nUnpacking gir1.2-gst-plugins-base-1.0 (1.4.4-2) ...\nSelecting previously unselected package gir1.2-clutter-gst-2.0.\nPreparing to unpack .../gir1.2-clutter-gst-2.0_2.0.12-1_amd64.deb ...\nUnpacking gir1.2-clutter-gst-2.0 (2.0.12-1) ...\nSelecting previously unselected package libkpathsea6.\nPreparing to unpack .../libkpathsea6_2014.20140926.35254-6_amd64.deb ...\nUnpacking libkpathsea6 (2014.20140926.35254-6) ...\nSelecting previously unselected package libevdocument3-4.\nPreparing to unpack .../libevdocument3-4_3.14.1-2_amd64.deb ...\nUnpacking libevdocument3-4 (3.14.1-2) ...\nSelecting previously unselected package libevview3-3.\nPreparing to unpack .../libevview3-3_3.14.1-2_amd64.deb ...\nUnpacking libevview3-3 (3.14.1-2) ...\nSelecting previously unselected package gir1.2-evince-3.0.\nPreparing to unpack .../gir1.2-evince-3.0_3.14.1-2_amd64.deb ...\nUnpacking gir1.2-evince-3.0 (3.14.1-2) ...\nSelecting previously unselected package gir1.2-gtkclutter-1.0.\nPreparing to unpack .../gir1.2-gtkclutter-1.0_1.6.0-1_amd64.deb ...\nUnpacking gir1.2-gtkclutter-1.0 (1.6.0-1) ...\nSelecting previously unselected package gir1.2-gtksource-3.0:amd64.\nPreparing to unpack .../gir1.2-gtksource-3.0_3.14.1-1_amd64.deb ...\nUnpacking gir1.2-gtksource-3.0:amd64 (3.14.1-1) ...\nSelecting previously unselected package gir1.2-javascriptcoregtk-3.0:amd64.\nPreparing to unpack .../gir1.2-javascriptcoregtk-3.0_2.4.8-2_amd64.deb ...\nUnpacking gir1.2-javascriptcoregtk-3.0:amd64 (2.4.8-2) ...\nSelecting previously unselected package libnautilus-extension1a.\nPreparing to unpack .../libnautilus-extension1a_3.14.1-2_amd64.deb ...\nUnpacking libnautilus-extension1a (3.14.1-2) ...\nSelecting previously unselected package gir1.2-nautilus-3.0.\nPreparing to unpack .../gir1.2-nautilus-3.0_3.14.1-2_amd64.deb ...\nUnpacking gir1.2-nautilus-3.0 (3.14.1-2) ...\nSelecting previously unselected package gir1.2-soup-2.4.\nPreparing to unpack .../gir1.2-soup-2.4_2.48.0-1_amd64.deb ...\nUnpacking gir1.2-soup-2.4 (2.48.0-1) ...\nSelecting previously unselected package gir1.2-webkit-3.0:amd64.\nPreparing to unpack .../gir1.2-webkit-3.0_2.4.8-2_amd64.deb ...\nUnpacking gir1.2-webkit-3.0:amd64 (2.4.8-2) ...\nSelecting previously unselected package gnome-accessibility-themes.\nPreparing to unpack .../gnome-accessibility-themes_3.14.2.2-1_all.deb ...\nUnpacking gnome-accessibility-themes (3.14.2.2-1) ...\nSelecting previously unselected package gnome-desktop3-data.\nPreparing to unpack .../gnome-desktop3-data_3.14.1-1_all.deb ...\nUnpacking gnome-desktop3-data (3.14.1-1) ...\nSelecting previously unselected package gnome-icon-theme.\nPreparing to unpack .../gnome-icon-theme_3.12.0-1_all.deb ...\nUnpacking gnome-icon-theme (3.12.0-1) ...\nSelecting previously unselected package gnome-icon-theme-symbolic.\nPreparing to unpack .../gnome-icon-theme-symbolic_3.12.0-1_all.deb ...\nUnpacking gnome-icon-theme-symbolic (3.12.0-1) ...\nSelecting previously unselected package p11-kit-modules:amd64.\nPreparing to unpack .../p11-kit-modules_0.20.7-1_amd64.deb ...\nUnpacking p11-kit-modules:amd64 (0.20.7-1) ...\nSelecting previously unselected package p11-kit.\nPreparing to unpack .../p11-kit_0.20.7-1_amd64.deb ...\nUnpacking p11-kit (0.20.7-1) ...\nSelecting previously unselected package gnome-keyring.\nPreparing to unpack .../gnome-keyring_3.14.0-1+b1_amd64.deb ...\nUnpacking gnome-keyring (3.14.0-1+b1) ...\nSelecting previously unselected package gnome-packagekit-data.\nPreparing to unpack .../gnome-packagekit-data_3.14.0-1_all.deb ...\nUnpacking gnome-packagekit-data (3.14.0-1) ...\nSelecting previously unselected package libgeocode-glib0.\nPreparing to unpack .../libgeocode-glib0_3.14.0-1_amd64.deb ...\nUnpacking libgeocode-glib0 (3.14.0-1) ...\nSelecting previously unselected package libgnome-desktop-3-10.\nPreparing to unpack .../libgnome-desktop-3-10_3.14.1-1_amd64.deb ...\nUnpacking libgnome-desktop-3-10 (3.14.1-1) ...\nSelecting previously unselected package libgweather-common.\nPreparing to unpack .../libgweather-common_3.14.1-1_all.deb ...\nUnpacking libgweather-common (3.14.1-1) ...\nSelecting previously unselected package libgweather-3-6.\nPreparing to unpack .../libgweather-3-6_3.14.1-1_amd64.deb ...\nUnpacking libgweather-3-6 (3.14.1-1) ...\nSelecting previously unselected package nautilus-data.\nPreparing to unpack .../nautilus-data_3.14.1-2_all.deb ...\nUnpacking nautilus-data (3.14.1-2) ...\nSelecting previously unselected package gnome-settings-daemon.\nPreparing to unpack .../gnome-settings-daemon_3.14.2-3_amd64.deb ...\nUnpacking gnome-settings-daemon (3.14.2-3) ...\nSelecting previously unselected package libglib2.0-bin.\nPreparing to unpack .../libglib2.0-bin_2.42.1-1_amd64.deb ...\nUnpacking libglib2.0-bin (2.42.1-1) ...\nSelecting previously unselected package packagekit.\nPreparing to unpack .../packagekit_1.0.1-2_amd64.deb ...\nUnpacking packagekit (1.0.1-2) ...\nSelecting previously unselected package gnome-packagekit-session.\nPreparing to unpack .../gnome-packagekit-session_3.14.0-1_amd64.deb ...\nUnpacking gnome-packagekit-session (3.14.0-1) ...\nSelecting previously unselected package gnome-packagekit.\nPreparing to unpack .../gnome-packagekit_3.14.0-1_amd64.deb ...\nUnpacking gnome-packagekit (3.14.0-1) ...\nSelecting previously unselected package gstreamer1.0-plugins-base:amd64.\nPreparing to unpack .../gstreamer1.0-plugins-base_1.4.4-2_amd64.deb ...\nUnpacking gstreamer1.0-plugins-base:amd64 (1.4.4-2) ...\nSelecting previously unselected package gstreamer1.0-plugins-good:amd64.\nPreparing to unpack .../gstreamer1.0-plugins-good_1.4.4-2_amd64.deb ...\nUnpacking gstreamer1.0-plugins-good:amd64 (1.4.4-2) ...\nSelecting previously unselected package gstreamer1.0-x:amd64.\nPreparing to unpack .../gstreamer1.0-x_1.4.4-2_amd64.deb ...\nUnpacking gstreamer1.0-x:amd64 (1.4.4-2) ...\nSelecting previously unselected package gtk2-engines-pixbuf:amd64.\nPreparing to unpack .../gtk2-engines-pixbuf_2.24.25-3_amd64.deb ...\nUnpacking gtk2-engines-pixbuf:amd64 (2.24.25-3) ...\nSelecting previously unselected package parted.\nPreparing to unpack .../parted_3.2-7_amd64.deb ...\nUnpacking parted (3.2-7) ...\nSelecting previously unselected package udisks2.\nPreparing to unpack .../udisks2_2.1.3-5_amd64.deb ...\nUnpacking udisks2 (2.1.3-5) ...\nSelecting previously unselected package gvfs-common.\nPreparing to unpack .../gvfs-common_1.22.2-1_all.deb ...\nUnpacking gvfs-common (1.22.2-1) ...\nSelecting previously unselected package gvfs-libs:amd64.\nPreparing to unpack .../gvfs-libs_1.22.2-1_amd64.deb ...\nUnpacking gvfs-libs:amd64 (1.22.2-1) ...\nSelecting previously unselected package gvfs-daemons.\nPreparing to unpack .../gvfs-daemons_1.22.2-1_amd64.deb ...\nUnpacking gvfs-daemons (1.22.2-1) ...\nSelecting previously unselected package gvfs:amd64.\nPreparing to unpack .../gvfs_1.22.2-1_amd64.deb ...\nUnpacking gvfs:amd64 (1.22.2-1) ...\nSelecting previously unselected package libcdio-cdda1.\nPreparing to unpack .../libcdio-cdda1_0.83-4.2_amd64.deb ...\nUnpacking libcdio-cdda1 (0.83-4.2) ...\nSelecting previously unselected package libcdio-paranoia1.\nPreparing to unpack .../libcdio-paranoia1_0.83-4.2_amd64.deb ...\nUnpacking libcdio-paranoia1 (0.83-4.2) ...\nSelecting previously unselected package gvfs-backends.\nPreparing to unpack .../gvfs-backends_1.22.2-1_amd64.deb ...\nUnpacking gvfs-backends (1.22.2-1) ...\nSelecting previously unselected package hwdata.\nPreparing to unpack .../hwdata_0.267-1_all.deb ...\nUnpacking hwdata (0.267-1) ...\nSelecting previously unselected package icedove.\nPreparing to unpack .../icedove_31.8.0-1~deb8u1_amd64.deb ...\nUnpacking icedove (31.8.0-1~deb8u1) ...\nSelecting previously unselected package imagemagick-6.q16.\nPreparing to unpack .../imagemagick-6.q16_8%3a6.8.9.9-5_amd64.deb ...\nUnpacking imagemagick-6.q16 (8:6.8.9.9-5) ...\nSelecting previously unselected package imagemagick.\nPreparing to unpack .../imagemagick_8%3a6.8.9.9-5_amd64.deb ...\nUnpacking imagemagick (8:6.8.9.9-5) ...\nSelecting previously unselected package libcanberra-gtk3-module:amd64.\nPreparing to unpack .../libcanberra-gtk3-module_0.30-2.1_amd64.deb ...\nUnpacking libcanberra-gtk3-module:amd64 (0.30-2.1) ...\nSelecting previously unselected package libclutter-1.0-common.\nPreparing to unpack .../libclutter-1.0-common_1.20.0-1_all.deb ...\nUnpacking libclutter-1.0-common (1.20.0-1) ...\nSelecting previously unselected package libcogl-common.\nPreparing to unpack .../libcogl-common_1.18.2-3_all.deb ...\nUnpacking libcogl-common (1.18.2-3) ...\nSelecting previously unselected package libmozjs-24-0.\nPreparing to unpack .../libmozjs-24-0_24.2.0-2_amd64.deb ...\nUnpacking libmozjs-24-0 (24.2.0-2) ...\nSelecting previously unselected package libgjs0e.\nPreparing to unpack .../libgjs0e_1.42.0-1_amd64.deb ...\nUnpacking libgjs0e (1.42.0-1) ...\nSelecting previously unselected package libgphoto2-l10n.\nPreparing to unpack .../libgphoto2-l10n_2.5.4-1.1_all.deb ...\nUnpacking libgphoto2-l10n (2.5.4-1.1) ...\nSelecting previously unselected package libmagickcore-6.q16-2-extra:amd64.\nPreparing to unpack .../libmagickcore-6.q16-2-extra_8%3a6.8.9.9-5_amd64.deb ...\nUnpacking libmagickcore-6.q16-2-extra:amd64 (8:6.8.9.9-5) ...\nSelecting previously unselected package libnetpbm10.\nPreparing to unpack .../libnetpbm10_2%3a10.0-15.2_amd64.deb ...\nUnpacking libnetpbm10 (2:10.0-15.2) ...\nSelecting previously unselected package libpam-gnome-keyring.\nPreparing to unpack .../libpam-gnome-keyring_3.14.0-1+b1_amd64.deb ...\nUnpacking libpam-gnome-keyring (3.14.0-1+b1) ...\nSelecting previously unselected package libvisual-0.4-plugins:amd64.\nPreparing to unpack .../libvisual-0.4-plugins_0.4.0.dfsg.1-7_amd64.deb ...\nUnpacking libvisual-0.4-plugins:amd64 (0.4.0.dfsg.1-7) ...\nSelecting previously unselected package myspell-en-us.\nPreparing to unpack .../myspell-en-us_1%3a3.3.0-4_all.deb ...\nUnpacking myspell-en-us (1:3.3.0-4) ...\nSelecting previously unselected package nautilus.\nPreparing to unpack .../nautilus_3.14.1-2_amd64.deb ...\nUnpacking nautilus (3.14.1-2) ...\nSelecting previously unselected package netpbm.\nPreparing to unpack .../netpbm_2%3a10.0-15.2_amd64.deb ...\nUnpacking netpbm (2:10.0-15.2) ...\nSelecting previously unselected package packagekit-tools.\nPreparing to unpack .../packagekit-tools_1.0.1-2_amd64.deb ...\nUnpacking packagekit-tools (1.0.1-2) ...\nSelecting previously unselected package policykit-1-gnome.\nPreparing to unpack .../policykit-1-gnome_0.105-2_amd64.deb ...\nUnpacking policykit-1-gnome (0.105-2) ...\nSelecting previously unselected package poppler-utils.\nPreparing to unpack .../poppler-utils_0.26.5-2_amd64.deb ...\nUnpacking poppler-utils (0.26.5-2) ...\nSelecting previously unselected package pulseaudio-utils.\nPreparing to unpack .../pulseaudio-utils_5.0-13_amd64.deb ...\nUnpacking pulseaudio-utils (5.0-13) ...\nSelecting previously unselected package pulseaudio.\nPreparing to unpack .../pulseaudio_5.0-13_amd64.deb ...\nUnpacking pulseaudio (5.0-13) ...\nSelecting previously unselected package pulseaudio-module-x11.\nPreparing to unpack .../pulseaudio-module-x11_5.0-13_amd64.deb ...\nUnpacking pulseaudio-module-x11 (5.0-13) ...\nSelecting previously unselected package python-nautilus.\nPreparing to unpack .../python-nautilus_1.1-4_amd64.deb ...\nUnpacking python-nautilus (1.1-4) ...\nSelecting previously unselected package rtkit.\nPreparing to unpack .../rtkit_0.11-2_amd64.deb ...\nUnpacking rtkit (0.11-2) ...\nSelecting previously unselected package xsettingsd.\nPreparing to unpack .../xsettingsd_0.0.20121210+72+g474f18a-1_amd64.deb ...\nUnpacking xsettingsd (0.0.20121210+72+g474f18a-1) ...\nSelecting previously unselected package gdisk.\nPreparing to unpack .../gdisk_0.8.10-2_amd64.deb ...\nUnpacking gdisk (0.8.10-2) ...\nSelecting previously unselected package gnome-sushi.\nPreparing to unpack .../gnome-sushi_3.12.0-2+b1_amd64.deb ...\nUnpacking gnome-sushi (3.12.0-2+b1) ...\nSelecting previously unselected package qubes-gpg-split.\nPreparing to unpack .../qubes-gpg-split_2.0.11-1+jessie1_amd64.deb ...\nUnpacking qubes-gpg-split (2.0.11-1+jessie1) ...\nSelecting previously unselected package qubes-pdf-converter.\nPreparing to unpack .../qubes-pdf-converter_2.0.3-1+jessie1_amd64.deb ...\nUnpacking qubes-pdf-converter (2.0.3-1+jessie1) ...\nSelecting previously unselected package qubes-thunderbird.\nPreparing to unpack .../qubes-thunderbird_1.2.7-1+jessie1_amd64.deb ...\nUnpacking qubes-thunderbird (1.2.7-1+jessie1) ...\nProcessing triggers for initramfs-tools (0.120) ...\nProcessing triggers for man-db (2.7.0.2-5) ...\nProcessing triggers for mime-support (3.58) ...\nProcessing triggers for shared-mime-info (1.3-1) ...\nUnknown media type in type 'all/all'\nUnknown media type in type 'all/allfiles'\nUnknown media type in type 'uri/mms'\nUnknown media type in type 'uri/mmst'\nUnknown media type in type 'uri/mmsu'\nUnknown media type in type 'uri/pnm'\nUnknown media type in type 'uri/rtspt'\nUnknown media type in type 'uri/rtspu'\nProcessing triggers for hicolor-icon-theme (0.13-1) ...\nProcessing triggers for libglib2.0-0:amd64 (2.42.1-1) ...\nProcessing triggers for fontconfig (2.11.0-6.3) ...\nProcessing triggers for dbus (1.8.18-0+deb8u1) ...\nProcessing triggers for menu (2.1.47) ...\nSetting up gnome-themes-standard-data (3.14.2.2-1) ...\nupdate-alternatives: using /usr/share/icons/Adwaita/cursor.theme to provide /usr/share/icons/default/index.theme (x-cursor-theme) in auto mode\nSetting up gnome-themes-standard:amd64 (3.14.2.2-1) ...\nSetting up imagemagick-common (8:6.8.9.9-5) ...\nSetting up libasound2-plugins:amd64 (1.0.28-1+b1) ...\nSetting up libavahi-glib1:amd64 (0.6.31-5) ...\nSetting up libcanberra-gtk3-0:amd64 (0.30-2.1) ...\nSetting up libcdparanoia0:amd64 (3.10.2+debian-11) ...\nSetting up libcogl20:amd64 (1.18.2-3) ...\nSetting up libcogl-pango20:amd64 (1.18.2-3) ...\nSetting up libcogl-path20:amd64 (1.18.2-3) ...\nSetting up libinput5:amd64 (0.6.0+dfsg-2) ...\nSetting up libclutter-1.0-0:amd64 (1.20.0-1) ...\nSetting up libclutter-gst-2.0-0:amd64 (2.0.12-1) ...\nSetting up libclutter-gtk-1.0-0:amd64 (1.6.0-1) ...\nSetting up libdjvulibre-text (3.5.25.4-4) ...\nSetting up libdjvulibre21:amd64 (3.5.25.4-4+b1) ...\nSetting up libdv4:amd64 (1.0.0-6) ...\nSetting up libelfg0:amd64 (0.8.13-5) ...\nSetting up libexempi3:amd64 (2.2.1-2) ...\nSetting up libexif12:amd64 (0.6.21-2) ...\nSetting up libfftw3-double3:amd64 (3.3.4-2) ...\nSetting up libfftw3-single3:amd64 (3.3.4-2) ...\nSetting up at-spi2-core (2.14.0-1) ...\nSetting up libgail-3-0:amd64 (3.14.5-1) ...\nSetting up libgck-1-0:amd64 (3.14.0-2) ...\nSetting up libgcr-3-common (3.14.0-2) ...\nSetting up libgcr-base-3-1:amd64 (3.14.0-2) ...\nSetting up libgcr-ui-3-1:amd64 (3.14.0-2) ...\nSetting up libgd3:amd64 (2.1.0-5) ...\nSetting up libglu1-mesa:amd64 (9.0.0-2) ...\nSetting up libgoa-1.0-common (3.14.2-1) ...\nSetting up libgoa-1.0-0b:amd64 (3.14.2-1) ...\nSetting up libgphoto2-port10:amd64 (2.5.4-1.1+b2) ...\nSetting up libgphoto2-6:amd64 (2.5.4-1.1+b2) ...\nSetting up libgtksourceview-3.0-common (3.14.1-1) ...\nSetting up libgtksourceview-3.0-1:amd64 (3.14.1-1) ...\nSetting up libgxps2:amd64 (0.2.2-3+b2) ...\nSetting up libiec61883-0:amd64 (1.2.0-0.2) ...\nSetting up liblqr-1-0:amd64 (0.4.2-2) ...\nSetting up libmagickcore-6.q16-2:amd64 (8:6.8.9.9-5) ...\nSetting up libmagickwand-6.q16-2:amd64 (8:6.8.9.9-5) ...\nSetting up libmediaart-1.0-0:amd64 (0.7.0-2) ...\nSetting up libneon27-gnutls (0.30.1-1) ...\nSetting up libmusicbrainz5-1:amd64 (5.1.0-2) ...\nSetting up libnspr4:amd64 (2:4.10.7-1) ...\nSetting up libnss3:amd64 (2:3.17.2-1.1) ...\nSetting up libpackagekit-glib2-18:amd64 (1.0.1-2) ...\nSetting up libpulsedsp:amd64 (5.0-13) ...\nSetting up libiptcdata0 (1.0.4-4) ...\nSetting up libtracker-sparql-1.0-0:amd64 (1.2.4-2) ...\nSetting up libudisks2-0:amd64 (2.1.3-5) ...\nSetting up libv4lconvert0:amd64 (1.6.0-2) ...\nSetting up libv4l-0:amd64 (1.6.0-2) ...\nSetting up libvisual-0.4-0:amd64 (0.4.0-6) ...\nSetting up libwacom-common (0.8-1) ...\nSetting up libwacom2:amd64 (0.8-1) ...\nSetting up libwavpack1:amd64 (4.70.0-1) ...\nSetting up libwmf0.2-7:amd64 (0.2.8.4-10.3+deb8u1) ...\nSetting up ntfs-3g (1:2014.2.15AR.2-1+deb8u2) ...\nupdate-initramfs: deferring update (trigger activated)\nSetting up libwebrtc-audio-processing-0:amd64 (0.1-3) ...\nSetting up desktop-file-utils (0.22-1) ...\nSetting up dosfstools (3.0.27-1) ...\nSetting up eject (2.1.5+deb1+cvs20081104-13.1) ...\nSetting up gcr (3.14.0-2) ...\nSetting up gdebi-core (0.9.5.5+nmu1) ...\nTraceback (most recent call last):\n  File \"/usr/bin/py3compile\", line 26, in <module>\n    import optparse\n  File \"/usr/lib/python3.4/optparse.py\", line 89, in <module>\n    from gettext import gettext, ngettext\n  File \"/usr/lib/python3.4/gettext.py\", line 49, in <module>\n    import locale, copy, io, os, re, struct, sys\n  File \"<frozen importlib._bootstrap>\", line 2237, in _find_and_load\n  File \"<frozen importlib._bootstrap>\", line 2226, in _find_and_load_unlocked\n  File \"<frozen importlib._bootstrap>\", line 1200, in _load_unlocked\n  File \"<frozen importlib._bootstrap>\", line 1129, in _exec\n  File \"<frozen importlib._bootstrap>\", line 1467, in exec_module\n  File \"<frozen importlib._bootstrap>\", line 1570, in get_code\n  File \"<frozen importlib._bootstrap>\", line 656, in _compile_bytecode\nValueError: bad marshal data (unknown type code)\ndpkg: error processing package gdebi-core (--configure):\n subprocess installed post-installation script returned error exit status 1\nSetting up gsfonts (1:8.11+urwcyr1.0.7~pre44-4.2) ...\nSetting up ghostscript (9.06~dfsg-2+deb8u1) ...\nSetting up gir1.2-cogl-1.0 (1.18.2-3) ...\nSetting up gir1.2-coglpango-1.0 (1.18.2-3) ...\nSetting up gir1.2-json-1.0 (1.0.2-1) ...\nSetting up gir1.2-clutter-1.0 (1.20.0-1) ...\nSetting up gir1.2-gstreamer-1.0 (1.4.4-2) ...\nSetting up gir1.2-gst-plugins-base-1.0 (1.4.4-2) ...\nSetting up gir1.2-clutter-gst-2.0 (2.0.12-1) ...\nSetting up libkpathsea6 (2014.20140926.35254-6) ...\nSetting up libevdocument3-4 (3.14.1-2) ...\nSetting up libevview3-3 (3.14.1-2) ...\nSetting up gir1.2-evince-3.0 (3.14.1-2) ...\nSetting up gir1.2-gtkclutter-1.0 (1.6.0-1) ...\nSetting up gir1.2-gtksource-3.0:amd64 (3.14.1-1) ...\nSetting up gir1.2-javascriptcoregtk-3.0:amd64 (2.4.8-2) ...\nSetting up libnautilus-extension1a (3.14.1-2) ...\nSetting up gir1.2-nautilus-3.0 (3.14.1-2) ...\nSetting up gir1.2-soup-2.4 (2.48.0-1) ...\nSetting up gir1.2-webkit-3.0:amd64 (2.4.8-2) ...\nSetting up gnome-accessibility-themes (3.14.2.2-1) ...\nSetting up gnome-desktop3-data (3.14.1-1) ...\nSetting up gnome-icon-theme (3.12.0-1) ...\nupdate-alternatives: using /usr/share/icons/gnome/scalable/places/debian-swirl.svg to provide /usr/share/icons/gnome/scalable/places/start-here.svg (start-here.svg) in auto mode\nSetting up gnome-icon-theme-symbolic (3.12.0-1) ...\nSetting up p11-kit-modules:amd64 (0.20.7-1) ...\nSetting up p11-kit (0.20.7-1) ...\nSetting up gnome-keyring (3.14.0-1+b1) ...\nSetting up gnome-packagekit-data (3.14.0-1) ...\nSetting up libgeocode-glib0 (3.14.0-1) ...\nSetting up libgnome-desktop-3-10 (3.14.1-1) ...\nSetting up libgweather-common (3.14.1-1) ...\nSetting up libgweather-3-6 (3.14.1-1) ...\nSetting up nautilus-data (3.14.1-2) ...\nSetting up gnome-settings-daemon (3.14.2-3) ...\nSetting up libglib2.0-bin (2.42.1-1) ...\ndpkg: dependency problems prevent configuration of packagekit:\n packagekit depends on gdebi-core (>= 0.8.2); however:\n  Package gdebi-core is not configured yet.\n\ndpkg: error processing package packagekit (--configure):\n dependency problems - leaving unconfigured\ndpkg: dependency problems prevent configuration of gnome-packagekit-session:\n gnome-packagekit-session depends on packagekit (>= 0.8.6); however:\n  Package packagekit is not configured yet.\n\ndpkg: error processing package gnome-packagekit-session (--configure):\n dependency problems - leaving unconfigured\ndpkg: dependency problems prevent configuration of gnome-packagekit:\n gnome-packagekit depends on gnome-packagekit-session (>= 3.14.0-1); however:\n  Package gnome-packagekit-session is not configured yet.\n\ndpkg: error processing package gnome-packagekit (--configure):\n dependency problems - leaving unconfigured\nSetting up gstreamer1.0-plugins-base:amd64 (1.4.4-2) ...\nSetting up gstreamer1.0-plugins-good:amd64 (1.4.4-2) ...\nSetting up gstreamer1.0-x:amd64 (1.4.4-2) ...\nSetting up gtk2-engines-pixbuf:amd64 (2.24.25-3) ...\nSetting up parted (3.2-7) ...\nSetting up udisks2 (2.1.3-5) ...\nSetting up gvfs-common (1.22.2-1) ...\nSetting up gvfs-libs:amd64 (1.22.2-1) ...\nSetting up gvfs-daemons (1.22.2-1) ...\nSetting up gvfs:amd64 (1.22.2-1) ...\nSetting up libcdio-cdda1 (0.83-4.2) ...\nSetting up libcdio-paranoia1 (0.83-4.2) ...\nSetting up gvfs-backends (1.22.2-1) ...\nSetting up hwdata (0.267-1) ...\nSetting up icedove (31.8.0-1~deb8u1) ...\nSetting up imagemagick-6.q16 (8:6.8.9.9-5) ...\nSetting up imagemagick (8:6.8.9.9-5) ...\nupdate-alternatives: using /usr/bin/compare-im6 to provide /usr/bin/compare (compare) in auto mode\nupdate-alternatives: using /usr/bin/animate-im6 to provide /usr/bin/animate (animate) in auto mode\nupdate-alternatives: using /usr/bin/convert-im6 to provide /usr/bin/convert (convert) in auto mode\nupdate-alternatives: using /usr/bin/composite-im6 to provide /usr/bin/composite (composite) in auto mode\nupdate-alternatives: using /usr/bin/conjure-im6 to provide /usr/bin/conjure (conjure) in auto mode\nupdate-alternatives: using /usr/bin/import-im6 to provide /usr/bin/import (import) in auto mode\nupdate-alternatives: using /usr/bin/identify-im6 to provide /usr/bin/identify (identify) in auto mode\nupdate-alternatives: using /usr/bin/stream-im6 to provide /usr/bin/stream (stream) in auto mode\nupdate-alternatives: using /usr/bin/display-im6 to provide /usr/bin/display (display) in auto mode\nupdate-alternatives: using /usr/bin/montage-im6 to provide /usr/bin/montage (montage) in auto mode\nupdate-alternatives: using /usr/bin/mogrify-im6 to provide /usr/bin/mogrify (mogrify) in auto mode\nSetting up libcanberra-gtk3-module:amd64 (0.30-2.1) ...\nSetting up libclutter-1.0-common (1.20.0-1) ...\nSetting up libcogl-common (1.18.2-3) ...\nSetting up libmozjs-24-0 (24.2.0-2) ...\nSetting up libgjs0e (1.42.0-1) ...\nSetting up libgphoto2-l10n (2.5.4-1.1) ...\nSetting up libmagickcore-6.q16-2-extra:amd64 (8:6.8.9.9-5) ...\nSetting up libnetpbm10 (2:10.0-15.2) ...\nSetting up libpam-gnome-keyring (3.14.0-1+b1) ...\nSetting up libvisual-0.4-plugins:amd64 (0.4.0.dfsg.1-7) ...\nSetting up myspell-en-us (1:3.3.0-4) ...\nSetting up nautilus (3.14.1-2) ...\nSetting up netpbm (2:10.0-15.2) ...\ndpkg: dependency problems prevent configuration of packagekit-tools:\n packagekit-tools depends on packagekit (= 1.0.1-2); however:\n  Package packagekit is not configured yet.\n\ndpkg: error processing package packagekit-tools (--configure):\n dependency problems - leaving unconfigured\nSetting up policykit-1-gnome (0.105-2) ...\nSetting up poppler-utils (0.26.5-2) ...\nSetting up pulseaudio-utils (5.0-13) ...\nSetting up pulseaudio (5.0-13) ...\nERROR: ld.so: object 'libeatmydata.so' from LD_PRELOAD cannot be preloaded (cannot open shared object file): ignored.\nAdding user pulse to group audio\nSetting up pulseaudio-module-x11 (5.0-13) ...\nSetting up python-nautilus (1.1-4) ...\nSetting up rtkit (0.11-2) ...\nERROR: ld.so: object 'libeatmydata.so' from LD_PRELOAD cannot be preloaded (cannot open shared object file): ignored.\ninvoke-rc.d: policy-rc.d denied execution of force-reload.\nSetting up xsettingsd (0.0.20121210+72+g474f18a-1) ...\nSetting up gdisk (0.8.10-2) ...\nSetting up gnome-sushi (3.12.0-2+b1) ...\nSetting up qubes-gpg-split (2.0.11-1+jessie1) ...\nSetting up qubes-pdf-converter (2.0.3-1+jessie1) ...\nSetting up qubes-thunderbird (1.2.7-1+jessie1) ...\nProcessing triggers for libc-bin (2.19-18) ...\nProcessing triggers for initramfs-tools (0.120) ...\nProcessing triggers for dbus (1.8.18-0+deb8u1) ...\nProcessing triggers for menu (2.1.47) ...\nErrors were encountered while processing:\n gdebi-core\n packagekit\n gnome-packagekit-session\n gnome-packagekit\n packagekit-tools\nE: Sub-process /usr/bin/dpkg returned an error code (1)\n+ retval=100\n+ true\n+ true ''\n+ return 100\n+ cleanup\n+ errval=100\n+ trap - ERR EXIT\n+ trap\n+ error '/home/user/qubes-builder/qubes-src/builder-debian/template_debian/04_install_qubes.sh: Error.  Cleaning up and un-mounting any existing mounts'\n+ output 'ERROR: /home/user/qubes-builder/qubes-src/builder-debian/template_debian/04_install_qubes.sh:' Error. Cleaning up and un-mounting any existing 'mounts'\n+ '[' 2 -ge 1 ']'\n+ [[ -z '' ]]\n+ [[ ehB != ehxB ]]\n+ umount_all\n+ directory=mnt\n+ '[' mnt == mnt -o mnt == mnt/ ']'\n++ mountPoints\n+++ mountPoint ''\n+++ local mount_point=\n+++ [[ '' = /* ]]\n++++ readlink -m .\n+++ mount_point=/home/user/qubes-builder/qubes-src/linux-template-builder/\n++++ echo /home/user/qubes-builder/qubes-src/linux-template-builder/\n++++ sed 's#//*#/#g'\n+++ echo /home/user/qubes-builder/qubes-src/linux-template-builder/\n++ local mount_point=/home/user/qubes-builder/qubes-src/linux-template-builder/\n+++ sudo grep /home/user/qubes-builder/qubes-src/linux-template-builder/ /proc/mounts\n+++ cut -f2 '-d '\n+++ sort -r\n+++ grep '^/home/user/qubes-builder/qubes-src/linux-template-builder/'\n++ echo '/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/tmp/qubes_repo\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/sys\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/run\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/proc\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt'\n+ '[' -n '/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/tmp/qubes_repo\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/sys\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/run\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/proc\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt' ']'\n+ removeDbusUuid\n+ '[' -e mnt/var/lib/dbus/machine-id ']'\n+ removeDivertPolicy\n+ outputc red 'Reactivating initctl...'\n+ color=red\n+ shift\n+ output 'Reactivating' 'initctl...'\n+ '[' 2 -ge 1 ']'\n+ [[ -z '' ]]\n+ [[ ehB != ehxB ]]\n+ chroot dpkg-divert --local --rename --remove /sbin/initctl\n+ local retval\n+ true ''\n+ '[' '' == 1 ']'\n+ /usr/sbin/chroot mnt dpkg-divert --local --rename --remove /sbin/initctl\nRemoving 'local diversion of /sbin/initctl to /sbin/initctl.distrib'\n+ retval=0\n+ true\n+ true ''\n+ return 0\n+ outputc green 'Removing policy-rc.d'\n+ color=green\n+ shift\n+ output 'Removing' 'policy-rc.d'\n+ '[' 2 -ge 1 ']'\n+ [[ -z '' ]]\n+ [[ ehB != ehxB ]]\n+ rm -f mnt/usr/sbin/policy-rc.d\n+ outputc red 'Restoring invoke-rc.d...'\n+ color=red\n+ shift\n+ output 'Restoring' 'invoke-rc.d...'\n+ '[' 2 -ge 1 ']'\n+ [[ -z '' ]]\n+ [[ ehB != ehxB ]]\n+ chroot sed -i -e 's/exit 0 #exit 100/exit 100/' /usr/sbin/invoke-rc.d\n+ local retval\n+ true ''\n+ '[' '' == 1 ']'\n+ /usr/sbin/chroot mnt sed -i -e 's/exit 0 #exit 100/exit 100/' /usr/sbin/invoke-rc.d\n+ retval=0\n+ true\n+ true ''\n+ return 0\n+ umount_kill mnt\n++ getXtrace\n++ [[ hB != hxB ]]\n++ echo 0\n+ local xtrace=0\n+ set +x\nAttempting to kill any processes still running in '/home/user/qubes-builder/qubes-src/linux-template-builder/mnt' before un-mounting\nINFO: umount /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/tmp/qubes_repo\nINFO: umount /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/sys\nINFO: umount /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/run\nINFO: umount /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/proc\nINFO: umount /home/user/qubes-builder/qubes-src/linux-template-builder/mnt\n+ [[ -n 0 ]]\n+ [[ 0 -eq 0 ]]\n+ set -x\n+ exit 100\n++ cleanup\n++ errval=100\n++ trap - ERR\n++ trap\n++ umount_kill /home/user/qubes-builder/qubes-src/linux-template-builder/mnt\n+++ getXtrace\n+++ [[ ehB != ehxB ]]\n+++ echo 0\n++ local xtrace=0\n++ set +x\nAttempting to kill any processes still running in '/home/user/qubes-builder/qubes-src/linux-template-builder/mnt' before un-mounting\n++ exit 100\nMakefile:47: recipe for target 'rootimg-build' failed\nmake[1]: *** [rootimg-build] Error 100\nMakefile:279: recipe for target 'template-local-jessie+whonix-workstation+standard' failed\nmake: *** [template-local-jessie+whonix-workstation+standard] Error 1\n[user@qubes-build qubes-builder]$\n```\n","comments":[{"author":"Patrick","date_created":1439565962,"date_modified":1439565962,"content":"https://phabricator.whonix.org/T391#6396"}]},"PHID-TASK-ano2j74iindteh7lhoe2":{"id":"391","title":"taksel in Qubes-Whonix builds unwanted and breaking the build","status":"resolved","priority":"High","author":"Patrick","description":"Qubes build, `make template` failed. Likely because I was using `REPO_PROXY`. (Which was working above for all package installations just fine.) Log attached below. Perhaps failed because using `apt-get` instead of `apt-get.anondist-orig`. Anyhow.\n\nUsing `tasksel --new-install --task-packages standard` for Whonix templates is a bad idea. For Whonix we like to have the list of installed default packages under tight control for security/privacy/anonymity reasons. This is defined here:\n\n* https://github.com/Whonix/whonix-developer-meta-files/tree/master/package_documentation\n* https://github.com/Whonix/anon-meta-packages/blob/master/debian/control\n\n`tasksel` can be a source of inspiration, help us checking which packages may be missing, however automating this is a bad idea. If we wanted to do this, it should be done in Whonix's code. Not in Qubes Builder. That's outside of Qubes Builder's purpose.\n\nTherefore, to fix this issue breaking the build, can you please just remove the `taksel` package installation? @nrgaway\n\n__EDIT 1__\n\n`+ debug 'Installing extra packages from: /home/user/qubes-builder/qubes-src/builder-debian/template_debian/packages_jessie_standard.list'` - Also failing. But we don't want packages_jessie_standard.list in Whonix either.\n\n__EDIT 2__\n\nAlso installing:\n* qubes-pdf-converter\n* qubes-gpg-split\n* qubes-thunderbird\n\nIs unwanted in Whonix-Gateway.\n\n-----\n\n```\n+ '[' -f /home/user/qubes-builder/qubes-src/linux-template-builder/mnt//tmp/.debian_packages ']'\n++ chroot tasksel --new-install --task-packages standard\n++ local retval\n++ true ''\n++ '[' '' == 1 ']'\n++ /usr/sbin/chroot /home/user/qubes-builder/qubes-src/linux-template-builder/mnt tasksel --new-install --task-packages standard\n++ retval=0\n++ true\n++ true ''\n++ return 0\n+ packages='m4\naptitude-common\nmlocate\napt-listchanges\ntime\nwamerican\ndc\nftp\nmutt\ntexinfo\ndeb.torproject.org-keyring\nlibswitch-perl\nhost\nw3m\ninstall-info\nnfs-common\ndebian-faq\nprocmail\ndoc-debian\nwhois\nrpcbind\nexim4\naptitude\nreportbug\nlibclass-isa-perl\npython-reportbug\npython-apt\ninfo'\n+ aptInstall m4 aptitude-common mlocate apt-listchanges time wamerican dc ftp mutt texinfo deb.torproject.org-keyring libswitch-perl host w3m install-info nfs-common debian-faq procmail doc-debian whois rpcbind exim4 aptitude reportbug libclass-isa-perl python-reportbug python-apt info\n+ files='m4 aptitude-common mlocate apt-listchanges time wamerican dc ftp mutt texinfo deb.torproject.org-keyring libswitch-perl host w3m install-info nfs-common debian-faq procmail doc-debian whois rpcbind exim4 aptitude reportbug libclass-isa-perl python-reportbug python-apt info'\n+ DEBIAN_FRONTEND=noninteractive\n+ DEBIAN_PRIORITY=critical\n+ DEBCONF_NOWARNINGS=yes\n+ chroot eatmydata apt-get -o Dpkg::Options::=--force-confnew --yes -o Acquire::Retries=3 -o Dpkg::Options::=--force-unsafe-io -o Acquire::http::Proxy=http://127.0.0.1:3142 install m4 aptitude-common mlocate apt-listchanges time wamerican dc ftp mutt texinfo deb.torproject.org-keyring libswitch-perl host w3m install-info nfs-common debian-faq procmail doc-debian whois rpcbind exim4 aptitude reportbug libclass-isa-perl python-reportbug python-apt info\n+ local retval\n+ true ''\n+ '[' '' == 1 ']'\n+ /usr/sbin/chroot /home/user/qubes-builder/qubes-src/linux-template-builder/mnt eatmydata apt-get -o Dpkg::Options::=--force-confnew --yes -o Acquire::Retries=3 -o Dpkg::Options::=--force-unsafe-io -o Acquire::http::Proxy=http://127.0.0.1:3142 install m4 aptitude-common mlocate apt-listchanges time wamerican dc ftp mutt texinfo deb.torproject.org-keyring libswitch-perl host w3m install-info nfs-common debian-faq procmail doc-debian whois rpcbind exim4 aptitude reportbug libclass-isa-perl python-reportbug python-apt info\nReading package lists... Done\nBuilding dependency tree       \nReading state information... Done\nThe following extra packages will be installed:\n  aptitude-doc-en docutils-common docutils-doc libcwidget3 libgc1c2 libintl-perl libnfsidmap2 libpaper-utils libtext-unidecode-perl libtirpc1\n  libtokyocabinet9 libwebpdemux1 libwebpmux1 libxml-libxml-perl libxml-namespacesupport-perl libxml-sax-base-perl libxml-sax-expat-perl libxml-sax-perl\n  python-debian python-debianbts python-defusedxml python-docutils python-pil python-pygments python-roman python-soappy python-wstools\nSuggested packages:\n  www-browser python-glade2 python-gtk2 debtags apt-xapian-index texinfo-doc-nonfree libcwidget-dev libintl-xs-perl urlview mixmaster open-iscsi watchdog\n  python-apt-dbg python-vte python-apt-doc texlive-latex-recommended texlive-latex-base texlive-lang-french fonts-linuxlibertine ttf-linux-libertine\n  python-pil-doc python-pil-dbg ttf-bitstream-vera debconf-utils dlocate python-urwid python-gtkspell emacs23-bin-common emacs24-bin-common claws-mail\n  texlive-base texlive-generic-recommended w3m-img w3m-el cmigemo\nThe following NEW packages will be installed:\n  apt-listchanges aptitude aptitude-common aptitude-doc-en dc deb.torproject.org-keyring debian-faq doc-debian docutils-common docutils-doc exim4 ftp host\n  info install-info libclass-isa-perl libcwidget3 libgc1c2 libintl-perl libnfsidmap2 libpaper-utils libswitch-perl libtext-unidecode-perl libtirpc1\n  libtokyocabinet9 libwebpdemux1 libwebpmux1 libxml-libxml-perl libxml-namespacesupport-perl libxml-sax-base-perl libxml-sax-expat-perl libxml-sax-perl m4\n  mlocate mutt nfs-common procmail python-apt python-debian python-debianbts python-defusedxml python-docutils python-pil python-pygments python-reportbug\n  python-roman python-soappy python-wstools reportbug rpcbind texinfo time w3m wamerican whois\n0 upgraded, 55 newly installed, 0 to remove and 0 not upgraded.\nNeed to get 15.3 MB of archives.\nAfter this operation, 57.8 MB of additional disk space will be used.\nErr http://deb.torproject.org/torproject.org/ jessie/main deb.torproject.org-keyring all 2014.08.31+b1\n  Could not connect to 127.0.0.1:3142 (127.0.0.1). - connect (111: Connection refused)\nErr http://security.debian.org/ jessie/updates/main host all 1:9.9.5.dfsg-9+deb8u2\n  Unable to connect to 127.0.0.1:3142:\nErr http://deb.torproject.org/torproject.org/ jessie/main deb.torproject.org-keyring all 2014.08.31+b1\n  Unable to connect to 127.0.0.1:3142:\nErr http://security.debian.org/ jessie/updates/main host all 1:9.9.5.dfsg-9+deb8u2\n  Unable to connect to 127.0.0.1:3142:\nErr http://deb.torproject.org/torproject.org/ jessie/main deb.torproject.org-keyring all 2014.08.31+b1\n  Unable to connect to 127.0.0.1:3142:\nErr http://security.debian.org/ jessie/updates/main host all 1:9.9.5.dfsg-9+deb8u2\n  Unable to connect to 127.0.0.1:3142:\nErr http://deb.torproject.org/torproject.org/ jessie/main deb.torproject.org-keyring all 2014.08.31+b1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libxml-libxml-perl amd64 2.0116+dfsg-1+deb8u1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libxml-libxml-perl amd64 2.0116+dfsg-1+deb8u1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main install-info amd64 5.2.0.dfsg.1-6\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libcwidget3 amd64 0.5.17-2\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libgc1c2 amd64 1:7.2d-6.4\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libnfsidmap2 amd64 0.25-5\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libtirpc1 amd64 0.2.5-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libtokyocabinet9 amd64 1.4.48-3\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libwebpdemux1 amd64 0.4.1-1.2+b2\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libwebpmux1 amd64 0.4.1-1.2+b2\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main python-apt amd64 0.9.3.11\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main apt-listchanges all 2.85.13+nmu1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main aptitude-common all 0.6.11-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main aptitude amd64 0.6.11-1+b1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main dc amd64 1.06.95-9\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main debian-faq all 5.0.3\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libxml-libxml-perl amd64 2.0116+dfsg-1+deb8u1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main doc-debian all 6.2\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main exim4 all 4.84-8\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main ftp amd64 0.17-31\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main info amd64 5.2.0.dfsg.1-6\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libclass-isa-perl all 0.36-5\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libswitch-perl all 2.17-2\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main m4 amd64 1.4.17-4\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main mlocate amd64 0.26-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main mutt amd64 1.5.23-3\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main rpcbind amd64 0.2.1-6\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main nfs-common amd64 1:1.2.8-9\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main procmail amd64 3.22-24\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main python-debian all 0.1.27\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main python-defusedxml all 0.4.1-2\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main python-roman all 2.0.0-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main docutils-common all 0.12+dfsg-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main python-docutils all 0.12+dfsg-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main python-wstools all 0.4.3-2\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main python-soappy all 0.12.22-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main python-debianbts all 1.12\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main python-reportbug all 6.6.3\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main reportbug all 6.6.3\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libtext-unidecode-perl all 1.22-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libintl-perl all 1.23-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libxml-namespacesupport-perl all 1.11-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libxml-sax-base-perl all 1.07-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libxml-sax-perl all 0.99+dfsg-2\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main texinfo amd64 5.2.0.dfsg.1-6\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main time amd64 1.7-25\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main w3m amd64 0.5.3-19\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main wamerican all 7.1-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main whois amd64 5.2.7\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main aptitude-doc-en all 0.6.11-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main docutils-doc all 0.12+dfsg-1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libpaper-utils amd64 1.1.24+nmu4\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libxml-sax-expat-perl all 0.40-2\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main python-pil amd64 2.6.1-2\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main python-pygments all 2.0.1+dfsg-1.1\n  Unable to connect to 127.0.0.1:3142:\nErr http://ftp.us.debian.org/debian/ jessie/main libxml-libxml-perl amd64 2.0116+dfsg-1+deb8u1\n  Unable to connect to 127.0.0.1:3142:\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/t/texinfo/install-info_5.2.0.dfsg.1-6_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/c/cwidget/libcwidget3_0.5.17-2_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libg/libgc/libgc1c2_7.2d-6.4_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libn/libnfsidmap/libnfsidmap2_0.25-5_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libt/libtirpc/libtirpc1_0.2.5-1_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/t/tokyocabinet/libtokyocabinet9_1.4.48-3_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libw/libwebp/libwebpdemux1_0.4.1-1.2+b2_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libw/libwebp/libwebpmux1_0.4.1-1.2+b2_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://deb.torproject.org/torproject.org/pool/main/d/deb.torproject.org-keyring/deb.torproject.org-keyring_2014.08.31+b1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/p/python-apt/python-apt_0.9.3.11_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/a/apt-listchanges/apt-listchanges_2.85.13+nmu1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/a/aptitude/aptitude-common_0.6.11-1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/a/aptitude/aptitude_0.6.11-1+b1_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/b/bc/dc_1.06.95-9_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/d/debian-faq/debian-faq_5.0.3_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/d/doc-debian/doc-debian_6.2_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/e/exim4/exim4_4.84-8_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/n/netkit-ftp/ftp_0.17-31_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://security.debian.org/pool/updates/main/b/bind9/host_9.9.5.dfsg-9+deb8u2_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/t/texinfo/info_5.2.0.dfsg.1-6_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libc/libclass-isa-perl/libclass-isa-perl_0.36-5_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libs/libswitch-perl/libswitch-perl_2.17-2_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/m/m4/m4_1.4.17-4_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/m/mlocate/mlocate_0.26-1_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/m/mutt/mutt_1.5.23-3_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/r/rpcbind/rpcbind_0.2.1-6_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/n/nfs-utils/nfs-common_1.2.8-9_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/p/procmail/procmail_3.22-24_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/p/python-debian/python-debian_0.1.27_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/d/defusedxml/python-defusedxml_0.4.1-2_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/p/python-roman/python-roman_2.0.0-1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/p/python-docutils/docutils-common_0.12+dfsg-1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/p/python-docutils/python-docutils_0.12+dfsg-1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/p/python-wstools/python-wstools_0.4.3-2_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/p/python-soappy/python-soappy_0.12.22-1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/p/python-debianbts/python-debianbts_1.12_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/r/reportbug/python-reportbug_6.6.3_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/r/reportbug/reportbug_6.6.3_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libt/libtext-unidecode-perl/libtext-unidecode-perl_1.22-1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libi/libintl-perl/libintl-perl_1.23-1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libx/libxml-namespacesupport-perl/libxml-namespacesupport-perl_1.11-1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libx/libxml-sax-base-perl/libxml-sax-base-perl_1.07-1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libx/libxml-sax-perl/libxml-sax-perl_0.99+dfsg-2_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libx/libxml-libxml-perl/libxml-libxml-perl_2.0116+dfsg-1+deb8u1_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/t/texinfo/texinfo_5.2.0.dfsg.1-6_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/t/time/time_1.7-25_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/w/w3m/w3m_0.5.3-19_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/s/scowl/wamerican_7.1-1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/w/whois/whois_5.2.7_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/a/aptitude/aptitude-doc-en_0.6.11-1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/p/python-docutils/docutils-doc_0.12+dfsg-1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libp/libpaper/libpaper-utils_1.1.24+nmu4_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/libx/libxml-sax-expat-perl/libxml-sax-expat-perl_0.40-2_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/p/pillow/python-pil_2.6.1-2_amd64.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Failed to fetch http://ftp.us.debian.org/debian/pool/main/p/pygments/python-pygments_2.0.1+dfsg-1.1_all.deb  Unable to connect to 127.0.0.1:3142:\n\nE: Unable to fetch some archives, maybe run apt-get update or try with --fix-missing?\n+ retval=100\n+ true\n+ true ''\n+ return 100\n+ cleanup\n+ errval=100\n+ trap - ERR EXIT\n+ trap\n+ error '/home/user/qubes-builder/qubes-src/builder-debian/template_debian/02_install_groups.sh: Error.  Cleaning up and un-mounting any existing mounts'\n+ output 'ERROR: /home/user/qubes-builder/qubes-src/builder-debian/template_debian/02_install_groups.sh:' Error. Cleaning up and un-mounting any existing 'mounts'\n+ '[' 2 -ge 1 ']'\n+ [[ -z '' ]]\n+ [[ ehB != ehxB ]]\n+ umount_all\n+ directory=/home/user/qubes-builder/qubes-src/linux-template-builder/mnt\n+ '[' /home/user/qubes-builder/qubes-src/linux-template-builder/mnt == /home/user/qubes-builder/qubes-src/linux-template-builder/mnt -o /home/user/qubes-builder/qubes-src/linux-template-builder/mnt == /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/ ']'\n++ mountPoints\n+++ mountPoint ''\n+++ local mount_point=\n+++ [[ '' = /* ]]\n++++ readlink -m .\n+++ mount_point=/home/user/qubes-builder/qubes-src/linux-template-builder/\n++++ echo /home/user/qubes-builder/qubes-src/linux-template-builder/\n++++ sed 's#//*#/#g'\n+++ echo /home/user/qubes-builder/qubes-src/linux-template-builder/\n++ local mount_point=/home/user/qubes-builder/qubes-src/linux-template-builder/\n+++ sudo grep /home/user/qubes-builder/qubes-src/linux-template-builder/ /proc/mounts\n+++ cut -f2 '-d '\n+++ sort -r\n+++ grep '^/home/user/qubes-builder/qubes-src/linux-template-builder/'\n++ echo '/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/sys\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/run\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/proc\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/home/user/Whonix\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/dev/shm\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/dev/pts\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/dev\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt'\n+ '[' -n '/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/sys\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/run\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/proc\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/home/user/Whonix\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/dev/shm\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/dev/pts\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt/dev\n/home/user/qubes-builder/qubes-src/linux-template-builder/mnt' ']'\n+ removeDbusUuid\n+ '[' -e /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/var/lib/dbus/machine-id ']'\n+ outputc red 'Removing generated machine uuid...'\n+ color=red\n+ shift\n+ output 'Removing' generated machine 'uuid...'\n+ '[' 2 -ge 1 ']'\n+ [[ -z '' ]]\n+ [[ ehB != ehxB ]]\n+ rm -f /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/var/lib/dbus/machine-id\n+ removeDivertPolicy\n+ outputc red 'Reactivating initctl...'\n+ color=red\n+ shift\n+ output 'Reactivating' 'initctl...'\n+ '[' 2 -ge 1 ']'\n+ [[ -z '' ]]\n+ [[ ehB != ehxB ]]\n+ chroot dpkg-divert --local --rename --remove /sbin/initctl\n+ local retval\n+ true ''\n+ '[' '' == 1 ']'\n+ /usr/sbin/chroot /home/user/qubes-builder/qubes-src/linux-template-builder/mnt dpkg-divert --local --rename --remove /sbin/initctl\nRemoving 'local diversion of /sbin/initctl to /sbin/initctl.distrib'\n+ retval=0\n+ true\n+ true ''\n+ return 0\n+ outputc green 'Removing policy-rc.d'\n+ color=green\n+ shift\n+ output 'Removing' 'policy-rc.d'\n+ '[' 2 -ge 1 ']'\n+ [[ -z '' ]]\n+ [[ ehB != ehxB ]]\n+ rm -f /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/usr/sbin/policy-rc.d\n+ outputc red 'Restoring invoke-rc.d...'\n+ color=red\n+ shift\n+ output 'Restoring' 'invoke-rc.d...'\n+ '[' 2 -ge 1 ']'\n+ [[ -z '' ]]\n+ [[ ehB != ehxB ]]\n+ chroot sed -i -e 's/exit 0 #exit 100/exit 100/' /usr/sbin/invoke-rc.d\n+ local retval\n+ true ''\n+ '[' '' == 1 ']'\n+ /usr/sbin/chroot /home/user/qubes-builder/qubes-src/linux-template-builder/mnt sed -i -e 's/exit 0 #exit 100/exit 100/' /usr/sbin/invoke-rc.d\n+ retval=0\n+ true\n+ true ''\n+ return 0\n+ umount_kill /home/user/qubes-builder/qubes-src/linux-template-builder/mnt\n++ getXtrace\n++ [[ hB != hxB ]]\n++ echo 0\n+ local xtrace=0\n+ set +x\nAttempting to kill any processes still running in '/home/user/qubes-builder/qubes-src/linux-template-builder/mnt' before un-mounting\nINFO: umount /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/sys\nINFO: umount /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/run\nINFO: umount /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/proc\nINFO: umount /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/home/user/Whonix\nINFO: umount /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/dev/shm\nINFO: umount /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/dev/pts\nINFO: umount /home/user/qubes-builder/qubes-src/linux-template-builder/mnt/dev\nINFO: umount /home/user/qubes-builder/qubes-src/linux-template-builder/mnt\n+ [[ -n 0 ]]\n+ [[ 0 -eq 0 ]]\n+ set -x\n+ exit 100\n+ umount_kill /home/user/qubes-builder/qubes-src/linux-template-builder/mnt\n++ getXtrace\n++ [[ hB != hxB ]]\n++ echo 0\n+ local xtrace=0\n+ set +x\nAttempting to kill any processes still running in '/home/user/qubes-builder/qubes-src/linux-template-builder/mnt' before un-mounting\nMakefile:47: recipe for target 'rootimg-build' failed\nmake[1]: *** [rootimg-build] Error 100\nMakefile:279: recipe for target 'template-local-jessie+whonix-gateway+standard' failed\nmake: *** [template-local-jessie+whonix-gateway+standard] Error 1\n```\n","comments":[{"author":"marmarek","date_created":1438892894,"date_modified":1438892894,"content":"I think those are two totally unrelated issues:\n1. Build failure\n2. Usage of tasksel (and more generally - default package list for Qubes Debian template) in Whonix template build\n\nRegarding build failure - what value for REPO_PROXY did you set in builder.conf? Did you actually started a proxy there? Or maybe the proxy crashed for some reason?"},{"author":"Patrick","date_created":1438895893,"date_modified":1438895893,"content":">>! In T391#6309, @marmarek wrote:\n> I think those are two totally unrelated issues:\n> 1. Build failure\n> 2. Usage of tasksel (and more generally - default package list for Qubes Debian template) in Whonix template build\n\nYes.\n \n> Regarding build failure - what value for REPO_PROXY did you set in builder.conf?\n\nNot in `builder.conf`. Only using `override.conf`:\n```\nREPO_PROXY = http://127.0.0.1:3142\n```\n\n(Always followed by `./setup` when making changes, seems required.)\n\n> Did you actually started a proxy there?\n\nYes. Otherwise it would have failed much earlier. (I know this, because I learned by mistake to not forget the `http://` part of the proxy. ;)\n\n> Or maybe the proxy crashed for some reason?\n\nIndeed.\n\n```\n[user@qubes-build qubes-builder]$ sudo service apt-cacher-ng status\nRedirecting to /bin/systemctl status  apt-cacher-ng.service\n● apt-cacher-ng.service - The apt-cacher-ng proxy server\n   Loaded: loaded (/usr/lib/systemd/system/apt-cacher-ng.service; disabled)\n   Active: failed (Result: exit-code) since Thu 2015-08-06 19:23:01 CEST; 3h 40min ago\n  Process: 2790 ExecStop=/bin/kill -s QUIT $MAINPID (code=exited, status=1/FAILURE)\n  Process: 6963 ExecStart=/usr/sbin/apt-cacher-ng $DAEMON_OPTS pidfile=/var/run/apt-cacher-ng/pid SocketPath=/var/run/apt-cacher-ng/socket foreground=0 $EXTRA_ACNG_OPTS (code=exited, status=0/SUCCESS)\n Main PID: 6964 (code=killed, signal=TERM)\n\nAug 06 18:35:22 qubes-build apt-cacher-ng[6963]: WARNING: No URL list file matching file:backends_debian found in config or support directories.\nAug 06 18:35:22 qubes-build apt-cacher-ng[6963]: WARNING: No URL list file matching file:backends_ubuntu found in config or support directories.\nAug 06 18:35:22 qubes-build apt-cacher-ng[6963]: WARNING: No URL list file matching file:backends_debvol found in config or support directories.\nAug 06 18:35:22 qubes-build apt-cacher-ng[6963]: WARNING: No URL list file matching file:backends_gentoo found in config or support directories.\nAug 06 18:35:22 qubes-build systemd[1]: Started The apt-cacher-ng proxy server.\nAug 06 19:23:01 qubes-build kill[2790]: kill: not enough arguments\nAug 06 19:23:01 qubes-build systemd[1]: apt-cacher-ng.service: control process exited, code=exited status=1\nAug 06 19:23:01 qubes-build systemd[1]: Unit apt-cacher-ng.service entered failed state.\nAug 06 19:23:01 qubes-build systemd[1]: apt-cacher-ng.service failed.\n```\n\n```\n[user@qubes-build qubes-builder]$ sudo journalctl -u apt-cacher-ng\n-- Logs begin at Thu 2015-07-09 20:13:58 CEST, end at Thu 2015-08-06 23:08:14 CEST. --\nAug 06 18:35:22 qubes-build systemd[1]: Starting The apt-cacher-ng proxy server...\nAug 06 18:35:22 qubes-build apt-cacher-ng[6963]: WARNING: No URL list file matching file:backends_debian found in config or support directories.\nAug 06 18:35:22 qubes-build apt-cacher-ng[6963]: WARNING: No URL list file matching file:backends_ubuntu found in config or support directories.\nAug 06 18:35:22 qubes-build apt-cacher-ng[6963]: WARNING: No URL list file matching file:backends_debvol found in config or support directories.\nAug 06 18:35:22 qubes-build apt-cacher-ng[6963]: WARNING: No URL list file matching file:backends_gentoo found in config or support directories.\nAug 06 18:35:22 qubes-build systemd[1]: Started The apt-cacher-ng proxy server.\nAug 06 19:23:01 qubes-build kill[2790]: kill: not enough arguments\nAug 06 19:23:01 qubes-build systemd[1]: apt-cacher-ng.service: control process exited, code=exited status=1\nAug 06 19:23:01 qubes-build systemd[1]: Unit apt-cacher-ng.service entered failed state.\nAug 06 19:23:01 qubes-build systemd[1]: apt-cacher-ng.service failed.\n```\n\nWild speculation: perhaps the build script killed apt-cacher-ng running on the build VM level?"},{"author":"marmarek","date_created":1438901062,"date_modified":1438901062,"content":">>! In T391#6310, @Patrick wrote:\n> Wild speculation: perhaps the build script killed apt-cacher-ng running on the build VM level?\n\nQuite possible. There is [[ https://github.com/nrgaway/qubes-template-whonix/blob/master/whonix-gateway/02_install_groups_pre.sh#L270 | a code to stop apt-cacher-ng ]]. Maybe somehow calling `service` from within chroot still communicates with the outside systemd?"},{"author":"Patrick","date_created":1439565948,"date_modified":1439565948,"content":"No longer using taksel. Building Whonix templates now with flavor `minimal` and `no-recommends` to get better control of the installed packages. Therefore also no more build error."}]},"PHID-TASK-uniypzrbfyweatdbh7px":{"id":"390","title":"whonixcheck should test for unwanted packages such as chrony, ntp, ntpdate and other anon-banned-packages","status":"resolved","priority":"Normal","author":"Patrick","description":"TODO:\n* implement a configureable list of packages with reasons into #whonixcheck\n* remove anon-banned-packages - https://github.com/Whonix/anon-meta-packages/blob/33c41008270345b8f780e0a4afaf35afde8ec56d/debian/control#L326-L339\n* remove from anon-shared-packages-recommended's `Depends:` https://github.com/Whonix/anon-meta-packages/blob/33c41008270345b8f780e0a4afaf35afde8ec56d/debian/control#L39\n","comments":[{"author":"Patrick","date_created":1439660541,"date_modified":1439660541,"content":"`whonixcheck test for unwanted packages such as chrony, ntp, ntpdate and other anon-banned-packages - https://phabricator.whonix.org/T390`:\nhttps://github.com/Whonix/whonixcheck/commit/0113ef90fe943f5afe145948acd3c0f66dd2fc5b\n\n`deprecated anon-banned-packages because checking for those in now implemented in whonixcheck - https://phabricator.whonix.org/T390`:\nhttps://github.com/Whonix/anon-meta-packages/commit/d4ddc3d532d156687dc26fda7c66577593fb47c2\n"}]},"PHID-TASK-cymgtiquumth62et3jel":{"id":"389","title":"make sure Qubes-Whonix has no access to clocksource=xen","status":"open","priority":"Normal","author":"Patrick","description":"```\ncat /sys/devices/system/clocksource/clocksource0/current_clocksource\nxen\n```\nBad. Should not be set to xen. (--> [Clock Correlation Attack](https://www.whonix.org/wiki/Dev/TimeSync#Clock_Correlation_Attack))\n\n```\ncat /sys/devices/system/clocksource/clocksource0/available_clocksource \nxen tsc\n```\nProbably bad. We don't want compromised VMs being able to access dom0's or any other VMs clock. I.e we probably don't want clocksource `xen`.\n\nQuestions:\n\n* What does clocksource=xen do? Is there documentation on clocksource xen? -> https://github.com/QubesOS/qubes-issues/issues/1764#issuecomment-195619793 ([w](http://www.webcitation.org/6fxu8ETjr))\n * this: https://github.com/QubesOS/qubes-issues/issues/1764#issuecomment-195619793\n* Can we make clocksource=xen unavailable to Qubes-Whonix VMs?\n\nRelated Qubes upstream bug:\n[libvirt domain validation error; virsh edit issue](https://github.com/QubesOS/qubes-issues/issues/1430)\n","comments":[{"author":"Patrick","date_created":1438799457,"date_modified":1438799457,"content":"clocksource xen is similar to clocksouce kvmclock.\n\nQuote http://old-list-archives.xenproject.org/xen-devel/2010-03/msg00484.html in context of clocksource xen\n> in KVM when using its very similar pv clock interface\n\nAnd kvmclock is bad in context of Whonix.\n\nQuote https://rwmj.wordpress.com/tag/kvmclock/\n> kvmclock or KVM pvclock lets guests read the host’s wall clock time.\n\nAnd we don't want that. We want time in Whonix-Gateway, Whonix-Workstation vs other VMs to slightly differ to prevent correlation attacks. [More info on the https://www.whonix.org/wiki/Dev/TimeSync page.]\n\nIn conclusion we ought to get rid of clocksource xen for Qubes-Whonix."},{"author":"Patrick","date_created":1438800935,"date_modified":1438800935,"content":"One way to approach this could be editing the libvirt xml. [Similar how we solved this for kvm.](https://github.com/Whonix/whonix-libvirt/blob/master/usr/share/whonix-libvirt/xml/Whonix-Workstation.xml) I don't know yet. But while experimenting with it, I run into an issue. Posted on qubes-devel.\n`virsh edit issue`:\nhttps://groups.google.com/forum/#!topic/qubes-devel/aN3IOv6JmKw\n"},{"author":"Patrick","date_created":1438821505,"date_modified":1438821505,"content":"`[Xen-users] clocksource xen documentation?`:\nhttp://lists.xen.org/archives/html/xen-users/2015-08/msg00018.html\n"},{"author":"Patrick","date_created":1438864774,"date_modified":1438864774,"content":">>! In T389#6254, @Patrick wrote:\n> `[Xen-users] clocksource xen documentation?`:\n> http://lists.xen.org/archives/html/xen-users/2015-08/msg00018.html\n\nAnswer:\nhttp://lists.xen.org/archives/html/xen-users/2015-08/msg00019.html\n"},{"author":"Patrick","date_created":1438888420,"date_modified":1438888420,"content":"`How to read clocksource xen as a [root] user?`:\nhttp://lists.xen.org/archives/html/xen-users/2015-08/msg00020.html"},{"author":"Patrick","date_created":1439211557,"date_modified":1439211557,"content":"`Is it possible to read PVclock from user space?`:\nhttp://unix.stackexchange.com/questions/222287/is-it-possible-to-read-pvclock-from-user-space\n"},{"author":"Patrick","date_created":1439391262,"date_modified":1439391262,"content":">>! In T389#6308, @Patrick wrote:\n> `How to read clocksource xen as a [root] user?`:\n> http://lists.xen.org/archives/html/xen-users/2015-08/msg00020.html\n\nGot an answer:\nhttp://lists.xen.org/archives/html/xen-users/2015-08/msg00035.html\n\nTo paraphrase it, \"no, not easily possible\"."},{"author":"Patrick","date_created":1447615548,"date_modified":1447615548,"content":">>! In T389#6253, @Patrick wrote:\n> One way to approach this could be editing the libvirt xml. [Similar how we solved this for kvm.](https://github.com/Whonix/whonix-libvirt/blob/master/usr/share/whonix-libvirt/xml/Whonix-Workstation.xml) I don't know yet. But while experimenting with it, I run into an issue. Posted on qubes-devel.\n> `virsh edit issue`:\n> https://groups.google.com/forum/#!topic/qubes-devel/aN3IOv6JmKw\n\nCreated https://github.com/QubesOS/qubes-issues/issues/1430 for it."},{"author":"Patrick","date_created":1448407937,"date_modified":1448407937,"content":"`How to get a completely isolated virtual time using Xen?`\nhttp://security.stackexchange.com/questions/106406/how-to-get-a-completely-isolated-virtual-time-using-xen\n"},{"author":"Patrick","date_created":1448462969,"date_modified":1448462969,"content":"`How to get a completely isolated virtual time using Xen?`\nhttp://lists.xen.org/archives/html/xen-users/2015-11/msg00114.html"},{"author":"Patrick","date_created":1455670077,"date_modified":1455670077,"content":"This may not be possible without linux kernel and/or xen patches. The `independent_wallclock` feature is no longer available in recent verisons. Source:\nhttp://syslog.me/2011/01/05/independent-wallclock-in-xen-4/\n\n`[Xen-users] How to disable clocksource xen pvclock?`:\nhttp://lists.xen.org/archives/html/xen-users/2016-02/msg00069.html\n"},{"author":"Patrick","date_created":1475174842,"date_modified":1475174842,"content":"[An interesting point has been made by](https://forums.whonix.org/t/tails-features-ideas/2611/3) @HulaHoop.\n\n> haveged relies on the RDTSC instruction, that apparently is useless in some virtualized environments. Also, the quality of random numbers output by HAVEGE is unclear, and the topic of many discussions.\n\nSo if managed to somehow make clocksource `tsc` (high resolution (!) CPU timing information?) [and `xen`] unavailable to  VMs, we would break [entropy and haveged in Qubes](https://github.com/QubesOS/qubes-issues/issues/673). Which is bad, since Xen apparently does not come with VirtIO RNG like KVM does."}]},"PHID-TASK-jl3zvq2qky5onqfd6qf4":{"id":"388","title":"document Spoof the Initial Virtual Hardware Clock Offset for KVM (biossystemtimeoffset)","status":"resolved","priority":"Normal","author":"Patrick","description":"Fill out:\nhttps://www.whonix.org/wiki/Advanced_Security_Guide#KVM\n\nSimilar to:\nhttps://www.whonix.org/wiki/Advanced_Security_Guide#VirtualBox\n\nGeneric link:\nhttps://www.whonix.org/wiki/Advanced_Security_Guide#Spoof_the_Initial_Virtual_Hardware_Clock_Offset\n\n(`biossystemtimeoffset`)","comments":[{"author":"HulaHoop","date_created":1438782202,"date_modified":1438782202,"content":"KVM does not have a way to introduce a random offset to a VM's clock. The offset is arbitrary and static so I don't think it will be useful."},{"author":"Patrick","date_created":1438784096,"date_modified":1438784096,"content":"Doesn't need to be random. Why isn't a static one useful? Just needs to be a custom number. Only known to the host. Not known to public and/or the guest VM. It wouldn't be useful to deploy this by default, because then the offset would be known. This is something in context for advanced security guide. Every advanced user is expected to make up their own numbers and adding this to the VM setting by themselves. That's why this ticket's project is #user_documentation and not whonix-libvirt."},{"author":"HulaHoop","date_created":1438830750,"date_modified":1438830750,"content":"Against an active attacker, static offsets and (random too to an extent) are not that effective. They can actively manipulate host NTP and figure out that the Whonix guest sits on a host machine of a certain target set. Say the real time is 1:30 they skew it to 1:15 for a certain target country - probably much less in real life to avoid being noticed but even a few seconds is enough then upon reboot the in the rooted VM they see its 1:15 + 5 seconds or even some random offset between 30seconds to a minute, this still won't be enough to disguise the fact that the host falls within a targeted set.\n\nThis attack seems hard but remember large network adversaries have all the time in the world (no pun intended) and can skew it subtly for as many people/areas as they can.\n\nThe only way to protect against this is to not leak host time at all so there is nothing to compare VM time to.\n\n"},{"author":"Patrick","date_created":1438861083,"date_modified":1438861083,"content":"Did you notice how this raised the bar? From just...\n\na) passive ISP level adversary + Whonix-Workstation exploit -> correlate time attack succeeds\n\nto\n\nb) host time offset + active ISP level adversary to manipulate NTP against many users [which risks getting this detected] + Whonix-Workstation exploit -> correlate time attack success\n\nSo that alone would make it worth to apply this setting.\n\n-----\n\nIt happens in context of advanced security guide. So there is no NTP on the host. Nothing to skew in the first place. Static offsets therefore should work."},{"author":"HulaHoop","date_created":1438878984,"date_modified":1438878984,"content":"Its trivial to document, that's not the problem, but I'm trying to see if it makes sense.\n\n> It happens in context of advanced security guide. So there is no NTP on the host. Nothing to skew in the first place. Static offsets therefore should work.\n\nRight, in the context of someone following the advanced security guide, this won't gain them any more protection than what they already have because I assume they will not be running anything in the clear on the host either.\n\nFor hose not following any of the advice they will be safe as things are but only against a passive adversary."},{"author":"Patrick","date_created":1438885180,"date_modified":1438885180,"content":"This is a defense in depth. It's hard to be 100% sure, local clock has never leaked, no? Even if they avoid clearnet traffic while browsing anonymous, how realistic is it to ask to never use clearnet ever again? If the clock leaked before they had applied all these settings, then they're better off spoofing the time offset."},{"author":"HulaHoop","date_created":1439054690,"date_modified":1439054690,"content":"Change:\n\n<clock offset='utc'>\n\nto\n\n<clock offset='variable' adjustment='123456' basis='utc'>\n\nadjustment takes any arbitrary value of seconds. Pick a random number of seconds only known to you."},{"author":"Patrick","date_created":1439156283,"date_modified":1439156283,"content":"That's it basically. Can you add this to the wiki please? And expand it a bit? (See the VirtualBox example. There is somewhat a suggested limit for the range. But the best range can be audited and revised if applicable.) Then this ticket can be considered resolved."},{"author":"HulaHoop","date_created":1439227051,"date_modified":1439227051,"content":"Where on the wiki should I post this?"},{"author":"HulaHoop","date_created":1439227179,"date_modified":1439227179,"content":"OK I see"},{"author":"Patrick","date_created":1439866369,"date_modified":1439866369,"content":"Thanks for your edit.\n\nhttps://www.whonix.org/wiki/Advanced_Security_Guide#KVM does this work? Did you test it with a big enough noticeable amount?"},{"author":"HulaHoop","date_created":1439912644,"date_modified":1439912644,"content":"I tried it with 123456 seconds and it pushed time in the vm the expected 34 hours in the future."}]},"PHID-TASK-havxfbaqfdjj2kxyym7f":{"id":"387","title":"Qubes-Whonix-Gateway as ClockVM","status":"open","priority":"Normal","author":"Patrick","description":"__prerequisite knowledge__:\n\n* The design goal is, that the host's [any VMs], Whonix-Gateway and any Whonix-Workstation's clock should slightly differ.\n* Rationale: Prevent adversaries from linking anonymous and pseudonymous activity. Described in more detail on the [Dev/TimeSync](https://www.whonix.org/wiki/Dev/TimeSync) wiki page.\n\n-----\n\n__What this is not__:\n\n* Therefore Whonix-Gateway should not \"directly\" be the ClockVM for all other VMs.\n* Using a second instance of sdwdate.\n\n-----\n\n__task description__:\n\n* Reusing Whonix-Gateway and sdwdate.\n* Having the time securely provided by sdwdate.\n* Useful to reuse these components, since sdwdate depends on Tor, that Whonix-Gateway provides. And Whonix-Gateway is also the right place for Tor configuration.\n* Having a second instance of sdwdate running within Whonix-Gateway that provides time for dom0 and all non-Whonix VMs would be an improvement against time related attacks.\n* Better than NTP.\n* For those who are willing to use Tor.\n","comments":[{"author":"Patrick","date_created":1448572289,"date_modified":1448572289,"content":"Running two sdwdate daemons all the time sounds awful. Thinking of a simpler solution.\n\nCould we add a `--oneshot` feature to sdwdate that would only output a unixtime string? I.e. instead of setting the time, just writing it to stdout and exit?\n\n(And somehow not mess up sdwdate daemon's logs. Perhaps we'd also need switches to configure log location.)"},{"author":"Patrick","date_created":1461785677,"date_modified":1461785677,"content":"I can imagine a much simpler implementation to make Qubes-Whonix-Gateway work as ClockVM. Similar to `dom0` [qubes.GetRandomizedTime](https://github.com/marmarek/qubes-core-admin/blob/master/qubes-rpc/qubes.GetRandomizedTime).\n\n`sys-whonix` could re-use the very same script as [qubes.SyncNtpClock](https://github.com/Whonix/qubes-whonix/blob/master/etc/qubes-rpc/qubes.SyncNtpClock.anondist).\n\nLooks simple enough. Could do this even for #Whonix_13. I haven't fully thought it through yet. The obvious disadvantage would be the the dom0 clock not being as accurate. Whatever consequences that may have. So we would have to regard this feature as experimental."},{"author":"marmarek","date_created":1461787834,"date_modified":1461787834,"content":"Interesting idea, but probably something better is needed. If this would\nbe used directly, every qubes.SyncNtpClock would return time with\ndifferent offset. Which means frequent clock jumps in dom0 (and VMs),\nboth forward and backward.\nMaybe a simple improvement would be enough: choose an offset at\nQubes-Whonix-Gateway startup time and use that value until its shutdown?"},{"author":"Patrick","date_created":1461794234,"date_modified":1461794234,"content":"There is also an interesting interaction to be thought through. sys-whonix -> gets suspended -> gets resumed -> calls dom0 qubes.GetRandomizedTime -> gets time from dom0 -> restarts sdwdate. At a close time, dom0 might call sys-whonix qubes.SyncNtpClock. So we would have a circle.\n\nAfter sys-whonix was resumed, perhaps sys-whonix qubes.SyncNtpClock should either\na) block until sdwdate succeeded\nb) exit non-zero\n?\n\nmarmarek (Marek Marczykowski-Górecki):\n>   Maybe a simple improvement would be enough: choose an offset at\n>   Qubes-Whonix-Gateway startup time and use that value until its shutdown?\n\nSounds good!\n"},{"author":"marmarek","date_created":1461796800,"date_modified":1461796800,"content":">   After sys-whonix was resumed, perhaps sys-whonix qubes.SyncNtpClock should either\n>   a) block until sdwdate succeeded\n>   b) exit non-zero\n>   ?\n\nBetter exit non-zero. Then other VMs will have time synced with\ndom0 clock. Blocking will delay other VMs clock sync (those VMs will\nhave time from before suspend). And it may be a long time, because user\nmay be in totally different location, without network access, so sdwdate\nwill not succeeded."},{"author":"Patrick","date_created":1488390367,"date_modified":1488390367,"content":"I was wondering, how big should be the offset? +/- x seconds?\n\n* Let's assume Qubes-Whonix-Gateway sdwdate got a real good time fix, very similar to NTP accuracy. Then the offset would mess up that accuracy a lot and thereby lower anonymity.\n* Let's assume Qubes-Whonix-Gateway sdwdate got a real bad time fix (for example + 220 seconds drift), then any offset would miss the design goal (as per the first bullet point in this ticket description).\n\nAll of that speaks for independent sdwdate daemons.\n\nOn the other hand I really like the offset approach and wish to find a sane implementation path. This is because implementing Qubes friendly sdwdate-gui (T534) would be really hard. Therefore I was wondering if the offset approach could not be made the default mode of operating. I mean, Whonix-Gateway could run a sdwdate-master and all Whonix-Workstations and other systems (dom0, other VMs) could periodically use a sdwdate-slave and request its time from Whonix-Gateway.\n\nWould require somehow multiple numbers of offsets. I.e. X offsets, since the gateway cannot know how many workstations will be started. Or X sdwdate daemons.\n\nOr somehow the `sdwdate --oneshot` approach and blocking, but then we'd have the issues resulting from blocking that you described.\n\nSomehow need to find a way so T534 would not have to be implemented, so seeing sdwdate status of Whonix-Gateway only would suffice."}]},"PHID-TASK-h5l4vc2uyivbqbjtsdwn":{"id":"386","title":"meek Pluggable Transport","status":"open","priority":"Normal","author":"HulaHoop","description":"The meek pluggable transport relies on the concept of too big to block to thwart censorship by governments that depend on access to these services.\n\nAt the moment it seems meek-http-helper depends on headless Firefox to run using xvfb. This could be a problem but may have since changed.\n\ni386 debs are available.\n\nInvestigate if we can include them with obfs4.\n\n***\n\nRepo keys: https://people.torproject.org/~infinity0/apt/\n\nOfficial instructions for meek on Debian: https://lists.torproject.org/pipermail/tor-dev/2015-March/008369.html\n\nSE instructions: https://tor.stackexchange.com/a/4074\n\nSource package: https://mentors.debian.net/package/meek\nBinary packages: https://people.torproject.org/~infinity0/bin/\n\n`make a deb of meek and get into Debian`: https://trac.torproject.org/projects/tor/ticket/13160","comments":[{"author":"HulaHoop","date_created":1438289293,"date_modified":1438289293,"content":"Looks like Iceweasel/Firefox is a necessary dependency. Its needed to emulate a normal looking HTTPS connection to Google or Amazon.\n\nTo get around the problem of users shooting themselves in the foot and browsing on Whonix Gateway we can restrict what users are allowed to run Iceweasel. Only the Tor user that meek runs under should have run capabilities for the binary. The \"user\" account should not. Maybe this can be done with chmod."},{"author":"HulaHoop","date_created":1438300276,"date_modified":1438300276,"content":"https://trac.torproject.org/projects/tor/ticket/11183\n\nmeek connection needs to bypass Tor proxy settings. I'm not liking this. Could leave room for leaks from GW. But how do we deal with obfsproxy? Is it the same situation?"},{"author":"Patrick","date_created":1438338237,"date_modified":1447696057,"content":"Did you succeed in setting this up you? Can you share instructions in meanwhile please?\n\nI am not very concerned about iceweasel. Without setting a SocksPort it will be unable to connect. We could also 'config-package-dev hide' its starter. And/or add something similar to https://github.com/Whonix/anon-iceweasel-warning [or extend that package with a gateway specific message].\n\nobfsproxy runs under the same user as Tor itself: `debian-tor`. That user is allowed to connect to any outside destination. meek should probably under the same user account?\n\nProbably better to wait until this package hits Debian's or The Tor Project's APT repository?\nTODO: feature request for adding meek to The Tor Project's APT repository.\n\nThere are many pluggable transports. The competing ticket to get all and the most recent of them is this one:\nT118"},{"author":"HulaHoop","date_created":1438382190,"date_modified":1438382303,"content":"> Did you succeed in setting this up you? Can you share instructions in meanwhile please?\n\nI haven't tried it yet. I will have to mask the experimental gateway's traffic or I risk deanonymizing myself. Before I go ahead I wanted to discuss the future direction of pluggable transport support on GW.\n\n\n* The problems discussed in https://trac.torproject.org/projects/tor/ticket/14121 can be solved even if the features requested are never developed. Running TBB Tor headlessly is possible thru using xvfb (pkg that tricks a gui application into thinking its connected to a X-server) and something like selenium.\n\nhttps://github.com/webfp/tor-browser-crawler\nhttps://github.com/isislovecruft/tor-browser-selenium\n\n\nEven when we can run TBB headlessly and still take advanatge of torlauncher-gui I forsee problems that will make the entire idea a non-starter. We cannot redistribute TBB binaries. They must be downloaded. Imagine users in censored areas where they can't connect with Tor how will they be able to fetch TBB when connections to TPO are censored? Downloading from alternative distribution channels using GetTor will leave all kinds of network fingerprints.\n\nThe only sane solution is for TPO to spin off torlauncher-gui into its own independent package along with all pluggable transports, all in their repo so we can redistribute them freely and generate builds that include them without problems."},{"author":"HulaHoop","date_created":1438396370,"date_modified":1438396370,"content":"Running Whonix Gateway behind another Whonix Gateway doesn't work for some reason. Any suggestions? I can't run this in the clear when I've already talked about it because it can be linked to me.\n\n"},{"author":"Patrick","date_created":1438415692,"date_modified":1465824769,"content":">>! In T386#6194, @HulaHoop wrote:\n> * The problems discussed in https://trac.torproject.org/projects/tor/ticket/14121 can be solved even if the features requested are never developed. Running TBB Tor headlessly is possible thru using xvfb (pkg that tricks a gui application into thinking its connected to a X-server) and something like selenium.\n> \n> https://github.com/webfp/tor-browser-crawler\n> https://github.com/isislovecruft/tor-browser-selenium\n> \n> \n> Even when we can run TBB headlessly and still take advanatge of torlauncher-gui I forsee problems that will make the entire idea a non-starter. We cannot redistribute TBB binaries. They must be downloaded. Imagine users in censored areas where they can't connect with Tor how will they be able to fetch TBB when connections to TPO are censored? Downloading from alternative distribution channels using GetTor will leave all kinds of network fingerprints.\n> \n> The only sane solution is for TPO to spin off torlauncher-gui into its own independent package along with all pluggable transports, all in their repo so we can redistribute them freely and generate builds that include them without problems.\n\nAnswered here:\nhttps://www.whonix.org/old-forum/index.php/topic,720.msg9280.html#msg9280"},{"author":"Patrick","date_created":1438436686,"date_modified":1465824785,"content":">>! In T386#6195, @HulaHoop wrote:\n> Running Whonix Gateway behind another Whonix Gateway doesn't work for some reason. Any suggestions? I can't run this in the clear when I've already talked about it because it can be linked to me.\n\nAnswered here:\nhttps://www.whonix.org/old-forum/index.php/topic,1476.msg9283.html#msg9283"},{"author":"HulaHoop","date_created":1438523012,"date_modified":1438523012,"content":"Closing this ticket.\n\nIts part of a bigger project of how we want to add pluggable transport support for Whonix, discussed in https://phabricator.whonix.org/T118"},{"author":"Patrick","date_created":1465824707,"date_modified":1465824707,"content":">>! In T386#6199, @HulaHoop wrote:\n> Closing this ticket.\n> \n> Its part of a bigger project of how we want to add pluggable transport support for Whonix, discussed in https://phabricator.whonix.org/T118\n\nSince we are no longer going for T118, reopen."},{"author":"Patrick","date_created":1465824881,"date_modified":1465824881,"content":"Will be checking on this ticket during porting to #debian_stretch (or +1 more depending on when meek lands in Debian)."},{"author":"Patrick","date_created":1484459781,"date_modified":1526138230,"content":"Didn't make it into #debian_stretch. Rechecking in #debian_version_10_codename_buster."},{"author":"Patrick","date_created":1526138259,"date_modified":1526138259,"content":"meek might be dead by then:\nhttps://forums.whonix.org/t/replacing-meek-snowflake"}]},"PHID-TASK-dpy2ikajfp3lmslgvrly":{"id":"385","title":"New Proposal for Seamless Time-sync after Suspend-Resume","status":"open","priority":"Normal","author":"HulaHoop","description":"More testing was done, inspired by the information here: https://serverfault.com/a/694543  \n\nIf date command sets system time during a session it will be honored even after a system-resume meaning sdwdate's time will stay the same even after resume with kvmclock available. If date command is never run during a session, the kvm-clock hwclock automatically adjusts system time after resume. kvm-clock always keeps up with host time. Running \"sudo hwclock\" confirms this.\n\nGiven this information, to make sdwdate work with hwclock (kvm-clock) it must monitor the difference between date command output and hwclock. Just like the loop check mechanism in the other ticket. If it exceeds certain delta time it would synchronize the system time to match that of hwclock with command:\n\nsudo hwclock --hctosys\n\nThe running of timesync on WS would be slightly delayed (for 30s) to give time for sdwdate GW to set a baseline time from hwclock to allow Tor to connect.\n\nAdvantages of this ticket:\n\n* No extra packages needed\n* No security tradeoffs cased by guest-agents\n* No intervm signalling needed\n* Works in both GW and WS\n\n\n***\nIt is safe to enable kvmclock because it doesn't interfere with the time set by sdwdate. We already decided in the threat model discussed in: https://whonix.org/wiki/Time_Attacks that even without giving access to kvmclock timesync cannot protect against active attacks by an adversary inside the WS.\n\nTo enable kvmclock the settings need to be reverted to:\n\n  <clock offset='utc'>\n    <timer name='rtc' tickpolicy='catchup'/>\n    <timer name='pit' tickpolicy='delay'/>\n    <timer name='hpet' present='no'/>\n  </clock>\n  \n  \nand whonixcheck should disable its kvm-clock warning.\n","comments":[{"author":"Patrick","date_created":1438197426,"date_modified":1438197426,"content":"> without giving access to kvmclock timesync cannot protect against active attacks by an adversary inside the WS\n\nWhy not? With a biossystemtimeoffset alike feature it could."},{"author":"HulaHoop","date_created":1438197645,"date_modified":1438197645,"content":"If we presuppose an active attacker sitting inside WS they could easily disable biossystemtimeoffset, no?"},{"author":"Patrick","date_created":1438198503,"date_modified":1438198503,"content":"No. Because that's a virtualizer specific setting applied on the host. Not inside the guest."},{"author":"HulaHoop","date_created":1438198880,"date_modified":1438198880,"content":"I'm confused is biossystemtimeoffset a whonix-host package?\n\nThe threat model considers active skew attacks against hosts running NTP too. A small offset against a skew of say 5 or 10 minutes will not help.\n\nEither way the package won't hurt.\n\n\n"},{"author":"Patrick","date_created":1438206834,"date_modified":1438206834,"content":"> I'm confused is biossystemtimeoffset a whonix-host package?\n\nbiossystemtimeoffset isn't a package. It's a VirtualBox setting. One that was previously recommended to users to manually set. Other virtualizers might have similar settings. We've discussed this at the early stages of KVM port. Not sure if KVM had it. We deprecated it because of the introduction of bootclockrandomization. Here is the deprecated documentation:\nhttps://www.whonix.org/wiki/Deprecated#VirtualBox_spoof_the_initial_virtual_hardware_clock_offset\nIf you search the wiki for 'biossystemtimeoffset', you'll find some more. However, for better comfort and adaptation, this would suit perhaps into the context of a whonix-host package.\n\nI keep writing 'biossystemtimeoffset alike', because I haven't found a good virtualizer agnostic term yet.\n\n> The threat model considers active skew attacks against hosts running NTP too. A small offset against a skew of say 5 or 10 minutes will not help.\n\nDepends. There are threat models in which the adversary doesn't know who's NTP clock to skew. Also not all adversaries are capable of it. On the other hand, controlling a few web servers that are receiving local clock leaks (ex: javascript) by many users and at the same time having compromised a Whonix-Workstation might not be a that unlikely threat model. In that cases, biossystemtimeoffset alike approaches are still very much worth it."},{"author":"HulaHoop","date_created":1438703543,"date_modified":1438703543,"content":"I tried running these settings again today but I couldn't reproduce them at all even after a clean boot. This ticket is dead reopening 381."},{"author":"Patrick","date_created":1438722845,"date_modified":1438722845,"content":"`document Spoof the Initial Virtual Hardware Clock Offset for KVM`:\nT388\n"},{"author":"Patrick","date_created":1438722918,"date_modified":1438722918,"content":"Would limit security. (Proposal is incompatible with `Spoof the Initial Virtual Hardware Clock Offset`)"},{"author":"HulaHoop","date_created":1450302037,"date_modified":1450302037,"content":"latest results:\n\nswitched off bootclockrandomization + swdate servcies\nkvmclock present\n\nUpon resume guest softclock is perfectly in sync with system. hwclock is not.\n\n\nWihout kvmclock both the softclock and hwclock are not synced.\nResults reproducible across restarts.\n\nExact same results with swdate and bootclockrandomization left on. The time set by sdwdate is honored until a host standby/resume event which causes th softclock in the vm to sync.\n\n\nThe only time the clock does not sync to the host's is when the guest is delayed by saving or pausing but that has nothing to do with normal opeation.\n\n\nI think its best that the kvmclock warning is disabled on gw so it can be left to use kvmclock normally. There is nothing unsafe about it. It would have been the exact same effect with the qemu guest-agent solution except the latter is not ready and would have required extra packages and settings to configure."},{"author":"Patrick","date_created":1450382509,"date_modified":1450382509,"content":"Given that setup... If you freeze the gateway for more than let's say 3 hours, is Tor actually able to recover from this - from Tor's perspective - time warp?\n\nissues with that proposal:\n\n* gw solution only, ws would still continue to use the slow clock\n* assuming a compromised gateway, would still violate the goal to have a fully independent VM clock [to protect the host and other VMs; to a lesser importance, also to protect time attacks when using additional (VPN or w/e) gateways in front that the compromised Whonix-Gateway)\n* using just kvmclock after suspend contradits the reason for running sdwdate on the gateway in the first place"},{"author":"HulaHoop","date_created":1450458151,"date_modified":1450458151,"content":"\n\n\n>>! In T385#7669, @Patrick wrote:\n> Given that setup... If you freeze the gateway for more than let's say 3 hours, is Tor actually able to recover from this - from Tor's perspective - time warp?\n> \n\nYes\n\n> issues with that proposal:\n> \n> * gw solution only, ws would still continue to use the slow clock\n\nNot different from whats happening now, but thats what sdwdate is for. At least it will work now that the gw is still connected to Tor.\n\n> * assuming a compromised gateway, would still violate the goal to have a fully independent VM clock [to protect the host and other VMs; to a lesser importance, also to protect time attacks when using additional (VPN or w/e) gateways in front that the compromised Whonix-Gateway)\n\nIMO a compromised gw means game over and the clock reading is the least thing a user should worry about at this point. We can also  agree that running Tor thru a VPN isn't much help if the Tor/gw anonymity is broken.\n\n> * using just kvmclock after suspend contradits the reason for running sdwdate on the gateway in the first place\n\nNot necessarily because the gw clock will honor the time set by sdwdate. The current time supplied by kvmclock is also no different than what would happen when I restart the gateway now so it updates its clock for Tor to work.\n\nA bonus usability feature is to have some script in the gateway running in a loop and detect softclock jumps and trigger a sdwdate run for both gw and ws somehow but its probably difficult. Even without this,  usability improves than what it is now and manual running of sdwdate after resume is seamless in the ws across suspend/resume sessions."},{"author":"Patrick","date_created":1450555381,"date_modified":1450555381,"content":"HulaHoop (HulaHoop):\n>> - assuming a compromised gateway, would still violate the goal to\n>> have a fully independent VM clock [to protect the host and other\n>> VMs; to a lesser importance, also to protect time attacks when\n>> using additional (VPN or w/e) gateways in front that the\n>> compromised Whonix-Gateway)\n> \n> IMO a compromised gw means game over and the clock reading is the\n> least thing a user should worry about at this point. We can also\n> agree that running Tor thru a VPN isn't much help if the Tor/gw\n> anonymity is broken.\n\nIn the use case of using Tor for non-anonymous use, location privacy,\nother VMs or the host should not be more vulnerable than necessary. The\nlocation privacy use case is for example what Appelbaum uses Tor for.\nAlso the other the \"I have nothing to hide but my privacy\" crowd should\ncare. \"least thing a user should worry about at this point\" only applies\nto some part of users. We appreciate the \"I have nothing to hide but my\nprivacy\" crowd so those who really need anonymity have the required\ncompany to hide.\n\n>> - using just kvmclock after suspend contradicts the reason for\n>> running sdwdate on the gateway in the first place\n> \n> Not necessarily because the gw clock will honor the time set by\n> sdwdate. The current time supplied by kvmclock is also no different\n> than what would happen when I restart the gateway now so it updates\n> its clock for Tor to work.\n\nThen you would at least have bootclockrandomization before Tor connects.\n\nFrom the Dev/TimeSync Page:\n\n> Using Boot Clock Randomization, i.e. after boot, the clock is set\nrandomly between 5 and 180 seconds into the past or future. This is\nuseful to enforce the design goal, that the host clock and\nWhonix-Workstation clock should always slightly differ. It's also useful\nto obfuscate the clock when sdwdate itself is running, because naturally\nat this time, sdwdate hasn't finished.\n\nYou could say, no longer required, because there are no more local clock\nleaks. But I am not so sure really all local clock leaks have been even\nfound. This is because I was involved in reporting some of these local\nclock leaks. They were only fixed, because by chance I happened to read\nhistoric Tor trac development discussions, and then using logic to draw\nthe right conclusions, then reported bugs. I didn't read the related\nsource codes nor checked with a traffic analyzer that there are no other\nlocal clock leaks. And I find it very likely, that no one else ever did\nthat either, because these issues remained unnoticed for years."},{"author":"HulaHoop","date_created":1450636412,"date_modified":1450636412,"content":"If Tor is broken then everyone's protection is gone just as if they are using the clearnet. Everyone no matter the threat model would be completely hosed. VPNs won't save them because plain SSL as a protocol and VPN design as single point of failure is why they cannot anonymize traffic. At that point the attacker will know a lot more valuable information than the local time about everyone.\n\n> Then you would at least have bootclockrandomization before Tor connects. \n\nOK Good. Please adjust the pv_clock function to check on ws only because I want to enable kvmclock on the gw.\n\n> You could say, no longer required, because there are no more local clock leaks.\n\nThats right and I would be willing to revisit this should evidence otherwise arise but thats unlikey because all the papers covering this point to things that have been handled already for the protocols in question on the gw."},{"author":"Patrick","date_created":1450698415,"date_modified":1450698415,"content":"HulaHoop:\n>   If Tor is broken then everyone's protection is gone just as if they are using the clearnet. Everyone no matter the threat model would be completely hosed.\n\nDefine completely hosed. Your threat model seems to be, 'once\ndeanonymized = literally imprisoned or dead'. That may be true for some\npeople, but certainly not the majority or all.\n\nLet's say there is a scale of 0 to 10 of priority where 10 is the\nhighest priority. And where you cannot have the same priority for\neverything for practical reasons. For example, personal preferences\ncould be something like this:\n\n6) prevent compromise of location privacy [Whonix-Gateway]\n7) prevent compromise of bank VM\n8) prevent compromise of vault VM\n9) prevent compromise of host / hardware\n10) prevent compromise of air gapped system\n\nNow, by making it easier to to break priorities 7 to 10, in case\npriority 6 was compromised, seems like a sellout to me.\n\nGranted, there are certainly people who assign highest priority '10)\nloss of anonymity'.\n\nThe ability to have Whonix-Gateway running after prolonged suspend is a\nusability feature that also needs its priority assigned.\n\nThe conflicting priorities here are, out of the box usability vs\ndisaster containment.\n\n>   > Then you would at least have bootclockrandomization before Tor connects.\n>   \n>   OK Good. Please adjust the pv_clock function to check on ws only because I want to enable kvmclock on the gw.\n\nWhat I wrote was not good, unfortunately.\n\nPatrick:\n>>> using just kvmclock after suspend contradicts the reason for running\nsdwdate on the gateway in the first place\n\nHulaHoop:\n>> Not necessarily because the gw clock will honor the time set by\nsdwdate. The current time supplied by kvmclock is also no different\nthan what would happen when I restart the gateway now so it updates\nits clock for Tor to work.\n\nPatrick:\n> Then you would at least have bootclockrandomization before Tor connects.\n\nTo specify what I meant...\n\nWhen gateway boots -> bootclockrandomization -> Tor connects with time\ndifferent from the host\n\nOn resume -> kvmclock sets time to host time -> Tor connects with same\ntime as the host\n\nThat's what I meant by \"Then you would at least have\nbootclockrandomization before Tor connects.\". I.e. \"after boot, you\nwould at least have bootclockrandomization before Tor connects. This was\nto illustrate that this would not be the case on resume -> kvmclock.\nThen Tor would connect with plain host time. (And a compromised gateway\nwould have always access to the exact host time.)\n\n>   > You could say, no longer required, because there are no more local clock leaks.\n>   \n>   Thats right and I would be willing to revisit this should evidence otherwise arise but thats unlikey because all the papers covering this point to things that have been handled already for the protocols in question on the gw.\n\nCreated T458 for it."},{"author":"HulaHoop","date_created":1450734646,"date_modified":1450734646,"content":"> Define completely hosed. \n\nIf they are  sitting on the gw they can see a lot more than the time shown by the vm clock, which does not leak to the network otherwise.***** At that point, knowing what the host time is is no longer important when they can see everything.\n\n\n\nI am not speaking about consequences that will happen to different people depending on what they do.\n\nI feel this topic has become a bikeshed argument detracting attention from more important things. I understand your intentions are good but blocking a simple change that will improve usability a lot is not something I agree with especially when you don't use this particular port yourself everyday.\n\n\n*****I would like to test the apt traffic with tshark to assure you.\n"},{"author":"Patrick","date_created":1450735220,"date_modified":1450735220,"content":"What are the other things they can see? Especially which ones aid to\nbreak out to the host? I guess we need a list on that also.\n\nI admit there is a lot love put in the details here. I just don't want\nany details be lost. Certainly something worth pointing out in advanced\nsecurity.\n\nThe final decision in this case is up to you.\n\nI'll make the changes in whonixcheck."},{"author":"Patrick","date_created":1450735574,"date_modified":1450735574,"content":"https://github.com/Whonix/whonixcheck/commit/88ce7981e57b564aef421aebdbd3e7174c7517c8\n\n(Untested. But likely working. To test this, emulate these changes or install latest whonixcheck from git master. [all git commits are signed])"},{"author":"Patrick","date_created":1450747908,"date_modified":1450747908,"content":"https://github.com/Whonix/whonix-libvirt/pull/24\n\nThis also needs to be mentioned in the Whonix 13 releases notes so users can update their existing libvirt xml files."},{"author":"Patrick","date_created":1461790132,"date_modified":1461790132,"content":"Related:\nSeamless Time-sync after Suspend-Resume has been implemented for Qubes-Whonix 13.\nhttps://github.com/QubesOS/qubes-issues/issues/1764"},{"author":"Patrick","date_created":1471982000,"date_modified":1471982000,"content":"What is the status of this? @HulaHoop "}]},"PHID-TASK-oq6klgo5xhqcx2ltvzwl":{"id":"384","title":"disable qubes.SetDateTime / qubes.SyncNtpClock in Qubes-Whonix VMs","status":"resolved","priority":"High","author":"Patrick","description":"Interferes with the rationale of https://www.whonix.org/wiki/Dev/TimeSync.","comments":[{"author":"Patrick","date_created":1438793312,"date_modified":1438793312,"content":"Can you please give directions on how to do this? @marmarek"},{"author":"marmarek","date_created":1438795083,"date_modified":1438795083,"content":"The easiest way is to remove ntpdate package. This will prevent\nqubes.SyncNtpClock from working. We probably need to document it\nsomewhere (that Whonix-based VMs do not work as ClockVM, yet).\n\nLater we may want to introduce alternative implementation[1], or some\nplugin-based approach.\n\n[1]\nhttps://github.com/QubesOS/qubes-issues/issues/1102#issuecomment-128076754"},{"author":"Patrick","date_created":1438827671,"date_modified":1438827671,"content":"Alright. For better understanding... I would be interested... Which script [in dom0?] dispatches qubes.SyncNtpClock? How is the hook defined/called inside VMs?"},{"author":"marmarek","date_created":1438827963,"date_modified":1438827963,"content":"Dom0: `/usr/bin/qvm-sunc-clock`. Called from cron in dom0 every 6\nminutes..\n\nVM: `/etc/qubes-rpc/qubes.SyncNtpClock` ->\n`/usr/lib/qubes/sync-ntp-clock`"},{"author":"Patrick","date_created":1438863566,"date_modified":1438863566,"content":"dom0's `/usr/bin/qvm-sync-clock` dispatches:\n* ClockVMs `/etc/qubes-rpc/qubes.SyncNtpClock`\n* other VMs `/etc/qubes-rpc/qubes.SetDateTime`\n"},{"author":"Patrick","date_created":1438865940,"date_modified":1438865940,"content":"(1) So I conclude, as a first step, we need to move `/etc/qubes-rpc/qubes.SetDateTime` (which is a script) out of the way. This can be done using config-package-dev displace or hide. Easy.\n\n(2) As a second step, we also do not want dom0 telling Qubes-Whonix VMs the time. Because in case of a compromised Whonix VM, we do not want the adversary replace/restore that script. We need to stop `dom0's /usr/bin/qvm-sync-clock` from running that hook for Qubes-Whonix VMs. Apparently not easy. How can we do that?\n\n* Patch build process: Qubes-Whonix VMs get a special setting \"no_qubes_set_date_time=true\" or so during build.\n* Patch dom0 `/usr/bin/qvm-sync-clock`: When \"no_qubes_set_date_time=true\", don't run the `qubes.SetDateTime` hook.\n\nOr do you have a simpler way in mind?"},{"author":"marmarek","date_created":1438871983,"date_modified":1438871983,"content":"> - Patch build process: Qubes-Whonix VMs get a special setting \"no_qubes_set_date_time=true\" or so during build.\n\nI think rather we should use mgmt stack for that. One day we'll have\nsingle file with all the settings for Whonix. This would be much better\nthan the current installation method, which requires a lot of manual\nconfiguration.\n\n> - Patch dom0 `/usr/bin/qvm-sync-clock`: When \"no_qubes_set_date_time=true\", don't run the `qubes.SetDateTime` hook.\n> \n> Or do you have a simpler way in mind?\n\nI think something like this would work. I'd use qvm-service framework\nfor that instead of new custom setting. But that's just method of\nstoring such setting."},{"author":"Patrick","date_created":1438874324,"date_modified":1438874324,"content":"Would mgmt be capable to keep this setting applied for custom created\nnew Whonix VMs based on Qubes-Whonix templates?"},{"author":"marmarek","date_created":1438883540,"date_modified":1438883540,"content":"> Would mgmt be capable to keep this setting applied for custom created\n> new Whonix VMs based on Qubes-Whonix templates?\n\nThis is rather question to @nrgaway, but I think yes."},{"author":"nrgaway","date_created":1438964596,"date_modified":1438966337,"content":""},{"author":"nrgaway","date_created":1438966356,"date_modified":1438966356,"content":"I am pretty sure that is a yes too :)"},{"author":"Patrick","date_created":1439690181,"date_modified":1439690181,"content":">>! In T384#6263, @Patrick wrote:\n> (1) So I conclude, as a first step, we need to move `/etc/qubes-rpc/qubes.SetDateTime` (which is a script) out of the way. This can be done using config-package-dev displace or hide. Easy.\n\n(1) was implemented.\n\n`disabled qubes.SetDateTime ( we do not want dom0 to sync Qubes-Whonix VMs time as it interferes with Whonix's network time synchronization - https://phabricator.whonix.org/T384 ) and disabled qubes.SyncNtpClock ( Qubes-Whonix VMs can be used as a ClockVM yet - https://phabricator.whonix.org/T387 )`:\nhttps://github.com/Whonix/qubes-whonix/commit/90e8d65230d3c13823af56b91eb2f48eeaad49b4\n\nI would appreciate a theoretic review. If these two stopgap replacement scripts are sane, because those `exit 1`.\n\n* https://github.com/Whonix/qubes-whonix/blob/master/etc/qubes-rpc/qubes.SetDateTime.anondist\n* https://github.com/Whonix/qubes-whonix/blob/master/etc/qubes-rpc/qubes.SyncNtpClock.anondist\n\nIs that okay or do you foresee issues with that?\n\n>>! In T384#6263, @Patrick wrote:\n> (2) As a second step, we also do not want dom0 telling Qubes-Whonix VMs the time. Because in case of a compromised Whonix VM, we do not want the adversary replace/restore that script. We need to stop `dom0's /usr/bin/qvm-sync-clock` from running that hook for Qubes-Whonix VMs.\n\nCreated `prevent dom0 telling Qubes-Whonix VMs the time` T397 for it."},{"author":"marmarek","date_created":1440557785,"date_modified":1440557785,"content":"Looks good."},{"author":"Patrick","date_created":1461260968,"date_modified":1461260968,"content":"Perhaps the `echo` and `exit 1` in qubes-rpc scripts is not sane and should be removed? @marmarek \n\n```\nsudo cat /var/log/syslog | grep -i 'qubes\\.'\n```\n\n```\nApr 20 03:50:45 host kernel: [    0.000000] Linux version 4.1.13-9.pvops.qubes.x86_64 (user@release) (gcc version 4.8.3 20140911 (Red Hat 4.8.3-7) (GCC) ) #1 SMP Thu Feb 11 15:46:02 UTC 2016\nApr 20 03:50:45 host kernel: [    2.392996] usb usb1: Manufacturer: Linux 4.1.13-9.pvops.qubes.x86_64 dummy_hcd\nApr 20 03:50:46 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetAppmenus dom0 pid 590\nApr 20 03:50:46 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 667\nApr 20 03:50:47 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 730\nApr 20 03:50:47 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 795\nApr 20 03:50:47 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 858\nApr 20 03:50:48 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 909\nApr 20 03:50:48 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 972\nApr 20 03:50:48 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1034\nApr 20 03:50:48 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1096\nApr 20 03:50:48 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1159\nApr 20 03:50:48 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1221\nApr 20 03:50:49 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1283\nApr 20 03:50:49 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1354\nApr 20 03:50:49 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1418\nApr 20 03:50:49 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1481\nApr 20 03:50:49 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1544\nApr 20 03:50:50 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1607\nApr 20 03:50:50 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1669\nApr 20 03:50:50 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1732\nApr 20 03:50:50 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1795\nApr 20 03:50:50 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1859\nApr 20 03:50:51 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1922\nApr 20 03:50:51 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 1984\nApr 20 03:50:51 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2049\nApr 20 03:50:51 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2112\nApr 20 03:50:51 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2174\nApr 20 03:50:51 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2237\nApr 20 03:50:52 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2299\nApr 20 03:50:52 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2361\nApr 20 03:50:52 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2424\nApr 20 03:50:52 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2486\nApr 20 03:50:52 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2551\nApr 20 03:50:52 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2614\nApr 20 03:50:53 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2677\nApr 20 03:50:53 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2740\nApr 20 03:50:53 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2803\nApr 20 03:50:53 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2865\nApr 20 03:50:53 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2927\nApr 20 03:50:53 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 2990\nApr 20 03:50:54 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 3055\nApr 20 03:50:54 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 3123\nApr 20 03:50:54 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 3185\nApr 20 03:50:54 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 3250\nApr 20 03:50:54 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 3313\nApr 20 03:50:55 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 3376\nApr 20 03:50:55 host qrexec-agent[496]: executed user:QUBESRPC qubes.GetImageRGBA dom0 pid 3439\nApr 21 01:18:51 host kernel: [    0.000000] Linux version 4.1.13-9.pvops.qubes.x86_64 (user@release) (gcc version 4.8.3 20140911 (Red Hat 4.8.3-7) (GCC) ) #1 SMP Thu Feb 11 15:46:02 UTC 2016\nApr 21 01:18:51 host kernel: [    2.112275] usb usb1: Manufacturer: Linux 4.1.13-9.pvops.qubes.x86_64 dummy_hcd\nApr 21 01:18:51 host qrexec-agent[530]: executed user:QUBESRPC qubes.SetMonitorLayout dom0 pid 745\nApr 21 01:18:52 host qrexec-agent[530]: executed root:QUBESRPC qubes.WaitForSession none pid 753\nApr 21 01:22:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 1018\nApr 21 01:22:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 01:28:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 1086\nApr 21 01:28:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 01:34:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 1914\nApr 21 01:34:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 01:40:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 1966\nApr 21 01:40:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 01:46:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 4657\nApr 21 01:46:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 01:52:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 7844\nApr 21 01:52:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 01:58:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 7898\nApr 21 01:58:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 02:04:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 7951\nApr 21 02:04:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 02:10:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8003\nApr 21 02:10:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 02:16:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8057\nApr 21 02:16:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 02:22:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8109\nApr 21 02:22:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 02:28:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8164\nApr 21 02:28:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 02:34:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8217\nApr 21 02:34:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 02:40:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8271\nApr 21 02:40:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 02:46:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8324\nApr 21 02:46:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 02:52:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8376\nApr 21 02:52:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 02:58:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8430\nApr 21 02:58:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 03:04:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8485\nApr 21 03:04:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 03:10:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8539\nApr 21 03:10:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 03:16:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8593\nApr 21 03:16:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 03:22:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8646\nApr 21 03:22:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 03:28:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8699\nApr 21 03:28:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 03:34:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8752\nApr 21 03:34:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 03:40:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8805\nApr 21 03:40:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 03:46:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8858\nApr 21 03:46:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 03:52:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8911\nApr 21 03:52:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 03:58:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8966\nApr 21 03:58:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 04:04:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9019\nApr 21 04:04:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 04:10:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9070\nApr 21 04:10:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 04:16:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9125\nApr 21 04:16:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 04:22:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9177\nApr 21 04:22:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 04:28:12 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9230\nApr 21 04:28:12 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 04:34:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9284\nApr 21 04:34:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 04:40:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9337\nApr 21 04:40:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 04:46:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9391\nApr 21 04:46:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 04:52:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9443\nApr 21 04:52:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 04:58:25 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9498\nApr 21 04:58:25 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 05:04:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9551\nApr 21 05:04:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 05:10:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9604\nApr 21 05:10:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 05:16:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9658\nApr 21 05:16:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 05:22:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9771\nApr 21 05:22:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 05:28:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9825\nApr 21 05:28:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 05:34:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9878\nApr 21 05:34:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 05:40:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9930\nApr 21 05:40:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 05:46:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 9984\nApr 21 05:46:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 05:52:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10037\nApr 21 05:52:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 05:58:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10090\nApr 21 05:58:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 06:04:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10144\nApr 21 06:04:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 06:10:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10197\nApr 21 06:10:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 06:16:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10251\nApr 21 06:16:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 06:22:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10303\nApr 21 06:22:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 06:28:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10356\nApr 21 06:28:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 06:34:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10410\nApr 21 06:34:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 06:40:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10463\nApr 21 06:40:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 06:46:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10517\nApr 21 06:46:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 06:52:11 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10569\nApr 21 06:52:11 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 06:58:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10622\nApr 21 06:58:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 07:04:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10676\nApr 21 07:04:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 07:10:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10729\nApr 21 07:10:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 07:16:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10783\nApr 21 07:16:11 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 07:22:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10836\nApr 21 07:22:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 07:28:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10889\nApr 21 07:28:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 07:34:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10943\nApr 21 07:34:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 07:40:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 10995\nApr 21 07:40:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 07:46:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11050\nApr 21 07:46:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 07:52:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11103\nApr 21 07:52:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 07:58:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11157\nApr 21 07:58:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 08:04:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11212\nApr 21 08:04:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 08:10:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11265\nApr 21 08:10:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 08:16:14 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11320\nApr 21 08:16:14 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 08:22:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11372\nApr 21 08:22:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 08:28:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11427\nApr 21 08:28:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 08:34:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11480\nApr 21 08:34:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 08:40:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11532\nApr 21 08:40:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 08:46:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11586\nApr 21 08:46:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 08:52:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11639\nApr 21 08:52:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 08:58:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11692\nApr 21 08:58:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 09:04:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11747\nApr 21 09:04:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 09:10:11 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11800\nApr 21 09:10:11 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 09:16:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11853\nApr 21 09:16:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 09:22:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11906\nApr 21 09:22:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 09:28:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11960\nApr 21 09:28:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 09:34:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12014\nApr 21 09:34:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 09:40:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12066\nApr 21 09:40:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 09:46:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12120\nApr 21 09:46:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 09:52:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12172\nApr 21 09:52:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 09:58:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12225\nApr 21 09:58:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 10:04:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12281\nApr 21 10:04:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 10:10:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12334\nApr 21 10:10:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 10:16:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12388\nApr 21 10:16:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 10:22:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12441\nApr 21 10:22:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 10:28:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12495\nApr 21 10:28:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 10:34:11 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12548\nApr 21 10:34:12 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 10:40:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12602\nApr 21 10:40:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 10:46:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12654\nApr 21 10:46:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 10:52:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12707\nApr 21 10:52:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 10:58:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12760\nApr 21 10:58:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 11:04:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12814\nApr 21 11:04:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 11:10:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12867\nApr 21 11:10:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 11:16:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12920\nApr 21 11:16:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 11:22:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12973\nApr 21 11:22:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 11:28:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13026\nApr 21 11:28:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 11:34:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13079\nApr 21 11:34:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 11:40:12 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13131\nApr 21 11:40:12 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 11:46:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13186\nApr 21 11:46:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 11:52:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13240\nApr 21 11:52:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 11:58:11 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13294\nApr 21 11:58:11 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 12:04:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13348\nApr 21 12:04:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 12:10:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13400\nApr 21 12:10:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 12:16:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13454\nApr 21 12:16:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 12:22:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13507\nApr 21 12:22:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 12:28:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13562\nApr 21 12:28:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 12:34:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13616\nApr 21 12:34:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 12:40:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13669\nApr 21 12:40:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 12:46:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13723\nApr 21 12:46:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 12:52:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13775\nApr 21 12:52:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 12:58:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13829\nApr 21 12:58:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 13:04:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13884\nApr 21 13:04:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 13:10:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13936\nApr 21 13:10:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 13:16:11 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 13988\nApr 21 13:16:11 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 13:22:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 14041\nApr 21 13:22:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 13:28:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 14095\nApr 21 13:28:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 13:34:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 14149\nApr 21 13:34:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 13:40:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 14203\nApr 21 13:40:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 13:46:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 14256\nApr 21 13:46:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 13:52:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 14308\nApr 21 13:52:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 13:58:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 14363\nApr 21 13:58:09 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 14:04:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 14488\nApr 21 14:04:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 14:10:09 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 14540\nApr 21 14:10:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 14:16:10 host qrexec-agent[530]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 14594\nApr 21 14:16:10 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 16:11:01 host kernel: [    0.000000] Linux version 4.1.13-9.pvops.qubes.x86_64 (user@release) (gcc version 4.8.3 20140911 (Red Hat 4.8.3-7) (GCC) ) #1 SMP Thu Feb 11 15:46:02 UTC 2016\nApr 21 16:11:01 host kernel: [    2.270600] usb usb1: Manufacturer: Linux 4.1.13-9.pvops.qubes.x86_64 dummy_hcd\nApr 21 16:11:02 host qrexec-agent[539]: executed user:QUBESRPC qubes.SetMonitorLayout dom0 pid 779\nApr 21 16:11:02 host qrexec-agent[539]: executed root:QUBESRPC qubes.WaitForSession none pid 780\nApr 21 16:14:22 host qrexec-agent[539]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 4434\nApr 21 16:14:22 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 16:20:22 host qrexec-agent[539]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 8909\nApr 21 16:20:22 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 16:26:22 host qrexec-agent[539]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11445\nApr 21 16:26:22 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 16:32:22 host qrexec-agent[539]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11497\nApr 21 16:32:22 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 16:38:21 host qrexec-agent[539]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 11552\nApr 21 16:38:21 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 16:44:21 host qrexec-agent[539]: executed root:QUBESRPC qubes.SetDateTime dom0 pid 12309\nApr 21 16:44:22 host qubes.SetDateTime-dom0: We do not want dom0 to tell us the time.\nApr 21 17:42:51 host kernel: [    0.000000] Linux version 4.1.13-9.pvops.qubes.x86_64 (user@release) (gcc version 4.8.3 20140911 (Red Hat 4.8.3-7) (GCC) ) #1 SMP Thu Feb 11 15:46:02 UTC 2016\nApr 21 17:42:51 host kernel: [    1.850229] usb usb1: Manufacturer: Linux 4.1.13-9.pvops.qubes.x86_64 dummy_hcd\nApr 21 17:42:52 host qrexec-agent[533]: executed user:QUBESRPC qubes.SetMonitorLayout dom0 pid 968\nApr 21 17:42:52 host qrexec-agent[533]: executed root:QUBESRPC qubes.WaitForSession none pid 1015\nApr 21 17:46:16 host kernel: [    0.000000] Linux version 4.1.13-9.pvops.qubes.x86_64 (user@release) (gcc version 4.8.3 20140911 (Red Hat 4.8.3-7) (GCC) ) #1 SMP Thu Feb 11 15:46:02 UTC 2016\nApr 21 17:46:16 host kernel: [    1.850871] usb usb1: Manufacturer: Linux 4.1.13-9.pvops.qubes.x86_64 dummy_hcd\nApr 21 17:46:18 host qrexec-agent[559]: executed user:QUBESRPC qubes.SetMonitorLayout dom0 pid 1378\nApr 21 17:46:18 host qrexec-agent[559]: executed root:QUBESRPC qubes.WaitForSession none pid 1396\n```\n"},{"author":"Patrick","date_created":1461613486,"date_modified":1461613486,"content":"https://github.com/Whonix/qubes-whonix/commit/a738a685c911a816ea4bf9c0ee090edb777ef9e1"}]},"PHID-TASK-2645u7pj52vcu5gvyfme":{"id":"383","title":"make sure systemd-timesyncd / timedatectl does not run","status":"wontfix","priority":"Normal","author":"Patrick","description":"After running.\n\n```\ntimedatectl set-ntp 1\n```\n\nThe following link will be created:\n\n`/etc/systemd/system/sysinit.target.wants/systemd-timesyncd.service` -> `/lib/systemd/system/systemd-timesyncd.service`\n\n```\ncat /lib/systemd/system/systemd-timesyncd.service\n```\n\n```\nsudo service systemd-timesyncd status\n```\n\nDebian does not enable systemd-timesyncd by default yet. (Related to T382.)\n\nWe could ship a systemd drop-in file to prevent start of systemd-timesyncd even if it was enabled.\n\n`/lib/systemd/system/systemd-timesyncd.service.d/40_disable.conf` (untested, but doable)\n\n```\n## This file is part of Whonix.\n## Copyright (C) 2012 - 2015 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\n[Unit]\nConditionPathExists=!/usr/share/whonix\n```\n\n(Or some more clever, better configurable condition.)\n\nInto which package would this belong? Not into sdwdate, because packages are not supposed to break other packages if deliberately installed at the same time by the system administrator. [Would make the page unfit for inclusion into official Debian.] [Or at least this would have to be carefully crafted using `Breaks:` or some mechanism of that kind.]\n\nHow useful is it to preemptively disable services the user or distribution could enable at some point?\n\nIn Whonix 12's whonixcheck we will have a sanity check anyway. (T332)\n\nOn the other hand, we have the anon-banned-package, which bans [a few](https://github.com/Whonix/anon-meta-packages/blob/df6f00b3804e3d1b17fb69c0a3879be8d0d38ae8/debian/control#L326-339) packages. How useful would it be to expand this? Would we then need to add ntp, chrony, tlsdate also? How realistic and useful is it to preemptively preventing users being up to such things from doing this?\n\nAt the moment I tend to believe, it's best to not over engineer this. Make sure such stuff is tested for, not part of images and part of unit testing.","comments":[{"author":"HulaHoop","date_created":1438106632,"date_modified":1438106632,"content":"If you think pre-empting is too much lets focus only on dangerous\npackages we know Debian ship with a base install. We cannot hope to\nanticipate/block everything a user can run on the host that potentially\nleaks time. We can only give opsec advice that advanced user can keep in\nmind in high risk situations.\n\nanon-banned package is the best place for this."},{"author":"Patrick","date_created":1438107295,"date_modified":1438107295,"content":"Alright. Please open tickets as appropriate for specific suggestions.\n"}]},"PHID-TASK-k7qzv3xxqkcj35j255co":{"id":"382","title":"timedatectl Debian Upstream Discussion","status":"resolved","priority":"Normal","author":"HulaHoop","description":"I asked Debian upstream maintainers of systemd to not enable timedatectl:\n\nhttps://lists.alioth.debian.org/pipermail/pkg-systemd-maintainers/2015-July/008323.html","comments":[{"author":"Patrick","date_created":1437997355,"date_modified":1437997355,"content":"I am not concerned about this. Maybe the ntp package migrated sysvinit\nto systemd. Maybe not. Does not matter for Whonix, because we do not\ninstall the ntp package. If Debian decided to no longer install ntp by\ndefault, but to ship a systemd unit file enabling timedatectl by\ndefault, we then would just ship a systemd drop-in file to disable it in\nWhonix. I doubt that Debian will/will not do this change because of\nderivatives, because those are free to reconfigure things."},{"author":"HulaHoop","date_created":1438002051,"date_modified":1438002051,"content":" >I doubt that Debian will/will not do this change because of\nderivatives, because those are free to reconfigure things.\n\nUnderstood.\n\nI wanted better privacy decisions to go upstream but there is nothing stopping us from making the changes to our systems."},{"author":"Patrick","date_created":1439587249,"date_modified":1439587249,"content":"I guess nothing more can be done here."}]},"PHID-TASK-2qda5qpopnmuvpqujovz":{"id":"381","title":"Seamless Clock Adjustment on Whonix Gateway after Suspend-Resume","status":"invalid","priority":"Normal","author":"HulaHoop","description":"Facts:\n\n*qemu-guest-agent achieves successful clock syncing of a guest upon host system resume and does not attempt to constantly adjust the clock.\n\n\n*kvmclock can only sync time during guest startup not during its lifetime:\nhttps://serverfault.com/a/334734\n\n*kvmclock used to sync time after suspend but no longer applies (this\nexplains my experiences before):\nhttp://thread.gmane.org/gmane.comp.emulators.libvirt/92431\n\n*qemu-guest agent is a solution but unsafe if used in untrusted guests, but is ok for Whonix-Gateway because its trusted:\nhttps://serverfault.com/a/635273\nhttp://wiki.qemu.org/Features/QAPI/GuestAgent\n\n*Its not safe because it relies on Javascript code parser thats still not\nhardened enough to run in hostile guest environments. It has to be enabled on the host by\nadding a qemu-guest agent channel for it to work - without this it has\nno effect and no security implications.\n\n*using qemu-guest-agent is currently stalled because of permissions problems on Jessie. Apparmor workarounds not recommended, could be harmful to security:\nhttps://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/1393842\n\n*To have the same functionality for VirtualBox the resume hooks in Guest Additions will be used.\n\n***\n\nThere is a Debian package:\nhttps://packages.debian.org/jessie/qemu-guest-agent\n\nWe could add it as a weak dependency, below here:\nhttps://github.com/Whonix/Whonix/blob/979c4393bd5e2d6ae20c690e39bb377d6244809e/build-steps.d/1700_install-packages#L405\n\nSimilar to this commit:\nhttps://github.com/Whonix/Whonix/commit/979c4393bd5e2d6ae20c690e39bb377d6244809e\n\n***\n\nRejected Solution:\n\nUsing Tordate as a coarse clock setting mechanism for Whonix-Gateway for Tor to connect.\n\nIt's fingerprintable. (All info/link/quotes on that [wiki page](https://www.whonix.org/wiki/Dev/TimeSync#Tor_Consensus_Method).)\n(Could be tied directly to Tails or Whonix. Unrelated from local clock leaks.)","comments":[{"author":"Patrick","date_created":1438006074,"date_modified":1438006074,"content":"When do you want to do this? Does this require Debian stretch first?\n\n> *qemu-guest agent is a solution but unsafe if used in untrusted guests, but is ok for Whonix-Gateway because its trusted:\n\n> *Its not safe because it relies on Javascript code parser thats still not\n> hardened enough to run in hostile guest environments. It has to be enabled on the host by\n> adding a qemu-guest agent channel for it to work - without this it has\n> no effect and no security implications.\n\nSo, can you enable this for Whonix-Gateway only? I guess it will need some libvirt XML changes in #whonix-libvirt? Something else?\n\nWhere is the documentation for the hooks? By hook I mean, that /path/to/some/script gets executed by the hypervisor upon resume. The script would be located inside the VM. Or does this require to add scripts to the host that then run some code within the VM?"},{"author":"Patrick","date_created":1438006558,"date_modified":1438006558,"content":"Is it possible for a (Qubes) VM to be notified (pre or) post suspend? (Refering to Qubes VM Manger, Pause VM feature.) @marmarek\n\nThe use case here would be to dispatch (a) script(s) when that happens (post-suspend, i.e. after resume)."},{"author":"HulaHoop","date_created":1438027807,"date_modified":1438028475,"content":">So, can you enable this for Whonix-Gateway only? I guess it will need some libvirt XML changes in whonix-libvirt? Something else?\n\nYes I can. When upstream is ready an on_resume tag is needed in the xml too, more below.\n\n>Where is the documentation for the hooks? By hook I mean, that /path/to/some/script gets executed by the hypervisor upon resume. The script would be located inside the VM. Or does this require to add scripts to the host that then run some code within the VM?\n\nNo official documentation yet, mostly mail list patches and discussions. No scripts of any kind will be needed just: qemu-channel for GW, on_resume flag in GW xml, qemu-guest-agent inside guest. That's it.\n\nBy Debian Stretch, libvirt upstream should have added an <on_resume> xml option to automatically trigger guest time syncing on resume. Also the Apparmor problem should hopefully be fixed. I tested and its only an Apparmor problem and not missing directories/permissions thing. Setting GW to aa-complain lets it start with guest-agent channel with no errors. You can add the support now if its simple enough or just wait because there is no rush to roll this out now when workarounds and manual interaction are needed.\n\nAt the moment its manual:\n\n\n[1]\n\nCreate the missing directories and change group permissions. note this will be necessary unless you reinstall the package in the future as the package update doesn't create the directory:\n\n\n>sudo mkdir -p /var/lib/libvirt/qemu/channel/target\n>sudo chown -R libvirt-qemu:kvm /var/lib/libvirt/qemu/channel\n\n\n[2]\n\nInstall apparmor-utils:\n\n>sudo apt-get install apparmor-utils\n\n\nMake sure only Whonix-Gateway is running and find out its profile name:\n\n>sudo apparmor_status\n\nSet the profile to complain mode. Note that its safe because the Gateway is trusted:\n\n>sudo aa-complain /etc/apparmor.d/libvirt/libvirt-73aa79f1-0023-4e37-8001-5be78e88434 (for example)\n\n\nThe vm should start normally now.\n\n[3] [5]\n\n\n>guest]sudo apt-get install qemu-guest-agent\n>guest]sudo systemctl start qemu-guest-agent.service\n>host ]sudo virsh domtime Whonix-Gateway --now\n\n***\n\nLibvirt upstream plans: [4]\n\n>This is still a frequently-requested issue on upstream lists; qemu 2.0 made it possible for the guest-agent to do guest-set-time without arguments to have the guest re-read the hardware clock and adjust software time from that, and qemu 2.1 is adding rtc-reset-reinjection to tell qemu when the agent has been used to force guest time and therefore qemu no longer needs to slew clock interrupts.  Libvirt 1.2.5 added a virDomainSetTime API to trigger the guest agent command, and future libvirt versions may add a flag to that API to also trigger the rtc-reset-reinjection followup.  There is also an idea of adding an <on_resume> action to the domain XML of libvirt to allow libvirt to automatically trigger time reset on resume (it can't be on by default, because it requires guest interaction which is only safe if the guest is trusted; but could be explicitly enabled by management as needed).  Of course, as this is still under active work upstream, there is no telling how soon it can be backported downstream, or even if such a backport is feasible without a rebase.\n\n***\n[1] https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/1393842/comments/2\n[2] https://bugs.launchpad.net/ubuntu/+source/libvirt/+bug/1407434/comments/6\n[3] https://bugzilla.redhat.com/show_bug.cgi?id=1156280#c25\n[4] https://bugzilla.redhat.com/show_bug.cgi?id=821988#c7\n[5] https://bugzilla.redhat.com/show_bug.cgi?id=1211938#c0\n"},{"author":"Patrick","date_created":1438030575,"date_modified":1438030575,"content":"But this won't restart `sdwdate`?"},{"author":"HulaHoop","date_created":1438033462,"date_modified":1438033462,"content":"It depends. Is it possible to trigger sdwdate upon detecting a clock jump on GW? This will need additions to the sdwdate code in the guest of course.\n\nAnother far-fetched idea is to have some type of unidirectional signal being sent from GW to WS to (safely) trigger timesync on the WS too without manual intervention there. These events follow from the actions above.\n\nThe main idea behind the ticket is for setting an acceptable time so Tor can even connect, but there is no reason it can't be developed more.\n\n"},{"author":"marmarek","date_created":1438033646,"date_modified":1438033646,"content":"First of all we don't have qemu in Qubes.\n\nBut we have qrexec services triggered on suspend/resume. Few of them:\n- qubes.SuspendPre - pre suspend\n- qubes.SuspendPost - post resume\n- qubes.SetDateTime - after resume and every 6 minutes\n\nThe first two currently are called only for VMs with PCI devices (to\ntear down devices before suspend). The last one is called in every VM\nwith current timestamp in format of `date -Iseconds` at stdin - exactly\nfor this purpose - to synchronize time.\nAFAIR Whonix does not want to use the last method (perhaps it should be\nblocked somehow?). But that mechanism can be repurposed to call swdate.\nOr we can enable qubes.SuspendPre and qubes.SuspendPost for every VM.\n\nThere is also fourth service: qubes.SyncNtpClock, which is called in\nselected VM (aka ClockVM) to synchronize time with \"outside world\".\nLater time from this VM is used to synchronize time in dom0 and every\nother VM (using said qubes.SetDateTime). Perhaps when using Whonix it\nshould be advised to set Whonix gateway as ClockVM, which would use\nswdate in qubes.SyncNtpClock service?"},{"author":"Patrick","date_created":1438092289,"date_modified":1438092289,"content":">>! In T381#6095, @HulaHoop wrote:\n> It depends. Is it possible to trigger sdwdate upon detecting a clock jump on GW? This will need additions to the sdwdate code in the guest of course.\n\nMaybe. A script that writes down the current unixtime every 10 seconds. Then compares those. If the difference is bigger than let's say 60 or so, likely a clock jump occurred. (Or the user just manually adjusted the clock.) And sdwdate would have to prevent noticing the clock jumps it causes itself (when setting time using date instead of sclockadj). Might be doable. But sounds like an unclean solution, awful hack to me.\n \n> Another far-fetched idea is to have some type of unidirectional signal being sent from GW to WS to (safely) trigger timesync on the WS too without manual intervention there. These events follow from the actions above.\n\nWould probably be only required for KVM due to the host security problem. Having a service listening just for that... I don't know. Perhaps KVM images should be separate builds then.\n \n> The main idea behind the ticket is for setting an acceptable time so Tor can even connect, but there is no reason it can't be developed more.\n\nWhat you're suggesting at the moment (virsh domtime) would directly conflict with sdwdate. KVM would set the clock to the host's clock (what we don't want - or not -> different discussion) and sdwdate's sclockadj might still be running unaffected by this. Not good."},{"author":"Patrick","date_created":1438093460,"date_modified":1438093460,"content":"Wondering, if there are virtualizer unspecific hooks.\n`virtualizer (Xen) unspecific hooks pre-suspend / post-suspend? pm-utils?`:\nhttps://groups.google.com/forum/#!topic/qubes-devel/Idct7OthKc0\n"},{"author":"Patrick","date_created":1438096552,"date_modified":1438096552,"content":">>! In T381#6096, @marmarek wrote:\n> But we have qrexec services triggered on suspend/resume. Few of them:\n> - qubes.SuspendPre - pre suspend\n> - qubes.SuspendPost - post resume\n> - qubes.SetDateTime - after resume and every 6 minutes\n> \n> The first two currently are called only for VMs with PCI devices (to\n> tear down devices before suspend).\n\n> The last one is called in every VM\n> with current timestamp in format of `date -Iseconds` at stdin - exactly\n> for this purpose - to synchronize time.\n> AFAIR Whonix does not want to use the last method (perhaps it should be\n> blocked somehow?).\n\nYes. That is a security issue. Created T384 for it.\n\n> But that mechanism can be repurposed to call sdwdate.\n\nI think for now \"after resume and every 6 minutes\" (qubes.SetDateTime) doesn't play well together with sdwdate. It keeps running after boot. Just a notification after resume is required.\n\n> > Or we can enable qubes.SuspendPre and qubes.SuspendPost for every VM.\n\nYes, unless there aren't any virtualizer agnostic hooks\n(https://groups.google.com/forum/#!topic/qubes-devel/Idct7OthKc0)\nthis would be great.\n \n> There is also fourth service: qubes.SyncNtpClock, which is called in\n> selected VM (aka ClockVM) to synchronize time with \"outside world\".\n> Later time from this VM is used to synchronize time in dom0 and every\n> other VM (using said qubes.SetDateTime). Perhaps when using Whonix it\n> should be advised to set Whonix gateway as ClockVM, which would use\n> swdate in qubes.SyncNtpClock service?\n\nThe design goal is, that the host's [any VMs], Whonix-Gateway and any Whonix-Workstation's clock should slightly differ.\n(Rationale: Prevent adversaries from linking anonymous and pseudonymous activity. Described in more detail on the [Dev/TimeSync](https://www.whonix.org/wiki/Dev/TimeSync) wiki page.)"},{"author":"HulaHoop","date_created":1438109724,"date_modified":1438109923,"content":"> Wondering, if there are virtualizer unspecific hooks.\n\nAlmost certainly no. \n\nThat kind of information sharing between guest and host will always need some hypervisor specific mechanism to happen. For KVM its the guest agent for Qubes implements it as a part of its integration protocol and so on.\n\n> What you're suggesting at the moment (virsh domtime) would directly conflict with sdwdate. KVM would set the clock to the host's clock (what we don't want - or not -> different discussion) and sdwdate's sclockadj might still be running unaffected by this. Not good.\n\nI'm not suggesting that Whonix supports that feature before automatic on-resume time syncing lands in libvirt. The virsh domtime command is manual and the workarounds needed to make this work manually now makes it unpractical to use. I documented it for archive purposes and do not recommend it for now.\n\n> Might be doable. But sounds like an unclean solution, awful hack to me.\n\nOn WS you can have the already running rinetd listening for signals. On GW you can use the cpfpd infrastructure to relay the unidirectional signal out.\n"},{"author":"HulaHoop","date_created":1438110220,"date_modified":1438110220,"content":"If you think the automated signalling to the WS is too ugly then write it off. At the moment timesync needs to be run manually on WS anyway (and works only when GW s connected to Tor)."},{"author":"Patrick","date_created":1438111786,"date_modified":1438111786,"content":"The 'awful hack' statement applied only to what I quoted: sdwdate clock jump detection.\n\nI don't think overloading cpfpy is the right place for adding a gw -> ws command protocol. It's doing one thing well. Such a protocol would require and additional server listening on the ws. That can't be cpfpy, because that's listening on the gw. And this protocol would require something sending commands to the ws from the gw. I hope this can be avoided. Getting this right is difficult. Also because then the ws would also have to authenticate, that commands are really coming from the gateway. (multiple ws's behind the same gw in the same internal network issue for non-Qubes-Whonix ([documented](https://www.whonix.org/wiki/Connections_between_Whonix-Gateway_and_Whonix-Workstation))). If we needed a protocol between gw and ws, I would be inclined to first check if the Qubes specific [qrexec](https://www.qubes-os.org/doc/Qrexec/) would work well for that task."},{"author":"HulaHoop","date_created":1438119639,"date_modified":1438119639,"content":"> The 'awful hack' statement applied only to what I quoted: sdwdate clock jump detection.\n\nI see. Nevermind the rest of the post. I was trying to figure out ways you didn't ask for.\n\n> If we needed a protocol between gw and ws, I would be inclined to first check if the Qubes specific qrexec would work well for that task.\n\nOK but the solution should potentially by hypervisor agnostic."},{"author":"Patrick","date_created":1438122150,"date_modified":1438122150,"content":"Sure. But I already explained why this is [too] difficult."},{"author":"HulaHoop","date_created":1438195564,"date_modified":1438195564,"content":"This ticket is deprecated by https://phabricator.whonix.org/T385\n\nclosing."},{"author":"Patrick","date_created":1438197977,"date_modified":1438197977,"content":">>! In T381#6110, @Patrick wrote:\n>>>! In T381#6096, @marmarek wrote:\n>> There is also fourth service: qubes.SyncNtpClock, which is called in\n>> selected VM (aka ClockVM) to synchronize time with \"outside world\".\n>> Later time from this VM is used to synchronize time in dom0 and every\n>> other VM (using said qubes.SetDateTime). Perhaps when using Whonix it\n>> should be advised to set Whonix gateway as ClockVM, which would use\n>> swdate in qubes.SyncNtpClock service?\n> \n> The design goal is, that the host's [any VMs], Whonix-Gateway and any Whonix-Workstation's clock should slightly differ.\n> (Rationale: Prevent adversaries from linking anonymous and pseudonymous activity. Described in more detail on the [Dev/TimeSync](https://www.whonix.org/wiki/Dev/TimeSync) wiki page.)\n\nI forgot adding, I think therefore Whonix-Gateway should not be the ClockVM for all other VMs. At least not \"directly\".\n\nApart from this... Generally... The idea is good. Reusing Whonix-Gateway and sdwdate. Having the time securely provided by sdwdate. (Since sdwdate depends on Tor, Tor traffic and Tor configuration...) Having a second instance of sdwdate running within Whonix-Gateway that provides time for dom0 and all non-Whonix VMs would be an improvement against time related attacks. Better than NTP. For those who are willing to use Tor."},{"author":"Patrick","date_created":1438261912,"date_modified":1438261912,"content":">>! In T381#6150, @Patrick wrote:\n>>>! In T381#6110, @Patrick wrote:\n>>>>! In T381#6096, @marmarek wrote:\n>>> There is also fourth service: qubes.SyncNtpClock, which is called in\n>>> selected VM (aka ClockVM) to synchronize time with \"outside world\".\n>>> Later time from this VM is used to synchronize time in dom0 and every\n>>> other VM (using said qubes.SetDateTime). Perhaps when using Whonix it\n>>> should be advised to set Whonix gateway as ClockVM, which would use\n>>> swdate in qubes.SyncNtpClock service?\n>> \n>> The design goal is, that the host's [any VMs], Whonix-Gateway and any Whonix-Workstation's clock should slightly differ.\n>> (Rationale: Prevent adversaries from linking anonymous and pseudonymous activity. Described in more detail on the [Dev/TimeSync](https://www.whonix.org/wiki/Dev/TimeSync) wiki page.)\n> \n> I forgot adding, I think therefore Whonix-Gateway should not be the ClockVM for all other VMs. At least not \"directly\".\n> \n> Apart from this... Generally... The idea is good. Reusing Whonix-Gateway and sdwdate. Having the time securely provided by sdwdate. (Since sdwdate depends on Tor, Tor traffic and Tor configuration...) Having a second instance of sdwdate running within Whonix-Gateway that provides time for dom0 and all non-Whonix VMs would be an improvement against time related attacks. Better than NTP. For those who are willing to use Tor.\n\nCreated T387 for it."},{"author":"Patrick","date_created":1438285148,"date_modified":1438285148,"content":"'resolved' is confusing here. Not really resolved as in implemented. New ticket: T385 But we might re-consider this one."},{"author":"HulaHoop","date_created":1438703766,"date_modified":1438703838,"content":"I'm ok with this ticket being implemented minimally rather than waiting for than abandoning it because of things hard to implement. By minimal I mean the timer loop checker on GW that triggers a clock sync and starts Tor before running timesync if it detects a large delta between what qemu-guest-agent says and the current host clock."},{"author":"Patrick","date_created":1438777779,"date_modified":1438777779,"content":"There is no need to implement most of this \"watch out for clock jumps and dispatch hooks when detected\" code directly in sdwdate. Can be implemented as an independent generic package."}]},"PHID-TASK-4n7e6h5jlgaokevcofd4":{"id":"380","title":"Qubes-Whonix 10 -> 11 upgrades","status":"resolved","priority":"High","author":"Patrick","description":"Instructions:\nhttps://www.whonix.org/wiki/Upgrading_Whonix_10_to_Whonix_11\n\nProgress on documenting Qubes specific 10 -> 11 upgrade issues has been made:\nhttps://www.whonix.org/w/index.php?title=Upgrading_Whonix_10_to_Whonix_11&diff=16487&oldid=16470\n\nThere are a few Qubes specific issues to solve. Documentation on how users can work around those.\n\n__issue 1__:\n\n~~www.whonix.org/wiki/Upgrading_Whonix_10_to_Whonix_11#Configuring_iptables-persistent_dialog~~\n\n__issue 2__:\n\n`Updating Qubes App Menus...` (`/usr/lib/qubes/qubes-trigger-sync-appmenus.sh`) runs forever. Locked up 5 times now. (Manually edited that script to disable this for now so the upgrade runs through.)\n\nWhen that happens, we could advice users to open another terminal and to run:\n`sudo killall qubes-trigger-sync-appmenus.sh`\n\nBut that solution is not great because it makes the upgrade process cumbersome, tedious. Any better idea?\n\n**TODO**: provide debug output to Marek as per https://groups.google.com/d/msg/qubes-users/MoUqGfMpMu0/GQfKwN1jBgAJ\n\n-----\n\n~~Currently upgrading Whonix-Workstation template. Will test upgrade a Whonix-Gateway template soon. Upgrade is slow. Still running. There may or may not be other issues during upgrading or after restart.~~","comments":[{"author":"Patrick","date_created":1437851108,"date_modified":1438824496,"content":"__issue 3__:\n\n```\nPackage configuration                                                                                                 \n ┌───────────────────────────────────────────┤ Configuring base-passwd ├───────────────────────────────────────────┐  \n │                                                                                                                 │  \n │ update-passwd has found a difference between your system accounts and the current Debian defaults.  It is       │  \n │ advisable to allow update-passwd to change your system; without those changes some packages might not work      │  \n │ correctly.  For more documentation on the Debian account policies, please see                                   │  \n │ /usr/share/doc/base-passwd/README.                                                                              │  \n │                                                                                                                 │  \n │ The proposed change is:                                                                                         │  \n │                                                                                                                 │  \n │ Remove group \"qubes\" (98)                                                                                       │  \n │                                                                                                                 │  \n │ If you allow this change, a backup of modified files will be made with the extension .org, which you can use    │  \n │ if necessary to restore the current settings.  If you do not make this change now, you can make it later with   │  \n │ the update-passwd utility.                                                                                      │  \n │                                                                                                                 │  \n │ Do you want to remove the group qubes?                                                                          │  \n │                                                                                                                 │  \n │                                 <Yes>                                    <No>                                   │  \n │                                                                                                                 │  \n └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘  \n```\n\nQubes specific. Most likely specific to the Debian templates, not Qubes-Whonix specific.\n\nWhat should one answer? Trying \"no\".\n\n(Also happens on jessie -> stretch upgrades. Therefore unspecific to Whonix.)\n\nReported upstream at Qubes tracker:\nhttps://github.com/QubesOS/qubes-issues/issues/1105"},{"author":"Patrick","date_created":1437851448,"date_modified":1438288849,"content":"~~__Issue 4__:~~ \n~~We don't have the upgraded #qubes-whonix_11 package for in the repository yet.~~\n"},{"author":"Patrick","date_created":1437852958,"date_modified":1438544324,"content":"~~__issue 5__:~~\n\n~~apt-get dist-upgrade~~\n\n~~The following packages have been kept back:~~\n~~db5.1-util grub-common grub-pc grub-pc-bin grub2-common~~\n~~0 upgraded, 0 newly installed, 0 to remove and 5 not upgraded.~~\n\n~~I guess we can simply recommend to purge those?~~\n\n~~apt-get purge db5.1-util grub-common grub-pc grub-pc-bin grub2-common~~\n"},{"author":"Patrick","date_created":1437853125,"date_modified":1438512051,"content":"__issue 6__:\nAfter upgrade, after \"sudo shutdown\" and starting the upgraded template, I am unable to start (using \"Run command in VM\") xterm, konsole and gnome-terminal. Neither any other applications are startable.\n\nUpdate... Qubes specific issue with it's Debian package versions and repository:\nhttps://github.com/QubesOS/qubes-issues/issues/1095#issuecomment-127013501"}]},"PHID-TASK-jo5ekgm52lozyqlxco3g":{"id":"379","title":"check if binary images for random seeds","status":"resolved","priority":"Normal","author":"Patrick","description":"More info:\nhttps://github.com/grml/grml-debootstrap/issues/91\nhttps://github.com/QubesOS/qubes-issues/issues/1311\n\nTODO check:\n\n* Whonix VBox / libvirt images\n* Qubes Debian templates\n* Qubes-Whonix images\n* Should any exist, think about what to do with those. As https://github.com/grml/grml-debootstrap/issues/91 explains, it may not be as simple as deleting those.\n","comments":[{"author":"Patrick","date_created":1444925883,"date_modified":1444925883,"content":"* /var/lib/random-seed\n* https://labs.riseup.net/code/issues/7100 /etc/machine-id / /var/lib/dbus/machine-id\n* https://labs.riseup.net/code/issues/7642 /var/lib/urandom/random-seed\n* https://labs.riseup.net/code/issues/7646 /var/lib/systemd/random-seed\n"},{"author":"Patrick","date_created":1445014428,"date_modified":1445014428,"content":"`delete /var/lib/systemd/random-seed and /var/lib/random-seed`:\nhttps://github.com/Whonix/whonix-initializer/commit/287d745c72a09733367e5d4dacbc5c5e07db9946\n"}]},"PHID-TASK-d5pynthyjgcn4im2ixwm":{"id":"378","title":"make vbox-disable-timesync compatible with guest additions from virtualbox CD","status":"open","priority":"Normal","author":"Patrick","description":"","comments":[]},"PHID-TASK-nx7q3yqvqwqlhl74ueko":{"id":"377","title":"update-grub does get run by grub-* packages during postinst","status":"resolved","priority":"Low","author":"Patrick","description":"Packages in question:\nhttps://github.com/Whonix?utf8=%E2%9C%93&query=grub-\n\nThe postinst script of these packages should call `update-grub`. Otherwise these packages have no effect before a kernel upgrade triggers or the user manually runs it.\n\nDebian has no update-grub trigger yet:\nhttps://bugs.debian.org/481542\n\nFYI:\nhttps://wiki.debian.org/DpkgTriggers\n","comments":[{"author":"Patrick","date_created":1437693318,"date_modified":1437693318,"content":"Done for #grub-screen-resolution package...\n`run update-grub during postinst so package takes effect right after installation - https://phabricator.whonix.org/T377`:\nhttps://github.com/Whonix/grub-screen-resolution/commit/b03aea8ff3a2ad28ec1bec7dba3d4a58e55cceda\n\nCan be easily replicated for the #grub-enable-apparmor and #grub-verbose-output package. Just waiting for potential comments on this."},{"author":"Patrick","date_created":1437693485,"date_modified":1437693485,"content":"Anyone has any suggestions on the error message when this fails? (@bnvk, @mfc, @memorylost)\n\n```\n      echo \"$DPKG_MAINTSCRIPT_PACKAGE $DPKG_MAINTSCRIPT_NAME ERROR: Running \\\n'update-grub' failed with exit code $?. $DPKG_MAINTSCRIPT_PACKAGE is most \\\nlikely only the trigger, not the cause. Unless you know this is not an issue, \\\nyou should fix running 'update-grub', otherwise your system might no longer \\\nboot.\" >&2\n```\n\n(It fails open, i.e. package installation will succeed. It's just supposed to be a warning in case this fails.)"},{"author":"Patrick","date_created":1439661712,"date_modified":1439661712,"content":"`run update-grub during postinst so package takes effect right after installation - https://phabricator.whonix.org/T377`:\nhttps://github.com/Whonix/grub-output-verbose/commit/1b8e74d70cef051c9d239692a48db8a82f87b62f\nhttps://github.com/Whonix/grub-enable-apparmor/commit/5d609e995fb3478700d53fb915cb3d807caa0ec8\n"}]},"PHID-TASK-dna54jtoxgwajatcwmd3":{"id":"376","title":"OnioNS on Whonix-Gateway","status":"open","priority":"Low","author":"HulaHoop","description":"Proposal to add OnioNS-client the Tor-based DNS that supports secure, global and human memorable addresses, to Whonix Gateway when it supports using system-wide Tor and packaged for Debian.\n\nhttps://github.com/Jesse-V/OnioNS-server/issues/53\nhttps://github.com/Jesse-V/OnioNS-client/issues/14\n\n","comments":[{"author":"Patrick","date_created":1437848678,"date_modified":1437848678,"content":"[quote](https://github.com/Jesse-V/OnioNS-server/issues/53#issuecomment-124867516) Jesse Victors:\n> I'd be happy to explain. OnioNS-client opens 9053/TCP on localhost which listens for *.tor domains, and then writes *.onion back. A Python script, using Stem, receives event notifications through Tor's control port of stream requests, picks up a *.tor domain lookup, sends it to 9053/TCP for resolution, reads back a *.onion address, tells Tor over the control port to redirect that stream to that *.onion address, and then tells Tor to attach that stream to a circuit. In effect, the Tor Browser operates exactly as before and from its perspective the user is browsing a *.tor domain, when under the hood Tor is receiving a *.onion lookup. This has the effect of loading hidden services under *.tor domain names.\n> \n> OnioNS is mainly distributed through my Ubuntu PPA, as described in the README. My current approach for integrating with the Tor Browser is to rename the Tor executable in Browser/TorBrowser/Data to \"torbin\", then insert my own executable which launches torbin, /usr/bin/onions-client, and the Python Stem script as child processes, in that order. That way, all the necessary software starts when the Tor Browser opens and by monitoring the status of torbin, they can all close when the Tor Browser closes as well. Obviously, this setup is not ideal and I do have plans to modify the Tor Launcher to also start up these processes, but my binary substitution approach was quicker and easier.\n> \n> In summary, I'm not distributing a different build of the Tor Browser. Clients can still download and verify it via PGP and all that, but then they can get OnioNS functionality into it with a few rename and copy commands. That's my current approach anyway. I'd love to integrate with Whonix of course, but I would like to prepare working binaries of non-Whonix software first, and then we can explore integrating with Whonix; one battle at a time. It's entirely possible that it'll be easy to integrate in Whonix, in which case we've killed two birds with one stone.\n\nAlright. Sounds good. I'll keep my time rereading this a few times over the next few days.\n\nSeems like it's two services. [as in (systemd) services to be started] (OnioNS-client + python script)\n\nI guess we could just start OnioNS-client opens 9053/TCP on localhost and the python script in the workstation. When they try to reach Tor's default SocksPort or Tor's default ControlPort, those would be actually redirected to Whonix-Gateway (anon-ws-disable-stacked-tor). Good.\n\nIf OnioNS was provided by a Debian package, then the implementation might be as simple as installing the Debian package by default.\n\nThere is room to mess up the tor-launcher patch, though. If they would break the ability to not start Tor/OnioNS-client (export TOR_SKIP_LAUNCH=1). But that's not very likely and we can give feedback in the process.\n\nEven if there wasn't a Debian package, then we might be able to provide instructions and/or a script and/or patch tb-starter, so it starts those two services from the extracted TBB. More hacky, fragile."},{"author":"HulaHoop","date_created":1469921694,"date_modified":1469921694,"content":"This task should take a backseat indefinitely. The OnioNS project is unfinished and undeployed:\n\nhttps://lists.torproject.org/pipermail/tor-dev/2016-July/011241.html"},{"author":"HulaHoop","date_created":1469921985,"date_modified":1470312165,"content":"As of July, the latest commit was in February but revisions were made to the masters thesis published on github. So its not totally abandonware just under development.\n\n***\n\nEDIT:\n\nStatus update on OnioNS. Its alive and well going through refactoring:\n\nhttps://lists.torproject.org/pipermail/tor-dev/2016-August/011265.html \n"},{"author":"HulaHoop","date_created":1471825896,"date_modified":1471825896,"content":"TPO devs going back to the drawing board since no optimal human readable address solution exists. They are giving it priority since longer HS addresses are just around the corner.\n\nhttps://lists.torproject.org/pipermail/tor-dev/2016-August/011314.html\nhttps://trac.torproject.org/projects/tor/wiki/doc/OnionServiceNamingSystems"},{"author":"HulaHoop","date_created":1475618715,"date_modified":1475618715,"content":"Jesse has improved OnioNS a lot since the GSoC release. Submitted updated paper and design to PoPETS. Tor has not decided to rely on a single official easy name resolution solution yet however a name resolution agnostic API supported by Tor is planned and proposals soon suggested.\n\nhttps://lists.torproject.org/pipermail/tor-dev/2016-October/011494.html\nhttps://lists.torproject.org/pipermail/tor-dev/2016-October/011495.html"}]},"PHID-TASK-b7eivepbj7wgqj4e72w6":{"id":"375","title":"Include Debian ReportBug GUI?","status":"wontfix","priority":"Wishlist","author":"HulaHoop","description":"I propose including the Debian GUI bug reporting tool in Whonix by default to make upstream bug reporting easier for all users.\n\nhttps://packages.debian.org/jessie/reportbug-ng","comments":[{"author":"Patrick","date_created":1437076706,"date_modified":1437076706,"content":"Big project. \n\n* We would need to check, that reportbug-ng doesn't collect privacy sensitive information.\n* Where are bug reports sent? To Debian's BTS? We would have to ask what they think about this. O run our own version of BTS?\n\nBtw, I don't like Debian BTS at all. It's web interface is outdated. Has bad usability."},{"author":"Patrick","date_created":1437077119,"date_modified":1437077119,"content":"Tails uses WhisperBack.\n\n* https://tails.boum.org/contribute/design/ search for WhisperBack\n* https://tails.boum.org/doc/first_steps/bug_reporting/"},{"author":"HulaHoop","date_created":1437089354,"date_modified":1437089408,"content":">Big project.\n\nWe are not going to be running our own anonymous bug reporting infrastructure like TAILS does with WhisperBack. That would be very demanding and need many things to make sure its done right.\n\nThe idea is to make it easier (relatively anyway) for bug reports to Debian BTS. I found myself needing to file some reports that way and usability could be better.\n\n>  * We would need to check, that reportbug-ng doesn't collect privacy sensitive information.\n\nThat should be simple to do.\n\n> * Where are bug reports sent? To Debian's BTS? We would have to ask what they think about this. O run our own version of BTS?\n\nDebian BTS\n\n>Btw, I don't like Debian BTS at all. It's web interface is outdated. Has bad usability.\n\nYes its not that good but still better than command line IMO for newbies."},{"author":"HulaHoop","date_created":1437158817,"date_modified":1437158817,"content":"I researched ReportBug some more. It seems to be a form asking for specific things to be filled out about a bug and then its sent via sendmail to Debian servers. Nothing besides whats filled out is sent. \n\nThis is different from KDE crash reporter where debug information can be optionally sent (they ask for permission first).\n\nIf you feel the GUI is no good for beginners then this ticket can be closed.  Those who have some experience can easily install and use reportbugs when its needed - so no benefit there."},{"author":"HulaHoop","date_created":1437162618,"date_modified":1437162618,"content":"I took another look at reportbugs vs reportbugs-ng and I think the gui tool is actually more awkward to use than the text-based tool. I don't think it should be included anymore.\n\nI want to add a small note on the documentation for reporting bugs that users can refer to to have an idea of what tool they should install if needed. Where should I post this?"},{"author":"mfc","date_created":1437164400,"date_modified":1437164400,"content":"> We are not going to be running our own anonymous bug reporting infrastructure like TAILS does with WhisperBack. That would be very demanding and need many things to make sure its done right.\n> \nIs this not desirable in the medium- or long-term though?\n\nI don't know what the backend looks like for WhisperBack, but\nQubes/Whonix is always going to have some infrastructure anyway (for\nupdates etc). The larger time-suck would probably be triaging bug\nreports to the respective tools, given that most will probably not be\nassociated with Q/W-developed work."},{"author":"Patrick","date_created":1437308070,"date_modified":1437308070,"content":"What I don't like about WhisperBack alike approaches is, that it leads to more secrecy behind closed doors. Everyone thinks their report need secrecy, is special and should be sent by encrypted mail to Whonix developers where they get private, premium support for free. Encourages laziness of just pressing the button. Less searching for existing discussions. Less incentive to sign up for the forums and user to user exchange.\n\nTails has a stronger incentive for WhisperBack, because they primarily target host operating systems, have to deal with hardware issues. Whonix primarily targets VMs and leaves dealing with hardware issues to host operating systems. So bug reports / feature requests are more generic.\n\nAnd the worst thing is, this kind of work behind the scenes isn't visible in public. Generates more \"invisible\" work in private while it looks like laziness in public. WhisperBack alike approaches seem more appropriate for paying customer to vendor support setups. Or like in case of The Tor Project, that receives funding dedicated for the employment of a support team.\n\nAll in all, I am not excited to invest time to make WhisperBack work. Also because reports would most likely reach my inbox. But if there is any compelling problem that needs to be solved, I stay open to arguments."},{"author":"mfc","date_created":1438946545,"date_modified":1438946545,"content":"Sorry the context is Whonix in Qubes, no? In which case it is a very\nsimilar context to Tails.\n\nWhisperBack doesn't provide any feedback to the user, it is only to\ncommunicate (securely, easily) to the developers, mostly likely about a\nbug that may have personal information associated with it.\n\nSo it's not for troubleshooting, it's for bug reporting. It could just\ngo automatically into a bug reporting system, not sure what Tails does.\n\nFrom the Tails monthly reports they seems to get some useful feedback\nthrough it.\n\nNot a priority, but just wanted to clarify the use-case.\n\nMichael\n\nPatrick (Patrick Schleizer):\n> Patrick added a comment.\n> \n> What I don't like about WhisperBack alike approaches is, that it leads to more secrecy behind closed doors. Everyone thinks their report need secrecy, is special and should be sent by encrypted mail to Whonix developers where they get private, premium support for free. Encourages laziness of just pressing the button. Less searching for existing discussions. Less incentive to sign up for the forums and user to user exchange.\n> \n> Tails has a stronger incentive for WhisperBack, because they primarily target host operating systems, have to deal with hardware issues. Whonix primarily targets VMs and leaves dealing with hardware issues to host operating systems. So bug reports / feature requests are more generic.\n> \n> And the worst thing is, this kind of work behind the scenes isn't visible in public. Generates more \"invisible\" work in private while it looks like laziness in public. WhisperBack alike approaches seem more appropriate for paying customer to vendor support setups. Or like in case of The Tor Project, that receives funding dedicated for the employment of a support team.\n> \n> All in all, I am not excited to invest time to make WhisperBack work. Also because reports would most likely reach my inbox. But if there is any compelling problem that needs to be solved, I stay open to arguments.\n> \n> \n> TASK DETAIL\n>   https://phabricator.whonix.org/T375\n> \n> EMAIL PREFERENCES\n>   https://phabricator.whonix.org/settings/panel/emailpreferences/\n> \n> To: Patrick\n> Cc: bnvk, marmarek, nrgaway, mfc, Patrick, troubadour, WhonixQubes, HulaHoop\n>"},{"author":"Patrick","date_created":1439034881,"date_modified":1439034881,"content":">>! In T375#6320, @mfc wrote:\n> Sorry the context is Whonix in Qubes, no?\n\nYes. I made no difference between Whonix / Qubes-Whonix here.\n\n> In which case it is a very\n> similar context to Tails.\n\n\"Tails has a stronger incentive for WhisperBack, because they primarily target host operating systems, have to deal with hardware issues. Whonix primarily targets VMs and leaves dealing with hardware issues to host operating systems. So bug reports / feature requests are more generic.\"\n\nIn other words, the system information that WhisperBack collects are not so important for Whonix.\n \n> WhisperBack doesn't provide any feedback to the user, it is only to\n> communicate (securely, easily) to the developers, mostly likely about a\n> bug that may have personal information associated with it.\n\nMostly true. What it does allow the user is providing an e-mail address. And even an OpenPGP key to receive encrypted replies.\n\n\"What I don't like about WhisperBack alike approaches is, that it leads to more secrecy behind closed doors. Everyone thinks their report need secrecy, is special and should be sent by encrypted mail to Whonix developers where they get private, premium support for free. Encourages laziness of just pressing the button. Less searching for existing discussions. Less incentive to sign up for the forums and user to user exchange.\"\n \n> So it's not for troubleshooting, it's for bug reporting. It could just\n> go automatically into a bug reporting system, not sure what Tails does.\n\nI don't know. Since users can provide an e-mail address (+ optional OpenPGP key), it can also be used as a support tool.\n \n> From the Tails monthly reports they seems to get some useful feedback\n> through it.\n\nBut they don't get useful feedback through the forums. Because they have none. ;)\n \n> Not a priority, but just wanted to clarify the use-case.\n\nSure thing. Keep it coming.\n\nI don't think I based my previous post upon knowledge, that has now changed. My previous comment T375#5966 still applies.\n\nIf users are using it, \"encourages laziness of just pressing the button\". It doesn't even require signing up for the forums. Less searching for existing discussions. Less user to user exchange. I fear users will just open the thing \"how do I x and y\" and then expect an answer.\n\nAnd all this work happens in private. Going unnoticed."},{"author":"Patrick","date_created":1674126101,"date_modified":1674126101,"content":"Due to phabricator being deprecated upstream, all tickets need to me migrated. Therefore closing here.\n\nPlease re-open in forums if still relevant.\n"}]},"PHID-TASK-n4fpa5llabizvqe7xdnn":{"id":"374","title":"Nymserver Documentation","status":"resolved","priority":"Normal","author":"HulaHoop","description":"This ticket is for nymserver documentation improvements. ","comments":[{"author":"dau","date_created":1436726404,"date_modified":1436728270,"content":">>! In T367#5918, @HulaHoop wrote:\n> I pushed a major change to the wiki. Many parts are rewritten and new information added.\n\nAwesome! Looks good :)\n\nI'd like to suggest that this section be split to have its own dedicated section, like `wiki/nymservers`. It is not a big deal, but although we recommend using Mixmaster to communicate with nym servers, they are totally independent. The only thing you need to manage your nym is sending messages to the nym server, via your SMTP server, Mixmaster or even your personal email (not recommended, but would still work).\n\nI would like to know if we should emphasize the use of GUIs (like KGpg) by giving all the examples using them, but leaving the command line instructions in textboxes that can be expanded if the user prefers to use them (not sure if can be done with Wikitext).\n\nAlso, there is a statement that caught my attention:\n\n> Note that the protection provided by Mixmaster is not of importance here because everything is done behind Tor.\n\nI am not sure in which aspect it was directed to, but I believe we should try to explain it better or at least link some references.\n\nThe user should know that the messages would kind of follow this path `whonix -> tor circuit -> mix network -> nym server`. After Tor's last hop, it depends on how Mixmaster encrypts the data that is sent to the mixes.\n\nAlso, we should try to discuss latency as well. I still have not found a conclusive study on Mixmaster vs Tor, but against a very powerful adversary, Mixmaster's high-latency can still provide some anonymity when it comes to time correlation attacks, where Tor's low-latency wouldn't. On nymphemeral's documentation we (rxcomm and I) instruct the users to use Mixmaster via Tor. We believe that the user can use all of their advantages by doing so.\n\nRegarding chains: I believe that choosing a short mix chain will decrease the latency, but decrease the anonymity level as well.\n\nLet me know what you think.\n\nThanks!"},{"author":"HulaHoop","date_created":1436741706,"date_modified":1436741706,"content":">I'd like to suggest that this section be split to have its own dedicated section, like wiki/nymservers. It is not a big deal, but although we recommend using Mixmaster to communicate with nym servers, they are totally independent. The only thing you need to manage your nym is sending messages to the nym server, via your SMTP server, Mixmaster or even your personal email (not recommended, but would still work).\n\nCreated new page at https://www.whonix.org/wiki/Nymservers\n\nOk I'll add the part about sending choices in the introduction, to give the user the whole idea of how it works.\n\n>I would like to know if we should emphasize the use of GUIs (like KGpg) by giving all the examples using them, but leaving the command line instructions in textboxes that can be expanded if the user prefers to use them (not sure if can be done with Wikitext).\n\nSure. I didn't know if some of the operations like signing and encrypting simultaneously were supported by the GUI so I put some of this with some of that. Your format of the instructions would be the proper way so feel free to add both.\n\n\n>I am not sure in which aspect it was directed to, but I believe we should try to explain it better or at least link some references.\n\nYes there should have been a reference. It was a statement made by Roger, one of Tor's chief researchers who worked on remailer networks in the past:\n\nhttp://www.mail-archive.com/liberationtech@lists.stanford.edu/msg00022.html\n\n>The user should know that the messages would kind of follow this path whonix -> tor circuit -> mix network -> nym server. After Tor's last hop, it depends on how Mixmaster encrypts the data that is sent to the mixes.\n\nYes. I'll add it too.\n\n>Regarding chains: I believe that choosing a short mix chain will decrease the latency, but decrease the anonymity level as well.\n\nI am thinking we should still keep chains 3 or 4 hops long just to blend in with most traffic not because of the anonymity benefit. Should I just remove this sentence? I was just explaining the concept."},{"author":"HulaHoop","date_created":1436744531,"date_modified":1436744531,"content":"How would attachments work? Are they the same instructions as sending a message - Would a user need to always sign and encrypt attachments to the Nymserver? \n\n(Mixmaster takes an **-a filename**  parameter to send an attachment.)"},{"author":"dau","date_created":1436766922,"date_modified":1436766922,"content":"> Created new page at https://www.whonix.org/wiki/Nymservers\n> \n> Ok I'll add the part about sending choices in the introduction, to give the user the whole idea of how it works.\n\nThanks!\n\n> Sure. I didn't know if some of the operations like signing and encrypting simultaneously were supported by the GUI so I put some of this with some of that. Your format of the instructions would be the proper way so feel free to add both.\n\nI tried to use KGpg where I could, but there were some things that I could not find out how to do. I never used KGpg :/\n\n> Yes there should have been a reference. It was a statement made by Roger, one of Tor's chief researchers who worked on remailer networks in the past:\n> \n> http://www.mail-archive.com/liberationtech@lists.stanford.edu/msg00022.html\n\nOh, thanks!\n\n> I am thinking we should still keep chains 3 or 4 hops long just to blend in with most traffic not because of the anonymity benefit. Should I just remove this sentence? I was just explaining the concept.\n\nI agree that around 4 hops should be enough to provide some anonymity, but not totally agree with the rest. I will first try to search for more information on that before actually saying what I'm thinking. I guess that sentence can stay there.\n\n>>! In T374#5923, @HulaHoop wrote:\n> How would attachments work? Are they the same instructions as sending a message - Would a user need to always sign and encrypt attachments to the Nymserver? \n> \n> (Mixmaster takes an **-a filename**  parameter to send an attachment.)\n\nI never sent attachments before. I will answer that once I find out. (That's why I haven't answered that new issue you opened)\n\nWell, here is what I have for the instructions sub-section on Nymservers. I changed it quite a bit, but it should have most of what you currently have there. Can you take a look to see if what I wrote is correct?\n\n```\n=== Instructions ===\nThe process broken down into steps:\n\n# Import Nymserver's Key\n# Prepare Nym Request\n# Send Request to Nymserver\n# Retrieve Messages from Newsgroup\n# Decrypt Messages\n# Send Mail with Registered Nym\n# Reconfigure Nym\n\n'''Conventions'''\n\nFor these instructions the example '''nym@server''' will be used. You\nmust change them to suit the nym choice you make and the domain name\nof the Nymserver.\n\nThis example is for '''mixnym.net''' but the guide is still generic\nand relevant to apply to any other Zax-type Nymserver. For a\nselection of Nymservers see this\n[https://www.whonix.org/w/index.php?title=Mixmaster&stable=0&shownotice=1&fromsection=Other_Useful_Topics#Zax_Server_List list].\n\nIt is important to know which of the address you are going to use\nwhen sending messages to the Nymserver:\n\n'''config@server''': creation or configuration requests, to create\nand manage your nym\n\n'''send@server''': send requests, to send messages from your nym to\nother people\n\n'''url@server''': url requests, to retrieve an HTML page\n\n==== Import Nymserver's Key ====\n\nA Nymserver's key is usually on their homepage, but sometimes it may\nonly be available from the PGP keyservers. In that situation, open\nKGpg's keyserver dialog, search for it and then import from there.\n\n1. Download the '''mixnym.net''' Nymserver key with curl to home folder.\n\n    <pre>\n    curl -o key.asc http://is-not-my.name/key.asc\n    </pre>\n\n2. Check fingerprints/owners without importing anything.\n\n    <pre>\n    gpg --with-fingerprint key.asc\n    </pre>\n\nAlways check the fingerprint for yourself. The output at the moment\nis:\n\n    <pre>\n    pub  4096R/0xFF4DB66014D0C447 2010-05-05 URL is-not-my.name (URL Retrieval address for Is-Not-My Nymserver) <url@is-not-my.name>\n          Key fingerprint = 94F2 04C2 8BF0 0937 EFC8  5D1A FF4D B660 14D0 C447\n    </pre>\n\n3. If it looks good, import with GPG:\n\n    <pre>\n    gpg --import key.asc\n    </pre>\n\n==== Prepare Nym Request ====\n\n===== Create a Key Pair =====\n\nCreate a new key pair for '''nym@server''':\n\n    <pre>\n    KGpg -> Keys -> Generate Key Pair...\n\n    Name: John Doe (or any alias of choice)\n    Email: nym@server\n    RSA key of 4096 bits\n\n    Enter passphrase for key. OK.\n    </pre>\n\nEquivalent in the command line:\n\n    <pre>\n    gpg --gen-key\n    </pre>\n\n===== Export Public Key =====\n\nThis will extract the newly generated key from your keyring and store\nit in a text file. In the following example, I've named that file\n<code>pubkey.txt</code>:\n\n    <pre>\n    KGpg -> Select key -> Export Public Key -> File -> pubkey.txt -> OK\n    </pre>\n\nEquivalent in the command line:\n\n    <pre>\n    gpg --armor --export nym@server > pubkey.txt\n    </pre>\n\n===== Configure Additional Options =====\n\nYou only need to perform this step if you want to configure\nadditional options on your nym, such as Subject Identification or\nSymmetric Encryption. For each option, prepend a line to the\n<code>pubkey.txt</code> file using the format:\n\n    <pre>\n    option: setting\n    </pre>\n\nCaps are unimportant in the option name, but are sensitive in the setting.\n\nThe Nymserver parameters specified here are optional.\n<ref>https://groups.google.com/forum/#!topic/alt.privacy.anon-server/f3H4Xw5j2LI</ref>\nYou can set them now or change them in the future as its detailed on\nReconfigure Nym.\n\n'''Fixed (Plaintext) Subject'''\n\nChoose some unique keyword as a '''Subject''' to be able identify the\nNymserver reply on the Newsgroup with the <code>subject</code>\noption. Using a fixed subject is convenient, but anyone will be able\nto link all the messages for a nym since they all have the same\nsubject.\n\n'''Hashed Subject'''\n\nA better alternative than the <code>subject</code> option is to use\nhashed subjects (hSubs) by providing an hSub passphrase with the\n<code>hsub</code> option instead.\n\nAn hSub is made of two parts, where the first is a random number and\nthe second part is the hash of that same random number and a\npassphrase. As the hashing is a one-way function, no one can identify\nthe owner of the message. However, as you know your nym's hSub\npassphrase, you can hash it with the random number of every message,\nand if the result collides with the second part of the hSub, that\nmessage was sent to your nym. You can read more on\n[http://is-not-my.name/hsub.html this post] by Zax.\n\nYou can also use these options to set an hSub:\n<code>hash-key</code>, <code>hash-subject</code>,\n<code>subject-password</code>. These all mean the same as\n<code>hsub</code>.\n\n'''Symmetric Encryption'''\n\nYou can add a symmetric encryption layer by specifying a key with the\n<code>symmetric</code> option.\n\n'''Deletion'''\n\nIf you wish to delete your nym, you can send the following option and\nsetting: <code>delete: yes</code>.\n\n'''Example'''\n\nFor example, to add an hSub passphrase of <code>panda</code>, you\nshould edit the <code>pubkey.txt</code> like this:\n\n    <pre>\n    hsub: panda\n\n    -----BEGIN PGP PUBLIC KEY BLOCK-----\n    <snipped>\n    -----END PGP PUBLIC KEY BLOCK-----\n    </pre>\n\nYou can add more than one option line to your request. However, you\nshould remember that some options might create conflicts. For\nexample, <code>subject</code> and <code>hsub</code> work differently,\nbut are used for the same purpose. You should choose either one or\nthe other.\n\n===== Encrypt the Request =====\n\nNow you must wrap <code>pubkey.txt</code>, the message containing your\nadditional options and public key, to the Nymserver. The\n<code>pubkey.txt</code> file is the input for the following example\nand the encrypted file will be created as\n<code>pubkey.txt.asc</code>:\n\n    <pre>\n    KGpg -> Open Editor -> Open -> Select pubkey.txt\n\n    Encrypt -> Select the Nymserver's key\n\n    Options -> Allow encryption with untrusted keys -> OK\n\n    Save -> Name the ciphertext pubkey.txt.asc\n    </pre>\n\nEquivalent in the command line:\n\n    <pre>\n    gpg --armor --encrypt --recipient config@mixnym.net pubkey.txt\n    </pre>\n\nYou can ignore the warning about encrypting to an \"untrusted\" key and\nselect <code>y</code> for yes.\n\n==== Send Request to Nymserver ====\n\nBefore sending the request, update remailer keys first. Its enough to\ndo this once a day\n<ref>https://www.youtube.com/watch?v=dzbrFPO4604 LinuxJournal</ref>:\n\n    <pre>\n    mixmaster\n\n    u)pdate stats\n\n    *\n\n    pick remailer letter (optional)\n\n    q)uit\n    </pre>\n\nSend the encrypted file to the Nymserver with Mixmaster:\n\n    <pre>\n    mixmaster --mail -l *,*,* -c 2 config@mixnym.net pubkey.txt.asc\n    </pre>\n\nWhere:\n\n<code>-l</code> customizes the remailer chain length. The shorter the\nchain the faster your mail will be sent and the more likely it will\nmake it through. Here we are using three random mixes:\n<code>*,*,*</code>.\n\n<code>-c</code> sends copies of the message. Here we are using\n<code>2</code>.\n\nIf necessary, run Mixmaster from command line and check the remailer\nchain list to see node availability and reliability stats and choose\naccordingly.\n\nThat's it! The Nymserver decrypts the message, extracts your Nym's\nemail address from the supplied Public Key and processes it. Provided\nthat the Nym isn't reserved or already taken, you will receive a\nconfirmation message from the Nymserver, encrypted to your nym's key.\n\nNote that the protection provided by Mixmaster is not of importance\nhere because everything is done behind Tor.\n<ref>http://www.mail-archive.com/liberationtech@lists.stanford.edu/msg00022.html</ref>\n\n'''Important'''\n\nIt's worth noting that this is the only message you will attach your\npublic key and the only one the server will ever accept from you\nthat's not signed by that key. From now on, you nym's digital\nsignature will prove your ownership of it. Examples on signing can be\nfound on Send Mail with Registered Nym and\nReconfigure Nym.\n\n==== Retrieve Messages from Newgroup ====\n\nZax-type Nymservers deliver messages to the nyms via the\nalt.anonymous.messages Usenet group (a.a.m). Anyone can access these\nmessages, but only the nyms can decrypt them, using their private\nkeys.\n\nAs explained previously, you can configure your messages to be\nidentified by subject. If you chose to use some kind of subject\nidentification from the previous section, you can go to\nUse aam2mail to Fetch Replies.\nIf you did not configure that and wish to do so, you will have to\nsend a configuration message to configure a method of subject\nidentification. You will find an example on\nReconfigure Nym.\n\nIf you do not wish to use any kind of subject identification, the\ndefault way to do this is by downloading and attempting to decrypt\nevery message posted on the Newsgroup. If it works, then the message\nwas sent to your nym.\n\n===== Use aam2mail to Fetch Replies =====\n\n1. Install git and clone aam2mail source. aam2mail requires no extra\ndependencies.\n\n    <pre>\n    sudo apt-get install git\n    git clone https://github.com/crooks/aam2mail\n    cd aam2mail\n    sudo python setup.py install\n    </pre>\n\n\n2. Configure aam2mail settings. Use the hsub you chose:\n\n    <pre>\n    mkdir aam2mail/etc\n    echo 'panda' >> aam2mail/etc/subject_hsub\n    echo 'news.aioe.org' >> aam2mail/etc/servers\n    </pre>\n\n3. Run aam2mail periodically to check for messages. There is an\nexpected delay of a few hours before getting replies.\n\n    <pre>\n    aam2mail --start\n    </pre>\n\nor\n\n    <pre>\n    aam2mail --restart\n    </pre>\n\n4. Replies will be downloaded by aam2mail to this path:\n''/home/user/Maildir/new''. aam2mail does not decrypt messages for\nyou but retrieves them only.\n\nBe sure to check for new messages regularly because messages on\nUsenet accumulate beyond the fetch-limit and you may miss them.\n\n==== Decrypt Messages ====\n\nWith the message saved to a file, open it with KGpg and decrypt it:\n\n    <pre>\n    KGpg -> File -> Open Editor -> Open\n\n    Select the file with the message\n\n    Decrypt -> Type your nym's key passphrase\n    </pre>\n\nYou should see the plaintext of the message your nym received.\n\nCongratulations for registering your first nym. Now you are ready to\nuse it for sending messages.\n\n==== Send Mail with Registered Nym ====\n\nTo send messages to other people, it is very similar to the way you\ndid previously for the creation and configuration. KGpg could be used\nfor that:\n\n    <pre>\n    KGpg -> Open editor\n    </pre>\n\nType the message:\n\n    <pre>\n    To: recipient@domain\n    Subject: Example\n\n    This is an example\n    </pre>\n\nAt the bottom, encrypt it:\n\n    <pre>\n    Encrypt -> Select the Nymserver's key\n\n    Options -> Allow encryption with untrusted keys -> OK\n\n    Save -> Name the ciphertext as message.txt\n    </pre>\n\nSend it with Mixmaster, but this time to '''send@server''':\n\n    <pre>\n    mixmaster --mail -l *,*,* send@server message.txt\n    </pre>\n\nNotice that this time we did not send copies of the message. We\nadvised sending copies on the creation because after receiving the\nfirst one, the server would ignore the others. In this case, if you\nsend copies, the server will send all of them to the recipient.\n\nThe recipient will receive a message from '''nym@server''' and they\ncan send a reply to that same address.\n\n==== Reconfigure Nym ====\n\nIf you wish to add (or change) an option, all you can send another\nmessage to '''config@server''', say <code>option.txt</code>, with the\noption(s) you would like to add:\n\n    <pre>\n    hsub: passphrase\n    </pre>\n\nThe message does not need to have a body, just headers. Remember that\nafter creation, all your messages should be signed before sending to\neither '''config@server''' or '''send@server''':\n\n    <pre>\n    gpg --armor --encrypt --sign --recipient config@mixnym.net option.txt\n    </pre>\n\nNow you just need to send. As you are configuring your nym, you\nshould send it to '''config@server''':\n\n    <pre>\n    mixmaster --mail -l *,*,* config@mixnym.net option.txt.asc\n    </pre>\n\n=== Important Notes ===\n\n==== Message Ordering ====\n\nDue to Mixmaster's latency, it is possible that messages arrive out\nof order. Your next messages might arrive earlier than the creation\nmessage. If you do not get responses, you will have to send them\nagain, once the nym is created.\n\n==== Public Mailbox ====\n\nWhen someone send a message to your nym, the server will receive\nit, encrypt to the nym and post on a.a.m so you can retrieve it. The\nNewsgroup acts as a public mailbox. Everybody can see and download\nthe messages but only the intended recipient (your nym) can decrypt\nit.\n\n==== Multiple Nyms ====\n\nIf you use more than one nym, you need to remember to choose which\nnym is going to sign the message, or always the same nym is going to\nsend the messages, and consequently only his messages will be\naccepted. Remember that the only message accepted without a signature\nis the creation message.\n\nTo specify the nym that is going to sign the message, use the\n<code>--local-user</code> flag:\n\n    <pre>\n    gpg --armor --encrypt --sign --recipient send@server --local-user nym@server message.txt\n    </pre>\n\n==== End-to-End Encryption ====\n\nThe encryption layers discussed here will only protect data between\nyour nym and the server. It is advised that you use some kind of\nend-to-end encryption (another layer) between you and the recipient\nby encrypting the body of the message first, and then encrypting to\nthe server's key.\n\nKeep in mind that the headers cannot be encrypted. An end-to-end\nencrypted message would look like this:\n\n    <pre>\n    To: recipient@domain\n    Subject: Subject\n\n    -----BEGIN PGP MESSAGE-----\n    <snipped>\n    -----END PGP MESSAGE-----\n    </pre>\n\nAfter that you would then encrypt to the Nymserver, and it would look\nlike this in the end:\n\n    <pre>\n    To: send@server\n\n    -----BEGIN PGP MESSAGE-----\n    <snipped>\n    -----END PGP MESSAGE-----\n    </pre>\n```\n\nPending:\n\n> Do not use Symmetric: passphrase. If you do, some (if not all) of the free hsub programs and routines will not be able to automatically find your messages. aam2mail supports the option but it complicates the operation. Its also not commonly used and therefore not a good choice for blending in.\n\nI do not remember using the symmetric option, but I do not think that would cause these problems. Can you provide more info on that?\n\nI do not know how Mixmaster's `-c` flag work, but I think it just sends a bunch of copies and all of them might be delivered. For that reason, I guess that we should instruct the user to use copies only for the creation, because the recipient might not like to receive duplicates. What do you think?\n\nThere were some parts of your new version that you enumerated the steps like `1) ... 2) ...`, but they are kind of 'hard coded'. Isn't there a way to use something to keep track of an ordered list similar to how the section numbers are handled? I just think that using a hard coded index would add a little more work when updating the text.\n\nI did not find a nice way of referencing sub-sections of the text. How exactly do you do that? I never used Wikitext before :/\n\nThanks!"},{"author":"HulaHoop","date_created":1436801455,"date_modified":1436801455,"content":">I never sent attachments before. I will answer that once I find out. (That's why I haven't answered that new issue you opened)\n\nAlright thanks.\n\n>Well, here is what I have for the instructions sub-section on Nymservers. I changed it quite a bit, but it should have most of what you currently have there. Can you take a look to see if what I wrote is correct?\n\nExcellent. It was a better polished version of what I wrote. I replaced everything with your text. Feel free to directly edit the page and I'll accept the changes.\n\n>I agree that around 4 hops should be enough to provide some anonymity, but not totally agree with the rest. I will first try to search for more information on that before actually saying what I'm thinking. I guess that sentence can stay there.\n\nThere isn't a mention of it in the new text but feel free to mention it if you think it should be.\n\n>I do not remember using the symmetric option, but I do not think that would cause these problems. Can you provide more info on that?\n\nNot my words but a copy of a newsgroup post - probably outdated. I never tried it and I don't think this still applies anyway because aam2mail should handle it.\n\n>I do not know how Mixmaster's -c flag work, but I think it just sends a bunch of copies and all of them might be delivered. For that reason, I guess that we should instruct the user to use copies only for the creation, because the recipient might not like to receive duplicates. What do you think?\n\nYes I agree.\n\n>There were some parts of your new version that you enumerated the steps like 1) ... 2) ..., but they are kind of 'hard coded'. Isn't there a way to use something to keep track of an ordered list similar to how the section numbers are handled? I just think that using a hard coded index would add a little more work when updating the text.\n>\n>I did not find a nice way of referencing sub-sections of the text. How exactly do you do that? I never used Wikitext before :/\n\nI haven't tried it before but could this work? \n\nhttps://en.wikipedia.org/wiki/Help:Section#Section_linking_and_redirects\nhttps://en.wikipedia.org/wiki/Help:Wiki_markup#Lists\n"},{"author":"dau","date_created":1436835287,"date_modified":1436835328,"content":"> Excellent. It was a better polished version of what I wrote. I replaced everything with your text. Feel free to directly edit the page and I'll accept the changes.\n\nCool! Thanks :)\n\n> There isn't a mention of it in the new text but feel free to mention it if you think it should be.\n\nIsn't it this part?\n\n\n```\nSend the encrypted file to the Nymserver with Mixmaster:\n\n    mixmaster --mail -l *,*,* -c 2 config@mixnym.net pubkey.txt.asc\n\nWhere:\n\n-l customizes the remailer chain length. The shorter the chain the faster your mail will be sent and the more likely it will make it through. Here we are using three random mixes: *,*,*. \n\n```\n\n> Not my words but a copy of a newsgroup post - probably outdated. I never tried it and I don't think this still applies anyway because aam2mail should handle it.\n\nI'll let you know if I find something new about it.\n\n> I haven't tried it before but could this work? \n> \n> https://en.wikipedia.org/wiki/Help:Section#Section_linking_and_redirects\n> https://en.wikipedia.org/wiki/Help:Wiki_markup#Lists\n\nI'll take a look at those.\n\nI was reading the section again and there is something missing there.\n\nOn the sub-section [[ https://www.whonix.org/wiki/Nymservers#Send_Mail_with_Registered_Nym | 3.6 Send Mail with Registered Nym ]], I forgot to instruct the user to sign the message. Unfortunately I did not find a way to sign and encrypt \"simultaneously\" with KGpg equivalent to `gpg -aesr server file`. I believe that doing separately with KGpg, by composing, signing and only after that encrypting would work, but haven't tested it yet. But I guess that in the case of this guide, using a GUI as KGpg isn't helping much. It might be even more confusing because we are not giving any screenshots, and the gpg's commands we are using do not seem to be too complicated for the users. I do not see a problem on using it, just think that we might be making the process even more complex. What do you think?\n\nAlso, there are some things missing:\n\n- Section on how to use url@server\n- Section on how to post no Newsgroups (maybe mailing lists too?)\n\nThanks!"},{"author":"HulaHoop","date_created":1436841364,"date_modified":1436841364,"content":">Isn't it this part?\n\nYes but I missed because it was differently phrased. I don't think it matters to compare anonymity types, more can never hurt :)\n\n>On the sub-section 3.6 Send Mail with Registered Nym, I forgot to instruct the user to sign the message. Unfortunately I did not find a way to sign and encrypt \"simultaneously\" with KGpg equivalent to gpg -aesr server file. I believe that doing separately with KGpg, by composing, signing and only after that encrypting would work, but haven't tested it yet. But I guess that in the case of this guide, using a GUI as KGpg isn't helping much. It might be even more confusing because we are not giving any screenshots, and the gpg's commands we are using do not seem to be too complicated for the users. I do not see a problem on using it, just think that we might be making the process even more complex. What do you think?\n\nAgreed. I prefer the commandline myself and find it most straight forward to do these steps anyhow. As long as everything is documented (as you have done) it should be easy for anyone to apply it by pasting them in the terminal.\n\n>Also, there are some things missing:\n>\n>    Section on how to use url@server\n>    Section on how to post no Newsgroups (maybe mailing lists too?)\n\nWould be great additions. Yes posting to mailing lists is a very useful usecase too.\n\nThanks Felipe!"},{"author":"dau","date_created":1436903598,"date_modified":1436903598,"content":"\n>>! In T374#5925, @HulaHoop wrote:\n> I haven't tried it before but could this work? \n> \n> https://en.wikipedia.org/wiki/Help:Section#Section_linking_and_redirects\n> https://en.wikipedia.org/wiki/Help:Wiki_markup#Lists\n\nI was able to user Anchors to reference the sub-sections, but apparently we can't  create ordered lists with content between the items. They must be in the format:\n\n\n```\n# Item 1\n# Item 2\n```\n\nDoing something like:\n\n\n```\n# Item 1\n\nInstructions, quotes, etc\n\n# Item 2\n```\n\nWill be interpreted as 2 separate lists.\n\n>>! In T374#5927, @HulaHoop wrote:\n> Yes but I missed because it was differently phrased. I don't think it matters to compare anonymity types, more can never hurt :)\n\nI actually do not remember what was written there before, but you can add more stuff to it.\n\n> Agreed. I prefer the commandline myself and find it most straight forward to do these steps anyhow. As long as everything is documented (as you have done) it should be easy for anyone to apply it by pasting them in the terminal.\n\nI just made some changes. Removed he KGpg instrctions and left gpg's only.\n\nAlso improved some steps.\n\nOh, and I believe that the `Message Path` section should be removed from the instructions and become a subsection of the main section.\n\nThanks!"},{"author":"HulaHoop","date_created":1436927719,"date_modified":1436927719,"content":">I just made some changes. Removed he KGpg instrctions and left gpg's only.\n>\n>Also improved some steps.\n>\n>Oh, and I believe that the Message Path section should be removed from the instructions and become a subsection of the main section.\n\nLooks good.\n\nI moved the Message Path into its own section above Instructions to give an overview. Do you think this is the right place?"},{"author":"dau","date_created":1436964998,"date_modified":1436964998,"content":"> I moved the Message Path into its own section above Instructions to give an overview. Do you think this is the right place?\n\nI believe so :)\n\nMaybe the only thing we have left to finish the instructions is to number the steps. Unfortunately it looks like we will have to use constants :/\n\nI think that in the future we can add more theory related to Nymservers, instead of just a tutorial.\n\nThanks HulaHoop!"},{"author":"HulaHoop","date_created":1436987230,"date_modified":1436987230,"content":"Thanks a lot Felipe, you've done a great job. \n\nIn the future I'll show you any additions I make first, to get your opinion."},{"author":"HulaHoop","date_created":1437057929,"date_modified":1437057929,"content":"Steve explained to me a some things about aam2mail. I think it belongs under the Important section because its related to multiple nyms. What do you think?\n\n For now I'll focus on testing Nymphemeral.\n\n\n> In aam2mail, there are 3 config files where you list Subjects you want\n> to extract from aam.  Those files are:\n> \n> subject_plain\n> subject_esub\n> subject_hsub\n> \n> You can use one or more config files simultaniously and each can have an\n> unlimited number of subjects to search for.  In reality, most people\n> probably only have a single Nym so they'd only put create one file and\n> that would contain a single line.\n> \n> If my hsub secret is \"bananasplit show\", I would create subject_hsub and\n> put a single line in it with that secret.\n> \n> The master config file is .aam2mailrc and it resides in the user's\n> homedir.  The locations of the subject config files, along with other\n> settings can be defined in there.  By default, they are:-\n> \n> $HOME/aam2mail/etc/subject_plain\n> $HOME/aam2mail/etc/subject_esub\n> $HOME/aam2mail/etc/subject_hsub\n\n\n\n"},{"author":"dau","date_created":1437072041,"date_modified":1437072041,"content":">>! In T374#5936, @HulaHoop wrote:\n> Thanks a lot Felipe, you've done a great job. \n\nSo have you :)\n \n> In the future I'll show you any additions I make first, to get your opinion.\n\nAlright! Just remember that I know these things because I've been working on nymphemeral for a while, but I am far from being an expert. More people reviewing that section are welcome.\n\n>>! In T374#5939, @HulaHoop wrote:\n> Steve explained to me a some things about aam2mail.\n\nCool! It would be awesome if he could review the whole Nymservers section.\n\n> I think it belongs under the Important section because its related to multiple nyms. What do you think?\n\nI think it would be more consistent to add it to aam2mail's sub-section, however, I think that it would make the guide longer and more complex. I agree on adding them to the important notes. But if possible, add a line under aam2mail mentioning there is more info at the end.\n\n> For now I'll focus on testing Nymphemeral.\n\nAwesome! I appreciate your help :)\n\nThanks!"},{"author":"HulaHoop","date_created":1438704208,"date_modified":1438704208,"content":"I asked Steve Crook about nymserver attachment support a while back and yet to receive a reply.\n\nResearched attachment support for remailers and apparently most (all?) Mixmaster nodes set the option to filter binary attachments, so I'm guessing the message with the attachment never makes it to the nymserver.\n"},{"author":"HulaHoop","date_created":1439136417,"date_modified":1439136417,"content":"I did some more testing to confirm:\n\n* Nymservers do support attachments. Any files attached in a conventional message are converted into base64 encoded text appended to the end of the message body:\n\nAn example message send to a nym address looks like so:\n\n\n> \n> Return-Path: <sender@openmailbox.org>\n> X-Original-To: gpgkey@mixnym.net\n> Delivered-To: nymserv@mixmin.net\n> Received: by snorky.mixmin.net (Postfix, from userid 110)\n> \tid 79C8CEA9FE; Thu,  6 Aug 2015 03:54:10 +0100 (BST)\n> Authentication-Results: snorky.mixmin.net; dkim=pass\n> \treason=\"1024-bit key; unprotected key\"\n> \theader.d=openmailbox.org header.i=@openmailbox.org\n> \theader.b=jxVZmrGS; dkim-adsp=pass; dkim-atps=neutral\n> X-Spam-Checker-Version: SpamAssassin 3.4.0 (2014-02-07) on snorky.mixmin.net\n> X-Spam-Level: *\n> X-Spam-Status: No, score=1.7 required=5.0 tests=BAYES_00,DKIM_SIGNED,\n> \tDKIM_VALID,DKIM_VALID_AU,MISSING_SUBJECT,RP_MATCHES_RCVD,SPF_PASS,\n> \tTVD_SPACE_RATIO,ZIP_ATTACHED autolearn=no autolearn_force=no version=3.4.0\n> Received: from smtp11.openmailbox.org (smtp11.openmailbox.org [62.4.1.45])\n> \t(using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))\n> \t(No client certificate requested)\n> \tby snorky.mixmin.net (Postfix) with ESMTPS id A7ADAEA9FC\n> \tfor <gpgkey@mixnym.net>; Thu,  6 Aug 2015 03:54:09 +0100 (BST)\n> Received: from localhost (localhost [127.0.0.1])\n> \tby mail2.openmailbox.org (Postfix) with ESMTP id E08AD2007BF\n> \tfor <gpgkey@mixnym.net>; Thu,  6 Aug 2015 04:54:08 +0200 (CEST)\n> DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=openmailbox.org;\n> \t h=content-type:content-type:mime-version:user-agent:from:from\n> \t:date:date:message-id:received; s=openmailbox; t=1438829647; bh=\n> \tAlR5Q3gNwD44W+b71sF2B5wlpZMbiDFQ8Uz5pSL1rQA=; b=jxVZmrGSEzLW6EbA\n> \tz39ArFcBmcWtxto0NIM6r8NjQ1VoS5DUxyZw9nQIyX2CJNz0OTjaG76eXtq4mSqa\n> \tWwGDzS93/jtbYrrnoOSW4w4xVR2uMOdNq+aQ4OOxdLHgkB5UFfY4GfOvWkEdqm3h\n> \tM0+59GbCqype28Bsuis0cAu3zEw=\n> X-Virus-Scanned: amavisd-new at openmailbox.org\n> Received: from mail2.openmailbox.org ([62.4.1.33])\n> \tby localhost (mail.openmailbox.org [127.0.0.1]) (amavisd-new, port 10026)\n> \twith ESMTP id 7y7gj3rgfqTP for <gpgkey@mixnym.net>;\n> \tThu,  6 Aug 2015 04:54:07 +0200 (CEST)\n> Message-ID: <55C2CC41.6090901@openmailbox.org>\n> Date: Thu, 06 Aug 2015 02:53:53 +0000\n> From: sender <sender@openmailbox.org>\n> User-Agent: Mozilla/5.0 (X11; Linux i686; rv:31.0) Gecko/20100101 Icedove/31.7.0\n> MIME-Version: 1.0\n> To: gpgkey@mixnym.net\n> Content-Type: multipart/mixed;\n>  boundary=\"------------060803030505030804000703\"\n> \n> This is a multi-part message in MIME format.\n> --------------060803030505030804000703\n> Content-Type: text/plain; charset=utf-8\n> Content-Transfer-Encoding: quoted-printable\n> \n> message body\n> \n> --------------060803030505030804000703\n> Content-Type: application/zip;\n>  name=\"Text File.zip\"\n> Content-Transfer-Encoding: base64\n> Content-Disposition: attachment;\n>  filename=\"Text File.zip\"\n> \n> UEsDBBQACAAIAAsVBkcAAAAAAAAAAAsAAAAJACAAVGV4dCBGaWxlVVQNAAcXycJVF8nCVRfJ\n> wlV1eAsAAQToAwAABOgDAABT4CpJrShRSMvMSQUAUEsHCGeFU+wNAAAACwAAAFBLAQIUAxQA\n> CAAIAAsVBkdnhVPsDQAAAAsAAAAJAA0AAAAAAAAAAACkgQAAAABUZXh0IEZpbGVVVAUABxfJ\n> wlV1eAAAUEsFBgAAAAABAAEARAAAAGQAAAAAAA==\n> --------------060803030505030804000703--\n\n\n\n\n* The attachment is then reconstructed by copying the base64 encoded text into a separate text file and running this command\n\n\n\n> base64 --decode \"1439126421.M839822P8316Q1.host\" > File.zip\n\n\n\n\n* Mixmaster nodes don't support attaching binary attachments outside the message body. The only way to send attachments is inline encoded in base64 with this command:\n\n\n\n> base64 \"filename.extension\"\n\n\n\nThe sender must specify to the recipient what kind of file it is so they can correctly reconstruct it with base64 on the other side."},{"author":"HulaHoop","date_created":1439153360,"date_modified":1439153360,"content":"Some bash scripts to automate the conversion and appending of attachments inline:\n\nhttp://backreference.org/2013/05/22/send-email-with-attachments-from-script-or-command-line/\n\nhttp://www.thegeekstuff.com/2009/12/how-to-send-an-email-with-attachment-and-body-from-linux/"},{"author":"dau","date_created":1439260632,"date_modified":1439260632,"content":">>! In T374#6341, @HulaHoop wrote:\n> * Nymservers do support attachments. Any files attached in a conventional message are converted into base64 encoded text appended to the end of the message body:\n\n> * Mixmaster nodes don't support attaching binary attachments outside the message body. The only way to send attachments is inline encoded in base64\n\nThanks for looking into that. That's great!\n\nThe message you posted is the one that has been processed by the server, but how does the message you composed look like? Something like the following?\n\n```\nTo: send@server\n\n-----BEGIN PGP MESSAGE-----\nTo: recipient@domain\n\nmessage\n\nattachment\n-----END PGP MESSAGE-----\n```\n\nIt's better if Mixmaster isn't even aware of the attachments if they are sent inline and then the whole message encrypted to the server. All it would see would be just a long PGP message, as the example above.\n\nSimilarly, if the nym and the recipient use end to end encryption to communicate, then the server would see just another PGP message:\n\n```\nTo: send@server\n\n-----BEGIN PGP MESSAGE-----\nTo: recipient@domain\n\n-----BEGIN PGP MESSAGE-----\nmessage\n\nattachment\n-----END PGP MESSAGE-----\n\n-----END PGP MESSAGE-----\n```\n\nIf neither Mixmaster, nor the nymserver reject long messages, then that's probably the best approach so that we do not leak the attachments' metadata. An adversary would just know that the message //probably// has attachment(s) because of its size, but that would be all, right?\n\n>>! In T374#6342, @HulaHoop wrote:\n> Some bash scripts to automate the conversion and appending of attachments inline:\n> \n> http://backreference.org/2013/05/22/send-email-with-attachments-from-script-or-command-line/\n> \n> http://www.thegeekstuff.com/2009/12/how-to-send-an-email-with-attachment-and-body-from-linux/\n\nThanks! I'll take a look at those."},{"author":"HulaHoop","date_created":1439301840,"date_modified":1439301840,"content":"> The message you posted is the one that has been processed by the server, but how does the message you composed look like? Something like the following?\n\nYes.\n\n> An adversary would just know that the message probably has attachment(s) because of its size, but that would be all, right?\n\nYes exactly :)\n\n***\n\nRemailers have a message size limitation specified as \"klen\" in their caps strings in the rlist.txt. The highest limit I saw on there is a klen of 1024 so I think this means a message of 1 mb in size. Any messages exceeding the limit are silently discarded.\n\nhttp://alt.privacy.anon-server.narkive.com/Nq6lzluz/size-limit-for-qsl-message\n\nhttps://groups.google.com/forum/?_escaped_fragment_=topic/alt.privacy.anon-server/6qPze6ehjAM#!topic/alt.privacy.anon-server/6qPze6ehjAM\n\nhttp://pinger.mixmin.net/rlist.txt\n\nRealistically the message size should be limited to 1000 to account for message padding to keep under the 1024 limit. Nymphemeral could parse rlist.txt to choose hops that support this maximum size or choose a node selection based on attachment size which will be harder. Say, if a message's size doesn't exceed 200 kb then Nymphemeral selects any remailer from rlist that supports 200+ (these nodes becomes eligible in its path selection and so on).\n\nThe small attachment limit makes them not optimal but they're still good to have."},{"author":"HulaHoop","date_created":1439334718,"date_modified":1439334718,"content":"I looked up more information and there are ways around the message limits. On usenet groups like alt.binaries people got around message size limits and the lack of binary file support by using dedicated programs that manage spliting and reconstruction of files into multi-part base64 messages. \n\nhttp://linux.die.net/man/1/uuenview\nhttp://linux.die.net/man/1/uudeview\n\nThe -lines parameter is useful here:\n\n> -lines\n>\n> Substituting lines with a number, sets the maximum number of encoded lines per part. The encoded data is automatically split into as many parts as required. Line counts less than 200 are ignored. The uuencoding and xxencoding methods encode 45k, and Base64 encodes 57k of data in 1000 lines. If this option is not specified, the default is unlimited lines per part, resulting in exactly one part. \n\nNymphemeral could just consider the lowest limit on message size in rlist when splitting/assembling attachments and not have to do any more difficult work selecting node paths because of different permitted size limits."},{"author":"dau","date_created":1439394914,"date_modified":1439394914,"content":"Thanks HulaHoop! That's very interesting.\n\nI've been busy, but I will read more about how to implement attachments on nymphemeral as soon as I can. One problem that I can think of right now is handling these parts from messages that do not arrive at the same time. nymphemeral will probably attempt to decode every message and keep them until it works. We do allow the users to save messages, but keeping stuff on disk is not very recommended. I do not see another option though.\n\nI'll let you know once I find a solution.\n\nThanks!"},{"author":"Patrick","date_created":1446139876,"date_modified":1446139876,"content":"What is the status of this #user_documentation ticket?"},{"author":"HulaHoop","date_created":1446156626,"date_modified":1446156626,"content":"The documentation is done and polished but there's parts about ideas for Nymphemeral that I should have opened another ticket for. Do you want to split the topic or change its title?"},{"author":"Patrick","date_created":1446156755,"date_modified":1446156755,"content":"split"},{"author":"Patrick","date_created":1450650681,"date_modified":1450650681,"content":"It's not yet added to https://www.whonix.org/wiki/Documentation. Please also check from which other places, linking it would be useful."},{"author":"HulaHoop","date_created":1450733028,"date_modified":1450733028,"content":"Done. Is there an easier way to add entries without having to change all tag numbers of entries that come after it?"},{"author":"Patrick","date_created":1450734220,"date_modified":1450734220,"content":"Just use a normal link.\n\n[[wiki page|link description]]"},{"author":"Patrick","date_created":1450734626,"date_modified":1450734626,"content":"Please don't change these numbers - because now there is a duplicate number 103 - which will cause issues. These numbers are up to the translations coordinator (Ego)."},{"author":"HulaHoop","date_created":1450736503,"date_modified":1450736503,"content":"I removed the number tags and left it in as a normal link."}]},"PHID-TASK-xclhdyi75ytd57hfmcbr":{"id":"373","title":"Qubes templates: graphical updater (Apper) broken","status":"resolved","priority":"Normal","author":"Patrick","description":"__Issue__:\n\nThe graphical updater (Apper) broken is broken. It reports no upgrades, even if there are upgrades.\n\n__prerequsite knowledge__:\n\n* apt-get upstream bugs: https://www.whonix.org/wiki/Dev/Automatic_Updates#apt-get_upstream_bugs\n* Security Issues when using apt-get update in Scripts: https://www.whonix.org/wiki/Dev/Automatic_Updates#apt-get_upstream_bugs\n* apper has proven to be too buggy in previous versions of Whonix: https://www.whonix.org/wiki/Dev/Automatic_Updates#apper_.28kde.29_package\n* secure apt-get automation is difficult for many reasons: https://www.whonix.org/wiki/Dev/Automatic_Updates#Simplified_Assisted_Updates\n\n__TODO decision__:\n\n* On https://www.whonix.org/wiki/Dev/Automatic_Updates I'll explain, why graphical updaters are insecure. Should we remove Apper?\n\n__TODO technical__:\n\n* remove apper?\n* remove apper menu entry?\n","comments":[{"author":"nrgaway","date_created":1435975943,"date_modified":1435975943,"content":"I have not tested it lately, but the same goes for the regular Debian templates ... sort of.\n\nI wait about 6 minutes after starting the TemplateVM and try the update, it works.  There is a timer that goes off 5 minutes after template is started that does an `apt-get update`.  When the template is first started, that has not happened yet.\n\nMay be worth while to see if `Apper` can do an update first, or add a wrapper to do it."},{"author":"Patrick","date_created":1435977994,"date_modified":1435977994,"content":"(Messed up ticket description. Fixed now.)\n\nOn https://www.whonix.org/wiki/Dev/Automatic_Updates I'll explain, why graphical updaters are insecure, a usability mess and why replacements have a scope of maintain a complete separate upstream project. I think in the absence of secure and usable gui utilities, we should avoid them and refer to cli tools. That's awful, but the only workable secure choice I can see at this time.\n\nAn Apper security issue...\n\nFunctional sources.list snippet.\n```\ndeb http://security.debian.org wheezy/updates main contrib non-free\n```\n\nNon-functional sources.list snippet with a purposed typo for demonstration purposes.\n```\ndeb http://ecurity.debian.org wheezy/updates main contrib non-free\n```\n\nApper won't complain about this. Therefore with a trivial DNS based denial of service, a user can be prevented to fetch security updates. Therefore in my opinion Apper disqualifies for an update gui for a security focused operating system."},{"author":"nrgaway","date_created":1435982155,"date_modified":1435982155,"content":"Or what about writing some utility, maybe even part of a wrapper that verifies the source.list sources first?\n\nApper will notify you if a package is not signed."},{"author":"Patrick","date_created":1436048983,"date_modified":1436048983,"content":"> maybe even part of a wrapper that verifies the source.list sources first?\n\nBtw, it's not just about messed up sources.list. This was only a cheap trick to demonstrate the issue. The same would happen if an access level (wifi) or ISP level adversary would run an active man-in-the-middle attack preventing the connectoin to the security repository.\n\nI guess a simple sanity test, checking if the right security repository is enabled in sources.list would be a good feature for whonixcheck or some other maybe-existing more general security check tool for Debian.\n\nThe code for finding typos that lead to DNS or connection errors might be already written. (packagekit)\n\n> Or what about writing some utility,\n\nIt's a huge task of the size of a separate project.\n\nTried to explain why this is difficult to invent a secure gui based apt-get upgrader in this very chapter: https://www.whonix.org/wiki/Dev/Automatic_Updates#One_click_upgrade_button_for_Debian_packages.\n\nFew more keywords to illustrate why this is a complex project... It follows a list of stuff from the top of my head that is difficult to handle in a gui upgrader\n\n* debconf questions\n* [dpkg interactive conflict resolution dialog](https://www.whonix.org/wiki/Whonix_Configuration_Files#dpkg_interactive_conflict_resolution_dialog)\n* DNS failures\n* connection failures (ISP's preventing connections to apt repositories for whatever reason; targeted attacks)\n* installation issues due to broken dependencies\n* hold back packages\n* notifications about packages available for autoremoval\n* packages in Debian stable, that that have no security support (T135)\n* slow retrival attacks (Defined by [TUF: Attacks and Weaknesses](https://github.com/theupdateframework/tuf/blob/develop/SECURITY.md) ([w](http://www.webcitation.org/6F7Io2ncN)).)\n* endless data attacks (Defined as per TUF.)\n* retrieved package release who's [valid-until field](http://blog.ganneff.de/blog/2008/09/23/valid-until-field-in-release-f.html) [when forgotten to refresh the repository, eventual roll back (TUF) or indefinite freeze (TUF) attack]\n* invalid signatures\n* expired signing keys\n* interrupted upgrades\n* failing Debian maintainer scripts\n* locked apt (some other process still using apt or died)\n* permission issues\n\nInstead of inventing yet another gui upgrader - which is a giant task to do securely - I think that time should be rather used to work on the fixing the existing ones. Such as apper or (ubuntu-)software-center. (software-center was ported to Debian wheezy, but didn't make into Debian jessie.)\n\nUpdating using a gui is really pretty. Works in many cases. But in the corner cases, you have to refer users back to console based apt-get upgrades. Since secure upgrades are currently not possible using gui tools, because the existing ones don't handle [at least inform] many failures, I think the reasonable thing for security focused Debian derivatives is to train users to use apt-get command line. They get to know how it's normally looking and are more likely to notice any issues.\n\nHowever, what could be done and with reasonable work and maintenance effort would be a secure gui update notification tool. Using a [/usr/lib/apt-get-wrapper](https://github.com/Whonix/whonixcheck/blob/master/usr/lib/apt-get-wrapper) like approach. Just notification if updates are available or not. Like whonixcheck does. No actual apt-get upgrade."},{"author":"nrgaway","date_created":1436056339,"date_modified":1436056339,"content":"I agree inventing a new gui updater is not ideal.\n\nOut of the available ones, which handles the most `keyword` items?  Anything lacking we can write a wrapper or make changes, patches and push upstream.\n\nOne thing we are tasked with is making it easier for end user to use.  There are different use cases for different types of users, but I believe requiring a user to user any command line is not friendly at all, but may be required for certain use case where security is essential.\n\nSo is the a GUI that fits most of our needs; especially one like Apper that is already available."},{"author":"Patrick","date_created":1436060303,"date_modified":1436060303,"content":"Agreed, cli usage is user unfriendly. Crystal clear. No argument from me. One of the main reasons why mainstream users are scared of Linux distributions.\n\n-----\n\nI can do my best testing for `keyword` items, reporting bugs upstream. (Once we picked a gui upgrader.) Could you attach patches to those in python or C++? (Depending on which one we choose?)\n\n-----\n\nChoosing one is not simple. It's not just about `keyword` items.\n\nLet's brainstorm more criteria for choosing which one deserves our contributions...\n\n* `keyword` items\n* language written in for simplicity of patches: I guess you prefer python over C and C++?\n* language written in for security: python preferred over C\n* future proof: Is the project going to be abandoned anytime soon?\n* usability of the tool\n* responsiveness upstream: How cooperative upstream is, how well you get along with them.\n* activity upstream: If they're still alive, active and kicking or if the project is barely left alive.\n* source code management used by upstream: git or bazzar or worse?\n* dependencies: okay to depend on KDE or so?\n* packages already in Debian [/ Fedora] repository: Work saving, if already packaged there, so the packaging work and getting it upstream is already done.\n\n-----\n\nA few I have in mind:\n\nubuntu-software-center\n** Good: usability, Last time I checked, it was the most pretty one. Best usability - apart from it's bugs such as crashes. Maybe they fixed that.\n** Good: written in python\n** Bad: Has \"ubuntu\" in it's name. Doesn't demonstrate their interest in having it work well in Debian.\n** Bad: (imho) using bazzar. [Perhaps I am too lazy, ignorant and wouldn't know why they bother with something other than git.]\n** Bad: Not in Debian repository. (Removed since jessie.)\n** Question: It's also political. Would you like to try to talk ubuntu-software-center developers about becoming agnostic, fully supporting debian?\n\nSynaptic:\n** Bad: Old. Usability sux imho. Not much progress over the years.\n\nApper:\n** Bad: dependencies: depends on KDE\n** Bad: written in C++\n** Medium: usability, oh well...\n** Good: Using packagekit by freedesktop.org, the ones who care about standards and doing things the-right-way(tm)\n\ngnome-packagekit:\n** Bad: written in C\n** usability: worse than Apper?\n\nLooks like there are not that many to choose from.\n"},{"author":"mfc","date_created":1436322438,"date_modified":1436322438,"content":"Don't forget Muon, which is Qt-based, at least Kubuntu uses it. Could be\nworth evaluating.\n\nList of more:\nhttps://en.wikipedia.org/wiki/Advanced_Packaging_Tool#Front-ends\n\nPatrick (Patrick Schleizer):\n> Patrick added a comment.\n> \n> Agreed, cli usage is user unfriendly. Crystal clear. No argument from me. One of the main reasons why mainstream users are scared of Linux distributions.\n> \n> -----\n> \n> I can do my best testing for `keyword` items, reporting bugs upstream. (Once we picked a gui upgrader.) Could you attach patches to those in python or C++? (Depending on which one we choose?)\n> \n> -----\n> \n> Choosing one is not simple. It's not just about `keyword` items.\n> \n> Let's brainstorm more criteria for choosing which one deserves our contributions...\n> \n> - `keyword` items\n> - language written in for simplicity of patches: I guess you prefer python over C and C++?\n> - language written in for security: python preferred over C\n> - future proof: Is the project going to be abandoned anytime soon?\n> - usability of the tool\n> - responsiveness upstream: How cooperative upstream is, how well you get along with them.\n> - activity upstream: If they're still alive, active and kicking or if the project is barely left alive.\n> - source code management used by upstream: git or bazzar or worse?\n> - dependencies: okay to depend on KDE or so?\n> - packages already in Debian [/ Fedora] repository: Work saving, if already packaged there, so the packaging work and getting it upstream is already done.\n> \n> -----\n> \n> A few I have in mind:\n> \n> ubuntu-software-center\n> \n> - Good: usability, Last time I checked, it was the most pretty one. Best usability - apart from it's bugs such as crashes. Maybe they fixed that.\n> - Good: written in python\n> - Bad: Has \"ubuntu\" in it's name. Doesn't demonstrate their interest in having it work well in Debian.\n> - Bad: (imho) using bazzar. [Perhaps I am too lazy, ignorant and wouldn't know why they bother with something other than git.]\n> - Bad: Not in Debian repository. (Removed since jessie.)\n> - Question: It's also political. Would you like to try to talk ubuntu-software-center developers about becoming agnostic, fully supporting debian?\n> \n> Synaptic:\n> \n> - Bad: Old. Usability sux imho. Not much progress over the years.\n> \n> Apper:\n> \n> - Bad: dependencies: depends on KDE\n> - Bad: written in C++\n> - Medium: usability, oh well...\n> - Good: Using packagekit by freedesktop.org, the ones who care about standards and doing things the-right-way(tm)\n> \n> gnome-packagekit:\n> \n> - Bad: written in C\n> - usability: worse than Apper?\n> \n> Looks like there are not that many to choose from.\n> \n> \n> TASK DETAIL\n>   https://phabricator.whonix.org/T373\n> \n> EMAIL PREFERENCES\n>   https://phabricator.whonix.org/settings/panel/emailpreferences/\n> \n> To: Patrick\n> Cc: HulaHoop, Patrick, nrgaway, marmarek, mfc, MemoryLost, WhonixQubes, troubadour\n>"},{"author":"bnvk","date_created":1436454824,"date_modified":1436454824,"content":"I definitely agree that the faster a FOSS OS can get to a GUI\ninstaller / updater, the fast it will gain user adoption. CLI 's\nare rife with so many challenges for a user.\n\nI don't know enough about these options as I'm still a recovering\nMac user (just started with Qubes OS), but the Ubuntu one\n*sounds* the best, except for the coupled to Ubuntu challenge :-)\n\nGreat criteria. Big+ for opting for Python instead of C!"},{"author":"Patrick","date_created":1436545151,"date_modified":1436545151,"content":"From a usability point of view, ubuntu-software-center is the most, if not the only, ambitious and serious one.\n\nI think this should become a proper, generic, distribution agnostic [maybe Debian only] upstream project. It is too important and difficult security wise to have this as a quick and dirty Qubes-only patchset. By having it available in Debian, therefore by a lot derivative distributions, much more people would look into this.\n\nAre you up for probably maintaining software-center in Debian? @nrgaway? Or is this too much of a daunting, mammoth task? Or would we require a dedicated developer for this?\n"},{"author":"nrgaway","date_created":1436547254,"date_modified":1436547254,"content":"I will have to take a look at the current source of `software-center` and play around with it a bit to be able to provide that answer.  I will look into it this weekend :)"},{"author":"HulaHoop","date_created":1436579256,"date_modified":1436579256,"content":"Is software-center subject to Canonical's CLA? The political problems with their licensing is one part. The other is most of their solutions are usually a product of NIH syndrome, are not designed with any other distro in mind but Ubuntu and they end up as abandonware while Canonical moves onto their next thing.\n\nFor long-term you might want to invest your effort in an upstream that has a track record of dedication for their software."},{"author":"Patrick","date_created":1436883073,"date_modified":1436883073,"content":">>! In T373#5894, @nrgaway wrote:\n> I will have to take a look at the current source of `software-center` and play around with it a bit to be able to provide that answer.  I will look into it this weekend :)\n\nWhat's your conclusions?"},{"author":"nrgaway","date_created":1436894635,"date_modified":1436894635,"content":"I did have a look at the software over the weekend, which BTW is GNU GPL v3 licensed. \n\nI don't think it would be too much of a task to maintain `software-center` in Debian but I have concerns about supporting `software-center` being:\n\n- I am unsure if this would solve the `GUI update requirement`.  Now, I do not have Ubuntu installed to test, but isn't the `software-center` package just used to search and install packages?  From what I recall, Ubuntu still used `packagekit` or something similar to handle the updating process of packages.\n- As previously mentioned, it does not support Fedora or RPM package backend\n- A RPM backend could be added, but would take time to implement\n- there are many features of `software-center` we do not need (or do we) such as reviews and app purchases.  It adds an extra layer of complexity to configure for these features.\n- `software-center` is about 60,000 lines of code.  There are other solutions like `lubuntu-software-center` that may be worth considering as well.\n\nI think what makes most sense is to either report the security issues or fix `packagekit`'s `aptcc` backend for apt and submit upstream?"},{"author":"nrgaway","date_created":1436895119,"date_modified":1436895119,"content":"[[ https://anonscm.debian.org/cgit/pkg-packagekit/packagekit.git/tree/backends/aptcc | https://anonscm.debian.org/cgit/pkg-packagekit/packagekit.git/tree/backends/aptcc ]]"},{"author":"Patrick","date_created":1436912289,"date_modified":1436912289,"content":">* As previously mentioned, it does not support Fedora or RPM package backend\n>* A RPM backend could be added, but would take time to implement\n\nIn long term, not required. The plan is to throw out Fedora anyhow. Source:\nhttps://github.com/QubesOS/qubes-issues/issues/1054#issuecomment-119448165\n\n>* there are many features of software-center we do not need (or do we) such as reviews and app purchases. It adds an extra layer of complexity to configure for these features.\n\nAgreed. So this would require an if/else patch to have this code disabled on non-Ubuntu?\n\n> There are other solutions like lubuntu-software-center that may be worth considering as well.\n\nYes.\n\n> I think what makes most sense is to either report the security issues or fix packagekit's aptcc backend for apt and submit upstream?\n\nContributing to packagekit seems sensible in any case. Since most new graphical package managers seem to be based on packagekit nowadays. WIth respect to noninteractivness and no questions during installation (Hughsie's Law) they seem to have the right mindset."},{"author":"HulaHoop","date_created":1438098832,"date_modified":1438098832,"content":"https://www.phoronix.com/scan.php?page=news_item&px=Ubuntu-MATE-Drops-USC\n\n\n\n> This Ubuntu \"Software Store\" has already been removed from the daily images of this MATE desktop spin of Ubuntu, ahead of the 15.10 Alpha 2. Wimpress mentioned they have \"something else lined up by way of replacement\" but that it's not the Debian Synaptic UI. \n> \n> Martin Wimpress shared these details via this Google+ post. This decision only affects the Ubuntu MATE version and not other members of the Ubuntu family. The Ubuntu Software Center has been criticized recently for being bloated, not well maintained, and in need of a full rewrite.\n\n"},{"author":"Patrick","date_created":1440007399,"date_modified":1440007399,"content":"I am afraid to say, but apparently this one stalled without any long term plan on how to proceed."},{"author":"nrgaway","date_created":1440012068,"date_modified":1440012068,"content":"I am still working on this.  I spent 3 days on it a few weeks ago.  I ended up reviewing the source code of many packages, and did a short audit on packagekit and gnome-packagekit to find ways to resolve issue.\n\nStep one was to get gpk working in both Fedora and Debian.  It works in Debian, not so much in fc21 (well, it did not a few weeks ago).\n\nNext step was to get it to update dpkg index on start.  From what I can remember from memory and without reviewing my notes, the newer version of packagekit removed portions of the update code and relies on the `unattended-upgrades` package for periodic updates.\n\nI understand though that there is a way to force the index to update still in Debian when gpk is launched from gnome's settings menu; which I have not had success in locating yet.  I am going to install a HVM version of standard Debian and test there.\n\nOnce these steps are complete, we can apply any security patches to packagekit backend `aptcc`? (again from memory) and submit upstream.\n\nTimeline is October since I have other deadlines items to complete first but plan to work on this as often as time permits."},{"author":"mfc","date_created":1442837897,"date_modified":1442837897,"content":"Honestly I think this issue has ballooned into a bunch of different (but related) issues. \n\nThe \"prerequisite knowledge\", \"todo decision\", actually are in no way related to the issue at hand.\n\nRight now the GUI updater in Qubes doesn't work. We need to make it work. \"Work\" is defined as display updates when there are updates, and attempt to update those packages.\n\nGUI updater works in Debian, Fedora, Ubuntu, Kubuntu, Linux Mint, etc. Is it an issue with how Qubes interacts with Apper that can be fixed? Then let's fix whatever isn't working. Is it an issue with Apper itself that cannot be fixed? Then it sounds like the program doesn't do its intended functionality and it shouldn't exist. So then we can switch to another program.\n\nYes there are problems with exit codes, automation etc. Those seem to be more general issues with updaters, not related/intrinsic to GUI updaters. That is a longer term project. This issue is / should be about making Apper work in Qubes (just as poorly as it does in other distros)."},{"author":"Patrick","date_created":1442843568,"date_modified":1442843568,"content":"Your criticism and attempt to move this forward is well appreciated! Thanks for posting qubes issue [Templates can't be updated via GUI Package Updater / Apper](https://github.com/QubesOS/qubes-issues/issues/1197)!\n\nThe `worst case scenario` is defined as `noticing that updates are missing while thinking that updates have been applied` cannot be fixed with a quick fix.\n\n> Right now the GUI updater in Qubes doesn't work. We need to make it work. \"Work\" is defined as display updates when there are updates, and attempt to update those packages.\n\n> GUI updater works in Debian, Fedora, Ubuntu, Kubuntu, Linux Mint, etc. Is it an issue with how Qubes interacts with Apper that can be fixed? Then let's fix whatever isn't working. Is it an issue with Apper itself that cannot be fixed?\n\nIt's both.\n\n* 1) Qubes specific issues that makes it totally not work for most users.\n * https://github.com/QubesOS/qubes-issues/issues/1197\n * https://github.com/QubesOS/qubes-issues/issues/982\n * https://github.com/QubesOS/qubes-issues/issues/968\n* 2) I guesstimate the existing issues Apper [and other existing gui updaters] will sooner or later lead to the `worst case scenario` situation for ~40% of users. That leads to grave confusion in user support situations. Whonix used to have Apper installed by default but it has been removed just for this reason. (I'll made up that percentage out of experience with various installations of Apper on personal systems + Whonix support experiences.)\n\n> Then it sounds like the program doesn't do its intended functionality and it shouldn't exist. So then we can switch to another program.\n\nI don't think `work`ing alternatives to Apper are available for installation. Definition would not be fulfilled for the `display updates when there are updates` part for a big percentage of users.\n\n> Yes there are problems with exit codes, automation etc. Those seem to be more general issues with updaters, not related/intrinsic to GUI updaters. That is a longer term project. This issue is / should be about making Apper work in Qubes (just as poorly as it does in other distros).\n\nLet's use [Templates can't be updated via GUI Package Updater / Apper](https://github.com/QubesOS/qubes-issues/issues/1197) for the short time fix. And this ticket for the long time fix.\n\n-----\n\nUntil there is a long term fix (`work`ing, secure, usable gui updater), it boils down to a question of security vs usability. I only see two options:\n\n* a) The secure option with bad usability is fall back to cli updating until the long term fix is in place.\n* b) The insecure option with almost as bad usability (common `worst case scenario`) is the short time fix + Apper.\n\nUnless there is a dedicated developer working on the long term fix, I am very pessimistic. There probably won't be any remotely great solution to this issue."},{"author":"mfc","date_created":1442845068,"date_modified":1442845068,"content":"I think one workaround to bridge short-term & long-term may be to have the App Menu listing just be a shortcut to a terminal that runs apt-get update && apt-get upgrade (or yum update). \n\nWe can't expect the user to be able to type anything in the command line, but y/n for prompts I think is fine for a workaround."},{"author":"troubadour","date_created":1444142173,"date_modified":1444142173,"content":"A starting point to run a cli or GUI updater could be achieved with a minor modification in msgcollector.\n\nInstead of displaying whonixcheck results systematically, parse the message from `msgdispatcher`.\n- result OK (all green) -> do nothing\n- warning or error -> display a tray icon with a menu offering to show the error only, or the whole message, and (if apt-get reports that packages can be updated) an option to run `apt-get update && apt-get upgrade` in a terminal, for the time being. The tray icon being closed after the user close the GUI or the terminal.\n\nEven if an automatic upgrade in a terminal is not wanted, this approach would have the benefit of being less intrusive than the compulsory popup."},{"author":"Patrick","date_created":1542008867,"date_modified":1542008867,"content":"Apper no longer installed by default."}]},"PHID-TASK-u453s6e54ozazlvkpeu6":{"id":"372","title":"Qubes-Whonix Whonix-Workstation TemplateVMs block access to (torified) open internet","status":"invalid","priority":"Normal","author":"Patrick","description":"As of Qubes-Whonix 10, Qubes-Whonix Whonix-Workstation TemplateVMs are capable to connect to open internet (over Tor).\n\nIs it a bug or feature?\n\nI guess we should keep connections to torproject.org (Tor Browser updates, perhaps anonymity/connectivity check), Debian, Whonix and Qubes repository allowed, but block the rest? Similar to Qubes' default Fedora TemplateVM?","comments":[{"author":"Patrick","date_created":1437837954,"date_modified":1437837954,"content":"See also this post by @marmarek:\nhttps://groups.google.com/d/msg/qubes-users/l71lkxWc1c0/q214W9prb3QJ\n"},{"author":"Patrick","date_created":1458314748,"date_modified":1471206859,"content":"As discussed in [sys-whonix does not yet function was Qubes FirewallVM](https://forums.whonix.org/t/sys-whonix-does-not-yet-function-was-qubes-firewallvm/2239/3), in future TemplateVMs will not be needing their own NetVM anymore.\n\nRather than implementing this ticket `Qubes-Whonix Whonix-Workstation TemplateVMs block access to (torified) open internet`, the solution to this ticket is to wait for Qubes to implement the following tickets:\n\n* [implement qrexec based updates proxy](https://github.com/QubesOS/qubes-issues/issues/1815)\n* [set NetVM of TemplateVMs to none by default / make TemplateVMs non-networked by default](https://github.com/QubesOS/qubes-issues/issues/1858)"},{"author":"Patrick","date_created":1471300704,"date_modified":1471300704,"content":"Duplicate of T466."}]},"PHID-TASK-txz2pj6frb6rwadyv7t2":{"id":"371","title":"improve whonixcheck output in Qubes","status":"resolved","priority":"Normal","author":"Patrick","description":"Usability questions:\n\n1) If running in TemplateVM, ProxyVM or AppVM: Perhaps add this info to window title? [1]\n\n2) If running in StandaloneVM or TemplateBasedVM: Perhaps add this info to window title? [2]\n\n3) If running in a TemplateBasedVM, and if there are updates available: Explain how to start a TemplateVM to update. [3]\n\n-----\n\nTechnical questions:\n\n[1] (output of `qubesdb-read /qubes-vm-type`) [no question]\n\n[2] Is it possible to read from within a script if it is running within a StandaloneVM or TemplateBasedVM using `qubesdb-read` or so?\n\n[3] From within a TemplateBasedVM... Can a script find out the name of the TemplateVM it is based on using  `qubesdb-read` or so?\n","comments":[{"author":"nrgaway","date_created":1435975537,"date_modified":1435975537,"content":"Yes to all the questions\n\n```\n# QUBESDB and PREFIX are used to access data in Qubes database.  The interfaces\n# to the database has changed in Release 3, so these vars will contain the proper\n# program and syntax to use when accessing the database.\n\n    # Qubes R3\n    if which qubesdb-read > /dev/null; then\n        QUBESDB=qubesdb\n        PREFIX='/'\n\n    # Qubes R2\n    else\n        QUBESDB=xenstore\n        PREFIX=''\n    fi\n```\n\nTo read host name in R3:\n```\nqubesdb-read /name\n```\n\nTo read VM type in R3:\n```\nqubesdb-read /qubes-vm-type\n```"},{"author":"Patrick","date_created":1435977448,"date_modified":1435977448,"content":"There are two technical questions still open. I'll restate/clarify those.\n\n[2] Is it possible to read from within a script if it is running within a StandaloneVM or TemplateBasedVM using qubesdb-read or so? I mean something like `qubesdb-read /standalone` -> `yes`, `no` or `qubesdb-read /template-based` -> `yes`, `no`.\n\n[3] From within a TemplateBasedVM... Can a script find out the name of the TemplateVM it is based on using qubesdb-read or so? `qubesdb-read /name` -> `my-whonix-gw-proxyvm` is fine, but not what I am asking here. More like this... `qubesdb-read /parent-template` -> `whonix-gw-experimental`."},{"author":"nrgaway","date_created":1435981940,"date_modified":1435981940,"content":">>! In T371#5858, @Patrick wrote:\n> There are two technical questions still open. I'll restate/clarify those.\n> \n> [2] Is it possible to read from within a script if it is running within a StandaloneVM or TemplateBasedVM using qubesdb-read or so? I mean something like `qubesdb-read /standalone` -> `yes`, `no` or `qubesdb-read /template-based` -> `yes`, `no`.\n\nI don't know if I understand the question. Are you trying to read from another VM from the one you are currently in?  For example, if your are in the Whonix Gateway ProxyVM, are you trying to read something from the TemplateVM?  If thats what you mean, no\n\nIf you mean you have a script running in the ProxyVM and are trying to figure out its hostname or type, the example I posted above is how you accomplish this.  \n\nqubes-whonix has code in /usr/lib/qubes-whonix/utility_functions.sh, replace-ips, and in the init directory a few of the scripts read as well.\n\nCheck out /usr/lib/qubes/init for examples as well.\n\n> [3] From within a TemplateBasedVM... Can a script find out the name of the TemplateVM it is based on using qubesdb-read or so? `qubesdb-read /name` -> `my-whonix-gw-proxyvm` is fine, but not what I am asking here. More like this... `qubesdb-read /parent-template` -> `whonix-gw-experimental`.\n\nI don't know this.\n\n"},{"author":"Patrick","date_created":1436046470,"date_modified":1436046470,"content":">>! In T371#5861, @nrgaway wrote:\n> I don't know if I understand the question. Are you trying to read from another VM from the one you are currently in?  \n\nFrom the VM the script is currently running in.\n\n> For example, if your are in the Whonix Gateway ProxyVM, are you trying to read something from the TemplateVM? \n\nNo.\n\n------\n\nI'll rephrase question [2]...:\n\nsome script running inside an some AppVM and asks: \"Am I a TemplateVM or StandaloneVM?\"\nqubesdb-read: replies \"You are a TemplateVM.\"\nor qubesdb-read: replies \"You are a StandaloneVM.\"\n"},{"author":"nrgaway","date_created":1436055223,"date_modified":1436055223,"content":">>! In T371#5865, @Patrick wrote:\n>>>! In T371#5861, @nrgaway wrote:\n>> I don't know if I understand the question. Are you trying to read from another VM from the one you are currently in?  \n> \n> From the VM the script is currently running in.\n> \n>> For example, if your are in the Whonix Gateway ProxyVM, are you trying to read something from the TemplateVM? \n> \n> No.\n> \n> ------\n> \n> I'll rephrase question [2]...:\n> \n> some script running inside an some AppVM and asks: \"Am I a TemplateVM or StandaloneVM?\"\n> qubesdb-read: replies \"You are a TemplateVM.\"\n> or qubesdb-read: replies \"You are a StandaloneVM.\"\n\nIn that case, Yes, example above state how to read what type of VM it is"},{"author":"Patrick","date_created":1436056526,"date_modified":1436056526,"content":"Doesn't work for me. Testing from inside a Standalone ProxyVM.\n\n`qubesdb-read /qubes-vm-type` -> `ProxyVM`\n\nBut I am looking for the info `StandaloneVM` (or `TemplateBasedVM` respectively)."},{"author":"nrgaway","date_created":1436057814,"date_modified":1436057814,"content":"Does for me:\n`qubesdb-read /qubes-vm-type` ->`TemplateVM`\n\nI don't have a standalone VM to test with, but I assume if it as a ProxyVM it reported properly.\n\nI don't know if you can identify if it's a standlone type or not.\n\nHere are available commands paths (`qubesdb-list /`):\n\n```\n.\nname\nqubes-block-devices\nqubes-debug-mode\nqubes-gateway\nqubes-ip\nqubes-keyboard\nqubes-netmask\nqubes-secondary-dns\nqubes-service/meminfo-writer\nqubes-timezone\nqubes-usb-devices\nqubes-vm-type\nqubes-vm-updateable\n```"},{"author":"Patrick","date_created":1436061114,"date_modified":1436061114,"content":"I have tried all of them. None reveals standalone or not."},{"author":"Patrick","date_created":1437834829,"date_modified":1437834829,"content":"Qubes upstream feature request...\n`qubesdb-read /qubes-template-type -> StandaloneVM / TemplateBasedVM`:\nhttps://github.com/QubesOS/qubes-issues/issues/1084\n"},{"author":"marmarek","date_created":1437855441,"date_modified":1437855441,"content":"Take a look here:\nhttps://www.qubes-os.org/doc/SystemDoc/VMInterface/\nEspecially `qubes-vm-updatable` is almost what you are looking for. It\nis True for StandaloneVMs and TemplateVMs. Later you can use\n`qubes-vm-type` to differentiate TemplateVM. In case of R3, you need '/'\nin front of those names.\n\nThere is no way to know template name from VM based on it. Ok, there are\nsome hacky way for that, not not something we want to use. Is there any\nuse case for such information?"},{"author":"Patrick","date_created":1438012958,"date_modified":1438012958,"content":">>! In T371#6039, @marmarek wrote:\n> Take a look here:\n> https://www.qubes-os.org/doc/SystemDoc/VMInterface/\n> Especially `qubes-vm-updatable` is almost what you are looking for. It\n> is True for StandaloneVMs and TemplateVMs. Later you can use\n> `qubes-vm-type` to differentiate TemplateVM.\n\nThis will do.\n\n> There is no way to know template name from VM based on it. Ok, there are\n> some hacky way for that, not not something we want to use. Is there any\n> use case for such information?\n\nYes. This is the existing whonixcheck update notification (which is sufficient for non-Qubes-Whonix):\n\n> [Debian Package Update](https://www.whonix.org/wiki/Update) Result: **apt-get reports that 15 packages can be updated.**\n> Please update Whonix-Gateway and Whonix-Workstation:\n> (Open a terminal, Start Menu -> Applications -> System -> Terminal.)\n> `sudo apt-get update && sudo apt-get dist-upgrade`\n\nI would like to update the Qubes specific update notification to improve usability. Something like this:\n\n> [Debian Package Update](https://www.whonix.org/wiki/Update) Result: **apt-get reports that 15 packages can be updated.**\n> Please update your Whonix-Gateway TemplateVM __whonix-gw-experimental__.\n> 1) Open a terminal, dom0 -> Start Menu -> __whonix-gw-experimental__ -> Terminal.\n> 2) Update. (`sudo apt-get update && sudo apt-get dist-upgrade`)\n> 3) Shutdown the Whonix-Gateway TemplateVM __whonix-gw-experimental__. (dom 0 -> Qubes VM Manager -> right click __whonix-gw-experimental__ -> Shutdown VM)\n> 4) Shutdown and restart this TemplateBased ProxyVM __sys-whonix__.\n> (dom 0 -> Qubes VM Manager -> right click __sys-whonix__ -> Shutdown VM)\n\n(Using underline for the ProxyVM __sys-whonix__, because that name can vary [can be freely choose by the user]. And using underline for the name of the template __whonix-gw-experimental__, because it differs from __whonix-ws__)\n\n(Maybe @bnvk has any advice for better wording of this message?)\n\nCurrent window title of whonixcheck for non-Qubes-Whonix:\n\n> whonixcheck | Whonix-Gateway | $whonix_deb_package_version | $(date)\n\nThat I would like to change for Qubes to something like.\n\n> whonixcheck | Whonix-Gateway (ProxyVM) (sys-whonix) (based on TemplateVM whonix-gw-experimental) | $whonix_deb_package_version | $(date)\n\nOr respectively.\n\n> whonixcheck | Whonix-Gateway (ProxyVM) (sys-whonix) (StandaloneVM) | $whonix_deb_package_version | $(date)\n"},{"author":"Patrick","date_created":1438022007,"date_modified":1438022007,"content":"`improved whonixcheck update notification output in Qubes`:\nhttps://github.com/Whonix/whonixcheck/commit/efb3f399548d20d739bf7a8a10aa1ff562c53e42\n\nscreenshot:\n{F251}\n"},{"author":"Patrick","date_created":1438696115,"date_modified":1438696115,"content":"* `/qubes-vm-persistence`\n* `/qubes-base-template`\n\n`Add template-related info to qubesdb`:\nhttps://github.com/QubesOS/qubes-issues/issues/1101\n"},{"author":"Patrick","date_created":1440006423,"date_modified":1440006423,"content":"No more can be done here, before...\n\n>>! In T371#6207, @Patrick wrote:\n> `Add template-related info to qubesdb`:\n> https://github.com/QubesOS/qubes-issues/issues/1101\n\n...gets implemented."},{"author":"Patrick","date_created":1441320931,"date_modified":1441320931,"content":"`improved output in Qubes by using 'qubesdb-read /qubes-base-template' `:\nhttps://github.com/Whonix/whonixcheck/commit/1d1ebc4ed98982d2dcfe396153c12a429b62887a\n"},{"author":"Patrick","date_created":1441322829,"date_modified":1441322829,"content":"`refactoring, ported from old 'qubesdb-read /qubes-vm-updateable' to new (https://github.com/QubesOS/qubes-issues/issues/1101) more readable 'qubesdb-read /qubes-vm-persistence'`:\nhttps://github.com/Whonix/whonixcheck/commit/442e94257bd3e3a07bb0f9f9d6ecbd1e8b5e5856\n"}]},"PHID-TASK-hhgvttnbnnv77cd5vjye":{"id":"370","title":"whonix_build and whonix_build_post should not end up in home folder","status":"resolved","priority":"Normal","author":"Patrick","description":"Issue with:\nhttps://github.com/nrgaway/qubes-template-whonix/blob/06d3e9577282bceabeac0ac0f3daac427b37c4e8/whonix-gateway/02_install_groups_pre.sh\n\nTwo files owned by root and up in user's home folder.\n\n* ~/whonix_build_post\n* ~/whonix_build\n\nThis is an unnecessary leftover. Bad for usability.\n\nA more appropriate folder should be chosen. Possible some sub folder under /var/lib or /var/cache?\n\nDeletion of these files however after the build process is undesireable. Good to keep for verification/audit purposes. Less magic. Easier to grasp.\n\nUnless... We can get rid of this temporary script creation altogether. (Related to: T369)\n","comments":[{"author":"Patrick","date_created":1440006511,"date_modified":1440006511,"content":"No longer the case with #Whonix_11."}]},"PHID-TASK-cr762krdg3sjodam5oah":{"id":"369","title":"/dev/shm, shared memory 'sem_open: Permission denied', prevent writing to /etc/fstab","status":"invalid","priority":"Normal","author":"Patrick","description":"Issue with:\nhttps://github.com/nrgaway/qubes-template-whonix/blob/169249cc18853e2e8bd44c409939a79399528625/whonix-gateway/02_install_groups_pre.sh#L104-107\n\n> Prevents Whonix makefile use of shared memory 'sem_open: Permission denied'\n\nNope. Whonix's build scripts are just bash scripts. No C/asm code. Terms like `/dev/shm`, `shared memory` or `sem_open` weren't on my mind, so no code is consciously making use of such stuff.\n\nI think a simple call of `dpkg-parsechangelog` caused this.\n\nWriting to `/etc/fstab` should be avoided.\n\nIf mounting of `/dev/shm` is required in chroot, it should be done during the chroot setup / unsetup. Not where currently.","comments":[{"author":"Patrick","date_created":1441468387,"date_modified":1441468387,"content":"This is related to deterministic packages and Whonix's use of `faketime`, which requires writing to `/dev/shm`.\n\nTo trigger this issue.\n\n```\nsudo -u user /home/user/Whonix/packages/anon-apt-sources-list/debian/gain-root-command debian/rules clean\n```\n\nOr unspecific to any packaging / Whonix.\n\n```\nsudo -u user faketime -f \"2013-08-15 11:02:35\" echo test\n```\n\n```\nsem_open: Permission denied\n```\n\nWorkaround.\n\n```\nchmod o+w /dev/shm\n```\n\nThe real solution is using a proper way to create deterministic packages. This means waiting until the [Debian ReproducibleBuilds toolchain](https://wiki.debian.org/ReproducibleBuilds/ExperimentalToolchain) has been merged into Debian."},{"author":"Patrick","date_created":1484727720,"date_modified":1484727720,"content":"Whonix's build script is no longer used to build Qubes-Whonix, so this is not required."}]},"PHID-TASK-xwolzsa2tatreatpwfll":{"id":"368","title":"whonixcheck should check if timezone is set to UTC","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1436535936,"date_modified":1436535936,"content":"`check if /etc/timezone and /etc/localtime are configured for UTC - https://phabricator.whonix.org/T368`:\nhttps://github.com/Whonix/whonixcheck/commit/07406526e8bade4c7546a2db03bd11f204141f17"}]},"PHID-TASK-yqype5py6btwbsd7p4xy":{"id":"367","title":"Mixmaster GUI Options","status":"wontfix","priority":"Normal","author":"HulaHoop","description":"The purpose of this ticket is to explore the GUI choices for Mixmaster and nymservers that run natively on Linux for documentation/inclusion for Whonix. The lack of GUIs and the complexity of using remailers made them not viable for most groups except those with degrees in Computer Science. This led to most users missing out on a great alternative to conventional email. Lack of adoption hurts the level of anonymity provided by the Mixmaster network.\n\nResearched choices:\n\n* Pyano - a simple python based webinterface by Paranoici a tech activist collective.\n\nhttp://pyanon.sourceforge.net\n\n\n* Nymphemeral - great python GUI. Well documented by the\nauthors. Feature-rich and optionally supports new nym server\ntypes that understand protocols like axolotl and forward secrecy.\n\nhttps://pypi.python.org/pypi/nymphemeral\nhttp://lists.mixmin.net/pipermail/remops/2014-September/001042.html\nhttps://moderncrypto.org/mail-archive/messaging/2014/000590.html\nhttp://k0rx.com/blog/2014/09/nymphemeral.html\nhttps://github.com/felipedau/nymphemeral\n\n\n\nTO-DO:\n\n* [s]Discuss code signing and upstream inclusion with nymphemeral dev - Done\n\nhttps://github.com/felipedau/nymphemeral/issues/3\n\n\n* [s]Contact Pyano devs and see if they can move from the Apache dependency to something smaller like libmicrohttpd (which is also packaged in Debian).\n\nhttps://www.whonix.org/pipermail/whonix-devel/2015-June/000378.html\n\n* Document secure install of nymphemeral when it becomes possible or see if it can be integrated into Whonix","comments":[{"author":"HulaHoop","date_created":1435683912,"date_modified":1435683912,"content":"Testing efforts will only be focused on nymphemeral because its the most promising. Takes care of the complexities of header formatting and newsgroup message retrieval.\n\nTesting Status report:\n\n\"Error while manipulating mix.cfg\"\nIts not clear what the conflict stems from. Expected settings and defaults between Whonix's Mixmaster instance and nymphemeral's installation advice could be the cause:\nhttps://nymphemeral.readthedocs.org/en/stable/install/mixmaster.html\n"},{"author":"dau","date_created":1435864386,"date_modified":1436555500,"content":"I am not sure if I should be posting here. But apparently I am allowed to.\n\n>>! In T367#5802, @HulaHoop wrote:\n> Testing efforts will only be focused on nymphemeral because its the most promising. Takes care of the complexities of header formatting and newsgroup message retrieval.\n> \n> Testing Status report:\n> \n> \"Error while manipulating mix.cfg\"\n> Its not clear what the conflict stems from. Expected settings and defaults between Whonix's Mixmaster instance and nymphemeral's installation advice could be the cause:\n> https://nymphemeral.readthedocs.org/en/stable/install/mixmaster.html\n\nThat error means that an IOError was raised when acessing the config file in your Mixmaster installation. As it is mentioned in the [[ https://nymphemeral.readthedocs.org/en/stable/use/files.html#mixmaster | documentation ]], you can edit `~/.config/nymphemeral/nymphemeral.cfg` to point to your Mixmaster installation (the default is `~/Mix`), which is probably the cause of the error. There is also the possibility that your Mixmaster version uses a name for the config file other than `mix.cfg`.\n\nUnfortunately we do not have a GUI for the settings and `~/Mix` is usually the default directory when the user installs Mixmaster. Manually editing `nymphemeral.cfg` under the `[mixmaster]` section to point to the correct directory and config file will fix the issue. I assume Whonix already comes with Mixmaster installed, but probably somewhere else.\n\nThanks for using nymphemeral!\n-Felipe"},{"author":"Patrick","date_created":1435865977,"date_modified":1435865977,"content":">>! In T367#5805, @dau wrote:\n> I am not sure if I should be posting here. But apparently I am allowed to.\n\nNo worries. It's open to public. Anything constructive to this ticket. Your welcome here. Your post looks very constructive.\n\n> I assume Whonix already comes with Mixmaster installed, but probably somewhere else.\n\nYes. Current Whonix stuff, related to mixmaster:\n\n* https://www.whonix.org/wiki/Mixmaster\n* https://www.whonix.org/wiki/Dev/Mixmaster\n* https://www.whonix.org/wiki/Remailer\n* https://github.com/Whonix/anon-mixmaster\n* https://www.whonix.org/wiki/E-Mail#alt.anonymous.messages\n* https://www.whonix.org/wiki/E-Mail#Nym_server_protected_e-mail_inbox\n"},{"author":"HulaHoop","date_created":1435876861,"date_modified":1435876861,"content":"Thanks for following up Felipe. Yes it turns out the Mixmaster file paths needed adjustment like you said. There is probably an instal location discrepancy between the compiled Mixmaster and the one installed from Debian.  I changed the cfg file path to point to where we have it but there is probably something else I'm missing to get it to work. Nymphemeral configuration now:\n\n\n```\n[mixmaster]\nbase_folder = /usr/bin/mixmaster\nbinary = /usr/bin/mixmaster\ncfg = /home/user/.Mix/mix.cfg\n\n```\n\nsudo dpkg -L mixmaster output:\n\n\n```\n/.\n/var\n/var/log\n/var/log/mixmaster\n/var/lib\n/var/lib/mixmaster\n/etc\n/etc/init.d\n/etc/init.d/mixmaster\n/etc/cron.daily\n/etc/cron.daily/mixmaster\n/etc/logrotate.d\n/etc/logrotate.d/mixmaster\n/etc/ppp\n/etc/ppp/ip-up.d\n/etc/ppp/ip-up.d/mixmaster\n/etc/mixmaster\n/etc/mixmaster/update.conf\n/etc/mixmaster/network.conf\n/etc/mixmaster/allpingers.txt\n/etc/mixmaster/remailer.conf\n/etc/mixmaster/filter.conf\n/etc/mixmaster/client.conf\n/etc/mixmaster/remailer\n/etc/mixmaster/remailer/end.hlp\n/etc/mixmaster/remailer/news.hlp\n/etc/mixmaster/remailer/pgponly.hlp\n/etc/mixmaster/remailer/pgp.hlp\n/etc/mixmaster/remailer/type1.hlp\n/etc/mixmaster/remailer/mix.hlp\n/etc/mixmaster/remailer/intro.hlp\n/etc/mixmaster/remailer/usage.txt.in\n/etc/mixmaster/remailer/reply.txt.in\n/etc/mixmaster/remailer/blocked.txt.in\n/etc/mixmaster/remailer/abuse.txt.in\n/etc/mixmaster/remailer/dest.alw\n/etc/mixmaster/remailer/header.blk\n/etc/mixmaster/remailer/adminkey.txt\n/etc/mixmaster/remailer/pop3.cfg\n/usr\n/usr/lib\n/usr/lib/mixmaster\n/usr/lib/mixmaster/mixmaster-rebuild\n/usr/share\n/usr/share/menu\n/usr/share/menu/mixmaster\n/usr/share/doc\n/usr/share/doc/mixmaster\n/usr/share/doc/mixmaster/README.gz\n/usr/share/doc/mixmaster/README.Debian.gz\n/usr/share/doc/mixmaster/changelog.Debian.gz\n/usr/share/doc/mixmaster/changelog.gz\n/usr/share/doc/mixmaster/copyright\n/usr/share/doc/mixmaster/TODO\n/usr/share/man\n/usr/share/man/man1\n/usr/share/man/man1/mixmaster-filter.1.gz\n/usr/share/man/man1/mixmaster-update.1.gz\n/usr/share/man/man1/mixmaster.1.gz\n/usr/bin\n/usr/bin/mixmaster\n/usr/bin/mixmaster-filter\n/usr/bin/mixmaster-update\ndiverted by uwt to: /usr/bin/mixmaster-update.anondist-orig\n\n```"},{"author":"dau","date_created":1435963290,"date_modified":1435963290,"content":">>! In T367#5826, @Patrick wrote:\n>>>! In T367#5805, @dau wrote:\n>> I am not sure if I should be posting here. But apparently I am allowed to.\n> \n> No worries. It's open to public. Anything constructive to this ticket. Your welcome here. Your post looks very constructive.\n> \n>> I assume Whonix already comes with Mixmaster installed, but probably somewhere else.\n> \n> Yes. Current Whonix stuff, related to mixmaster:\n> \n> * https://www.whonix.org/wiki/Mixmaster\n> * https://www.whonix.org/wiki/Dev/Mixmaster\n> * https://www.whonix.org/wiki/Remailer\n> * https://github.com/Whonix/anon-mixmaster\n> * https://www.whonix.org/wiki/E-Mail#alt.anonymous.messages\n> * https://www.whonix.org/wiki/E-Mail#Nym_server_protected_e-mail_inbox\n\nThanks Patrick! I will read those articles.\n\n>>! In T367#5827, @HulaHoop wrote:\n> Thanks for following up Felipe. Yes it turns out the Mixmaster file paths needed adjustment like you said. There is probably an instal location discrepancy between the compiled Mixmaster and the one installed from Debian.  I changed the cfg file path to point to where we have it but there is probably something else I'm missing to get it to work. Nymphemeral configuration now:\n> \n> \n> ```\n> [mixmaster]\n> base_folder = /usr/bin/mixmaster\n> binary = /usr/bin/mixmaster\n> cfg = /home/user/.Mix/mix.cfg\n> \n> ```\n> \n> sudo dpkg -L mixmaster output:\n> \n> \n> ```\n> /.\n> /var\n> ...\n\nGot it. Are you still having the same `mix.cfg` error?\n\n"},{"author":"HulaHoop","date_created":1435972579,"date_modified":1435972579,"content":">Got it. Are you still having the same mix.cfg error?\n\nYes. I've also tried many other likely paths but with no success unfortunately."},{"author":"dau","date_created":1435986124,"date_modified":1435986124,"content":">>! In T367#5855, @HulaHoop wrote:\n>>Got it. Are you still having the same mix.cfg error?\n> \n> Yes. I've also tried many other likely paths but with no success unfortunately.\n\nI installed Whonix and I found out what the problem is. That is a bug on nymphemeral. I apologize for that :(\n\nHere is what is happening: the `mix.cfg` file is only used (by nymphemeral) to display the mix chain. If an IOError is raised when accessing the file, the \"Error while manipulating mix.cfg\" message is //printed// (in the terminal, not the GUI) and the chain does not change from `None`. It will also keep that value if the chain is not found in the file (our case).\n\nIt happens that when I coded, I assumed that if a chain was found, Mixmaster was probably correctly installed, configured and ready to be used. Therefore, inside the GUI, it is checked if the chain exists to display it and enable the radio button to use Mixmaster, and if it is not found the \"Error while manipulating mix.cfg\" will be displayed too (now in the GUI), even if no IOError was raised, because the chain would still be `None`.\n\nAfter installing Whonix, I saw that `mix.cfg` has only the `SMTPRELAY` option. That's why the chain is not being found and this whole thing is going on.\n\nFor now, adding a chain to the Mixmaster configs will \"fix\" the issue so you can keep testing, but I will fix it on nymphemeral.\n\nThe simplest way is to assign an \"Unkown chain\" to the chain variable when it cannot be found in the file. That value will be displayed instead of the error and will allow the user to use Mixmaster, but it still does not change the fact that I am assuming that Mixmaster is installed and working by simply checking `mix.cfg`. Do you have any idea of how to do that properly?\n\nI'm really sorry for making you waste time on such a silly bug :(\n\nApparently I was able to successfully send a couple dummy messages with Mixmaster, so I assume regular messages will be sent as well. I would like to point out that nymphemeral was tested with Mixmaster >= 3.0.2, and Whonix comes with Mixmaster 3.0 only. That should not be a big deal, but there could happen unexpected errors. I will install nymphemeral and do some testing as well.\n\nPs: I would like that you read my last post on the [[ https://github.com/felipedau/nymphemeral/issues/3 | GitHub issue ]] you opened, because I want to know what exactly you guys expect from nymphemeral.\n\nThanks!"},{"author":"HulaHoop","date_created":1436109405,"date_modified":1436109405,"content":">I installed Whonix and I found out what the problem is. That is a bug on nymphemeral. I apologize for that \n\nTotally fine. You've been very helpful so far and open to suggestions, thanks.\n\n>The simplest way is to assign an \"Unkown chain\" to the chain variable when it cannot be found in the file. That value will be displayed instead of the error and will allow the user to use Mixmaster, but it still does not change the fact that I am assuming that Mixmaster is installed and working by simply checking `mix.cfg`. \n\nSo are you just checking for the existence of the file or are you also parsing its contents and going off of that? The first method (if possible to implement) would make it more robust because it makes less assumptions I think.\n\nOrthognal questions: Can/Should  Nymphemeral allow users to set their own chain length? Also how does Nymphemeral deal with the exit remailers disallowing \"From:\" headers? AFAICT this header is the only way a recipient knows what nym to reply to. There is only a handful of exits like dizum that accept custom From headers.\n\n>Do you have any idea of how to do that properly?\n\nCould ConfigParser work for this?\n\n>Ps: I would like that you read my last post on the GitHub issue <https://github.com/felipedau/nymphemeral/issues/3> you opened, because I want to know what exactly you guys expect from nymphemeral.\n\nHadn't had the chance to check GitHub for the past days, will reply soon."},{"author":"dau","date_created":1436555464,"date_modified":1436555464,"content":"> So are you just checking for the existence of the file or are you also parsing its contents and going off of that? The first method (if possible to implement) would make it more robust because it makes less assumptions I think.\n\nI am parsing the contents. I also agree with you, but the problem is that nymphemeral would still assume that Mixmaster is installed (and working) based only on the config file. I guess it would be a bit better if it checked for the binary instead.\n\nI am going to take a look to see if there is a way to run Mixmaster's own tests. Otherwise nymphemeral could try to run a simple test, like sending a dummy message. I am not sure, but these tests would probably add some delay to nymphemeral's startup.\n\nI will open an issue for that.\n\n> Orthognal questions: Can/Should  Nymphemeral allow users to set their own chain length?\n\nnymphemeral does not have that feature yet. The user will have to manually set it, because will depend on what is actually on `mix.cfg`.\n\n> Also how does Nymphemeral deal with the exit remailers disallowing \"From:\" headers? AFAICT this header is the only way a recipient knows what nym to reply to. There is only a handful of exits like dizum that accept custom From headers. \n\nAll the messages sent through nymphemeral (via Mixmaster or not) go to the nym server. It is the server that sends them to the targets afterwards. As the message also has an asymmetric encryption layer signed by the nym, the server would check the signature and know which nym sent it. It will then send it for him.\n\nI actually do not know how the server would manage Mixmaster chaining to send the message to the final target, although I believe that would not happened because nyms expect to receive replies. It is important that the client uses Mixmaster to anonymize the user (actual owner of the nym), but if the nym server mixed the message as well until it gets to the final recipient //and// the \"From:\" header persisted, then just the path of the message would remain unknown, because the server was revealed.\n\nJust would like to remind that as nymphemeral is a Zax-type client, that's how a Zax-type nym would send its messages. Also, it would receive messages by downloading from a news group. Other nym servers, e.g. GHIO-type, work differently.\n\nThanks!"},{"author":"HulaHoop","date_created":1436578657,"date_modified":1436578657,"content":"> I am not sure, but these tests would probably add some delay to nymphemeral's startup.\n\nYou know how users will have to renew remailer chain information - usually once a day? this dummy message sending test could be part of that procedure instead of something done on (every) startup by nymphemeral.\n\n>All the messages sent through nymphemeral (via Mixmaster or not) go to the nym server. It is the server that sends them to the targets afterwards. As the message also has an asymmetric encryption layer signed by the nym, the server would check the signature and know which nym sent it. It will then send it for him.\n\nIs it the same for any Zax-type nymserver? From testing I understood that one sends the message through Mixmaster to the recipient but uses the nym address in the From: header to let the recipient know that there is a destination they can send a reply to. The nymserver would only interact with replies from the recipient, encrypting and directing them to a.a.m.\n\nAnyway your solution of relaying it to the nymserver that then sends it on your behalf is more usable/stable.\n\n>Just would like to remind that as nymphemeral is a Zax-type client, that's how a Zax-type nym would send its messages. Also, it would receive messages by downloading from a news group. Other nym servers, e.g. GHIO-type, work differently.\n\nYeah I know. Zax-type nymservers are the only type I have used and there is a night-and-day difference in usability when looking at how GHIO nymservers work. GHIO-type nymservers are a nightmare, they should shut them down.\n\n***\n\nPlease keep me posted about the developments for the Github tickets you opened today."},{"author":"HulaHoop","date_created":1436582914,"date_modified":1436582914,"content":"Off-topic:\n\n**Felipe** do you mind helping me figure out something for our Mixmster wiki [[ https://www.whonix.org/wiki/Mixmaster#Nymserver_How-To | documentation ]]? \nI'm trying to document the long way of registering a nym with a Zax Nymserver (mixnym.net) that uses an hsub instead of a plaintext subject line. The latter works but sticks out like a sore thumb on a.a.m. All my trials with formatting a message with an hsub header failed as they never got replies from the nymserver. (Note that I'll need to change the part about Icedove as a newsgroup client to aam2mail instead). Please post an exact example of a nym registration message that also configures an hsub.\n\nI'll keep these instructions  around until they become obsolete when nymphemeral is integrated in Whonix.\n\n"},{"author":"dau","date_created":1436591962,"date_modified":1436591962,"content":"\n>>! In T367#5902, @HulaHoop wrote:\n> You know how users will have to renew remailer chain information - usually once a day? this dummy message sending test could be part of that procedure instead of something done on (every) startup by nymphemeral.\n\nI don't know how often they would have to do that, but nymphemeral only displays it for convenience. It is not too important. I like your idea, I will keep that in mind.\n\n> Is it the same for any Zax-type nymserver? From testing I understood that one sends the message through Mixmaster to the recipient but uses the nym address in the From: header to let the recipient know that there is a destination they can send a reply to. The nymserver would only interact with replies from the recipient, encrypting and directing them to a.a.m.\n>\n> Anyway your solution of relaying it to the nymserver that then sends it on your behalf is more usable/stable.\n\nIn theory the only difference from the regular Zax-type and the new one is the ephemeral encryption, and I always thought that's how Zax designed it.\n \n> Yeah I know. Zax-type nymservers are the only type I have used and there is a night-and-day difference in usability when looking at how GHIO nymservers work. GHIO-type nymservers are a nightmare, they should shut them down.\n \nIndeed!\n \n> Please keep me posted about the developments for the Github tickets you opened today.\n\nAbsolutely.\n\n>>! In T367#5904, @HulaHoop wrote:\n> Off-topic:\n> \n> **Felipe** do you mind helping me figure out something for our Mixmster wiki [[ https://www.whonix.org/wiki/Mixmaster#Nymserver_How-To | documentation ]]? \n\nNot at all!\n \nI just skimmed through the link you posted and noticed there are some errors there, or maybe the server or Mixmaster are smarter than I thought.\n\nAFAIK, for Zax-type nym servers:\n\nCreation and configuration messages should be sent to `config@server` and regular messages to `send@server`.\nIf I were to send the following message:\n\n    From: nym@server\n    To: recipient@domain\n    Subject: Example\n    \n    This is an example\n\nI would encrypt to the nym server to send to `send@server` and add the outer headers:\n\n    From: nym@server\n    To: send@server\n    Subject: Example\n    \n    -----BEGIN PGP MESSAGE-----\n    ...\n    -----END PGP MESSAGE-----\n    \nNote that I encrypt the original headers and body of the message. The PGP block has everything composed earlier.\n\nFinally I would send it to `send@server` (via Mixmaster or whatever I would like to use) and then the server would deliver the message to `recipient@domain` after decrypting the PGP message.\n\nAlso, from nymphemeral's point of view, the \"From:\" and \"Subject:\" headers do not even have to match or be valid.\n\n> I'm trying to document the long way of registering a nym with a Zax Nymserver (mixnym.net) that uses an hsub instead of a plaintext subject line. The latter works but sticks out like a sore thumb on a.a.m. All my trials with formatting a message with an hsub header failed as they never got replies from the nymserver. (Note that I'll need to change the part about Icedove as a newsgroup client to aam2mail instead). Please post an exact example of a nym registration message that also configures an hsub.\n\nIf you are using the `hsub:` header when creating the nym, it should work. I never used Icedove to retrieve these messages. How would you check for the hSubs?\n\nI am going to run some tests before writing the full instructions. By the way, would you like to open another ticket for that?\n\nI am going to talk to rxcomm, the developer of the new nym server, to confirm the differences from the regular and new nym servers.\n\nFor now, I hope this post can help you, but do not take it too seriously until I confirm if what I do is actually correct."},{"author":"HulaHoop","date_created":1436639867,"date_modified":1436639867,"content":"Thanks Felipe. I followed your directions and now it works!\n\n>I just skimmed through the link you posted and noticed there are some errors there, or maybe the server or Mixmaster are smarter than I thought.\n\nYes there are many. I'll fix up this guide now and I'll give you credit for helping.\n\n>Creation and configuration messages should be sent to config@server and regular messages to send@server.\n\nThat was it. \nI hadn't seen this explained clearly anywhere except in your post. My instructions were based on wrong usenet comments.\n\n>I never used Icedove to retrieve these messages. How would you check for the hSubs?\n\nNot possible, it just a temporary solution for use with plaintext subjects until I got hsubs working.\n\n>I am going to run some tests before writing the full instructions. By the way, would you like to open another ticket for that?\n\nSure.\n\n>I am going to talk to rxcomm, the developer of the new nym server, to confirm the differences from the regular and new nym servers.\n>\n>For now, I hope this post can help you, but do not take it too seriously until I confirm if what I do is actually correct.\n\nThanks.\n\nFor completion, please also describe how to post to a newsgroup with a nym."},{"author":"dau","date_created":1436661206,"date_modified":1436661206,"content":">>! In T367#5906, @HulaHoop wrote:\n> Thanks Felipe. I followed your directions and now it works!\n\nGreat!\n\n> Yes there are many. I'll fix up this guide now and I'll give you credit for helping.\n\nDon't worry about it! I started modifying that section and I can send you once its done.\n\n> That was it. \n> I hadn't seen this explained clearly anywhere except in your post. My instructions were based on wrong usenet comments.\n\nUnfortunately we do not have much (and good) information out there related to this stuff :(\n\n> Not possible, it just a temporary solution for use with plaintext subjects until I got hsubs working.\n\nGot it. I am going to make a sub-section on aampy, another tool developed by rxcomm. It easily downloads messages for your nyms checking their hsubs.\n\n> Thanks.\n> \n> For completion, please also describe how to post to a newsgroup with a nym.\n\nNo problem! I'll let you know once I have something new :)\n\nThanks!"},{"author":"HulaHoop","date_created":1436707099,"date_modified":1436707099,"content":"I pushed a major change to the wiki. Many parts are rewritten and new information added.\n\n>Got it. I am going to make a sub-section on aampy, another tool developed by rxcomm. It easily downloads messages for your nyms checking their hsubs.\n\nOk Great"},{"author":"dau","date_created":1436984650,"date_modified":1436984650,"content":"It seems that pip has been updated and nymphemeral is not installing as it should. HulaHoop, when you were testing nymphemeral, did you install it with pip or built it from source?"},{"author":"HulaHoop","date_created":1437017928,"date_modified":1437017928,"content":"I was using pip. Should I try building from source?"},{"author":"dau","date_created":1437020325,"date_modified":1437020325,"content":">>! In T367#5937, @HulaHoop wrote:\n> I was using pip. Should I try building from source?\n\nThe issue came up when using pip 7. It does not allow files being installed outside of the scope any more. nymphemeral was copying the generic.db (a template needed to start a conversation with the server), connection scripts and docs to /usr/share/nymphemeral and pip 7 can't do that anymore. And they are right, I shouldn't be doing that.\n\nYou were probably using pip 6. Otherwise you would not even get to that `mix.cfg` error. I would like that you tried to update nymphemeral to see if you would get any errors. You can do it with `sudo pip install nymphemeral --upgrade`. By the way, what were you able to test so far?\n\nRight now I can't update nymphemeral to run automatically when installed on Whonix, but I was able to make it work with a few manual changes. Let me know what issues you had that I am preparing the instructions for you.\n\nThanks!"},{"author":"HulaHoop","date_created":1437060011,"date_modified":1437060011,"content":">You were probably using pip 6. Otherwise you would not even get to that mix.cfg error. I would like that you tried to update nymphemeral to see if you would get any errors. You can do it with sudo pip install nymphemeral --upgrade. By the way, what were you able to test so far?\n\nI can successfully upgrade nymphemeral with pip however I still have the same error with mix.cfg\n\n>Right now I can't update nymphemeral to run automatically when installed on Whonix, but I was able to make it work with a few manual changes. Let me know what issues you had that I am preparing the instructions for you.\n\nOk great."},{"author":"dau","date_created":1437070881,"date_modified":1437070881,"content":"> I can successfully upgrade nymphemeral with pip however I still have the same error with mix.cfg\n\nGreat!\n\nHere is how I got it working:\n\n1. First of all, we provide socat scripts to the users to use Tor when sending/receiving messages. Since Whonix naturally does that, `socnews.sh` and `socsmtp.sh` are not needed. However, the user should still use stunnel to download messages with TLS. Install stunnel:\n\n```\n\nsudo apt-get install stunnel4\n```\n\nDownload the stunnel .conf file we provide:\n\n\n```\nsudo curl https://raw.githubusercontent.com/felipedau/nymphemeral/master/connections/stunnel.conf -o /etc/stunnel/stunnel.conf\n```\n\nEdit `/etc/stunnel/stunnel.conf`. At the end of the file, you can ignore (prepend with `;` or delete the lines) the [ssmtp-client] section and use the default that is already configured in `mix.cfg`, but should not ignore the [nntps-client] section. Those values would connect to the port that socat would be listening. As we are not using socat because every connection on Whonix is done via Tor, you can configure to connect directly to the news server:\n\n\n```\n[nntps-client]\nclient = yes\naccept = 127.0.0.1:119\nconnect = news.mixmin.net:563\n\n;[ssmtp-client]\n;protocol = smtp\n;client = yes\n;accept = 127.0.0.1:2525\n;connect = 127.0.0.1:2526\n\n```\nEnable stunnel by setting `ENABLE` to `1` in `/etc/default/stunnel4`:\n\n```\n\n# Change to one to enable stunnel automatic startup\nENABLED=1\nFILES=\"/etc/stunnel/*.conf\"\nOPTIONS=\"\"\n```\n\nFinally, start it:\n\n\n```\nsudo service stunnel4 start\n```\n\n2. Until I fix the `mix.cfg` issue, please add some chain to that file:\n\n```\n\nSMTPRELAY 1.1.1.1\nSMTPRELAY 2.2.2.2\nCHAIN *\n```\n\nLaunch nymphemeral to create the user files:\n\n\n```\nnymphemeral\n```\n\nYou will still get the `mix.cfg` error. Now that the config file has been created, modify the [mixmaster] section to point to the correct paths:\n\n\n```\n[mixmaster]\nbase_folder = /home/user/.Mix\nbinary = /usr/bin/mixmaster\ncfg = %(base_folder)s/mix.cfg\n```\n\nStill in that file, I would advise you to enable the debug messages from the [main] section:\n\n\n```\n[main]\n...\ndebug_switch = True\n...\n```\n\nNow you should be ready to launch nymphemeral and use Mixmaster :) All you have to do is getting the public key from `nym.now.im/nymserver` and importing with the `Manage Servers` button on the login window.\n\n3. I'd advise you to [[ https://nymphemeral.readthedocs.org |  read the docs ]] not only to understand nymphemeral, but also to provide me some feedback, if possible.\n\nI hope it works!"},{"author":"HulaHoop","date_created":1437074228,"date_modified":1437074228,"content":"Awesome. I have Nymphemeral up and running.\n\nNotes:\n\n* I have some confusion about what to do about the Ephemeral Key field under the Create Nym tab. I probably missed something when reading the documentation. Can you please add an explanation about it on:\nhttps://nymphemeral.readthedocs.org/en/stable/use/creation.html\n\n* Suggestion: What do you think about changing the name of the  \"Name\" field into pseudonym? The idea is to prevent newbies from putting in their real name by mistake.\n\n* Suggestion: At the moment the Nymphemeral keyring is separate from th one in the user's home directory. What if Nymphemeral automatically symlinks to the user's keychain to make the process of using contact's keys more seamless so at no point the command line will be needed?"},{"author":"HulaHoop","date_created":1437074502,"date_modified":1437074502,"content":"* Suggestion: It would be good practice to encourage users to have generic subject lines for instructions here: https://nymphemeral.readthedocs.org/en/stable/use/composition.html#composition"},{"author":"dau","date_created":1437089672,"date_modified":1437089672,"content":">>! In T367#5952, @HulaHoop wrote:\n> Awesome. I have Nymphemeral up and running.\n\nGood to hear that :)\n\n> * I have some confusion about what to do about the Ephemeral Key field under the Create Nym tab. I probably missed something when reading the documentation. Can you please add an explanation about it on:\n> https://nymphemeral.readthedocs.org/en/stable/use/creation.html\n\nYou are right, there should be more information about that. The Axolotl protocol derives a master key from the handshake to start a conversation. Since we already have a secure channel (using the server's PGP key), the nym can go ahead and send that master key, so the server does not need to make a handshake. That's the ephemeral key you see and it can be any random key.\n\nI'm planning on adding some check boxes that the user can check to automatically generate the ephemeral key and hsub passphrase so they do not even have to worry about them.\n\n> * Suggestion: What do you think about changing the name of the  \"Name\" field into pseudonym? The idea is to prevent newbies from putting in their real name by mistake.\n\nI agree!\n\n> * Suggestion: At the moment the Nymphemeral keyring is separate from th one in the user's home directory. What if Nymphemeral automatically symlinks to the user's keychain to make the process of using contact's keys more seamless so at no point the command line will be needed?\n\nIn previous versions, nymphemeral was actually grabbing the keys from the local keyring. I discussed that with rxcomm and we decided to totally split them. That way we can prevent the users from making mistakes and correlating their real identities and nyms. That will also prevent nymphemeral from messing with the user's keyring; mistakes happen :/\n\nUnfortunately we do not have information on how people use their nyms. Maybe they might use their real keys in the end-to-end encryption layer, but maybe (through another channel) they should exchange their nyms and only encrypt/sign with the nyms' keys instead of the real ones (sounds much better).\n\nI do think that it is convenient to access the user's keyring, but it shouldn't be done for those reasons. By making the user manually add these keys we can assume that they know what they are doing and maybe decrease the chances of screwing up.\n\nI have a plan of upgrading the \"Server Manager\" used to add the server key to become some kind of a keyring manager and the user will not need to use the terminal for that any more. //In fact (not intentionally) you are already allowed to add any key using the server manager because there is nothing checking if the key you are adding is actually from a nym server. The window still only show keys from nym servers, but any key can be added.//\n\n>>! In T367#5953, @HulaHoop wrote:\n> * Suggestion: It would be good practice to encourage users to have generic subject lines for instructions here: https://nymphemeral.readthedocs.org/en/stable/use/composition.html#composition\n\nI also agree with that! It should be mentioned that the headers are visible to the nym server.\n\nLet me know what you think! Thanks for the feedback :)"},{"author":"HulaHoop","date_created":1437109402,"date_modified":1437109402,"content":">I'm planning on adding some check boxes that the user can check to automatically generate the ephemeral key and hsub passphrase so they do not even have to worry about them.\n\nExcellent. It would be even great as a default because the less choices a user has to make, the more frictionless their experience is.\n\n>In previous versions, nymphemeral was actually grabbing the keys from the local keyring. I discussed that with rxcomm and we decided to totally split them. That way we can prevent the users from making mistakes and correlating their real identities and nyms. That will also prevent nymphemeral from messing with the user's keyring; mistakes happen :/\n\nSafe defaults are always the smart thing to do, so I agree that the current behavior should be as it is out-of the box, but for more flexibility can you make direct access to the user keyring an option that powerusers can enable? To make sure no mistakes are made, Nymphemeral could show a confirmation prompt warning the user not to use the option unless they know what they're doing.\n\nUpgrading Server Manager to handle this still works, I'm just putting ideas out there :)\n\nI will continue testing and keep you updated.\n"},{"author":"HulaHoop","date_created":1437112033,"date_modified":1437112078,"content":">You are right, there should be more information about that. The Axolotl protocol derives a master key from the handshake to start a conversation. Since we already have a secure channel (using the server's PGP key), the nym can go ahead and send that master key, so the server does not need to make a handshake. That's the ephemeral key you see and it can be any random key.\n\nNo keys appear in the Ephemeral key field. Is this supposed to happen? I just typed in a random word and it seems to work.\n\n***\n\nSuggestions:\n\n* Nymphemeral main window having a checkbox option to remember typed addresses for convenience.\n\n* IMHO it feels more intuitive to click \"Start Session\" right under the address and passphrase fields, switching places with \"Manage Servers\"\n\n* \"Manage Servers\" gaining the ability to import asc keys files without needing to open, copy-paste their contents. Makes sense in the future because other nymservers provide keyfiles without posting their keys on the server webpage like nym.now.im\n\n* In the \"Send Message\" tab under the End-to End section, the keys in the keychain could appear in a drop-down menu or alternatively auto-searched as the user types in an email associated with a key they want to send to. Same for the Signer field."},{"author":"dau","date_created":1437176384,"date_modified":1437200190,"content":">>! In T367#5960, @HulaHoop wrote:\n> Safe defaults are always the smart thing to do, so I agree that the current behavior should be as it is out-of the box, but for more flexibility can you make direct access to the user keyring an option that powerusers can enable? To make sure no mistakes are made, Nymphemeral could show a confirmation prompt warning the user not to use the option unless they know what they're doing.\n> \n> Upgrading Server Manager to handle this still works, I'm just putting ideas out there :)\n\nThat can be done, but I think that at the moment I'm going to give more priority to the development of the \"keyring manager\".\n\n>>! In T367#5961, @HulaHoop wrote:\n> No keys appear in the Ephemeral key field. Is this supposed to happen? I just typed in a random word and it seems to work.\n\nMaybe I should find a better word for that, but that's it! As if it was a passphrase. Just a random string.\n\n> * IMHO it feels more intuitive to click \"Start Session\" right under the address and passphrase fields, switching places with \"Manage Servers\"\n\nWhen I designed it, I was looking as if everything was part of a process that leads to starting the session, like:\n\n# Type address and passphrase\n# Import the server's key\n# (Not) Use the GPG agent\n# Choose an output method\n# Start session\n\nBut you are right. After the first login, you will rarely import keys and will probably have the same options for the agent and output method every time. I am going to think of a better placement of those items.\n\n> * \"Manage Servers\" gaining the ability to import asc keys files without needing to open, copy-paste their contents. Makes sense in the future because other nymservers provide keyfiles without posting their keys on the server webpage like nym.now.im\n\nThat's convenient. Thanks :) I am going to add that feature once I start coding the keyring manager.\n\n> * Nymphemeral main window having a checkbox option to remember typed addresses for convenience.\n>\n> * In the \"Send Message\" tab under the End-to End section, the keys in the keychain could appear in a drop-down menu or alternatively auto-searched as the user types in an email associated with a key they want to send to. Same for the Signer field.\n\nI wish I had already done that, but I will probably have to use something more powerful than tkinter. I could not find a neat way of doing that.\n\nThe data does not even need to be \"remembered\" because they are already in the keyring. That can be easily retrieved. The problem is designing a nice interface that display that information with tkinter :(\n\n> I will continue testing and keep you updated.\n\nThanks HulaHoop!"},{"author":"dau","date_created":1437414454,"date_modified":1437414454,"content":"Hi HulaHoop!\n\nWould like to let you know that I am about to release 1.3.4, which consists of things we've been discussing. I'm still not able to implement everything you suggested, but I will when I can. What is important about 1.3.4 is that it updates nymphemeral to be used on Whonix. You can take a look at the [[ https://github.com/felipedau/nymphemeral/commits/develop | latest commits ]].\n\nIf you can, take a look at the [[ https://github.com/felipedau/nymphemeral/issues | issues ]] I opened. We still have not defined the priority of them and we cannot promise which and when will be fixed. Please, take a look and see if there is something missing.\n\nNote that it's been a while since I merged things to the master branch. The reason for that is that nymphemeral has been updated to use pyaxo 0.4, but we are still updating the server. Once we have the new version running on nym.now.im, I'll merge the releases.\n\nThanks!"},{"author":"HulaHoop","date_created":1437524293,"date_modified":1437524293,"content":"\nGreat and thanks for considering my suggestions. "},{"author":"Patrick","date_created":1455124569,"date_modified":1455124569,"content":"What is the status of this ticket?"},{"author":"dau","date_created":1455127791,"date_modified":1455127791,"content":">>! In T367#8079, @Patrick wrote:\n> What is the status of this ticket?\n\nHi, I apologize for being away for such a long time. The changes I made to nymphemeral with help from @HulaHoop to add Whonix support are present since the 1.3.4 release. However, I have not packaged it for Debian yet. I remember I started learning how to do that but it seemed more complex than I expected and I postponed that, still indefinitely. I have been making some minor changes to nymphemeral, but I have been working on other things as well.\n\nWould you point me to the right direction on how to package nymphemeral? I specifically remember reading that I would have to first write a test suite for nymphemeral (which I am currently learning), but I also found a lot of  divergent information and I am not sure, for example, if that test requirement is true. Do you have a nice material that can help me learn how to package for Debian?\n\nThanks!"},{"author":"Patrick","date_created":1455132329,"date_modified":1455132329,"content":"I never read that a test suite is required for a package to be accepted\ninto Debian. Unfortunately, I don't know what the best more straight\nforward guide into Debian packaging [of a python project] is.\n\nwhonix-setup-wizard is a python package maintained by Whonix.\n\nhttps://github.com/Whonix/whonix-setup-wizard\n\nIt has only one dependency, genmkfile that is unfortunately not yet\npackaged for Debian but hopefully sooner than later.\n\nhttps://github.com/Whonix/genmkfile\n\nYou can see there the `/debian` sub folder. You could copy and paste it\nas a template and then modify for nymphemeral.\n\nhttps://github.com/Whonix/whonix-setup-wizard/tree/master/debian\n\nDebian package build instructions are included in the project's readme.\n\nhttps://github.com/Whonix/whonix-setup-wizard/blob/master/README.md\n\nIt produces a 100 % `lintian` (including --pedantic) warning free\npackage. [Lintian is the package quality checker by Debian.] And\nreasonable absence of lintian warnings this is a condition for packages\nto be accepted in Debian.\n\nThere surely are other ways to package python based software for Debian.\nLook into a few python based software packages and download their\nsources. (apt-get source pkg-name)\n\nThere is also the Debian mentors mailing list, which helps with\npackaging questions.\n\nhttps://lists.debian.org/debian-mentors/\n\nI suggest to try to reach out to the Debian Anonymity Tools Team for help.\n\nhttps://tracker.debian.org/teams/anonymity-tools/"},{"author":"dau","date_created":1455133696,"date_modified":1455133696,"content":">>! In T367#8102, @Patrick wrote:\n> I never read that a test suite is required for a package to be accepted\n> into Debian. Unfortunately, I don't know what the best more straight\n> forward guide into Debian packaging [of a python project] is.\n> \n> whonix-setup-wizard is a python package maintained by Whonix.\n> \n> https://github.com/Whonix/whonix-setup-wizard\n> \n> It has only one dependency, genmkfile that is unfortunately not yet\n> packaged for Debian but hopefully sooner than later.\n> \n> https://github.com/Whonix/genmkfile\n> \n> You can see there the `/debian` sub folder. You could copy and paste it\n> as a template and then modify for nymphemeral.\n> \n> https://github.com/Whonix/whonix-setup-wizard/tree/master/debian\n> \n> Debian package build instructions are included in the project's readme.\n> \n> https://github.com/Whonix/whonix-setup-wizard/blob/master/README.md\n> \n> It produces a 100 % `lintian` (including --pedantic) warning free\n> package. [Lintian is the package quality checker by Debian.] And\n> reasonable absence of lintian warnings this is a condition for packages\n> to be accepted in Debian.\n> \n> There surely are other ways to package python based software for Debian.\n> Look into a few python based software packages and download their\n> sources. (apt-get source pkg-name)\n> \n> There is also the Debian mentors mailing list, which helps with\n> packaging questions.\n> \n> https://lists.debian.org/debian-mentors/\n> \n> I suggest to try to reach out to the Debian Anonymity Tools Team for help.\n> \n> https://tracker.debian.org/teams/anonymity-tools/\n\nThanks @Patrick, I will study those links!\n\nSo far, the easiest way to install nymphemeral is:\n\n```\napt-get install python-dev python-tk\npip install nymphemeral\n```\n\nI'll let you know how the packaging goes.\n\nThanks!"},{"author":"HulaHoop","date_created":1471488468,"date_modified":1471488468,"content":"As soon as TUF for python is packaged for Debian I will document how to install nymphemeral with it.\n\nBackground: TUF provides a secure updater framework that guarantees package and update integrity. It is now integrated in many alternative installer/updaters that traditionally had poor to no security. Using it with pip will give the same security benefits as if it was available under Debian's apt."},{"author":"dau","date_created":1471656011,"date_modified":1471656011,"content":">>! In T367#9898, @HulaHoop wrote:\n> As soon as TUF for python is packaged for Debian I will document how to install nymphemeral with it.\n> \n> Background: TUF provides a secure updater framework that guarantees package and update integrity. It is now integrated in many alternative installer/updaters that traditionally had poor to no security. Using it with pip will give the same security benefits as if it was available under Debian's apt.\n\n@HulaHoop, thank you! That is very interesting.\n\nPlease let me know if there is anything I can help you with."},{"author":"HulaHoop","date_created":1534434169,"date_modified":1534434169,"content":"Non-Debian dependencies and non materialization of TUF PyPi makes a secure way to obtain this package impossible. "}]},"PHID-TASK-apz6rodoeb6xus65oet5":{"id":"366","title":"cover Qubes specific steps in advice by whonixcheck","status":"resolved","priority":"Normal","author":"Patrick","description":"__Usability Question__:\n\nFor better usability, whonixcheck sometimes (i.e. invalid /etc/tor/torrc) advices various steps to help users fix their issue. Examples:\n\n> * Start Menu -> Applications -> System -> Torrc\n> * Start Menu -> Applications -> System -> Restart Tor\n> * Start Menu -> Applications -> System -> Whonix Check\n\nThis advice does not fully cover Qubes. Instructions could be better. For example:\n\n> * Start Menu in dom0 -> sys-whonix -> Torrc\n\nWhat do you think?\n\nIs it sane to have AppVMs / ProxyVMs advice to use dom0 to do x? Or do you see a security issue in training users to do so?\n\n__Technical Question__:\n\nCan AppVMs / ProxyVMs read their own VM name, i.e. if they are called `sys-whonix` vs `my-gateway` etc.?\n","comments":[{"author":"nrgaway","date_created":1435457065,"date_modified":1435457065,"content":"Do you mean TemplateVM or dom0.\n\nIn regards to TemplateVM:\n\n/etc/tor directory is bound to /rw so changes to Tor configuration can happen in ProxyVM\n\nThe bind-directories script contains all the directories that are bound.  Changes made in TemplateVM to those directories will not be reflected in ProxyVM once the initial bind occurs in ProxyVM\n\nI have a TODO item to consider updating /rw from dom0 changes in NOTES.\n\nSystem updates (apt-get) are still preformed from TemplateVM\n\nIn regards to dom0:\n\nNot much needs to be done in dom0 once installed and configured.  Qubes-manager takes care of most of that.  What type of things were you thinking about?\n\nAppVMs can read thier own name, it's what the host name is usually set to"},{"author":"Patrick","date_created":1435458066,"date_modified":1435458152,"content":"Wrong track.\n\nExample: user messes something up in sys-whonix (ProxyVM as per Qubes Whonix documentation. Not TemplateVM). Really doesn't matter where. Let's say the user messed up /etc/tor/torrc. In non-Qubes-Whonix, classically, whonixcheck would note \"something wrong with torrc, to fix it try x, y, z...\". Including step by step instructions what to click next. For example \"Start Menu -> Applications -> System -> Torrc\". But exactly \"Start Menu -> Applications -> System -> Torrc\" does not apply to Qubes-Whonix. More correct instructions for Qubes would be \"Start Menu in dom0 -> sys-whonix -> Torrc\".\n\nAnother example: Tor is unable to connect. Whonixcheck advices various actions a user could try. These instructions again differ slightly Whonix vs Qubes-Whonix.\n\nThese steps documentation differences happen, because in Qubes you don't have a start menu per VM. You don't have a task bar per VM. (And that's fine.) I mean, compared to for example VirtualBox. In VirtualBox, each VM has it's own task bar and start menu. In Qubes, a \"VMs start menu\" can be found in dom0's start menu.\n\nTo repeat the usability question here... That has a security aspect to it... Which is a conceptually discussion...\n\"Is it sane to have applications (such as whonixcheck) that re running in AppVMs to advice to use dom0 to do x? Or do you see a security issue in training users to do so?\"\n\n> AppVMs can read thier own name, it's what the host name is usually set to\n\nHopefully not in Whonix, because we set hostname by default to `host`. Any command line tool to figure out one's AppVM name for an AppVM?"},{"author":"marmarek","date_created":1435571104,"date_modified":1435571104,"content":">   Can AppVMs / ProxyVMs read their own VM name, i.e. if they are called `sys-whonix` vs `my-gateway` etc.?\n\nR2: xenstore-read name\nR3: qubesdb-read /name"},{"author":"Patrick","date_created":1435670417,"date_modified":1435670417,"content":"Ok, if no one has any concern, I'll go for it."},{"author":"Patrick","date_created":1435671298,"date_modified":1435671298,"content":"* output - https://github.com/Whonix/whonixcheck/commit/fc98254759793f3d29cb73443fcc0991fa7a10d2\n* `made start menu instructions variable - https://phabricator.whonix.org/T366` - https://github.com/Whonix/whonixcheck/commit/42f3fc0e565f2130086e1a1866a3a31a2ffc826d\n* `switch to use variable start_menu_instructions_system_first_part - https://phabricator.whonix.org/T366` - https://github.com/Whonix/whonixcheck/commit/697e077f8ecde2f60199c29fa52d15eb961bbf26\n"}]},"PHID-TASK-3dc5txyxlazx6xmsc4ed":{"id":"365","title":"apparmor denied message for icedove torbirdy","status":"resolved","priority":"Normal","author":"Patrick","description":"```\nJun 26 13:07:25 host kernel: [ 5267.446094] audit: type=1400 audit(1435324045.951:14): apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/lib/icedove/icedove\" name=\"/usr/share/xul-ext/torbirdy/\" pid=16833 comm=\"icedove\" requested_mask=\"r\" denied_mask=\"r\" fsuid=1000 ouid=0\n```\n","comments":[{"author":"troubadour","date_created":1435440870,"date_modified":1435440870,"content":"Could not see that one. Added.\nhttps://github.com/troubadoour/apparmor-profile-icedove/commit/91263dc1a7ea42ced53c96dddabdaca512ccf2fd"},{"author":"Patrick","date_created":1435527456,"date_modified":1435527456,"content":"Merged.\n\nGot another one.\n\n> audit: type=1400 audit(1435526834.654:16): apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/lib/icedove/icedove\" name=\"/usr/share/xul-ext/torbirdy/defaults/\" pid=18882 comm=\"icedove\" requested_mask=\"r\" denied_mask=\"r\" fsuid=1000 ouid=0\n\nAdded:\nhttps://github.com/Whonix/apparmor-profile-icedove/commit/b4b5d10a1f9cf987ae5308cc580266c8959cdef2\n"}]},"PHID-TASK-b6vqoguvp34t5u67xcgg":{"id":"364","title":"apparmor denied messages when running Tor Browser's Internal Updater","status":"resolved","priority":"Normal","author":"Patrick","description":"```\nJun 26 11:45:41 host kernel: [  362.582162] audit: type=1400 audit(1435319141.087:6): apparmor=\"DENIED\" operation=\"open\" profile=\"/home/*/tor-browser_*/Browser/firefox\" name=\"/proc/sys/vm/overcommit_memory\" pid=8777 comm=\"updater\" requested_mask=\"r\" denied_mask=\"r\" fsuid=1000 ouid=0\n```\n\n```\nJun 26 11:57:31 host kernel: [ 1073.059489] audit: type=1400 audit(1435319851.563:8): apparmor=\"DENIED\" operation=\"exec\" profile=\"/home/*/tor-browser_*/Browser/firefox\" name=\"/tmp/MozUpdater/bgupdate/updater\" pid=8710 comm=\"firefox\" requested_mask=\"x\" denied_mask=\"x\" fsuid=1000 ouid=1000\n```\n","comments":[{"author":"troubadour","date_created":1435440781,"date_modified":1435440781,"content":"Added.\nhttps://github.com/troubadoour/apparmor-profile-torbrowser/commit/ba49d7a460386e6ca9974b8933c53ce841b2f772"},{"author":"Patrick","date_created":1435527471,"date_modified":1435527471,"content":"Merged.\n\nGot another denied message.\n\n> apparmor=\"DENIED\" operation=\"rename_src\" profile=\"/home/*/tor-browser_*/Browser/firefox\" name=\"/home/user/tor-browser_en-US/Browser/\" pid=19495 comm=\"updater\" requested_mask=\"wd\" denied_mask=\"wd\" fsuid=1000 ouid=1000\n"},{"author":"Patrick","date_created":1441727744,"date_modified":1441727744,"content":">>! In T364#5759, @Patrick wrote:\n>> apparmor=\"DENIED\" operation=\"rename_src\" profile=\"/home/*/tor-browser_*/Browser/firefox\" name=\"/home/user/tor-browser_en-US/Browser/\" pid=19495 comm=\"updater\" requested_mask=\"wd\" denied_mask=\"wd\" fsuid=1000 ouid=1000\n\nIs this solved? @troubadour"},{"author":"troubadour","date_created":1442093385,"date_modified":1442093385,"content":"Yes, it should be in commit `60bf3b98cf3cd0b20c9f186a3e896cb678758e99`\nhttps://github.com/troubadoour/apparmor-profile-torbrowser/commit/60bf3b98cf3cd0b20c9f186a3e896cb678758e99"}]},"PHID-TASK-6gghk3wpyerbkirfpi6f":{"id":"363","title":"Request Redirection to localhost","status":"invalid","priority":"Normal","author":"HulaHoop","description":"This ticket is for a working/stable workaround for localhost connections\n\nI found the solution I had been really looking for when I made the faulty proposal in https://phabricator.whonix.org/T343\n\nThe idea: an iptables entry on the workstation to reroute requests by TBB that consist of an arbitrarily chosen non RFC-1918 private address to localhost, transparently. This tricks TBB into believing its connecting to a normal address when in reality its to 127.0.0.1\n\nThis rule can be toggled on or off as any other custom iptables script. It would be off by default though.\n\n***\n\nSource: \nhttps://serverfault.com/questions/171850/redirect-request-to-an-external-ip-to-localhost-emulate-a-server\nhttps://serverfault.com/a/171882\n\n","comments":[{"author":"Patrick","date_created":1435098063,"date_modified":1435098063,"content":"Do you have it working or is this TODO research?\n\nAlso if this were to work, we'd be back with the same fingerprinting issues which Tor Browser wants to defend against by blocking local connections in the first place? I mean, if `<some private ip>` is a shortcut for `127.0.0.1`, then any website could fingerprint `<some private ip>` having the same effect as fingerprinting `127.0.0.1`.\n\nWe'd have the same effect by allowing local connections in Tor Browser in the first place. And the same fingerprinting issues.\n\nPerhaps keeping `<some private ip>` secret [chosen by user] and making this a user-documentation-only thing?\n\nOr am I totally off the track?"},{"author":"HulaHoop","date_created":1435098806,"date_modified":1435098806,"content":">Do you have it working or is this TODO research?\n\nStill research as I haven't tried it yet.\n\n>Also if this were to work, we'd be back with the same fingerprinting issues which Tor Browser wants to defend against by blocking local connections in the first place? \n\n>I mean, if <some private ip> is a shortcut for 127.0.0.1, then any website could fingerprint <some private ip> having the same effect as fingerprinting 127.0.0.1. We'd have the same effect by allowing local connections in Tor Browser in the first place. And the same fingerprinting issues.\n\nTrue. That's why if we decide to choose the IP this feature would be disabled by default. But the advantage is, we would have something stable for documentation.\n\n>Perhaps keeping <some private ip> secret [chosen by user] and making this a user-documentation-only thing?\n\nIf we go this route then its best to incorporate it as a whonixsetup feature? That way it would be safe to leave enabled. Its very unlikely a website will automatically scan the entire non 1918 address space with JS and be able to reliably pinpoint that they found services running on the local machine that way."},{"author":"Patrick","date_created":1435168783,"date_modified":1435168783,"content":">>! In T363#5706, @HulaHoop wrote:\n>>Perhaps keeping <some private ip> secret [chosen by user] and making this a user-documentation-only thing?\n> \n> If we go this route then its best to incorporate it as a whonixsetup feature? That way it would be safe to leave enabled.\n\nWell, before considering this, it has to work at all.\n\n> Its very unlikely a website will automatically scan the entire non 1918 address space with JS and be able to reliably pinpoint that they found services running on the local machine that way.\n\nWhy is that unlikely once we apply that solution? That's maybe just a small function that loops through all ports away.\n"},{"author":"HulaHoop","date_created":1435194727,"date_modified":1435194727,"content":">Why is that unlikely once we apply that solution? That's maybe just a small function that loops through all ports away.\n\nTrue. It won't solve the security problems I though it would and so it can't be enabled by default. \n\nAlso it doesn't make sense as a usability feature because enabling it will need the command line. That would be harder than the documented workaround we have now.\n\nI'll close this now."}]},"PHID-TASK-n6p2gnpqia7hofexrswe":{"id":"362","title":"systemd SystemCallFilter= containment option seccomp hardening","status":"resolved","priority":"Normal","author":"HulaHoop","description":"This will likely easily be possible once we're based on #debian_version_9_codename_stretch.\n\nSource:\n- https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=760299\n- https://packages.debian.org/search?keywords=systemd\n\n***\n\nOnce available, its a matter of adding whitelisted calls using SystemCallFilter= in a service unit file.\n\nstrace logs may help further debugging:\n\nhttps://forums.whonix.org/t/cpfpd-data-options-control-port-filter-python-hardening/1146\n\n-----\n\nWorth checking out... Quote: [Tails report for January, 2016](https://tails.boum.org/news/report_2016_01/)\n\n> Change to systemd as init system and use it to:\n> * Sandbox many services using Linux namespaces and make them harder to exploit.","comments":[{"author":"Patrick","date_created":1573007661,"date_modified":1573007661,"content":"This was done. If not, please create specific tickets where it isn't done."}]},"PHID-TASK-s2nkp423ancjgm7wat2k":{"id":"361","title":"Migrating from IRC OFTC to Tor friendly IRC network","status":"open","priority":"Normal","author":"HulaHoop","description":"OFTC while welcoming Tor users is mostly unavailable because of blocks against abuse. Our official support channel has become mostly useless.\n\nI propose choosing a different network from this page and moving to it:\n\nhttps://trac.torproject.org/projects/tor/wiki/doc/BlockingIrc \n(Networking that try to provide normal access to Tor and remove K-lines)\n\nSome networks have an Onion Service dedicated to Tor users.\nAnonymous access should be possible and not pseudo-anonymity measures like SASL.\n\nShould coordinate with Qubes.\n`migrate \"unofficial\" IRC channel to tor-friendly network`:\nhttps://github.com/QubesOS/qubes-issues/issues/1571\n\nThe Tor Project bug report:\n`move away from OFTC to new functional, Tor-friendly IRC network`\nhttps://trac.torproject.org/projects/tor/ticket/18002","comments":[{"author":"Patrick","date_created":1435458467,"date_modified":1435458467,"content":"Ideally the new network would also offer an additional webchat (web gateway to it's irc network) as [OFTC offered](http://www.oftc.net/WebChat/).\n\nThis [small list](https://trac.torproject.org/projects/tor/wiki/doc/BlockingIrc#NetworksthattrytoprovidenormalaccesstoTorandremoveK-lines) of Tor friendly IRC networks gets even smaller, because networks are listed there, which don't provide a great service to Tor users. Namely freenode and OFTC.\n\nAny recommendations which IRC network we should pick?"},{"author":"HulaHoop","date_created":1435534664,"date_modified":1435534664,"content":"DarkScience has a dedicated Onion Service."},{"author":"IronSoldier","date_created":1440895593,"date_modified":1440895593,"content":"OFTC actually allows Tor connections via any IRC client. Actual limitation is that you can't connect by the webchat.\n\nSo far there is not much IRC networks that allows Tor. Outside of OFTC, I also use Agora (Anarplex).\n\nAgora offer a webchat (https://anarplex.net/webirc/) and allows connection from Tor (via clearnet address or .onion). As already discussed before, the downside of it is that users are forced to join #agora on connect.... However this is not a major problem IMHO.\n\nFROM https://anarplex.net/agorairc/connect.html: \n\n\nConnect from the Clearnet\nConnect directly (via Chatzilla, etc.): ircs://agora.anarplex.net:14716/#agora.\n\nHost: agora.anarplex.net\nPort: 14716\n\nConnecting requires SSL, the certificate might be expired (which is not a problem unless you sell SSL certificates).\nConnect to Tor hidden service\nConnect directly (via Chatzilla, etc.): irc://cfyfz6afpgfeirst.onion:6667/#agora.\n\nHost: cfyfz6afpgfeirst.onion\nPort: 6667\n\nConnection is already encrypted by Tor, so do NOT enable additional SSL for the connection. "},{"author":"IronSoldier","date_created":1440905174,"date_modified":1440905251,"content":"Other option would be to run our own IRC server with strict rules (Access to only Whonix channel, mandatory registration (match with forum registration database ?)\n\nIt would requests some server ressources and a bit of time but it can be done..."},{"author":"Patrick","date_created":1440929074,"date_modified":1440929074,"content":"Official #Tor is still on OTFC. Currently OTFC works for Tor users. Let's see.\n\nNext time it does not work, can you please bring this up on tor-talk about #Tor? @HulaHoop"},{"author":"HulaHoop","date_created":1440966538,"date_modified":1440966538,"content":"Hi IronSoldier! I haven't seen you around for a while. \n\nDid you put your Strategic Intelligence Network site online again? \n\nI put up a guide on using syncthing with Onion services after you told me you were looking for easy ways to sync site mirrors:\n\nhttps://www.whonix.org/w/index.php?title=Hidden_Services_Guides#Syncthing_with_OnionCat\n\n\n***\n\nBefore, OFTC blocked all Torrified IRC client connections from webchat and dedicated clients but recently they've permanently blocked anonymous webchat on their site and left IRC clients alone.\n\nGood suggestions IronSoldier.\n\n\n@Patrick I'll post on Tor talk if it happens again."},{"author":"Patrick","date_created":1451834424,"date_modified":1451834424,"content":">>! In T361#6605, @Patrick wrote:\n> Official #Tor is still on OTFC. Currently OTFC works for Tor users. Let's see.\n> \n> Next time it does not work, can you please bring this up on tor-talk about #Tor? @HulaHoop\n\n>>! In T361#6607, @HulaHoop wrote:\n> @Patrick I'll post on Tor talk if it happens again.\n\nIf [this is](https://forums.whonix.org/t/whonix-12-0-0-3-2-rc-testers-wanted/1646/68) still an issue, now would be a good time."},{"author":"HulaHoop","date_created":1451859451,"date_modified":1451859451,"content":"Done."},{"author":"Patrick","date_created":1451909035,"date_modified":1451909035,"content":"* https://lists.torproject.org/pipermail/tor-talk/2016-January/039818.html\n* https://lists.torproject.org/pipermail/tor-talk/2016-January/039823.html\n"},{"author":"Patrick","date_created":1452000980,"date_modified":1452000980,"content":">>! In T361#6604, @IronSoldier wrote:\n> Other option would be to run our own IRC server with strict rules (Access to only Whonix channel, mandatory registration (match with forum registration database ?)\n> \n> It would requests some server ressources and a bit of time but it can be done...\n\nI don' think we want to host our own server. That's problematic legal wise. (If users abuse using the private messaging function.) Better left to dedicated projects. The nice thing about public IRC is the synergy effects. People hanging out in multiple channels.\n\n> Agora offer a webchat (https://anarplex.net/webirc/) and allows connection from Tor (via clearnet address or .onion). As already discussed before, the downside of it is that users are forced to join #agora on connect.... \n\nNot great. But if Qubes, Torproject and Tails do not mind about this, I would not mind either.\n\n-----\n\n`move away from OFTC to new functional, Tor-friendly IRC network`:\nhttps://trac.torproject.org/projects/tor/ticket/18002"},{"author":"IronSoldier","date_created":1453753740,"date_modified":1453753740,"content":"Sorry for the delay... Even after having changed my email, Phabricator still sends email to my old one that I review about once a month....\n\nAnother option that I start to prefer over IRC is XMPP (aka jabber). We can run an XMPP Multi-User Chat (MUC) room.\n\n Riseup.net is offering that : https://help.riseup.net/en/chat#connecting-to-multi-user-chatrooms\n\nSo whoever can join that chat room, registration can be done using about any providers (The ones I know that are privacy oriented : openxmpp.com, jabber.calyxinstitute.org, riseup.net)\n\nSecureChat use jabber.calyxinstitute.org to create burner identity... I guess it can easily be done with a client like pidgin..."},{"author":"HulaHoop","date_created":1453865101,"date_modified":1453865101,"content":"If you go down the XMPP path please install anything but libpurple."},{"author":"IronSoldier","date_created":1453900711,"date_modified":1453900711,"content":"I would recommend pidgin. It offer OTR (Off-The-Record) pluggin, is multi-protocol (XMPP, IRC, ICQ...) and Tails used a hardened version restricting protocol to IRC and XMPP only.\n\nThe regular version of pidgin is easy to install from debian repos (apt-get install pidgin pidgin-otr). It may need a bit of adaptation for xchat/mirc users but once you get it is not that much complicated."},{"author":"HulaHoop","date_created":1453950086,"date_modified":1453950086,"content":"@IronSoldier my comment was vague and I don't want to digress from the thread topic. \n\nIts been mentioned in security circles that the XMPP library libpurple which Pidgin and other opensource IM programs are based is full of 0days - many remotely exploitable.\n\nOur best bet is gajim or Adam Langley's xmpp-client once a gui is written for it (written in type safe languages)"},{"author":"mfc","date_created":1453979070,"date_modified":1453979070,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>   @IronSoldier my comment was vague and I don't want to digress from the thread topic.\n>   \n>   Its been mentioned in security circles that the XMPP library libpurple which Pidgin and other opensource IM programs are based is full of 0days - many remotely exploitable.\n>   \n>   Our best bet is gajim or Adam Langley's xmpp-client once a gui is written for it (written in type safe languages)\n> \n> TASK DETAIL\n>   https://phabricator.whonix.org/T361\n> \n> EMAIL PREFERENCES\n>   https://phabricator.whonix.org/settings/panel/emailpreferences/\n> \n> To: Patrick, HulaHoop\n> Cc: IronSoldier, bnvk, fortasse, JasonJAyalaP, crackman, Linostar, wax, joanna, MemoryLost, mfc, marmarek, nrgaway, Patrick, troubadour, HulaHoop, WhonixQubes\n\nThis is a discussion of servers not clients, please keep it on topic."},{"author":"Patrick","date_created":1454434900,"date_modified":1454434900,"content":"I don't think XMPP chats are practical for various reasons which I elaborated here:\nhttps://github.com/QubesOS/qubes-issues/issues/1571#issuecomment-16866697\n\nI would consider XMPP chat not a solution to this ticket but consider it a new feature. If you want to create such a XMPP chat room, please create a new ticket (if useful). Feel free to go for XMPP chat. Probably good idea. Let's give it a test run. We could mention it on https://www.whonix.org/wiki/Support and if it's useful for some users why not."},{"author":"lynX","date_created":1463047340,"date_modified":1463047340,"content":"I would not recommend using a public IRC network for the reasons discussed in http://about.psyc.eu/IRC. The reasoning also applies to XMPP chatrooms as all of its traffic goes through federation, so XMPP is usually even worse."}]},"PHID-TASK-dm4tx4n2w74hk3j4v7g6":{"id":"360","title":"cpfpd define Address Families for hardening","status":"invalid","priority":"Needs Triage","author":"HulaHoop","description":"RestrictAdressFamilies, a systemd.exec feature would have been a good option to bring limit surface attack because it excludes obscure protocols from interacting with the daemon, but its not available on x86:\n\nQuote:\n\n    \"RestrictAddressFamilies=\n\n     Note that this option has no effect on 32-bit x86 and is ignored (but\n     works correctly on x86-64).\"\n\n\nUnfortunately iptables cannot recognize or limit address families it is something up to the process itself:\n\nhttps://stackoverflow.com/a/19377464\n\n\nThis is something that can be defined in the python script by specifying\nit as a socket parameter:\n\n\nhttps://docs.python.org/2/library/socket.html\n\nsearch for AF_INET\n\n\ncpfpd's code could include this for further hardening.\n","comments":[{"author":"HulaHoop","date_created":1434919982,"date_modified":1434919982,"content":"Looks like I should have looked more carefully. Its already in there. My bad.\n\n```\nConnect to the real control port\nsock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)\n```"}]},"PHID-TASK-yjxjjxje2svwwld5m3mr":{"id":"359","title":"tb-starter should check permissions before cd'ing into Tor Browser folder to provide better error message in corner cases","status":"resolved","priority":"Normal","author":"Patrick","description":"As per the corner case issue that a user has recently run into... (https://www.whonix.org/forum/index.php/topic,1323.0.html)\n\nEither #tb-starter should check if `/home/user/tor-browser_en-US/` permissions are correct and/or if `cd /home/user/tor-browser_en-US/` fails, a useful error message should be shown. (Could be various issues. Permission issues or hdd failures.)","comments":[{"author":"Patrick","date_created":1436540596,"date_modified":1436540596,"content":"`check permissions before cd'ing into Tor Browser folder to provide better error message in corner cases for better usability - https://phabricator.whonix.org/T359`:\nhttps://github.com/Whonix/tb-starter/commit/ae5010076bd3be814093a6c86e0e7c594b839958\n"}]},"PHID-TASK-jvyjwe5jc3pm2y3hoim7":{"id":"358","title":"fix power-savings-disable-in-vms 'su -' issue","status":"resolved","priority":"Normal","author":"Patrick","description":"[Reported by ir1s.](https://www.whonix.org/forum/index.php/topic,1304.msg8527.html#msg8527)\n\n`su -` in Konsole results in.\n\n```\nsetterm: terminal xterm does not support --blank\n```\n\nNot critical.","comments":[{"author":"Patrick","date_created":1434569029,"date_modified":1434569029,"content":"`fix 'su -' issue, refactoring - https://phabricator.whonix.org/T358`:\nhttps://github.com/Whonix/power-savings-disable-in-vms/commit/7424a2c5c31c2e9dd6d1232e7ef3cd5ffb9e6dae\n"}]},"PHID-TASK-rlfc2vo5ufarn3k4fv5w":{"id":"357","title":"uwt: set AllowOutboundLocalhost / AllowInbound and abolish UWT_DEV_PASSTHROUGH / uwt circumvention hack","status":"resolved","priority":"Normal","author":"Patrick","description":"Quote https://lists.torproject.org/pipermail/tor-talk/2015-May/037979.html:\n\n> - AllowOutboundLocalhost option allows torsocks to connect to a\n>  localhost address.\n\nIt might help to abolish to whole `UWT_DEV_PASSTHROUGH` hack / [uwt circumvention confusion, explanation](https://www.whonix.org/wiki/Stream_Isolation#Deactivate_uwt_Stream_Isolation_Wrapper).\n\n-----\n\n#debian_stretch /etc/tor/torsocks.conf\n```\n# Set Torsocks to accept inbound connections. If set to 1, listen() and\n# accept() will be allowed to be used with non localhost address. (Default: 0)\n#AllowInbound 1\n```\n\n```\n# Set Torsocks to allow outbound connections to the loopback interface.\n# If set to 1, connect() will be allowed to be used to the loopback interface\n# bypassing Tor. If set to 2, in addition to TCP connect(), UDP operations to\n# the loopback interface will also be allowed, bypassing Tor. This option\n# should not be used by most users. (Default: 0)\n#AllowOutboundLocalhost 1\n```\n\n-----\n\nTODO:\n\n* Test the new torsocks `AllowOutboundLocalhost` option.\n* Consider setting this option by default.\n* Depending on above, consider removing `UWT_DEV_PASSTHROUGH` from Whonix code everywhere. (`grep -r UWT_DEV_PASSTHROUGH *`)\n","comments":[{"author":"Patrick","date_created":1484729152,"date_modified":1484729152,"content":"https://github.com/Whonix/uwt/commit/86d553a63a3a90d7e9b57edc9e2998df6cc17a70"},{"author":"Patrick","date_created":1484730048,"date_modified":1484730048,"content":"`/etc/tor/torsocks.conf AllowInbound 1` - safe in Whonix-Workstation and can help making Tor hidden services based servers work.\n\nhttps://github.com/Whonix/uwt/commit/b7d4101af1c7d8c95872b03abb52c0a2bbcda87f"}]},"PHID-TASK-jmayddjnoqkqcxzepkzq":{"id":"356","title":"uwt: set TORSOCKS_ISOLATE_PID in Debian Stretch?","status":"resolved","priority":"Normal","author":"Patrick","description":"There isn't a lot information on `TORSOCKS_ISOLATE_PID` yet. Will be introduced in the torsocks version which is now in #Debian_Stretch.\n\nQuote https://lists.torproject.org/pipermail/tor-talk/2015-May/037979.html:\n\n>- IsolatePID is a new option that will make torsocks set the SOCKS5\n>  username and password automatically to provide isolation on Tor side.\n>\n>  You can use this with the -i,--isolate command added or\n>  TORSOCKS_ISOLATE_PID env. variable.\n\nIt could help to get rid of the whole #uwt [temporary file creation hack](https://github.com/Whonix/uwt/blob/568a0e4737e2e5f2d698c017d78bfa9e5624a433/usr/bin/uwt#L176-268).","comments":[{"author":"HulaHoop","date_created":1434591858,"date_modified":1434591858,"content":">It could help to get rid of the whole uwt temporary file creation hack.\n\nYes.\n\n\nMore information:\n\nhttps://www.mankier.com/8/torsocks\n\n>TORSOCKS_ISOLATE_PID\n    Set the username and password for the SOCKS5 authentication method to a PID/current time based value automatically. Username and Password MUST NOT be set. \n\nhttps://lists.torproject.org/pipermail/tor-dev/2015-May/008871.html\n\n> *Change IsolatePID password from 42 to 0\n   *Add automatic per process isolation (IsolatePID)\n\n\nAFAICT this will be default behavior since we don't set passwords for Tor SOCKS. It will isolate circuits based on different PIDs it detects automatically. "},{"author":"Patrick","date_created":1484728654,"date_modified":1484728654,"content":"Not enabled by default.\n\n#debian_stretch `/etc/tor/torsocks.conf`\n```\n# Set Torsocks to use an automatically generated SOCKS5 username/password based\n# on the process ID and current time, that makes the connections to Tor use a\n# different circuit from other existing streams in Tor on a per-process basis.\n# If set, the SOCKS5Username and SOCKS5Password options must not be set.\n# (Default: 0)\n#IsolatePID 1\n```"},{"author":"Patrick","date_created":1484730234,"date_modified":1484730234,"content":"https://github.com/Whonix/uwt/commit/c2f471d97573680bf00992ac775296da0fe9ac35"},{"author":"Patrick","date_created":1484730404,"date_modified":1484730404,"content":"https://github.com/Whonix/uwt/commit/d1a64bd9a6016ee527b127b380676f97aa1d53ca"},{"author":"Patrick","date_created":1484730517,"date_modified":1484730517,"content":"https://github.com/Whonix/uwt/commit/66447a54d37a88a78bb9a2056cd410c0c2bf12ab"},{"author":"Patrick","date_created":1484731514,"date_modified":1484731514,"content":"https://www.whonix.org/wiki/Stream_Isolation#Whonix_14_and_above"}]},"PHID-TASK-eguhfbdj3ifhqkl23cy3":{"id":"355","title":"understand / consider systemd ApparmorProfile= option","status":"resolved","priority":"Normal","author":"Patrick","description":"Once #Whonix will be based on #Debian_Stretch, #systemd will provide an `ApparmorProfile=` option.\n\nQuoted from https://wiki.debian.org/AppArmor/Progress:\n\n> Integrate with systemd by: waiting for systemd v210+, which has a ApparmorProfile= option, or ship upstart's /lib/init/apparmor-profile-load as an apparmor helper script and call it in systemd's ExecPreStart= \n\nQuoted from http://manpages.debian.org/cgi-bin/man.cgi?&query=systemd.exec:\n\n>       AppArmorProfile=\n>           Takes a profile name as argument. The process executed by the unit\n>           will switch to this profile when started. Profiles must already be\n>           loaded in the kernel, or the unit will fail. This result in a non\n>           operation if AppArmor is not enabled. If prefixed by \"-\", all\n>           errors will be ignored.\n\n#control-port-filter-python's AppArmor profile [/etc/apparmor.d/usr.sbin.cpfpd](https://github.com/Whonix/control-port-filter-python/blob/master/etc/apparmor.d/usr.sbin.cpfpd) is effective without that option. One can verify that by test wise out commenting something form the profile. After reboot, denied messages would pop up.\n\nTODO #research:\n\n* What's the `ApparmorProfile=` option good for?\n* Should we use it?\n* Should we prefix by `-`?\n","comments":[{"author":"HulaHoop","date_created":1434590775,"date_modified":1434590775,"content":">What's the ApparmorProfile= option good for?\n\nI'm still unsure as to the exact benefits from it but upstream decided to go with it in their Tor service file. I was going to ask for more information but OFTC has been out the whole day.\n\nhttps://trac.torproject.org/projects/tor/ticket/8368"},{"author":"troubadour","date_created":1434661522,"date_modified":1434661522,"content":"Looks like this option is not implemented.\nAdded \n```AppArmorProfile=/etc/apparmor.d/usr.sbin.cpfpd```\nin `control-port-filter-python.service`. It works as expected.\nBut with a typo\n```AppArmorProfile=/etc/apparmor.d/usr.sbin.cpf```\nIt still works. `sudo service control-port-filter-python status` reports `active (running)`, and the process is still enforced."},{"author":"HulaHoop","date_created":1434731473,"date_modified":1434731473,"content":"Jessie has systemd 215, meaning this *should* be in there. If its not working its probably a bug.\n"},{"author":"HulaHoop","date_created":1434732447,"date_modified":1434733269,"content":"Progress information on this feature in Debian:\n\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=760526\n\nYes there was a bug with the filesystem protections of apparmor and systemd conflicting. Improvements were added upstream in both projects but came late for the Jessie merge window. \n\nTo understand more the purpose of this feature please read the mail list discussion."},{"author":"Patrick","date_created":1434829911,"date_modified":1434829911,"content":"Yes, `AppArmorProfile=` is >= #Debian_Stretch only.\n\nI think I now understand what's it about. It's useful if we wanted to contain a daemon but not maintain a system wide apparmor profile for that daemon. Such as Debian's system_tor profile for Tor. It apparmor-contains the daemon, but starting the daemon manually from the command line is unsupported by that profile.\n\nOur options once using #Debian_Stretch.\n\na) `dh-apparmor` way\n\n* Use `dh-apparmor`.\n* Not using systemd's `AppArmorProfile=`\n* Ship \"global\" profiles.\n* Like we currently do with cpfpy in Whonix 11.\n\nb) systemd's `AppArmorProfile=` way\n\n* Not using `dh-apparmor`.\n* Using systemd's `AppArmorProfile=`\n* We ship system profiles only (example: `system_cpfpy`).\n\nWith our current method a) that we are using for cpfpy, there is a \"bug\". Users could not easily start secondary instances of cpfpy from command line with separate options while profiting from AppArmor. That use case isn't needed. No one ever required that. Method b) would be a bit more correct. It would be more clear, that we only support the AppArmor use case in context of the default systemd unit file. The \"missing feature\" would then be \"you only have a \"system\" AppArmor profile, no \"global\" one. Not \"perfect\" either way, but certainly good enough for a long time either way, looks like. (Also \"perfect\" here would mean a code and support for stuff that one one even raised.)\n\nWith our current daemons, AppArmor profiles and users this whole thing is a corner case. I recommend we just leave it as it - because it works - until it comes up and/or just say \"patches welcome\"."},{"author":"Patrick","date_created":1455064688,"date_modified":1455064688,"content":"A related issue....\n`systemd AppArmorProfile= directive unavailable leads to not loading AppArmor profile on Debian jessie`:\n* https://trac.torproject.org/projects/tor/ticket/18294\n* https://www.whonix.org/pipermail/whonix-devel/2016-February/000561.html\n* https://forums.whonix.org/t/whonix-apparmor-profiles-development-discussion/108/640?u=patrick"},{"author":"Patrick","date_created":1455064800,"date_modified":1455064800,"content":"T355#5608 should be a good enough summary. And done. Nothing left to do here."}]},"PHID-TASK-nubigwy6zl2xsx5vtey2":{"id":"354","title":"Add grub-screen-resolution and grub-output-verbose to anon-meta-packages?","status":"resolved","priority":"Normal","author":"Patrick","description":"T26 and T27 are done, but it has been forgotten to add #grub-screen-resolution and #grub-output-verbose to #anon-meta-packages.\n\nRelated:\nT353\n","comments":[{"author":"Patrick","date_created":1434344231,"date_modified":1434344231,"content":"Dependency is non-ideal because of #Qubes (T353).\n\n`added grub-screen-resolution and grub-output-verbose as weak recommended packages - https://phabricator.whonix.org/T354`:\nhttps://github.com/Whonix/Whonix/commit/979c4393bd5e2d6ae20c690e39bb377d6244809e\n\nIncluded in Whonix `11.0.0.3.0-developers-only`."}]},"PHID-TASK-g5ifixn2ybc7iutqy6t5":{"id":"353","title":"grub configuration packages review for Qubes","status":"resolved","priority":"Normal","author":"Patrick","description":"Can you please have a short look at these three simple configuration files?\n\n-----\n\n1) https://github.com/Whonix/grub-enable-apparmor/blob/master/etc/default/grub.d/30_apparmor.cfg\n\nShould be fine in #Qubes?\n\n-----\n\n2) https://github.com/Whonix/grub-screen-resolution/blob/master/etc/default/grub.d/30_screen_resolution.cfg\n\nBetter not installed on #Qubes, not useful?\n\n-----\n\n3) https://github.com/Whonix/grub-output-verbose/blob/master/etc/default/grub.d/30_output_verbose.cfg\n\nBetter not installed on #Qubes, not useful?\n","comments":[{"author":"marmarek","date_created":1434329518,"date_modified":1434329518,"content":"Qubes VMs (currently) does not use grub at all - Xen loads kernel\ndirectly from dom0 filesystem (yes, VM have no influence on kernel\nbinary and parameters).\nSo, those files will not be used at all.\n\nBut we might introduce support for pvgrub some day, and then it\nwill matter. From those three files, IMO only graphic mode may cause\nsome troubles.\n\n  - {F107, layout=link}"},{"author":"Patrick","date_created":1434330062,"date_modified":1434330062,"content":"Alright. That answers my question. Thanks!"}]},"PHID-TASK-rdy2icthhbc5fadlrg2r":{"id":"352","title":"Make Onion Key backup more accessible","status":"resolved","priority":"Normal","author":"HulaHoop","description":"This ticket is a sub-task of https://phabricator.whonix.org/T21. This is for the design and implementation of an automatic backup mechanism for Onion Site keys.\n\nDesign Points:\n\n*lsyncd configured like the example section \"Inotify Backup - Backup Files When Changed\" from http://backdrift.org/recursive-inotify-scripting-with-lsyncd.\n\n*a systemd service that runs lsyncd command: lsyncd -pidfile /var/run/backup.lsyncd /etc/lsyncd.d/backup.lsyncd\n\nThe backup target will be the user home folder. The user makes a decision when and if the keys should go into the shared folder. For example they will want to do this when only the gateway is permitted access to the shared folder for security. ","comments":[{"author":"HulaHoop","date_created":1434398936,"date_modified":1434398936,"content":"This works on system startup\n\n```\n[Unit]\nDescription=Automatically syncs Onion Site keys to the home folder\nConditionPathExists=/var/lib/tor\n\n[Service]\nType=oneshot\nExecStart=/usr/bin/rsync -a --chown=user:user -br /var/lib/tor /home/user\n\n[Install]\nWantedBy=multi-user.target\n```\n\nFor presentation I tried adding: /bin/rm -f /home/user/tor/* as an  ExecStartPost but it doesn't work.\n\n\nIt would be nice to have this service as a daemon running constantly so it would create a backup during a session instead of needing a restart but I don't know how."},{"author":"Patrick","date_created":1434461920,"date_modified":1434461920,"content":"What's the purpose of this? Users being able to more easily find their onion keys since FHS is not really user intuitive?\n\nLet's suppose on shutdown /var/lib/tor gets damaged. After reboot the backup in home would be overridden. No advantage by this auto backup. It would require a versioned backup where old files aren't automatically deleted.\n\nPossible confusion: On restoration, users won't be trying to copy their keys into home and then wonder why those will not be used by Tor?\n\nWhat I personally find useful in such cases is putting such folders under version control using `git init`. I haven't researched automation yet. Any (atomic) damages could be detected and rolled back to a working version. However, for end users the usability of git doesn't suffice. Not an end user tool."},{"author":"HulaHoop","date_created":1434473038,"date_modified":1434473038,"content":">What's the purpose of this? Users being able to more easily find their onion keys since FHS is not really user intuitive?\n\nI guess. Now that you bring it up I'm not convinced that it makes sense anymore. Good points you bring up on limitations too. \n\nWe shouldn't try to invent GUIs and usability hacks all over the place when everything is one or two commands away. However a very simple solution that makes the tor folder accessible from the desktop would make sense and not be a \"usability hack\".\n\nSomething like the desktop shortcut \"Tor user config\" on gw, that opens /var/lib/tor via kdesudo dolphin is a good idea. A user opens the folder up and copies what ever they need into a shared folder.\n\n"},{"author":"Patrick","date_created":1434473414,"date_modified":1434473414,"content":"> Something like the desktop shortcut \"Tor user config\" on gw, that opens /var/lib/tor via kdesudo dolphin is a good idea. A user opens the folder up and copies what ever they need into a shared folder.\n\nThat makes sense. New ticket?\n\nProblem is once you open dolphin via kdesudo and copy some files, those will be owned by root. So copied as root to shared folders. I guess users would wonder why they cannot delete their files once access from the host (owned by root, not user account)?"},{"author":"HulaHoop","date_created":1434473857,"date_modified":1434473857,"content":"Notes to self:\n\nanon-gw-anonymizer-config\n/usr/lib/gateway-shortcuts/tordata\n\n```\nset -x\n\nkdesudo dolphin /var/lib/tor\n```\n"},{"author":"HulaHoop","date_created":1434492958,"date_modified":1434492958,"content":">That makes sense. New ticket?\n\nI didn't see your reply before I posted. I think I'll just keep this ticket and change its title to reflect the new direction its taken.\n\n>Problem is once you open dolphin via kdesudo and copy some files, those will be owned by root. So copied as root to shared folders. I guess users would wonder why they cannot delete their files once access from the host (owned by root, not user account)?\n\nShouldn't matter because with KVM shared folders, any file moved in there hs its permissions/owner changed to qemu no matter what and will need to have chown run on the host to be able to interact with them there.\n\nSo nothing will change from the POV of usability for whats happening now."},{"author":"Patrick","date_created":1434497087,"date_modified":1434497087,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n>> That makes sense. New ticket?\n> \n> \n> I didn't see your reply before I posted. I think I'll just keep this ticket and change its title to reflect the new direction its taken.\n\nOk.\n\n>> Problem is once you open dolphin via kdesudo and copy some files, those will be owned by root. So copied as root to shared folders. I guess users would wonder why they cannot delete their files once access from the host (owned by root, not user account)?\n> \n> \n> Shouldn't matter because with KVM shared folders, any file moved in there hs its permissions/owner changed to qemu no matter what and will need to have chown run on the host to be able to interact with them there.\n> \n> So nothing will change from the POV of usability for whats happening now.\n\nAlright.\n\nAny chance to make this also work for VBox?"},{"author":"HulaHoop","date_created":1434499981,"date_modified":1434499981,"content":"It would make sense that VBox would need recursive chown on the host as well (if it didn't already). Can you test it?"},{"author":"Patrick","date_created":1434500708,"date_modified":1434500708,"content":"Yes. Also a non-issue for VBox. Gets permission of the user even when\nusing `sudo touch /mnt/shared/test-file`. Great."},{"author":"HulaHoop","date_created":1434589238,"date_modified":1434589238,"content":"Is anything else besides https://phabricator.whonix.org/T352#5550 needed to create the shortcut?"},{"author":"Patrick","date_created":1434827834,"date_modified":1434827834,"content":"Yes, the `.desktop` file.\nFolder: https://github.com/Whonix/anon-gw-anonymizer-config/tree/master/usr/share/applications\n"},{"author":"HulaHoop","date_created":1434907574,"date_modified":1434907574,"content":"Please review pulls and feel free to close ticket when merged:\n\nhttps://github.com/Whonix/anon-gw-anonymizer-config/pull/2\n\nhttps://github.com/Whonix/anon-gw-anonymizer-config/pull/1"},{"author":"Patrick","date_created":1434989849,"date_modified":1434989849,"content":"For a shortcut, modification of https://github.com/Whonix/whonix-gw-desktop-shortcuts/blob/master/debian/whonix-gw-desktop-shortcuts.postinst#L24 is required."},{"author":"HulaHoop","date_created":1434996611,"date_modified":1434996611,"content":"Done.\n\nhttps://github.com/Whonix/whonix-gw-desktop-shortcuts/pull/1"},{"author":"Patrick","date_created":1436538180,"date_modified":1436538180,"content":"All merged.\n\n`chmod +x usr/lib/gateway-shortcuts/tordata`:\nhttps://github.com/Whonix/anon-gw-anonymizer-config/commit/bac763816f16cc5fd9dbd0c7ab261db8f351289a\n\nWhat happens in case the folder does not exist? I.e. at first boot without having Tor enabled at this point? Most likely won't work then as is currently."},{"author":"HulaHoop","date_created":1436575772,"date_modified":1436575772,"content":"I'm not sure. Its not a problem f it doesn't fail hard with a confusing error message. The time between enabling Tor and using the folder will be small enough that it won't inconvenience anyone."},{"author":"Patrick","date_created":1436576349,"date_modified":1436576349,"content":"It would be confusing if users wanted to restore their old folder before they start. But nevermind. It's a non-issue. The postinst will have /var/lib/tor created already."},{"author":"Patrick","date_created":1438184248,"date_modified":1438184248,"content":"Anything left to do here? Besides testing as soon as a new test image is released?"},{"author":"HulaHoop","date_created":1438195922,"date_modified":1438195922,"content":"Nope."}]},"PHID-TASK-72tzuxctj7bjb4hcz6je":{"id":"351","title":"let qubes-whonix master branch reflect latest commits","status":"wontfix","priority":"Normal","author":"Patrick","description":"> I was wrong about a few things on how it's actually handled in QubesOS. - See T351#5797\n\n__current situation__:\n\n[qubes-whonix](https://github.com/nrgaway/qubes-whonix) package:\n\n* currently Whonix11 branch contains latest commits\n* master contains status of latest Whonix stable (Whonix 10 at time of writing)\n\nall [Whonix](https://github.com/Whonix) packages, such as [whonix-gw-firewall](https://github.com/Whonix/whonix-gw-firewall) etc.\n\n* master contains status of latest developments\n* Whonix10 maintenance branch\n* Whonix11 maintenance branch (since soon to be released)\n\nmost (all?) [Qubes](https://github.com/QubesOS) packages such as [qubes-builder-debian](https://github.com/QubesOS/qubes-builder-debian), [qubes-core-agent-linux](https://github.com/QubesOS/qubes-core-agent-linux):\n\n* master contains status of latest developments, looks like\n* branches for maintenance (and history perhaps) such as release2, looks like\n\n-----\n\n__proposal__:\n\nTo sync things... Adapt the same style to qubes-whonix package. I.e. let master reflect latest commits.\n\nAdvantages:\n\n* No need to explain to future contributors \"don't base on master, that's just maintenance, base on Whonix11 branch, is latest\", followed by replacing that with Whonix12 in future.\n* Most common way to handle use of master branch?\n* Activity on github looks better. Github defaults to master. People see latest commit was not so long ago and perhaps look into those. Better than being swamped when it's merged into master at release time.\n* One step less (choosing Whonix11 branch) when creating github pull requests.\n* Most pull requests are based on latest (ideally: master) rather than specific versions.","comments":[{"author":"Patrick","date_created":1435673226,"date_modified":1435673226,"content":"I was wrong about a few things on how it's actually handled in QubesOS.\n\nPerhaps let's move this discussion to the qubes-devel mailing list.\n\n`[qubes-devel] let github.com/QubesOS master branches reflect latest developments`:\nhttps://groups.google.com/forum/#!topic/qubes-devel/lhnx5B8YMY0\n\n-----\n\nFor example I would like to make a small commit, that should go into \"latest unstable\". At the moment Whonix12. There is no Whonix 12 branch yet.\n\nBackground; I wanted a small change to this file...\nhttps://github.com/nrgaway/qubes-whonix/blob/master/usr/lib/qubes-whonix/messages.yaml\n\n> <p><B>Tor netvm required for updates!</B></p>\n> <p>Please ensure your template vm has a Whonix gateway as it's VM.</p>\n> <p>No updates are possible without an active (running) Whonix gateway VM.</p>\n\n-->\n\n> <p><B>Whonix-Gateway NetVM required for updates!</B></p>\n> <p>Please ensure that this TemplateVM has a Whonix-Gateway as its NetVM.</p>\n> <p>No updates are possible without an active (running) Whonix-Gateway VM.</p>\n\nhttps://github.com/nrgaway/qubes-whonix/pull/11\n"},{"author":"nrgaway","date_created":1435711036,"date_modified":1435711036,"content":"I replied to comments in the Qubes ML thread you created :)"},{"author":"Patrick","date_created":1436540468,"date_modified":1436540468,"content":"That didn't went too well, unfortunately."}]},"PHID-TASK-k7s5uuz6sqod4tgtcbtj":{"id":"350","title":"qubes-whonix network-manager systemd config fix","status":"resolved","priority":"Normal","author":"Patrick","description":"As per\nhttps://lists.alioth.debian.org/pipermail/pkg-systemd-maintainers/2015-June/007613.html\n`debian-systemd mailing list: cannot extend network-manager unit file by using network-manager.service.d` \n\nwe need to do\n`etc/systemd/system/network-manager.service.d/40_qubes.conf` -> `etc/systemd/system/NetworkManager.service.d/40_qubes.conf`\n\nPull request coming soon.","comments":[{"author":"Patrick","date_created":1434022565,"date_modified":1434022565,"content":"https://github.com/nrgaway/qubes-whonix/pull/10\n"}]},"PHID-TASK-f7jiv7lfrrsbcgzkxdkz":{"id":"349","title":"/etc/systemd/system/qubes-whonix-tor.service code simplification","status":"resolved","priority":"Normal","author":"Patrick","description":"[`/etc/systemd/system/qubes-whonix-tor.service`](https://github.com/nrgaway/qubes-whonix/blob/Whonix11/etc/systemd/system/qubes-whonix-tor.service)\n\nIn #qubes-whonix_12, we can get rid of the.\n```\nBefore=whonixcheck.service\n```\n\nBy adding in #whonixcheck.\n\n```\nAfter=tor.service\n```\n\nNo?\n\n-----\n\nCan we get rid of the whole `/etc/systemd/system/qubes-whonix-tor.service`?","comments":[{"author":"Patrick","date_created":1439341916,"date_modified":1439341916,"content":"`get rid of etc/systemd/system/qubes-whonix-tor.service which is error prone, code simplification - https://phabricator.whonix.org/T349`:\nhttps://github.com/adrelanos/qubes-whonix/commit/a1a022a974b8c13132369b391cd3194207f3bf19\n"},{"author":"Patrick","date_created":1439342112,"date_modified":1439342112,"content":"https://github.com/Whonix/whonixcheck/blob/master/lib/systemd/system/whonixcheck.service is already using `Wants=tor.service`."},{"author":"Patrick","date_created":1439344377,"date_modified":1439344377,"content":"https://github.com/adrelanos/qubes-whonix/commit/1cb387851a091f5453daad01d205b8cd43f00747"}]},"PHID-TASK-7r2lhf5exotnmv3jb6uh":{"id":"348","title":"clean up apparmor user documentation","status":"resolved","priority":"Normal","author":"Patrick","description":"From,\n\n* https://www.whonix.org/wiki/Documentation and\n* https://www.whonix.org/wiki/AppArmor\n\nwe should remove indivudual links.\n\n    * VirtualBox\n    * Tor Browser Bundle (TBB)\n    * Icedove (with Enigmail)\n    * Pidgin (with OTR)\n    * XChat\n    * Whonix sdwdate\n    * Whonix timesync\n    * Whonix whonixcheck\n","comments":[]},"PHID-TASK-qmjlzuae3xhpw44yovom":{"id":"347","title":"use /etc/network/interfaces.d instead of /etc/network/interfaces","status":"resolved","priority":"Normal","author":"Patrick","description":"Use `/etc/network/interfaces.d`  instead of `/etc/network/interfaces`, so we can get rid of [config-package-dev](https://debathena.mit.edu/config-packages/) `displace`ing `/etc/network/interfaces`.\n\nhttps://www.whonix.org/wiki/Dev/Build_Documentation/Physical_Isolation instructions would require updating.","comments":[{"author":"Patrick","date_created":1441579962,"date_modified":1441579962,"content":"I am currently trying to get rid of this hack:\nhttps://github.com/nrgaway/qubes-template-whonix/blob/be0c1f53cc10a3ccb8628d132da35006225bdff6/whonix-gateway/02_install_groups_pre.sh#L122-L130\n\nTherefore I wanted to implement this ticket right now for next Whonix version.\n\nWondering... By default, #Qubes doesn't use `ifupdown` at all, right? Would it be fine to avoid installation of ifupdown on Qubes-Whonix? @marmarek\n"},{"author":"marmarek","date_created":1441613638,"date_modified":1441613638,"content":"Currently Qubes configures interfaces manually from udev rule. Actually\nI think it would be better to move it to some more standard place, for\nexample to not conflict with NetworkManager (which is currently handled\nas a special case) or other network-related tools.\nOr at least move it out of udev rule, which is called in quite\nunpredictable time (->race conditions). I think it may somehow related\nto:\nhttps://github.com/QubesOS/qubes-issues/issues/1067\n\nAnyway currently it should be safe to remove `ifupdown`. If we'll need\nit later (and configure properly), we'll add it do `Depends:` of needing\npackage."},{"author":"Patrick","date_created":1441625644,"date_modified":1441625644,"content":"`use /etc/network/interfaces.d instead of /etc/network/interfaces - https://phabricator.whonix.org/T347`:\n\n* https://github.com/Whonix/whonix-gw-network-conf/commit/fc3bb9e4c4de2e3791fa79d4724a32608e68db8f\n* https://github.com/Whonix/whonix-ws-network-conf/commit/4b840887571687c3f02ec781eef92f0f1b8308ce\n\n`disabled ifupdown service in Qubes-Whonix, since not required and conflicting with non-Qubes-Whonix /etc/network/interfaces.d/30_non-qubes-whonix`:\nhttps://github.com/Whonix/qubes-whonix/commit/520479ed66254f5cd93705ef34336e1c7a4b99ef\n"},{"author":"Patrick","date_created":1441627458,"date_modified":1441627458,"content":"`no need to replace ip's in /etc/network/interfaces.whonix - https://phabricator.whonix.org/T347`:\nhttps://github.com/Whonix/qubes-whonix/commit/b251a4af0a20738446e1cc16bc31d59f52ba7350"}]},"PHID-TASK-e5vtsj2cc2zhwdzvude3":{"id":"346","title":"Third Party Repo Lists","status":"open","priority":"Wishlist","author":"HulaHoop","description":"I am opening this as a different ticket so it doesn't get buried.\n\nI propose  including a few repo lists and keys to ship with Whonix,disabled by default of course. Users should enable them only when choosing to install/trust the software.\n\nAdvantages include simpler installation of select third part packages and preventing the user from shooting themselves in the foot when adding a repo or doing key verification which can result int them being tricked and infected.","comments":[{"author":"Patrick","date_created":1433650912,"date_modified":1433650912,"content":"This is a general #usability issue of linux distributions such as Debian. There is no easy and secure way to enable third party repositories. Nowhere where third parties can register. Ideally stuff like TPO, Tails, Whonix signing key would be available from a package that is shipped in official Debian repository.\n\n$someone would have to create a package `third-party-repositories` (or so) that contains:\n\n* the /etc/apt/sources.list.d/ snippets\n* the signing keys\n\nFor:\n\n* yacy\n* i2p\n* torproject\n* Debian multimedia\n* etc.\n\nThereby becoming somewhat a certificate authority. Someone who verifies and somewhat vouches for keys of others.\n\nAs a related task, [apt-add-repository](http://manpages.debian.org/cgi-bin/man.cgi?&query=apt-add-repository) could use a feature,\n\n* to create the /etc/apt/sources.list.d/ snippet\n* drop the signing key into /etc/apt/trusted.gpg.d/ (mixing into /etc/apt/trustdb.gpg is non-ideal)\n\nAnd maybe scripts and/or a graphical user interface to enable/disable those.\n\nCertainly a lot room to increase usability. And quite some development and maintenance effort. This is like a whole project idea."}]},"PHID-TASK-tsenbzrv4db3vjmjicy5":{"id":"345","title":"comment whonix-firewall-plugin iptables rules","status":"resolved","priority":"Normal","author":"Patrick","description":"Please add comments on top of these iptables rules to document what those are good for.\n\nhttps://github.com/nrgaway/qubes-whonix/blob/eb9b63e34e385b5d8d3e1c7876b04b11974f1efe/usr/lib/qubes-whonix/init/whonix-firewall-plugin#L16-22\n","comments":[{"author":"nrgaway","date_created":1433606840,"date_modified":1433606840,"content":"Done.\n\n[[ https://github.com/nrgaway/qubes-whonix/commit/01a71c5718482e4317f014e7a41d9bbce564ff7a | https://github.com/nrgaway/qubes-whonix/commit/01a71c5718482e4317f014e7a41d9bbce564ff7a ]]"}]},"PHID-TASK-n56w2mnkkvytpazxogrf":{"id":"344","title":"whonix_firewall should add the --wait option to iptables statements","status":"resolved","priority":"High","author":"nrgaway","description":"iptables on Debian Jessie support the `--wait` option which will wait for lock to be released on xtable if another process is currently has a lock on it.  This can also prevent any race conditions.\n\nI received a `whonix_firewall` failure due to this error; only once that I have noticed, but it would most likely be best form to update the `whonix_firewall` to use the `--wait` option\n\nFrom http://manpages.debian.org/cgi-bin/man.cgi?&query=iptables\n```\n       -w, --wait\n              Wait for the xtables lock.  To prevent multiple instances of the\n              program from running concurrently, an attempt will  be  made  to\n              obtain  an  exclusive  lock  at launch.  By default, the program\n              will exit if the lock cannot be obtained.  This option will make\n              the program wait until the exclusive lock can be obtained.\n```","comments":[{"author":"nrgaway","date_created":1433598425,"date_modified":1433598425,"content":"Just happened again when booting... I have to to detect it now\n\n```\nJun 06 13:42:52 host systemd[1]: Started Qubes Whonix firewall updater.\nJun 06 13:42:52 host enable-firewall[1052]: OK: Loading Whonix firewall...\nJun 06 13:42:52 host enable-firewall[1052]: OK: TOR_USER: 106\nJun 06 13:42:52 host enable-firewall[1052]: OK: CLEARNET_USER: 1001\nJun 06 13:42:52 host enable-firewall[1052]: OK: USER_USER: 1000\nJun 06 13:42:52 host enable-firewall[1052]: OK: ROOT_USER: 0\nJun 06 13:42:52 host enable-firewall[1052]: Another app is currently holding the xtables lock. Perhaps you want to use the -w option?\nJun 06 13:42:52 host enable-firewall[1052]: ##################################################\nJun 06 13:42:52 host enable-firewall[1052]: Whonix firewall script failed!\nJun 06 13:42:52 host enable-firewall[1052]: ##################################################\n```"},{"author":"Patrick","date_created":1433599317,"date_modified":1433599317,"content":"Do we want to just use a single command at the beginning of `/usr/bin/whonix_firewall` to do the waiting or do we want to add `--wait` to each and every invocation of `iptables`?"},{"author":"Patrick","date_created":1433599895,"date_modified":1433599895,"content":"I am working on a solution. Here are some bits. Might be sufficient to imagine what I am doing.\n\n```\n[ -n \"$iptables_cmd\" ] || iptables_cmd=\"iptables --wait\"\n[ -n \"$ip6tables_cmd\" ] || ip6tables_cmd=\"ip6tables --wait\"\n```\n\n`iptables -P INPUT DROP` -> `$iptables_cmd -P INPUT DROP` etc.\n\nStill testing. There will a git diff soon."},{"author":"Patrick","date_created":1433600765,"date_modified":1433600765,"content":"Check this out.\n\n`use iptables --wait - https://phabricator.whonix.org/T344`:\nhttps://github.com/Whonix/whonix-gw-firewall/commit/6ba2bb28ee5d65d4c6786329b31a81a6b7122d65\n"},{"author":"Patrick","date_created":1433601342,"date_modified":1433601342,"content":"`use iptables --wait - https://phabricator.whonix.org/T344`:\nhttps://github.com/Whonix/whonix-ws-firewall/commit/a0e494dea43032f4b84f1790b4dfd87586d4843f\n"},{"author":"Patrick","date_created":1433604108,"date_modified":1433604108,"content":"`use iptables --wait - https://phabricator.whonix.org/T344`:\nhttps://github.com/nrgaway/qubes-whonix/pull/9\n"},{"author":"Patrick","date_created":1433604319,"date_modified":1433604319,"content":"Included in:\n\n* whonix-gw-firewall `1.4-1`\n* whonix-ws-firewall `1.3-1`\n* Whonix `11.0.0.2.6-developers-only`\n"},{"author":"nrgaway","date_created":1433609754,"date_modified":1433609754,"content":"Your PR will not merge as I made too many changes today.  I already changed the `qubes-whonix` code to use `--wait` ([[ https://github.com/nrgaway/qubes-whonix/blob/Whonix11/usr/lib/qubes-whonix/init/whonix-firewall-plugin.sh | https://github.com/nrgaway/qubes-whonix/blob/Whonix11/usr/lib/qubes-whonix/init/whonix-firewall-plugin.sh ]]\n\nThe `--wait` in `enable-firewall` was a hack to skirt around the issue which did not work which I will remove now you have `--wait` in `whonix_firewall`\n\nDo you think it is still worth while to change `whonix-firewall-plugin` to use the variable you set up, or just leave it like is?\n"},{"author":"Patrick","date_created":1433648218,"date_modified":1433648218,"content":">>! In T344#5337, @nrgaway wrote:\n> Your PR will not merge as I made too many changes today.  I already changed the `qubes-whonix` code to use `--wait` ([[ https://github.com/nrgaway/qubes-whonix/blob/Whonix11/usr/lib/qubes-whonix/init/whonix-firewall-plugin.sh | https://github.com/nrgaway/qubes-whonix/blob/Whonix11/usr/lib/qubes-whonix/init/whonix-firewall-plugin.sh ]]\n> \n> The `--wait` in `enable-firewall` was a hack to skirt around the issue which did not work which I will remove now you have `--wait` in `whonix_firewall`\n\nAlright.\n\n> Do you think it is still worth while to change `whonix-firewall-plugin` to use the variable you set up, or just leave it like is?\n\nProbably fine to leave it as is.\n\n-----\n\nPlease close this if you consider this solved."}]},"PHID-TASK-inpyl5zaajgrqujrqfxw":{"id":"343","title":"document Tor Browser local connections workaround","status":"invalid","priority":"Normal","author":"Patrick","description":"[Tor Browser Local Connections](https://www.whonix.org/wiki/Tor_Browser#Local_Connections) situation is a mess. With no sane (fingerprinting issue free) documented workaround.\n\n>>>! In T291#5255, @HulaHoop wrote:\n>> Or maybe we can use something like rinetd somehow for a safer solution.\n\nInteresting idea. For example, the [yacy](https://www.whonix.org/wiki/YaCy) (or [i2p](https://www.whonix.org/wiki/I2p)) webinterface could bind to `127.0.0.1:<some-port>` (the default, no magic). `rinetd` (or so) could listen on `10.152.152.11:<some-port>` and forward to `127.0.0.1:<some-port>`.\n\nTODO:\n\n* #research if that works\n* [add to documentation](https://www.whonix.org/wiki/Tor_Browser#Local_Connections)\n* __bonus__: (Disadvantage: other workstations can connect to the service listening on 10.152.152.11. A warning needs to be added. But perhaps a separate, virtual, firewalled interface could be added for that purpose.)","comments":[{"author":"Patrick","date_created":1433555778,"date_modified":1433555778,"content":"That particular idea of mine is most likely a dead end. Just tried to connect to a webserver listening on `10.152.152.11:80` using Tor Browser. Didn't work. Tor Browser knows it's a local IP and rejects it. Therefore also the whole redirection thing won't work.\n\nBut perhaps #iptables magic can do? We could define a fake external IP and then use #iptables to redirect to `127.0.0.1`. Just brainstorming. Probably also won't work. #iptables can't redirect to `127.0.0.1`. That's what redirectors such as `rinetd` are for. Also if this were to work, we'd be back with the same fingerprinting issues which Tor Browser wants to defend against by blocking local connections in the first place. So probably not worth it. We'd have the same effect by allowing local connections in Tor Browser in the first place. And the same fingerprinting issues.\n\nTherefore closing this. Anyone feel free to reopen if you have some other solution in mind."}]},"PHID-TASK-jzkrvqtlax2mzpix2ui3":{"id":"342","title":"instructions for upgrading Whonix 10 to Whonix 11","status":"resolved","priority":"High","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1433884189,"date_modified":1433884189,"content":"Work in progress:\nhttps://www.whonix.org/wiki/Upgrading_Whonix_10_to_Whonix_11"},{"author":"Patrick","date_created":1434341634,"date_modified":1434341634,"content":"Done:\nhttps://www.whonix.org/blog/testers-upgrade-10-to-11\n"}]},"PHID-TASK-oxvd3irfmpzawr236hvk":{"id":"341","title":"release Whonix 11.0.0.2.3 testers-only","status":"resolved","priority":"High","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1433527273,"date_modified":1433527273,"content":"Done:\nhttps://www.whonix.org/blog/whonix-11-testers-wanted\n"}]},"PHID-TASK-r7qfa4uzs6yxiqdogefr":{"id":"340","title":"cleanup / deprecate anon-shared-build-fix-grub package","status":"resolved","priority":"Normal","author":"Patrick","description":"[Likely](https://github.com/grml/grml-debootstrap/issues/65#issuecomment-108874288) the following code block can be removed, because likely the grub issue was fixed in jessie:\n- https://github.com/Whonix/anon-shared-build-fix-grub/blob/bec926b41f7d8c2f9edfcb29ab6ead6f062076c3/usr/lib/anon-dist/chroot-scripts-post.d/90_fix_grub#L53-60\n- https://github.com/Whonix/anon-shared-build-fix-grub/blob/bec926b41f7d8c2f9edfcb29ab6ead6f062076c3/usr/lib/anon-dist/chroot-scripts-post.d/90_fix_grub#L64-78\n\nIf so, creation of the whole backup folder `/var/lib/anon-dist/grub-backup` would also be unnecessary.\n\nIf that is so, the only remaining action `rm --force \"/boot/grub/device.map\"` could perhaps be moved to #whonix-initializer and so the #anon-shared-build-fix-grub package could be deprecated.\n\nWhonix `11.0.0.2.3` `/boot/grub/grub.cfg`:\n\n```\n#\n# DO NOT EDIT THIS FILE\n#\n# It is automatically generated by grub-mkconfig using templates\n# from /etc/grub.d and settings from /etc/default/grub\n#\n\n### BEGIN /etc/grub.d/00_header ###\nif [ -s $prefix/grubenv ]; then\n  set have_grubenv=true\n  load_env\nfi\nif [ \"${next_entry}\" ] ; then\n   set default=\"${next_entry}\"\n   set next_entry=\n   save_env next_entry\n   set boot_once=true\nelse\n   set default=\"0\"\nfi\n\nif [ x\"${feature_menuentry_id}\" = xy ]; then\n  menuentry_id_option=\"--id\"\nelse\n  menuentry_id_option=\"\"\nfi\n\nexport menuentry_id_option\n\nif [ \"${prev_saved_entry}\" ]; then\n  set saved_entry=\"${prev_saved_entry}\"\n  save_env saved_entry\n  set prev_saved_entry=\n  save_env prev_saved_entry\n  set boot_once=true\nfi\n\nfunction savedefault {\n  if [ -z \"${boot_once}\" ]; then\n    saved_entry=\"${chosen}\"\n    save_env saved_entry\n  fi\n}\nfunction load_video {\n  if [ x$feature_all_video_module = xy ]; then\n    insmod all_video\n  else\n    insmod efi_gop\n    insmod efi_uga\n    insmod ieee1275_fb\n    insmod vbe\n    insmod vga\n    insmod video_bochs\n    insmod video_cirrus\n  fi\n}\n\nif [ x$feature_default_font_path = xy ] ; then\n   font=unicode\nelse\ninsmod part_msdos\ninsmod ext2\nif [ x$feature_platform_search_hint = xy ]; then\n  search --no-floppy --fs-uuid --set=root  26ada0c0-1165-4098-884d-aafd2220c2c6\nelse\n  search --no-floppy --fs-uuid --set=root 26ada0c0-1165-4098-884d-aafd2220c2c6\nfi\n    font=\"/usr/share/grub/unicode.pf2\"\nfi\n\nif loadfont $font ; then\n  set gfxmode=auto\n  load_video\n  insmod gfxterm\nfi\nterminal_output gfxterm\nif [ \"${recordfail}\" = 1 ] ; then\n  set timeout=-1\nelse\n  if [ x$feature_timeout_style = xy ] ; then\n    set timeout_style=menu\n    set timeout=5\n  # Fallback normal timeout code in case the timeout_style feature is\n  # unavailable.\n  else\n    set timeout=5\n  fi\nfi\n### END /etc/grub.d/00_header ###\n\n### BEGIN /etc/grub.d/05_debian_theme ###\nset menu_color_normal=cyan/blue\nset menu_color_highlight=white/blue\n### END /etc/grub.d/05_debian_theme ###\n\n### BEGIN /etc/grub.d/10_linux ###\nfunction gfxmode {\n\tset gfxpayload=\"${1}\"\n}\nset linux_gfx_mode=\nexport linux_gfx_mode\nmenuentry 'Whonix GNU/Linux' --class whonix --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-simple-26ada0c0-1165-4098-884d-aafd2220c2c6' {\n\tload_video\n\tinsmod gzio\n\tif [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi\n\tinsmod part_msdos\n\tinsmod ext2\n\tif [ x$feature_platform_search_hint = xy ]; then\n\t  search --no-floppy --fs-uuid --set=root  26ada0c0-1165-4098-884d-aafd2220c2c6\n\telse\n\t  search --no-floppy --fs-uuid --set=root 26ada0c0-1165-4098-884d-aafd2220c2c6\n\tfi\n\techo\t'Loading Linux 3.16.0-4-686-pae ...'\n\tlinux\t/boot/vmlinuz-3.16.0-4-686-pae root=UUID=26ada0c0-1165-4098-884d-aafd2220c2c6 ro  apparmor=1 security=apparmor quiet\n\techo\t'Loading initial ramdisk ...'\n\tinitrd\t/boot/initrd.img-3.16.0-4-686-pae\n}\nsubmenu 'Advanced options for Whonix GNU/Linux' $menuentry_id_option 'gnulinux-advanced-26ada0c0-1165-4098-884d-aafd2220c2c6' {\n\tmenuentry 'Whonix GNU/Linux, with Linux 3.16.0-4-686-pae' --class whonix --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-3.16.0-4-686-pae-advanced-26ada0c0-1165-4098-884d-aafd2220c2c6' {\n\t\tload_video\n\t\tinsmod gzio\n\t\tif [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi\n\t\tinsmod part_msdos\n\t\tinsmod ext2\n\t\tif [ x$feature_platform_search_hint = xy ]; then\n\t\t  search --no-floppy --fs-uuid --set=root  26ada0c0-1165-4098-884d-aafd2220c2c6\n\t\telse\n\t\t  search --no-floppy --fs-uuid --set=root 26ada0c0-1165-4098-884d-aafd2220c2c6\n\t\tfi\n\t\techo\t'Loading Linux 3.16.0-4-686-pae ...'\n\t\tlinux\t/boot/vmlinuz-3.16.0-4-686-pae root=UUID=26ada0c0-1165-4098-884d-aafd2220c2c6 ro  apparmor=1 security=apparmor quiet\n\t\techo\t'Loading initial ramdisk ...'\n\t\tinitrd\t/boot/initrd.img-3.16.0-4-686-pae\n\t}\n\tmenuentry 'Whonix GNU/Linux, with Linux 3.16.0-4-686-pae (recovery mode)' --class whonix --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-3.16.0-4-686-pae-recovery-26ada0c0-1165-4098-884d-aafd2220c2c6' {\n\t\tload_video\n\t\tinsmod gzio\n\t\tif [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi\n\t\tinsmod part_msdos\n\t\tinsmod ext2\n\t\tif [ x$feature_platform_search_hint = xy ]; then\n\t\t  search --no-floppy --fs-uuid --set=root  26ada0c0-1165-4098-884d-aafd2220c2c6\n\t\telse\n\t\t  search --no-floppy --fs-uuid --set=root 26ada0c0-1165-4098-884d-aafd2220c2c6\n\t\tfi\n\t\techo\t'Loading Linux 3.16.0-4-686-pae ...'\n\t\tlinux\t/boot/vmlinuz-3.16.0-4-686-pae root=UUID=26ada0c0-1165-4098-884d-aafd2220c2c6 ro single  apparmor=1 security=apparmor\n\t\techo\t'Loading initial ramdisk ...'\n\t\tinitrd\t/boot/initrd.img-3.16.0-4-686-pae\n\t}\n\tmenuentry 'Whonix GNU/Linux, with Linux 3.16.0-4-586' --class whonix --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-3.16.0-4-586-advanced-26ada0c0-1165-4098-884d-aafd2220c2c6' {\n\t\tload_video\n\t\tinsmod gzio\n\t\tif [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi\n\t\tinsmod part_msdos\n\t\tinsmod ext2\n\t\tif [ x$feature_platform_search_hint = xy ]; then\n\t\t  search --no-floppy --fs-uuid --set=root  26ada0c0-1165-4098-884d-aafd2220c2c6\n\t\telse\n\t\t  search --no-floppy --fs-uuid --set=root 26ada0c0-1165-4098-884d-aafd2220c2c6\n\t\tfi\n\t\techo\t'Loading Linux 3.16.0-4-586 ...'\n\t\tlinux\t/boot/vmlinuz-3.16.0-4-586 root=UUID=26ada0c0-1165-4098-884d-aafd2220c2c6 ro  apparmor=1 security=apparmor quiet\n\t\techo\t'Loading initial ramdisk ...'\n\t\tinitrd\t/boot/initrd.img-3.16.0-4-586\n\t}\n\tmenuentry 'Whonix GNU/Linux, with Linux 3.16.0-4-586 (recovery mode)' --class whonix --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-3.16.0-4-586-recovery-26ada0c0-1165-4098-884d-aafd2220c2c6' {\n\t\tload_video\n\t\tinsmod gzio\n\t\tif [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi\n\t\tinsmod part_msdos\n\t\tinsmod ext2\n\t\tif [ x$feature_platform_search_hint = xy ]; then\n\t\t  search --no-floppy --fs-uuid --set=root  26ada0c0-1165-4098-884d-aafd2220c2c6\n\t\telse\n\t\t  search --no-floppy --fs-uuid --set=root 26ada0c0-1165-4098-884d-aafd2220c2c6\n\t\tfi\n\t\techo\t'Loading Linux 3.16.0-4-586 ...'\n\t\tlinux\t/boot/vmlinuz-3.16.0-4-586 root=UUID=26ada0c0-1165-4098-884d-aafd2220c2c6 ro single  apparmor=1 security=apparmor\n\t\techo\t'Loading initial ramdisk ...'\n\t\tinitrd\t/boot/initrd.img-3.16.0-4-586\n\t}\n}\n\n### END /etc/grub.d/10_linux ###\n\n### BEGIN /etc/grub.d/20_linux_xen ###\n\n### END /etc/grub.d/20_linux_xen ###\n\n### BEGIN /etc/grub.d/30_os-prober ###\n### END /etc/grub.d/30_os-prober ###\n\n### BEGIN /etc/grub.d/30_uefi-firmware ###\n### END /etc/grub.d/30_uefi-firmware ###\n\n### BEGIN /etc/grub.d/40_custom ###\n# This file provides an easy way to add custom menu entries.  Simply type the\n# menu entries you want to add after this comment.  Be careful not to change\n# the 'exec tail' line above.\n### END /etc/grub.d/40_custom ###\n\n### BEGIN /etc/grub.d/41_custom ###\nif [ -f  ${config_directory}/custom.cfg ]; then\n  source ${config_directory}/custom.cfg\nelif [ -z \"${config_directory}\" -a -f  $prefix/custom.cfg ]; then\n  source $prefix/custom.cfg;\nfi\n### END /etc/grub.d/41_custom ###\n```\n\nTODO:\n\n* Test build without these code blocks.\n* See generated `/boot/grub/grub.cfg`.\n* Compare with above `/boot/grub/grub.cfg`.\n* If it matches, clean this up.","comments":[{"author":"Patrick","date_created":1438184769,"date_modified":1438184769,"content":"`clean up /boot/grub/device.map because the anon-shared-build-fix-grub package can be deprecated - https://phabricator.whonix.org/T340`:\nhttps://github.com/Whonix/whonix-initializer/commit/c7c5cddc595d41079d54752a1c3f1949298d592b\n"},{"author":"Patrick","date_created":1438185128,"date_modified":1438185128,"content":"`deactivated most code, testing to deprecate anon-shared-build-fix-grub package - https://phabricator.whonix.org/T340`:\nhttps://github.com/Whonix/anon-shared-build-fix-grub/commit/3ce9b90b02f25d4cf7ea0733eb9228dc668b144b"},{"author":"Patrick","date_created":1438185162,"date_modified":1438185162,"content":"Checking this again when the next test release has been created."},{"author":"Patrick","date_created":1449243742,"date_modified":1449243742,"content":"```\ndeprecated anon-shared-build-fix-grub - no longer required\n\nhttps://phabricator.whonix.org/T340\n```\nhttps://github.com/Whonix/Whonix/commit/c2b0e56e322ed55656513a65ba9281cf6e1cb520"}]},"PHID-TASK-m5fjv2cgzo3deogzeyg6":{"id":"339","title":"Prevent whonix_firewall from starting automatically ","status":"resolved","priority":"High","author":"nrgaway","description":"In Qubes, the network interfaces are loaded manually.  Now that whonix_firewall is being started with the ifup-pre.d scripts, it is always starting early.  I could remove it completely but that will cause upgrade issues.\n\nIt took me 3 hours to work around the file being there today.  Most of the time was figuring out what was preventing connections to the gateways secure update server from the TemplateVM.\n\nNormally, in the TemplateVM, I connect to the Gateway to confirm there is secure update server available. If there is, a proxy is set for apt-get and that is the only traffic allowed in the Template VM.  If no server is available, I completely lock down the iptables rules.  Whonix firewall rules were preventing the initial connection and I add to add some rule to allow outgoing connection to 10.137.255.254:8082.  \n\nI would prefer to be able to disable the loading of the firewall in the first place. I load it manually as well.\n\nI also needed to make sure all the replace-ip functions were done well in advance of networking because of this.\n\nOne last issue I came across when reloading whonix_firewall was a locked iptables database since some other app had a lock on it at the time.  In Jessie you can use iptables --wait ... to prevent this type of failure.  This only happened once, but worth noting.","comments":[{"author":"Patrick","date_created":1433365303,"date_modified":1433365303,"content":"Don't work around this. Try to view this from Whonix perspective where you're upstream yourself. Where upstream can make any changes required to make this work. No need to see qubes-whonix as a fork that needs to work around things. We modify the whonix-(gw|ws)-firewall packages so those are also well suited for Qubes-Whonix.\n\nProbably no need to remove the /etc/network/if-pre-up.d/30_whonix_firewall hook, no? It just runs /usr/bin/whonix_firewall. And we can make any changes required in /usr/bin/whonix_firewall to make this work.\n\nFor example in /usr/bin/whonix_firewall [line ~55](https://github.com/Whonix/whonix-gw-firewall/blob/5ebca43416269a5fd42c98a80af1b0b3d38adecf/usr/bin/whonix_firewall#L55) we could add something like this...\n\n```\nif [ -f \"/path/to/some/status-file\" ]; then\n   true \"some debug/explain info msg\"\n   exit 0\nfi\n```\n\nOr we could make [/etc/network/if-pre-up.d/30_whonix_firewall](https://github.com/Whonix/whonix-gw-firewall/blob/master/etc/network/if-pre-up.d/30_whonix_firewall)...\n\n```\n#!/bin/sh\n\n## This file is part of Whonix.\n## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\nset -e\n\nif [ -f \"/usr/lib/qubes\" ]; then\n   true \"some debug/explain info msg\"\n   exit 0\nfi\n\n/usr/bin/whonix_firewall\n```\n\nIs any of these approaches suitable?\n\n> One last issue I came across when reloading whonix_firewall was a locked iptables database since some other app had a lock on it at the time. In Jessie you can use iptables --wait ... to prevent this type of failure. This only happened once, but worth noting.\n\nNo idea about that one."},{"author":"nrgaway","date_created":1433370812,"date_modified":1433370812,"content":"I currently have it tied into the `GATEWAY_IPv4_DROP_INVALID_INCOMING_PACKAGES_POST_HOOK` hook.\n\nIt would be better to have something in the line 55 range though to be able to be sure nothing loads. \n\nWhat I want is for the firewall not to load during if-up stage, and will be started manually later after qubes network is configured, but before it's activated.  I can control this with a service.\n\nactually I do prefer the `/etc/network/if-pre-up.d/30_whonix_firewall` option best. The condition you can set is same as the rest; `!/usr/lib/qubes-whonix`.  Then I can take care of starting firewall when its confirmed network is configured properly."},{"author":"Patrick","date_created":1433374858,"date_modified":1433374858,"content":">>! In T339#5191, @nrgaway wrote:\n> I currently have it tied into the `GATEWAY_IPv4_DROP_INVALID_INCOMING_PACKAGES_POST_HOOK` hook.\n\nNot great.\n \n> It would be better to have something in the line 55 range though to be able to be sure nothing loads. \n\nYes.\n \n> What I want is for the firewall not to load during if-up stage, and will be started manually later after qubes network is configured, but before it's activated.  I can control this with a service.\n\n> actually I do prefer the `/etc/network/if-pre-up.d/30_whonix_firewall` option best. The condition you can set is same as the rest; `!/usr/lib/qubes-whonix`.  Then I can take care of starting firewall when its confirmed network is configured properly.\n\nYou mean by (a) `/lib/systemd/system/unit.service.d/` snippet(s)? That sounds good. [Perhaps the networking service could be extended by a `Requires=` or so.]"},{"author":"nrgaway","date_created":1433382525,"date_modified":1433382525,"content":"I tried to use a systemd drop in snippet but it did not work for `ifup@.service`.\n\nMaybe the best option is as you suggested earlier since it would prevent the firewall from loading at all at the network stage:\n\n`/etc/network/if-pre-up.d/30_whonix_firewall (if script will work there):`\n\n```\n#!/bin/sh\n\n## This file is part of Whonix.\n## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\nset -e\n\nif [ ! -e \"/usr/lib/qubes\" ]; then\n  /usr/bin/whonix_firewall\nfi\n```"},{"author":"Patrick","date_created":1433414180,"date_modified":1433414180,"content":"Slightly different.\n\n```\n#!/bin/sh\n\n## This file is part of Whonix.\n## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\nset -e\n\nif [ -e \"/usr/lib/qubes\" ]; then\n   true \"$0: /usr/lib/qubes exits, exiting. See https://phabricator.whonix.org/T339 for details.\"\n   exit 0\nfi\n\n/usr/bin/whonix_firewall\n```\n\nWill commit soon."},{"author":"Patrick","date_created":1433414708,"date_modified":1433414708,"content":"`Qubes fix - https://phabricator.whonix.org/T339`:\n- https://github.com/Whonix/whonix-gw-firewall/commit/6aec420d362ed56f062dd653167e48365648278f (`1.3-1`)\n- https://github.com/Whonix/whonix-ws-firewall/commit/43fb959f7d704b9aa5dd82473597a2fae72d6080 (`1.2-1`)\n\n-----\n\nIncluded in Whonix `11.0.0.2.4-developers-only`.\n* https://github.com/Whonix/Whonix/commit/3ab0d47ccb46e7aac9a760ead057f432f5462a9b\n\n-----\n\n(Among with a few other minor, low risk changes.\n\n* https://github.com/Whonix/Whonix/commit/7a66149fb91db541d3d60e9d7d6654da6f4a221a\n* https://github.com/Whonix/Whonix/commit/c37fbb5112853ddb67828d740061817b74d7b9fc\n* https://github.com/Whonix/Whonix/commit/a27ebcd450356107534ceda0f180c5d4fc727078)\n\n-----\n\nAlright. Please see if that works for you so we can close this ticket."}]},"PHID-TASK-hxnn2fqi6ujefsf6hjhv":{"id":"338","title":"make tb-updater installation path configurable / change default installation directory to ~/.tb","status":"resolved","priority":"Normal","author":"Patrick","description":">>! In T337#5157, @nrgaway wrote:\n> I noticed tor-browser installs in the root of the users home directory.\n> \n> Would it be possible to automatically install it in the ~/bin directory as not to clutter the root directory?\n","comments":[{"author":"Patrick","date_created":1433364192,"date_modified":1433364192,"content":"No, I don't think so. This is because TBB's folder and application is structured as a linux portable app. All binaries and user data is supposed to be stored in a writeable folder in the user's home folder. If you wanted to install binaries to ~/bin and user data to /home/user, i.e. how usual linux applications work, it would require extensive changes upstream in TBB.\n\nIf you disagree and/or want to research this further, you can either:\n\n* a) Get plain Debian. Get regular TBB from https://www.torproject.org. Figure out how to manually install it to ~/bin etc. When you figured out, I can maybe automate this in tb-updater.\n* b) report an upstream issue\n** Due to the year long non-progress in https://trac.torproject.org/projects/tor/ticket/3994, https://trac.torproject.org/projects/tor/ticket/5236, the huge demand for a system wide solution and the technical hurdles to implement this, I think unless $someone invests lots of time and effort, this is unrealistic.\n"},{"author":"nrgaway","date_created":1433364595,"date_modified":1433364595,"content":"You just place it in the ~/bin directory.  That's where all of my 'personal' binaries go that are not part of a package.\n\nI run tor-browser right now out of the ~/bin directory without any issues."},{"author":"Patrick","date_created":1433365024,"date_modified":1433365024,"content":"Starting the browser as user or root?\n\nBut then you also have your user data inside ~/bin or where does it get stored?"},{"author":"nrgaway","date_created":1433370220,"date_modified":1433370220,"content":"I start it as user; never usually start a program as root.\n\nAnd the user data get placed within the tor-browser directory tree; you can move it anywhere and still start and access your data as it uses the tor-browser directory as a base"},{"author":"Patrick","date_created":1433513685,"date_modified":1433513685,"content":">>! In T338#5190, @nrgaway wrote:\n> And the user data get placed within the tor-browser directory tree;\n\nOption 1:\n\nSo user data will also be in ~/bin? Doesn't this require user `user` having write access to ~/bin?\n\nOption 2:\n\nUser data gets written in ~/home? Unlikely. Probably not?\n"},{"author":"nrgaway","date_created":1433515375,"date_modified":1433515375,"content":">>! In T338#5216, @Patrick wrote:\n>>>! In T338#5190, @nrgaway wrote:\n>> And the user data get placed within the tor-browser directory tree;\n> \n> Option 1:\n> \n> So user data will also be in ~/bin? Doesn't this require user `user` having write access to ~/bin?\n\n`~/bin == /home/user/bin` :) \n\n`Tor browser user data then gets written into /home/user/bin/tor-browser_en-US/Browser/TorBrowser/Data/Browser/profile.default`\n\n> Option 2:\n> \n> User data gets written in ~/home? Unlikely. Probably not?\n\n"},{"author":"Patrick","date_created":1433516676,"date_modified":1433516676,"content":"Alright. I was confused about this. You wrote about `~/bin` from start. Somehow I thought `/bin/`. That's where confusion came from. Sorry.\n\n-----\n\nNow on the real topic...\n\n>>! In T337#5157, @nrgaway wrote:\n> I noticed tor-browser installs in the root of the users home directory.\n> \n> Would it be possible to automatically install it in the ~/bin directory as not to clutter the root directory?\n\nYes, it would not be hard to change the installation directory in #tb-updater and/or to make that configurable.\n\nYou want an option or to change the default?"},{"author":"nrgaway","date_created":1433517352,"date_modified":1433517352,"content":"I think an option make more sense, so as not to confuse existing users on other platforms like virtualbox.  I personally do not like any non standard directory within ~/home/user unless its a .hidden directory.\n\nIts just weird how Firefox is so self contained.  I am used to users data going in to ~/.local/shared, config data going into ~/.config and cache data going into ~/.cache"},{"author":"Patrick","date_created":1433526347,"date_modified":1433526347,"content":">>! In T338#5220, @nrgaway wrote:\n> I think an option make more sense, so as not to confuse existing users on other platforms like virtualbox.\n\nPhew. So glad we're not debating default TBB installation folder.\n\nThe good news is, that's already supported.\n\nCreate a file `/etc/torbrowser.d/50_user` with the following content.\n\n```\ntb_home_folder=~/bin\n```\n\nJust now tested. Works for me for #tb-updater. Please try and leave feedback.\n\n#tb-starter doesn't support it. Something I am happy to fix for Whonix 12. In meanwhile you have to manually start it, create your own shortcut and patch #tb-starter.\n\n> Its just weird how Firefox is so self contained. \n\nYes!\n\n{FYI: The background is, that want it as an probable app on Windows. [portableapps.com](http://portableapps.com) alike. And because there is no package manager on Windows. And they want to support easy uninstall. Ideally they wanted it forensically clean. These goals clash with usually installed applications.}\n"},{"author":"Patrick","date_created":1433526863,"date_modified":1433526863,"content":"Actually, that #tb-starter fix is so simple, it can be included in next tag and Whonix 11. Shouldn't stop you from testing this now anyhow."},{"author":"Patrick","date_created":1433527173,"date_modified":1433527173,"content":"`Made path to Tor Browser configurable by tb_home_folder variable. Renamed variable home_folder to tb_home_folder to synchronize it with tb-updater. - https://phabricator.whonix.org/T338`:\nhttps://github.com/Whonix/tb-starter/commit/46803cdeb68bfe6655660b73f6f1fa0783ad1c80\n"},{"author":"Patrick","date_created":1433528699,"date_modified":1433528699,"content":"Included in tb-starter >= `1.6-1` and Whonix >= `11.0.0.2.5-developers-only`."},{"author":"nrgaway","date_created":1433647500,"date_modified":1433647500,"content":"Works well, thank you.\n\nI did more research and the proper place for the tor-browser package to go was in `~/opt`. I looked into it more cause I thought it was strange to have a package in bin directory since usually they are individual binaries. `opt` is used same as on local system, for pre-compiled packages. `~/bin` then would be used to add a soft-link to start Tor and then make sure `~/bin` is added to users PATH. I usually add the `~/bin` PATH before the other PATHs to allow one to override a system default application if so desired just by placing it in users home directory ~bin.\n\nI did have an issue with TB being installed via `whonix_build` using `tb_home_folder=~/opt` in 40_qubes cause it tried to install it in /root directory it seemed like. I already needed to create a temporary `torbuilder.d` configuration file located in the chroot at `/etc/torbrowser.d/40whonix_build` since `qubes-builder` does not get installed until after Whonix is installed, so I just changed that path to `tb_home_folder=/home/user/opt` which ended up working.  The temp file gets removed just fine during `qubes-builder` cleanup stage and the real file gets placed by `qubes-whonix`.\n\nIt was nice to see it work :)"},{"author":"Patrick","date_created":1433652392,"date_modified":1433652392,"content":">>! In T338#5350, @nrgaway wrote:\n> I did have an issue with TB being installed via `whonix_build` using `tb_home_folder=~/opt` in 40_qubes cause it tried to install it in /root directory it seemed like. I already needed to create a temporary `torbuilder.d` configuration file located in the chroot at `/etc/torbrowser.d/40whonix_build` since `qubes-builder` does not get installed until after Whonix is installed, so I just changed that path to `tb_home_folder=/home/user/opt` which ended up working.  The temp file gets removed just fine during `qubes-builder` cleanup stage and the real file gets placed by `qubes-whonix`.\n\nI can imagine why this happens.\n\nConsider this test script `/home/user/a`.\n\n```\n#!/bin/bash\necho ~\n```\n\n```\nsudo su\nroot@host:~# sudo -u user /home/user/a\n/home/user\n```\n\n```\nsudo su\nroot@host:~# sudo -E -u user /home/user/a\n/root\n```\n\n[anon-shared-build-inst-tb 70_torbrowser chroot script](https://github.com/Whonix/anon-shared-build-inst-tb/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/70_torbrowser) runs as `root` and runs:\n\n```\nsudo -E -u user /usr/bin/update-torbrowser --devbuildpassthrough\n```\n\nThat's probably why `~` expands to `root`.\n\n(Using `sudo -E` to allow influencing other tb-updater environment variables.)\n"},{"author":"Patrick","date_created":1433653110,"date_modified":1433653110,"content":">>! In T338#5350, @nrgaway wrote:\n> I did more research and the proper place for the tor-browser package to go was in `~/opt`. I looked into it more cause I thought it was strange to have a package in bin directory since usually they are individual binaries. `opt` is used same as on local system, for pre-compiled packages. `~/bin` then would be used to add a soft-link to start Tor and then make sure `~/bin` is added to users PATH. I usually add the `~/bin` PATH before the other PATHs to allow one to override a system default application if so desired just by placing it in users home directory ~bin.\n\nSo you [changed](https://github.com/nrgaway/qubes-whonix/commit/c94dccd82e348b05c67d38738edf1afc7b809246) the default in Qubes-Whonix. I don't think this is a good idea.\n\n* Different Tor Browser installation path Whonix vs Qubes-Whonix. Probably causing confusion.\n* Users are less likely to find their Tor Browser so they can backup it. Probably causing questions.\n* Who uses `~/opt`?\n* Even if there was `~/opt`, similar to `/opt/`, as far I know opt binaries aren't supposed to be in a sub folder. I.e. for example `/opt/some-bin`, not `/opt/some-sub-folder/some-bin`. (But TBB without sub folder would also be weird.)\n\nDunno. Pre-Installation to `/home/` as distribution is always non-standard, bad. `/home/user/tor-browser_en-US` isn't great, but I find `/home/user/opt/tor-browser_en-US` worse.\n\n(torbrowser-launcher installs to `~/.tbb` btw. But we shouldn't use ~/.tbb to avoid confilcts and allow co-installability of tb-updater and torbrowser-launcher.)"},{"author":"Patrick","date_created":1433681010,"date_modified":1433681010,"content":"Another issue with different Tor Browser installation paths Whonix vs Qubes-Whonix / changing Tor Browser installation path by default is, that it breaks [apparmor-profile-torbrowser](https://github.com/Whonix/apparmor-profile-torbrowser)."},{"author":"nrgaway","date_created":1433695481,"date_modified":1433695481,"content":"Could you just not change the apparmor-profile?\n\nfrom:\n```\n/home/*/tor-browser_*/Browser/firefox {\n```\n\nto:\n```\n/home/{*,*/opt}/tor-browser_*/Browser/firefox {\n```"},{"author":"Patrick","date_created":1433698531,"date_modified":1433698531,"content":"That would perhaps solve the AppArmor issue."},{"author":"Patrick","date_created":1434387597,"date_modified":1434387597,"content":"Can you undo the ~/opt thing please? @nrgaway"},{"author":"nrgaway","date_created":1434400149,"date_modified":1434400149,"content":"What ya mean?  Is it causing issues? In following standards or defacto standards the ~/opt directory is the correct spot to place pre-built packages that do not adhere to XDG specs."},{"author":"Patrick","date_created":1434405209,"date_modified":1434405209,"content":"Yes, causing issues.\n\n* 1) Too much of a rush for Whonix 11. Too controversial to quickly sneak this in.\n* 2) apparmor-profile-torbrowser package not patched yet with new location, therefore containing Tor Browser is not as simple as installing that package.\n* Other issues I raised at: https://phabricator.whonix.org/T338#5356... To update those...\n** 3) Different Tor Browser installation path Whonix vs Qubes-Whonix. Probably causing confusion.\n** 4) Users are less likely to find their Tor Browser so they can backup it. Probably causing questions.\n** 5) Who uses `~/opt`? I used google to search for `\"/home/user/opt\"` and `\"~/opt\"`. Very few results. Haven't found any distribution / standard using that. Please clarify who uses that.\n** 6) Even if there was `~/opt`, similar to `/opt/`, as far I know, opt binaries aren't supposed to be in a sub folder. I.e. for example `/opt/some-bin`, not `/opt/some-sub-folder/some-bin`. (But TBB without sub folder would also be weird.)\n\nPre-Installation to `/home/` as distribution is always non-standard, bad. `/home/user/tor-browser_en-US` isn't great, but I find `/home/user/opt/tor-browser_en-US` worse.\n"},{"author":"HulaHoop","date_created":1434569422,"date_modified":1434569422,"content":"This will cause confusion because it goes against users' reasonable expectations for uniform default behavior - opening the door to balkanization of Whonix versions.  We also have to be compatible with the expectations of upstream because at some point they will ship an upstream apparmor profile too.\n\nJust my 2 satoshis"},{"author":"nrgaway","date_created":1434744496,"date_modified":1434744496,"content":"I can revert to use original path although if talking about 'reasonable expectations for uniform default behaviour' and wanting to keep all the Whonix variations similar we may want to consider changing the path for all the other versions as well then since the `/home/user/opt` is the `proper` and `defacto` standard location path to install `pre-built personal/private binary applications` that are not `XDG` aware.\n\nIf the TB package was not private, it would have been installed in the `/opt` directory.\n\nI suggest this since Patrick seems to like to follow standards as much as possible, and the time to change this would be in the new version.\n"},{"author":"Patrick","date_created":1434821845,"date_modified":1434821845,"content":"Yes, please undo for now.\n\nWe can consider this for #Whonix_12.\n\nYes, following standards is good.\n\nI've searched XGD standards by using the following google query:\n```\nsite:http://standards.freedesktop.org opt\n```\n\nNot found. Haven't found any mentioning of `/home/user/opt`, `/home/<user>/opt`, `~/opt` or so. Also as previously mentioned, a more general google search didn't yield any useful results. Please show any code, documentation examples or distributions [...] using `~/opt`."},{"author":"nrgaway","date_created":1435017401,"date_modified":1435017401,"content":"I will revert the change for now by adding a comment to the configuration file that sets the path.\n\nThe opt path is deferentially not part of XDG standard, completely opposite. ~/bin /~opt is part of a long time honoured defacto standard.  \n\nHere are some discussions on it including which include using ~opt\n[[ https://unix.stackexchange.com/questions/30/where-should-i-put-software-i-compile-myself | https://unix.stackexchange.com/questions/30/where-should-i-put-software-i-compile-myself ]]\n\n[BTW, This ended up in spam folder again :(]"},{"author":"Patrick","date_created":1435020800,"date_modified":1435020800,"content":"> The opt path is deferentially not part of XDG standard, completely opposite. ~/bin /~opt is part of a long time honoured defacto standard.  \n\nAlso Filesystem Hierarchy Standard does not include this.\n \n> Here are some discussions on it including which include using ~opt\n> [[ https://unix.stackexchange.com/questions/30/where-should-i-put-software-i-compile-myself | https://unix.stackexchange.com/questions/30/where-should-i-put-software-i-compile-myself ]]\n\nIt's a non-example. Only a single time `~/opt/` was mentioned. A user wrote `I like ~/sbin for bash/ruby/python scripts, and ~/opt/... for compiled installs`. That's okay for the user to like it, but it does not show, that this is a standard or even common.\n \n> [BTW, This ended up in spam folder again :(]\n\nI recommend to make fixing your mail experience a priority. We don't have that many sender e-mail addresses. Should be whitelistable.\n\n-----\n\nInterestingly, on jessie, `~/.profile` includes.\n\n```\n# set PATH so it includes user's private bin if it exists\nif [ -d \"$HOME/bin\" ] ; then\n    PATH=\"$HOME/bin:$PATH\"\nfi\n```\n\nSo when `~/bin` exists, then `$HOME/bin` is automatically added to `PATH`. No mention of `~/opt` though.\n\n-----\n\nMore importantly... Let's assume - what I am not convinced of yet - `~/bin` [or supposedly even `~/opt`] is a standard...\n\nWhen using `/usr/bin`, `/usr/local/bin`, `~/bin` [or supposedly even `~/opt`] etc... One is supposed to drop binaries/scripts there - not folders. For example, `~/bin/some-script` would be correct. And `~/bin/some-folder/some-script` would be incorrect.\n\nI conclude, that `~/bin/tor-browser_en-US/start-tor-browser.desktop` [or `~/opt/tor-browser_en-US/start-tor-browser.desktop`] would still not be standards conform? Because there is a sub folder (`tor-browser_en-US`). What do you think?\n\nStarting `start-tor-browser.desktop` from command line would also fail, because of the sub folder (not included in `PATH`). (And additionally, `start-tor-browser.desktop` has an upstream bug(?): You need to `cd` into the folder, before you can run `./start-tor-browser.desktop`."},{"author":"nrgaway","date_created":1435105222,"date_modified":1435105222,"content":">>! In T338#5679, @Patrick wrote:\n...\n\n> So when `~/bin` exists, then `$HOME/bin` is automatically added to `PATH`. No mention of `~/opt` though.\n\n`~/opt` would never be added to `$PATH`. `~/bin` would create the binary link to package located in `~/opt` or an `XDG` desktop file would be created in the appropriate place.\n\n> More importantly... Let's assume - what I am not convinced of yet - `~/bin` [or supposedly even `~/opt`] is a standard...\n> \n> When using `/usr/bin`, `/usr/local/bin`, `~/bin` [or supposedly even `~/opt`] etc... One is supposed to drop binaries/scripts there - not folders. For example, `~/bin/some-script` would be correct. And `~/bin/some-folder/some-script` would be incorrect.\n\nYou are correct about  `/usr/bin`, `/usr/local/bin` and `~/bin` being the place to drop binaries. `~/opt` is a spot for `pre-compiled` binary `'packages'` and its related files; same as `/opt`. You would not drop the `tor-browser-en-US` package in any type of `bin` directory. You will notice packages such as `Google Chrome` get installed in main `/opt` directory (not home user directory).\n\n> I conclude, that `~/bin/tor-browser_en-US/start-tor-browser.desktop` [or `~/opt/tor-browser_en-US/start-tor-browser.desktop`] would still not be standards conform? Because there is a sub folder (`tor-browser_en-US`). What do you think?\n\nThis is also correct, as you suggested, creating a `.desktop` file in `~/bin/tor-browser_en-US/start-tor-browser.desktop` or `~/opt/tor-browser_en-US/start-tor-browser.desktop` is the incorrect location for them to go.  Since `Tor browser` is considered a private user application, then any links to it should be within the users home directory.  Therefore the `.desktop` file should then be located in `~/.local/share/applications/`, or the path of where the `.desktop` files is located would need to be added to `XDG_DATA_DIRS` `ENV` variable (I think this would be a bad option to add to `XDG_DATA_DIRS` for only one file).\n\nNow, that solves the issue of placing the `.desktop` file in the standards base location, but leaves the issue of being able to make sure its in the path to be able to start it from the command line.  That's where the `~/bin` directory comes into play. We would ensure it's in the uses path and either create a wrapper or softlink to to start `Tor browser`. Again, `~/bin' is a DE-facto standard location to place private user binaries, and you already mentioned Debian 8 supports this.\n\n> Starting `start-tor-browser.desktop` from command line would also fail, because of the sub folder (not included in `PATH`). (And additionally, `start-tor-browser.desktop` has an upstream bug(?): You need to `cd` into the folder, before you can run `./start-tor-browser.desktop`.\n\n**This would be the best solution IMO:**\n\nThe main `tor-browser_en-US` private package should either be located in `~/.tor-browser_en-US`, or within a parent hidden directory like `~/.tb|tor|tor-browser/tor-browser_en-US` (to allow old versions, or additional locales) .  This keeps the main user directory clean and is an acceptable directory to put such a package according to the `Filesystem Hierarchy Standard`.  The other acceptable location could be the `~/opt` directory.  My preference though would be in a hidden subdirectory such as `~/.tb/tor-browser_en-US` directory.\n\nThe desktop application file should then be located in `~/.local/share/applications/start-tor-browser.desktop` which is the `XDG_DATA_DIR`.  This would then make the `Tor browser` application available on the `start menu`.  The XDG user data directories are used to store user data.\n\nFurther a wrapper or soft-link can be provided within the `~/bin` directory to directly start `Tor browser` from the command line, or if `Tor browser` is able to be activated from `Dbus` the `gapplications`\n\n\n\n"},{"author":"Patrick","date_created":1435344796,"date_modified":1435348155,"content":"Whonix 11 currently uses:\n\n* cache dir: `~/.tb`\n* data dir: `~/tor-browser_en-US`\n\nWhonix 12 proposal:\n\n* cache dir: `~/.cache/tb`. Maybe even honoring $XDG_CACHE_HOME. (Containing tarballs, signatures, sha.) (Can be deleted without browser data loss.)\n* data dir: `~/.tb` (Containing TBB binary and user data, bookmarks etc.) (Supposed to be included in backups by users.)\n"},{"author":"marmarek","date_created":1435347739,"date_modified":1435347739,"content":"\n\n  - {F140, layout=link}"},{"author":"Patrick","date_created":1435348190,"date_modified":1435348190,"content":"True. Was a copy'n'paste mistake. Fixed."},{"author":"Patrick","date_created":1436550924,"date_modified":1436550924,"content":"`refactoring, made \"$tb_home_folder/tor-browser_$TB_LANG\" a variable tb_browser_folder, useful for later moving of the Tor Browser folder to a more appropriate location - https://phabricator.whonix.org/T338`:\nhttps://github.com/Whonix/tb-starter/commit/202270d89953851fe039b3db81c85290f6383d55"},{"author":"Patrick","date_created":1436553340,"date_modified":1436553340,"content":"`refactoring, made \"$tb_home_folder/tor-browser_$TB_LANG\" a variable tb_browser_folder, useful for later moving of the Tor Browser folder to a more appropriate location - https://phabricator.whonix.org/T338`:\nhttps://github.com/Whonix/tb-updater/commit/0e5d47f14d2271b4d1aaa9aa33a91c452b4e6279"},{"author":"Patrick","date_created":1438189623,"date_modified":1438189623,"content":"`changed default data dir to ~/.tb and cache dir to ~/.cache/tb - https://phabricator.whonix.org/T338`:\nhttps://github.com/Whonix/tb-updater/commit/6e919a326bea5e21d3cee5bfd7efa884e31edde7\n"},{"author":"Patrick","date_created":1438190037,"date_modified":1438190037,"content":"`changed default data dir to ~/.tb and cache dir to ~/.cache/tb - https://phabricator.whonix.org/T338`:\nhttps://github.com/Whonix/tb-starter/commit/8a06f0244a64a563f43503b279015f1e6633c2ef\n"}]},"PHID-TASK-7seydzfybccqgrbmb5r2":{"id":"337","title":"install Tor Browser by default in Qubes-Whonix","status":"resolved","priority":"Normal","author":"Patrick","description":"For better #usability.\n\nWhonix's #build script as well as #tb-updater already supports that. Build script command line switch:\n\n```\n## --tb none|closed|open\n## none: Do not install Tor Browser.\n## closed: Fail closed if Tor Browser cannot be installed.\n## open: Fail open if Tor Browser cannot and installed.\n```\n\n-----\n\nFailing open vs closed:\n\n* Failing open: if Tor Browser download fails, the build continues without invoking the error handler.\n* Failing closed: if Tor Browser download fails, the build invokes the error handler.\n\n-----\n\nWhy not fix tb-updater and make sure it does not fail?\n\nEconomically impossible. In past, TPO kept changing download locations, links, verification scheme, version format and more. I would be surprised, if tb-updater won't need to be updated in future again to cope up with their changes.\n\n-----\n\nWhat are the reasons, why we didn't do this earlier for Whonix 10? From https://www.whonix.org/wiki/Tor_Browser#Not_installed_by_Default.\n\n> Tor Browser is not installed by default anymore. If you are interested in the reasons why, [...]\n\n> Licensing reasons:\n> * Mozilla trademark: https://trac.torproject.org/projects/tor/ticket/10888\n> * The Tor Project trademark: https://www.whonix.org/wiki/Dev/TPO_Trademark\n\nIf the distributor of Qubes-Whonix, the Qubes team doesn't mind, I (@Patrick) won't mind either.\n\n> Security reasons:\n> * Forces the user to get an up to date version of Tor Browser. By the time users download Whonix, mostly the shipped version of Tor Browser would be already outdated.\n\nCould be solved by frequent releases if you're up for that. Or solved by having users manually upgrade. Then at least half of the time they have better usability.\n\n> Technical reasons:\n> * Users who build Whonix from source code won't have issues with a build script that is broken, just because of issues with downloading Tor Browser. [Although since Whonix 10 the build script has an option `--tb open` that would fail open, i.e let the build continue, even if Tor Browser download failed as opposed to `--tb closed` that would fail closed, i.e. invoke the usual error handler of the build script. (Default is `--tb none`.)]\n\nWhat's your thoughts on that... Do we want the build to fail open or closed by default?\n","comments":[{"author":"nrgaway","date_created":1433363237,"date_modified":1433363237,"content":"I noticed tor-browser installs in the root of the users home directory.\n\nWould it be possible to automatically install it in the ~/bin directory as not to clutter the root directory?\n\n"},{"author":"Patrick","date_created":1433363844,"date_modified":1433363844,"content":">>! In T337#5157, @nrgaway wrote:\n> I noticed tor-browser installs in the root of the users home directory.\n> \n> Would it be possible to automatically install it in the ~/bin directory as not to clutter the root directory?\n\nCreated T338 for it. Will answer there."},{"author":"nrgaway","date_created":1433364448,"date_modified":1433364448,"content":"It should fail as the build would not be complete.\n\nI think it might be better for qubes-builder to download and verify the browser though, then it would be available to install after Whonix?"},{"author":"Patrick","date_created":1433366128,"date_modified":1433366128,"content":">>! In T337#5182, @nrgaway wrote:\n> It should fail as the build would not be complete.\n\nOk.\n \n> I think it might be better for qubes-builder to download and verify the browser though, then it would be available to install after Whonix?\n\nWhen you run [`whonix_build`](https://github.com/marmarek/qubes-template-whonix/blob/fcef742c0ccf8d75751cb116e7b12b5d079c389e/whonix-gateway/02_install_groups_pre.sh#L165), just add below line [~175](https://github.com/marmarek/qubes-template-whonix/blob/fcef742c0ccf8d75751cb116e7b12b5d079c389e/whonix-gateway/02_install_groups_pre.sh#L175)...\n\n```\n --tb closed \\\n```\n\nThat's all and this ticket will be implemented. [+ testing] It will be installed in the image. And therefore of course be available after first boot of the image.\n\n(FYI: This is done by the [chroot-script](https://www.whonix.org/wiki/Dev/Source_Code_Intro#Chroot_Scripts) /[usr/lib/anon-dist/chroot-scripts-post.d/70_torbrowser](https://github.com/Whonix/anon-shared-build-inst-tb/blob/master/usr/lib/anon-dist/chroot-scripts-post.d/70_torbrowser))\n\nWhonix's build script can do this. The ability to implement this ticket is one reason why I implemented this. I don't know what benefit it would have to re-implement this in qubes-builder."},{"author":"nrgaway","date_created":1433370967,"date_modified":1433370967,"content":"The only reason is since I was under impression the file will be downloaded and may fail, compared to downloading the file initially and knowing it won't fail since the file is already in local repo directory.\n\nI will test it out; sounds cool!"},{"author":"Patrick","date_created":1433371372,"date_modified":1433371372,"content":">>! In T337#5192, @nrgaway wrote:\n> The only reason is since I was under impression the file will be downloaded and may fail, compared to downloading the file initially and knowing it won't fail since the file is already in local repo directory.\n\nUnderstood. (Well, when tb-updater fails downloading it, anything else would also fail. So it cannot be made more robust to my knowledge either way.)\n \n> I will test it out; sounds cool!\n\nGreat."},{"author":"Patrick","date_created":1439599165,"date_modified":1439599165,"content":"Done in #Whonix_11."}]},"PHID-TASK-fbyyu3bd4rwmktheb554":{"id":"336","title":"disable timesyncd by default","status":"resolved","priority":"Normal","author":"Patrick","description":"Debian will enable timesyncd by default in #Debian_Stretch. It would conflict with #sdwdate. Therefore we need to disable it when we port to #Debian_Stretch.","comments":[{"author":"Patrick","date_created":1441631562,"date_modified":1441631562,"content":"This is also an issue in #Qubes / #jessie. `/etc/systemd/system/sysinit.target.wants/systemd-timesyncd.service` exists there. Most likely because of this (**[link](https://github.com/adrelanos/qubes-template-whonix/blob/842fea2f4ff9d394a5307c8eca8259702b76fdbd/whonix-gateway/04_install_qubes_post.sh#L190-L193)**) not easily solvable issue? So I need to fix this for #Whonix_12.\n\nSomething like this would fix it.\n`/lib/systemd/system/systemd-timesyncd.service.d/40_sdwdate.conf`\n\n```\n## This file is part of Whonix.\n## Copyright (C) 2012 - 2015 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\n[Unit]\nConditionPathExists=!/usr/lib/sdwdate\n```\n\nI am wondering where to add this. New package `timesyncd-disable` or existing package #sdwdate? The latter would certainly cost less time. But I don't know if the latter would hinder upstreaming the package to Debian."},{"author":"Patrick","date_created":1441723950,"date_modified":1441723950,"content":"`disable systemd-timesyncd by default as it conflicts with sdwdate - https://phabricator.whonix.org/T336`:\nhttps://github.com/Whonix/sdwdate/commit/83ef0068cb7c0287d6f2d6feab2d8d4961f8a260\n"}]},"PHID-TASK-c7gxikkiqw2ea67uxoyy":{"id":"335","title":"disable hwclock-save.service","status":"open","priority":"Wishlist","author":"Patrick","description":"Quote Tails issue tracker:\n\n> systemd (215-13)'s debian/changelog entry says:\n\n> `Add hwclock-save.service to sync the system clock to the hardware clock on shutdown, to provide monotonic time for reboots. (Note: this is a hack for jessie; the next Debian release will enable timesyncd by default). (Closes: #755722)`\n\n> We need to disable that, as per our design goal to avoid leaving traces on the hardware being used, as much as possible.\n\n> For more information, see https://bugs.debian.org/755722. (And interestingly, there we learn that under sysvinit (Wheezy), util-linux's hwclock.sh is supposed to \"overwrite the RTC with the system clock partway through the shutdown\", so that's not exactly a regression against Tails/Wheezy, but rather a problem we already had. Will file a dedicated ticket about it.)\n\nSource:\nhttps://labs.riseup.net/code/issues/9363\n","comments":[]},"PHID-TASK-hw6c3cnciucq55cak5vh":{"id":"334","title":"check sdwdate prerequisite before each fetch attempt","status":"resolved","priority":"Normal","author":"Patrick","description":"Currently, when the prerequisite was fulfilled (i.e. when connectivity was functional), all three fetches are sequentially attempted without checking again if the prerequisite is still fulfilled. This is problematic, because when connectivity goes down during or after the first fetch, the remaining fetches will wait for the full timeout. By waiting until the prerequisite is fulfilled before every fetch, waiting for these timeouts can be avoided in many cases.\n\nRelated:\n\n* https://github.com/Whonix/sdwdate-plugin-anon-shared-con-check\n* https://github.com/Whonix/sdwdate-plugin-anon-shared-con-check/blob/master/etc/sdwdate.d/31_anon_dist_con_check_plugin\n* https://github.com/Whonix/anon-shared-helper-scripts/blob/master/usr/lib/anon-shared-helper-scripts/te_pe_tb_check\n* https://github.com/Whonix/sdwdate/blob/0f6e50748eaeab34f9f00ce7dfbd80e980cb2a5b/usr/lib/sdwdate/modules.d/sdwdate#L1554-1585\n","comments":[{"author":"Patrick","date_created":1433170452,"date_modified":1433170452,"content":"`check sdwdate prerequisite before each fetch attempt - https://phabricator.whonix.org/T334`:\nhttps://github.com/Whonix/sdwdate/commit/52e09908ca9b8181de4b64a96b1abb80e4693863\n"}]},"PHID-TASK-54rlcii4qhfgu3krretq":{"id":"333","title":"anon-gw-leaktest broken on jessie based Whonix 11","status":"resolved","priority":"Normal","author":"Patrick","description":"From https://github.com/Whonix/anon-gw-leaktest/blob/master/usr/bin/leaktest the following command does not work anymore.\n\n```\nsudo -u user tshark -i eth0 -S -f 'ip and src host 10.0.2.15 and not (port 80 or port 443 or port 9001 or port 9030 or ssh)'\n```\n","comments":[{"author":"Patrick","date_created":1433004419,"date_modified":1433004419,"content":"`fix - https://phabricator.whonix.org/T333`:\nhttps://github.com/Whonix/anon-gw-leaktest/commit/03dfaaf2d2b772d94239e99fb92b8ad174299608\n"},{"author":"Patrick","date_created":1433605056,"date_modified":1433605056,"content":"Fixed in Whonix `10.0.0.2.3`."}]},"PHID-TASK-xa6onn4jgszqvqu3mlmi":{"id":"332","title":"use timedatectl as sanity check in whonixcheck","status":"resolved","priority":"Normal","author":"Patrick","description":"Parsing information by `timedatectl`.","comments":[{"author":"HulaHoop","date_created":1432850238,"date_modified":1432850238,"content":"timedatectl's output looks like the standard date format extracted from http headers and so can be processed with similar logic to sdwdate: \n\n> timedatectl Local time: Mon 2013-09-16 19:30:24 CEST Universal time: Mon 2013-09-16 17:30:24 UTC\n\nYou can set system date and time similar to how date --set works.\n\n> timedatectl set-time HH:MM:SS\n\n> timedatectl set-time YYYY-MM-DD\n\n> timedatectl set-timezone time_zone\n\nhttps://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/chap-Configuring_the_Date_and_Time.html\n\n***\n\nIs the timedatectl sanity check going to be used besides anon-tordate plugin?\n"},{"author":"Patrick","date_created":1432851519,"date_modified":1432851519,"content":"whonixcheck only. Similar to [check_kvmclock](https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_kvmclock). Just testing to see that systemd's time synchronization feature isn't active."},{"author":"HulaHoop","date_created":1432857350,"date_modified":1432857350,"content":"> $ timedatectl\n\njust gives the system time and doesn't set anything. \n\nDo you know if it can be disabled? I'm  not sure if it can be disabled like kvmclock, but it won't interfere with the system time unless instructed. Additional feature of automatic NTP time syncing by timedatectl is not enabled by default. To run it would need :\n\n> timedatectl set-ntp true"},{"author":"Patrick","date_created":1432857657,"date_modified":1432857657,"content":">>! In T332#5074, @HulaHoop wrote:\n>> $ timedatectl\n> \n> just gives the system time and doesn't set anything. \n\nAnd that's fine.\n\nWill just check this:\n\n```\nNTP enabled: no\nNTP synchronized: no\n```\n\nAnd perhaps:\n```\nRTC in local TZ: \n```\n\nAnd perhaps:\n```\nDST active: \n```\n \n> Do you know if it can be disabled? I'm  not sure if it can be disabled like kvmclock, but it won't interfere with the system time unless instructed. Additional feature of automatic NTP time syncing by timedatectl is not enabled by default. To run it would need :\n> \n>> timedatectl set-ntp true\n\nYes, but checking it's not is the whole todo here. Nothing fancy."},{"author":"HulaHoop","date_created":1434919083,"date_modified":1434919083,"content":"http://www.freedesktop.org/software/systemd/man/timedatectl.html\n\nService file is at this path:\n/usr/lib/systemd/system/systemd-timesyncd.service\n\nService can be set to disabled at boot."},{"author":"Patrick","date_created":1434922251,"date_modified":1434922251,"content":"It's not enabled by default, fortunately. If it was, we might likely be able to create a file `/etc/systemd/system/systemd-timesyncd.d/30_whonix.conf` with the following content.\n\n```\n## This file is part of Whonix.\n## Copyright (C) 2012 - 2015 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\n[Unit]\nConditionPathExists=!/usr/share/anon-gw-base-files/gateway\nConditionPathExists=!/usr/share/anon-ws-base-files/workstation\n```\n\nOr better in `/lib/system/systemd-timesyncd.d/30_whonix.conf`?\n\nWe could do this anyhow to be on the safe side also in far future. I am not sure in which package adding this would be appropriate."},{"author":"Patrick","date_created":1436547395,"date_modified":1436547395,"content":"`parse output of timedatectl as sanity check in whonixcheck to make sure systemd NTP is disabled as well as timezone is set to UTC - https://phabricator.whonix.org/T332`:\nhttps://github.com/Whonix/whonixcheck/commit/07f5922b48447a0a9828c708bde1c18a12c20ca5\n"}]},"PHID-TASK-o2mrinx3ff4v3haiknsk":{"id":"331","title":"check if invocations of 'service' by Whonix scripts in Whonix 11 is functional","status":"resolved","priority":"Normal","author":"Patrick","description":"Find related code by running.\n\n```\ngrep -r --exclude-dir '.git*' --exclude README.md --exclude changelog.upstream --exclude GPLv3 \"service \" *\n```\n\nAnd check if the related functionality is working.\n\nForum discussion:\n[Is Whonix 11 using systemd functions in bash, python scripts?](https://www.whonix.org/forum/index.php/topic,1228.0.html)\n","comments":[]},"PHID-TASK-edwerksilv6cjag5rwqi":{"id":"330","title":"anon-ws-disable-stacked-tor, Debian Strech, systemd port","status":"resolved","priority":"Normal","author":"Patrick","description":"In #Debian_Stretch, upstream (Debian) might add a #systemd unit file to the [rinetd](https://packages.debian.org/stretch/rinetd) package.\n\nWhen that happens (at time we port Whonix to #Debian_Stretch), we need to update the following code in the #anon-ws-disable-stacked-tor maintainer scripts.\n\n```\ngrep -r /etc/init.d/rinetd *\n```\n\n* `debian/anon-ws-disable-stacked-tor.postinst:         if [ -x \"/etc/init.d/rinetd\" ]; then`\n* `debian/anon-ws-disable-stacked-tor.postrm:         if [ -x \"/etc/init.d/rinetd\" ]; then`\n","comments":[{"author":"Patrick","date_created":1466083460,"date_modified":1466083460,"content":"Since rinetd has been replaced with socat in T464, this code can be removed."},{"author":"Patrick","date_created":1466083668,"date_modified":1466083668,"content":"https://github.com/Whonix/anon-ws-disable-stacked-tor/commit/63a0d3ccd15646cf11d7c37a2a7fbde7e4b0bb61"}]},"PHID-TASK-62x2n6ciahoxq3esgkuq":{"id":"329","title":"do not 'set -o pipefail' in /usr/lib/pre.bsh","status":"resolved","priority":"Normal","author":"Patrick","description":"config-package-dev doesn't like 'set -o pipefail'?\nhttp://mailman.mit.edu/pipermail/config-package-dev/2015-May/000041.html\n\nhttps://github.com/Whonix/anon-base-files/blob/master/usr/lib/pre.bsh\n","comments":[{"author":"Patrick","date_created":1432847601,"date_modified":1432847601,"content":"`no longer 'set -o pipefail' in /usr/lib/pre.bsh - https://phabricator.whonix.org/T329`:\nhttps://github.com/Whonix/anon-base-files/commit/3c4e108e7732fa83fceea628540b80d8529d57ef\n"}]},"PHID-TASK-p6zl7mxjpe732pefdp6q":{"id":"328","title":"remove unnecessary 'systemctl restart' call from qubes-whonix package","status":"resolved","priority":"Normal","author":"Patrick","description":"From https://github.com/nrgaway/qubes-whonix/blob/Whonix11/debian/qubes-whonix.postinst#L162 ... The following can be removed.\n\n```\n# Will not be restarted in chroot which is what is expected\nsystemctl restart qubes-whonix-network.service\nsystemctl restart qubes-whonix-firewall.service\n```\n\nBecause debhelper does the right thing. (Using [deb-systemd-invoke](http://manpages.debian.org/cgi-bin/man.cgi?&query=deb-systemd-invoke) (Which is a pretty small, simple looking script, effectively without comments just ~40 lines of perl code, used by whole Debian.) Adds the following code to the postinst.\n\n```\n# Automatically added by dh_systemd_start\nif [ -d /run/systemd/system ]; then\n\tsystemctl --system daemon-reload >/dev/null || true\n\tdeb-systemd-invoke start qubes-whonix-network.service qubes-whonix-firewall.service >/dev/null || true\nfi\n# End automatically added section\n```\n\nThis also fixes a lintian warning (`W: qubes-whonix: maintainer-script-calls-systemctl`). (T186)","comments":[{"author":"nrgaway","date_created":1433607926,"date_modified":1433607926,"content":"Done\n\n[[ https://github.com/nrgaway/qubes-whonix/commit/36b4368094e9f690233be50c1d5efa6167a421c8 | https://github.com/nrgaway/qubes-whonix/commit/36b4368094e9f690233be50c1d5efa6167a421c8 ]]"}]},"PHID-TASK-n5hch3gzqzu4yz3oplzk":{"id":"327","title":"skip whonixsetup / whonix-setup-wizard disclaimer in qubes-whonix","status":"resolved","priority":"Normal","author":"Patrick","description":"```\n    if ! [ -f \"/var/cache/whonix-setup-wizard/status-files/disclaimer.done\" ]; then\n        # Setup repository in template\n        sudo mkdir -p /var/cache/whonix-setup-wizard/status-files\n        sudo touch /var/cache/whonix-setup-wizard/status-files/whonix_repository.done\n\n        XDG_CURRENT_DESKTOP=gnome sudo /usr/bin/whonix-setup-wizard setup -style gtk+\n    fi\n```\n\nWhat's the, `if`, the `if ! [ -f \"/var/cache/whonix-setup-wizard/status-files/disclaimer.done\" ]` good for? @nrgaway?\n\nJoanna wants the disclaimer skipped, and I (@Patrick) don't mind, because I am not the distributor of qubes-whonix.\n\nSkipping the disclaimer is supported by creating the `/var/cache/whonix-setup-wizard/status-files/disclaimer.skip` status file.\n\nBut then the `/var/cache/whonix-setup-wizard/status-files/disclaimer.done` status file will never be created.\n\nCan we get rid of that `if` @nrgaway?","comments":[{"author":"nrgaway","date_created":1433029787,"date_modified":1433029787,"content":"Currently Setup is run differently for the `Template` vs an `AppVM`.  \n\nThe `AppVM` shows the initial disclaimer and sets up Tor.\n\nThe 'Template` only run repository setup as the updates are completed in the `Template` and not `AppVM`.\n\nThe disclaimer is only shown once; either in Template or AppVM.  Same goes for the other setup, it is only shown once as well.\n\nI could just set everything up to run by default with no disclaimer and Tor initially enabled as well as the repo set up to stable.  Instructions can be provided on how to change these options.  For instance, someone who needs to run a obsproxy can just not enable the network `netvm` when initially setting up Whonix which would allow them to set up proxy first.  This way Whonix would run out of the box per-se.\n\n"},{"author":"Patrick","date_created":1433076470,"date_modified":1433076470,"content":"Joanna wants the disclaimer skipped in qubes-whonix. Always.\n\nAnd that's fine with me, because Qubes is the distributor of qubes-whonix. Not me. So any laws that apply to me, don't apply to her. And if she doesn't see need for such a disclaimer, I am happy she wants to abolish it.\n\nBy the way, I don't think there is no need to delete any status-files files and such. If it were, that would be an awful interface. And I think it's safe to say, we want nice interfaces. See:\n\n```\nkdesudo whonix-setup-wizard \nusage: whonix-setup-wizard [-h] {setup,repository,locale_settings}\n```\n\nThat means by running [1],\n* `kdesudo whonix-setup-wizard setup` it starts Whonix connection wizard\n* `kdesudo whonix-setup-wizard repository` it starts Whonix repository tool\n\n>>! In T327#5098, @nrgaway wrote:\n> I could just set everything up to run by default with no disclaimer and Tor initially enabled as well as the repo set up to stable.  Instructions can be provided on how to change these options.  For instance, someone who needs to run a obsproxy can just not enable the network `netvm` when initially setting up Whonix which would allow them to set up proxy first.  This way Whonix would run out of the box per-se.\n\nThat's another discussion for later. Joanna had a management VM in mind. I'll be creating a ticket later.\n\nFor now - for the purpose of Whonix 11 - this ticket, let's just create the `/var/cache/whonix-setup-wizard/status-files/disclaimer.skip` status-file to skip the disclaimer in qubes-whonix by default. And maybe prettify usage of whonix-setup-wizard by using the above syntax [1] with no need to delete any status-files just to start it."},{"author":"nrgaway","date_created":1433608054,"date_modified":1433608054,"content":"Done\n\n[[ https://github.com/nrgaway/qubes-whonix/commit/182a283d1ba3144d78f6d83b86b796792e3a9917 | https://github.com/nrgaway/qubes-whonix/commit/182a283d1ba3144d78f6d83b86b796792e3a9917 ]]"}]},"PHID-TASK-5fcil5ww3cfdy2d3njkx":{"id":"326","title":"delete /etc/tmpfiles.d/qubes-whonix-whonixcheck.conf","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/nrgaway/qubes-whonix/blob/Whonix11/etc/tmpfiles.d/qubes-whonix-whonixcheck.conf can be deleted?\n\nNow that there is https://github.com/Whonix/whonixcheck/blob/master/usr/lib/tmpfiles.d/whonixcheck.conf there should be no reason to keep it?","comments":[{"author":"nrgaway","date_created":1433029024,"date_modified":1433029024,"content":"Ok"},{"author":"Patrick","date_created":1433169177,"date_modified":1433169177,"content":"Please review and merge:\nhttps://github.com/nrgaway/qubes-whonix/pull/8\n"},{"author":"nrgaway","date_created":1433607076,"date_modified":1433607076,"content":"Done"}]},"PHID-TASK-deqsuzecgdv7ixr7c76n":{"id":"325","title":"wants to upgrade python-guimessages, whonix-setup-wizard, tb-default-browser even though already up to date","status":"resolved","priority":"Normal","author":"Patrick","description":"build version:\n\n```\ncat /var/lib/anon-dist/build_version\n11.0.0.2.0\n```\n\nThat comes with...\n\n```\ndpkg -l | grep python-guimessages\nii  python-guimessages                       3:0.6-1                             all          Translatable GUI Messages\n```\n\npkg version in source package:\n\n```\nhead -n 1 debian/changelog \npython-guimessages (3:0.6-1) unstable; urgency=low\n```\n\ndevelopers repository:\n\n```\napt-cache show python-guimessages | grep -i version\nVersion: 3:0.6-1\n```\n\nEven though it's already up to date, `apt-get dist-upgrade` would \"upgrade\" it.\n\nSame issue with whonix-setup-wizard and tb-default-browser.","comments":[{"author":"Patrick","date_created":1432655012,"date_modified":1432655012,"content":"No idea why this is happening.\n\nMy first speculation was, that somehow the derivation `Maintainer:` causes this, which is set to troubadour instead of me. But there is no such issue for control-port-filter-python, so that's unlikely.\n\nSmall attempt to fix...\n`debian/control: removed empty 'Recommends:' field`:\nhttps://github.com/Whonix/python-guimessages/commit/e6b28926a320ac81bb9358e263d6f966836e28cd\nPerhaps that was confusing things. Unlikely, that this is the cause.\n"},{"author":"Patrick","date_created":1432911885,"date_modified":1432911885,"content":"tb-default-browser... 'diff'ed /var/lib/dpkg/status before and after installation. Only difference...\n\nimage comes with:\n```\nInstalled-Size: 92\n```\n\nvs after upgrade from repository:\n\n```\nInstalled-Size: 93\n```\n\nMaybe packages just need to be rebuild using `jessie` based Debian, because they're still build using `wheezy` based Debian."},{"author":"Patrick","date_created":1433904572,"date_modified":1433904572,"content":"Yes, they needed to be rebuild on `jessie`."}]},"PHID-TASK-rujr2jrlfkgxu2qicco2":{"id":"324","title":"Add package needrestart","status":"open","priority":"Normal","author":"HulaHoop","description":"I propose to add the needrestart pkg :\n\n>New in this release is the needrestart package. When installed, it will perform a check after each APT upgrade session. If any services running on the system require a restart to take advantage of changes in the upgraded packages then it offers to perform these restarts. It is recommended to install needrestart to ensure that security updates in libraries are propagated to running services.","comments":[{"author":"Patrick","date_created":1432443031,"date_modified":1432443031,"content":"Good point.\n\nSomewhat documented in the deepness of expand buttons updating documentation:\nhttps://www.whonix.org/wiki/Security_Guide#Operating_System\n\nSomewhat related to T135.\n\nHave you actually tried this? I worry about the usability of this thing. It mentions that a lot services need to be restarted. A few of them are checked by default, other such as kdm not. Now, if a user who is trying hard to be secure checks kdm, then kdm is shut down. Together with the Konsole that was running apt-get. All other open windows, all unsaved work would be lost. Surely a nice tool for slightly advanced users, but installed by default? Maybe it can be configured to prevent such a mess."},{"author":"HulaHoop","date_created":1432479601,"date_modified":1432479601,"content":"needrestart can be set to only list the packages that need a restart without taking action. Users will be notified and take the necessary steps before restarting their system:\n\nhttps://github.com/liske/needrestart/blob/master/man/needrestart.1\n\nhttps://packages.debian.org/jessie/admin/needrestart"},{"author":"Patrick","date_created":1432487208,"date_modified":1432487208,"content":"See this screneshot.\n\n{F71}\n\nWhen users think they doing something good and check all these boxes, it will kill kdm, their Konsole session, apt-get that was run by the Konsole session as well as all unsaved work."},{"author":"HulaHoop","date_created":1432492956,"date_modified":1432492956,"content":"Right. But if you run needrestart -v -r l\n(Small L)\n\nIt would only act as a notification only without giving options for restart."},{"author":"Patrick","date_created":1432659266,"date_modified":1432659266,"content":"Not talking about manual invocation here. It automatically runs with that option during apt-get dist-upgrade. Maybe it's possible to configure this, but then this would require shipping a configuration file. Either as part of the [usability-misc](https://github.com/Whonix/usability-misc) package or a separate packages.\n\nApparmor issue:\n```\nMay 26 16:03:45 host kernel: [ 7239.228434] audit: type=1400 audit(1432656225.140:100): apparmor=\"DENIED\" operation=\"open\" profile=\"/usr/bin/whonixcheck\" name=\"/etc/dpkg/dpkg.cfg.d/needrestart\" pid=13517 comm=\"dpkg\" requested_mask=\"r\" denied_mask=\"r\" fsuid=0 ouid=0\n```\n\nNeeds more work. Therefore moving to Whonix 12."},{"author":"Patrick","date_created":1438192437,"date_modified":1438192437,"content":"Testing the following config... `/etc/needrestart/conf.d/50_user.conf`\n\n```\n$nrconf{restart} = 'l';\n```\n\nTherefore it doesn't run interactively anymore. Prevents users selecting services such as kdm and thereby shooting their own feet.\n\nThen the extraneous output when running 'apt-get dist-upgrade' is the following.\n\n```\nScanning processes...                                                                                                 \nScanning candidates...                                                                                                \nScanning kernel images...                                                                                             \nFailed to retrieve available kernel versions.\nServices to be restarted:\nSkipping dbus.service...\nsystemctl restart polkitd.service\n```\n\nIs this output any helpful to users? Let's go through it line by line.\n\n* `Failed to retrieve available kernel versions.` - Probably a Qubes specific issue. May or may not be possible to fix this. But for let's ignore this, since I have greater worries that needrestart actually worsens usability.\n* `Skipping dbus.service...` - I see it coming. Users become concerned, asking in the forums, it said \"`Skipping dbus.service...`\", am I hacked? (What this really means, I guess is something like \"dbus is on a list of packages, that are not pre-selected for automatic restart recommendation\".)\n* `systemctl restart polkitd.service` - Alright. Users would either ignore this or know that this is convenient for them to copy and paste this.\n\nUnless this can be configured better, I think by default, for most users, with the current advice to reboot after upgrading is better. (Not installing needrestart by default.) (For advanced users there can be a hint about needrestart in documentation.)"},{"author":"HulaHoop","date_created":1438197488,"date_modified":1438197488,"content":"* Most people will have no idea what these messages mean to even bother asking if they are hacked.\n\n* Using a package manager GUI will hide all the information.\n\n* There might still be a way to hide this output either with a needrestart option \"a\" or in apt-get itself. needrestart manual page:\n\n\n-r\nset restart mode\n\nl\n(l)ist only\n\ni\n(i)nteractive restart\n\na\n(a)utomatically restart\n"},{"author":"HulaHoop","date_created":1438198274,"date_modified":1438198274,"content":"Running apt-get updates quietly can be done with:\n\napt-get dist-upgrade -qq\n\nWe can add the \"-qq\" as a condition if needrestart is included."},{"author":"Patrick","date_created":1438198399,"date_modified":1438198399,"content":">>! In T324#6148, @HulaHoop wrote:\n> * Most people will have no idea what these messages mean to even bother asking if they are hacked.\n\nI think not. Users know these messages. So we have a genuine disagreement here.\n\n> * Most people will have no idea what these messages mean to even bother asking if they are hacked.\n\nA different answer:\nIf that is so, if they don't know what these messages mean, why bother installing the needrestart then? If they don't know what these messages mean, then this ticket wasn't an improvement.\n \n> * Using a package manager GUI will hide all the information.\n\nJudging by the current rate of progress, I find this unrealistic and I am not convinced we are getting there anytime soon.\n \n> * There might still be a way to hide this output either with a needrestart option \"a\" or in apt-get itself. needrestart manual page:\n \n> l\n> (l)ist only\n\nIs what I was using above. The issues described:\nT324#6134\n \n> i\n> (i)nteractive restart\n\nProblematic UI as mentioned here:\nT324#4951\n \n> a\n> (a)utomatically restart\n\nRestarting without asking is too intrusive and causing all kind of trouble. Nothing we should set by default."},{"author":"HulaHoop","date_created":1438199000,"date_modified":1438199000,"content":"If you don't agree with the quiet option for apt-get dist-upgrade too then this ticket is good for closing."},{"author":"HulaHoop","date_created":1438200904,"date_modified":1438200904,"content":"OK I reread what the package does and a compromise would be to make a wrapper for it that hides the output that could trigger support threads and only say: Some packages that were updated need a system restart for the changes to take effect. Restart? Yes/No\n\nwe could have the details logged by needrestart to a logfile that advanced users can optionally check out.\n\n"},{"author":"HulaHoop","date_created":1438203629,"date_modified":1438203629,"content":"https://gehrcke.de/2014/06/good-to-know-checkrestart-from-debian-goodies/\n\nUseful blog post. There is checkrestart from debian-goodies pkg that does the same thing but works different.\n\nDebian upstream considering shipping either by default.\n"},{"author":"Patrick","date_created":1438258548,"date_modified":1438258548,"content":"I guess checkrestart is too dated?\n\nA wrapper could work. Disabling the hooks that come with needrestart. Adding new hooks. Having the wrapper run needrestart with hidden output. And showing a simplified message to users as appropriate.\n\n```\napt-file list needrestart\n```\n\nAnother TODO: contacting the author. Giving feedback. Asking if such a wrapper is necessary at all of if there is a simpler solution.\n\nAnother related thing:\nhttps://packages.debian.org/stretch/needrestart-session\n"},{"author":"Patrick","date_created":1438264672,"date_modified":1438264672,"content":"It also has a batch mode.\n\n```\nsudo needrestart -b\n```\n\n```\nNEEDRESTART-VER: 1.2\nNEEDRESTART-KCUR: 3.18.17-5.pvops.qubes.x86_64\nNEEDRESTART-KSTA: 0\nNEEDRESTART-SVC: dbus.service\nNEEDRESTART-SVC: polkitd.service\n```\n\n-----\n\n> * `Failed to retrieve available kernel versions.` - Probably a Qubes specific issue. May or may not be possible to fix this.\n\nThat could be fixed. `/etc/needrestart/conf.d/50_qubes.conf`\n\n```\n$nrconf{kernelhints} = '0';\n```\n\n```\nsudo needrestart -l -b\n```\n\n```\nNEEDRESTART-VER: 1.2\nNEEDRESTART-SVC: dbus.service\nNEEDRESTART-SVC: polkitd.service\n```\n"},{"author":"Patrick","date_created":1438265492,"date_modified":1438265492,"content":"feature request...\n`optional non-zero exit codes in case of restart(s) required`:\nhttp://bugs.debian.org/cgi-bin/bugreport.cgi?bug=794099\n"},{"author":"Patrick","date_created":1443551574,"date_modified":1443551574,"content":"https://github.com/liske/needrestart/issues/12#issuecomment-136799810"},{"author":"Patrick","date_created":1443551589,"date_modified":1443551589,"content":"https://github.com/liske/needrestart/issues/13#issuecomment-136804625"},{"author":"Patrick","date_created":1448031424,"date_modified":1448031424,"content":"#Qubes bug report:\n`needrestart reports 'Failed to retrieve available kernel versions.'`\nhttps://github.com/QubesOS/qubes-issues/issues/1442\n"},{"author":"Patrick","date_created":1448034003,"date_modified":1448034003,"content":"#Qubes bug fix:\n`Prevent services from being accidentally restarted by 'needrestart'.`\nhttps://github.com/marmarek/qubes-core-agent-linux/pull/51"},{"author":"Patrick","date_created":1459625251,"date_modified":1459625251,"content":"needrestart feature request:\n`easy mode for needrestart`\nhttp://bugs.debian.org/cgi-bin/bugreport.cgi?bug=819824"},{"author":"Patrick","date_created":1461614280,"date_modified":1461614280,"content":"https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=819824#10"},{"author":"Patrick","date_created":1462820489,"date_modified":1462820489,"content":">>! In T324#8576, @Patrick wrote:\n> needrestart feature request:\n> `easy mode for needrestart`\n> http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=819824\n\nThis feature has just been implemented! The author is asking for testing."},{"author":"Patrick","date_created":1484732071,"date_modified":1484732071,"content":"Readded Whonix 14 by accident during batch edit (adding all debian stretch tickets to Whonix 14)."},{"author":"Patrick","date_created":1561803224,"date_modified":1561803224,"content":"needrestart works good enough for it to be implemented as a test in #whonixcheck (`--verbose`?).\n\n    sudo needrestart -r l -b\n\n```\nNEEDRESTART-VER: 3.4\nNEEDRESTART-KCUR: 4.19.43-1.pvops.qubes.x86_64\nNEEDRESTART-KEXP: 4.19.0-5-amd64\nNEEDRESTART-KSTA: 3\n```\n\nSee https://github.com/liske/needrestart/blob/master/README.batch.md for meaning of `NEEDRESTART-KSTA`.\n\nOutput `NEEDRESTART-KSTA` cannot be interpreted directly yet in Qubes-Whonix but a temporary auto-generated config file as per T324#6180 could do.\n\nWhat is a good way to detect that users are using VM kernel in Qubes? @marmarek If `uname -r` outputs `4.19.43-1.pvops.qubes.x86_64` i.e. matches `*pvops* ` it means that no VM kernel is being used?\n"},{"author":"marmarek","date_created":1561805732,"date_modified":1561805732,"content":">>! In T324#18696, @Patrick wrote:\n> What is a good way to detect that users are using VM kernel in Qubes? @marmarek If `uname -r` outputs `4.19.43-1.pvops.qubes.x86_64` i.e. matches `*pvops* ` it means that no VM kernel is being used?\n\nI'd match *qubes*. Yes, should be good."}]},"PHID-TASK-4izytbubtrr4ynmsc5a7":{"id":"323","title":"install obfs4proxy in Whonix-Gateway 11 by default","status":"resolved","priority":"Normal","author":"Patrick","description":"We should probably install [`obfs4proxy`](https://packages.debian.org/jessie/obfs4proxy) by default, no?\n\nTo be added as `Depends:` to [`anon-gateway-packages-recommended`](https://github.com/Whonix/anon-meta-packages/blob/f400f82ad493befede7a78356e026b297d2ec7ba/debian/control#L61).","comments":[{"author":"HulaHoop","date_created":1432327536,"date_modified":1432327536,"content":"Yes it should be installed especially if we want Whonix to be useful for people behind firewalls.\n\nLong term we should have the pluggable transports chaining framework in Whonix so transports can be combined in interesting ways."},{"author":"Patrick","date_created":1432330437,"date_modified":1432330437,"content":">>! In T323#4819, @HulaHoop wrote:\n> Long term we should have the pluggable transports chaining framework in Whonix so transports can be combined in interesting ways.\n\nProbably unrealistic? Even T118 doesn't progress. Also I also don't know if chaining would make thing better (needs to be discussed on tor-talk). And if it were to make sense, that's something that would need to be implemented as an upstream, outside of Whonix, perhaps inside Tor. I don't think Whonix currently has the manpower to maintain such a project."},{"author":"HulaHoop","date_created":1432339326,"date_modified":1432339407,"content":"Tor upstream plans it, its not something I'm suggesting we should do. All I said was we should include bridge support in gw so we can take advantage of features like this when they become ready.\n\n"},{"author":"Patrick","date_created":1432343863,"date_modified":1432343863,"content":">>! In T323#4832, @HulaHoop wrote:\n> Tor upstream plans it, its not something I'm suggesting we should do.\n\nInteresting. Missed that. Got any reference?\n\n> All I said was we should include bridge support in gw so we can take advantage of features like this when they become ready.\n\nSure, please open tickets as soon we can act."},{"author":"Patrick","date_created":1432344379,"date_modified":1432344379,"content":"`added obfs4proxy to anon-gateway-packages-recommended - https://phabricator.whonix.org/T323`:\nhttps://github.com/Whonix/anon-meta-packages/commit/62cf77e325ad05fb3b46d089d8a0f51dfec95e80"},{"author":"HulaHoop","date_created":1432358566,"date_modified":1432358566,"content":"https://trac.torproject.org/projects/tor/wiki/doc/PluggableTransports\n\nsection: Combining pluggable transports\n\nLinks to trac tickets and code under there too if you want to follow them."}]},"PHID-TASK-jxk5bccxqosyz7xqqfmn":{"id":"322","title":"obfsproxy not working on Qubes R3","status":"resolved","priority":"High","author":"nrgaway","description":"[[ https://www.whonix.org/forum/index.php/topic,1249.0.html | https://www.whonix.org/forum/index.php/topic,1249.0.html ]]\nQuote from: oneoffew on May 21, 2015, 06:32:10 am\n\n    I have no idea why, but obfsproxy isn't working on R3. arm shows no network traffic.\n\n    Before it's asked:\n    * Yes, Whonix has worked before, I've been using Whonix on Qubes (R2) for several months.\n    * No, I haven't changed  the configuration. I spent around 13 hours (tempered by coffee making breaks!) yesterday trying to get it to work, but then I removed qubes-gw-experimental and installed it again (actually, twice) to make sure it wasn't some fuckwittery of my own.\n    * I managed to get plain Tor to \"work\" once, I have no idea how since configuration didn't change between rebooting the domain.\n    * I've tried connecting it directly to the netvm\n    * I've tried disabling ipv6 (ipv6.disable) in the netvm, firewallvm, and gateway\n    * I've tried the R2 kernel\n    * Yes, tbb does work (thank God...) in the Fedora template.\n\n    Any help would be greatly appreciated.\n\n\nI will create an issue for this.  I have never used obsproxy before so do not know how to test it off hand.  First thing to look into is to make sure it works in regular Whonix 10.  Maybe I missed some startup file or firewall rule.  ","comments":[{"author":"nrgaway","date_created":1432283471,"date_modified":1432283471,"content":"@Patrick I was wondering if this is working in regular Whonix 10?  If so can you give me some clues on how to troubleshoot it (startup scripts, configuration locations, expected firewall rules) since I have never used it before"},{"author":"Patrick","date_created":1432301583,"date_modified":1432301583,"content":"- works for me in Whonix 10\n- Documentation: https://www.whonix.org/wiki/Bridges\n- obfsproxy: https://www.whonix.org/wiki/Bridges#Using_obfuscated.2C_.28private.29_and.2For_ordinary_bridges\n- no different firewall rules required for obfs3\n- no startup scripts required\n- no other fancy stuff required\n- user configuration is simply added to /etc/tor/torrc\n- make sure the obfsproxy package is installed\n- apparmor was an issue in past, try obfsproxy yourself and check /var/log/kern.log\n- for now, just try it out yourself. Does it work for you? If it works for you, if you can confirm from /var/log/tor/log and arm, that Tor is in fact connecting only to the obfs3 bridges you configured, then it's more likely a user configuration error than Whonix bug.\n"},{"author":"nrgaway","date_created":1432302766,"date_modified":1432302766,"content":"Thanks for all the info.  I will test it out over the weekend!"},{"author":"oneoffew","date_created":1433447525,"date_modified":1433447525,"content":"This seems to have gotten lost in the backlog.\n\nSeeing that nrgaway mentioned init scripts and firewalls, here's the output of iptables-save:\n\n{P1}\n\nIn case either are useful, tor log:\n\n>[warn] Problem bootstrapping. Stuck at 15%: Establishing an encrypted directory connection. (DONE; DONE; count 2; recommendation warn)\n>[warn] 2 connections have failed:\n>[warn]  2 connections died in state handshaking (TLS) with SSL state unknown state in HANDSHAKE\n\nobfsproxy log:\n{P2}\nNote the timing. I don't know what sort of delays iptables can be expected to give, but perhaps someone else can infer something.\n\ntorrc matches the guide, with:\n>DisableNetwork 0\n>\n>UseBridges 1\n>\n>ClientTransportPlugin scramblesuit exec /usr/bin/obfsproxy managed\n>\n>bridge scramblesuit [ip]:[port] [id] password=[password]\n>bridge scramblesuit [ip]:[port] [id] password=[password]\n\nBoth tor and obfsproxy are running as uid 104."},{"author":"oneoffew","date_created":1433459606,"date_modified":1433459606,"content":"For the record, flushing all rules and defaulting to ACCEPT makes obfsproxy work."},{"author":"Patrick","date_created":1435340910,"date_modified":1435340910,"content":"For the record, slightly off-topic.\nQubes Q3 RC1, Whonix 10.\n\n```\nDisableNetwork 0\nUseBridges 1\nClientTransportPlugin obfs2,obfs3 exec /usr/bin/obfsproxy managed\nBridge obfs3 <ip> <fingerprint>\n```\nWithout any firewall modifications. Works for me.\n\nscramblesuit not yet tested by me.\n"},{"author":"Patrick","date_created":1439669549,"date_modified":1439669549,"content":"Related, there is another unrelated reason why obfsproxy might not work...\n\"Qubes-Whonix obfsproxy AppArmor issue\" -> T396\n"},{"author":"Patrick","date_created":1439818027,"date_modified":1439818027,"content":"Qubes Q3 RC1, Whonix 11.\nobfs4 works for me. Example config:\n```\nUseBridges 1\nClientTransportPlugin obfs4 exec /usr/bin/obfs4proxy managed\nBridge obfs4 141.201.27.48:420 gibberish cert=more-gibberish iat-mode=0\n```\nNow also documented here:\nhttps://www.whonix.org/wiki/Bridges#Using_obfuscated.2C_.28private.29_and.2For_ordinary_bridges\n"},{"author":"Patrick","date_created":1439820909,"date_modified":1439820909,"content":"(No firewall rule changes required.)\n\n-----\n\n> Before it's asked:\n> ...\n\nThis was a good list by the way. A perhaps missing item:\n\n* Try getting Tor / pluggable transport to work with Tor from deb.torproject.org on a Debian template.\n\n-----\n\nSince this works for me with Qubes Q3 RC1, Whonix 11 [release announcement most likely follows today, already in the Qubes archive], I consider this fixed. Otherwise please reopen."}]},"PHID-TASK-ky5ejz3nnma2sc2xe4na":{"id":"321","title":"'insserv: script virtualbox-guest-utils.anondist-orig: service vboxguest already provided!' issue during apt-get install/upgrade","status":"resolved","priority":"Normal","author":"Patrick","description":"This is visible during package installation / upgrade.\n\n```\ninsserv: script virtualbox-guest-utils.anondist-orig: service vboxguest already provided!\ninsserv: script virtualbox-guest-utils.anondist-orig: service virtualbox-guest-utils already provided!\ninsserv: script virtualbox-guest-utils.anondist: service vboxguest already provided!\ninsserv: script virtualbox-guest-utils.anondist: service virtualbox-guest-utils already provided!\n```\n\nIt doesn't break anything, but is certainly a message that will cause confusion.\n\nHow to reproduce:\n\n```\nupdate-rc.d haveged defaults\n```\n\n(Works with any, haveged, tor, anything.)\n\nThis is problematic, because most packages postinst scripts include update-rc.d.\n\npackage:\nhttps://github.com/Whonix/vbox-disable-timesync\n\nDebug output:\n\n```\nuser@host:~$ ls -la /etc/init.d/virtualbox-guest-utils*\nlrwxrwxrwx 1 root root   31 May 20 16:19 /etc/init.d/virtualbox-guest-utils -> virtualbox-guest-utils.anondist\n-rwxr-xr-x 1 root root 2168 Aug 15  2013 /etc/init.d/virtualbox-guest-utils.anondist\n-rwxr-xr-x 1 root root 2146 Mar  4 09:34 /etc/init.d/virtualbox-guest-utils.anondist-orig\n```\n\nMaybe this can be solved by using config-package-dev's hide operation instead of the displace operation.","comments":[{"author":"Patrick","date_created":1432339768,"date_modified":1432339768,"content":"`fix 'insserv: script virtualbox-guest-utils.anondist-orig: service vboxguest already provided!' issue during apt-get install/upgrade - https://phabricator.whonix.org/T321`:\nhttps://github.com/Whonix/vbox-disable-timesync/commit/383bc1c1f5d7cf9186db36488e904bc4fac47f16\n\n`backwards compatibility fix`:\nhttps://github.com/Whonix/vbox-disable-timesync/commit/e688100a72090439312866f6f3df1a30e30de93d\n"},{"author":"Patrick","date_created":1432478016,"date_modified":1432478016,"content":"Fixed in Whonix `11.0.0.2.0-developers-only`."}]},"PHID-TASK-grkludemjpygy4kybumm":{"id":"320","title":"Tor fails after reload related to torrc DisableNetwork setting issue","status":"resolved","priority":"Normal","author":"Patrick","description":"whonixsetup or whonix-setup-wizard will run `sudo service tor reload`. That will exit `0`, but Tor will die. `sudo service tor status` will then show.\n\n```\n● tor.service - LSB: Starts The Onion Router daemon processes\n   Loaded: loaded (/etc/init.d/tor)\n   Active: active (exited) since Wed 2015-05-20 17:10:03 UTC; 10min ago\n  Process: 3468 ExecReload=/etc/init.d/tor reload (code=exited, status=0/SUCCESS)\n  Process: 688 ExecStart=/etc/init.d/tor start (code=exited, status=0/SUCCESS)\n```\n\n`/var/log/tor/log` contains an error message.\n\n```\nMay 20 17:34:56.000 [warn] Could not bind to 10.152.152.10:53: Permission denied\n```\n\nCould be an issue in Tor, jessie, anon-gw-anonymizer-config or systemd.\n\nCould be a related misunderstanding on how Tor's configs are supposed to be used:\nhttps://trac.torproject.org/projects/tor/ticket/15261\n\nHow to reproduce? (Warning: this following command wipes your whole /etc/tor/torrc.)\n\n```\nsudo su\necho \"DisableNetwork 1\" > /etc/tor/torrc\nsudo service tor restart\nsleep 2\necho \"DisableNetwork 0\" > /etc/tor/torrc\nsudo service tor reload\n```\n","comments":[{"author":"Patrick","date_created":1432345434,"date_modified":1432345434,"content":"Updated ticket description with instructions on how to reproduce this issue."},{"author":"Patrick","date_created":1432347364,"date_modified":1432347364,"content":"Reported a bug upstream.\n`Tor dies on reload when swichting to 'DisableNetwork 0' when using 'DnsPort 127.0.0.1:53'`:\nhttps://trac.torproject.org/projects/tor/ticket/16161"},{"author":"Patrick","date_created":1432349283,"date_modified":1432349283,"content":"Until upstream fixes that bug and until their fix landed in deb.torproject.org, which will take a while... Our options are:\n\n* a) abstain from using `reload` and always use `restart` or\n* b) check if the Tor pid is still running after reload and if it died, start it.\n"},{"author":"Patrick","date_created":1432390770,"date_modified":1432390770,"content":">>! In T320#4855, @Patrick wrote:\n> Reported a bug upstream.\n> `Tor dies on reload when swichting to 'DisableNetwork 0' when using 'DnsPort 127.0.0.1:53'`:\n> https://trac.torproject.org/projects/tor/ticket/16161\n\nIssue was confirmed.\n\n>>! In T320#4856, @Patrick wrote:\n> Until upstream fixes that bug and until their fix landed in deb.torproject.org, which will take a while... Our options are:\n> \n> * a) abstain from using `reload` and always use `restart` or\n> * b) check if the Tor pid is still running after reload and if it died, start it.\n\nJudging by https://trac.torproject.org/projects/tor/ticket/918 I think it might take quite some time until they fix this issue. Until then, I think for code simplicity we're better off forgetting about `reload` and just using `restart`."},{"author":"Patrick","date_created":1432390894,"date_modified":1432390894,"content":"Done in #whonixsetup,\n`fix 'Tor fails after reload related to torrc DisableNetwork setting issue' by only restarting Tor, no longer trying to reload Tor - https://phabricator.whonix.org/T320`\nhttps://github.com/Whonix/whonixsetup/commit/bc8cb713430a655eb3bb8dd3f8397babce1b6d3e\n"},{"author":"Patrick","date_created":1432392570,"date_modified":1432392570,"content":"`fix 'Tor fails after reload related to torrc DisableNetwork setting issue' by only restarting Tor, no longer trying to reload Tor - https://phabricator.whonix.org/T320`:\nhttps://github.com/Whonix/whonix-setup-wizard/commit/d5aacf5c58d5aad1c158e589b43d0dd5ccc9cc3f"},{"author":"troubadour","date_created":1432409653,"date_modified":1432409653,"content":"Tested `restart` instead of `start` `reload` before your post, working. Could not check if that solves the issue at first boot in Whonix Gateway, (tor active, exited) but I guess it does, because a manual `sudo service tor restart` works."},{"author":"Patrick","date_created":1432477805,"date_modified":1432477805,"content":"Fixed in Whonix `11.0.0.2.0-developers-only`."}]},"PHID-TASK-zbv7yk3l2dawnopb7mu7":{"id":"319","title":"packages should use 'pkg-config systemd' to determine systemd unit install destination path","status":"open","priority":"Low","author":"Patrick","description":"Currently systemd units for packages developed under the Whonix umbrella are located in `lib/systemd/system` (or `etc/systemd/system`). And installed by `make install` with the usual `DESTDIR` support. This works for Debian and perhaps Fedora based distributions, but is not 100% convention conform.\n\nAs per [daemon(7)](http://manpages.debian.org/cgi-bin/man.cgi?query=daemon&apropos=0&sektion=7&manpath=Debian+8+jessie&format=html&locale=en), section `Installing Systemd Service Files`, Quote:\n\n\"At the build installation time (e.g.  make install during package build), packages are recommended to install their systemd unit files in the directory returned by `pkg-config systemd --variable=systemdsystemunitdir` (for system services) or `pkg-config systemd --variable=systemduserunitdir` (for user services).\"\n\nTherefore, for better platform / porting support, we should\n\n* move those files to the package's root `pkg-name.service` (?),\n* genmkfile should `Depends:` on `pkg-config`,\n* [genmkfile](https://github.com/Whonix/genmkfile)'s function `make_install` ([function `make_helper`](https://github.com/Whonix/genmkfile/blob/bb964f582cd24cef14ee1c7d346ba1cd22894c1c/usr/share/genmkfile/make-helper.bsh#L812)) should use `pkg-config` to determine the systemd install destination path\n","comments":[]},"PHID-TASK-nmhxm5tkccl6uczvcyvz":{"id":"318","title":"search Tails issue tracker for jessie related issues and check if they apply to Whonix","status":"resolved","priority":"Normal","author":"Patrick","description":"https://labs.riseup.net/code/projects/tails/search?utf8=%E2%9C%93&q=jessie&scope=&all_words=&all_words=1&titles_only=&titles_only=1&issues=1&changesets=1&commit=Submit\n","comments":[{"author":"Patrick","date_created":1433354349,"date_modified":1433354349,"content":"Something useful came up.\n\n* T335\n* T336\n\nBut nothing that needs immediate attention."}]},"PHID-TASK-qkhtwfi6vifijmvxjh6y":{"id":"317","title":"disable torsocks warning spam","status":"resolved","priority":"Normal","author":"Patrick","description":"We make heavy use of torsocks in Whonix. For example, apt-get is run through torsocks for better stream isolation.\n\nThis generated loads of, hundreds of these kinds of messages.\n\n```\n[May 20 11:45:27] WARNING torsocks[2645]: [syscall] Unsupported syscall number 224. Denying the call (in tsocks_syscall() at syscall.c:165)\n```\n\nAs per David Goulet's (torsocks maintainer) [answer](https://www.whonix.org/pipermail/whonix-devel/2015-May/000360.html), we can disable them. Fortunately.\n\n```\nexport TORSOCKS_LOG_LEVEL=1\n```\n\nDo we want to set `TORSOCKS_LOG_LEVEL=1` by,\n- a) #uwt for all invocations of uwt -> torsocks -> apt-get, gpg, etc. or\n- b) #uwt globally for the whole system or\n- c) #whonix-base-files globally for the whole system or\n- d) #anon-base-files globally for the whole system or\n- e) elsewhere or\n- f) something else?\n\nDisabling these messages globally is not the greatest solution, but would certainly save lots of bug reports we can do nothing about anyhow.","comments":[{"author":"Patrick","date_created":1432345090,"date_modified":1432345090,"content":"`disable torsocks warning spam - https://phabricator.whonix.org/T317`:\nhttps://github.com/Whonix/uwt/commit/68b44f34929ab992072342a07b278d8827bc088a"},{"author":"Patrick","date_created":1432487487,"date_modified":1432487487,"content":"Warning spam still happens, because environment variable is not kept when using `sudo`.\n\n```\nsudo apt-get install --reinstall udev\n```\n\nDoes not contain warning spam, since keeping environment (`-E`). Very few users do that.\n\n```\nsudo -E apt-get install --reinstall udev\n```\n"},{"author":"Patrick","date_created":1432487814,"date_modified":1432487814,"content":"Solution:\n\n`/etc/sudoers.d/uwt`\n\n```\nDefaults:ALL env_keep += \"TORSOCKS_LOG_LEVEL\"\n```\n"},{"author":"Patrick","date_created":1432655926,"date_modified":1432655926,"content":"`disable torsocks warning spam, also set 'export TORSOCKS_LOG_LEVEL=1' in /usr/bin/uwt - https://phabricator.whonix.org/T317`:\nhttps://github.com/Whonix/uwt/commit/f48aca83973bead089c97d720ac7b9c37a6b6348\n\n`disable torsocks warning spam, set 'Defaults:ALL env_keep += \"TORSOCKS_LOG_LEVEL\"' in '/etc/sudoers.d/uwt' - https://phabricator.whonix.org/T317`:\nhttps://github.com/Whonix/uwt/commit/60af762a7bb30ac40339aa05c438bc9fd3c6c754\n"},{"author":"Patrick","date_created":1433605136,"date_modified":1433605136,"content":"Fixed in Whonix `10.0.0.2.3`."}]},"PHID-TASK-6zv2q2xnygpgxqt2izje":{"id":"316","title":"systemd units are not enabled by default","status":"resolved","priority":"Normal","author":"Patrick","description":"systemd unit files are working, but msgcollector, sdwdate and whonixcheck are not enabled by default yet.\n\nSeems like making packages systemd-only is non-standard and causing this issue.\n\n```\n* Now talking on #debian-systemd\n* Topic for #debian-systemd is: user tagged bugs: http://deb.li/335K7 | wiki: http://wiki.debian.org/systemd | http://people.debian.org/~stapelberg/dashboard/ | please contribute: https://etherpad.fr/p/systemd-best-practices | SysV compat and upgrade issues: https://debian.titanpad.com/23\n* Topic for #debian-systemd set by mbiebl!~quassel@g231076196.adsl.alicedsl.de at Fri Oct 24 14:54:44 2014\n<adrelanos> hi! do you know any example packages, that are systemd only, that do not ship a sysvinit script?\n<mbiebl> adrelanos: there are packages, which systemd units but no sysv init script\n<yrro> systemd-cron perhaps?\n<mbiebl> upower is such an example\n<mbiebl> but those are started via different means under sysvinit\n<mbiebl> i.e. directly by dbus-daemon\n<mbiebl> other then that, I'm not aware of any package which does not support to be run under sysvinit\n<adrelanos> okay\n<mbiebl> adrelanos: why do you ask?\n<adrelanos> trying to port a package to systemd. the original plan was making it systemd-only, not maintaining the sysvinit script anymore.\n<adrelanos> but it seems we're trying something very unusual and should rethink this\n<yrro> is there something unusual about the service? e.g., a sysvinit script that tries to manage multiple instances or something?\n<yrro> i've bashed my head against too many of those for one lifetime... :)\n<adrelanos> no, just a lintian warning and too little time\n<mbiebl> adrelanos: keep in mind, that existing packages do typically have sysvinit scripts\n<adrelanos> fear of conflicts sysinit script vs systemd also\n<adrelanos> yes\n<mbiebl> for new packages, it's indeed going to be interesting, who is going to maintain them\n<mbiebl> i.e., rely on bug reporters / sysvinit supporters to provide them\n<mbiebl> similar to how ports are handled (in theory)\n<mbiebl> atm I would provide a sysvinit script along with the systemd unit \n<mbiebl> if you name them the same, systemd will pick the native unit file\n<adrelanos> alright. will do.\n<mbiebl> so there shouldn't be any conflict\n<fsateler> adrelanos: see man 5 init-d-script , it should simplify maintainance of simple sysv services\n<yrro> as long as it's a native executable ;)\n<adrelanos> interesting\n<adrelanos> as upstream, is it good to have 'make install' install /etc/init.d/pkg and /lib/systemd/system/pkg.service?\n<algernon> second: yes, first: only if it doesn't exist (no overwrite)\n<mbiebl> adrelanos: it's hard, shipping a sysv init script which works decently everywhere\n<mbiebl> so I probably wouldn't bother\n<mbiebl> shipping a native systemd unit is actually something systemd upstream pushes for\n<mbiebl> adrelanos: please see also \"man 7 daemon\"\n<mbiebl> section \" Installing Systemd Service Files\"\n<ansgar> adrelanos: You should use the pkg-config path to install stuff upstream. Not everyone uses /lib/systemd/system ;)\n```\n","comments":[{"author":"troubadour","date_created":1432060622,"date_modified":1432060622,"content":"For information, tried it out of curiosity some time ago. control-port -filter-python is working with systemd only (control-port-filter-python removed from `/etc/init.d`)."},{"author":"Patrick","date_created":1432077104,"date_modified":1432077104,"content":"Good point! That will help. I'll be comparing those packages. Preferably we can keep packages systemd-only."},{"author":"Patrick","date_created":1432130980,"date_modified":1432130980,"content":"Created a minimal package to reproduce this issue on a plain Debian jessie system:\nhttps://github.com/adrelanos/hellodaemon\n"},{"author":"Patrick","date_created":1432132364,"date_modified":1432132364,"content":"Asked on debian systemd mailing list.\n`systemd unit functional, but not enabled by default issue`:\nhttps://lists.alioth.debian.org/pipermail/pkg-systemd-maintainers/2015-May/007271.html\n"},{"author":"Patrick","date_created":1432135900,"date_modified":1432135900,"content":"Looks like a bug in `deb-systemd-helper`.\n\nThe spaces in \n\n```\nWantedBy = multi-user.target\n```\n\nare unsupported by `deb-systemd-helper`. It needs to be strictly without spaces.\n\n```\nWantedBy=multi-user.target\n```\n"},{"author":"Patrick","date_created":1432137576,"date_modified":1432137576,"content":"`systemd unit: workaround/fix, removed spaces from 'WantedBy = ', likely bug in 'deb-systemd-helper' that prevents enabling the service by default - https://phabricator.whonix.org/T316`\n`systemd unit: workaround/fix, removed spaces, likely bug in 'deb-systemd-helper' that prevents enabling the service by default - https://phabricator.whonix.org/T316`\n- https://github.com/Whonix/bootclockrandomization/commit/0a15a20467e1ef33307435fa2a7b415f940955d9\n- https://github.com/Whonix/bootclockrandomization/commit/faa7fa520679f1beb3401d4dbceb288c57e84660\n- https://github.com/Whonix/msgcollector/commit/4503b5e9f92a0af8e473f2ff5dbc8a0001c0de92\n- https://github.com/Whonix/msgcollector/commit/6640b8f8816df633af8d339769127d4912cf6ba4\n- https://github.com/Whonix/sdwdate/commit/fb1480d8ee7ba130579555f43944608b4fea2f34\n- https://github.com/Whonix/swap-file-creator/commit/f3187350233c4c87ab1bddc7db2734d97efee237\n- https://github.com/Whonix/timesanitycheck/commit/f9d8ceec88b87ba648d5231504dfaf145e8c7bf6\n- https://github.com/Whonix/whonixcheck/commit/2a72ec4348ab1ba4ac718d4e4be25b105292dc7c\n- https://github.com/Whonix/timesync/commit/0f344ca1363682aa75a23c1bc2732732f331bd10\n\n`deprecated sysvinit script again - https://phabricator.whonix.org/T316`\n- https://github.com/Whonix/sdwdate/commit/3d445b7c75f696997f9f1730b94eab4abfa4dfb6\n\n`debian/sdwdate.service -> lib/systemd/system/sdwdate.service - https://phabricator.whonix.org/T316`:\nhttps://github.com/Whonix/sdwdate/commit/9c04753b62353049c8cc6a172509c04eb3cfcc98\n"},{"author":"Patrick","date_created":1432137772,"date_modified":1432137772,"content":"For reference, this is what I used for debugging.\n\n```\nsudo DPKG_MAINTSCRIPT_PACKAGE=hellodaemon _DEB_SYSTEMD_HELPER_DEBUG=1  perl -d:Trace /usr/bin/deb-systemd-helper enable hellodaemon.service > a 2>&1\n```\n\n```\nsudo DPKG_MAINTSCRIPT_PACKAGE=control-port-filter-python _DEB_SYSTEMD_HELPER_DEBUG=1 perl -d:Trace /usr/bin/deb-systemd-helper enable control-port-filter-python.service > b 2>&1\n```\n\nThen compared the difff."},{"author":"Patrick","date_created":1432137805,"date_modified":1432137805,"content":"All these changes are available in `11.0.0.1.8-developers-only`. Now testing a build."},{"author":"Patrick","date_created":1432141164,"date_modified":1432141164,"content":"pull request against @nrgaway/qubes-whonix,\n`systemd unit file remove spaces fix/workaround`:\nhttps://github.com/nrgaway/qubes-whonix/pull/3"},{"author":"Patrick","date_created":1432143466,"date_modified":1432143466,"content":"This is fixed in `11.0.0.1.8-developers-only`."},{"author":"nrgaway","date_created":1432158703,"date_modified":1432159038,"content":">>! In T316#4749, @Patrick wrote:\n> pull request against @nrgaway/qubes-whonix,\n> `systemd unit file remove spaces fix/workaround`:\n> https://github.com/nrgaway/qubes-whonix/pull/3\n\nMerged\n[[ https://github.com/nrgaway/qubes-whonix/pull/3 | https://github.com/nrgaway/qubes-whonix/pull/3 ]]"},{"author":"nrgaway","date_created":1432159080,"date_modified":1432159080,"content":"That's a nasty upstream bug for `deb-systemd-helper`. You would have thought that would have been fixed for Jessie stable release. Do you know if there is a reported issue on it upstream?"},{"author":"Patrick","date_created":1432160692,"date_modified":1432160692,"content":">>! In T316#4773, @nrgaway wrote:\n> That's a nasty upstream bug for `deb-systemd-helper`. You would have thought that would have been fixed for Jessie stable release.\n\nYeah. You bet. This one has cost me quite some time. But it was really worth it. Now we can do a standard conform, robust, non-error-prone, stable implementation. (No need to manually call systemd enable, which would lead to all sorts of issues [ignoring state files while reinstallation and whatnot].)\n\n> Do you know if there is a reported issue on it upstream?\n\nPerhaps TODO? No upstream bug report yet. After reading https://lists.alioth.debian.org/pipermail/pkg-systemd-maintainers/2015-May/007273.html I don't think that's worth it. What do you think? A lintian check could be suggested, though."},{"author":"nrgaway","date_created":1432163164,"date_modified":1432163164,"content":"I guess just not using spaces would be the way to go.  I used to not use spaces, but then added them as it seems like that should be supported and works with systemd, just not the `deb-systemd-helper`\n\nThe man pages don't say you can or can not use extra spaces, but extra spaces do work.  The issue here was, as indicated, a bug in `deb-systemd-helper` in which spaces are not supported even though spaces work in systemd unit files. Systemd developers should comment on this and provide clear policy in regards to spaces.\n\nTherefore I suggest this issue be raised on systemd forums or bug tracker for their developer to comment on (not users, need a policy here) and depending on that outcome submit bug report to `deb-systemd-helper`.\n\nAlthough it still may be worthwhile submitting the bug report for `deb-systemd-helper` now as well for the benefit of some other developer down the road having same issue."},{"author":"Patrick","date_created":1432213826,"date_modified":1432213826,"content":"Judging by the system man pages that do not use spaces and info from a systemd contributor on systemd IRC, no spaces should be used."},{"author":"Patrick","date_created":1432214996,"date_modified":1432214996,"content":"bug report,\n`deb-systemd-helper fails to enable systemd units when using 'WantedBy = ' with spaces`:\nhttp://bugs.debian.org/cgi-bin/bugreport.cgi?bug=786418\n\nlintian feature request,\n`warn against usage of spaces, i.e. 'Type = notify' in systemd unit files`:\nhttp://bugs.debian.org/cgi-bin/bugreport.cgi?bug=786421"}]},"PHID-TASK-qdykljzymmyyf4yojgjg":{"id":"315","title":"disable rads, whonix-initializer and swap-file-creator systemd unit files in qubes-whonix","status":"resolved","priority":"Normal","author":"Patrick","description":"As a follow up ticket of T106 and T312...\n\nrads, whonix-initializer and swap-file-creator systemd unit files should be disabled in the qubes-whonix package.\n\n```\n[Unit]\nConditionPathExists = !/usr/lib/qubes-whonix\n```\n\nThat's [done](https://github.com/nrgaway/qubes-whonix/pull/2) for rads already. Are whonix-initializer and swap-file-creator are remaining TODO.\n\nI (Patrick) don't mind if @nrgaway does this or if I provide another pull request.","comments":[{"author":"nrgaway","date_created":1431981488,"date_modified":1431981488,"content":"Those are already disabled.  As well, I have already created a systemd rule for `whonix-initializer` and just created one for `swap-file-creator`.  As stated I have the `rads` one already from your PR\n\n disableSystemdUnits \\\n            qubes-whonix-network \\\n            qubes-whonix-firewall \\\n            sdwdate \\\n            whonixcheck \\\n            network-manager \\\n            spice-vdagent \\\n            swap-file-creator \\\n            whonix-initializer \\\n            tor\n"},{"author":"Patrick","date_created":1431984151,"date_modified":1431984151,"content":"It's a hackish solution. We can get rid of the whole non-standard disableSystemdUnits hopefully."},{"author":"Patrick","date_created":1432142942,"date_modified":1432142942,"content":"Quoting myself.\n\n>>! In T316#4749, @Patrick wrote:\n> pull request against @nrgaway/qubes-whonix,\n> `systemd unit file remove spaces fix/workaround`:\n> https://github.com/nrgaway/qubes-whonix/pull/3\n\nThat should also help to abolish that hack."},{"author":"Patrick","date_created":1432659432,"date_modified":1432659432,"content":"pull request...\n`clean mechanism to skip starting services network-manager, spice-vdagent, swap-file-creator and whonix-initializer in Qubes using /etc/systemd/system/unit.service.d directory - https://phabricator.whonix.org/T315`:\nhttps://github.com/nrgaway/qubes-whonix/pull/5\n\nPlease review and merge. @nrgaway\n\nFew more comments:\n\n* Not starting `spice-vdagent` might not work, because that package still comes with a sysvinit script from Debian. But nevermind. `spice-vdagent` only gets installed when using the build script with `--target qcow2`. So deactivating/overwriting it is not really necessary anymore.\n* This pull request is independent. Shouldn't cause a lot issues.\n* However, this pull request should also allow for a follow up task. Abolishing all manual interaction with systemd, i.e. abolishing `disableSystemdUnits`, `enableSystemdUnits` and `systemctl restart`. Needs quite some testing, I guess? @nrgaway Or anything more required still to be able to abolish these hacks? Can be done for Whonix 11 or Whonix 12. ([Whonix 11](https://phabricator.whonix.org/maniphest/query/FAHipiL19o_a/#R) task list is getting smaller.)"},{"author":"nrgaway","date_created":1432677588,"date_modified":1432677588,"content":"I don't consider enable SystemdUnit hacks if there are no other deb-installer solutions to ensure a proper state.\n\nThe rules can be removed for `spice-vdagent`, `whonix-initalizer` and `swap-file-creator` since you added systemd overrides.\n\nI commented on your PR [[ https://github.com/nrgaway/qubes-whonix/pull/5 | https://github.com/nrgaway/qubes-whonix/pull/5 ]]; needs a few small tweaks before merge.\n"},{"author":"Patrick","date_created":1432733745,"date_modified":1432733745,"content":"Done.\n\n>>! In T315#4975, @nrgaway wrote:\n> I don't consider enable SystemdUnit hacks if there are no other deb-installer solutions to ensure a proper state.\n\nWhat's the problem that needs to be solved?\n\n* a rush to make Whonix work with systemd (T273), ...\n* the systemd unti file spaces issue that lead to services not being enabled by default T316\n* the Tor reload on first boot issue T320\n\nAll bugs in Whonix core that are now solved."}]},"PHID-TASK-fvfmye3n6dawxamtxqzs":{"id":"314","title":"solve apparmor-profile-pidgin vs apparmor-profiles conflict","status":"resolved","priority":"Normal","author":"Patrick","description":"~~user@host:~$ sudo apt-get install apparmor-profiles apparmor-profile-pidgin\nReading package lists... Done\nBuilding dependency tree       \nReading state information... Done\napparmor-profiles is already the newest version.\nThe following NEW packages will be installed:\napparmor-profile-pidgin\n0 upgraded, 1 newly installed, 0 to remove and 26 not upgraded.\n10 not fully installed or removed.\nNeed to get 0 B/7,272 B of archives.\nAfter this operation, 42.0 kB of additional disk space will be used.\nDo you want to continue? [Y/n] \n(Reading database ... 87205 files and directories currently installed.)\nPreparing to unpack .../apparmor-profile-pidgin_3%3a1.2-1_all.deb ...\nUnpacking apparmor-profile-pidgin (3:1.2-1) ...\ndpkg: error processing archive /var/cache/apt/archives/apparmor-profile-pidgin_3%3a1.2-1_all.deb (--unpack):\n trying to overwrite '/etc/apparmor.d/usr.bin.pidgin', which is also in package apparmor-profiles-extra 1.4\nErrors were encountered while processing:\n /var/cache/apt/archives/apparmor-profile-pidgin_3%3a1.2-1_all.deb\nE: Sub-process /usr/bin/dpkg returned an error code (1)~~\n\n~~Both, apparmor-profiles-extra and apparmor-profile-pidgin ship the pidgin profile. That conflicts.~~\n\n~~Especially problematic, because apparmor-profiles-whonix depends on apparmor-profile-pidgin.~~\n\n~~Is the pidgin profile from apparmor-profiles-extra okay? Do we recommend to install it?~~\n\n~~What do we do with the apparmor-profile-pidgin package? Deprecate it? Or solve that conflict by using config-package-dev displace (I can add this if useful)?~~ ([fixed](https://phabricator.whonix.org/T314#4947))\n\n-----\n\n>>! In T314#5003, @troubadour wrote:\n> There is an issue with some profiles form `apparmor-profiles` and `apparmor-profiles-extra`. They are not loaded because of `conflicting x modifiers`. The problem does not show in the host. Looking onto it.\n","comments":[{"author":"troubadour","date_created":1431979336,"date_modified":1431979391,"content":"The pidgin profile from apparmor-profiles-extra is not okay in Whonix. See\nhttps://www.whonix.org/forum/index.php/topic,97.msg6432.html#msg6432\n\nOn top of the kde messages, they include some Ubuntu abstractions that create some parsing errors in Whonix, preventing the profile to load.\nhttps://www.whonix.org/forum/index.php/topic,97.msg6343.html#msg6343\n\nRetested the profile from apparmor-profiles-extra in Whonix 11, same issues, \n\nThere was another issue, when after an update, a bunch of denied messages popped, and we replaced the adapted Debian profile with the original from Whonix.\nhttps://www.whonix.org/forum/index.php/topic,97.msg7707.html#msg7707\n\nRetested the adapted Debian profile in Whonix 11, okay except for one new kde message that shows in the host too. Not big problem. This is the one you merged in https://github.com/troubadoour/apparmor-profile-pidgin/commit/0b33fe34ef453f620e932d35eab1b2cb6937df6b\n\nIf we want to install  apparmor-profiles-extra, we should probably use your magic (config-package-dev displace to replace the original profile with our modified one)."},{"author":"Patrick","date_created":1432130158,"date_modified":1432130158,"content":"Will do."},{"author":"Patrick","date_created":1432344138,"date_modified":1432344138,"content":"`solve apparmor-profile-pidgin package conflict with apparmor-profiles-extra by 'config-package-dev displace'ing /etc/apparmor.d/usr.bin.pidgin - https://phabricator.whonix.org/T314`:\nhttps://github.com/Whonix/apparmor-profile-pidgin/commit/aaa16a16de160cc8ef859d943d150ab1df080d68\n"},{"author":"Patrick","date_created":1432480567,"date_modified":1432480567,"content":"Fixed in Whonix `11.0.0.2.0-developers-only`.\n\nRunning `sudo apt-get install apparmor-profiles-whonxi apparmor-profiles apparmor-profiles-extra` succeeded. (Currently from `developers` repository that was upgraded as per `11.0.0.2.0-developers-only`.)"},{"author":"troubadour","date_created":1432760345,"date_modified":1432760345,"content":"Updated apparmor-profile-pidgin.\n\nBecause it's working in jessie, `usr.bin.pidgin.anondist` is reverted to the Debian profile. There is an addition, a denied message for `/usr/share/aspell`.\n https://github.com/troubadoour/apparmor-profile-pidgin/commit/7dde08febaa2fe8310c2eb3e377a248d6783b54c\n\nThere is an issue with some profiles form `apparmor-profiles` and `apparmor-profiles-extra`. They are not loaded because of `conflicting x modifiers`. The problem does not show in the host. Looking onto it."},{"author":"Patrick","date_created":1432766185,"date_modified":1432766185,"content":"Merged. And added to repository."},{"author":"Patrick","date_created":1433338645,"date_modified":1433338645,"content":"```\nsudo aa-enforce /etc/apparmor.d/usr.bin.chromium-browser\n```\n\n```\nSetting /etc/apparmor.d/usr.bin.chromium-browser to enforce mode.\nTraceback (most recent call last):\n  File \"/usr/sbin/aa-enforce\", line 30, in <module>\n    tool.cmd_enforce()\n  File \"/usr/lib/python3/dist-packages/apparmor/tools.py\", line 166, in cmd_enforce\n    raise apparmor.AppArmorException(cmd_info[1])\napparmor.common.AppArmorException: 'profile has merged rule with conflicting x modifiers\\nERROR processing regexs for profile sanitized_helper, failed to load\\n'\nSetting /etc/apparmor.d/usr.bin.evince to enforce mode.\nTraceback (most recent call last):\n  File \"/usr/sbin/aa-enforce\", line 30, in <module>\n    tool.cmd_enforce()\n  File \"/usr/lib/python3/dist-packages/apparmor/tools.py\", line 166, in cmd_enforce\n    raise apparmor.AppArmorException(cmd_info[1])\napparmor.common.AppArmorException: 'profile has merged rule with conflicting x modifiers\\nERROR processing regexs for profile sanitized_helper, failed to load\\n'\n```\n\nThe issue must be somewhere within these lines:\nhttps://github.com/Whonix/apparmor-profile-anondist/blob/814ec01c4189ea0e897ba066ee3f914aa530f2ae/etc/apparmor.d/abstractions/base.anondist#L118-152\n\n(Because when commenting those out, the profile can be loaded.)"},{"author":"troubadour","date_created":1433795890,"date_modified":1433817338,"content":"I missed that post. Thanks for the finding.\n\nAnother one. config-package-dev displace installs the .orig file in /etc/apparmor.d. So after installing apparmor-profiles-extra, the original Pidgin profile is parsed by AppArmor, and we end up with the same situation. "},{"author":"Patrick","date_created":1433847577,"date_modified":1433847577,"content":"What error do you get? The install error?\n\n```\nUnpacking apparmor-profiles-extra (1.4) ...\ndpkg: error processing archive /var/cache/apt/archives/apparmor-profiles-extra_1.4_all.deb (--unpack):\n trying to overwrite '/etc/apparmor.d/usr.bin.pidgin', which is also in package apparmor-profile-pidgin 3:1.2-1\nErrors were encountered while processing:\n /var/cache/apt/archives/apparmor-profiles-extra_1.4_all.deb\nE: Sub-process /usr/bin/dpkg returned an error code (1)\n```\n\nThat's maybe because apparmor-profile pidgin isn't updated in the Whonix `jessie` / `developers` repository. Still working on that (T342, T325).\n\nOtherwise if somehow the .orig file is parsed, maybe instead of config-package-dev displace, I should have used config-package-dev hide. Then that file is moved out of the way.\n\n-----\n\nActually a different issue:\nhttps://phabricator.whonix.org/T314#5122\n\nI think this happens because /etc/apparmor.d/usr.bin.chromium-browser tries to grant rights to files located in /usr/share/ somewhere, while apparmor-profile-anondist /etc/apparmor.d/abstractions/base.anondist granted different rights."},{"author":"troubadour","date_created":1433881883,"date_modified":1433881883,"content":"It was not the install error, but the original file was parsed, provoking the `conflicting x modifiers` error.\n\nThe problem, along with the offending profiles (chromium-browser, evince) is solved in https://github.com/troubadoour/apparmor-profile-anondist/commit/fbf9542507b998751a4f727d7f90307c47ed831a\n\nFor executables, we have to give permissions to files individually, wildcards are not allowed, apparently. What is strange is that the Whonix profiles do not complain. Anyhow, I have been on and off on this for quite some time, and did not look at the obvious: base.anondist.\n\nWe can either remove the file displacement, or better I think, remove the Pidgin profile completely from Whonix, and users can install the one from apparmor-profiles-extra. They are similar, I was just removing some Ubuntu abstractions."},{"author":"Patrick","date_created":1433882673,"date_modified":1433882673,"content":">>! In T314#5374, @troubadour wrote:\n> It was not the install error, but the original file was parsed, provoking the `conflicting x modifiers` error.\n\nI see. So I suppose if one deleted the .orig file, the issue would be gone?\n\n> The problem, along with the offending profiles (chromium-browser, evince) is solved in https://github.com/troubadoour/apparmor-profile-anondist/commit/fbf9542507b998751a4f727d7f90307c47ed831a\n\nNice! Merged!\n\n> We can either remove the file displacement, or better I think, remove the Pidgin profile completely from Whonix, and users can install the one from apparmor-profiles-extra. They are similar, I was just removing some Ubuntu abstractions.\n\nYeah. If the upstream profile works with Whonix, by all means, let's remove it.\n\nIf you want, I'll empty the package. Remove the apparmor profile and add a config-package-dev `undisplace` to restore original state. (And keep the empty package, perhaps it will be reintroduced in not so far future.)"},{"author":"troubadour","date_created":1434050984,"date_modified":1434050984,"content":"The upstream profile works with Whonix, and it's probably safer to keep the empty package."},{"author":"Patrick","date_created":1434344415,"date_modified":1434344415,"content":"Clearing config-package-dev is non-trival. Postponing this to #Whonix_12."},{"author":"Patrick","date_created":1453409329,"date_modified":1453409329,"content":"https://github.com/Whonix/apparmor-profile-pidgin/commit/af69e1447de8120e416c1d8af5dfa9944041c23d\n\nTODO testing:\n\n1) install old packages on test system\n\nsudo apt-get install apparmor-profile-pidgin apparmor-profiles apparmor-profiles-extra\n\n2) upgrade with newer package version\n\n3) Check if only /etc/apparmor.d/usr.bin.pidgin is the only file that exists\n\nls -la /etc/apparmor.d/usr.bin.pidgin*\n"},{"author":"Patrick","date_created":1461808523,"date_modified":1461808523,"content":"```\nls -la /etc/apparmor.d/usr.bin.pidgin*\n```\n```\n-rw-r--r-- 1 root root 2155 Oct 19  2014 /etc/apparmor.d/usr.bin.pidgin.dpkg-new\n```\n\nRequires manual reinstallation of `apparmor-profiles-extra`.\n```\nsudo apt-get install --reinstall apparmor-profiles-extra\n```\n"}]},"PHID-TASK-gupv7l3rovgledra24ib":{"id":"313","title":"apparmor issues Whonix 11 / jessie","status":"resolved","priority":"Normal","author":"Patrick","description":"(As per https://www.whonix.org/forum/index.php/topic,97.msg8190.html#msg8190.)\n\nThis ticket is a reminder to check `sudo apt-get install apparmor-profiles-whonix` and to fix any eventual issues before the release of Whonix 11.","comments":[{"author":"Patrick","date_created":1432649477,"date_modified":1432649477,"content":"```\nuser@host:~$ sudo aa-enforce /etc/apparmor.d/usr.bin.timesync \nTraceback (most recent call last):\n  File \"/usr/sbin/aa-enforce\", line 30, in <module>\n    tool.cmd_enforce()\n  File \"/usr/lib/python3/dist-packages/apparmor/tools.py\", line 153, in cmd_enforce\n    apparmor.read_profiles()\n  File \"/usr/lib/python3/dist-packages/apparmor/aa.py\", line 2572, in read_profiles\n    read_profile(profile_dir + '/' + file, True)\n  File \"/usr/lib/python3/dist-packages/apparmor/aa.py\", line 2598, in read_profile\n    profile_data = parse_profile_data(data, file, 0)\n  File \"/usr/lib/python3/dist-packages/apparmor/aa.py\", line 2922, in parse_profile_data\n    raise AppArmorException(_('Invalid mode %(mode)s in file: %(file)s line: %(line)s') % {'mode': mode, 'file': file, 'line': lineno + 1 })\napparmor.common.AppArmorException: 'Invalid mode mrcux in file: /etc/apparmor.d/usr.lib.virtualbox.VirtualBox line: 49'\n```\n\nProblematic line in `/etc/apparmor.d/usr.lib.virtualbox.VirtualBox`.\n\n```\n/usr/lib/virtualbox/** mrcux,\n```\n"},{"author":"Patrick","date_created":1433338274,"date_modified":1433338274,"content":"Somehow I don't get `cux` to work. Using `/usr/lib/virtualbox/** mrux,` now. Non-ideal, but it at least fixes the [bigger issue](https://phabricator.whonix.org/T313#4957).\n\n`fix - https://phabricator.whonix.org/T313`:\nhttps://github.com/Whonix/apparmor-profile-virtualbox/commit/d5b72fab6414be8649fa238ef24387bb77442b07\n\nI leave the final fix to @troubadour."},{"author":"troubadour","date_created":1434051766,"date_modified":1434051766,"content":"Had the same issue. The `mrux` or `mrix` permissions fix the parsing issue, but I'll have to check if that works in the host. I have not used the VirtualBox profile for a long time, and I'm not sure it's working as is in jessie. Not sure either if we should keep this profile in Whonix.\n\nFor the time being, we could close this task, and I'll put the VirtualBox profile check in the todo llist."},{"author":"Patrick","date_created":1434054068,"date_modified":1434054068,"content":"Alright."}]},"PHID-TASK-vjb3kpm5uwrbdcagipsu":{"id":"312","title":"/etc/systemd/system/unit.service.d vs /lib/systemd/system/unit.service.d","status":"resolved","priority":"Normal","author":"Patrick","description":"What's the correct location as package upstream when extending systemd unit files? `/etc/systemd/system/unit.service.d` or `/lib/systemd/system/unit.service.d`?\n\nI might have made a mistake in T306 ([pull](https://github.com/nrgaway/qubes-whonix/pull/2)).\n\nFiguring this out is important, so I can submit a fixed pull request and also because I plan to use similar overrides.\n\nFor example, [timesync](https://github.com/Whonix/timesync) should extend the systemd unit file `sdwdate.service` by `[Unit]` (newline) `Requires = msgcollector.service`.\n\nAnd another example, analogous to T306, `swap-file-creator.service` should be extended by `[Unit]` (newline) `ConditionPathExists = !/usr/lib/qubes-whonix`.\n\nExample...\n\n-----\n\na)\n\n/etc/systemd/system/rads.service.d/40_qubes.conf\n\n```\nsudo systemd-delta\n```\n```\n[EXTENDED]   /lib/systemd/system/rads.service → /etc/systemd/system/rads.service.d/40_qubes.conf\n```\n\n-----\n\nb)\n\n/lib/systemd/system/rads.service.d/40_qubes.conf\n\n```\nsudo systemd-delta\n```\n\n```\n[EXTENDED]   /lib/systemd/system/rads.service → /lib/systemd/system/rads.service.d/40_qubes.conf\n```\n","comments":[{"author":"nrgaway","date_created":1431882278,"date_modified":1431882278,"content":"My understanding is distribution package file go in `/lib/systemd/system`.  \n\nAdministrator or local files go in `/etc/systemd/system`\n\nUsers can further extend within home directory\n\nIf you are simply extending a unit file; adding some extra condition, modifying its behaviour, over-riding the normal behaviour (adding an alias) to that what is published by upstream, the configuration files would go in `/etc/systemd/system`. \n\nYour example of `timesync` above is not extending `msgcollector` or over-riding the behaviour of `msgcollector` in any way and only is requiring `msgcollector` to be available in order to start and therefore would be placed in `/lib/systemd/system`.  The required statement should also be in the main `timesync` systemd unit file, not in a `.d` directory since it is required in all use cases\n\nIn the example of qubes needing an override, and since that would be local specific, the configuration override would go in `/etc/systemd/system`. \n\nAnything that is putting a condition on `ConditionPathExists = !/usr/lib/qubes-whonix`, should not be included in upstream package at all, and `qubes-whonix` should be responsible to add the condition in `/etc/systemd/system` so I would need to know which files I should be doing this for.  So far I it has `rads` and `whonix-initializer`"},{"author":"Patrick","date_created":1431948666,"date_modified":1431948666,"content":"\n> Your example of `timesync` above is not extending `msgcollector` or over-riding the behaviour of `msgcollector` in any way\n\nYes, and that's okay.\n\n> and only is requiring `msgcollector` to be available in order to start and therefore would be placed in `/lib/systemd/system`.\n\nThe intention is \"if timesync is installed [which is an sdwdate gui plugin], then sdwdate.service requires msgcollector.service be running\". I guess that's working.\n\n> The required statement should also be in the main `timesync` systemd unit file, not in a `.d` directory since it is required in all use cases\n\ntimesync is not a daemon, doesn't have a systemd unit file.\n\n> In the example of qubes needing an override, and since that would be local specific, the configuration override would go in `/etc/systemd/system`. \n\nYes. That way also advanced users who want to undo that setting can do that more easily by deleting the file from /etc.\n \n> Anything that is putting a condition on `ConditionPathExists = !/usr/lib/qubes-whonix`, should not be included in upstream package at all, and `qubes-whonix` should be responsible to add the condition in `/etc/systemd/system` so I would need to know which files I should be doing this for.  So far I it has `rads` and `whonix-initializer`\n\nYes. By your previous choice (initial implementation of qubes-whonix), I think that is rads, whonix-initializer and swap-file-creator.\n"},{"author":"Patrick","date_created":1431948770,"date_modified":1431948770,"content":"Thanks, the answer is clear to me now."}]},"PHID-TASK-g66u4syjq4hg5u43ec7n":{"id":"311","title":"systemd 'Restart=' and sd_notify for sdwdate and whonixcheck","status":"resolved","priority":"Normal","author":"Patrick","description":"Let's use `Restart=`?\n\nLet's use sd_notify?\n\nhttp://www.freedesktop.org/software/systemd/man/systemd-notify.html\nsd_notify for shell scripts?\n\nSee also:\nhttps://superuser.com/questions/689017/can-systemd-detect-and-kill-hung-processes\n","comments":[{"author":"HulaHoop","date_created":1431782825,"date_modified":1431782825,"content":"https://fedorahosted.org/fpc/ticket/191 \n\nLennart explained the different restart conditions Restart= can have. The reaction of systemd depends on how a service exited.\n\nsd_notify is about notifying the init system about start-up completion and other daemon status changes."},{"author":"Patrick","date_created":1432843668,"date_modified":1432843668,"content":"`systemd unit: added 'TimeoutSec=30' and 'Restart=always' - https://phabricator.whonix.org/T311`:\nhttps://github.com/Whonix/whonixcheck/commit/eccbb43021ace3a9d2144c63e1a3c99571006701\n\n`systemd unit: added 'TimeoutSec=30' and 'Restart=always' - https://phabricator.whonix.org/T311`:\nhttps://github.com/Whonix/sdwdate/commit/095cb9b82816a699e04a9171080b53b835f2fa39\n"},{"author":"Patrick","date_created":1432846343,"date_modified":1432846343,"content":"Using  sd_notify for shell scripts seems difficult to not much benefit. Not doing that. Patches welcome.\n\n`Restart=` was [implemented](https://phabricator.whonix.org/T311#5063)."}]},"PHID-TASK-5qsrwo7ofafygaiuhb3u":{"id":"310","title":"use apt-get -o Acquire::http::Proxy rather than http_proxy environment variable","status":"resolved","priority":"Normal","author":"Patrick","description":"Consideration.\n\nInspired by Marek:\nhttps://github.com/marmarek/qubes-builder-debian/pull/10/files\n\nConditionally adding\n```\n-o Acquire::http::Proxy=$(REPO_PROXY)\n```\nto `apt_misc_opts` seems a bit nicer than using `aptcachemaybeenable` and `aptcachedisable`.","comments":[{"author":"Patrick","date_created":1439660790,"date_modified":1439660790,"content":"This is done:\nhttps://github.com/Whonix/Whonix/commit/bd24500ce5e9a82115c17981590421dcc6892cc3\n\nAdditionally, qubes-template-whonix forwards environment variable REPO_PROXY to Whonix's build script which will then equally use it for `-o Acquire::http::Proxy=$(REPO_PROXY)`."}]},"PHID-TASK-qv35qxna7wtsqwleukzp":{"id":"309","title":"consider deleting old Whonix 10`ish /etc/init.d scripts during upgrade to Whonix 11","status":"resolved","priority":"Normal","author":"Patrick","description":"- foremost to avoid conflicts with systemd\n- also to remove cruft and confusion\n- move `/etc/init.d/sdwdate` etc. to some backup location (in order to prevent hate from users who customized them)\n- maybe `update-rc.d sdwdate remove || true`\n- and for all other init scripts that have been ported to systemd (T106)\n","comments":[{"author":"Patrick","date_created":1432399201,"date_modified":1432399201,"content":"Probably better not. Not required. Non-standard. Conflicts are unlikely, because name of package = name of sysvinit script = name of systemd unit file."},{"author":"Patrick","date_created":1434344333,"date_modified":1434344333,"content":"Not required. T342 functional."}]},"PHID-TASK-fe4dqmg4bfdm4f2ox5ua":{"id":"308","title":"do not run rads outside of boot process","status":"resolved","priority":"Normal","author":"Patrick","description":"There is a bug. When installing/updating rads when no login manager is started, rads is started. Example: when running no login manager and running \"apt-get dist-upgrade\" during a rads upgrade.\n\nHalf solution: make rads exit early if stdin and/or a tty is detected. (When run by systemd during boot, there is no stdin connected.)\n\nFull Solution: somehow distinguish \"boot -> run rads normally\" vs \"run by apt-get/dpkg -> exit rads early\".\n","comments":[{"author":"Patrick","date_created":1431952588,"date_modified":1431952699,"content":"Implemented the half solution.\n`Do not run rads outside of boot process.`\n`When started by systemd, there is no stdin connected and \"tty\" exit code is 1.`\n`In these cases, rads is likely run during an interactive apt-get upgrade.`\n`Exit in those cases.`\n`https://phabricator.whonix.org/T308`:\nhttps://github.com/Whonix/rads/commit/d3c27f735155033f53fb6ce8e75330255cc29bf9"},{"author":"Patrick","date_created":1431954916,"date_modified":1431954916,"content":"`How to distinguish if a systemd unit is run by apt-get or during boot?`:\nhttps://unix.stackexchange.com/questions/204084/how-to-distinguish-if-a-systemd-unit-is-run-by-apt-get-or-during-boot\n"},{"author":"Patrick","date_created":1432161776,"date_modified":1432161776,"content":"`How to distinguish if a systemd unit is run by apt-get or during boot?`:\nhttps://lists.alioth.debian.org/pipermail/pkg-systemd-maintainers/2015-May/007274.html\n"},{"author":"Patrick","date_created":1432340348,"date_modified":1432340348,"content":"`do not run rads outside of boot process - https://phabricator.whonix.org/T308`:\nhttps://github.com/Whonix/rads/commit/cb90ac1c54900fc27e9b80ccc2c46ea95f98a324\n"},{"author":"Patrick","date_created":1432396437,"date_modified":1432396437,"content":">>! In T308#4679, @Patrick wrote:\n> Implemented the half solution.\n> `Do not run rads outside of boot process.`\n> `When started by systemd, there is no stdin connected and \"tty\" exit code is 1.`\n> `In these cases, rads is likely run during an interactive apt-get upgrade.`\n> `Exit in those cases.`\n> `https://phabricator.whonix.org/T308`:\n> https://github.com/Whonix/rads/commit/d3c27f735155033f53fb6ce8e75330255cc29bf9\n\nUndone because of better implementation (https://phabricator.whonix.org/T57#4891) and because `dh_systemd_start --no-start` (https://phabricator.whonix.org/T308#4837) is enough."},{"author":"Patrick","date_created":1432480683,"date_modified":1432480683,"content":"Fixed in Whonix `11.0.0.2.0-developers-only`.\n\nRunning `sudo apt-get install --reinstall rads` and `sudo apt-get purge rads && sudo apt-get install rads` succeeded (didn't start rads during re-installation). (Currently from `developers` repository that was upgraded as per `11.0.0.2.0-developers-only`.)"}]},"PHID-TASK-nebforenvfbdwlylj2af":{"id":"307","title":"switch from '--target root' to '--target qubes' for qubes-whonix builds","status":"resolved","priority":"Normal","author":"Patrick","description":"A follow up task of T298.\n\nAs of Whonix 11, there is no difference between `--target root` and `--target qubes`.\n\nFor Whonix 12, we will need a way to distinguish VM builds, i.e. also Qubes builds from physical isolation builds. (For T296 and perhaps in future other things as well.)\n\nIt could be done for Whonix 11 already, but there is no rush. Doesn't matter.","comments":[{"author":"Patrick","date_created":1439260197,"date_modified":1439260197,"content":"This is implemented:\nhttps://github.com/nrgaway/qubes-template-whonix/blob/be0c1f53cc10a3ccb8628d132da35006225bdff6/whonix-gateway/02_install_groups_pre.sh#L37\n"}]},"PHID-TASK-gkxnmuw4gk4rjzx63ubo":{"id":"306","title":"rads skip mechanism","status":"resolved","priority":"Normal","author":"Patrick","description":"rads is of no use for Qubes. The systemd unit currently does not get started there.\n\nIts [systemd unit](https://github.com/Whonix/rads/blob/master/lib/systemd/system/rads.service) is currently using\n\n```\nConditionPathExists = !/usr/lib/qubes-whonix \n```\n\nThis isn't a great agnostic solution.\n\nAlso [/usr/lib/ram_adjusted_desktop_starter/display-manager-dpkg-post-invoke](https://github.com/Whonix/rads/blob/master/usr/lib/ram_adjusted_desktop_starter/display-manager-dpkg-post-invoke) should not be run on Qubes.","comments":[{"author":"Patrick","date_created":1431704136,"date_modified":1431704136,"content":"pull request for qubes-whonix, skip rads:\nhttps://github.com/nrgaway/qubes-whonix/pull/2\n"},{"author":"Patrick","date_created":1431720301,"date_modified":1431720301,"content":"Added another commit to the pull request.\n\n`skip rads systemd service on qubes - https://phabricator.whonix.org/T306`:\nhttps://github.com/adrelanos/qubes-whonix/commit/683b8de3d606a0caebfdcc9021f22836225890b6\n"},{"author":"Patrick","date_created":1431720403,"date_modified":1431720403,"content":"`systemd unit: removed non-agnostic 'ConditionPathExists = !/usr/lib/qubes-whonix', this will be implemented in the qubes-whonix package - https://phabricator.whonix.org/T306`:\nhttps://github.com/Whonix/rads/commit/9d1605db7e44f61cb8b590165bf9c26eb56606cf\n"},{"author":"Patrick","date_created":1431720426,"date_modified":1431720426,"content":"This is done as soon as @nrgaway merges https://github.com/nrgaway/qubes-whonix/pull/2."},{"author":"nrgaway","date_created":1431724690,"date_modified":1431724690,"content":"I have already reviewed your PRs and there is nothing I can see to prevent build errors and I have also merged them into a test branch I am using for building this weekend.  Will merge into master once everything confirmed working.\n\nWill this cause a problem if included in Whonix10 branch since the codebase is still currently the same.  If it will cause an issue I will only merge it into Whonix11 branch for now and not 10"},{"author":"Patrick","date_created":1431739419,"date_modified":1431739419,"content":"Yes. This is supposed for Whonix >= 11 only. (Hence, only using 'Whonix 11' tag, not 'Whonix 10' tag.)"},{"author":"Patrick","date_created":1431869662,"date_modified":1431869662,"content":"Done, https://github.com/nrgaway/qubes-whonix/pull/2 was merged by nrgaway."}]},"PHID-TASK-e3y4zmchz5b7jwriy7pm":{"id":"305","title":"grub-enable-apparmor broken on jessie based Whonix","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1431699666,"date_modified":1431699666,"content":"`fixed, moved from etc/grub.d/30_apparmor.cfg to etc/default/grub.d/30_apparmor.cfg since the path has changed since release of jessie`:\nhttps://github.com/Whonix/grub-enable-apparmor/commit/85aa341ef3fe9eb72ea21e6c7ad059c2bbb87e94"}]},"PHID-TASK-lutszlhh4sapmus7rktd":{"id":"304","title":"systemd unit file for Tor package?","status":"resolved","priority":"Normal","author":"Patrick","description":"Do we need a systemd file for the Tor package?\n\nDebian jessie's version of Tor still comes with a sysvinit script. Additionally we have deb.torproject.org enabled (through the [anon-shared-build-apt-sources-tpo](https://github.com/Whonix/anon-shared-build-apt-sources-tpo) package). The latter my sooner or later include a systemd unit file by The Tor Project.\n\nI am confused what we need [qubes-whonix/blob/master/etc/systemd/system/qubes-whonix-tor.service](https://github.com/nrgaway/qubes-whonix/blob/master/etc/systemd/system/qubes-whonix-tor.service) for. Is it just fancy or is there a real need for?\n\nIf it was fancy, I don' think we should ship systemd files for packages that come from Debian or The Tor Project that are still sysvinit based. There is simply too many old systemd unit files, just check /etc/init.d. Shipping such as systemd unit file inside Whonix just seems wrong. Those should be contributed upstream. They have a much deeper understanding of the package and if they add new systemd unit files it will get more broader review and testing. Why not just rely on systemd's sysvinit script compatibility, that seems to work quite well for all the remaining stuff in /etc/init.d?\n\nI feel very uncomfortable with Whonix shipping a systemd unit file for Tor if there is no strong reason to do so. As soon as upstream (Debian or The Tor Project) switches to systemd themselves, something during package upgrade could go wrong in conflict with Whonix's specifics. When upstream releases a package upgrade, their maintainer scripts run without knowing whatever Whonix has cooked up. In worst case the package manager will be broken and the Tor service will no longer automatically start during that transition. For all users. Support hell.\n\nI know, there is currently an issue in Whonix 11. On first boot, the Tor service won't successfully start. That's a bug that has yet to be analyzed. Likely caused by Whonix's Tor config. Maybe a bug in Whonix's Tor config or Tor itself. That requires a fix or workaround. Anyhow, I don't think it's right to not find out what's going on and to simply add a systemd workaround while trading the risk of some day breaking Tor connection for all Whonix users.\n\nRelated:\nT303\n","comments":[{"author":"HulaHoop","date_created":1431701052,"date_modified":1431701052,"content":"+1\n\nI'm not a fan of reinvented wheels either because of conflicts and the increased burden. You probably agree the same stance should be taken for other components like apparmor profiles whenever upstream incorporates theirs in Debian."},{"author":"Patrick","date_created":1431702152,"date_modified":1431702152,"content":">>! In T304#4499, @HulaHoop wrote:\n> You probably agree the same stance should be taken for other components like apparmor profiles whenever upstream incorporates theirs in Debian.\n\nThat might be a bigger off-topic discussion. Moved and answered here. Current status of AppArmor and Whonix:\nhttps://www.whonix.org/forum/index.php/topic,97.msg8159.html#msg8159\n"},{"author":"nrgaway","date_created":1431718106,"date_modified":1431718106,"content":"The `qubes-whonix-tor.service` was implemented to solve the issue you were talking about where `Tor` would sometimes not start properly on boot.\n\nThis service file seems to be working and I have not had that issue since.  I named it as such so as not to conflict with an official distribution `unit` file or even one provided by `Whonix`, which would be located in `/etc/systems/system` directory named `tor`.\n\nThe `qubes-whonix-tor.service` is designed to override both a official distribution and Whonix local `unit` files and can be updated or removed in future with a `qubes-whonix` update.\n\nSince the `upstream package version` of `Tor` does not seem to be maintained very well and this solution works I submit it is required, at least for `Qubes`.\n\nI am also working on a more hardened `unit` file for Tor as well [[ https://github.com/nrgaway/qubes-whonix/blob/master/tests/wip/tor.service | https://github.com/nrgaway/qubes-whonix/blob/master/tests/wip/tor.service ]]\n\nOne thing that seems to me missing from `Tor upstream` is `sd_notify`, so watchdog has been disabled, otherwise the service would be restarted every X seconds.\n"},{"author":"Patrick","date_created":1432350295,"date_modified":1432350295,"content":">>! In T304#4517, @nrgaway wrote:\n> The `qubes-whonix-tor.service` was implemented to solve the issue you were talking about where `Tor` would sometimes not start properly on boot.\n\nThat was T251, which is now fixed. There is still a related issue T320, but that will soon be fixed also. (That issue is an upstream bug in Tor, isn't systemd related. Systemd would just be a bandage.)\n \n> I am also working on a more hardened `unit` file for Tor as well [[ https://github.com/nrgaway/qubes-whonix/blob/master/tests/wip/tor.service | https://github.com/nrgaway/qubes-whonix/blob/master/tests/wip/tor.service ]]\n\nThe should be suggested upstream. Adding flag x, y, etc. may seem simple, but can cause issues later. See stuff they discussed earlier. They added a systemd unit file to git:\nhttps://gitweb.torproject.org/tor.git/tree/contrib/dist/tor.service.in\n\nThey had a lot systemd related discussion and improvement already.\n\n- https://trac.torproject.org/projects/tor/query?summary=~systemd&col=id&col=summary&col=type&col=status&col=priority&col=milestone&col=component&order=priority\n- https://trac.torproject.org/projects/tor/query?keywords=~systemd&col=id&col=summary&col=type&col=status&col=priority&col=milestone&col=component&order=priority\n- https://trac.torproject.org/projects/tor/search?changeset=on&milestone=on&ticket=on&wiki=on&q=systemd&page=2&noquickjump=1\n\nThey seem interested and responsive.\n\nReported a bug upstream,\n`spaces in Tor's systemd unit file causes issues`:\nhttps://trac.torproject.org/projects/tor/ticket/16162\n \n> One thing that seems to me missing from `Tor upstream` is `sd_notify`, so watchdog has been disabled, otherwise the service would be restarted every X seconds.\n\nSeems fixed upstream. https://gitweb.torproject.org/tor.git/tree/contrib/dist/tor.service.in uses `Type = notify`.\n"},{"author":"Patrick","date_created":1432392621,"date_modified":1432392621,"content":"Doesn't look like we need one."},{"author":"Patrick","date_created":1432477904,"date_modified":1432477904,"content":"Works fine in Whonix `11.0.0.2.0-developers-only`."}]},"PHID-TASK-4pj3w6wxs37ijkjwzeef":{"id":"303","title":"anon-ws-disable-stacked-tor/blob/master/etc/init.d/tor.anondist vs systemd, insserv already provided issue","status":"resolved","priority":"Normal","author":"Patrick","description":"package:\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor\n\nfile:\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/etc/init.d/tor.anondist\n\n-----\n\nWe probably won't ship our own systemd unit file for Tor (T304).\n\nBut what happens if upstream starts shipping one? ([tor.service](https://gitweb.torproject.org/tor.git/tree/contrib/dist/tor.service.in)) (([bug report](https://trac.torproject.org/projects/tor/ticket/16162)))\n\n-----\n\n~~This is visible during package installation / upgrade.~~\n\n~~update-rc.d: using dependency based boot sequencing~~\n~~insserv: script tor.anondist-orig: service tor already provided!~~\n\n~~Similar issue as T321.~~ ([fixed](https://phabricator.whonix.org/T303#5020))\n","comments":[{"author":"Patrick","date_created":1432830823,"date_modified":1432830823,"content":"`fixed 'insserv: script tor.anondist-orig: service tor already provided!' warning during upgrades - https://phabricator.whonix.org/T303`:\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/commit/12691426c9f0bfd561ce369e90158b9dcd1132ae\n"},{"author":"Patrick","date_created":1432843035,"date_modified":1432843035,"content":"Tested by placing `/lib/systemd/system/tor.service` from https://gitweb.torproject.org/tor.git/tree/contrib/dist/tor.service.in (removed spaces).\n\n```\n# tor.service -- this systemd configuration file for Tor sets up a\n# relatively conservative, hardened Tor service.  You may need to\n# edit it if you are making changes to your Tor configuration that it\n# does not allow.  Package maintainers: this should be a starting point\n# for your tor.service; it is not the last point.\n\n[Unit]\nDescription=Anonymizing overlay network for TCP\nAfter=syslog.target network.target nss-lookup.target\n\n[Service]\nType=notify\nNotifyAccess=all\nExecStartPre=/usr/bin/tor -f /etc/tor/torrc --verify-config\nExecStart=/usr/bin/tor -f /etc/tor/torrc\nExecReload=/bin/kill -HUP ${MAINPID}\nKillSignal=SIGINT\nTimeoutSec=30\nRestart=on-failure\nWatchdogSec=1m\nLimitNOFILE=32768\n\n# Hardening\nPrivateTmp=yes\nPrivateDevices=yes\nProtectHome=yes\nProtectSystem=full\nReadOnlyDirectories=/\nReadWriteDirectories=-/var/lib/tor\nReadWriteDirectories=-/var/log/tor\nNoNewPrivileges=yes\nCapabilityBoundingSet=CAP_SETUID CAP_SETGID CAP_NET_BIND_SERVICE\n\n[Install]\nWantedBy=multi-user.target\n```\n\n-----\n\n`systemd compatibility - https://phabricator.whonix.org/T303`:\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/commit/21a6f2be78497432fdfb207663fd3aa46832ab43\n"},{"author":"Patrick","date_created":1433605223,"date_modified":1433605223,"content":"Fixed in Whonix `10.0.0.2.3`."}]},"PHID-TASK-dsf4kowu2fwsoxh3bnpm":{"id":"302","title":"Tor Browser sha256sum files will be deprecated","status":"resolved","priority":"Normal","author":"Patrick","description":"This will break tb-updater until updated as well as it's bad for security. More info:\nhttps://github.com/micahflee/torbrowser-launcher/issues/180\n","comments":[{"author":"Patrick","date_created":1432129866,"date_modified":1432129866,"content":"Upstream ticket,\n`Differentiate between build and release sha256sums.txt`:\nhttps://trac.torproject.org/projects/tor/ticket/15864\n"},{"author":"Patrick","date_created":1432399760,"date_modified":1432399760,"content":"No way to act at this point, because upstream hasn't decided yet what they want to do."},{"author":"Patrick","date_created":1432839898,"date_modified":1432839898,"content":"Download of TBB `5.0a1` still functional in Whonix `11.0.0.2.0-developers-only`."},{"author":"Patrick","date_created":1433336574,"date_modified":1433336574,"content":"Looks like no change will be required."}]},"PHID-TASK-fuksbwxdtn7pdxaaad4w":{"id":"301","title":"make grsecurity kernel, grsecurity-installer work inside Whonix","status":"invalid","priority":"Normal","author":"Patrick","description":"__Introduction__:\n\n* [grsecurity-installer](https://github.com/Whonix/grsecurity-installer)\n* (a fork of https://github.com/rickard2/grsecurity-Debian-Installer)\n* Used by and useful for the Linux distribution [Whonix](https://www.whonix.org), which is primarily run inside virtual machines\n\n__TODO__:\n\n* use [grsecurity sources from Debian repository](https://packages.debian.org/source/jessie-backports/linux-grsec) (not from grsecurity.net because then we can avoid custom gpg verification)\n* package needs more testing and eventually various fixes\n* the 'make menuconfig' which currently needs manual interaction needs to be automated (preseeded by a configuration file most likely?)\n* sane, secure, useful kernel compilation configuration file required\n* never mind MPROTECT for now (can be disabled)\n* test if it works inside [Qubes](https://www.qubes-os.org) and fix if required\n* test if it works inside [Qubes-Whonix](https://www.whonix.org/wiki/Qubes) and fix if required\n\n__possibly helpful__:\n\n* https://github.com/coldhakca/coldkernel - grsecurity for xen\n* http://www.webcitation.org/6hG9TVlld - previous work and previous ticket discussion\n\n__Bounty too low?__:\n\n1) Go to https://www.bountysource.com/issues/14471558-make-grsecurity-kernel-grsecurity-installer-work-inside-whonix\n2) Click on \"Developers\"\n3) Click on \"Get Started\"\n4) Select Status \"Bounty too low\"\n5) Enter your offer and press \"Save\".\n\n-----\n\nMirrored from:\nhttps://phabricator.whonix.org/T301\n\n-----\n\nMirrored to:\nhttps://github.com/Whonix/grsecurity-installer/issues/1\n\n-----\n\nOn bountysource:\nhttps://www.bountysource.com/issues/14471558-make-grsecurity-kernel-grsecurity-installer-work-inside-whonix\n\n(If you are reading on bountysouce, you can skip all comments until `Snapshot of this before I am going to rewrite the ticket.` and read from there.)","comments":[{"author":"HulaHoop","date_created":1431481670,"date_modified":1431481670,"content":"A compact list of sane grsec defaults as deployed on gentoo:\n\nhttps://wiki.gentoo.org/wiki/Hardened/Grsecurity2_Quickstart\n\nComprehensive coverage of grsec features and default settings:\n\nhttps://wiki.archlinux.org/index.php/Grsecurity"},{"author":"HulaHoop","date_created":1432126421,"date_modified":1432126421,"content":"What are cons of using the Mempo kernel that's already patched with grsecurity?"},{"author":"Patrick","date_created":1432129081,"date_modified":1432129081,"content":"Mempo kernel:\n\n* project cannot be taken serious, see discussion: https://www.whonix.org/forum/index.php/topic,886.0.html\n* high lag with reply: https://github.com/mempo/mempo-kernel/issues/31\n* no reply: https://github.com/mempo/mempo-kernel/issues/30\n* not in Debian\n* -> not very well maintained\n\n* does it even compile?\n* the size of that repository, number of files, number of code lines vs grsecurity-installer is deterring\n* repository contains a history of grsecurity patches -> bad practice -> nowhere near ready for inclusion into Debian\n* seems more like a repository that is run by maintainers to compile a kernel that will be uploaded to a deb repository used for Mempo rather than a grsecurity-installer that would be similar to torbrowser-launcher / tb-updater, that is supposed to be run by a Debian user\n* maybe parts of it would be useful for grsecurity-installer, perhaps they have sorted auto automating kernel config\n"},{"author":"HulaHoop","date_created":1432139135,"date_modified":1432139135,"content":"What about the corsac repository listed in:\nhttps://wiki.debian.org/grsecurity"},{"author":"Patrick","date_created":1432217909,"date_modified":1432217909,"content":"It's also just a compiled kernel. I am that far. Has almost the same TODO as this ticket. Non-minor stuff such as \"desktop environment (kdm) currently does not start, needs fixing\"."},{"author":"Patrick","date_created":1433559601,"date_modified":1433559601,"content":"http://www.corsac.net/index.php?post=1575"},{"author":"HulaHoop","date_created":1439927458,"date_modified":1439927458,"content":"Long term I think its better to have a script to compile and update a grsec kernel than a package in upstream repos because some protections can only be effective if they are unique to the user. A precompiled kernel loses these benefits because the protection values are public and known to everyone including the attacker. Arch has a packaged kernel and they explain the limits:\n\nhttps://wiki.archlinux.org/index.php/Grsecurity\n\nI see the potential problems with update logistics same as you had to handle with TBB updater bit it's a trade off between full protection and ease of compilation.\n\nThis is a big project in itself. The ideas I'll post belong on Rickard's github tracker:\n\nThe script should have different default option configuration files so users can choose  depending on the intended use of the computer server vs desktop.\n\nTor support so all this can happen anonymously preventing metadata and package info from leaking.\n"},{"author":"HulaHoop","date_created":1440171479,"date_modified":1440191732,"content":"Actually the best option is the availability of a Debian grsecurity kernel source package that can be deterministically built. That way the maintenance and update burden is handled upstream and it can be securely installed thru apt with the full protections of grsecurity."},{"author":"HulaHoop","date_created":1493482819,"date_modified":1493482819,"content":"upstream ceased open development: https://www.grsecurity.net/passing_the_baton_faq.php"}]},"PHID-TASK-bpfnofovfkvjhq3wlna7":{"id":"300","title":"replace timesync progress bar by tray icon sdwdate-gui","status":"resolved","priority":"Normal","author":"Patrick","description":"Why deprecate the Whonix 10 timesync progress bar?\n\n* Stale progress bars bug. (https://www.whonix.org/forum/index.php/topic,1219.0.html)\n* Usability mess.\n* Especially confusing in Qubes where a popup comes seemingly up out of nowhere.\n\nNew implementation:\n\n* tray icon that shows that status of network time synchronization\n* the tray are app would read whatever status information the sdwdate daemon provides\n* that shows more detailed status information when hovering over it\n* perhaps a right click context menu would be useful\n* that perhaps later shows a graphical user interface when clicking it\n* after boot, before the first time synchronization finished, sdwdate should dispatch a script that blocks network access and dispatch another script that allows network access when done\n\nSplit task `iptables block network access until sdwdate succeeded`:\nT533","comments":[{"author":"nrgaway","date_created":1431781868,"date_modified":1431781868,"content":"Let me know when you start this.\n\nI know an icon can be added to task bar in `Qubes` since `Network Manager` will display, I am just not sure if anything needs to be done on the `Qubes` side as well"},{"author":"Patrick","date_created":1435624724,"date_modified":1435624724,"content":"python rewrite of sdwdate - which is only a time syncing daemon - no gui stuff - in progress by troubadour:\nhttps://www.whonix.org/forum/index.php/topic,1301.0.html\n\nIf you want, you can follow as it happens. Comment on code sanity, security, concepts and whatnot etc.\n\nTray icon will come when sdwdate python rewrite is done."},{"author":"Patrick","date_created":1470239837,"date_modified":1470239837,"content":"Split task `iptables block network access until sdwdate succeeded`:\nT533"}]},"PHID-TASK-tpayk6v3hk5ypzb4kekf":{"id":"299","title":"abolish whonixcheck random wait","status":"resolved","priority":"Normal","author":"Patrick","description":"Why was it introduced in the first place? From https://www.whonix.org/wiki/Whonixcheck\n\n> Some users wish to hide the fact from their ISP, they they are using Tor and Whonix. See [Hide Tor and Whonix from your ISP](https://www.whonix.org/wiki/Hide_Tor_and_Whonix_from_your_ISP) article. While only a fraction of users goes through the procedures to hide Tor, it is still desirable to hide the fact they're using Whonix. We're better of if adversaries can't distinguish between lets say TBB and Whonix users. When whonixcheck is automatically started, it waits a randomized amount of time (between 60 and 500 seconds). Although it would be Tor's job to prevent any kinds of conclusions from the amount of traffic and the traffic pattern, this feature is supposed to aid to obfuscation of that kind of traffic analysis. Starting Tor and instantly having a lot of traffic (from whonixcheck) might be easier to distinguish than waiting a randomized amount of time until that kind of traffic flows.\n\nWhy deprecate it?\n\n* It breaks terminal-only (https://www.whonix.org/forum/index.php/topic,1209.0.html) (or requires, wastes ~64 MB RAM).\n* Usability mess.\n* It's incomplete. (Not in use on first run of Whonix-Gateway.)\n* Based on unproven, speculative assumption. Even if the above strategy worked, whonixcheck is still too specific in its activities. So it's really Tor's task to prevent traffic classification.\n* Especially confusing in Qubes where a popup comes seemingly up out of nowhere.\n","comments":[{"author":"HulaHoop","date_created":1431441341,"date_modified":1431441341,"content":"Agreed"},{"author":"Patrick","date_created":1432404858,"date_modified":1432404858,"content":"`abolished random wait by default - https://phabricator.whonix.org/T299`:\nhttps://github.com/Whonix/whonixcheck/commit/c12b7c1f33a4a281dc1802ba7b6801d2a8067de3\n"},{"author":"Patrick","date_created":1432477922,"date_modified":1432477922,"content":"Done in Whonix `11.0.0.2.0-developers-only`."}]},"PHID-TASK-3lo6lsqacfbwjaetmrn3":{"id":"298","title":"add --target qubes","status":"resolved","priority":"Normal","author":"Patrick","description":"Using `--target root` works, but it's non-ideal. Using `--target qubes` would allow more freedom. Required for T296.","comments":[{"author":"Patrick","date_created":1431290275,"date_modified":1431290275,"content":"`implemented --target qubes - https://phabricator.whonix.org/T298`:\nhttps://github.com/Whonix/Whonix/commit/705bae959e157db951d698f9e9d73dc1aa279b31\n\n`cleanup, checking for \"$ANON_BUILD_INSTALL_TO_ROOT\" = \"1\" or \"$WHONIX_BUILD_QUBES\" = \"true\" in function check-virtualbox-vm-exists not required, because function is only called if \"$WHONIX_BUILD_VIRTUALBOX\" = \"true\" anyhow`:\nhttps://github.com/Whonix/Whonix/commit/0043a466b4fe2b9a17f5cffbc52101735f7bd81a\n\n`implemented WHONIX_BUILD_QUBES=true environment variable support - https://phabricator.whonix.org/T298`:\nhttps://github.com/Whonix/anon-base-files/commit/698ba10c7554a020891d619bcdd61b01014c4245\n\n`implemented WHONIX_BUILD_QUBES=true environment variable support - https://phabricator.whonix.org/T298`:\nhttps://github.com/Whonix/whonix-developer-meta-files/commit/ed05f096b9d3e2f69a40a3ce1d28dd980d1047c0\n\n`whonix-gateway and whonix-workstation package no longer depend on anon-shared-build-fix-grub because it has been made a weak dependency for better physical isolation and Qubes support`:\nhttps://github.com/Whonix/anon-meta-packages/commit/f400f82ad493befede7a78356e026b297d2ec7ba\n\n`code simplification, removed support for environment variable ANON_BUILD_INSTALL_TO_ROOT=true because anon-shared-build-fix-grub now gets only installed on required platforms`:\nhttps://github.com/Whonix/anon-shared-build-fix-grub/commit/bec926b41f7d8c2f9edfcb29ab6ead6f062076c3\n"},{"author":"nrgaway","date_created":1431738053,"date_modified":1431738053,"content":"With `--target qubes` I get following error:\n\n```\n+ true 'INFO: Would build form untagged commits.'\n+ export whonix_build_ignore_untagged=true\n+ whonix_build_ignore_untagged=true\n+ shift 2\n+ :\n+ case $1 in\n+ '[' false = true ']'\n+ '[' false = false ']'\n+ true 'INFO: Sanity tests false.'\n+ export 'SKIP_SCRIPTS+= 20_sanity_checks '\n+ SKIP_SCRIPTS+=' 20_sanity_checks '\n+ shift 2\n+ :\n+ case $1 in\n+ '[' '' = '' ']'\n+ true\n+ break\n+ '[' ' linux-image-amd64' = '' ']'\n+ '[' ' linux-headers-amd64' = '' ']'\n+ '[' amd64 = '' ']'\n+ '[' '!' '' = 1 ']'\n+ '[' '!' 1 = 1 ']'\n+ '[' 1 -gt 1 ']'\n+ '[' 1 -le 0 ']'\n+ '[' '' = 1 ']'\n+ '[' '' = true ']'\n+ '[' '' = true ']'\n+ '[' '' = true ']'\n+ parse_cmd_target_error\n+ echo 'ERROR: --target must be either virtualbox, root or qcow2 and can be used multiple times.'\nERROR: --target must be either virtualbox, root or qcow2 and can be used multiple times.\n```\n\nalthough the first test passes:\n```\n+ case $1 in\n+ true 'INFO: --target qubes chosen.'\n+ '[' qubes = virtualbox ']'\n+ '[' qubes = root ']'\n+ '[' qubes = qcow2 ']'\n+ '[' qubes = qubes ']'\n+ build_target_counter=1\n+ export WHONIX_BUILD_QUBES=true\n+ WHONIX_BUILD_QUBES=true\n+ shift 2\n+ :\n+ case $1 in\n```\n\nLooks like some code is missing in `parse-cmd` at aprox `line 745`:\n```\n   elif [ \"$WHONIX_BUILD_QUBES\" = \"true\" ]; then\n      true\n```"},{"author":"Patrick","date_created":1431738501,"date_modified":1431738501,"content":"Will fix this soon.\n\nActually using this has time. Explanation and ticket for the actual switch: T307\n"},{"author":"Patrick","date_created":1431738812,"date_modified":1431738812,"content":"Fixed:\nhttps://github.com/Whonix/Whonix/commit/5e737c34bc5b66eb34f17d6022f18d142384b96f\n\nAvailable in `11.0.0.1.5-developers-only`.\n"}]},"PHID-TASK-yhf6hpy6y56kyfsto4z5":{"id":"297","title":"disable KDE's power management in VMs","status":"duplicate","priority":"Normal","author":"Patrick","description":"KDE -> System Settings --> Power Management\n\nForum discussion:\nhttps://www.whonix.org/forum/index.php/topic,1217.0.html\n\nRelated to:\nT296","comments":[{"author":"Patrick","date_created":1439928163,"date_modified":1439928163,"content":"Produced a branch doing this. Not yet merged into master.\n\n`disabled powerdevil service to prevent occasionally message \"no valid power management backend plugins are available\" - https://phabricator.whonix.org/T297`:\nhttps://github.com/adrelanos/power-savings-disable-in-vms/commit/eec0a4283651d61f8f179ca7b05ddb16fe3e8ea5\n\nBut that alone is an incomplete solution. The battery monitor still appears in systray by default. And worse, when you click at it, there will be an error message, because power devil has been disabled. I am onto something to get rid of the battery monitor as well. Let's see."}]},"PHID-TASK-4n3lxnze5hkq57pukw7c":{"id":"296","title":"disable kde power management in VMs","status":"resolved","priority":"Normal","author":"Patrick","description":"TODO:\n\n* disable powerdevil\n* disable kde battery monitor systray\n* disable KDE -> System Settings --> Power Management\n\n-----\n\nForum discussion:\nhttps://www.whonix.org/forum/index.php/topic,1217.0.html\n\n-----\n\nDeprecated:\n\n~~In `/usr/share/kde4/services/kded/powerdevil.desktop` change from~~\n\n~~X-KDE-Kded-phase=1~~\n~~to~~\n~~X-KDE-Kded-phase=0~~\n\n~~using config-package-dev's displace operation. Conditionally, only if --target virtualbox, qcow2, qubes (T298) [during build script] or when virt-what detects a virtual machine.~~\n","comments":[{"author":"Patrick","date_created":1439917577,"date_modified":1439931322,"content":"Might have found a better solution.\n\nSwitching using the kde service manager (https://userbase.kde.org/System_Settings/Startup_and_Shutdown/de#Service_Manager) modifies the following file.\n\n`/home/user/.kde/share/config/kdedrc`\n\n```\n[Module-powerdevil]\nautoload=false\n```\n\nBut we won't need to write into user's home folder. Can be implemented similar to the kde-lowfat package.\n\n* https://github.com/Whonix/kde-lowfat/blob/master/etc/X11/Xsession.d/50kde-lowfat\n* https://github.com/Whonix/kde-lowfat/blob/master/usr/share/kde-lowfat/share/config/kdedrc\n\nThe Xsession.d script could even check if being run within virtualization.\n\n-----\n\nProduced a branch doing this. Not yet merged into master.\n\n`disabled powerdevil service to prevent occasionally message \"no valid power management backend plugins are available\" - https://phabricator.whonix.org/T297`:\nhttps://github.com/adrelanos/power-savings-disable-in-vms/commit/eec0a4283651d61f8f179ca7b05ddb16fe3e8ea5\n\nBut that alone is an incomplete solution. The battery monitor still appears in systray by default. And worse, when you click at it, there will be an error message, because power devil has been disabled. I am onto something to get rid of the battery monitor as well. Let's see."},{"author":"HulaHoop","date_created":1439927825,"date_modified":1439927825,"content":"Nice. Do you know if this can be extended to KDE network manager to get rid of the taskbar icon?"},{"author":"Patrick","date_created":1439928676,"date_modified":1439928676,"content":"My quick and dirty solution in place solution that works, that I am cleaning up and committing to disable the battery monitor systray.\n\n`/usr/share/whonix-ws-kde-desktop-conf/share/kde4/services/plasma-applet-batterymonitor.desktop`\n\n```\n[Desktop Entry]\nName=battery-monitor-disabled\nType=none\n```\n"},{"author":"Patrick","date_created":1439928736,"date_modified":1439931336,"content":""},{"author":"Patrick","date_created":1439931239,"date_modified":1439931239,"content":">>! In T296#6497, @HulaHoop wrote:\n> Nice. Do you know if this can be extended to KDE network manager to get rid of the taskbar icon?\n\nWill answer here later:\nhttps://www.whonix.org/forum/index.php/topic,532.msg9518.html#msg9518\n\n"},{"author":"Patrick","date_created":1439931788,"date_modified":1439931788,"content":"`disabled kde battery monitor systray in VMs - https://phabricator.whonix.org/T296`:\nhttps://github.com/adrelanos/power-savings-disable-in-vms/commit/73c37a29c936a2d4d51e068789ae79d0471081f8\n"},{"author":"Patrick","date_created":1440010619,"date_modified":1440010619,"content":"Working quick and dirty in place solution to get rid of the broken power management item in kde systemsettings. (Broken as expected because powerdevil has been disabled.)\n`/usr/share/whonix-ws-kde-desktop-conf/share/kde4/services/powerdevilglobalconfig.desktop`\n```\n[Desktop Entry]\nType=none\nX-KDE-System-Settings-Parent-Category=\n```\n"},{"author":"Patrick","date_created":1440013923,"date_modified":1440013923,"content":"`Disabled power management item in kde systemsettings.`:\nhttps://github.com/Whonix/power-savings-disable-in-vms/commit/46569ac2889fb6d793dd52973ad3f63683efb41d\n"},{"author":"Patrick","date_created":1448032796,"date_modified":1448032796,"content":"https://forums.whonix.org/t/whonix-12-0-0-3-2-rc-testers-wanted/\n\nDoes it work in KVM wrt to this ticket?"},{"author":"Patrick","date_created":1462978043,"date_modified":1462978043,"content":">>! In T296#7190, @Patrick wrote:\n> https://forums.whonix.org/t/whonix-12-0-0-3-2-rc-testers-wanted/\n> \n> Does it work in KVM wrt to this ticket?\n\n@HulaHoop "},{"author":"HulaHoop","date_created":1462981906,"date_modified":1462981906,"content":"Yes its working :)"}]},"PHID-TASK-3swcvgblkgrn5iwj5c6a":{"id":"295","title":"Speedup Whonix 11 build time","status":"resolved","priority":"Normal","author":"nrgaway","description":"We are considering using `----force-unsafe-io` and `eatmydata` options to speed up the performance of installing the Debian templates and was wondering what your thoughts would be on implementing same for Whonix11 build, either as standard or as a build option?\n\nThe following is Marek's comment, and your will see he states he is receiving a huge performance boost; What used to take 40 minutes to install has been cut to 10 minutes.\n\n> dpkg is quite slow in installing packages, most likely because it calls fsync() at each file. In Qubes IO have noticeable latency, especially when building template (effectively two loop device layers, or even three when building in DispVM).\n> Those patches disables most of fsync calls, which greatly improve performance (prepare-chroot-debian takes 10min compared to over 40 earlier). debootstrap itself still still calls fsync, because I haven't found a way to pass dpkg options there and Fedora doesn't have eatmydata package.\n>\n> Of course, there is nothing for free - here we pay with data integrity - if the system crashes during chroot/template preparation, most likely the only option would be to remove it and generate again. \n>\n> You can view, comment on, or merge this pull request online at:\n>\n> https://github.com/marmarek/qubes-builder-debian/pull/10\n>\n> Commit Summary\n>\n>   Add --force-unsafe-io to speedup installation\n>    Further performance optimization - use 'eatmydata' for IO-intensive calls\n>\n> File Changes\n> \n>    M prepare-chroot-debian (9)\n>    M prepare-chroot-qubuntu (6)\n>    M template_debian/01_install_core.sh (2)\n>    M template_debian/distribution.sh (8)\n>    M template_debian/vars.sh (2)\n>\n> Patch Links:\n> \n> [[ https://github.com/marmarek/qubes-builder-debian/pull/10.patch | https://github.com/marmarek/qubes-builder-debian/pull/10.patch ]]\n> [[ https://github.com/marmarek/qubes-builder-debian/pull/10.diff | https://github.com/marmarek/qubes-builder-debian/pull/10.diff ]]\n","comments":[{"author":"Patrick","date_created":1431280917,"date_modified":1431280917,"content":"Great idea! Great to have as a build option. Great for debug/personal/developers-only builds. I wouldn't want to release testers-only or stable releases build with that option. Looking forward to it!"},{"author":"Patrick","date_created":1431342306,"date_modified":1431342306,"content":"`implemented $apt_misc_opts - https://phabricator.whonix.org/T295`:\nhttps://github.com/Whonix/Whonix/commit/cc635d254a9a77b5c0bdd33eedfe68009a77ce93\n\n```\n- implemented build parameter '--unsafe-io true', that speeds up builds, that uses '-o Dpkg::Options::=--force-unsafe-io', eatmydata and ignores 'sync'. - Thanks to @nrgaway for the suggestion!  - https://phabricator.whonix.org/T295\n- implemented $apt_misc_opts - https://phabricator.whonix.org/T295\n```\nhttps://github.com/Whonix/Whonix/commit/5fc20ac69b6e994f6813ec7328c4a0a97f58d05a\n\n"},{"author":"Patrick","date_created":1431344624,"date_modified":1431344624,"content":"`don't use both, eatmydata command and LD_PRELOAD eatmydata, not required and causes conflicts with symlinks (dpkg-diversions, uwt)`:\nhttps://github.com/Whonix/Whonix/commit/8f5c58f2765f7ef039e6c72e33afdaa7ce66830d\n"},{"author":"Patrick","date_created":1431348442,"date_modified":1431348442,"content":"That didn't work. ld preloading works a bit different on jessie. Fixed.\n\n`fix, refactoring, cleanup, output`:\nhttps://github.com/Whonix/Whonix/commit/3c172558a8afa348fccb9b64a8e02f58b1b05ab2\n\nCurrently testing if it speeds up the build."},{"author":"Patrick","date_created":1431351241,"date_modified":1431351241,"content":"`--unsafe-io true` has been implemented. As of `11.0.0.1.2-developers-only`.\n\nBenchmark results...\n\n```\n11.0.0.0.8-developers-only\nsudo -E ./whonix_build --flavor whonix-gateway -- --report minimal --build --target virtualbox\n+ true 'INFO: End of: ./whonix_build | exit_code: 0 | error(s) detected: 0 | benchmark: 00:35:03'\n```\n\n```\n11.0.0.1.2-developers-only\nsudo -E ./whonix_build --flavor whonix-gateway -- --report minimal --build --target virtualbox --unsafe-io true\n+ true 'INFO: End of: ./whonix_build | exit_code: 0 | error(s) detected: 0 | benchmark: 00:31:09'\n```\n\nNot too big an improvement. Could be because I am using an SSD anyhow."},{"author":"Patrick","date_created":1431352776,"date_modified":1431352776,"content":"Doesn't work for `build-steps.d/1200_create-debian-packages` yet. Working on that."},{"author":"Patrick","date_created":1431355750,"date_modified":1431355750,"content":"Fixed that.\n\n`fixed '--unsafe-io true' in build-steps.d/1200_create-debian-packages; unsafe-io wheezy compatibility; refactoring; output`:\nhttps://github.com/Whonix/Whonix/commit/3c172558a8afa348fccb9b64a8e02f58b1b05ab2\n\nHowever, the time that is saved, if any, is below measuring inaccuracy.\n\n```\nsudo ./build-steps.d/1200_create-debian-packages --build --target root --allow-uncommitted true --allow-untagged true --internalrun --unsafe-io false\n+ true 'INFO: End of: ./build-steps.d/1200_create-debian-packages | exit_code: 0 | error(s) detected: 0 | benchmark: 00:13:16'\n```\n\n```\nsudo ./build-steps.d/1200_create-debian-packages --build --target root --allow-uncommitted true --allow-untagged true --internalrun --unsafe-io true\n+ true 'INFO: End of: ./build-steps.d/1200_create-debian-packages | exit_code: 0 | error(s) detected: 0 | benchmark: 00:14:11'\n```\n\nFeel free to experiment with `--unsafe-io true` and tell me if that helps."},{"author":"Patrick","date_created":1431358221,"date_modified":1431358221,"content":"As of `11.0.0.1.3-developers-only`...\n```\nsudo -E ./whonix_build --flavor whonix-gateway -- --report minimal --build --target virtualbox --unsafe-io true\n+ true 'INFO: End of: ./whonix_build | exit_code: 0 | error(s) detected: 0 | benchmark: 00:28:13'\n```\n"},{"author":"Patrick","date_created":1431363139,"date_modified":1431363139,"content":"As of `11.0.0.1.3-developers-only`... This time for comparison, just creating a raw image. (Skips conversion to a vdi image as well as ova export.)\n\nWhy do I mention raw image benchmarks? Because that's very similar to the Qubes build process. Only differences... Whonix: using grml-debootstrap for creation of the base image; not adding Qubes specific packages. Qubes: using qubes-builder-debian. My point is, you should be able to reach very similar build speeds.\n\n```\nsudo -E ./whonix_build --flavor whonix-gateway -- --report minimal --build --target raw --unsafe-io true\n+ true 'INFO: End of: ./whonix_build | exit_code: 0 | error(s) detected: 0 | benchmark: 00:22:08'\n```\n\n```\nexport make_use_lintian=\"true\"\nsudo -E ./whonix_build --flavor whonix-gateway -- --report minimal --build --target raw --unsafe-io true\n+ true 'INFO: End of: ./whonix_build | exit_code: 0 | error(s) detected: 0 | benchmark: 00:22:23'\n```\n\n```\nexport make_use_lintian=\"true\"\nsudo -E ./whonix_build --flavor whonix-gateway -- --report minimal --build --target raw --unsafe-io true --sanity-tests false\n+ true 'INFO: End of: ./whonix_build | exit_code: 0 | error(s) detected: 0 | benchmark: 00:21:40'\n```\n\nThat's the ~20 minutes you were looking for?"},{"author":"nrgaway","date_created":1431726492,"date_modified":1431727019,"content":"I be testing it soon.  Looks like only new options are `--unsafe-io true` and `--target qubes`"},{"author":"Patrick","date_created":1431738904,"date_modified":1431738904,"content":"Yes.\n\n(`--target qubes` has time (low priority at this moment). Explanation and ticket for the actual switch to `--target qubes`: T307)"},{"author":"nrgaway","date_created":1431781074,"date_modified":1431781074,"content":"Marek says he sees improvement.  I may too; its hard to tell at this point; need a few more dozen builds to get a better idea.\n\nThanks for adding the option!"}]},"PHID-TASK-abq3y6ii537hon5d2n3b":{"id":"294","title":"apparmor-profile-whonixcheck add /proc/sys/kernel/random/entropy_avail","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1430773318,"date_modified":1430773318,"content":"`added /proc/sys/kernel/random/entropy_avail - https://phabricator.whonix.org/T294'`:\nhttps://github.com/Whonix/apparmor-profile-whonixcheck/commit/8deacd048499560e46ffaa6cb6709b95cfd4f7cf"}]},"PHID-TASK-yygc64vxjn6z3qmi4kcj":{"id":"293","title":"Maybe document Whonix services boot process","status":"open","priority":"Normal","author":"nrgaway","description":"I am thinking it would be useful to have the Whonix boot process documented. The document can contain what `core` Whonix services are loaded at what point.  For example:\n```\n  - /lib/systemd/system/sdwdate.service\n  - /lib/systemd/system/tor.service\n  - /lib/systemd/system/whonixcheck.service\n  - /etc/X11/Xsession.d/20whonix\n  - /etc/X11/Xsession.d/50torbrowser-default-browser\n  - /etc/X11/Xsession.d/50whonix-gw-kde-desktop-conf\n  - /etc/profile.d/15_open_link_confirmation.sh\n  - /etc/profile.d/20_power_savings_disable_in_vms.sh\n  - /etc/profile.d/20_whonix.sh\n  - /etc/profile.d/30_desktop.sh\n  - /etc/profile.d/30_setup.sh\n  - /etc/profile.d/40_msgdispatcher.sh\n  - /etc/xdg/autostart/whonix-setup-wizard.desktop\n```\n\nAnd describe what each service, configuration file accomplishes in one document.\n\nThis would be useful to know where to plug other stuff in so it will not conflict with Whonix startup and therefore remove some of the qubes-whonix related work-around code.  It would be nice for audits as well.\n\nIt would also be nice to have high level documentation of the individual Whonix modules such as `whonixcheck` for audit and workflow.  I am not suggesting each function be documented.  For example, it is really difficult to see what the flow for `whonixcheck`.  A document can contain all the files that get included and the order they are included so if I am having issues with `whonixcheck` I can check the docs on which files in which order and why they are being included.\n\nI would suggest we use something like `sphnix` markup within the source files themselves so the docs can automatically be built for each package.  I can help write custom modules where needed to stitch things together and allow it to work with shell scripts as well as python scripts.","comments":[{"author":"Patrick","date_created":1430578585,"date_modified":1430578585,"content":"> I am thinking it would be useful to have the Whonix boot process documented. The document can contain what `core` Whonix services are loaded at what point.  For example:\n> And describe what each service, configuration file accomplishes in one document.\n\nCan do. Would a wiki page do?\n\n> This would be useful to know where to plug other stuff in so it will not conflict with Whonix startup and therefore remove some of the qubes-whonix related work-around code.  It would be nice for audits as well.\n\nSure.\n\n> It would also be nice to have high level documentation of the individual Whonix modules such as `whonixcheck` for audit and workflow.  I am not suggesting each function be documented.  For example, it is really difficult to see what the flow for `whonixcheck`.  A document can contain all the files that get included and the order they are included so if I am having issues with `whonixcheck` I can check the docs on which files in which order and why they are being included.\n\nJust now added whonixcheck source code documentation:\n* https://www.whonix.org/wiki/Whonixcheck#Source_Code_Introduction\n* Does that help?\n* Any questions?\n\n> I would suggest we use something like `sphnix` markup within the source files themselves so the docs can automatically be built for each package.  I can help write custom modules where needed to stitch things together and allow it to work with shell scripts as well as python scripts.\n\nPlease get this started and then I go on documenting."}]},"PHID-TASK-6ilutdamykghrqje5md5":{"id":"292","title":"make git-tags-push-latest","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1430487809,"date_modified":1430487809,"content":"`implemented 'make git-tag-push-latest' - git push most recent git tag. (Environment variable make_git_tag_push_targets, that defaults to 'origin'.) - https://phabricator.whonix.org/T292`:\nhttps://github.com/Whonix/genmkfile/commit/472850c285714a080316778296dda4aefd2b06c6"}]},"PHID-TASK-vh5co2dzqs3wkaqb24v2":{"id":"291","title":"Integration of YaCy with TorBrowser","status":"resolved","priority":"Wishlist","author":"HulaHoop","description":"The integration of YaCy with TorBrowser prevents fingerprinting while users take advantage of the censorship resistant p2p search engine.\n\nHave wrapper scripts for yacy and privoxy settings that make them usable with Tor using the follwing instructions: https://www.whonix.org/forum/index.php?topic=314.0\n\nSome ideas:\n\nRequest of environment variable to allow seamless use of yacy if its installed so it can sit between TBB and the GW Tor. The idea is yacy will sit side by side with the normal TBB path of TBB > Tor > Internet and take reuqests only when explicitly used rather than force everything though itself.\n\nSee if there is a way to have custom search providers in TorBrowser and include a link to a would-be yacy search portal at 127.0.0.1 that only works if the user opts to install it.\n\nAdd a YaCy searchbox in the Whonix TBB custom homepage\n\n\nTemporarily document the forum post in the wiki page:\nhttps://www.whonix.org/wiki/YaCy","comments":[{"author":"HulaHoop","date_created":1433520181,"date_modified":1433520675,"content":"I don't think shipping YaCy  by default is a good idea because it would need openjdk - a massive dependency. Documenting manual installation is enough. The process is easy enough anyhow. YaCy is configured to restart with the system out of the box.\n\n* Should we ship YaCy's Debian apt repo list -  but comment it out and leave it up to the user to enable?\n\n* The only problem I see is TBB refusing to recognize localhost addresses which makes YaCy not usable in TBB. That's a serious problem because of fingerprinting. Can this be fixed?\n\n* PaX exceptions for java need to be configured when we use it."},{"author":"Patrick","date_created":1433527931,"date_modified":1433527931,"content":">>! In T291#5231, @HulaHoop wrote:\n> I don't think shipping YaCy  by default is a good idea because it would need openjdk - a massive dependency. \n\nYes.\n\n> Documenting manual installation is enough.\n\nOk.\n \n> * Should we ship YaCy's Debian apt repo list -  but comment it out and leave it up to the user to enable?\n\nSounds good, we can preconfigure all so only a very few easy steps would be required to actually enable it.\n\n-----\n \n> * The only problem I see is TBB refusing to recognize localhost addresses which makes YaCy not usable in TBB. That's a serious problem because of fingerprinting. Can this be fixed?\n\nPossibly, but unrealistic. Source:\n\nhttps://trac.torproject.org/projects/tor/ticket/11493\n\n>> me:\n>> Can you allow connections to 127.0.0.1 will still defeating fingerprinting issues (#10419) please?\n> gk:\n> This involves fixing ​https://bugzilla.mozilla.org/show_bug.cgi?id=354493 which is not so easy...\n\nNot sure how useful that answer is.\n\n(References are also listed here: https://www.whonix.org/wiki/Tor_Browser#Local_Connections)\n \n-----\n\nAnything is possible, but $someone would have to create a package like `anon-ws-yacy`."},{"author":"HulaHoop","date_created":1433551843,"date_modified":1433552009,"content":"There's a workaround but at cost of less fingerprinting defense: https://trac.torproject.org/projects/tor/ticket/10419#comment:37\n\nIs it worth it?\n\nOr maybe we can use something like rinetd somehow for a safer solution."},{"author":"Patrick","date_created":1433555223,"date_modified":1433555223,"content":">>! In T291#5255, @HulaHoop wrote:\n> There's a workaround but at cost of less fingerprinting defense: https://trac.torproject.org/projects/tor/ticket/10419#comment:37\n> \n> Is it worth it?\n\nNot a great solution imho. It could be added to documentation https://www.whonix.org/wiki/Tor_Browser#Local_Connections if you want. But a vague, not well described risk, I don't know. Not great. Separate ticket if you want.\n \n> Or maybe we can use something like rinetd somehow for a safer solution.\n\nProbably not. Created T343 for it."},{"author":"HulaHoop","date_created":1433611623,"date_modified":1433611890,"content":""},{"author":"HulaHoop","date_created":1433611853,"date_modified":1433611853,"content":"Workaround documented. Its not great but acceptable than using Iceweasel.\n\nI don't know if this applies to I2P or just its management interface -if it does I'll put it under the general TBB page.\n\nHowever for just accessing management interfaces locally, Iceweasel is fine\n\nClosing this."}]},"PHID-TASK-gtd3vn4hadn5sv3sq5gk":{"id":"290","title":"show details on whonixcheck Whonix News gpg verification failure by default","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1430441782,"date_modified":1430441782,"content":"`show diagnostic message on whonixcheck Whonix News gpg verification failure by default`:\nhttps://github.com/Whonix/whonixcheck/commit/fe7b5eaffec1bd12460b7986a089ad528f6b7581"}]},"PHID-TASK-muzbmhhgcnccioahp2rq":{"id":"289","title":"create jessie repository","status":"resolved","priority":"Normal","author":"Patrick","description":"Required for Whonix 11 based builds.","comments":[{"author":"Patrick","date_created":1430422525,"date_modified":1430422525,"content":"Updated `developers` repository as per Whonix `11.0.0.0.6-developers-only` and migrated that to `jessie` repository."}]},"PHID-TASK-mykwxh2maq5wgi2evs6e":{"id":"288","title":"Qubes Whonix 10 - Testing Instructions and Issues","status":"resolved","priority":"High","author":"nrgaway","description":"I will include instructions on how to upgrade an existing `Qubes Whonix` template (`version 9.6.2`) to the recently released `Whonix 10`.\n\nI have been able to test in 'whonix-gateway` in `Qubes Release 3`, but do not have access to machine with `Release 2` installed on it.  Nor have I been able to test upgrading `whonix-workstation` since I did not have an earlier version to upgrade with.\n\n`ITL` will also release, at some point, a full template which would replace your existing template for users not interested in the upgrade process.\n\nPlease report any bugs or errors you experience here; but not ones listed as expected.  An additional task may then be created for any bugs that I am currently unaware of.","comments":[{"author":"nrgaway","date_created":1430362327,"date_modified":1430443361,"content":"# Testers Update instructions\n\n`DO NOT FORGET TO BACKUP (CLONE)` your existing whonix templates :)\n\nFollowing is the procedure I used to update a Qubes OS Release 3 `whonix-gateway` template from `9.6.2` to `10.0.5`.  I have not tested updating `whonix-workstation`, since I did not have a 9.6 version installed, but I would assume the same procedure as listed below could be followed verbatim.\n\n# In dom0\nBackup (clone) existing `whonix-gateway` and `whonix-workstation`  (max 30 chars)\n`qvm-clone whonix-gateway-experimental whonix-gw-backup`\n`qvm-clone whonix-workstation whonix-ws-backup`\n\n# In Whonix template-vm\n\nFix if you receive locale errors that may have happened during a Debian system update\n`sudo localedef -f UTF-8 -i en_US -c en_US.UTF-8`\n`sudo update-locale LC_ALL=en_US.UTF-8`\n`poweroff`  # Need to restart template-vm for setttings to take effect\n\nEnable `qubes TEST repo`; uncomment test repos (remove the '#')\n(Use vi, nano or whatever text editor you are familiar with)\n`sudo vi /etc/apt/sources.list.d/qubes-r3.list`\n- or for r2\n`sudo vi /etc/apt/sources.list.d/qubes-r2.list`\n\nEnable `Whonix TEST repo` (for access to qubes-whonix).\nThis step has to be run even if set previously though setup since `whonix-setup-wizard` pointed to the incorrect repos\n`sudo whonix_repository`\n\nUpdate package index\n`sudo apt-get update`\n\n#  `IMPORTANT`: Confirm `qubes-whonix` installation candidate is at least `0.10.0.5-1`\n```\nsudo apt-cache policy qubes-whonix\nqubes-whonix:\n  Installed: 9.6.2-1+wheezy1\n  Candidate: 0:10.0.5-1\n  Version table:\n     0:10.0.5-1 0\n        500 http://sourceforge.net/projects/whonixdevelopermetafiles/files/internal/ developers/main amd64 Packages\n *** 9.6.2-1+wheezy1 0\n        100 /var/lib/dpkg/status\n```\n\n# Expected error messages, warnings, dialog's or prompts that require action\n\nIt should be fine to ignore any errors or warnings to do not cause `dist-upgrade` to fail\nIt is also fine to ignore a 'whonixcheck` dialog may appear with following message.  Click `OK`.\n```\nERROR: Virtualizer xen xen-hvm unsupported by Whonix developers! Whonixcheck aborted!\nUsing Virtualizer xen xen-hvm together with Whonix is recommended against, because it is rarely tested. [1] [2] [3] \nIt could be made possible, but would require more Whonix contributors. \nIt may already work, but is highly experimental. \nThis might endanger your anonymity. Do not proceed unless you know what you are doing. \nIf you wish to ignore this warning and to continue whonixcheck anyway, you can set \nWHONIXCHECK_NO_EXIT_ON_UNSUPPORTED_VIRTUALIZER=\"1\"\nin /etc/whonix.d/30_whonixcheck_default. \nRecommended action: \n- Shut down. \n- Read Whonix documentation [4]. \n- Use Whonix with either VirtualBox or Physical Isolation [5]. \n```\n\nSelect `Y` to to install any `maintainer` version of files\n```\nConfiguration file `/etc/whonix.d/30_whonixcheck_default'\n ==> Modified (by you or by a script) since installation.\n ==> Package distributor has shipped an updated version.\n   What would you like to do about it ?  Your options are:\n    Y or I  : install the package maintainer's version\n    N or O  : keep your currently-installed version\n      D     : show the differences between the versions\n      Z     : start a shell to examine the situation\n The default action is to keep your current version.\n*** 30_whonixcheck_default (Y/I/N/O/D/Z) [default=N] ? \n```\n\n```\nConfiguration file `/etc/apt/sources.list.d/qubes-r3.list'\n ==> Modified (by you or by a script) since installation.\n ==> Package distributor has shipped an updated version.\n   What would you like to do about it ?  Your options are:\n    Y or I  : install the package maintainer's version\n    N or O  : keep your currently-installed version\n      D     : show the differences between the versions\n      Z     : start a shell to examine the situation\n The default action is to keep your current version.\n*** qubes-r3.list (Y/I/N/O/D/Z) [default=N] ? \n```\n\n# Start the Whonix 10.0 upgrade\nAs stated above, enter `Y` for configuration file replacements, and Click `OK` if `whonixcheck` dialog appears\n`sudo apt-get dist-upgrade`\n\n# Exit status may look like the following:\n```\nErrors were encountered while processing:\n timezone-utc\nE: Sub-process /usr/bin/dpkg returned an error code (1)\n```\n\n# Fix timezone installation errors\n(Ignore `qubes-update-check.service failed` error.  Will be fixed upstream)\n`sudo apt-get install -f`\n```\nReading package lists... Done\nBuilding dependency tree       \nReading state information... Done\nThe following packages were automatically installed and are no longer required:\n  anon-gw-first-run-notice ksh libgtop2-7 libgtop2-common libsystemd-id128-0 libunique-3.0-0 nautilus-actions netcat-openbsd\n  spice-vdagent ucspi-tcp\nUse 'apt-get autoremove' to remove them.\n0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.\n1 not fully installed or removed.\nAfter this operation, 0 B of additional disk space will be used.\nSetting up timezone-utc (3:0.8-1) ...\nJob for qubes-update-check.service failed. See 'systemctl status qubes-update-check.service' and 'journalctl -xn' for details.\nE: Problem executing scripts DPkg::Post-Invoke 'systemctl start qubes-update-check.service'\nE: Sub-process returned an error code\n```\n\n# Remove configuration files that were backup up by dpkg\n`sudo rm /etc/whonix.d/30_whonixcheck_default.dpkg-old`\n\n# Disable `Whonix TEST repo` (select `stable`)\n`sudo whonix-setup-wizard repository`\n\n# Disable `qubes TEST repo`; comment out test repo (Insert '#' at beginning of line)\n`sudo vi /etc/apt/sources.list.d/qubes-r3.list`\n- or for r2\n`sudo vi /etc/apt/sources.list.d/qubes-r2.list`\n\n# Remove unneeded files\n`sudo apt-get autoremove`\n\n# Shutdown `template-vm`\n`sudo poweroff`\n"},{"author":"Patrick","date_created":1430403355,"date_modified":1430403355,"content":"I am not sure it's wise telling `testers` to enable the `developers` repository. That could break badly at some point. The `developers` repository is a playground for me to upload and install from packages where I am not 100% certain they are not going to break the package manager."},{"author":"nrgaway","date_created":1430436758,"date_modified":1430436758,"content":">>! In T288#4179, @Patrick wrote:\n> I am not sure it's wise telling `testers` to enable the `developers` repository. That could break badly at some point. The `developers` repository is a playground for me to upload and install from packages where I am not 100% certain they are not going to break the package manager.\n\nOkay.  So is the solution to move `whonix-qubes` to the testing repo now then?  If so please do that or provide an alternative solution so we can get this tested some more.\n\nI am satisfied with the manual upgrade procedure especially given that the `experimental` template did not take into consideration upgrading to major versions since I believe this is the first time I have seen where you could do that with Whonix since version 7 or 8.\n\nUsers who wish not to manually upgrade will be able to wait for a template update and just install it."},{"author":"Patrick","date_created":1430442031,"date_modified":1430442031,"content":"Yes. Done, migrated (copied) qubes-whonix 10.0.5-1 from developers to testers repository.\n\nWant to post a blog post? Otherwise I guess very few will notice these instructions. Got a blog account already?"},{"author":"nrgaway","date_created":1430443112,"date_modified":1430443112,"content":">>! In T288#4212, @Patrick wrote:\n> Yes. Done, migrated (copied) qubes-whonix 10.0.5-1 from developers to testers repository.\n> \n> Want to post a blog post? Otherwise I guess very few will notice these instructions. Got a blog account already?\n\nNot yet, we may have to end up moving it to stable sooner than expected...\n\nDoes an 'apt-get dist-upgrade' in `Whonix 9.6` update Whonix to `10.0`?  I am receiving reports of Qubes-Whonix users updates failing as of a few days ago.\n\nI am in the process of installing the original `ITL` `qubes-whonix-gateway-experimental` to test what is actually happening.  There can be 2 issues here, since some users repos will be set to use your `old repo` due to the `whonix-setup-wizard` bug, and `qubes-whonix` is not in that old repo as well.\n\nShould be done testing in 30 minutes... More to come..."},{"author":"Patrick","date_created":1430443686,"date_modified":1430443686,"content":"Link: \"stable vs wheezy repository\" bug T233\n\n> Does an 'apt-get dist-upgrade' in `Whonix 9.6` update Whonix to `10.0`?\n\nYes. (And that should work quite reliable, because the old package version was deprecated in whonixcheck Whonix News and users seem to upgrade. Otherwise they would panic about whonixcheck reporting them being outdated and not being able to upgrade.)\n"},{"author":"nrgaway","date_created":1430455848,"date_modified":1430455967,"content":"# What to do if you ran a `apt-get dist-upgrade` not using the `upgrade` method above\n\nOh no!  Your gateway will most likely be in some type of broken state, maybe some dialog's are popping up stating `Using Virtualizer xen xen-hvm together with Whonix is recommended against, because it is rarely tested.`, `timesysnc` dialog seems stuck and `tor` is stuck at bootstrapping at 5%.\n\nWith a little bit of patience and manual intervention, we can fix things up.\n\nFirst thing.  Start the `whonix-gateway-experimental` template; we need to get tor up and running again so we can update template properly.\n\nOpen a 'gnome-teminal' or 'xterm' session to the templatevm.  Either select 'terminal` from your `start` menu or in `qubes-manager` right-click the vm name, click on `Run command in VM`, then enter `gnome-terminal` or `xterm`.\n\nIn the template terminal type:\n```\nsudo cp -p /usr/bin/whonix_firewall /usr/bin/whonix_firewall.dist\nsudo sed -i 's/## IPv4 DROP INVALID INCOMING PACKAGES POST HOOK//' /usr/bin/whonix_firewall\nsudo poweroff\n```\n\nNow the Whonix Gateway AppVM should start properly (Don't worry about the `Using Virtualizer xen xen-hvm together with Whonix is recommended against, because it is rarely tested.` dialog box that may pop up; it will be taken care of once the upgrade to `Whonix 10` is complete.\n\nNow proceed with the update starting at the step labelled `In Whonix template-vm` in the first post listed above\n\nThis will all be sorted out once a couple of packages are moved from the `testing` to `stable` repos\n\n\n"},{"author":"Patrick","date_created":1430482861,"date_modified":1430482861,"content":"Your instructions sound good. I recommend to hit the edit button for instruction posts and to copy it over to the wiki https://www.whonix.org/wiki/Qubes/Upgrade_from_9_to_10 or so. Unfortunately, phabricator uses markdown and mediawiki uses mediawiki syntax.\n\nCan workstation templates also be upgraded that way?\n\n> What to do if you ran a `apt-get dist-upgrade` not using the `upgrade` method above\n\nInstructions from https://phabricator.whonix.org/T288#4171 contain `apt-get dist-upgrade` rather than `apt-get upgrade`.\n"},{"author":"nrgaway","date_created":1430536505,"date_modified":1430536505,"content":">>! In T288#4229, @Patrick wrote:\n> Your instructions sound good. I recommend to hit the edit button for instruction posts and to copy it over to the wiki https://www.whonix.org/wiki/Qubes/Upgrade_from_9_to_10 or so. Unfortunately, phabricator uses markdown and mediawiki uses mediawiki syntax.\n\nArgh :) We have to find someone to maintain the `Qubes Whoix` forum and wiki since @WhonixQubes has left us.  I really don't want to be managing those parts as I prefer to spend my time coding and such related things.  Maybe you can put an ad out looking to see if anyone interested in such a task.\n\nMaybe in the mean time, we can place a link in the `wiki` pointing to this task as it will allow me to be notified of any issues.  I have one user on Qubes mailing list confirm the upgrade procedure worked for them after a failed updated a few days ago (I added the second post for them and other users that will have that issue).\n\n> \n> Can workstation templates also be upgraded that way?\n> \n>> What to do if you ran a `apt-get dist-upgrade` not using the `upgrade` method above\n> \n> Instructions from https://phabricator.whonix.org/T288#4171 contain `apt-get dist-upgrade` rather than `apt-get upgrade`.\n\nThat's correct.  I specified an `apt-get dist-upgrade` purposely. `dist-upgrade` will allow additional packages to be installed that are not already installed and `upgrade` will only allow existing packages to be upgraded.  The `qubes-core-agent` contains additional dependencies that may not already be installed.  If only an `upgrade` were specified I would think the newest `qubes-core-agent` would not install, or fail, and therefore `qubes-whonix 10.0.5` would also not install since it depends on the former."},{"author":"Patrick","date_created":1430575162,"date_modified":1430575162,"content":"Can workstation templates also be upgraded that way? That's not clear from instructions.\n\n----\n\n>>! In T288#4256, @nrgaway wrote:\n> Argh :) We have to find someone to maintain the `Qubes Whoix` forum and wiki since @WhonixQubes has left us.  I really don't want to be managing those parts as I prefer to spend my time coding and such related things.  Maybe you can put an ad out looking to see if anyone interested in such a task.\n\n- blog post: https://www.whonix.org/blog/qubes-whonix-maintainer\n- wiki random news\n- forum news\n- social media\n \n>>! In T288#4256, @nrgaway wrote:\n> Maybe in the mean time, we can place a link in the `wiki` pointing to this task as it will allow me to be notified of any issues.  I have one user on Qubes mailing list confirm the upgrade procedure worked for them after a failed updated a few days ago (I added the second post for them and other users that will have that issue).\n\nYes.\n\n-----\n\n>>! In T288#4256, @nrgaway wrote:\n> That's correct.  I specified an `apt-get dist-upgrade` purposely. `dist-upgrade` will allow additional packages to be installed that are not already installed and `upgrade` will only allow existing packages to be upgraded.  The `qubes-core-agent` contains additional dependencies that may not already be installed.  If only an `upgrade` were specified I would think the newest `qubes-core-agent` would not install, or fail, and therefore `qubes-whonix 10.0.5` would also not install since it depends on the former.\n\nMakes sense. But it not what I meant. There was a misunderstanding by me about the following sentence.\n\n>>! In T288#4256, @nrgaway wrote:\n> What to do if you ran a apt-get dist-upgrade not using the upgrade method above\n\nTo make it unambiguous, please make that:\n\n> What to do if you ran a `apt-get dist-upgrade` not using the upgrade instructions above\n"},{"author":"nrgaway","date_created":1430619764,"date_modified":1430619764,"content":"# HOW TO RE-INSTALL `qubes-whonix`\n\n---\n\n# Apply these steps within the `whonix template`\n\n---\n\n### Re-enable Whonix `test` repository\n`sudo whonix-setup-wizard repository`\n\n### Update package index\n`sudo apt-get update`\n\n### Make sure `whonix_firewall` is patched\n`sudo sed -i 's/## IPv4 DROP INVALID INCOMING PACKAGES POST HOOK//' /usr/bin/whonix_firewall`\n\n### Re-install `qubes-whonix`\n`sudo apt-get install --reinstall qubes-whonix`\n\n### Re-enable Whonix `stable` repository\n`sudo whonix-setup-wizard repository`\n\n### Update package index\n`sudo apt-get update`\n\n### Shutdown both template and gateway VM\n\n\n# HOW TO SEE STATUS OF SOME SERVICES\n\n---\n\n```\nsudo systemctl status qubes-whonix-tor\nsudo systemctl status control-port-filter-python\n```"},{"author":"nrgaway","date_created":1433609222,"date_modified":1433609222,"content":"# Error when attempting to update in Whonix 10\n\nThere has been an issue reported in the forum ([[ https://www.whonix.org/forum/index.php/topic,1280.0.html | https://www.whonix.org/forum/index.php/topic,1280.0.html ]]) that prevents a user from using `apt-get` to update the system due to the following error:\n\n```\n    E: Malformed line 2 in source list /etc/apt/sources.list.d/qubes-r2.list (dist parse)\n    E: The list of sources could not be read.\n```\n\nYou will need to edit the `/etc/apt/sources.list.d/qubes-r2.list` file manually and add in `wheezy` like it shows in the following example. The following example is for release 3 of Qubes, but will work for release 2 as well; just do not change the version number in the file, only add in  `wheezy` to all the lines.\n\nYou need to be root to edit the file, so use `sudo`.  For example, using the `vi` editor:\n`sudo vi /etc/apt/sources.list.d/qubes-r2.list`\n\n```\n# Main qubes updates repository\ndeb [arch=amd64] http://deb.qubes-os.org/r3.0/vm wheezy main\ndeb-src http://deb.qubes-os.org/r3.0/vm wheezy main\n\n# Qubes updates candidates repository\ndeb [arch=amd64] http://deb.qubes-os.org/r3.0/vm wheezy-testing main\ndeb-src http://deb.qubes-os.org/r3.0/vm wheezy-testing main\n\n# Qubes experimental/unstable repository\n#deb [arch=amd64] http://deb.qubes-os.org/r3.0/vm wheezy-unstable main\n#deb-src http://deb.qubes-os.org/r3.0/vm wheezy-unstable main\n```\n\nNext run an `apt-get update` to confirm your changes."}]},"PHID-TASK-wpds5i5b23fmq3q5mwhf":{"id":"287","title":"A General Purpose PDF/Image Sanitizer","status":"invalid","priority":"Wishlist","author":"HulaHoop","description":"Whonix has some neat tools to manipulate and sanitize documentation like the Metadata Anonymization Toolkit. Adding a PDF sanitizer (and even an photo sanitizer) can add alot of value and improve workflow for journalists and others working with documents.\n\nIt is somewhat complex but we are not starting form scratch. Qubes has a series of bash scripts implementing these functions (see 1& 2). The point of modifying it is to make an improved edition that is hypervisor agnostic and and can work on air-gapped setups like physical whonix too.\nIdeally the client/server scripts would be unified into one package so both processes can be made available to a user running on a different VM platform.\n\nThe idea behind the choice of .rgb is, it can't carry any complex data that can trigger anything when parsed by ImageMagick compared to other formats.\n\nThe process:\n\nUntrusted vm [untrusted pdf > conversion to png > simple rgb format] > Transfer to trusted vm [simple rgb > reassemble back to png (2) > optional manual ocr operation (see 4 & 5) and cleanup (3) > A trusted fully searchable pdf]\n\n**Edit**: The scripts (2) support image files too.\n\n***\n\n**Edit**: The OCR and enhancement is out of scope for this script and it involves more tools. The primary purpose is to edit and repackage the scripts from the repo (2) into a disro neutral form.\n\nThe cleanup is about enhancing scanned printed material and adjusting it to make it better to read than originals and easier to process correctly by OCR. OCR is about restoring the searchability of pdfs that was lost when they were converted to a simpler format during sanitization.\n\nKonrad Voelkel's link recommended **scantailor** and **unpaper** for enhancing scanned images PDFs. Both are packaged for Debian. This step should be left manual and up to the user before finalizing conversion to trusted PDF.\n\nMicah's tool is too simple for the threat model that we are addressing. I'm mentioning his work becuase it talks about the redaction process during the PNG stage.\n\nBonus points for slapping on a GUI.\n\n\n1 http://theinvisiblethings.blogspot.com/2013/02/converting-untrusted-pdfs-into-trusted.html\n\n2 https://github.com/QubesOS/qubes-app-linux-pdf-converter\n\n3 http://www.fmwconcepts.com/imagemagick/textcleaner/\n\n4 http://www.konradvoelkel.com/2010/01/linux-ocr-and-pdf-problem-solved/\n\n5 http://www.konradvoelkel.com/2013/03/scan-to-pdfa/\n\n6 https://github.com/micahflee/pdf-redact-tools\n","comments":[{"author":"HulaHoop","date_created":1431701707,"date_modified":1431701707,"content":"I think the entire concept is flawed after reading this. There is no foolproof way of sanitization and a smart adversary can account for it and make sure their crafted code  survives format conversion and still ends up in the saved PNG. Untrusted data should always be handled in a VM period.\n\nhttps://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/ \n\n>Some conclusions\n>\n>Placing shells in IDAT chunks has some big advantages and should bypass most data validation techniques where applications resize or re-encode uploaded images. You can even upload the above payloads as GIFs or JPEGs etc. as long as the final image is saved as a PNG.\n>\n>There are probably some better techniques you could use to hide the shell more convincingly and short of scanning each uploaded image for a shell there is probably not much you can do as a developer to stop it. I'd imagine that encoding a shell into a lossy format such as JPEG could be substantially harder - but probably not impossible.\""},{"author":"Patrick","date_created":1431702568,"date_modified":1431702568,"content":"[Qubes converts those to bitmaps, not pngs.](http://theinvisiblethings.blogspot.de/2013/02/converting-untrusted-pdfs-into-trusted.html) Does it still apply?"},{"author":"HulaHoop","date_created":1431723706,"date_modified":1431723706,"content":"tl;dr Yes  it does.\n\nIt involves encoding the payload byte sequences in the RGB bitmap in such a way as to have it form a malicious string when passed through the  PNG filters and compression algorithm. A PNG is technically an RGB bitmap with metadata and compression applied. The post describes how the payload stays intact even if resized, rotated, stripped of their metadata or encoded into other file formats.\n\nThis is just as applicable with any other format besides PNG although it needs more time.\n"}]},"PHID-TASK-qjdqj6to5fzvvgyu4j5h":{"id":"286","title":"Only source configuration files that end with the `.conf` extension?","status":"resolved","priority":"Normal","author":"Patrick","description":">>! In T275#4134, @nrgaway wrote:\n> XXX: @Patrick, do your scripts ignore backed up files in directories such as `/etc/whonix_firewall.d...`. If not, maybe consider using a standard extension of `.conf` and only include those?\n\nFiles that end with `~` are ignored (backup files by many editors). Files that end with `.dpkg-*` are ignored (file names used by dpkg conflict resolution). So you could rename these files for example to `.dpkg-nouse`.\n\nDo we want to rename all the config files to include a `.conf` extension and then only source those? Any opinions?\n\nExisting documentation:\nhttps://www.whonix.org/wiki/Whonix_Configuration_Files\n\nThe config folder `source`ing code for #whonix-gw-firewall be viewed here:\nhttps://github.com/Whonix/whonix-gw-firewall/blob/master/usr/bin/whonix_firewall#L27\nhttps://github.com/Whonix/whonix-gw-firewall/blob/5ebca43416269a5fd42c98a80af1b0b3d38adecf/usr/bin/whonix_firewall#L27\n\nOthers for #whonixcheck etc. look similar.","comments":[{"author":"Patrick","date_created":1448913382,"date_modified":1448913382,"content":"```\nOnly source configuration files that end with the '.conf' extension.\n\nThanks to @nrgaway for the suggestion!\n\nhttps://phabricator.whonix.org/T286\n```\nhttps://github.com/Whonix/control-port-filter-python/commit/4280a718558f776bfac8b5b2fce3a13bd021fe5c @troubadour\nhttps://github.com/Whonix/open-link-confirmation/commit/0b6c0f212df08fb4fae06c86cc0abbab6abfdbb5\nhttps://github.com/Whonix/qubes-whonix/commit/8282d2cef8cb8a22033594a1164395373e4dfced\nhttps://github.com/Whonix/rads/commit/9e462bbe39fe5dfbcf9ed841c482803a21c9fd24\nhttps://github.com/Whonix/sdwdate/commit/47e9a0eb84fd184ac799b0d48b9ccc67d55db747 @troubadour\nhttps://github.com/Whonix/tb-starter/commit/d4c9822e6c08a15c89d2aa02dc60fd59cb6f3996\nhttps://github.com/Whonix/tb-updater/commit/9ee254e4ab2deabe85953ba00f5dd4e829545cfa\nhttps://github.com/Whonix/uwt/commit/4dd48f16329d9701d8d86c3dc4931251a15372c6\nhttps://github.com/Whonix/whonix-gw-firewall/commit/eafa4a9f7ec30b706597c88fccd22506691dfb69\nhttps://github.com/Whonix/whonix-ws-firewall/commit/24baec332e1040056888cd0522760b4134b2920a\nhttps://github.com/Whonix/whonix-host-firewall/commit/e6caaa761b2a08569419a2c9756d133452fd256a\nhttps://github.com/Whonix/whonixcheck/commit/afe9aad6aa25e7577442478ce8f1117b76f86bfe\n\nCan you please check the #control-port-filter-python and #sdwdate commits? @troubadour?"},{"author":"Patrick","date_created":1448920534,"date_modified":1448920534,"content":"https://github.com/Whonix/Whonix/commit/1340726a83e5e02fe5e355cd20620d04335024c4"},{"author":"Patrick","date_created":1461811756,"date_modified":1461811756,"content":"Since T503 is not yet implemented, Whonix 12 -> Whonix 13 are currently broken because of #uwt. #whonix-repository and #tb-updater fails closed because the moment it uses `gpg`, `/etc/uwt.d/30_uwt_default.conf` does not exist, which results in \"`gpg`\" (actually `uwt`) failing. The solution I will be attempting is to make #uwt also work with built-in defaults (part of T503)."},{"author":"Patrick","date_created":1461812858,"date_modified":1461812858,"content":"https://github.com/Whonix/uwt/commit/651d2af8417fb0b7f77a88493a37935972ed444b"},{"author":"Patrick","date_created":1461891044,"date_modified":1461891044,"content":">>! In T286#8987, @Patrick wrote:\n> https://github.com/Whonix/uwt/commit/651d2af8417fb0b7f77a88493a37935972ed444b\n\nWorks."},{"author":"Patrick","date_created":1461902114,"date_modified":1461902114,"content":"https://github.com/Whonix/sdwdate/commit/0a0436b2de152ca13445c368fbd7cb95d339c75a\n"}]},"PHID-TASK-66ycdfz2uhr3t357jjpr":{"id":"285","title":"remove anon-gw-first-run-notice from source tree because replaced by whonix-setup-wizard","status":"resolved","priority":"Normal","author":"Patrick","description":"anon-gw-first-run-notice has been replaced by #whonix-setup-wizard. Therefore it should be removed from `./packages` folder.\n\nWe also don't install it anymore since Whonix 10 by default.","comments":[{"author":"Patrick","date_created":1430249160,"date_modified":1430249160,"content":"`Removed anon-gw-first-run-notice from source tree because replaced by whonix-setup-wizard.\nanon-gw-first-run-notice has been replaced by whonix-setup-wizard. Therefore it should was removed from ./packages folder.\nWe also don't install it anymore since Whonix 10 by default.`:\nhttps://github.com/Whonix/Whonix/commit/b15a295922810760c55cf92856cae1577188ef6f"}]},"PHID-TASK-6ao5us2bff6ct2tf3gqf":{"id":"284","title":"no longer install acpi-support-base by default on jessie","status":"resolved","priority":"Normal","author":"Patrick","description":"Because systemd now implements that functionality.\n\nAs per:\n* https://github.com/grml/grml-debootstrap/issues/76\n* https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=783247\n","comments":[{"author":"Patrick","date_created":1430156702,"date_modified":1430156702,"content":"`No longer install acpi-support-base by default on jessie, because systemd now implements that functionality. - https://phabricator.whonix.org/T284`:\nhttps://github.com/Whonix/Whonix/commit/838ff7c08b7626510579afa0e57928317bf3cdaf"}]},"PHID-TASK-4zxkreyopstshtgby6nj":{"id":"283","title":"tb-updater's download confirmation screen multiple version numbers info msg not shown on first run","status":"resolved","priority":"Normal","author":"Patrick","description":"Follow up task of T214.\n\n> Only versions still considered secure should be listed here. Higher version numbers does not necessarily mean more secure here. Could be alpha or beta versions. In most cases you are best off choosing the lowest version number among them.\n\nThat message does not show, if no Tor Browser is installed. I.e not when running tb-updater for the first time.","comments":[{"author":"Patrick","date_created":1430156286,"date_modified":1430156286,"content":"`- tb-updater: show \"highest version number is not necessarily the best one\" message also on first run if no Tor Browser is installed yet - https://phabricator.whonix.org/T283`:\nhttps://github.com/Whonix/tb-updater/commit/4aa6c996e972cf374ece96b785eb5d132618800a"}]},"PHID-TASK-qpwj2elr2cmbgvpmjsc5":{"id":"282","title":"modify apt-get parameters during build to prevent need to remove apt-listchanges","status":"resolved","priority":"Normal","author":"Patrick","description":">>! In T278#4002, @nrgaway wrote:\n> Since I ran `whonix_build` next after `debootstrap` I did not have to uninstall `apt-listchanges`.  I mention this since you may want to consider modifying your `apt-get` parameters to some of the ones I use that prevent the need to uninstall `apt-listchanges`:\n> \n> ```\n> DEBIAN_FRONTEND=\"noninteractive\" DEBIAN_PRIORITY=\"critical\" DEBCONF_NOWARNINGS=\"yes\" \\\n>         chroot apt-get ${APT_GET_OPTIONS} install ${files[@]}\n> ```","comments":[{"author":"Patrick","date_created":1430146678,"date_modified":1430146678,"content":"Environment `DEBIAN_FRONTEND=\"noninteractive\"` was already the case.\n\nAdded to environment:\n```\nDEBIAN_PRIORITY=\"critical\"\nDEBCONF_NOWARNINGS=\"yes\"\n```\n\n`added environment variables DEBIAN_PRIORITY=\"critical\" and DEBCONF_NOWARNINGS=\"yes\" as suggested by @nrgaway - https://phabricator.whonix.org/T282`:\nhttps://github.com/Whonix/Whonix/commit/bf74cf3353e88a8a503b959dadd9ecb44d980288\n\n-----\n\nWhat's inside the `APT_GET_OPTIONS` variable?\n\nAre there any other missing parameters you recommend adding, @nrgaway?"},{"author":"nrgaway","date_created":1430169874,"date_modified":1430169874,"content":">>! In T282#4029, @Patrick wrote:\n> Environment `DEBIAN_FRONTEND=\"noninteractive\"` was already the case.\n> \n> Added to environment:\n> ```\n> DEBIAN_PRIORITY=\"critical\"\n> DEBCONF_NOWARNINGS=\"yes\"\n> ```\n> \n> `added environment variables DEBIAN_PRIORITY=\"critical\" and DEBCONF_NOWARNINGS=\"yes\" as suggested by @nrgaway - https://phabricator.whonix.org/T282`:\n> https://github.com/Whonix/Whonix/commit/bf74cf3353e88a8a503b959dadd9ecb44d980288\n> \n> -----\n> \n> What's inside the `APT_GET_OPTIONS` variable?\n> \n> Are there any other missing parameters you recommend adding, @nrgaway?\n\nThe options are fairly basic...\n```\n# ------------------------------------------------------------------------------\n# apt-get configuration options\n# ------------------------------------------------------------------------------\nAPT_GET_OPTIONS=\"-o Dpkg::Options::=\"--force-confnew\" --force-yes --yes\"\n\ncontainsFlavor 'no-recommends' && {\n    APT_GET_OPTIONS+=\" -o APT::Install-Recommends=0  -o APT::Install-Suggests=0\" \n} || true\n```"},{"author":"Patrick","date_created":1430175233,"date_modified":1430175233,"content":"Okay, so let's go through this one by one.\n\n* Combination of `--force-yes` and `--yes` is insecure. Reported a bug: https://groups.google.com/forum/#!topic/qubes-devel/akv5B7TgRFQ (I know that you already know this, because you answered on the mailing list, but I am speaking so that any technical person can track this, and to keep a record for later.)\n* `--yes`: using that already\n* `-o APT::Install-Recommends=0` using the equivalent `--no-install-recommends` already\n* `-o APT::Install-Suggests=0` that's the default anyhow [and very unlikely to change in Debian, I think), so it it is superfluous, not making a difference, not using it\n* `-o Dpkg::Options::=\"--force-confnew\"`: This is TODO. Need to think about that one."},{"author":"nrgaway","date_created":1430189005,"date_modified":1430189005,"content":"`-o Dpkg::Options::=\"--force-confnew\"`: This is TODO. Need to think about that one.\n\nYou may not need that one.  Qubes over-rides 2 configuration files so it is required for unattended installations of initially creating the templates.  \n\nThe option does show an indication that it replaced a configuration file and also backs up the old one."},{"author":"Patrick","date_created":1430246779,"date_modified":1430246779,"content":"Yes. I'd rather not add `-o Dpkg::Options::=\"--force-confnew\"` if not needed, because also `whonix-developer-meta-files/debug-steps/locally-upgrade-whonix-debian-packages` uses `help-steps/variables`. Easier code and less to think through. We can still do it if needed one day.\n\nI've succeeded with a build where apt-listchanges was installed by default. It went through without any interactive questions.\n\nJust to make sure, added another environment variable.\n`add APT_LISTCHANGES_FRONTEND=\"text\" to environment during build - https://phabricator.whonix.org/T282`:\nhttps://github.com/Whonix/Whonix/commit/38301f244d0c709fe5fe57c7b079d947ea61f14b\n\nEverything done here? This one should be closeable?"},{"author":"nrgaway","date_created":1430256122,"date_modified":1430256122,"content":"Great.  Will this be part of Whonix 10? "},{"author":"Patrick","date_created":1430258207,"date_modified":1430258207,"content":"No."},{"author":"Patrick","date_created":1430258228,"date_modified":1430258228,"content":"Whonix 10 is out. Will be part of Whonix 11."}]},"PHID-TASK-4bi7sxblxvi5j5vp6kk2":{"id":"281","title":"lintian warnings when building packages on jessie","status":"resolved","priority":"Normal","author":"Patrick","description":"There are quite a few new lintian warnings when building Whonix packages on jessie, because it comes with a newer lintian.\n\nTODO:\n* Let's fix those.\n* Then make lintian fail closed again. (Undo T280.)\n\nRelated:\n* T277\n","comments":[{"author":"Patrick","date_created":1430231369,"date_modified":1430231369,"content":"In progress.\n\n`added 'Keywords=' to '.desktop' files to fix lintian warning 'desktop-entry-lacks-keywords-entry' - https://phabricator.whonix.org/T281`:\nhttps://github.com/Whonix/whonix-setup-wizard/commit/ce89f2cab08e9f68c8977768b33dbd2c0c95b4b2\n(FYI @troubadour)\n\nMany more of that kind and some other lintian warnings."},{"author":"Patrick","date_created":1430407008,"date_modified":1430407008,"content":"All lintian warnings fixed in Whonix `11.0.0.0.5-developers-only` and made lintian fail closed again. (Except for T186.)"}]},"PHID-TASK-gmnuhvb3sf42gg74nudd":{"id":"280","title":"building packages on jessie broken due to genmkfile -> lintian warnings","status":"resolved","priority":"High","author":"Patrick","description":"Let's temporarily let lintian fail open or not run lintian?","comments":[{"author":"Patrick","date_created":1430147037,"date_modified":1430147037,"content":"Let's let it fail open so we have a reminder, motivation, notification to actually fix those.\n\n`let genmkfile -> lintian fail open until we fixed all the new lintian warnings in jessie - https://phabricator.whonix.org/T280`:\nhttps://github.com/Whonix/Whonix/commit/9e0320d8e73aff5c94c52237875970cb687f875f\n\nFollow up task:\nT281"}]},"PHID-TASK-m4arqcqg37ayt34kpgsy":{"id":"279","title":"build-steps.d/1200_create-debian-packages does not obey make_use_lintian environment variable","status":"resolved","priority":"High","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1430094099,"date_modified":1430094099,"content":"Fixed:\nhttps://github.com/Whonix/Whonix/commit/d671b8b085d8a008704513cf4c1d1270749749c2\n"}]},"PHID-TASK-x5gw7rfkg76j2vhjw4ro":{"id":"278","title":"building Whonix11 for qubes-whonix: Package installation errors","status":"resolved","priority":"High","author":"nrgaway","description":"I am getting errors like these:\n```\nThe following packages have unmet dependencies:\n network-manager : Depends: libpam-systemd but it is not going to be installed\n                   Depends: policykit-1 but it is not going to be installed\nE: Unable to correct problems, you have held broken packages.\n```\n\nMy build script looks like this:\n\nThis script is called first so I can set some stuff up as sudo user before calling the actual build script:\n```\n# Pre Fixups\nsudo mkdir -p /boot/grub2\nsudo touch /boot/grub2/grub.cfg\nsudo mkdir -p /boot/grub\nsudo touch /boot/grub/grub.cfg\nsudo mkdir --parents --mode=g+rw \"/tmp/uwt\"\n\n# Whonix seems to re-install sysvinit even though there is a hold\n# on the package.  Things seem to work anyway. BUT hopfully the\n# hold on grub* don't get removed\nsudo apt-mark hold sysvinit\nsudo apt-mark hold grub-pc grub-pc-bin grub-common grub2-common\n\n# Whonix expects haveged to be started\nsudo /etc/init.d/haveged start\n\nsudo ~/whonix_build_post $@\n```\n\nThen this is called (`whonix_build_post`)\n```\n#!/bin/bash -e\n# vim: set ts=4 sw=4 sts=4 et :\n\nexport WHONIX_BUILD_UNATTENDED_PKG_INSTALL=\"1\"\n\n# Whonix 11 Hacks (stretch does not exist)\nexport whonix_build_apt_newer_release_codename=\"jessie\"\n\n# Make sure we clear Qubes overrides of these vars\n#export GENMKFILE_INCLUDE_FILE_MAIN=\n#export GENMKFILE_BOOTSTRAP=\n\n# Prevents Whonix makefile use of shared memory 'sem_open: Permission denied'\necho tmpfs /dev/shm tmpfs defaults 0 0 >> /etc/fstab\nmount /dev/shm\n\n#    --freshness current \\\n\npushd /home/user/Whonix\n/home/user/Whonix/whonix_build \\\n    --flavor $1 \\\n    -- \\\n    --build \\\n    --arch amd64 \\\n    --kernel linux-image-amd64 \\\n    --headers linux-headers-amd64 \\\n    --target root \\\n    --report minimal \\\n    --verifiable minimal \\\n    --allow-uncommitted true \\\n    --sanity-tests false || { exit 1; }\npopd\n```","comments":[{"author":"Patrick","date_created":1430096370,"date_modified":1430096370,"content":"Minor stuff:\n* Note, there was a fix for genmkfile today. But that's probably not your issue here.\n* `export whonix_build_apt_newer_release_codename=\"jessie\"` workaround will be no longer needed soon, fixed here: https://github.com/Whonix/Whonix/commit/34b042ac565056a5da67e2140a5d1a50f31d9b98\n* `export WHONIX_BUILD_UNATTENDED_PKG_INSTALL=\"1\"` is the default anyhow, no need to set it?\n\nProbably Qubes specific? Because I just succeeded package installation step with `Whonix-Gateway-11.0.0.0.1-5-gc94a68696170a5febe680a92452eadb33743c485`. A real tag is coming soon. Just wanted to try with early help fixing this.\n\nIf you like my help, you can try providing a full build log, because by the current information provided I don't know what could be causing this."},{"author":"nrgaway","date_created":1430096882,"date_modified":1430096882,"content":"Is there a way to build with `current sources`?  That may solve the issue.  \n\nQubes components are built with `current-sources` and may also require `current-sources for Whonix` although its too early to tell.  When we are at a point that I can build with both `frozen` (which do not exist for jessie) and `current-sources`, I will be able to determine that.\n\nI also do realize there is a debate over which method is better, `frozen` or `current` which seems to tend to go either way based on opinion.  In relation to Qubes, I tend to lean in favour of `current sources`, but provide an option to build with `frozen sources` since as stated Qubes is currently built with `current sources` for **all distributions and packages** and Marek keeps up with security patches.  Also the use case and threat model is different from a VirtualBox environment.\n\nI do not wish to enter such a debate within this task, but am open to discussing it within a thread on the forums if anyone has any views on this especially in relation to QubesOS where considerations can be taken into the already present security model of Qubes since I think reasonings from that discussion could differ from previous discussions on the matter.\n\nCurrently, I would be most please to just get past the build install errors and test next with current sources.  \n\nQuestions:\n  1. What is the purpose of `whonix_build_apt_newer_release_codename`.  By default it was set to `stretch` which gave build errors so I set it to `jessie`\n\n  2. What is required to use the `current sources`.\n\n  3. Is the definition of `current sources` that is uses the standard `main` Debian repos?\n"},{"author":"nrgaway","date_created":1430097214,"date_modified":1430097214,"content":">>! In T278#3998, @Patrick wrote:\n> Minor stuff:\n> * Note, there was a fix for genmkfile today. But that's probably not your issue here.\n> * `export whonix_build_apt_newer_release_codename=\"jessie\"` workaround will be no longer needed soon, fixed here: https://github.com/Whonix/Whonix/commit/34b042ac565056a5da67e2140a5d1a50f31d9b98\n\n:)\n\n> * `export WHONIX_BUILD_UNATTENDED_PKG_INSTALL=\"1\"` is the default anyhow, no need to set it?\n\nGreat, will remove it\n\n> Probably Qubes specific? Because I just succeeded package installation step with `Whonix-Gateway-11.0.0.0.1-5-gc94a68696170a5febe680a92452eadb33743c485`. A real tag is coming soon. Just wanted to try with early help fixing this.\n\nGood, I will also try it.  I am not sure what the issue may be at the moment.  I am building a base Debian system using `debootstrap` then install a few packages to prep Whonix, then use a `chroot` environment to build `Whonix`.\n\n> If you like my help, you can try providing a full build log, because by the current information provided I don't know what could be causing this.\n\nThank you.  Where would this build log be found, or should I redirect screen output to file?\n\nWhere / how should I send it?\n"},{"author":"Patrick","date_created":1430100375,"date_modified":1430100375,"content":"1. Was a bug that is now fixed (https://github.com/Whonix/Whonix/commit/34b042ac565056a5da67e2140a5d1a50f31d9b98) in latest master. [And soon a new tag.] Related to `build-steps.d/1100_prepare-build-machine`. The purpose was to be able to install packages from a newer codename. On `wheezy` we needed to install a few packages from `jessie`. That's what `whonix_build_apt_newer_release_codename` was good for. What will it be good for? I hope it can be avoided, but I could imagine at some point while we're `jessie` based, we may need to install packages from `stretch`. I am not sure about it and I was thinking about removing that build script feature.\n\n-----\n\n2. Frozen vs Current Sources, it should all be possible already. I made a detailed answer in the forums already. See:\nhttps://www.whonix.org/forum/index.php/topic,1167.msg7892.html#msg7892\nPlease add if there are any follow up questions.\n\nFor a pros and cons of Frozen vs Current Sources, see https://www.whonix.org/wiki/Dev/Build_Documentation/9_full#CurrentSources_Builds_.28Optional.29 and click expand.\n\nThe discussion thread of Frozen vs Current Sources could be this one:\nhttps://www.whonix.org/forum/index.php/topic,1052.0.html\n\n(It's not about VirtualBox vs non-VirtualBox at all. Same pros / cons for any image.)\n\n-----\n\n3. No. Current Sources is the regular repository. Frozen Sources is a specific snapshot from snapshot.debian.org.\n\n`main`, `contrib`, `non-free` are called components (as per Debian apt sources.list terminology). Has nothing to do with Current vs Frozen Sources.\n\n-----\n\nJust set your `Konsole` (if you are using that) to unlimited scrollback (gui, profile settings) and then use the gui to save the whole log. Or similar. You can try pasting it in here surrounded by the usual code tags. Or in the forums using code tags. Or on some free paste service. Another option is to use regular redirections to store the log into a file. `>> ~/log 2>&1` Then `tail -f ~/log` in another terminal. Doesn't really matter where / how. The log just somehow needs to materialize somewhere."},{"author":"nrgaway","date_created":1430126681,"date_modified":1430126681,"content":"I have been about to get `Whonix 11` to successfully build using the `11.0.0.0.1-developers-only` tag (since `submodules` seemed broken on `master` branch), although the build process kept asking for input starting at `line 450 of 1700_install-packages` and all the way until it exited.  I just kept entering `c` manually since by that stage everything had already been installed:\n```\n# 1700_install-packages:450 --> \"$WHONIX_SOURCE_HELP_STEPS_FOLDER/remove-local-temp-apt-repo\"\nINFO: Setting... export UWT_DEV_PASSTHROUGH=\"1\"\nINFO: Variable anon_dist_build_version was already set to: 11.0.0.0.1\n/home/user/Whonix/help-steps/pre: line 20: error_: command not found\n...\n+ true 'INFO: Currently running script: /home/user/Whonix/help-steps/unprevent-daemons-from-starting '\n+ true 'INFO: Currently running script: /home/user/Whonix/help-steps/unchroot-raw '\n+ true 'INFO: Skipping script, because ANON_BUILD_INSTALL_TO_ROOT=1: /home/user/Whonix/help-steps/unmount-raw'\n+ true 'INFO: Currently running script: ././build-steps.d/2300_run-chroot-scripts-post-d '\n```\n\nIn order to prevent the original build dependencies as described in task details, I had to make sure Whonix was installed directly after debootstrap.  Normally I would have installed the base Debian system as distributed before running Whonix build. The build process seems intolerant to unknown packages.  This seems acceptable since I was able to build Whonix, and update with Qubes required packages afterwards.\n\nSince I ran `whonix_build` next after `debootstrap` I did not have to uninstall `apt-listchanges`.  I mention this since you may want to consider modifying your `apt-get` parameters to some of the ones I use that prevent the need to uninstall `apt-listchanges`:\n\n```\nDEBIAN_FRONTEND=\"noninteractive\" DEBIAN_PRIORITY=\"critical\" DEBCONF_NOWARNINGS=\"yes\" \\\n        chroot apt-get ${APT_GET_OPTIONS} install ${files[@]}\n```\n\nAfter building I was able to also successfully run the `gateway` and `workstation`.  \n\n`Gateway` issues included the following:\n1. torsocks errors:\n```\n[Apr 27 08:05:16] WARNING torsocks[31405]: [syscall] Unsupported syscall number 202. Denying the call (in tsocks_syscall() at syscall.c:165)\n```\n\n2. gpg issues?:\n\n```\n## error_cause: error_handler called with error_text: /usr/bin/whonixcheck script bug Please report this bug!\nBASH_COMMAND: gpg_bash_lib_output_gpg_import_output=\"$( gpg --no-options --ignore-time-conflict\n--homedir \"$gpg_bash_lib_input_temp_folder\" --import \"$gpg_bash_lib_internal_key\" 2>&1 )\" exit_code: 1\n----- gpg_bash_lib_output_diagnostic_message: gpg_bash_lib_internal_gpg_verify_status_fd_file:\n/tmp/tmp.7NYjOmRiLu/news_verify_dir/news_gpg/gpg_bash_lib_internal_gpg_verify_status_fd_file\ngpg_bash_lib_internal_gpg_verify_output_file: /tmp/tmp.7NYjOmRiLu/news_verify_dir/news_gpg\ngpg_bash_lib_internal_gpg_verify_output_file gpg_bash_lib_output_gpg_import_output: mktemp: failed to\ncreate file via template '/tmp/uwt/tmp.XXXXXXXXXX': Permission denied mktemp failed with exit code 0!\ngpg_bash_lib_output_gpg_verify_output: gpg_bash_lib_output_gpg_verify_status_fd_output:\n\n```\n\n`Workstation` issues included the following:\nSame `gpg?` issue\nTor Browser downloaded successfully, but also received some gpg error\n\nBoth Whonix10 and 11 had some strange display issues in regards to dialog boxes that pop up.  Some of the dialog boxes are partially transparent and seem not to be receiving proper focus until clicked on and some time three quartes of the dialog is transparent when the other quarter is normal, and the smaller dialogs seems to have the bottom two corners transparent as well until focus is gained.\n\nI have done some research and such a bug has been reported 6 weeks ago to kde as other applications are also having same issue.  I am going to also going to build a gnome workstation and see if that makes any difference, since the bug was said not to effect gnome.  It could also just be my windows manager; guess that's something @WhonixQubes can also look for when testing (which can be done when the required qubes component is re-released with fix for wheezy)\n\nIt time for me to get some sleep, but now that this builds, I can start testing with it so later today I will first finish off the issues regarding the `replace-ip` regression and a few others and then package up `control-port-filter-python`."},{"author":"WhonixQubes","date_created":1430132923,"date_modified":1430133084,"content":""},{"author":"WhonixQubes","date_created":1430133192,"date_modified":1430133192,"content":">>! In T278#4002, @nrgaway wrote:\n> Both Whonix10 and 11 had some strange display issues in regards to dialog boxes that pop up.  Some of the dialog boxes are partially transparent and seem not to be receiving proper focus until clicked on and some time three quartes of the dialog is transparent when the other quarter is normal, and the smaller dialogs seems to have the bottom two corners transparent as well until focus is gained.\n\n\nYes...\n\nI believe I have already experienced this same transparent focus dialog issue too a few weeks ago.\n\nBut I think I saw it with Whonix 9.6 KDE inside of a Qubes R2 HVM."},{"author":"Patrick","date_created":1430146108,"date_modified":1430146108,"content":">>! In T278#4002, @nrgaway wrote:\n> I have been about to get `Whonix 11` to successfully build using the `11.0.0.0.1-developers-only` tag (since `submodules` seemed broken on `master` branch)\n\nYes. That should now be fixed. (I was mass bumping debian/control Standards-Version to fix a lintian warning and did not push all the packages by that time. Will also need to mass bump package versions after fixing T281.)\n\n> In order to prevent the original build dependencies as described in task details, I had to make sure Whonix was installed directly after debootstrap.\n\nInteresting. Well, that's how Whonix raw images are usually build outside of Qubes build process. That's why something else might not work. Not tested before. Got a related question about that:\nhttps://www.whonix.org/forum/index.php/topic,1187.0.html\n\n> Normally I would have installed the base Debian system as distributed before running Whonix build. The build process seems intolerant to unknown packages.  \n\nIntolerant, well. Implicitly intolerant. That's a bug. There is no explicit counter measure or so. I'd be interested to fix it and/or to take patches. A full build log would be required here.\n\n> This seems acceptable since I was able to build Whonix, and update with Qubes required packages afterwards.\n\nAlright.\n \n> Since I ran `whonix_build` next after `debootstrap` I did not have to uninstall `apt-listchanges`.  I mention this since you may want to consider modifying your `apt-get` parameters to some of the ones I use that prevent the need to uninstall `apt-listchanges`:\n\nYou bet I am interested in that. I dislike glitches, baggage such as \"apt-listchanges should not be installed\". That piles up. I want to do that soon for Whonix 11. Created T282 for it where I have a question.\n\n> After building I was able to also successfully run the `gateway` and `workstation`.  \n> \n> `Gateway` issues included the following:\n> 1. torsocks errors:\n> ```\n> [Apr 27 08:05:16] WARNING torsocks[31405]: [syscall] Unsupported syscall number 202. Denying the call (in tsocks_syscall() at syscall.c:165)\n> ```\n\nNeeds a separate ticket and instructions on how to reproduce. Possibly a log.\n \n> 2. gpg issues?:\n> \n> ```\n> ## error_cause: error_handler called with error_text: /usr/bin/whonixcheck script bug Please report this bug!\n> BASH_COMMAND: gpg_bash_lib_output_gpg_import_output=\"$( gpg --no-options --ignore-time-conflict\n> --homedir \"$gpg_bash_lib_input_temp_folder\" --import \"$gpg_bash_lib_internal_key\" 2>&1 )\" exit_code: 1\n> ----- gpg_bash_lib_output_diagnostic_message: gpg_bash_lib_internal_gpg_verify_status_fd_file:\n> /tmp/tmp.7NYjOmRiLu/news_verify_dir/news_gpg/gpg_bash_lib_internal_gpg_verify_status_fd_file\n> gpg_bash_lib_internal_gpg_verify_output_file: /tmp/tmp.7NYjOmRiLu/news_verify_dir/news_gpg\n> gpg_bash_lib_internal_gpg_verify_output_file gpg_bash_lib_output_gpg_import_output: mktemp: failed to\n> create file via template '/tmp/uwt/tmp.XXXXXXXXXX': Permission denied mktemp failed with exit code 0!\n> gpg_bash_lib_output_gpg_verify_output: gpg_bash_lib_output_gpg_verify_status_fd_output:\n> \n> ```\n\nNeeds a separate ticket. Please attach the output of the following two commands.\n\n```\nwhonixcheck --function download_whonix_news\n```\n\n```\nbash -x whonixcheck --function download_whonix_news\n``` \n\n> `Workstation` issues included the following:\n> Same `gpg?` issue\n> Tor Browser downloaded successfully, but also received some gpg error\n\nNot sure if it's the same `gpg` issue. Possibly be a bug in #gpg-bash-lib.\n\nNeeds a separate ticket. Please attach the output of the following two commands.\n\n```\nupdate-torbrowser --input gui\n```\n\n```\nbash -x update-torbrowser --input gui\n```\n"},{"author":"Patrick","date_created":1430173294,"date_modified":1430173294,"content":"You know this thread already? https://www.whonix.org/forum/index.php/topic,1040.msg7941.html#msg7941\nShort: `11.0.0.0.2-developers-only` is a tag that works for me (build succeeded). Hth."},{"author":"nrgaway","date_created":1430173808,"date_modified":1430173808,"content":">>! In T278#4074, @Patrick wrote:\n> You know this thread already? https://www.whonix.org/forum/index.php/topic,1040.msg7941.html#msg7941\n> Short: `11.0.0.0.2-developers-only` is a tag that works for me (build succeeded). Hth.\n\nYes, thank you.  I have been following that thread."},{"author":"Patrick","date_created":1430405983,"date_modified":1430405983,"content":"1. torsocks: This is most likely something we have to live with. It happens because the uwt wrapper adds torsocks before invoking apt-get for stream isolation. And torsocks generates this noise. It's something we need to document as a known issue and to report upstream against torsocks. Only alternative would be not using stream isolation for apt-get or finding some alternative way to point it to a socks port. Unfortunately, apt-get does not support socks proxy settings. (`Acquire::socks::proxy` is a myth in forums. That string can neither be found in apt's source code nor do apt developers claim to have implemented it.)\n2. whonixcheck gpg issue: I was unable to reproduce this in 11.0.0.0.3.\n3. tb-updater gpg issue: Same as above.\n\n-----\n\nIs there anything left to do in this very ticket?"},{"author":"nrgaway","date_created":1430432468,"date_modified":1430432468,"content":">>! In T278#4002, @nrgaway wrote:\n> I have been about to get `Whonix 11` to successfully build using the `11.0.0.0.1-developers-only` tag (since `submodules` seemed broken on `master` branch), although the build process kept asking for input starting at `line 450 of 1700_install-packages` and all the way until it exited.  I just kept entering `c` manually since by that stage everything had already been installed:\n> ```\n> # 1700_install-packages:450 --> \"$WHONIX_SOURCE_HELP_STEPS_FOLDER/remove-local-temp-apt-repo\"\n> INFO: Setting... export UWT_DEV_PASSTHROUGH=\"1\"\n> INFO: Variable anon_dist_build_version was already set to: 11.0.0.0.1\n> /home/user/Whonix/help-steps/pre: line 20: error_: command not found\n> ...\n> + true 'INFO: Currently running script: /home/user/Whonix/help-steps/unprevent-daemons-from-starting '\n> + true 'INFO: Currently running script: /home/user/Whonix/help-steps/unchroot-raw '\n> + true 'INFO: Skipping script, because ANON_BUILD_INSTALL_TO_ROOT=1: /home/user/Whonix/help-steps/unmount-raw'\n> + true 'INFO: Currently running script: ././build-steps.d/2300_run-chroot-scripts-post-d '\n> ```\n\nI just completed Whonix 10 and have not had much time yet to debug your replay above.  I am running a build right now and still have the build error where everything starts producing errors as initially described above using `11.0.0.0.1-developers-only` and `11.0.0.0.3-developers-only` tags.  \n\nI figure I should at least get a successful build before I start to debug other issue since there could be the possibility something was not installed correctly to begin with due to the build errors.\n\nWhere do you want the logs sent to as they are large.\n\n\n\n"},{"author":"Patrick","date_created":1430442195,"date_modified":1430442195,"content":"Indeed.\n\nAny pages you find under 'free paste bin' or github [gist] or anything that works."},{"author":"nrgaway","date_created":1430469769,"date_modified":1430469769,"content":"I was able to identify all the issue that prevented complete and successful build.\n\n1. help-steps/variables:\n  - `lsb_release --short -i` is returning 'Whonix', not 'Debain' which causes error\n    - TEMP HACK:\n    -  `export whonix_build_on_operating_system=\"debian\"`\n\nThe following are all grub related.  I did not install grub for Whonix 11 and pulled out the code that fakes installation of grub since its not needed.\n\n2. build-steps.d/2300_run-chroot-scripts-post-d\n  - `run-parts --verbose --exit-on-error \"/usr/lib/anon-dist/chroot-scripts-post.d/\"`\n  - `/usr/lib/anon-dist/chroot-scripts-post.d//30_backup_grub_cfg`\n  - `cp /boot/grub/grub.cfg /var/lib/anon-dist/grub-backup/grub.cfg.chroot-post1`\n\n3. /usr/lib/anon-dist/chroot-scripts-post.d//85_update_grub\n  - `update-grub`\n\n4. /usr/lib/anon-dist/chroot-scripts-post.d//90_fix_grub\n  - `cp /boot/grub/grub.cfg /var/lib/anon-dist/grub-backup/grub.cfg.chroot-post4`\n\nIn regards to the `grub` errors, what are our options?\n  - export ENV var to preven `grub` related items from installing?\n  - configuration files to `skip` those 3 `chroot-post` scripts?\n  - Add conditional tests before executing any `grub` related command (see if file or command exists first)\n\nAs to lsb_release I have no idea why it stops working in 1700* script.\n\nOnce these issues are resolved, I can attempt another build :)"},{"author":"Patrick","date_created":1430485247,"date_modified":1430485247,"content":"Good catch!\n\n__Only answering the grub issue in this comment.__ About lsb_release, I need to think some more and do another comment.\n\n__side note__, skippable chroot-scripts:\nchroot-scripts are skippable already. Example code:\nhttps://github.com/Whonix/anon-shared-build-fix-grub/blob/c80a6af12f9559ba119827f8fc4215dc780b7131/usr/lib/anon-dist/chroot-scripts-post.d/85_update_grub#L33\n\nBut we won't chroot-script skipping here. Just wanted to let you know. Perhaps the interface is not the nicest, since you cannot match those by `*_grub*` and changing file names in later versions could break it.\n\n-----\n\n__skippable package installation__:\n\nOn Whonix `10`, all packages installed in `build-steps.d/1700_install-packages` by `pkg-install-maybe` (as opposed of being installed as part of a dependency) are skippable through the `whonix_build_script_skip_package_install` environment variable. Example:\n\n```\nwhonix_build_script_skip_package_install+=\" anon-shared-build-fix-grub \"\nexport whonix_build_script_skip_package_install\n```\n\nShould prevent installation of that package.\n\n-----\n\n__side note__, `export` not in same line:\nI prefer not using export in the same line but in it's own. Otherwise failing commands still return zero rather than non-zero.\n\n```\nexport testvar=\"$(false)\" ; echo $?\n0\n```\n\n-----\n\n__side note__, environment variable vs build configuration files:\n\n* It's not just a feast of environment variables. You can also do the same using build configuration files. Documentation: https://www.whonix.org/wiki/Dev/Source_Code_Intro#Build_Configuration\n* code: https://github.com/Whonix/Whonix/blob/3116cdfad815305d8a8062dc6efa0de0f18278f6/help-steps/variables#L314\n\n-----\n\n__fixing it in mainline Whonix__\n\nIs there some \"if Qubes\" already available at `build-steps.d/1700_install-packages` time? Then, for Whonix `11`, we could apply the fix in mainline Whonix. I.e. \"if Qubes, don't install the anon-shared-build-fix-grub package\"."},{"author":"Patrick","date_created":1430486965,"date_modified":1430486965,"content":"The `whonix_build_on_operating_system` variable is important for:\nhttps://github.com/Whonix/Whonix/blob/master/buildconfig.d/30_apt_sources\n\nIt influences which build upstream apt sources.list(s) will be used.\n\nApplied a fix in mainline master that will be in `11.0.0.0.7-developers-only` and above, `build script: Fix building Whonix on Whonix, fix if 'lsb_release --short --i' returns 'Whonix'. Temp hack 'export whonix_build_on_operating_system=\"debian\"' no longer required. Thanks to @nrgaway for the bug report and the analysis. - https://phabricator.whonix.org/T278`:\nhttps://github.com/Whonix/Whonix/commit/2e3bd0fd8d6bc1b18438aa3a75011e361131fcf8\n"},{"author":"nrgaway","date_created":1430516607,"date_modified":1430516607,"content":">>! In T278#4230, @Patrick wrote:\n> -----\n> \n> __skippable package installation__:\n> \n> On Whonix `10`, all packages installed in `build-steps.d/1700_install-packages` by `pkg-install-maybe` (as opposed of being installed as part of a dependency) are skippable through the `whonix_build_script_skip_package_install` environment variable. Example:\n> \n> ```\n> whonix_build_script_skip_package_install+=\" anon-shared-build-fix-grub \"\n> export whonix_build_script_skip_package_install\n> ```\n> \n> Should prevent installation of that package.\n\nOkay, so I should add the export for above and remove my hack for the `lsb_release` issue.\n\n> -----\n> \n> __fixing it in mainline Whonix__\n> \n> Is there some \"if Qubes\" already available at `build-steps.d/1700_install-packages` time? Then, for Whonix `11`, we could apply the fix in mainline Whonix. I.e. \"if Qubes, don't install the anon-shared-build-fix-grub package\".\n\nI will create a new task when I can confirm a successful build that will contain all the work-a-rounds to be able to install Whonix.  \n\nThen at some point it may also be of benefit to also remove as much of the special workarounds I needed to do for Qubes on boot.  I needed a special `startup` file in the past due to `whonixcheck` starting too soon, which may be able to be solved with `systemd` unit files.\n"},{"author":"nrgaway","date_created":1430534201,"date_modified":1430534201,"content":"@Patrick\n\nIs the `11.0.0.0.7-developers-only` tag supposed to be available?  While most submodules are cloning properly, I get this error:\n\n```\nSubmodule path 'packages/xchat-improved-privacy': checked out 'afc52a514e0b86bd4fe61344e5e44023d6885890'\nUnable to checkout '435741702cb49cb38f410b7597078df7d6659a6c' in submodule path 'packages/whonix-developer-meta-files\n```"},{"author":"Patrick","date_created":1430541558,"date_modified":1430541558,"content":">>! In T278#4255, @nrgaway wrote:\n> @Patrick\n> \n> Is the `11.0.0.0.7-developers-only` tag supposed to be available?  While most submodules are cloning properly, I get this error:\n> \n> ```\n> Submodule path 'packages/xchat-improved-privacy': checked out 'afc52a514e0b86bd4fe61344e5e44023d6885890'\n> Unable to checkout '435741702cb49cb38f410b7597078df7d6659a6c' in submodule path 'packages/whonix-developer-meta-files\n> ```\nFixed.\n\n\n\n>>! In T278#4245, @nrgaway wrote:\n>>>! In T278#4230, @Patrick wrote:\n>> -----\n>> \n>> __skippable package installation__:\n>> \n>> On Whonix `10`, all packages installed in `build-steps.d/1700_install-packages` by `pkg-install-maybe` (as opposed of being installed as part of a dependency) are skippable through the `whonix_build_script_skip_package_install` environment variable. Example:\n>> \n>> ```\n>> whonix_build_script_skip_package_install+=\" anon-shared-build-fix-grub \"\n>> export whonix_build_script_skip_package_install\n>> ```\n>> \n>> Should prevent installation of that package.\n> \n> Okay, so I should add the export for above and remove my hack for the `lsb_release` issue.\n\nNot necessarily. That would work but only be a workaround.\n\nFor a real fix - that I would enjoy implementing - you perhaps missed my question... Let me restate.\n\nIs there some \"if Qubes\" already available at build-steps.d/1700_install-packages time? Then, for Whonix 11, we could apply the fix in mainline Whonix. I.e. \"if Qubes, don't install the anon-shared-build-fix-grub package\".\n \n>> -----\n>> \n>> __fixing it in mainline Whonix__\n>> \n>> Is there some \"if Qubes\" already available at `build-steps.d/1700_install-packages` time? Then, for Whonix `11`, we could apply the fix in mainline Whonix. I.e. \"if Qubes, don't install the anon-shared-build-fix-grub package\".\n> \n> I will create a new task when I can confirm a successful build that will contain all the work-a-rounds to be able to install Whonix.  \n\nOkay, great.\n \n> Then at some point it may also be of benefit to also remove as much of the special workarounds I needed to do for Qubes on boot.  I needed a special `startup` file in the past due to `whonixcheck` starting too soon, which may be able to be solved with `systemd` unit files.\n\nYes. I am most definitively interested to remove as much workarounds as possible."},{"author":"nrgaway","date_created":1431751650,"date_modified":1431751650,"content":"No longer an issue with `11.0.0.0.4-developers-only`\n\nSuccessful build of gateway (manually patching to use `--target qubes`)"}]},"PHID-TASK-6yn7aayfhw475gpevty4":{"id":"277","title":"genmkfile lintian debian-watch-may-check-gpg-signature build issue","status":"resolved","priority":"Normal","author":"Patrick","description":"This is currently breaking builds of Whonix on Debian jessie, because lintian is reporting this issue, genmkfile detects it and breaks the build.\n\n-----\n\n```\nP: anon-apt-sources-list source: debian-watch-may-check-gpg-signature\nN: \nN:    This watch file does not include a means to verify the upstream tarball\nN:    using cryptographic signature.\nN:    \nN:    If upstream distributions provide such signatures, please use the\nN:    pgpsigurlmangle options in this watch file's opts= to generate the URL\nN:    of an upstream GPG signature. This signature is automatically downloaded\nN:    and verified against a keyring stored in\nN:    debian/upstream-signing-key.asc.\nN:    \nN:    Of course, not all upstreams provide such signatures, but you could\nN:    request them as a way of verifying that no third party has modified the\nN:    code against their wishes after the release. Projects such as\nN:    phpmyadmin, unrealircd, and proftpd have suffered from this kind of\nN:    attack.\nN:    \nN:    Refer to the uscan(1) manual page for details.\nN:    \nN:    Severity: pedantic, Certainty: certain\nN:    \nN:    Check: watch-file, Type: source\nN:\n```\n\nhttps://lintian.debian.org/tags/debian-watch-may-check-gpg-signature.html\n\n-----\n\nPreviously the watch file has just been added to to fix the [`--pedantic`?] lintian warning, that there is no watch file at all. So we can say, the package is `--pedantic` lintian clean, i.e. has zero lintian warnings to shorten discussions about that and to make packaging \"complete\".\n\nWe don't really need the watch files for Whonix currently since we're upstream and packages in one person and not using such a notification mechanism.\n\nI am wondering about which fix would be appropriate. Possibles routes:\n\n* each and every package getting a lintian overwrite to make lintian ignore this issue\n* trying to make the watch file support gpg as per https://wiki.debian.org/debian/watch#Cryptographic_signature_verification - it would require adding Whonix's signing key to each and every package\n* anything else?\n\n-----\n\nWorkarounds:\n\nMaking lintian fail open.\n\n```\nexport make_use_lintian=open\n```\n\nOr not using lintian.\n\n```\nexport make_use_lintian=false\n```\n","comments":[{"author":"nrgaway","date_created":1430092595,"date_modified":1430092595,"content":"I had to force disable lintian to compile jessie,\n```\n sed -i \"s/make_use_lintian=\\\"true\\\"/make_use_lintian=\\\"false\\\"/g\" \"${WHONIX_DIR}/build-steps.d/1200_create-debian-packages\"\n```\n\nI initially tried just to uninstall `lintian` cause your bash makefile script had the option to do so, but when I did that there was some error that it was expecting `lintian`\n\nI have not got to the point where build is successful, as I am getting stuck on `1700_install-packages` (broken packages)"},{"author":"Patrick","date_created":1430094552,"date_modified":1430094552,"content":"It's a different issue. Found a related issue and fixed it: T279\n\nLintian quick fix ticket: T280\n\nLintian real fix ticket: T281\n\nI would like to limit this ticket on how to actually solve `debian-watch-may-check-gpg-signature`. Any idea?\n\n"},{"author":"Patrick","date_created":1430159150,"date_modified":1430159150,"content":"* Our `debian/watch` files are broken anyhow. (`uscan` does no longer work with them. Probably because github changed something.)\n* We're not providing tarballs and/or detached OpenPGP signatures for packages. Only signed git tags.\n* `uscan` does not support [signed] git [tags] (yet?).\n\nSo rather than going in circles trying to fix this, unless someone wants to contribute a better solution (patches welcome!), my current plan is only a workaround, to rather add a lintian overwrite to all packages."},{"author":"Patrick","date_created":1430229133,"date_modified":1430229133,"content":"`all packages: added debian/source/lintian-overrides with debian-watch-may-check-gpg-signature to fix lintian warning - https://phabricator.whonix.org/T277`:\n- https://github.com/Whonix/anon-apt-sources-list/commit/272de53bb78ab00743ae5cdd58527a5f03af13bf\n- [...]\n- https://github.com/Whonix/Whonix/commit/a44f1f994adc357e4c8644e05ae375f64d46e917\n"}]},"PHID-TASK-fbihzyiexe664puchmrz":{"id":"276","title":"explain Whonix Build Version","status":"resolved","priority":"Normal","author":"Patrick","description":"It causes some confusion every now and then why it never changes.\n\nThere should be a link in whonixcheck for \"Whonix Build Version\".\n\nShort technical explanation:\n* at build time, the https://github.com/Whonix/anon-shared-build-log-build-version package does in essence\n* `echo \"$anon_dist_build_version\" > \"/var/lib/anon-dist/build_version\"`\n* it's there so whonixcheck can find out which version of the build script has created that version\n* that version number is supposed to never change\n** this is because sometimes updating or other issues do only apply to version created by specific, mostly older versions of the build script\n** this helps with diagnostic purposes\n** therefore, should we ever need to deprecate a specific build version (because it would be too difficult/expensive to upgrade), then whonixcheck's Whonix News (https://www.whonix.org/wiki/Whonix_News) could inform about this","comments":[{"author":"Patrick","date_created":1430158029,"date_modified":1430158029,"content":"Done:\n- `added link to document Whonix Build Version`: https://github.com/Whonix/whonixcheck/commit/aefc489edbbb0e5603d3e653f67990720819c024\n- https://www.whonix.org/wiki/Whonixcheck#Whonix_Build_Version\n"}]},"PHID-TASK-scjmjaj37gq4w3uh3lmp":{"id":"275","title":"Qubes Whonix 9.6.9 and 10.0.5 is ready","status":"resolved","priority":"Normal","author":"nrgaway","description":"Hi Patrick,\n\nI have completed both `qubes-whonix` `9.6.7` and `10.0.2`\n\nCurrently both versions are identical except for the version numbers and changelog.\n\nPlease review and provide signed tags of `9.6.7` and `10.0.2`.  Once this is complete I will attempt another run of test builds using your repo.  They are located in Whonix9 and Whonix10 branch in my repo.\n\nI have manually tested upgrading from `9.6.2` to `9.6.7` using the local repo utility that is now included within `qubes-whonix` package (although it does not get included in build) but would be nice to have these packages included in either the testing or developer repos so we can test the upgrade via apt-get.  The upgrade via apt-get will not be successful until the `qubes` changes I made are also available within the `qubes repo` as well.\n\n@WhonixQubes:\nI have also then upgraded to Whonix 10.  Steps I took are (in the `template vm`):\n- Cloned original `templatevm` as a backup; just in case of failure\n- Make sure `Whonix` repo is disabled using old `whonix_repository` <-- Important\n- Manually enabled qubes-r3 repo in `/etc/apt/sources.list.d/qubes-r3.list` (repos are disabled by default)\n- `apt-get update`\n- Simulate an `apt-get dist-upgrade` ... used `qubes-whonix 10.0.2` and unreleased `qubes packages`\n- Powered off template\n- Powered up template (to allow new `qubes-whonix` code to remove `chattr +i`)\n- Enable `Whonix` testers repo\n- `apt-get update` && `apt-get dist-upgrade`\n- `poweroff` templatevm\n- `poweroff` `whonix-gateway` proxyvm\n- `poweron` `whonix-gateway` proxyvm to test that upgrade was successful\n\nPrompted to update the following file.  Answered `Y`\n```\n/etc/whonix.d/30_whonixcheck_default\n```\n\nWill end with these two messages which is fine, since we are in a template...\n```\nFailed to read /qubes-netvm-gateway\nFailed to read /qubes-netvm-gateway\n```\n\n`whonixcheck` report build as `9.6` still, but I definitely have `10.0` packages installed after update.\n\nAs far as I am concerned, it looks like Whonix 10 is a go... Great job!\n\nFollowing is the changelog since `9.6.2` update:\n```\nqubes-whonix (0:9.6.7-1 / 0:10.0.2-1) wheezy; urgency=medium\n  [ Jason Mehring ]\n  * Update files to search and replace IP addresses Fix syntax typo for\n    whonix workstation that prevented search and replace\n  * start whonixcheck on startup for workstation\n  * Use new whonix-setup-wizard directory for *.done files Use\n    50_whonixcheck_user instead of 30_whonixcheck_default Enable new\n    control-port-filter-python.service\n  * Remove unneeded bind directories due to new localtion of whonix\n    status files\n  * - Remove references to old whonix status files; use new references -\n    Start whonixcheck last - Add missing whonixcheck for workstation -\n    Don't prompt to install repository in AppVM (Gateway or Workstation)\n    - Prompt to install repository in templatevm\n  * Add missing whonixcheck.conf file\n  * Add systemd unit file for control-port-filter-python.service\n\nqubes-whonix (0:10.0.1-1) wheezy; urgency=medium\n  * version 10.0.1\n\nqubes-whonix (0:9.6.6-1) wheezy; urgency=medium\n[ Patrick Schleizer ]\n  * added genmkfile to Build-Depends\n  * updated makefile generic to version 1.5\n  * updated readme\n  * updated makefile generic to version 1.4\n\n  [ Jason Mehring ]\n  * Commented out watchdog as it was resetting tor every minute\n  * More specific reference to be able to inject firewall code was\n    needed for Whonix 10\n\nqubes-whonix (0:9.6.5-1) wheezy; urgency=medium\n  [ Jason Mehring ]\n  * Remove chattr +i and replace with a protected files routine\n  * Notes with issues not yet resolved due to changes in Qubes or qubes-\n    whonix\n  * Added wip whonixcheck systemd unit file\n  * Added a tor systemd unit files along with a wip unit file to\n    implement hardening\n  * Added ability to upgrade and dist-upgrade from local test repo\n  * Streamlined enable/disable services; remove immutable bits\n  * Make sure qubes-network is started before qubes-firewall\n  * Keep whonixcheck and sdwdate disabled and manually start them to\n    prevent false positive errors that tor is not started\n  * Send a 0 when enabling a service\n\nqubes-whonix (0:9.6.4-1) wheezy; urgency=medium\n  [ Jason Mehring ]\n  * Bump version to 9.6.4\n  * Fix a bug that gave error on upgrade when restarting service\n  * Use debhelper package install to install files to prevent tests from being part of package\n  * Fixed an issue with restarting services and added whonix-setup-wizard cache dir\n  * Added more options to make sure unwanted dirs like rpm or deb do not make it into Debian package\n  * Removed stale references from notes\n  * Added a update test script that will install a local repo and perform an update of package\n    The test suite is excluded from built package\n  * Updated changelog for 9.6.3\n\nqubes-whonix (0:9.6.3-1) wheezy; urgency=medium\n  [ Jason Mehring ]\n  * Added /var/cache/whonix-setup-wizard to list of dirs to bind on\n    startup\n  * Updated Makefile.builder to work with new qubes-builder api\n  * Bumped version to 9.6.3\n```","comments":[{"author":"Patrick","date_created":1429882957,"date_modified":1429882957,"content":"> whonixcheck report build as 9.6 still, but I definitely have 10.0 packages installed after update.\n\nThis is expected and by design. But needs documentation. Short explanation and ticket: T276\n\n-----\n\nReview:\n\n* `50_whonixcheck_user` isn't a good name. `_user` indicates user. `/etc/whonix.d/50_whonixcheck_qubes` would be appropriate. Then you could also easily get ride of that file one day without risking to delete user changes.\n* Shipping systemd unit file control-port-filter-python.service will most likely prevent later [easy] upgrades, i.e. break the package manager, see https://www.whonix.org/forum/index.php/topic,1167.0.html\n* What about T193, we'll let's do this for Whonix 11?\n\n-----\n\nTwo tags / versions pointing to the same version looks a bit strange, no? Do we really need 9.6.7 with Whonix 10 package versions?\n\nI guess we can release [10.0.0.5.5](https://www.whonix.org/blog/testers-wanted-10-10-0-0-5-5) as stable within the next 3 days or so. That would be elegant to reduce need for 9.6.7? What do you think?\n\n-----\n\nThere is some confusion on my side. You didn't merge my changes from master beforehand. Perhaps I should have created a separate notification ticket rather than mentioning it somewhere. Maybe my mistake, maybe my changes were too extensive. There was a small, easy to resolve merge conflict in `debian/rules`. Anyhow. Merged your latest master into master. The diff between adrelanos/qubes-whonix and nrgaway/qubes-whonix is minimal. \n\nTagged as `10.0.2-1`, not `10.0.2`. Using the usual `make git-tag-sign` way. I hope that's fine?\n\nAlso added to developers repository. Note: the one on sourceforge upgrades quite fast. The mirror.whonix.de has a lag of ~1 hour until all mirrors got the changes.\n\nJust so you can test. I recommend another revision where at least the systemd / package manager / upgrade issue is fixed. But that's up to you."},{"author":"Patrick","date_created":1429884015,"date_modified":1429884015,"content":"Something that worries me. About https://github.com/Whonix/qubes-whonix/blob/master/tests/apt-update-from-local-repo\n\n```\nKey-Type: RSA\nKey-Length: 1024\n```\n\nThis is a weak key. Even if it's just a local key and perfectly secure... It's a source for FUD. Fear, uncertainty, doubt. And from a marketing perspective, FUD can kill a project. I don't want to distract discussion of real security issues with such easy-to-confuse-easy-to-fix false-positives.\n\nCan you please use deb [trusted=yes] rather than local signing key for local apt repository? I.e.\n\n```\ndeb file:$(readlink -m ${LOCAL_REPO}) ${DIST} main\n```\n\n-->\n\n```\ndeb [trusted=yes] file:$(readlink -m ${LOCAL_REPO}) ${DIST} main\n```\n\nand removing the local key creation should do. Also less code and more elegant.\n\nMinor: By the way there is an existing similar script https://github.com/Whonix/whonix-developer-meta-files/blob/master/debug-steps/locally-upgrade-whonix-debian-packages. It upgrades all Whonix packages from source code. But it seems yours has a different purpose?"},{"author":"nrgaway","date_created":1429887315,"date_modified":1429887315,"content":">>! In T275#3897, @Patrick wrote:\n> Something that worries me. About https://github.com/Whonix/qubes-whonix/blob/master/tests/apt-update-from-local-repo\n> \n> ```\n> Key-Type: RSA\n> Key-Length: 1024\n> ```\n> \n> This is a weak key. Even if it's just a local key and perfectly secure... It's a source for FUD. Fear, uncertainty, doubt. And from a marketing perspective, FUD can kill a project. I don't want to distract discussion of real security issues with such easy-to-confuse-easy-to-fix false-positives.\n> \n> Can you please use deb [trusted=yes] rather than local signing key for local apt repository? I.e.\n> \n\nSure, if I can get rid of the signing code, all the better.  Be aware that any of the code that is in the test directory is excluded from the Debian packaging build so it is not available at all once the Debian package is created and solely lives in the git repo for developer testing purposes.\n\n> ```\n> deb file:$(readlink -m ${LOCAL_REPO}) ${DIST} main\n> ```\n> \n> -->\n> \n> ```\n> deb [trusted=yes] file:$(readlink -m ${LOCAL_REPO}) ${DIST} main\n> ```\n> \n> and removing the local key creation should do. Also less code and more elegant.\n> \n> Minor: By the way there is an existing similar script https://github.com/Whonix/whonix-developer-meta-files/blob/master/debug-steps/locally-upgrade-whonix-debian-packages. It upgrades all Whonix packages from source code. But it seems yours has a different purpose?\n\nThe purpose of that script is to simulate an update instead of having to use a live repo.  I used it to update the `qubes-whonix 9.6.2` to `10.0.2` to make sure it would not fail.  I also added in the compiled Qubes Debian packages that will be available from their repo.  For my purpose, I just clone a `whonix-gateway` templatevm, copy the test directory and wheezy repos that were built by `qubes-builder` for the current template build.  Then the script runs `apt-get dist-upgrade` against the main repos and this local repo to test if the upgrade will be a success."},{"author":"WhonixQubes","date_created":1429888430,"date_modified":1429888430,"content":"@nrgaway Great job! :)\n\nHere is how I'd like to handle this release, if this is okay...\n\nI'd like to create a new audit thread, announce and invite others in the Whonix and Qubes communities to join in on auditing/testing if they please, and give it an audit myself.\n\n@Patrick can sign and put the new `qubes-whonix` package(s) into `developers` and `testers` Whonix APT repositories whenever, right now, etc.\n\nWe and the community complete a quick audit/testing phase, and then we can then ping Patrick and Marek to build and release final DEB and RPM packages.\n\nWith Qubes R3.0-rc1 and imminent Whonix 10 releases, I know we want to get this out there very soon, so we can make this a quick audit and assuming nothing major comes up, we can be all ready hopefully by say this Sunday/Monday or so to call it final and go to stable release.\n\nJust wanting to give it a quick audit and be inclusive with the community.\n\nI will initiate this now, assuming there is no problem with this.\n\nThank you!"},{"author":"WhonixQubes","date_created":1429888447,"date_modified":1429888447,"content":"@nrgaway What did you think of Patrick's proposal of going directly to Whonix 10 in the next few days?"},{"author":"Patrick","date_created":1429890922,"date_modified":1429890922,"content":"> Sure, if I can get rid of the signing code, all the better.\n\nGreat.\n\n> Be aware that any of the code that is in the test directory is excluded from the Debian packaging build so it is not available at all once the Debian package is created and solely lives in the git repo for developer testing purposes.\n\nYes, I was/am aware of that.\n\n> The purpose of that script is to simulate an update instead of having to use a live repo.\n\nAlright. As a side note, that's also the purpose of whonix-developer-meta-files/blob/master/debug-steps/locally-upgrade-whonix-debian-packages. It doesn't touch any remote/binary repositories run Whonix. Uses source code by Whonix only. Binary packages are created and installed from local hdd. For trust reasons, for those who prefer to upgrade from source code. (Documented here: https://www.whonix.org/wiki/Dev/Build_Documentation/10_full)\n\n-----\n\n@WhonixQubes: That's fine with me. It's in the developers repository currently. I can migrate it to the testers soon, if requested. I guess it's best if at least one developer tried upgrading from the remote developers apt repository at least once. Otherwise the risk is that the package manager breaks for all testers [of that package]. And manual fixes might be so complicated, that we can't help all users through it. Anyhow. I leave that decision to you. If someone tried a local upgrade from existing versions to the new one and it worked, the risk is a lot smaller."},{"author":"nrgaway","date_created":1429891222,"date_modified":1429891222,"content":">>! In T275#3892, @Patrick wrote:\n>> whonixcheck report build as 9.6 still, but I definitely have 10.0 packages installed after update.\n> \n> This is expected and by design. But needs documentation. Short explanation and ticket: T276\n> \n> -----\n> \n> Review:\n> \n> * `50_whonixcheck_user` isn't a good name. `_user` indicates user. `/etc/whonix.d/50_whonixcheck_qubes` would be appropriate. Then you could also easily get ride of that file one day without risking to delete user changes.\n\nOkay\n\n> * Shipping systemd unit file control-port-filter-python.service will most likely prevent later [easy] upgrades, i.e. break the package manager, see https://www.whonix.org/forum/index.php/topic,1167.0.html\n\nYes it would.  I can rename packages and set some conditionals as described in the mentioned forum topic.\n\nI need to have own tor for `qubes-whonix` for both 9.6 and 10.0, although as stated, I will rename it.  And as I mentioned, both 9.6 and 10.0 currently share the exact same `qubes-whonix` code base; the systemd unit file for control-port-filter-python is included, but will not run due to a requirement not being met (namely, that the package does not exist hehe)\n\n> * What about T193, we'll let's do this for Whonix 11?\n> \n> -----\n> \n> Two tags / versions pointing to the same version looks a bit strange, no? Do we really need 9.6.7 with Whonix 10 package versions?\n\nSince 9.6.7 may diverge.  They Point to the changelog which is different and I have created a `Whonix9` and `Whonix10` branch which separates the versions by branch hierarchy. \n\n9.6.7 is for those not wanting to update to 10.0 and contain the important whonix-setup-wizard fix as well as the chattr change.\n\n> \n> I guess we can release [10.0.0.5.5](https://www.whonix.org/blog/testers-wanted-10-10-0-0-5-5) as stable within the next 3 days or so. That would be elegant to reduce need for 9.6.7? What do you think?\n\nDoes not matter to me so much, but there may be people not wanting to upgrade to version 10 yet?\n\n> \n> -----\n> \n> There is some confusion on my side. You didn't merge my changes from master beforehand. Perhaps I should have created a separate notification ticket rather than mentioning it somewhere. Maybe my mistake, maybe my changes were too extensive. There was a small, easy to resolve merge conflict in `debian/rules`. Anyhow. Merged your latest master into master. The diff between adrelanos/qubes-whonix and nrgaway/qubes-whonix is minimal. \n\nI did merge your changes in `0:9.6.6-1`.  I only noticed the 4 changes related to `genmkfile`.  I typically do not merge wholesale as I prefer to cherry pick the commits and apologize if I missed any others; that is even the case with code from v10 branch to v9 branch.\n\n> \n> Tagged as `10.0.2-1`, not `10.0.2`. Using the usual `make git-tag-sign` way. I hope that's fine?\n\nYes, anything fine so long as I can add it to qubes template code ;)\n\n> \n> Also added to developers repository. Note: the one on sourceforge upgrades quite fast. The mirror.whonix.de has a lag of ~1 hour until all mirrors got the changes.\n\nThanks.\n\n> \n> Just so you can test. I recommend another revision where at least the systemd / package manager / upgrade issue is fixed. But that's up to you.\n\nYes, I will need to address these issues as stated and submit updated revision asap\n"},{"author":"nrgaway","date_created":1429891629,"date_modified":1429891629,"content":">>! In T275#3899, @WhonixQubes wrote:\n> @nrgaway Great job! :)\n> \n> Here is how I'd like to handle this release, if this is okay...\n> \n> I'd like to create a new audit thread, announce and invite others in the Whonix and Qubes communities to join in on auditing/testing if they please, and give it an audit myself.\n> \n> @Patrick can sign and put the new `qubes-whonix` package(s) into `developers` and `testers` Whonix APT repositories whenever, right now, etc.\n> \n> We and the community complete a quick audit/testing phase, and then we can then ping Patrick and Marek to build and release final DEB and RPM packages.\n> \n> With Qubes R3.0-rc1 and imminent Whonix 10 releases, I know we want to get this out there very soon, so we can make this a quick audit and assuming nothing major comes up, we can be all ready hopefully by say this Sunday/Monday or so to call it final and go to stable release.\n> \n> Just wanting to give it a quick audit and be inclusive with the community.\n> \n> I will initiate this now, assuming there is no problem with this.\n> \n> Thank you!\n\nYou will not be able to test the package unless you build from source, and you would also need to use my `qubes-agent-linux` repo as there are changes to qubes that to allow the `chattr` to be removed did not make rc1.  They would be available when Marek gets time merge that code, which I assume will be at the same time he works on this.  You only need to build that one packaage though, and install it manually.\n\nUntil that point it is not ready for testers."},{"author":"nrgaway","date_created":1429891715,"date_modified":1429891715,"content":">>! In T275#3900, @WhonixQubes wrote:\n> @nrgaway What did you think of Patrick's proposal of going directly to Whonix 10 in the next few days?\n\nYa, that's fine with me.  We can always release the 9.6.7 if people complain, but I can't really see that."},{"author":"nrgaway","date_created":1430033228,"date_modified":1430037319,"content":"I have completed the changes previously discussed.\n\nI will begin to tackle some of the outstanding tasks which mostly are for Whonix 11 once I can confirm this is stable since I do not want to be introducing too many changes at this point :)\n\nI suppose the tag will be `10.0.3-1`\n\n@WhonixQubes\nMarek has released a new version of `qubes-core-agent`  that is compatible to `Whonix` to the Debian test repo.  You would need to enable the test repo manually in `/etc/apt/sources.d/qubes-r3.list` but there is an issue with that package at the moment so I suggest you wait until it gets resolved.  If you are impatient, then after you update, you will need to edit `/etc/xen/scripts/vif-route-qubes` and delete the `-w` in the `iptables` statement at about [[ https://github.com/marmarek/qubes-core-agent-linux/commit/c49d9283f0f209612f09d3997bc4b8e9af2cec0b | line 56 ]], otherwise the gateway will crash when trying to connect to it.\n\nOnce Patrick is able to sign a new tag again, I will again attempt an apt-get update.\n\n"},{"author":"WhonixQubes","date_created":1430042468,"date_modified":1430042468,"content":"@nrgaway That all sounds good. I've updated the audit forum thread and \nam reviewing the code myself today."},{"author":"Patrick","date_created":1430053110,"date_modified":1430053110,"content":"__.d Issue Regression__\n\n* You reintroduced issues, that you earlier fixed already.\n** T174\n** T163\n* For the same reason,\n** it's also a bug to edit `/etc/cpfpy.d/30_controlportfilt_default`. You can ship a higher numbered file and edit that.\n** Same for `/etc/uwt.d/30_uwt_default`.\n\n-----\n\n__etc/systemd/system/tor.service in the workstation issue__\n\nThe qubes-whonix package also gets installed in the workstation. Likely the following clashes with https://github.com/Whonix/anon-ws-disable-stacked-tor, which gets installed by default.\n\n```\nConditionPathExists = /etc/init.d/tor\n```\n\nBecause anon-ws-disable-stacked-tor ships a `/etc/init.d/tor`. Your `etc/systemd/system/tor.service` that would also be installed on the workstation would then have the condition satisfied and try to start Tor, which is not installed. So that would fail. Probably not fatal, but I am sure users will report the failed systemd startup message.\n\n-----\n\n__control-port-filter-python.service__\n\nWhat's the following good for?\n\n```\nConditionPathExists = /etc/init.d/control-port-filter-python\n```\n\nUsers that delete that init script (because they think they want to do X with systemd) will have the issue that suddenly cpfpy does not start anymore.\n\n-----\n\nTagged as `10.0.3-1`. Added to `developers` repository."},{"author":"nrgaway","date_created":1430055303,"date_modified":1430055303,"content":">>! In T275#3915, @Patrick wrote:\n> __.d Issue Regression__\n> \n> * You reintroduced issues, that you earlier fixed already.\n> ** T174\n> ** T163\n> * For the same reason,\n> ** it's also a bug to edit `/etc/cpfpy.d/30_controlportfilt_default`. You can ship a higher numbered file and edit that.\n> ** Same for `/etc/uwt.d/30_uwt_default`.\n\nYou are referring to the replace-ip list I imagine.  I will change as indicated and make notes in the source.\n\n> \n> -----\n> \n> __etc/systemd/system/tor.service in the workstation issue__\n> \n> The qubes-whonix package also gets installed in the workstation. Likely the following clashes with https://github.com/Whonix/anon-ws-disable-stacked-tor, which gets installed by default.\n> \n> ```\n> ConditionPathExists = /etc/init.d/tor\n> ```\n> \n> Because anon-ws-disable-stacked-tor ships a `/etc/init.d/tor`. Your `etc/systemd/system/tor.service` that would also be installed on the workstation would then have the condition satisfied and try to start Tor, which is not installed. So that would fail. Probably not fatal, but I am sure users will report the failed systemd startup message.\n\nI will check to see what is happening.  I can ship with it disabled as well.\n\n> \n> -----\n> \n> __control-port-filter-python.service__\n> \n> What's the following good for?\n> \n> ```\n> ConditionPathExists = /etc/init.d/control-port-filter-python\n> ```\n\nThat condition was put in so it will not conflict when you add systemd unit files to the main package.  Therefore when you install the systemd unit file, and the sysv init script is removed, my control-port-filter-python unit script will not startup, since yours will.\n\n> \n> Users that delete that init script (because they think they want to do X with systemd) will have the issue that suddenly cpfpy does not start anymore.\n> \n> -----\n> \n> Tagged as `10.0.3-1`. Added to `developers` repository.\n\n"},{"author":"nrgaway","date_created":1430056022,"date_modified":1430056022,"content":"It does not look like the systemd unit file is causing any issues in workstation. No errors are being reported...\n```\nroot@host:/home/user# systemctl status tor\nqubes-whonix-tor.service - Whonix Tor anonymizing overlay network for TCP\n   Loaded: loaded (/etc/systemd/system/qubes-whonix-tor.service; enabled)\n   Active: inactive (dead) since Sun 2015-04-26 13:37:39 UTC; 2min 40s ago\n  Process: 1791 ExecStart=/usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-torrc --runasdaemon 0 (code=exited, status=0/SUCCESS)\n  Process: 1762 ExecStartPre=/usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-torrc --verify-config (code=exited, status=0/SUCCESS)\n\nApr 26 13:37:39 host systemd[1]: Started Whonix Tor anonymizing overlay network for TCP.\nroot@host:/home/user# journalctl -u tor\n-- Logs begin at Sun 2015-04-26 13:39:30 UTC, end at Sun 2015-04-26 13:40:14 UTC. --\n\nroot@host:/home/user# journalctl -u qubes-whonix-tor\n-- Logs begin at Sun 2015-04-26 13:39:30 UTC, end at Sun 2015-04-26 13:40:14 UTC. --\nApr 26 13:37:39 host systemd[1]: Starting Whonix Tor anonymizing overlay network for TCP...\nApr 26 13:37:39 host systemd[1]: Started Whonix Tor anonymizing overlay network for TCP.\n```"},{"author":"Patrick","date_created":1430056104,"date_modified":1430056104,"content":"> You are referring to the replace-ip list I imagine.\n\nYes, I was.\n\n> That condition was put in so it will not conflict when you add systemd unit files to the main package.\n\n> and the sysv init script is removed\n\nWhen using proper systemd aliases, there should be no conflicts. Not sure about removal of old sysvinit scripts, see this comment:\nhttps://phabricator.whonix.org/T106#3920"},{"author":"Patrick","date_created":1430056369,"date_modified":1430056369,"content":">>! In T275#3921, @nrgaway wrote:\n> It does not look like the systemd unit file is causing any issues in workstation. No errors are being reported...\n> ```\n> root@host:/home/user# systemctl status tor\n> qubes-whonix-tor.service - Whonix Tor anonymizing overlay network for TCP\n>    Loaded: loaded (/etc/systemd/system/qubes-whonix-tor.service; enabled)\n>    Active: inactive (dead) since Sun 2015-04-26 13:37:39 UTC; 2min 40s ago\n>   Process: 1791 ExecStart=/usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-torrc --runasdaemon 0 (code=exited, status=0/SUCCESS)\n>   Process: 1762 ExecStartPre=/usr/bin/tor --defaults-torrc /usr/share/tor/tor-service-defaults-torrc --verify-config (code=exited, status=0/SUCCESS)\n> \n> Apr 26 13:37:39 host systemd[1]: Started Whonix Tor anonymizing overlay network for TCP.\n> root@host:/home/user# journalctl -u tor\n> -- Logs begin at Sun 2015-04-26 13:39:30 UTC, end at Sun 2015-04-26 13:40:14 UTC. --\n> \n> root@host:/home/user# journalctl -u qubes-whonix-tor\n> -- Logs begin at Sun 2015-04-26 13:39:30 UTC, end at Sun 2015-04-26 13:40:14 UTC. --\n> Apr 26 13:37:39 host systemd[1]: Starting Whonix Tor anonymizing overlay network for TCP...\n> Apr 26 13:37:39 host systemd[1]: Started Whonix Tor anonymizing overlay network for TCP.\n> ```\n\nMakes sense. The existing dummytor implementation (shipping substitute Tor binaries that are just minimal shell scripts in the workstation) prevents this.\n\n* https://github.com/Whonix/anon-ws-disable-stacked-tor/blob/master/usr/bin/tor.anondist\n* https://www.whonix.org/wiki/Dev/anon-ws-disable-stacked-tor\n\nIndeed unlikely to cause issues of that kind."},{"author":"nrgaway","date_created":1430057523,"date_modified":1430057523,"content":">>! In T275#3922, @Patrick wrote:\n>> You are referring to the replace-ip list I imagine.\n> \n> Yes, I was.\n> \n>> That condition was put in so it will not conflict when you add systemd unit files to the main package.\n> \n>> and the sysv init script is removed\n> \n> When using proper systemd aliases, there should be no conflicts. Not sure about removal of old sysvinit scripts, see this comment:\n> https://phabricator.whonix.org/T106#3920\n\nI don't know what you mean my `proper system aliases`.  I do know that if I have a `control-port-filter-python` systemd unit file and you add one as well, there is now a conflict.  Both will start `cpfpy`.\n\nI renamed mine to `qubes-whonix-control-port-filter-python` as not to cause a dpkg install `error` when installing yours, and I added the condition not to run mine when it notices the the sysv init script is no longer present.  If you decide to keep the sysv init scripts as well, we are back to square one; guess we can deal with that then.\n\nI have started the work on Whonix11, and will compile a list of hacks I needed to implement to get it to compile in another task.  Still having a few issues and can test these systemd unit files better."},{"author":"Patrick","date_created":1430068317,"date_modified":1430068317,"content":"I meant 'proper systemd `Alias=`'.\n\nYes.\n\nYes, for Whonix 11 I am looking forward to reduce the number of hacks to a minimum."},{"author":"WhonixQubes","date_created":1430089916,"date_modified":1430089916,"content":"Okay, I've reviewed \"qubes-whonix\" 10.0.3 and give it a thumbs up for \nrelease in its current form.\n\nIf any new functional changes are introduced, I'll review those and \nprovide a final check and update before release.\n\nIf no new functional changes are introduced, then I'm good with stable \nrelease of the current package.\n\nAwesome work, @nrgaway! :)"},{"author":"Patrick","date_created":1430174769,"date_modified":1430174769,"content":"From https://github.com/Whonix/qubes-whonix/blob/master/tests/apt-update-from-local-repo\n\n```\nAPT_GET_OPTIONS=\"-o Dpkg::Options::=\"--force-confnew\" --force-yes --yes\"\n```\n\nplease remove the `--force-yes`. Reason: insecure, see also:\nhttps://groups.google.com/forum/#!topic/qubes-devel/akv5B7TgRFQ"},{"author":"nrgaway","date_created":1430182228,"date_modified":1430182228,"content":">>! In T275#4079, @Patrick wrote:\n> From https://github.com/Whonix/qubes-whonix/blob/master/tests/apt-update-from-local-repo\n> \n> ```\n> APT_GET_OPTIONS=\"-o Dpkg::Options::=\"--force-confnew\" --force-yes --yes\"\n> ```\n> \n> please remove the `--force-yes`. Reason: insecure, see also:\n> https://groups.google.com/forum/#!topic/qubes-devel/akv5B7TgRFQ\n\nYes, its now gone.  Will submit PR later today to Qubes"},{"author":"nrgaway","date_created":1430229219,"date_modified":1430229219,"content":"@Patrick\n\nI have another version ready to tag, `10.0.4`.  Hopefully its the last since I have to gt back working on another task soon too :)\n\nI removed the `injected firewall code` and dealt with the `replace-ips` issues as discussed earlier.  I also added a work-around for when a user upgrades `9.6` to `10` do disable the old `control-port-filter` since it never got removed on update.  Maybe the new `control-port-filter` should have `conflicts` or `provides` in the `control` file."},{"author":"Patrick","date_created":1430230980,"date_modified":1430230980,"content":"Done."},{"author":"Patrick","date_created":1430231134,"date_modified":1430231134,"content":"Tagged your Whonix 10 branch by the way as `10.0.4-1`.\n\nJust tagged. Not added to any repository. I can do that if you wish. I am not sure, if I should always do that or wait for explicit requests. I don't mind either way."},{"author":"WhonixQubes","date_created":1430233419,"date_modified":1430233419,"content":"We really need a better structured release process that helps iron out \nthe issues and hiccups. I will plan to make a post on this so we can get \na more robust process in place for the future.\n\n\nFor now, at least auto uploading to `developers` repository probably \nmakes sense. Not sure if `testers` repository is also needed by @nrgaway \nto test from right now, or if `developers` works out well for that too? \nNot sure if always auto uploading to `testers` would also poorly affect \nsome users who may use it? Maybe also depends upon the typical state of \nother Whonix packages kept in these repos?\n\nThe `stable` repository should obviously probably be at request though.\n\n\nI am reviewing the 10.0.4 code now."},{"author":"WhonixQubes","date_created":1430237465,"date_modified":1430237465,"content":"I've reviewed \"qubes-whonix\" 10.0.4 and give it a thumbs up for release \nin its current form."},{"author":"Patrick","date_created":1430239338,"date_modified":1430239338,"content":"I was wondering about this also and going to post about that. It slows down the development/debugging process if you have to wait for me to tag releases just so you can do a developers-only test build. We're living in different time zones and perhaps I won't have time for a few days at some point.\n\nqubes-whonix isn't build by git cloning https://github.com/Whonix/Whonix and using Whonix's original build script anyhow. Official redistributable template images are build by ITL. So we don't have any security/trust improvements by having \"blessed\" tags in https://github.com/Whonix/qubes-whonix.\n\nI was wondering if the canonical location for the qubes-whonix package in the qubes-builder should not be rather https://github.com/nrgaway/qubes-whonix or so. We want also easy from-source-code-builds by anyone without having to rely on some official location to sign any tags.\n\nSomehow it all needs to be more flexible and less centralized. The `whonix_repository` since Whonix 10 supports a `--baseuri` switch to easily allow to enable other locations. Perhaps that's of any help. I don't know what tools are missing to make this possible, but if there is anything we can do about this, I am eager to know."},{"author":"Patrick","date_created":1430239780,"date_modified":1430239780,"content":">>! In T275#4090, @nrgaway wrote:\n> since it never got removed on update.  Maybe the new `control-port-filter` should have `conflicts` or `provides` in the `control` file.\n\nThat's already implemented.\n\nRemoval of the package works for me during upgrade. The first Whonix 10 testers-only version had this bug but it was fixed in the second Whonix 10 testers-only version that has now been blessed stable.\n\n`control-port-filter-python` has in `debian/control` a `Conflicts: control-port-filter`.\n`control-port-filter` (bash) is no longer available in the repository.\n`anon-gateway-packages-recommended` (from `anon-meta-packages` repository) depends on `control-port-filter-python`."},{"author":"WhonixQubes","date_created":1430241784,"date_modified":1430241784,"content":"@Patrick\n\nYes, I am for improving the process.\n\nI do think there could be security and trust pitfalls with that specific \nmodel though.\n\nI don't want to hijack and veer off track the purpose of this ticket to \nget 10.0.4 released though.\n\nSo it would probably be best for us to open another ticket or thread to \ndiscuss details."},{"author":"Patrick","date_created":1430244518,"date_modified":1430244518,"content":"Okay, so to get this back on topic... What's next? I guess @nrgaway will inform us about his test results."},{"author":"WhonixQubes","date_created":1430246215,"date_modified":1430246215,"content":"Right. I assume @nrgaway is testing his build, and if it checks out, he \ncan notify us here, submit a pull request to Marek, and we can have you \n@Patrick update qubes-whonix 10.0.4 DEB package as stable.\n\nThen Marek can build and release RPMs when he is ready to."},{"author":"nrgaway","date_created":1430259010,"date_modified":1430259010,"content":">>! In T275#4092, @Patrick wrote:\n> Tagged your Whonix 10 branch by the way as `10.0.4-1`.\n> \n> Just tagged. Not added to any repository. I can do that if you wish. I am not sure, if I should always do that or wait for explicit requests. I don't mind either way.\n\nhehe, I was wondering why it was not in repo.  Yes, please add it as I want to do some upgrade testing."},{"author":"nrgaway","date_created":1430260065,"date_modified":1430260065,"content":">>! In T275#4097, @Patrick wrote:\n> I was wondering about this also and going to post about that. It slows down the development/debugging process if you have to wait for me to tag releases just so you can do a developers-only test build. We're living in different time zones and perhaps I won't have time for a few days at some point.\n> \n> qubes-whonix isn't build by git cloning https://github.com/Whonix/Whonix and using Whonix's original build script anyhow. Official redistributable template images are build by ITL. So we don't have any security/trust improvements by having \"blessed\" tags in https://github.com/Whonix/qubes-whonix.\n\n`qubes-whonix` is built using the signed tag version from the Whonix repo.  ITL uses both the Whonix and Debian template scripts I created to build.  Currently `qubes-whonix`, `Whonix` and `genmkfile` are the related components that are cloned from your repo and verified from your signing key.\n\nNow, stating that, we can move the `qubes-whonix` repo to `ITL`.  That would make this process much simpler as I would just integrate it into the `template-whonix` module which I recently created to keep `Whonix` separate from `Debian` templates.  If we go this route, we should do it right away for 10.0.\n\nI would prefer combining `qubes-whonix` and `template-whonix` as they are directly related by version and would be much easier to maintain for everyone involved.  This was not the case initially when `Whonix` was part of the `Debian` package repos. This will mean, we will need to remove any existing `qubes-whonix` from `Whonix` repo (and I would have to also make sure Marek is okay with this too :)\n\n\n> \n> I was wondering if the canonical location for the qubes-whonix package in the qubes-builder should not be rather https://github.com/nrgaway/qubes-whonix or so. We want also easy from-source-code-builds by anyone without having to rely on some official location to sign any tags.\n> \n> Somehow it all needs to be more flexible and less centralized. The `whonix_repository` since Whonix 10 supports a `--baseuri` switch to easily allow to enable other locations. Perhaps that's of any help. I don't know what tools are missing to make this possible, but if there is anything we can do about this, I am eager to know.\n\n"},{"author":"Patrick","date_created":1430260872,"date_modified":1430260872,"content":">>! In T275#4128, @nrgaway wrote:\n> hehe, I was wondering why it was not in repo.  Yes, please add it as I want to do some upgrade testing.\n\nDone, added to developers repository."},{"author":"nrgaway","date_created":1430262474,"date_modified":1430262474,"content":">>! In T275#4130, @Patrick wrote:\n>>>! In T275#4128, @nrgaway wrote:\n>> hehe, I was wondering why it was not in repo.  Yes, please add it as I want to do some upgrade testing.\n> \n> Done, added to developers repository.\n\nThanks!\n\nI also sent Marek a note to see if it would be okay with him to merge `template-whonix` and `qubes-whonix`."},{"author":"Patrick","date_created":1430273876,"date_modified":1430273876,"content":"Alright.\n\nHow would users upgrade the qubes-whonix package then? Does the ITL repo also contain Debian packages?\n\nHow do we keep it sync? I mean, when there are package upgrades for Whonix and the qubes-whonix package needs to be upgraded as well, it would be difficult to make it happen at the very same time, no? (Just image, Whonix 10 packages are being released to the stable repository but you need a few more days for the qubes-whonix package. What I want to think through and prevent here is that some upgrade from either repository is breaking the system for everyone using the repository.)"},{"author":"nrgaway","date_created":1430280742,"date_modified":1430280742,"content":">>! In T275#4132, @Patrick wrote:\n> Alright.\n> \n> How would users upgrade the qubes-whonix package then? Does the ITL repo also contain Debian packages?\n\nYes they also have a Debian repo for Wheezy and Jessie\n\n> How do we keep it sync? I mean, when there are package upgrades for Whonix and the qubes-whonix package needs to be upgraded as well, it would be difficult to make it happen at the very same time, no? (Just image, Whonix 10 packages are being released to the stable repository but you need a few more days for the qubes-whonix package. What I want to think through and prevent here is that some upgrade from either repository is breaking the system for everyone using the repository.)\n\nMarek seems to agree that it would cause confusion to keep `qubes-whonix` on ITL repos.  I received Marek's response.  He is concerned that it would cause confusion to the end user if `qubes-whonix` was within the `deb.qubes-os.org` repo and the package would not make sense there without the other Whonix packages.  The example he gave was a user will be confused if they install `qubes-whonix` in a debian-7 template [Currently the package would not even install due to a failed dependency `whonix-setup-wizard` if the Whonix repo was not added].\n\nSo it looks like maybe the best option may be to keep it as is.  As I stated the official ITL build as well as end users builds both get the `qubes-whonix` package and use the signed tags to verify, from the `Whonix` repo. \n\nIt would not be desirable to have my repo as the main source since that would require the users to import and additional key.  I am fine with how its working out so far so long as you are too.  If you want to propose an alternate solution, I would think we should bring Marek into the conversation."},{"author":"nrgaway","date_created":1430301763,"date_modified":1430301763,"content":"@WhonixQubes\n\nMaybe you want to give an upgrade a try.  The required `qubes` package is now also in the ITL `test` repo so you should be able to attempt an update. `DO NOT FORGET TO BACKUP (CLONE)` your existing whonix proxy :)\n\nFollowing is the procedure I used to update a Release 3 Whonix 9.6 to 10.0.\n\nI have not tested in in Release 2 as I do not have that installed.  I also re-created a proxy-vm (`sys-whonix`) after the update (Qubes Release 3 uses `sys-net`, `sys-firewall`, so please use this term `sys-whonix` to identify Whonix proxyvm.).  I think it would be best to re-create the Whonix `proxy-vm` since its quick and could avoid some missing path conflicts, but go ahead and test it if you want either way.\n\nI have not tested updating workstation, since I did not have a 9.6 version installed, but I would assume the same procedure as listed below could be followed verbatim.  I am building a 9.6 release to test with it.\n\n# In dom0\nBackup (clone) existing whonix-gateway first (max 30 chars)\n`qvm-clone whonix-gateway-experimental whonix-gw-backup`\n\n# In Whonix template-vm\nEnable `qubes TEST repo`; uncomment test repo\n`sudo vi /etc/apt/sources.list.d/qubes-r3.list`\n\nEnable Whonix developers repo (for qubes-whonix)\n`sudo whonix_repository`\n\nUpdate index\n`sudo apt-get update`\n\n#  `IMPORTANT` Update qubes-whonix package first (Ignore any errors)\n`sudo apt-get install qubes-whonix qubes-core-agent`\n\n# Update rest of system\nSelect `Y` to to install any `maintainer` version of files\n\nXXX: @Patrick, do your scripts ignore backed up files in directories such as `/etc/whonix_firewall.d...`. If not, maybe consider using a standard extension of `.conf` and only include those?\n\nBased on Patrick's answer to above, user may need to delete:\n`/etc/whonix_firewall.d/32_qubes.dist` (may be named differently; depending on version upgrading from)\n\n# Start the Whonix 10.0 upgrade\n`sudo apt-get dist-upgrade`\n\n`control-port-filter-python` is not always being re-enabled properly via update; could depend on update method used (I have noticed this when updating all at once where I did not update `qubes-whonix` first).  It will not hurt to do this step in the `template-vm` directly after upgrade to ensure service will start properly.\n```\nsudo systemctl is-enabled qubes-whonix-control-port-filter-python\nsudo systemctl disable control-port-filter-python\nsudo systemctl enable qubes-whonix-control-port-filter-python\n```\n\n# Shutdown `template-vm`\n`sudo poweroff`\n\n# Consider creating new proxyvm (`sys-whonix`) \nin qubes-manager using the updated template as `template-vm`\n\n# NOTES\nEven though `control-port-filter` was un-installed, it's `sysv init` configuration file remained, as well as the start directive in `/etc/rc3.d/S17control-port-filter`\n"},{"author":"Patrick","date_created":1430308928,"date_modified":1430308928,"content":">>! In T275#4134, @nrgaway wrote:\n> XXX: @Patrick, do your scripts ignore backed up files in directories such as `/etc/whonix_firewall.d...`.\n\nThe config folder `source`ing code can be viewed here:\nhttps://github.com/Whonix/whonix-gw-firewall/blob/master/usr/bin/whonix_firewall#L27\nhttps://github.com/Whonix/whonix-gw-firewall/blob/5ebca43416269a5fd42c98a80af1b0b3d38adecf/usr/bin/whonix_firewall#L27\n\nFiles that end with `~` are ignored. Files that end with `.dpkg-*` are ignored. So you could rename these files for example to `.dpkg-nouse`.\n\n> If not, maybe consider using a standard extension of `.conf` and only include those?\n\nCreated T286 for it.\n\n> Based on Patrick's answer to above, user may need to delete:\n> /etc/whonix_firewall.d/32_qubes.dist (may be named differently; depending on version upgrading from)\n\nYes, delete it."},{"author":"nrgaway","date_created":1430309911,"date_modified":1430309911,"content":"@Patrick, I created a new version that hopefully solves the `control-port-filter-python` not re-enabling properly... I had a typo in the maintainers postinst configuration file.\n\nSo when you get a chance, please tag and upload `10.0.5` to the developers repo\n\nThanks.\n\nPS. Could you also tag `9.6.9` as well please.  That version does not need to go into developers repo, but it is tied to the current qubes templates release and will be kept for 'history' to complete the `qubes-template-whonix` module.  The master `qubes-template-whonix` branch will be updated with the reference to this tag, then its version will immediately be bumped and merge in `10.0`.  The purpose is to maintain a history, even though it was never released, since there were many changes since the last release of `9.6.2` and allows users to maintain 9.6 if they so choose."},{"author":"Patrick","date_created":1430351986,"date_modified":1430351986,"content":"Signed, pushed `9.6.9-1`.\n\nSigned, pushed `10.0.5-1` and added to `developers` repository."},{"author":"nrgaway","date_created":1430360833,"date_modified":1430360833,"content":"Thanks, tests are successful for me.\n\nI will start a testers task"}]},"PHID-TASK-ahfvo6wysi42ai7hwrwc":{"id":"274","title":"control-port-filter-proxy sd_notify support","status":"resolved","priority":"Normal","author":"Patrick","description":">>! In T273#3852, @nrgaway wrote (edited):\n> There are a few deficiencies we may want to consider for `tor-controlport-filter` for the future:\n> ~~1. cpfp.py should daemonize itself and write the PID to the proper location (done)~~\n> 2. [/usr/lib/tor-controlport-filter](https://github.com/Whonix/control-port-filter-python/blob/master/usr/lib/tor-controlport-filter) should implement a `watchdog` (`sd_notify`) function\n\n> The watchdog feature would be nice to have, which would restart the service if it appeared to be running, but became unresponsive.\n\n-----\n\npython-daemon looks interesting. In Debian:\n\n* https://packages.debian.org/stretch/python3-daemon\n* (maybe info: https://pypi.python.org/pypi/python-daemon)\n\nwith sd-notify:\nhttps://packages.debian.org/sid/python3-cotyledon\n\npython3-sdnotify:\n\n* https://packages.debian.org/stretch/main/python3-sdnotify\n* (more info https://github.com/bb4242/sdnotify)\n\npython3-systemd:\nhttps://packages.debian.org/stretch/python3-systemd\n\n-----\n\nTODO:\n* `sd_notify` - T274#4525\n","comments":[{"author":"troubadour","date_created":1430172191,"date_modified":1430172191,"content":"The daemonized control-port-filter-python is nearly completed (with some tricks for wheezy).\n\nRemarks and suggestions.\n\nI will create a new repository, suggested name `control-port-filter-daemon`. Instead of cpfp.py, the file name could be `cpfpd` without the .py extension. Since it's a daemon, perhaps a better path would be /usr/bin. I don't know in systemd, but in init.d, it would look like\n```case \"$1\" in\n  start)\n    echo \"Starting control port filter\" \n    cpfpd start\n    ;;\n  stop)\n    echo \"Stopping control port filter\"\n    cpfpd stop\n    ;;\n  restart)\n     \"Restarting control port filter\"\n    cpfpd restart\n    ;;\nesac\n```\nWhich leads to the first issue. There is no `status` in python-daemon. It could probably be implemented in a non standard way. To be explored.\n\nAlso, when the daemon is running, starting it again outputs a timeout error because the lock file (pid.lock) exists, it seems. Looks like a bug, the daemon is still running.\n\nQuoting  @nrgaway \n> cpfp.py should daemonize itself and write the PID to the proper location\nWhat is the proper location for a daemon pid?"},{"author":"Patrick","date_created":1430172843,"date_modified":1430172843,"content":">>! In T274#4070, @troubadour wrote:\n> The daemonized control-port-filter-python is nearly completed (with some tricks for wheezy).\n\nI guess this is sufficient for Whonix 11 / jessie.\n\n> I will create a new repository, suggested name `control-port-filter-daemon`.\n\nI don't think this should become a separate package. Never saw something like this. Like apache-server and apache-daemon, doesn't exist.\n\nJust installing control-port-filter-python without the -daemon package, what's the use case for that? Anyone up to that could rather just disable the systemd unit and have the same effect.\n\n> Instead of cpfp.py, the file name could be `cpfpd` without the .py extension. Since it's a daemon, perhaps a better path would be /usr/bin.\n\nI guess /usr/sbin as per https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard.\n\n> Which leads to the first issue. There is no `status` in python-daemon. It could probably be implemented in a non standard way. To be explored.\n\nHm. Do you know any existing python daemon(s) so we can do a standard thing?\n\n> What is the proper location for a daemon pid?\n\n`/var/run/control-port-filter-python.pid`? Looks like most packages do it that way."},{"author":"Patrick","date_created":1430173043,"date_modified":1430173043,"content":"I thought it's working like this: you somehow import a library into a python script, that does the listening to events. Systemd starts the binary. Once the system shuts down or [manually] or so, systemd sends a signal to the daemon. It receives it and acts accordingly.\n\nThe python-daemon package is more like separate binary in between?"},{"author":"nrgaway","date_created":1430173265,"date_modified":1430173265,"content":">>! In T274#4070, @troubadour wrote:\n> The daemonized control-port-filter-python is nearly completed (with some tricks for wheezy).\n> \n> Remarks and suggestions.\n> \n> I will create a new repository, suggested name `control-port-filter-daemon`. Instead of cpfp.py, the file name could be `cpfpd` without the .py extension. Since it's a daemon, perhaps a better path would be /usr/bin. I don't know in systemd, but in init.d, it would look like\n> ```case \"$1\" in\n>   start)\n>     echo \"Starting control port filter\" \n>     cpfpd start\n>     ;;\n>   stop)\n>     echo \"Stopping control port filter\"\n>     cpfpd stop\n>     ;;\n>   restart)\n>      \"Restarting control port filter\"\n>     cpfpd restart\n>     ;;\n> esac\n> ```\n> Which leads to the first issue. There is no `status` in python-daemon. It could probably be implemented in a non standard way. To be explored.\n\nWe will not need a `status` function for `systemd`; `sysv init` can also implement following procedure.  `status` will be based on PID and if PID is running, status will return with success when using `systemctl status control-port-filter-daemon`.\n\nIf you also implement the watchdog function (`sd_notify`), systemd will automatically restart the daemon if the watchdog has not heard from daemon in the specified time period which indicates the daemon process is most likely locked up.\n\n> \n> Also, when the daemon is running, starting it again outputs a timeout error because the lock file (pid.lock) exists, it seems. Looks like a bug, the daemon is still running.\n> \n> Quoting  @nrgaway \n>> cpfp.py should daemonize itself and write the PID to the proper location\n> What is the proper location for a daemon pid?\nEither:\n`/var/run/control-port-filter-daemon.pid` \n\n- OR -\n\n`/var/run/control-port-filter-daemon/pid` \n\nIf a `/var/run/control-port-filter-daemon` directory is not required for other related files, then it saves having to create such a directory by placing the pid in directly in `/var/run`.\n\n`whonixcheck` would also need to be update to use new location for `pid`\n"},{"author":"troubadour","date_created":1430246572,"date_modified":1430247187,"content":">>! In T274#4071, @Patrick wrote:\n> I don't think this should become a separate package. Never saw something like this. Like apache-server and apache-daemon, doesn't exist.\n> \n> Just installing control-port-filter-python without the -daemon package, what's the use case for that? Anyone up to that could rather just disable the systemd unit and have the same effect.\n\n> I thought it's working like this: you somehow import a library into a python script, that does the listening to events. Systemd starts the binary. Once the system shuts down or [manually] or so, systemd sends a signal to the daemon. It receives it and acts accordingly.\n\n> The python-daemon package is more like separate binary in between?\nI should have mentioned that the daemon and  control-port-filter are in a single package (single file). Instead of importing control-port-filter in the daemon, it's in the same script. Same behavior, but self-contained.\n\n Created a temporary repository. You can see the code at https://github.com/troubadoour/cpfpd/blob/master/cpfpd\n\nWas thinking of a new repository because of the major code change and the different path. And the name of the package would become `control-port-filter-daemon`.\n\nThe pid file should be in `/var/run/control-port-filter-daemon/`, becuse the daemon creates three files:\n```host.MainThread.nnnnn\npid\npid.lock```\n\n\n\n\n>>! In T274#4073, @nrgaway wrote:\n> We will not need a `status` function for `systemd`; `sysv init` can also implement following procedure.  `status` will be based on PID and if PID is running, status will return with success when using `systemctl status control-port-filter-daemon`.\nThat's good news.  It's probably why it's not implemented in python-daemon.\n"},{"author":"Patrick","date_created":1430247141,"date_modified":1430247141,"content":"During upgrades we have more trouble when we deprecate packages (ex: `control-port-filter-python`), want them uninstalled in favor of new packages (ex: `control-port-filter-daemon`). The `control-port-filter`-> `control-port-filter-python` transition has cost quite some effort.\n\nI see no reason why we should abstain from huge refactoring/moving around files in existing packages. We can keep `control-port-filter-python` as is (perhaps with minor maintenance fixes if really urgent) in Whonix 10 and have a major revision in Whonix 11.\n\nSounds good."},{"author":"troubadour","date_created":1430247684,"date_modified":1430247684,"content":"Yes, nothing urgent. This change is not intended for Whonix 10, say we have a good base and we can fine tune the script before Whonix 11 release. I guess some small issues might solve themselves after it's tested in a jessie based Whonix. We could change the tag, make tit `Whonix 11`."},{"author":"Patrick","date_created":1430248591,"date_modified":1430248591,"content":"Yes.\n\n(I just didn't add the #Whonix_11 tag, because I didn't intent to do it myself for #Whonix_11. Was more like adding it to the pile. But if you plan on doing stuff for a specific release tag, please feel free to add the tag and/or to claim the task.)\n\n(I'll start merging your code and testing it on my system shortly after you're done as usually so I am not very concerned about missing issues.)"},{"author":"troubadour","date_created":1430686915,"date_modified":1430686915,"content":"Pushed some changes in control-port-filter-python.\n\nThe last one includes python-daemon in debian/control.\n\nReplaced  `usr/lib/control-port-filter-python/cpfp.py` with  `usr/sbin/cpfpd`in  https://github.com/troubadoour/control-port-filter-python/commit/d7d5839ce50b7dc9c3d64cb84b644bda63ef6051\n\nNew  etc/init.d/control-port-filter-python in https://github.com/troubadoour/control-port-filter-python/commit/a7875d45b79a600c40ebb1ccfbed05a78c9d80ca\n\nNew  lib/systemd/control-port-filter-python.service in https://github.com/troubadoour/control-port-filter-python/commit/e5a376f03aa80810af0078e4dd5222eba5b36b6f\n\nIt 's tested in Whonix 10.0.0.5.5. A strange issue (to me). the daemon dose not start at boot, but it runs after \n``` sudo service control-port-filter-python start```\n`stop`, `restart`, `status` work."},{"author":"troubadour","date_created":1431120462,"date_modified":1431120462,"content":"An update to cpfpd.\n\nPushed a few commits. The relevant ones to some issues.\n\nhttps://github.com/troubadoour/control-port-filter-python/commit/9226b2923034e011a994941d37578e6a93720e3f\nIn ControlPortFilter() init(), replace `/dev/tty` with `/dev/null` for stdout and stderr. `/dev/tty` is unknown when the service is started by systemd.\n\nhttps://github.com/troubadoour/control-port-filter-python/commit/5a06efa8cad9c23734963740400784b376a8ec82\nThe service  does not start when user and group are set to `debian-tor`. Commented out the settings in `control-port-filter-python.service`.\n\nNow the daemon starts, but is only `activating`, it does not reach the `active` state and is restarted after the `TimeoutSec` period. Investigating.\n\nOther commits:\nhttps://github.com/troubadoour/control-port-filter-python/commit/f0eedc86739fb2524be35fe29fa92dbc30f9e80a\nCreate /var/run/control-port-filter-python directory, needed because three files are written by the daemon.\n\nhttps://github.com/troubadoour/control-port-filter-python/commit/baf8eaa1bb891343bd6ac6aa5fc51e2f7673f833\nCopyright (lintian warning).\n\nStill trying to get the man page without warning."},{"author":"Patrick","date_created":1431183982,"date_modified":1431183982,"content":"I think using `/bin/touch` in systemd unit files might work, but it's non-ideal. systemd units aren't shell scripts, and therefore fast. Forking to `touch` is \"slow\". The canonical way looks like using `/usr/lib/tmpfiles.d/` - http://www.freedesktop.org/software/systemd/man/tmpfiles.d.html.\n\n> https://github.com/troubadoour/control-port-filter-python/commit/9226b2923034e011a994941d37578e6a93720e3f\n> In ControlPortFilter() init(), replace `/dev/tty` with `/dev/null` for stdout and stderr. `/dev/tty` is unknown when the service is started by systemd.\n\nThat works and if we don't need `/dev/tty`, that's fine. Otherwise we could tell systemd to wait until `/dev/tty` is available by figuring out on which dependency to add.\n \n> Other commits:\n> https://github.com/troubadoour/control-port-filter-python/commit/f0eedc86739fb2524be35fe29fa92dbc30f9e80a\n> Create /var/run/control-port-filter-python directory, needed because three files are written by the daemon.\n\nThat's fine for ports and running as root. But otherwise I think it's up to systemd creating these files as owned by user debian:tor and running as user debian:tor.\n\n> Still trying to get the man page without warning.\n\n* `debian/control`: Add to `Build-Depends:` `ruby-ronn (>= 0.7.3)`\n* for `debian/rules`, see boilerplate of a simple \"similar\" (in sense of man page) requirements: https://github.com/Whonix/tor-ctrl/blob/master/debian/rules It's just the following block that needs to be added.\n\n```\noverride_dh_install:\nmake manpages\ndh_installman $(CURDIR)/debian/tmp-man/*\n```\n\n* on how to write a man page, similarly see boilerplate: https://github.com/Whonix/tor-ctrl/blob/master/man/tor-ctrl.8.ronn (or other packages that have simpler man pages)"},{"author":"Patrick","date_created":1431342837,"date_modified":1431342837,"content":"Even though you haven't requested review yet, I took the liberty to merge your latest changes. :) Needed to man page creation, because that fixed a lintian warning, that otherwise would make builds from master inconvenient. Added a small fix to the man page on top to fix the last lintian warning:\nhttps://github.com/Whonix/control-port-filter-python/commit/d6c62e9625ae41ceeb1e15f501b0513b1c6c9ca8\n"},{"author":"Patrick","date_created":1431519905,"date_modified":1431519905,"content":"An issue. When running `sudo -u debian-tor /usr/sbin/cpfpd start` while `/var/run/control-port-filter-python` does not exist, cpfpd will exit `0`. When it fails to write into `/var/run/control-port-filter-python` it would be great to have it exit non-zero. Fixing that could help with debugging the systemd unit file.\n\nApart from that, running `sudo -u debian-tor /usr/sbin/cpfpd start` and `sudo -u debian-tor /usr/sbin/cpfpd stop` works for me."},{"author":"Patrick","date_created":1431521693,"date_modified":1431521693,"content":"As an example package we could look into a package from Debian: `apt-get download bcfg2-server`. It depends on `python-daemon` and comes with a systemd unit file."},{"author":"troubadour","date_created":1431634399,"date_modified":1431634399,"content":"`sudo -u debian-tor /usr/sbin/cpfpd start` and `sudo -u debian-tor /usr/sbin/cpfpd stop` works for me too. The problem is when the daemon is run with systemd.\n\n`sudo systemctl start control-port-filter-python` works but you have to ctrl-c to get back the terminal. `sudo systemctl stop control-port-filter-python` also work, and here the the output of `sudo systemctl status control-port-filter-python`:\n```● control-port-filter-python.service - Control Port Filter Proxy\n   Loaded: loaded (/lib/systemd/system/control-port-filter-python.service; enabled)\n   Active: activating (start) since Thu 2015-05-14 19:59:31 UTC; 4s ago\n  Process: 19753 ExecStartPre=/bin/chown --recursive debian-tor:debian-tor /var/log/%p.log (code=exited, status=0/SUCCESS)\n  Process: 19750 ExecStartPre=/bin/touch /var/log/%p.log (code=exited, status=0/SUCCESS)\n  Process: 19748 ExecStartPre=/bin/chown --recursive debian-tor:debian-tor /var/run/%p (code=exited, status=0/SUCCESS)\n  Process: 19745 ExecStartPre=/bin/mkdir -p /run/%p (code=exited, status=0/SUCCESS)\n  Process: 19741 ExecStartPre=/usr/lib/anon-shared-helper-scripts/torsocks-remove-ld-preload (code=exited, status=0/SUCCESS)\n  Control: 19756 (cpfpd)\n   CGroup: /system.slice/control-0.port-filter-python.service\n           └─19756 /usr/bin/python /usr/sbin/cpfpd start\n```\nThe service is activating instead of running, and is restarted regularly at the timeout interval set in the unit file. It looks like the process is not detached. Looking into the `bcfg2-server` code, there might be something useful in there (thanks for that one, by the way)."},{"author":"troubadour","date_created":1431636093,"date_modified":1431636119,"content":"In the unit file, changing `Type = forking` to `Type = simple` solves this issue.\nhttps://github.com/troubadoour/control-port-filter-python/commit/9f80d19f778a5d6d047b1fe24212905f8b003c28"},{"author":"Patrick","date_created":1431644096,"date_modified":1431644096,"content":"Nice. Merged. Glad you figured out! Works well. I'll add some commits on the systemd unit file on top."},{"author":"Patrick","date_created":1431644671,"date_modified":1431644671,"content":"`systemd unit: removed \"ExecStartPre = /usr/lib/anon-shared-helper-scripts/torsocks-remove-ld-preload\" - Doesn't work with systemd and also not required. - https://phabricator.whonix.org/T274`:\nhttps://github.com/Whonix/control-port-filter-python/commit/6f6734588381a4129e4209b4bee86ba5e1fe0bdb\n\n`systemd unit file: replaced ExecStartPre touch/mkdir stuff with usr/lib/tmpfiles.d mechanism - https://phabricator.whonix.org/T274`:\nhttps://github.com/Whonix/control-port-filter-python/commit/78c0a49b0450152daee1446892d4de1607525e4c\n\n`systemd unit: added 'SuccessExitStatus = 143' so when systemd stopped the service it will consider it terminated with status success rather than failure - https://phabricator.whonix.org/T274`:\nhttps://github.com/Whonix/control-port-filter-python/commit/11e2cb5fc61a341ec8eff8bbb8086b577e6387b6"},{"author":"Patrick","date_created":1431646060,"date_modified":1431646060,"content":"Anything left to do here?\n\nWell, you could go for perfection. Implement sd_notify. Some pointers (dunno if they lead somewhere).\n\n- http://stackoverflow.com/a/21388697/2605155\n- https://github.com/kirelagin/pysystemd-daemon (just a single small file)\n\nBut from my perspective for now, that would be just for the sake of it. For learning. As an intellectual challenge. I don't see an actual issue that would be solved. Perhaps @nrgaway has some argument in favor of sd_notify? We would open a follow up task if needed.\n\nOtherwise, unless I missed something or you think something... This should be closeable or moveable to Whonix 12?"},{"author":"nrgaway","date_created":1431717020,"date_modified":1431717020,"content":"`sd_notify` would be used if you want to have watchdog monitor the service.  If the service does not respond within X amount of seconds (IE did not send a notification it was still active within this time period), then `systemd` would then restart the service.\n\nSince this seems to be a critical service, I would suggest implementing it for `Whonix 11`.\n\nI leave that up to @troubadour if he even wants to implement this and @Patrick to decide the level of importance.\n\nI am also assuming Whonix 11 is at least more than 4-6 weeks away from release. If you have a shorter release frame in mind, please let me know as I would need to shift my coding efforts around.  My goal was to complete build of Whonix 11 this weekend; then shift to `Qubes Pre-configuration` for a few weeks, then back to streamlining the `Whonix 11` build"},{"author":"Patrick","date_created":1431723304,"date_modified":1431723304,"content":"Difficult question. I am debating with myself. The normal case should be no daemons crashing. If they do crash. something is very wrong that we should apply a-real-fix (tm) to, no? On the other hand, If the service was crashing due to some hypothetical parsing issue, I would actually prefer the affected user noticing and reporting an issue. An automatically restarted service with no one noticing because of the auto restart would be bad. The daemon is very stable at this preset. How much code would be added by implementing the sd_notify protocol? A reason against would be if it's getting complexer so we actually understand it less. If it's just a few lines, that doesn't apply."},{"author":"troubadour","date_created":1431723369,"date_modified":1431723369,"content":"I am putting `sd_notify` in the pipeline, without guarantee that it will be completed  before Whonix 11 release.\n\nOn the other hand, systemd restarts the service after`TimeoutSec` if it does not receive a proper notification. It happens in one situation at least, when using `Type = forking` in the unit file (cpfpd is running in that configuration, but systemd does not seem aware of it).\n\nAs Patrick suggests, we could move it to Whonix 12 and open a follow up task when required. \n\nMoved `import gevent` where it should be (beginning of the script).\nhttps://github.com/troubadoour/control-port-filter-python/commit/a608e24cf84978b0e9ba43f2b9ddd060b0b6e7fa\n\nThat should be it for the daemon part. There will be some PEP8 / pylint compliance adjustments, will use T243.\n\n "},{"author":"nrgaway","date_created":1431724912,"date_modified":1431724912,"content":">>! In T274#4522, @Patrick wrote:\n> Difficult question. I am debating with myself. The normal case should be no daemons crashing. If they do crash. something is very wrong that we should apply a-real-fix (tm) to, no? On the other hand, If the service was crashing due to some hypothetical parsing issue, I would actually prefer the affected user noticing and reporting an issue. An automatically restarted service with no one noticing because of the auto restart would be bad. The daemon is very stable at this preset. How much code would be added by implementing the sd_notify protocol? A reason against would be if it's getting complexer so we actually understand it less. If it's just a few lines, that doesn't apply.\n\nDaemons can crash for many reasons, many of which have nothing to do with the daemon itself.  There are kernel issues, memory, cpu, races, so many things that are not in a daemons control and that's why watchdog exists"},{"author":"Patrick","date_created":1431750949,"date_modified":1431750949,"content":"Okay."},{"author":"Patrick","date_created":1431751565,"date_modified":1431751565,"content":"Having consensus on that one... It might follow... systemd 'Restart=' and sd_notify for sdwdate and whonixcheck: T311\n"},{"author":"Patrick","date_created":1487700640,"date_modified":1487717680,"content":"Great work by @joysn1980 with the initial implementation.\n\n- https://github.com/Whonix/control-port-filter-python/commit/8929b0da163a6c472199a14df0354b7f4d2d3909\n- https://github.com/Whonix/control-port-filter-python/commit/e568c7a3e464119ae22efc42ae9f827c104d925f\n\nMerged. And added a few minor commits on top.\n\n- https://github.com/Whonix/control-port-filter-python/commit/a0b72aa0c5e07ff38b48d5fd22f68ab8f4cc1cac\n- https://github.com/Whonix/control-port-filter-python/commit/219373ba55f8ebbb3b0372bc5298b4048c5515ec\n- https://github.com/Whonix/control-port-filter-python/commit/a68fb8199f709bd18290e423502ffc261f2b96a6\n- https://github.com/Whonix/control-port-filter-python/commit/5f0468a48bd14628ae144a6b7881a30bb09f80ed\n- https://github.com/Whonix/control-port-filter-python/commit/e176f6ebab9cd4f69824b556d83abfb08d6d85e0\n- https://github.com/Whonix/control-port-filter-python/commit/61455a4162b7fa5527d526f61a72ae1d74ff8034\n\n-----\n\n- https://github.com/Whonix/control-port-filter-python/blob/master/lib/systemd/system/tor-controlport-filter.service\n- https://github.com/Whonix/control-port-filter-python/blob/master/usr/lib/tor-controlport-filter\n\n-----\n\nTests:\n\n\n\"sudo service tor-controlport-filter status\" contains\n\n>    Status: \"Serving Thread started\"\n>    Status: \"Serving Thread active. count: 12 / 10000\"\n>    Status: \"Serving Thread active. count: 55 / 10000\"\n>    etc.\n\n\n\n\nNow, if `n.notify(\"WATCHDOG=1\")` gets commented out (to simulate what would happen), systemd correctly detects the stale daemon and restarts it.\n\n> Feb 21 17:48:26 host systemd[1]: Started Tor control port filter proxy.\n> Feb 21 17:48:36 host systemd[1]: tor-controlport-filter.service: Watchdog timeout (limit 10s)!\n> Feb 21 17:48:36 host systemd[1]: tor-controlport-filter.service: Killing process 5419 (tor-controlport) with signal SIGABRT.\n> Feb 21 17:48:36 host systemd[1]: tor-controlport-filter.service: Main process exited, code=killed, status=6/ABRT\n> Feb 21 17:48:36 host systemd[1]: tor-controlport-filter.service: Unit entered failed state.\n> Feb 21 17:48:36 host systemd[1]: tor-controlport-filter.service: Failed with result 'watchdog'.\n> Feb 21 17:48:37 host systemd[1]: tor-controlport-filter.service: Service hold-off time over, scheduling restart.\n> Feb 21 17:48:37 host systemd[1]: Stopped Tor control port filter proxy.\n> Feb 21 17:48:37 host systemd[1]: Starting Tor control port filter proxy...\n\nSimilarly, if `n.notify(\"READY=1\")` gets commented out to simulate a daemon that fails to start, systemd rightly never considers the daemon started and tries starting it again.\n\n-----\n\nI am not sure if it was the best idea to move `n.notify(\"READY=1\")` to `def service_actions(self):`. By adding `n.notify(\"READY=1\")` just before `server.serve_forever()` I was not sure if a race condition might happen. Currently not the very most pretty solution to keep calling `n.notify(\"READY=1\")` but it works great.\n\nAlso arbitrarily chosen `10` for `WatchdogSec=10`. No idea if that is a good value or if a lower/higher one should be used."},{"author":"Patrick","date_created":1490839187,"date_modified":1490839187,"content":"`tor-controlport-filter` has been renamed to `onion-grater` by upstream Tails.\n\nhttps://git-tails.immerda.ch/onion-grater\n(web interface is broken, but git clone works)\n\n----\n\nhttps://github.com/Whonix/onion-grater\n\n----\n\nsd-notify patch pull request sent to upstream Tails:\nhttps://mailman.boum.org/pipermail/tails-dev/2017-March/011327.html"}]},"PHID-TASK-5mimphcah6bqytwj725s":{"id":"273","title":"control-port-filter-python.service exits pre-maturely","status":"resolved","priority":"Normal","author":"nrgaway","description":"It seems `control-port-filter-python`  exits pre-maturely.  I am unaware of its expected behaviour since this seems to be a new modules for `Whonix 10`.\n\nIf I manually restart the `control-port-filter-python` after booting the gateway, it seems to run fine, otherwise it exits with no error and therefore `Whonix Workstation` can not connect.\n\n```\nStatus after booting\n====================\nroot@host:/etc/init.d# systemctl status control-port-filter-python \ncontrol-port-filter-python.service - LSB: Control Port Filter Proxy\n   Loaded: loaded (/etc/init.d/control-port-filter-python)\n   Active: active (exited) since Thu 2015-04-23 12:42:08 UTC; 6min ago\n  Process: 1250 ExecStart=/etc/init.d/control-port-filter-python start (code=exited, status=0/SUCCESS)\n\nApr 23 12:42:08 host systemd[1]: Starting LSB: Control Port Filter Proxy...\nApr 23 12:42:08 host systemd[1]: Started LSB: Control Port Filter Proxy.\n\nRestart service\n===============\nroot@host:/etc/init.d# systemctl restart control-port-filter-python \n\nStatus after restarting service\n===============================\nroot@host:/etc/init.d# systemctl status control-port-filter-python \ncontrol-port-filter-python.service - LSB: Control Port Filter Proxy\n   Loaded: loaded (/etc/init.d/control-port-filter-python)\n   Active: active (running) since Thu 2015-04-23 12:49:37 UTC; 46s ago\n  Process: 11024 ExecStop=/etc/init.d/control-port-filter-python stop (code=exited, status=0/SUCCESS)\n  Process: 11037 ExecStart=/etc/init.d/control-port-filter-python start (code=exited, status=0/SUCCESS)\n   CGroup: name=systemd:/system/control-port-filter-python.service\n           └─11054 /usr/bin/python /usr/lib/control-port-filter-python/cpfp.py\n\nApr 23 12:49:37 host systemd[1]: Starting LSB: Control Port Filter Proxy...\nApr 23 12:49:37 host systemd[1]: Started LSB: Control Port Filter Proxy.\n```","comments":[{"author":"Patrick","date_created":1429820026,"date_modified":1429820026,"content":"As of Whonix 10.0.0.5.5 / control-port-filter-python (0.4-1), on wheezy, the sysvinit script and #control-port-filter-python seems to work very stable. I guess it \"just\" needs a proper #systemd unit file."},{"author":"nrgaway","date_created":1429824182,"date_modified":1429824182,"content":"I can write a systemd unit file, but that does not explain why the cpfp.py process is exiting in the first place.\n\nThis seems to be my only blocking item to being able to release Whonix 10 workstation.\n\nPlease share some additional information that will assist in the creation of a systemd files such as:\n- At what point should it be started?  Before or after Tor?\n- Does it need to be restarted or reloaded if Tor is restarted or reloaded\n- Any security considerations\n- Does cpfp log its output?  to syslog?\n- Are there any conditions to starting the process?\n- Anything else you may think I may find useful\n"},{"author":"Patrick","date_created":1429825827,"date_modified":1429825827,"content":">>! In T273#3833, @nrgaway wrote:\n> I can write a systemd unit file\n\nYes, please.\n\n> but that does not explain why the cpfp.py process is exiting in the first place.\n\nIndeed.\n\nRelated, FYI:\nhttps://www.whonix.org/forum/index.php/topic,1167\n\n> - At what point should it be started?  Before or after Tor?\n\nNot defined at the moment. Doesn't matter. If Tor is not yet started, it will [hopefully] behave as if Tor is not yet started. No issue there. whonixcheck waits for it up to 30 seconds, seems sufficient. Probably not [reverse]dependency in sysvinit / systemd required. sdwdate-plugin-anon-shared-con-check waits as long as needed.\n\n> - Does it need to be restarted or reloaded if Tor is restarted or reloaded\n\nNo need.\n\n> - Any security considerations\n\nNone that I can see.\n\n> - Does cpfp log its output?  to syslog?\n\nAt the moment using python `logging`, using `/var/log/control-port-filter-python.log`. @troubadour might change this in future (T243).\n\n> - Are there any conditions to starting the process?\n\nNot that I know. Just a usual daemon. Not too important. Just what the current sysvinit script does. Nothing fancy.\n\n> - Anything else you may think I may find useful\n\nNope.\n"},{"author":"nrgaway","date_created":1429848799,"date_modified":1429848799,"content":"I have completed the systemd unit file.  There are a few deficiencies we may want to consider for `cpfp.py` for the future:\n1. cpfp.py should daemonize itself and write the PID to the proper location\n2. cpfp.py should implement a `watchdog` (`sd_notify`) function\n\nI have impleemnted a work-around in systemd unit file to use `start-stop-daemon` to deamonize `cpfp` since otherwise the PID would not be created and `whonixcheck` raised a concern.\n\nThe watchdog feature would be nice to have, which would restart the service if it appeared to be running, but became unresponsive.\n\nHere is the systemd unit file:\n`/lib/systemd/system/control-port-filter-python.service`\n```\n# control-port-filter-python.service -- Filters out dangerous control port \n# messages in Tor control port.\n#\n# See also related configuration file:\n# /etc/tmpfiles.d/control-port-filter-python.conf\n\n[Unit]\nDescription = Control Port Filter Proxy\nConditionPathExists = /usr/lib/control-port-filter-python/cpfp.py\nAfter = remote-fs.target syslog.target network.target\n\n[Service]\nType = forking\nUser = debian-tor\nGroup = debian-tor\n\n## Run ExecStartPre with root-permissions\nPermissionsStartOnly=true\nExecStartPre = /usr/lib/anon-shared-helper-scripts/torsocks-remove-ld-preload\nExecStartPre = /bin/touch /var/log/%p.log ; /bin/chown --recursive debian-tor:debian-tor /var/log/%p.log\nPIDFile = /var/run/%p/pid\n\n## Run ExecStart with User=debian-tor / Group=debian-tor\n# ExecStart = /usr/lib/control-port-filter-python/cpfp.py\n#\n## TODO: cpfp.py should daemonize itself and handle pid file creation\nExecStart = /sbin/start-stop-daemon \\\n      --start \\\n      --quiet \\\n      --background \\\n      --make-pidfile \\\n      --pidfile /var/run/%p/pid \\\n      --chuid debian-tor:debian-tor \\\n      --exec /usr/lib/control-port-filter-python/cpfp.py\n\n##\n## General options\n##\n\nTimeoutSec = 30\nRestart = always\nStandardOutput = syslog\n\n## TODO: Watchdog disabled.  cpfp.py would need to implement the sd_notify protocol\n# WatchdogSec = 1m\n\n##\n## Hardening\n##\n\nPrivateTmp=yes\n\n[Install]\nWantedBy=multi-user.target\n```\n\nAnd related configuration file:\n` /etc/tmpfiles.d/control-port-filter-python.conf`\n```\nd /var/run/control-port-filter-python 02750 debian-tor debian-tor\n```"},{"author":"nrgaway","date_created":1429849123,"date_modified":1429849123,"content":">>! In T273#3835, @Patrick wrote:\n>>>! In T273#3833, @nrgaway wrote:\n>> but that does not explain why the cpfp.py process is exiting in the first place.\n> \n> Indeed.\n\nThe issue was related to IP addresses being of the old value `10.152.152.10` and the init file not restarting on that error.  As an `init` file it must have been starting before the search and replace function; before network was started maybe.\n\nAnyway, with the new `systemd` unit file in place it seems to be working correctly.  I am currently re-building both the gateway and workstation for a final test."},{"author":"Patrick","date_created":1429851793,"date_modified":1429851793,"content":"Nice!\n\nCan you add this to git please?\n+ copyright?\nFork https://github.com/Whonix/control-port-filter-python?\n\nOther TODO:\n* add to debian/control\n* add to debian/rules\n* remove syvinit script\n\nI don't mind who is doing this.\n\n>>! In T273#3852, @nrgaway wrote:\n> There are a few deficiencies we may want to consider for `cpfp.py` for the future:\n> 1. cpfp.py should daemonize itself and write the PID to the proper location\n> 2. cpfp.py should implement a `watchdog` (`sd_notify`) function\n\nCreated T274 for it.\n"},{"author":"Patrick","date_created":1430085677,"date_modified":1430085677,"content":"@nrgaway?"},{"author":"nrgaway","date_created":1430092008,"date_modified":1430092008,"content":">>! In T273#3929, @Patrick wrote:\n> @nrgaway?\n\nYou rang?  Are you asking me to commit it to repo?  "},{"author":"Patrick","date_created":1430092958,"date_modified":1430092958,"content":">>! In T273#3939, @nrgaway wrote:\n>>>! In T273#3929, @Patrick wrote:\n>> @nrgaway?\n> \n> You rang?\n\nYeah! :)\n\n> Are you asking me to commit it to repo?  \n\nNot necessarily. I am not employing you, so I cannot ask you for anything.\n\nI was hoping you address https://phabricator.whonix.org/T273#3867. To re-state...\n\nCan you fork and commit the systemd unit file to control-port-filter-python? You plan on doing it, prefer doing it yourself or prefer me doing it? I actually prefer if you do it, because then you get the git commit and credit in git history and licensing will be sorted out. Since this is a volunteer based thing, it's also fine for me to take your systemd unit file as is if you wish and do the commit myself.\n\nAnd what about the other TODO mentioned in my previous comment? Same here. If you wish to do it, that's fine. If you prefer me doing it, that's also fine.\n\nWas just ringing to find out if you plan on doing it or if I should do it."},{"author":"nrgaway","date_created":1430093258,"date_modified":1430093258,"content":">>! In T273#3941, @Patrick wrote:\n>>>! In T273#3939, @nrgaway wrote:\n>>>>! In T273#3929, @Patrick wrote:\n>>> @nrgaway?\n>> \n>> You rang?\n> \n> Yeah! :)\n> \n>> Are you asking me to commit it to repo?  \n> \n> Not necessarily. I am not employing you, so I cannot ask you for anything.\n> \n> I was hoping you address https://phabricator.whonix.org/T273#3867. To re-state...\n> \n> Can you fork and commit the systemd unit file to control-port-filter-python? You plan on doing it, prefer doing it yourself or prefer me doing it? I actually prefer if you do it, because then you get the git commit and credit in git history and licensing will be sorted out. Since this is a volunteer based thing, it's also fine for me to take your systemd unit file as is if you wish and do the commit myself.\n> \n> And what about the other TODO mentioned in my previous comment? Same here. If you wish to do it, that's fine. If you prefer me doing it, that's also fine.\n> \n> Was just ringing to find out if you plan on doing it or if I should do it.\n\nYes I can do it.  I would prefer to get Whonix11 build going so I can test it within that environment.  It should just work, but I do prefer to test on the targeted platform before I commit something. \n\nHopefully I can figure out why I am getting package problems building Whonix11 tonight"},{"author":"nrgaway","date_created":1430127320,"date_modified":1430127320,"content":"Do you want me to keep both `systemd` and `sysv init` files in the package.  Both of them could go in the `/usr/share/control-port-filter-python` directory and be available to anyone that may want to manually install the `sysv init` scripts.  At the same time a copy can be made of the `systemd` unit file to be placed in the `/lib/systemd/system` directory (since linking may not work)\n\nThen at some point you could even consider automatically detecting the init manager to install the appropriate configuration files.\n\nI figure once this is package, I may as well use it in `Whonix 10`, then there will not be any possibility of conflict down the road.  Same for `whonixcheck`; maybe `tor` as well"},{"author":"Patrick","date_created":1430129916,"date_modified":1430129916,"content":"I would like to do it the Debian way. Like how other Debian packages handle this. Using the standard way. I want to figure that out today. And only if the standard way of doing this seems inappropriate I would cook up a custom solution. Maybe you get to find this out before me? debian-mentors IRC?"},{"author":"Patrick","date_created":1430143118,"date_modified":1430143118,"content":"I've got an unrelated lintian error for an existing sysvinit script.\n\nSince the effort to keep sysvinit still somewhat supported is too high for too little gain, let's deprecate all sysvinit scripts for Whonix 11. Let's move those into the https://github.com/Whonix/deprecated-code repository and then say \"patches welcome\" if someone wants to reintroduce/contribute sysvinit support.\n\nAs for proper systemd unit files, for packages developed under the Whonix umbrella (where we are upstream), let's move them into the standard location /lib/systemd/system?\n\nDoes that sound alright? @nrgaway?\n\n-----\n\n`debian/rules`\n\n```\n\tdh $@\n```\n\n-->\n\n```\n\tdh $@ --with systemd\n```\n\n+ remove `dh_installinit` stuff.\n\n-----\n\n> And related configuration file:\n> ` /etc/tmpfiles.d/control-port-filter-python.conf`\n\nWrong location as per lintian.\n\n```\nE: control-port-filter-python: systemd-tmpfiles.d-outside-usr-lib etc/tmpfiles.d/control-port-filter-python.conf\nN: \nN:    The package ships a systemd tmpfiles.d(5) conf file outside\nN:    /usr/lib/tmpfiles.d/\nN:    \nN:    Severity: serious, Certainty: certain\nN:    \nN:    Check: systemd, Type: binary\nN: \n```\n\n-----\n\nPlease use lintian to check for other systemd related issues. They look easy to fix.\n"},{"author":"nrgaway","date_created":1430173579,"date_modified":1430173579,"content":">>! In T273#4007, @Patrick wrote:\n> I've got an unrelated lintian error for an existing sysvinit script.\n> \n> Since the effort to keep sysvinit still somewhat supported is too high for too little gain, let's deprecate all sysvinit scripts for Whonix 11. Let's move those into the https://github.com/Whonix/deprecated-code repository and then say \"patches welcome\" if someone wants to reintroduce/contribute sysvinit support.\n> \n> As for proper systemd unit files, for packages developed under the Whonix umbrella (where we are upstream), let's move them into the standard location /lib/systemd/system?\n> \n> Does that sound alright? @nrgaway?\n\nYes\n\n> \n> -----\n> \n> `debian/rules`\n> \n> ```\n> \tdh $@\n> ```\n> \n> -->\n> \n> ```\n> \tdh $@ --with systemd\n> ```\n> \n> + remove `dh_installinit` stuff.\n> \n> -----\n> \n>> And related configuration file:\n>> ` /etc/tmpfiles.d/control-port-filter-python.conf`\n> \n> Wrong location as per lintian.\n> \n> ```\n> E: control-port-filter-python: systemd-tmpfiles.d-outside-usr-lib etc/tmpfiles.d/control-port-filter-python.conf\n> N: \n> N:    The package ships a systemd tmpfiles.d(5) conf file outside\n> N:    /usr/lib/tmpfiles.d/\n> N:    \n> N:    Severity: serious, Certainty: certain\n> N:    \n> N:    Check: systemd, Type: binary\n> N: \n> ```\n> \n> -----\n> \n> Please use lintian to check for other systemd related issues. They look easy to fix.\n\nOk.\n\nHow do I run your makefile scripts manually to build package and produce these warnings?  Currently I do not use your Makefiles, so am un-aware of the process.\n\n"},{"author":"Patrick","date_created":1430174231,"date_modified":1430174231,"content":"You don't necessarily need Whonix's makefiles. Although I hope they make things real comfortable and fast to test/develop.\n\nJust `cd` into any package. Then run.\n\n```\nmake deb-pkg\n```\n\nIt builds the package and automatically runs `lintian` in the process.\n\nThere is also a separate `make lintian`.\n\nOr you could just build the package your way, and then manually run lintian.\n\n```\nlintian --pedantic --info --display-info --fail-on-warnings\n```\n\nOr just.\n\n```\nlintian --pedantic\n```\n\nTo cleanup (delete temporary files and produces artifacts in the parent directory), you can comfortably use `make deb-cleanup`.\n\nThere is a lot more. See `make help`."},{"author":"nrgaway","date_created":1430174655,"date_modified":1430174655,"content":"Thanks, I need to bookmark those instructions now :)\n\nIs there already a forum topic on this?"},{"author":"Patrick","date_created":1430174951,"date_modified":1430174951,"content":"Perhaps just remember `make help`. I guess you get used to the others quite soon. Forum... This one...\n`make / make help / makefile / package build process changes`:\nhttps://www.whonix.org/forum/index.php/topic,378\nIt's an older thread. I don't mind if we continue to use that one or create a new one."},{"author":"nrgaway","date_created":1430193439,"date_modified":1430193439,"content":"BTW, and as a note to self :)\n\n/etc/tmpfiles.d/control-port-filter-python.conf is an acceptable location for config file if it's not installed by the pacakge that `owns` it.  For this package the correct location would be `/usr/lib/tmpfiles.d/control-port-filter-python.conf`\n\n[[ http://man7.org/linux/man-pages/man5/tmpfiles.d.5.html | tmpfiles.d man page ]]\n\n```\nFiles in /etc/tmpfiles.d override files with the same name in\n       /usr/lib/tmpfiles.d and /run/tmpfiles.d. Files in /run/tmpfiles.d\n       override files with the same name in /usr/lib/tmpfiles.d. Packages\n       should install their configuration files in /usr/lib/tmpfiles.d.\n       Files in /etc/tmpfiles.d are reserved for the local administrator,\n       who may use this logic to override the configuration files installed\n       by vendor packages. \n```\n"},{"author":"Patrick","date_created":1430399979,"date_modified":1430399979,"content":"What's next here?\n\n@nrgaway Can you please post all your existing systemd units for packages developed under the Whonix umbrella somewhere? Such as the one in the comment of https://phabricator.whonix.org/T273#3852 ? + Add the license header? That would be important. It's currently a blocker before I can continue with most Whonix 11 development tasks. I would like to integrate those into packages and make those systemd-only. I guess I am getting to that before you?\n\nJust finished making whonix-initializer systemd-only. Once the systemd unit is ready, the required remaining changes in `debian/control` and `debian/rules` are [minimal and simple](https://github.com/Whonix/whonix-initializer/commit/41c68fe15e0e0789b2ac46689695febba3d06b00)."},{"author":"Patrick","date_created":1430407700,"date_modified":1430407700,"content":"Related, see also:\nhttps://www.whonix.org/forum/index.php/topic,560.msg7989.html#msg7989"},{"author":"Patrick","date_created":1430692495,"date_modified":1430692495,"content":">>! In T273#4175, @Patrick wrote:\n> What's next here?\n> \n> @nrgaway Can you please post all your existing systemd units for packages developed under the Whonix umbrella somewhere? Such as the one in the comment of https://phabricator.whonix.org/T273#3852 ? + Add the license header? That would be important. It's currently a blocker before I can continue with most Whonix 11 development tasks. I would like to integrate those into packages and make those systemd-only. I guess I am getting to that before you?\n> \n> Just finished making whonix-initializer systemd-only. Once the systemd unit is ready, the required remaining changes in `debian/control` and `debian/rules` are [minimal and simple](https://github.com/Whonix/whonix-initializer/commit/41c68fe15e0e0789b2ac46689695febba3d06b00).\n\n@nrgaway\n\nAbove is important to proceed."},{"author":"Patrick","date_created":1431647878,"date_modified":1431647878,"content":"This has been fixed in T274. control-port-filter-python has a working systemd unit file now. Closing. Please re-open if you still see an issue here."}]},"PHID-TASK-k57vz3sxhseubse73vhl":{"id":"272","title":"whonix_firewall script failure","status":"resolved","priority":"Needs Triage","author":"nrgaway","description":"Initial build of Whonix 10 is successful, however there are still some configuration options I need to sort out.  The first issue I have come across is a firewall startup failure as shown below.  Currently looking into what the cause of this error is.\n\n```\nroot@host:/usr/lib/qubes-whonix/init# /usr/bin/whonix_firewall\nOK: Loading Whonix firewall...\nOK: TOR_USER: 105\nOK: CLEARNET_USER: 1001\nOK: USER_USER: 1000\nOK: ROOT_USER: 0\niptables: Chain already exists.\n##################################################\nWhonix firewall script failed!\n##################################################\n```","comments":[{"author":"Patrick","date_created":1429743527,"date_modified":1429743527,"content":"Perhaps the script slightly changed and the sed/patching magic doesn't work anymore?\n\nRelated to:\nT176"},{"author":"nrgaway","date_created":1429745645,"date_modified":1429745645,"content":"Yes, I have identified the section that is causing issues...\n\nThis is what is being search for...\n`## IPv4 DROP INVALID INCOMING PACKAGES`\n\nand now there is also:\n`## IPv4 DROP INVALID INCOMING PACKAGES POST HOOK`\n\nYes, you were correct. Fixed.\n\nYou mentioned that I may not need to patch the script for Whonix 10.  It does not look like there is a hook in the first location listed above to do so, so I will continue with the patch which consists of:\n```\n## --- THE FOLLOWING WS INJECTED ---\n##     Qubes Tiny Proxy Updater\niptables -t nat -N PR-QBS-SERVICES\niptables -A INPUT -i vif+ -p tcp -m tcp --dport 8082 -j ACCEPT\niptables -A OUTPUT -o vif+ -p tcp -m tcp --sport 8082 -j ACCEPT\niptables -t nat -A PREROUTING -j PR-QBS-SERVICES\niptables -t nat -A PR-QBS-SERVICES -d 10.137.255.254/32 -i vif+ -p tcp -m tcp --dport 8082 -j REDIRECT\niptables -t nat -A OUTPUT -p udp -m owner --uid-owner tinyproxy -m conntrack --ctstate NEW -j DNAT --to 10.137.5.1:53\niptables -t nat -A OUTPUT -p tcp -m owner --uid-owner tinyproxy -m conntrack --ctstate NEW -j DNAT --to 10.137.5.1:9040\n\n# Route any traffic FROM netvm TO netvm BACK-TO localhost\n# Allows localhost access to tor network\n#iptables -t nat -A OUTPUT -s 10.137.5.1 -d 10.137.5.1 -j DNAT --to-destination 127.0.0.1\n```"}]},"PHID-TASK-7l3hpem3dxsg7kviw3gc":{"id":"271","title":"Whonix 10 Makefile interferes with Qubes build","status":"resolved","priority":"Needs Triage","author":"nrgaway","description":"The Whonix `Makefile` currently prevents build of Qubes template since it interferes with `qubes-builder` directives.\n\nI have not yet identified the offending code within the Makefile or a possible solution as of yet.\n\nAs a stop-gap measure, I have deleted the Makefile to allow a build, which will cause a build-error if the Whonix repo is not committed.  It would be nice to have an option to skip this test when building.\n\nWill provide further details once I have Whonix 10 building and tested.","comments":[{"author":"Patrick","date_created":1429743911,"date_modified":1429743911,"content":"All packages or just one?\n\nIf you post the xtrace, I'll find out which function causes this.\n\nIf it's just one package, we can easily add a package specific override (the override mechanism I explained in T168). Otherwise if multiple packages are involved, we can just patch the genmkfile package.\n\nBy the way... If it's about qubes-whonix... Can you merge my changes please?\nhttps://github.com/Whonix/qubes-whonix\nUpdated genmkfile to version 1.5.\n"},{"author":"nrgaway","date_created":1429764507,"date_modified":1429764507,"content":"I have merged your changes with the v9.6.6 version of `qubes-whonix` which is currently the `master` and also the branch with the name of `9.6.6`.  `9.6.6` also contains the fixes for `immutable files`, and the newer `whonix-setup-wizard`.\n\nThese changes were also merged to the `10.0.1` branch. Currently all 3 branches contain identical code being the version numbers being the only difference as of right now.\n\nSo far build seems fine for both gateway and workstation.\n\nI created a fix with the `qubes-builder` template code that builds `Whonix` to fix the error of the task topic by exporting `GENMKFILE_BOOTSTRAP` to an empty marker file so the Whonix `makefile-full` will not be included.\n\nIt would be useful for me if you could change the main Whonix Makefile's last line from:\n```\ninclude $(GENMKFILE_BOOTSTRAP)/makefile-full\n\nto\n\n-include $(GENMKFILE_BOOTSTRAP)/makefile-full\n```\n\nThis way I will not actually have to need to have a `makefile-full` marker file and can just set a fake path that will fail.  When you add the minus `-` sign in front of a make file statement, that indicates to make not to fail if it can not find or load the file."},{"author":"Patrick","date_created":1429823450,"date_modified":1429823450,"content":"Just this single one https://github.com/Whonix/Whonix/blob/master/Makefile ?\n\nIf it would fail open, I guess that would be confusing.\n\nWhy does `qubes-builder` not like it? I am interested to make it real compatible, extensible, easy, clean and whatnot.\n\nBut yes, that main Whonix Makefile has room for customization. We can make this real clean and awesome.\n\nFrom `include $(GENMKFILE_BOOTSTRAP)/makefile-full` would it help to make the latter part `makefile-full` configurable by an environment variable also? Too bad I didn't think of that earlier.\n\nBut that would be a hack. Because then you'd set `GENMKFILE_` environment variables, but did something completely different. There could also be something like `GENMKFILE_CUSTOM` and if set, it does your custom stuff and ignores the rest.\n\nOr perhaps there should also be a clean [environment variables?] way to - earlier and/or later - to source your own Makefile?"},{"author":"nrgaway","date_created":1429826580,"date_modified":1429826580,"content":"Yes, you are referencing the correct file.  It is the only file that needs to be edited and only needs the additional `-' inserted before the `include` statement.\n\nIt fails for `qubes-builder` since `qubes-builder` also includes or tests for the existence of certain 'targets' of all `Makefiles` that are included as a `COMPONENT`.  The Makefile you are including must have a conflicting target; or has a target that is being called by `qubes-builder` that is not intended to be called by Whonix. I include `Whonix` as a component to allow its source code to automatically be downloaded and verified ans well as to prompt the user to allow importing the `Whonix` key.\n\nYes, the later part could also be configurable.\n\nAnother les hackish way to accomplish the goal would be to instead add a conditional to prevent the include statement from executing if some ENV var is set.  Something like the following:\n```\nINCLUDE_MKFILE ?= 1\nGENMKFILE_NAME ?= makefile-full\n\nGENMKFILE_BOOTSTRAP ?= ./packages/genmkfile/usr/share/genmkfile\nGENMKFILE_PATH ?= $(GENMKFILE_BOOTSTRAP)\nGENMKFILE_ROOT_DIR := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))\n\n#You could use the following in lieu of exporting each var individually\n#.EXPORT_ALL_VARIABLES:\n\nexport GENMKFILE_BOOTSTRAP\nexport GENMKFILE_PATH\nexport GENMKFILE_ROOT_DIR\n\n# If the ENV var INCLUDE_MKFILE == 0, then makefile will NOT be included\nifeq ($(INCLUDE_MKFILE), 1)\n  include $(GENMKFILE_BOOTSTRAP)/$(GENMKFILE_NAME)\nendif\n```"},{"author":"Patrick","date_created":1429829003,"date_modified":1429829003,"content":"Yeah. (Untested, but...) I like that!\n\nThere are two specific Makefiles (can probably not be avoided)\n* https://github.com/Whonix/genmkfile/blob/master/Makefile\n* https://github.com/Whonix/Whonix/blob/master/Makefile\n\nAnd the generic one https://github.com/Whonix/genmkfile/blob/master/usr/share/genmkfile/Makefile that all the other packages are currently using.\n\n-----\n\nI would like to fix this once and for all, if that's possible, at least for most cases, a long time.\n\nSee the following. Roughly tested. But you most likely know what I am up to? Hopefully you like fixing it? I guess it's not that hard if you speak make?\n\n```\n#!/usr/bin/make -f\n\n## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\n## Bootstrapping genmkfile. Using genmkfile to build genmkfile.\n## Using genmkfile without having genmkfile available as a build dependency.\n\nGENMKFILE_NAME ?= makefile-full\nGENMKFILE_BOOTSTRAP ?= ./packages/genmkfile/usr/share/genmkfile\nGENMKFILE_PATH ?= $(GENMKFILE_BOOTSTRAP)\nGENMKFILE_ROOT_DIR := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))\nGENMKFILE_INCLUDE_FILE_MAIN ?= $(GENMKFILE_PATH)/$(GENMKFILE_NAME)\n\nexport GENMKFILE_NAME\nexport GENMKFILE_BOOTSTRAP\nexport GENMKFILE_PATH\nexport GENMKFILE_ROOT_DIR\nexport GENMKFILE_INCLUDE_FILE_MAIN\n\nifdef GENMKFILE_INCLUDE_FILE_PRE\n   include $(GENMKFILE_INCLUDE_FILE_PRE)\nendif\n\nifneq ($(GENMKFILE_INCLUDE_FILE_MAIN),0)\n  include $(GENMKFILE_INCLUDE_FILE_MAIN)\nendif\n\nifdef GENMKFILE_INCLUDE_FILE_POST\n   include $(GENMKFILE_INCLUDE_FILE_POST)\nendif\n```\n\nChanges:\n\n- `INCLUDE_MKFILE` -> `GENMKFILE_INCLUDE_MAIN`\n- I guess we need to `export GENMKFILE_NAME`.\n- `.EXPORT_ALL_VARIABLES` - probably not that extensible. Makes modifications by (hopefully future) third parties more difficult.\n- Why `GENMKFILE_INCLUDE_FILE_PRE`, not named `GENMKFILE_INCLUDE_PRE`? Well, perhaps in future we need `GENMKFILE_INCLUDE_DIR_PRE` (`.d`-style).\n- `GENMKFILE_INCLUDE_FILE_MAIN ?= $(GENMKFILE_PATH)/$(GENMKFILE_NAME)`\n\nCould also become `genmkfile - Makefile - version 1.6`.\n\nQuestions:\n\n- I don't like the `ifneq ($(GENMKFILE_INCLUDE_FILE_MAIN),0)` so much, but I guess there is no more elegant solution?\n- When `GENMKFILE_INCLUDE_FILE_PRE` is set but doesn't exist, then make currently does not stop. Can/should this be fixed, something like `set -e` in make terms?\n- What do you think? Super clean, super compatible, extensible?\n"},{"author":"nrgaway","date_created":1429832220,"date_modified":1429832220,"content":"I tried to reply from email; guess it does not work that way?\n\nStatements like `ifneq ($(GENMKFILE_INCLUDE_FILE_MAIN),0)` are pretty much the way to do what we are trying to do with make.  Lots of things bug me about make, but it is very powerful.\n\nI would think the make file should exit with an error if you are including a file that does not exist, unless it is preceded with a `-`.  Make sure that there are no tabs in the statement.  I guess you could also test if the file exists as well like:\n```\nifeq (,$(wildcard $(GENMKFILE_INCLUDE_FILE_PRE)))\n$(error GENMKFILE_INCLUDE_FILE_PRE $(GENMKFILE_INCLUDE_FILE_PRE) does not exist!)\nendif\n```\n\nOne thing I always do is add an about target into all my make files:\n```\n.PHONY: about\nabout::\n        @echo \"Makefile\"\n```\n\nThe `@echo \"Makefile\"` would be different in each make file to allow identification of the make file.  This allows one to run `make about` and it will show exactly which make files have been included which is really useful when debugging and dealing with multiple included files. \n\nInstead of limiting the amount inclusion to only PRE, MAIN, POST Makefiles, you may also consider something like the following:\n```\nINCLUDES ?= makefile-pre makefile-full makefile-post\n-include $(addprefix $(GENMKFILE_PATH)/,$(INCLUDES))\n```\nThis will allow one to change the `INCLUDES` via `ENV var` and also will not fail Make script if the file does not exist"},{"author":"Patrick","date_created":1429836338,"date_modified":1429836338,"content":">>! In T271#3839, @nrgaway wrote:\n> I tried to reply from email; guess it does not work that way?\n\nStill works for me:\nhttps://phabricator.whonix.org/T185#3840\n \n> Statements like `ifneq ($(GENMKFILE_INCLUDE_FILE_MAIN),0)` are pretty much the way to do what we are trying to do with make.  Lots of things bug me about make, but it is very powerful.\n\nAlright.\n \n> I would think the make file should exit with an error if you are including a file that does not exist, unless it is preceded with a `-`.  Make sure that there are no tabs in the statement.  I guess you could also test if the file exists as well like:\n> ```\n> ifeq (,$(wildcard $(GENMKFILE_INCLUDE_FILE_PRE)))\n> $(error GENMKFILE_INCLUDE_FILE_PRE $(GENMKFILE_INCLUDE_FILE_PRE) does not exist!)\n> endif\n> ```\n\nUsing this now. Works.\n \n> One thing I always do is add an about target into all my make files:\n> ```\n> .PHONY: about\n> about::\n>         @echo \"Makefile\"\n> ```\n>\n> The `@echo \"Makefile\"` would be different in each make file to allow identification of the make file.  This allows one to run `make about` and it will show exactly which make files have been included which is really useful when debugging and dealing with multiple included files. \n\nImplemented that. Although I tried it in a generic way, so we can use the exact same file in most places. Please see if you like it.\n \n> Instead of limiting the amount inclusion to only PRE, MAIN, POST Makefiles, you may also consider something like the following:\n> ```\n> INCLUDES ?= makefile-pre makefile-full makefile-post\n> -include $(addprefix $(GENMKFILE_PATH)/,$(INCLUDES))\n> ```\n> This will allow one to change the `INCLUDES` via `ENV var` and also will not fail Make script if the file does not exist\n\nIt's an interesting idea, but then once you set `GENMKFILE_PATH` you could no longer use the default one. You'd have to leave a symlink in your custom location to the original one if you wanted that.\n\n-----\n\nAlright, that's what I have for now.\n\n```\n#!/usr/bin/make -f\n\n## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\n## Bootstrapping genmkfile. Using genmkfile to build genmkfile.\n## Using genmkfile without having genmkfile available as a build dependency.\n\n.PHONY: about\n\nGENMKFILE_NAME ?= makefile-full\nGENMKFILE_BOOTSTRAP ?= ./packages/genmkfile/usr/share/genmkfile\nGENMKFILE_PATH ?= $(GENMKFILE_BOOTSTRAP)\nGENMKFILE_ROOT_DIR := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))\nGENMKFILE_INCLUDE_FILE_MAIN ?= $(GENMKFILE_PATH)/$(GENMKFILE_NAME)\nGENMKFILE_CURRENT := $(CURDIR)/$(word $(words $(MAKEFILE_LIST)),$(MAKEFILE_LIST))\n\nexport GENMKFILE_NAME\nexport GENMKFILE_BOOTSTRAP\nexport GENMKFILE_PATH\nexport GENMKFILE_ROOT_DIR\nexport GENMKFILE_INCLUDE_FILE_MAIN\nexport GENMKFILE_CURRENT\n\nabout : ; @echo \"GENMKFILE_CURRENT: $(GENMKFILE_CURRENT)\"\n\nifdef GENMKFILE_INCLUDE_FILE_PRE\n   ifeq (,$(wildcard $(GENMKFILE_INCLUDE_FILE_PRE)))\n      $(error GENMKFILE_INCLUDE_FILE_PRE $(GENMKFILE_INCLUDE_FILE_PRE) does not exist!)\n   else\n      include $(GENMKFILE_INCLUDE_FILE_PRE)\n   endif\nendif\n\nifneq ($(GENMKFILE_INCLUDE_FILE_MAIN),0)\n   ifeq (,$(wildcard $(GENMKFILE_INCLUDE_FILE_MAIN)))\n      $(error GENMKFILE_INCLUDE_FILE_MAIN $(GENMKFILE_INCLUDE_FILE_MAIN) does not exist!)\n   else\n      include $(GENMKFILE_INCLUDE_FILE_MAIN)\n   endif\nendif\n\nifdef GENMKFILE_INCLUDE_FILE_POST\n   ifeq (,$(wildcard $(GENMKFILE_INCLUDE_FILE_POST)))\n      $(error GENMKFILE_INCLUDE_FILE_POST $(GENMKFILE_INCLUDE_FILE_POST) does not exist!)\n   else\n      include $(GENMKFILE_INCLUDE_FILE_POST)\n   endif\nendif\n```\n\nI am not happy about the following syntax.\n\n```\nabout : ; @echo \"GENMKFILE_CURRENT: $(GENMKFILE_CURRENT)\"\n```\n\nBut perhaps getting too late here. Following doesn't work.\n\n```\nabout:\n   @echo \"GENMKFILE_CURRENT: $(GENMKFILE_CURRENT)\"\n```\n\nWhat do you think? Please suggest any required/useful changes."},{"author":"nrgaway","date_created":1429838714,"date_modified":1429838714,"content":"In case my reply by email does not arrive...\n\nThe @echo... is part of a targets rule.. it needs to be  indented by one tab, not spaces.  One tab will equate to 8 spaces.\nabout:\n<tab here>@echo \"GENMKFILE_CURRENT: $(GENMKFILE_CURRENT)\"\n<blank_line_here>\n"},{"author":"Patrick","date_created":1429839202,"date_modified":1429839202,"content":"Alright. So let's take this?\n\n```\n#!/usr/bin/make -f\n\n## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\n## Bootstrapping genmkfile. Using genmkfile to build genmkfile.\n## Using genmkfile without having genmkfile available as a build dependency.\n\n.PHONY: about\n\nGENMKFILE_NAME ?= makefile-full\nGENMKFILE_BOOTSTRAP ?= ./packages/genmkfile/usr/share/genmkfile\nGENMKFILE_PATH ?= $(GENMKFILE_BOOTSTRAP)\nGENMKFILE_ROOT_DIR := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))\nGENMKFILE_INCLUDE_FILE_MAIN ?= $(GENMKFILE_PATH)/$(GENMKFILE_NAME)\nGENMKFILE_CURRENT := $(CURDIR)/$(word $(words $(MAKEFILE_LIST)),$(MAKEFILE_LIST))\n\nexport GENMKFILE_NAME\nexport GENMKFILE_BOOTSTRAP\nexport GENMKFILE_PATH\nexport GENMKFILE_ROOT_DIR\nexport GENMKFILE_INCLUDE_FILE_MAIN\nexport GENMKFILE_CURRENT\n\nabout:\n\t@echo \"GENMKFILE_CURRENT: $(GENMKFILE_CURRENT)\"\n\nifdef GENMKFILE_INCLUDE_FILE_PRE\n   ifeq (,$(wildcard $(GENMKFILE_INCLUDE_FILE_PRE)))\n      $(error GENMKFILE_INCLUDE_FILE_PRE $(GENMKFILE_INCLUDE_FILE_PRE) does not exist!)\n   else\n      include $(GENMKFILE_INCLUDE_FILE_PRE)\n   endif\nendif\n\nifneq ($(GENMKFILE_INCLUDE_FILE_MAIN),0)\n   ifeq (,$(wildcard $(GENMKFILE_INCLUDE_FILE_MAIN)))\n      $(error GENMKFILE_INCLUDE_FILE_MAIN $(GENMKFILE_INCLUDE_FILE_MAIN) does not exist!)\n   else\n      include $(GENMKFILE_INCLUDE_FILE_MAIN)\n   endif\nendif\n\nifdef GENMKFILE_INCLUDE_FILE_POST\n   ifeq (,$(wildcard $(GENMKFILE_INCLUDE_FILE_POST)))\n      $(error GENMKFILE_INCLUDE_FILE_POST $(GENMKFILE_INCLUDE_FILE_POST) does not exist!)\n   else\n      include $(GENMKFILE_INCLUDE_FILE_POST)\n   endif\nendif\n```\n"},{"author":"nrgaway","date_created":1429839480,"date_modified":1429839480,"content":"Looks good; I will need to test it to make sure that I can set  `GENMKFILE_INCLUDE_FILE_MAIN` to 0 to skip loading the Makefile."},{"author":"Patrick","date_created":1429840232,"date_modified":1429840232,"content":"Good!\n\nOne more thing.\n\n>>! In T271#3838, @Patrick wrote:\n> There are two specific Makefiles (can probably not be avoided)\n> * https://github.com/Whonix/genmkfile/blob/master/Makefile\n> * https://github.com/Whonix/Whonix/blob/master/Makefile\n\nMaybe can be avoided by auto detecting the path? It's just 3 different locations we can try. Then the exact same makefile can be used everywhere? No need to have a special bootstrap one? I am unsure about it. When using make from within Whonix/Whonix or genmkfile it should always use the local one?\n\n(With \"local\" I mean ./packages/genmkfile/usr/share/genmkfile here. Not the system wide installed one.)"},{"author":"nrgaway","date_created":1429842043,"date_modified":1429842043,"content":"I am not exactly sure what you mean.\n\nI do not even know what the current purpose of the make file is.  I would personally be using it to build the gateway, build debs, sign tags, update repos... everything.  Your makefile can call your scripts as needed.\n\nIf I knew what the makefile is currently being used for I could provide better answer. How to you call the make file to begin with?  on the command line or with a a script?  So if you can explain to me in detail what you want the makefile to do, I can provide some code back :)\n\nIt does not look like you need 3 make files that are mostly identical.  Usually I would include another makefile named something.conf, which includes and variable overrides or additional targets.  It is a makefile, but named with the extension .conf\n\nOr you can just call the master Makefile we have been working on i the ~whonix root directory as follows:\n```\nGENMKFILE_BOOTSTRAP=./packages/genmkfile/usr/share/genmkfile make\nGENMKFILE_BOOTSTRAP=./usr/share/genmkfile make\n```\n\n- or -\n\nBest yet is to create some targets and rules. \n```\n# make genmkfile\ngenmkfile: include some_genmkfile_config_file\ngenmkfile:\n        @echo 'this is some logic'\n        if [ some_test == \"1\" ]; then \\\n            echo 'passed'; \\\n        fi\n\n# To build default workstation and gateway (would read from a .conf file for options)\n# make gateway\n\ngateway:\n        whonix_build $(OPTIONS)\n\ndebs:\n        bash script code to make debs?\n```"},{"author":"Patrick","date_created":1429844223,"date_modified":1429844223,"content":">>! In T271#3845, @nrgaway wrote:\n> Looks good; I will need to test it to make sure that I can set  `GENMKFILE_INCLUDE_FILE_MAIN` to 0 to skip loading the Makefile.\n\nJust again specifically tested this. Works. You can ignore the main one and source your own make file and targets in pre.\n\n>>>! In T271#3838, @Patrick wrote:\n>> There are two specific Makefiles (can probably not be avoided)\n>> * https://github.com/Whonix/genmkfile/blob/master/Makefile\n>> * https://github.com/Whonix/Whonix/blob/master/Makefile\n> \n> Maybe can be avoided by auto detecting the path? It's just 3 different locations we can try. Then the exact same makefile can be used everywhere? No need to have a special bootstrap one? I am unsure about it. When using make from within Whonix/Whonix or genmkfile it should always use the local one?\n> \n> (With \"local\" I mean ./packages/genmkfile/usr/share/genmkfile here. Not the system wide installed one.)\n\nGot this working in this revision.\n\n>>! In T271#3847, @nrgaway wrote:\n> I do not even know what the current purpose of the make file is.  I would personally be using it to build the gateway, build debs, sign tags, update repos... everything.  Your makefile can call your scripts as needed.\n\nThe purpose of genmkfile is described here:\nhttps://github.com/Whonix/genmkfile/blob/master/debian/control#L18\n\nIt's purpose is to avoid having to define \"install file x to /usr/bin/x\" for each individual file in each individual package. That's something I find awful. Because when you ever rename files in the package, you also have to update the makefile. Too much effort for something as simple as scripts and config files as I find.\n\nWith genmkfile each individual package just needs this minimal makefile. It's purpose is to require seldom upgrades. It sources a more comprehensive makefile-full that implements all the real targets such as make install, make installcheck, make uninstall and much more (see make help). Since I find makefiles hard to write (; \\ syntax) and debug (no xtrace), the heavy lifting is done by make-helper.bsh. makefile-full and make-helper.bsh which are in the genmkfile package can be often upgraded and all packages benefit from it without requiring to copy/commit a new version.\n \n> How to you call the make file to begin with?\n\nFor example if troubadour works on whonix-setup-wizard, he can just needs to have genmkfile installed as a build dependency (git clone and \"make deb-icup\") and can then use in whonix-setup-wizard \"make install\", \"make deb-icup\" and others without needing to understand a lot about makefiles and such. It's all nicely abstracted into genmkfile. So can other users/developers easily git clone and play around with a package. When I come up with new hot features such as short commands to quickly bump version number, create and add a package to the repository, I don't have to commit to individual packages such as whonix-setup-wizard.\n\nFor Whonix/Whonix I can understand the confusion. It's Makefile is not that useful yet. Some stuff is useful for developers such as \"make git-verify\". Another plan of mine was to package whole images generated by Whonix/Whonix as deb package. It's not yet in use to build Whonix images. That's only whonix_build.\n\n> It does not look like you need 3 make files that are mostly identical.\n\nYes. Now it autodetects the path. Why are these two exceptions? Well, for genmkfile, I would like to use genmkfile to build genmkfile package. To avoid a circular build dependency (on on itself), I use the same one that comes with genmkfile. And for Whonix/Whonix to avoid having to install genmkfile just to use the makefile.\n\n> # To build default workstation and gateway (would read from a .conf file for options)\n> # make gateway\n> \n> gateway:\n>         whonix_build $(OPTIONS)\n> \n> debs:\n>         bash script code to make debs?\n> ```\n\nThe makefile for Whonix/Whonix could indeed have additional features that individual packages don't need (make debs, make gateway). Additional features that are only needed for Whonix/Whonix that are not useful for genmkfile. That's another story.\n\n-----\n\n```\n#!/usr/bin/make -f\n\n## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\n## genmkfile - Makefile - version 1.6\n\n## This is a copy.\n## master location:\n## https://github.com/Whonix/genmkfile/blob/master/usr/share/genmkfile/Makefile\n\n.PHONY: about\n\nGENMKFILE_NAME ?= makefile-full\nGENMKFILE_BOOTSTRAP_ONE ?= ./packages/genmkfile/usr/share/genmkfile/$(GENMKFILE_NAME)\nGENMKFILE_BOOTSTRAP_TWO ?= ./usr/share/genmkfile/$(GENMKFILE_NAME)\nGENMKFILE_PATH ?= /usr/share/genmkfile\nGENMKFILE_ROOT_DIR := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))\nGENMKFILE_CURRENT := $(CURDIR)/$(word $(words $(MAKEFILE_LIST)),$(MAKEFILE_LIST))\n\nifndef GENMKFILE_INCLUDE_FILE_MAIN\n   ifneq (,$(wildcard $(GENMKFILE_BOOTSTRAP_ONE)))\n      GENMKFILE_INCLUDE_FILE_MAIN := $(GENMKFILE_BOOTSTRAP_ONE)\n   else ifneq (,$(wildcard $(GENMKFILE_BOOTSTRAP_TWO)))\n      GENMKFILE_INCLUDE_FILE_MAIN := $(GENMKFILE_BOOTSTRAP_TWO)\n   else\n      GENMKFILE_INCLUDE_FILE_MAIN := $(GENMKFILE_PATH)/$(GENMKFILE_NAME)\n   endif\nendif\n\nexport GENMKFILE_NAME\nexport GENMKFILE_PATH\nexport GENMKFILE_ROOT_DIR\nexport GENMKFILE_INCLUDE_FILE_MAIN\nexport GENMKFILE_CURRENT\n\nabout:\n\t@echo \"GENMKFILE_CURRENT: $(GENMKFILE_CURRENT)\"\n\nifdef GENMKFILE_INCLUDE_FILE_PRE\n   ifeq (,$(wildcard $(GENMKFILE_INCLUDE_FILE_PRE)))\n      $(error GENMKFILE_INCLUDE_FILE_PRE $(GENMKFILE_INCLUDE_FILE_PRE) does not exist!)\n   else\n      include $(GENMKFILE_INCLUDE_FILE_PRE)\n   endif\nendif\n\nifneq ($(GENMKFILE_INCLUDE_FILE_MAIN),0)\n   ifeq (,$(wildcard $(GENMKFILE_INCLUDE_FILE_MAIN)))\n      $(error GENMKFILE_INCLUDE_FILE_MAIN $(GENMKFILE_INCLUDE_FILE_MAIN) does not exist!)\n   else\n      include $(GENMKFILE_INCLUDE_FILE_MAIN)\n   endif\nendif\n\nifdef GENMKFILE_INCLUDE_FILE_POST\n   ifeq (,$(wildcard $(GENMKFILE_INCLUDE_FILE_POST)))\n      $(error GENMKFILE_INCLUDE_FILE_POST $(GENMKFILE_INCLUDE_FILE_POST) does not exist!)\n   else\n      include $(GENMKFILE_INCLUDE_FILE_POST)\n   endif\nendif\n```"},{"author":"Patrick","date_created":1429845178,"date_modified":1429845178,"content":"Committed:\n- https://github.com/Whonix/Whonix/commit/46a3ff469c297dca5e39bbc90e1332c2c598249b\n- https://github.com/Whonix/genmkfile/commit/7b9e6b13d11d98b9623ce9e16b2db02b5a6d6bac\n\nIf there are more points to discuss, please raise them. Otherwise please close this one."}]},"PHID-TASK-6bgqyx62v2pz2tqgrfkk":{"id":"270","title":"change release codename from wheezy to jessie","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1429718330,"date_modified":1429718330,"content":"Done:\n- https://github.com/Whonix/Whonix/commit/6fe0b5a6eb634199e5dfe1cdf3555ce346339ca8\n- https://github.com/Whonix/anon-apt-sources-list/commit/185ea2f82c83f03b6f707262aa2f1a0e47537999\n- https://github.com/Whonix/anon-shared-build-apt-sources-tpo/commit/4a6edceae2aff1aaae6acbdf8a9a2bfd39cc45e5\n- https://github.com/Whonix/whonix-repository/commit/e8ed98b658559f6b4194bf90365183d2d3db05ec\n"}]},"PHID-TASK-m6prlwyh6q44sot53pfk":{"id":"269","title":"use exit trap to reduce code duplication","status":"resolved","priority":"Normal","author":"Patrick","description":"Instead of using the following in every script...\n\n```\n   benchmarktimeend ## sets benchmark_took_time (implemented in help-steps/pre)\n   true \"${bold}INFO: End of: $BASH_SOURCE | $whonix_build_error_counter error(s) detected. (benchmark: $benchmark_took_time)${reset}\"\n```\n\nAn exit trap in help-steps/pre would be better.","comments":[{"author":"Patrick","date_created":1429638088,"date_modified":1429638088,"content":"Done:\n* https://github.com/Whonix/whonix-developer-meta-files/commit/0a92e00aaa9b9b749468780260b9f11d65d60133\n* https://github.com/Whonix/Whonix/commit/5684681422ba1c0b6122434f941f6e342d364250"}]},"PHID-TASK-tdj7xhqltwjyreitopa2":{"id":"268","title":"fix reconfigurability of /etc/default/keyboard","status":"open","priority":"Wishlist","author":"Patrick","description":"Changing keyboard layout through `/etc/default/keyboard` is currently unsupported, broken.\n\nIt would require installation of `console-setup`, but doing so would break ncurses based dialogs in consoles (such as tty0). (See T267.) This is a follow up task for T267.\n\nSee also:\n* https://wiki.debian.org/Keyboard\n* https://www.whonix.org/wiki/Keyboard_Layout","comments":[]},"PHID-TASK-omedhgzuadqxfu6nkzkg":{"id":"267","title":"ncurses based dialogs are broken in consoles (such as tty0)","status":"resolved","priority":"Normal","author":"Patrick","description":"All ncurses based dialogs are broken in consoles (such as tty0) as of Whonix `10` - `10.0.0.5.4-developers-only`.\n```\ndialog --msgbox test 640 480\n```\n\n{F63}","comments":[{"author":"Patrick","date_created":1429218784,"date_modified":1429218784,"content":"Whonix 9 vs Whonix 10 locale settings are the same.\n\nBy setting an environment variable this can be worked around.\n\n```\nTERM=vt1000 dialog --msgbox test 640 480\n```\n```\nTERM=xterm dialog --msgbox test 640 480\n```\nBut hard setting an environment variable is a crude solution.\n\n-----\n\nRemoval of the `console-setup console-setup-linux` packages fixes this.\n\nRelated changelog entries:\n\n```\n– anon-meta-packages: added console-setup to anon-shared-packages-dependencies so users can use /etc/default/keyboard as alternative mechanism to change the keyboard layout\n– anon-meta-packages: added console-data to anon-shared-packages-dependencies to make sure all three packages console-setup, console-data and console-common are installed.\n```\n"},{"author":"Patrick","date_created":1429220670,"date_modified":1429220670,"content":"Having `console-setup` uninstalled alone also suffices."},{"author":"Patrick","date_created":1429291015,"date_modified":1429291015,"content":"Since this is non-trivial to solve, and the last blocker for Whonix 10, reverted the related changelog entries.\n* https://github.com/Whonix/anon-meta-packages/commit/828ebdc945623b5f50b9e471223075e0da330d13\n* https://github.com/Whonix/anon-meta-packages/commit/c3316255bdb1772080f5e8c8bb330ee2f993f01e\n\nCreated a follow up task T268 for the real solution."},{"author":"Patrick","date_created":1429368630,"date_modified":1429368630,"content":"See also this post:\nhttps://www.whonix.org/forum/index.php/topic,1123.msg7831.html#msg7831"}]},"PHID-TASK-juaj76tq3mzxsb6yoodj":{"id":"266","title":"New Onion Services for sdwdate","status":"resolved","priority":"Low","author":"HulaHoop","description":"https://lists.torproject.org/pipermail/tor-talk/2015-April/037457.html\n\n Major news related to GlobaLeaks project use and deployment as as follow: - Deployment of OCCRPLeaks in Bosnia [7] - Deployment of MexicoLeaks in Mexico [8] - Partnership with Transparency International Philippines for National Anticorruption initiative [9] - Deployment of NieuwsLeaks in Belgium [10]\n\n[7] https://occrp.org/occrpleaks [8] https://mexicoleaks.mx/ [9] http://www.transparency-ph.org/2015/03/technology-for-transparency-transparency-international-philippines-ti-ph-partners-with-the-hermes-center-for-transparency-and-digital-human-rights-hermes/ [10] http://nieuws.vtm.be/nieuwsleaks ","comments":[{"author":"Patrick","date_created":1429191875,"date_modified":1429191875,"content":"Trust. Hard topic. I don't know. For example https://mexicoleaks.mx is just some site by whom, by anonymous with some onion? Are they trustworthy just because they happen to run GloaLeaks?\n\nPerhaps we could say, GlobaLeaks is trustworthy and by extension their partners might be. Does GlobaLeaks vet them or do you simply add anyone who installs their software to the list?"},{"author":"HulaHoop","date_created":1429307093,"date_modified":1429307093,"content":"Not sure. Nothing is mentioned on the wiki about it. You can make the call or ask the Globaleaks dev whose Tor mailing list post I linked to because every site helps.\n\nIt seems the list is being maintained because a couple of other ones installed since the beginning of this year that I didn't mention:\nhttps://en.wikipedia.org/wiki/GlobaLeaks#Implementations"},{"author":"HulaHoop","date_created":1429798045,"date_modified":1429798045,"content":"New wikileaks chat onion just up:\n\nhttps://twitter.com/wikileaks/status/590907709387624450"},{"author":"HulaHoop","date_created":1430341688,"date_modified":1430341688,"content":"The Sun's securedrop instance launched. It should show up on the freedom.press list when updated:\n\nhttp://www.thesun.co.uk/sol/homepage/news/6429126/The-Sun-Whistleblower-Charter.html\n\n\nnodd5fyasyj4jqgp.onion"},{"author":"Patrick","date_created":1443126239,"date_modified":1443126239,"content":">>! In T266#3828, @HulaHoop wrote:\n> New wikileaks chat onion just up:\n> \n> https://twitter.com/wikileaks/status/590907709387624450\n\n\n\n>>! In T266#4158, @HulaHoop wrote:\n> The Sun's securedrop instance launched. It should show up on the freedom.press list when updated:\n> \n> http://www.thesun.co.uk/sol/homepage/news/6429126/The-Sun-Whistleblower-Charter.html\n> \n> \n> nodd5fyasyj4jqgp.onion\n\nBoth added and refreshed securedrop list:\nhttps://github.com/Whonix/sdwdate/commit/8377e85f6e857a8af7ba21761c4b727090e507fe\n"},{"author":"HulaHoop","date_created":1443219490,"date_modified":1443219490,"content":"Some new ones on here and others defunct. Feel free to add this source as a code comment:\nhttps://en.m.wikipedia.org/wiki/GlobaLeaks\n\nWe may be able to use the recently launched apt Debian onion mirrors."},{"author":"Patrick","date_created":1443552111,"date_modified":1443552111,"content":"https://www.whonix.org/pipermail/whonix-devel/2015-September/000430.html\n"},{"author":"HulaHoop","date_created":1444005148,"date_modified":1445199800,"content":"~~intelexit.org~~\n\n~~intelexi7yo7mj7j.onion~~"},{"author":"Patrick","date_created":1444069231,"date_modified":1444069231,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> intelexit.org\n> \n> http://intelexi7yo7mj7j.onion/\n\nYeah. Can you send a pull request please?"},{"author":"HulaHoop","date_created":1444667522,"date_modified":1445199647,"content":"~~OK I'll add it later.~~\n\n~~Library Freedom project: libraryxobbrbj33.~~"},{"author":"HulaHoop","date_created":1445185928,"date_modified":1445185928,"content":"How do I do a strike through? \n\nCan sdwdate set the time from Debian repo URLs? I'll add them too it can."},{"author":"Patrick","date_created":1445186798,"date_modified":1445186798,"content":">>! In T266#6961, @HulaHoop wrote:\n> How do I do a strike through? \n\nAs per https://secure.phabricator.com/book/phabricator/article/remarkup/.\n\n`~~test~~`\n~~test~~\n\n> Can sdwdate set the time from Debian repo URLs? I'll add them too it can.\n\nIf those can be viewed in a normal browser, i.e. if those are just normal http, it should work. If `curl --head http://xxx.onion` works, it should work. sdwdate does something similar."}]},"PHID-TASK-txk3fahrbs2s4pulbfaj":{"id":"265","title":"broken gateway-firsttimesetup.desktop desktop icon after Whonix 9 -> Whonix 10 upgrade","status":"resolved","priority":"Normal","author":"Patrick","description":"gateway-firsttimesetup.desktop broke because file names changed.","comments":[{"author":"Patrick","date_created":1429133688,"date_modified":1429133688,"content":"fix broken gateway-firsttimesetup.desktop desktop icon after Whonix 9 -> Whonix 10 upgrade:\nhttps://github.com/Whonix/whonix-legacy/commit/eff76a81deb9a99f52518e9d6253f92bf5777b05"}]},"PHID-TASK-yj3za4r235m266s5galx":{"id":"264","title":"warn if whonix-gateway / whonix-workstation package is not installed","status":"resolved","priority":"Normal","author":"Patrick","description":"This message went unnoticed during installation from testers repository.\n```\nThe following packages will be REMOVED:\n  anon-gateway-packages-recommended whonix-gateway\n```\nTherefore whonixcheck should check if either the whonix-gateway (on the gateway) or respective whonix-workstation package is not installed and warn if so.\n\nThe warning should be configurable, dismissible (use case: https://www.whonix.org/wiki/Whonix_Debian_Packages).","comments":[{"author":"Patrick","date_created":1429710819,"date_modified":1429710819,"content":"Done:\nhttps://github.com/Whonix/whonixcheck/commit/564f23ba2f4c9aeb61fe4e12525eecb0e7a21881"}]},"PHID-TASK-bk4ogheo2tq7gxu3cprc":{"id":"263","title":"test if gr-osmosdr package installs","status":"resolved","priority":"Normal","author":"Patrick","description":"```\nsudo apt-get update\nsudo apt-get install gr-osmosdr\n```\n\nA bug report indicated, that there may be issues installing that package on jessie based Whonix.\n","comments":[{"author":"MemoryLost","date_created":1429077700,"date_modified":1429077700,"content":"Bug was on weezy"},{"author":"Patrick","date_created":1430402453,"date_modified":1430402453,"content":"wheezy:\nWorks when installing from backports. New documentation is are ready:\nhttps://www.whonix.org/wiki/Install_Software#Backports\n\njessie:\nWorks normally."}]},"PHID-TASK-cescdczvkno3vluj6hkb":{"id":"262","title":"tor package being installed on Whonix-Workstation","status":"resolved","priority":"Normal","author":"Patrick","description":"anon-shared-packages-dependencies depends on sdwdate which depends on tor.\n\nanon-shared-packages-dependencies (sdwdate, tor) currently gets installed before anon-workstation-packages-recommended (anon-ws-disable-stacked-tor).","comments":[{"author":"Patrick","date_created":1428969898,"date_modified":1428969898,"content":"fix, no longer install tor package in Whonix-Workstation:\nhttps://github.com/Whonix/Whonix/commit/908b66da6eaa19a98819c3644fe8f656bec98e74"}]},"PHID-TASK-ykovjgtbxzounn6yswi3":{"id":"261","title":"mirror testing script","status":"resolved","priority":"Normal","author":"Patrick","description":"A follow up task for T54.\n\nMirrors that are outdated or down generate lots of confusion and support requests:\n\n* https://www.whonix.org/forum/index.php/topic,1131.0.html\n* https://www.whonix.org/forum/index.php/topic,1130.0.html\n\nA script is needed that can quickly check all mirrors for being up and fresh.","comments":[{"author":"Patrick","date_created":1428872628,"date_modified":1428872628,"content":"Done:\nhttps://github.com/Whonix/whonix-developer-meta-files/commit/a061fe2fb30e0470338e5e9107cdc538379943df\n"}]},"PHID-TASK-zfeq6lm264h64ek5ulj7":{"id":"260","title":"streamline release maintenance scripts","status":"resolved","priority":"Normal","author":"Patrick","description":"To make new releases simpler, faster and more streamlined, the following scripts should be combined.\n\n        release/compress_libvirt\n        release/create_hashes\n        release/create_torrent\n        release/sign_images\n\nThey should all be combined into a single script.\n\n        release/prepare_release\n\nOr so.","comments":[{"author":"Patrick","date_created":1428871135,"date_modified":1428871135,"content":"Done:\nhttps://github.com/Whonix/whonix-developer-meta-files/commit/9b9090d272c360ba21e908c4b4120a80f86fc223"},{"author":"Patrick","date_created":1429012772,"date_modified":1429012772,"content":"implemented \"make git-tag-push\":\nhttps://github.com/Whonix/genmkfile/commit/96488b686814f794bb3070ac7582ca2ff4ff638b\n\nimplemented \"make reprepro-add\":\nhttps://github.com/Whonix/genmkfile/commit/6bce8b0347e609b2b2a894c39b32177c799942c9"}]},"PHID-TASK-xxfjjcrefwowk3wxf4g4":{"id":"259","title":"apparmor-profile-torbrowser permission denied issue /usr/share/libthai/thbrk.tri","status":"resolved","priority":"Normal","author":"Patrick","description":"```\nApr 11 14:17:06 host kernel: [ 2609.834321] type=1400 audit(1428761826.198:29): apparmor=\"DENIED\" operation=\"open\" parent=1 profile=\"/home/*/tor-browser_*/Browser/firefox\" name=\"/usr/share/libthai/thbrk.tri\" pid=9094 comm=\"firefox\" requested_mask=\"r\" denied_mask=\"r\" fsuid=1000 ouid=0\n```\n","comments":[{"author":"troubadour","date_created":1428876820,"date_modified":1428876820,"content":"Added:\nhttps://github.com/troubadoour/apparmor-profile-whonixcheck/commit/69c239cb114488ea6850e4027bfd0391aa4f739e"},{"author":"Patrick","date_created":1428877483,"date_modified":1428877483,"content":"Wrong package.\n\nYou committed to apparmor-profile-whonixcheck, not apparmor-profile-torbrowser.\n\nMerged into whonixcheck anyhow. Doesn't hurt. Should I revert?"},{"author":"Patrick","date_created":1428932132,"date_modified":1428932132,"content":"Perhaps `/usr/share/libthai/** r,` would be better, just in case?"},{"author":"Patrick","date_created":1429003360,"date_modified":1429003360,"content":"Done:\nhttps://github.com/Whonix/apparmor-profile-torbrowser/commit/4bf5e5a58b982ddceac8a01fdbd305d8d3005e07\n"}]},"PHID-TASK-3wmtwjo7j3lqooailuoj":{"id":"258","title":"apparmor-profile-whonixcheck /usr/lib/apt-get-wrapper","status":"resolved","priority":"Normal","author":"Patrick","description":"Forgot to add.\n\n```\nApr  9 23:59:54 host kernel: [ 7030.356024] type=1400 audit(1428623994.051:36): apparmor=\"DENIED\" operation=\"exec\" parent=17612 profile=\"/usr/bin/whonixcheck\" name=\"/usr/lib/apt-get-wrapper\" pid=17613 comm=\"apt-get-update\" requested_mask=\"x\" denied_mask=\"x\" fsuid=0 ouid=0\n```\n","comments":[{"author":"troubadour","date_created":1428876876,"date_modified":1428876876,"content":"Added:\nhttps://github.com/troubadoour/apparmor-profile-whonixcheck/commit/b1c051ad0463b272d2645294272e075751501e1e"},{"author":"Patrick","date_created":1428877197,"date_modified":1428877197,"content":"Fixed together a few other issues:\nhttps://github.com/Whonix/apparmor-profile-whonixcheck/commit/0f0312ec2d2412f321121c06e3b039b55022d42d\n"},{"author":"Patrick","date_created":1428877544,"date_modified":1428877544,"content":"You beat me by 4 minutes. ;=)"}]},"PHID-TASK-iijkotlfdrpx4qaxlqve":{"id":"257","title":"simplify manual_analysis_folder","status":"open","priority":"Normal","author":"Patrick","description":"The [How-To](https://www.whonix.org/wiki/Verifiable_Builds#How-To) is currently a bit long. Manually comparing multiple files inside the manual_analysis_folder is cumbersome.\n\nTherefore either consider adding the content of these files to the reports or create a separate file that contains the contents of these files.","comments":[]},"PHID-TASK-7sffsjjsmuee4u5xzxcl":{"id":"256","title":"Finish initial release of Whonix Welcome Page","status":"resolved","priority":"Normal","author":"WhonixQubes","description":"Need to finish any final touches for initial release of the Whonix Welcome Page.\n\nTo release with Whonix 10.\n\nSimple static only webpage for initial release.\n\nForum Discussion:\n- https://www.whonix.org/forum/index.php/topic,365.0.html","comments":[{"author":"Patrick","date_created":1428159652,"date_modified":1428159652,"content":"How much work is that?\n\nAny ETA?"},{"author":"WhonixQubes","date_created":1428425807,"date_modified":1428425807,"content":"@Patrick\n\nShouldn't take very much at all.\n\nWhen do you need it done by?\n\nI will adjust this priority to your expected release date needs for \nsigning the final initial package version."},{"author":"Patrick","date_created":1428497144,"date_modified":1428497144,"content":"Good question. I don't really know for sure.\n\nIs this change important enough to be included in Whonix 10 stable release? Currently I am preparing a testers-only release of 10.0.0.5.0.\n\nEvery additional testers-only release generates a lot work on my side.\n\n- painfully merge git submodules into the Whonix 10 branch\n- tag the updated package\n- tag a new release\n- build, test new images\n- compress images which feels like taking hours\n- upload new images which takes hours\n- update Whonix News files with new blessed version numbers\n- update APT repository\n- write a blog post, call for another round of testing\n- and make sure, I don't mess up anything along that way\n\nAlso depends on how many issues are reported against 10.0.0.5.0. If another testers-only round is required, then the effort is better justified.\n\nIf Whonix 11 is early enough, than any time before Whonix 11 would work.\n\nOtherwise I guess one or two weeks for giving users time to test 10.0.0.5.0 before proceeding further, so I can merge it before then, before the next testers-only release [that may be blessed stable after testing]."},{"author":"WhonixQubes","date_created":1428550220,"date_modified":1428550220,"content":"I'm all finished now. Didn't require much at all.\n\nUploaded here:\n\nhttps://github.com/WhonixQubes/whonix-welcome-page\n\nI just removed the excess unused JavaScript stuff and added the \nlicensing comments.\n\nThese changes are not critical to me. You can include it to whatever \nversion you please, now, later, whenever. I don't mind."},{"author":"Patrick","date_created":1428598777,"date_modified":1428598777,"content":"Thanks! Merged. Suffices for Whonix 11."}]},"PHID-TASK-ieiu2otkqofgtkqynuje":{"id":"255","title":"whonixcheck general Whonix News files","status":"resolved","priority":"Normal","author":"Patrick","description":"Ability to specific news by build / package version only doesn't scale anymore. There are too many versions now. Most times, Whonix News isn't specific to certain versions, but applies to all versions. (Such as the current \"[Tor Browser cannot be started](https://www.whonix.org/blog/cannot-start-tor-browser)\" issue.) Therefore a feature to define a general, fallback news file is required.","comments":[{"author":"Patrick","date_created":1428082266,"date_modified":1428082266,"content":"Done.\n\nimplemented whonixcheck general Whonix News file:\nhttps://github.com/Whonix/whonixcheck/commit/2603317458dc470e5710f5f94d86594dda402a34"}]},"PHID-TASK-fncgmab75rsumfugu4xq":{"id":"254","title":"disable whonix.org blog comments, redirect them to Whonix forum","status":"resolved","priority":"High","author":"Patrick","description":"There is low activity in the blog. Mostly spam comments. Since blog comments are automatically mirrored to the forum, every spam comment generates extra work cleaning those up twice.\n\nUnless someone else steps up to handle the spam, I am planning to disable blog comments. Comments are still welcome and open in the forums. New blog posts will hopefully still be automatically mirrored to Whonix forums [by by the wordpress wpsmf plugin] [and the whonix-devel mailing list]. Editing blog posts to add a link to the mirrored forum post is currently a manual process, that could be automated one day with some wordpress [plugin] php hacking.","comments":[]},"PHID-TASK-253zkqfgdzobuyxm7tci":{"id":"253","title":"make tb-starter compatible with TBB 4.5a5 and above","status":"resolved","priority":"Normal","author":"Patrick","description":"Already reported against torbrowser-launcher:\nhttps://github.com/micahflee/torbrowser-launcher/issues/176\n\nApply to #tb-starter in the same way.\n","comments":[{"author":"Patrick","date_created":1427987864,"date_modified":1427987864,"content":"Fixed.\n\nmake tb-starter compatible with TBB 4.5a5 and above:\nhttps://github.com/Whonix/tb-starter/commit/7ccdc3e03868a61f5d1a0d95384dc4af18402229\n\nHopefully TBB alpha won't become the new stable before Whonix 10 is out so this won't require a new stable release."}]},"PHID-TASK-kbsssqschxprqmctedgd":{"id":"252","title":"qubes-whonix build debuggbility of tags","status":"invalid","priority":"Normal","author":"Patrick","description":"As per https://phabricator.whonix.org/T233#3363... Can you make builds without having signed tags available? @nrgaway\n\nAn eventual dependency on official signed git tags seems for non-redistributable builds seems weird, complicating and slowing down developing. Let's suppose that tag doesn't work, and we'd need 4, 5 intermediate test builds for development, then it would be awful if you'd always need to wait for me to create the tag.","comments":[{"author":"nrgaway","date_created":1427898262,"date_modified":1427898262,"content":"Personally I can make builds without signed tags since I use my repo when testing and I sign every commit and tag/sign every push.\n\nBy default the qubes-builder will not even initialize the git repo on download if it is not signed and verified.  The process to download sources in then aborted.  There is a flag that can be set to not verify, but it is really only useful in weird situations.\n\nI would not advise an end user to disable verification though."},{"author":"Patrick","date_created":1427977342,"date_modified":1427977342,"content":"Seems not an issue then."}]},"PHID-TASK-3tbtbarjogdrnwin6c7k":{"id":"251","title":"Tor systemd startup issue","status":"resolved","priority":"High","author":"nrgaway","description":">>! In T233#3269, @Patrick wrote:\n>>>! In T233#3268, @nrgaway wrote:\n>> I have a problem on initial run of `whonix-setup-wizard` where Tor is not restarting.  Will get back on that once I can find the problem.\n> \n> I bumped into this issue when creating Debian jessie based Whonix builds. My speculation is, that it's a bug in Tor and/or Tor's systemd unit / sysvinit script. I think it only happens on first boot, so for debugging it would make sense to make a snapshot at the point where Tor gets reload etc. I am quite certain the issue is not directly caused by whonixsetup or whonix-setup-wizard. For debugging purposes, I think it would be easiest if the the Tor enable logic should be tested in a simple, minimal shell script. Scripts that can be manually run for testing:\n> \n> * whonixsetup: https://github.com/Whonix/whonixsetup/blob/master/usr/lib/whonixsetup_/ft_m_1\n> * whonix-setup-wizard: https://github.com/Whonix/whonix-setup-wizard/blob/master/usr/share/pyshared/whonix_setup_wizard/tor_status.py\n> \n> Fixing the likely systemd related issue requires to make those scripts compatible with systemd.\n","comments":[{"author":"Patrick","date_created":1427893841,"date_modified":1427893841,"content":"After first start of Whonix-Gateway, just ignore whonix-setup-wizard and open a terminal.\n\nHere are instructions on how to reproduce this issue. I am attempting to write generic instructions so the bug can be reproduced on Whonix-Gateway as well as on plain Debian jessie.\n\n```\n## 1) Stop Tor.\nservice tor stop\n\n## 2) Append 'DisableNetwork 1' to /etc/tor/torrc.\n\n## 3) Start Tor with Tor networking disabled.\nservice tor start\n\n## 4) Check Tor's status.\nservice tor status\n\n## 5) All fine until now.\n\n## 6) Set 'DisableNetwork 0' in /etc/tor/torrc\n\n## 7) Reload Tor to enable Tor networking.\nservice tor reload\n\n## 8) Check Tor's status.\nservice tor status\n\n## 9) Result:\n## Tor service no longer running.\n## Expected result:\n## Tor running with networking enabled.\n```\n\nI was able to reproduce this issue multiple times in a row on a jessie [and therefore also systemd] based Whonix-Gateway 10.0.0.4.3-developers-only, but not yet on a plain Debian jessie [and therefore also systemd] based system.\n\n@nrgaway, do you think you can get to the bottom of this one?"},{"author":"nrgaway","date_created":1427898675,"date_modified":1427898675,"content":"Yes, I created that python-sh package that I was going to use to write a shutdown, restart script; one you can use from the shell scripts as well.\n\nI plan to also maybe write a systemd system unit file if non are available for tor.\n\nThe proper syntax for systemd status/start/stop/restart is something like this:\n`systemctl start tor`\n`systemctl isactive tor`"},{"author":"Patrick","date_created":1427900213,"date_modified":1427900213,"content":"It would be trivial to use restart rather than reload in existing scripts. That would fix this issue. But it comes with disadvantages. For one, this obscure Whonix-only bug would remain.\n\nUsing reload rather than restart has advantages.\n\n* reload is more correct\n* given us a chance to understand this obscure Whonix-only bug\n* faster (think: a zillion of hidden services and/or listeners in data centers)\n* doesn't needlessly restart Tor for users who re-run the wizard, i.e. doesn't interrupt active Tor internet and control port connections\n\n> The proper syntax for systemd status/start/stop/restart is something like this:\n\nYes, but it doesn't matter here. `service` seems to be fully compatible and doing the same. While using the `systemctl` equivalents, I can reproduce the same issue.\n\n> I plan to also maybe write a systemd system unit file if non are available for tor.\n\nThere is none in jessie or sid. Please submit to upstream, Debian and/or TPO. It ensures high quality and compatibility, reduces Whonix-only issues.\n\nIf you want to ship it before Debian stretch, the correct package to add it is:\nhttps://github.com/Whonix/anon-gw-anonymizer-config\n\n[Once that was done, I would add the proper config-package-dev config on top, so there won't be conflicts as soon as upstream ships the systemd unit.]\n\nMaybe it's a sysvinit [script] issue and/or systemd compatibility issue. Maybe a systemd unit would make proper reload work."},{"author":"Patrick","date_created":1428159878,"date_modified":1428159878,"content":"Does this necessarily be finished for Whonix 10? @nrgaway\n\n(Asking, because I would like to release Whonix 10 rather sooner than later, as per: https://www.whonix.org/forum/index.php/topic,1071.)"},{"author":"nrgaway","date_created":1428416217,"date_modified":1428416217,"content":"I was hoping so.  Can you give me a day or 2 to see if I can fix it within that time frame?"},{"author":"Patrick","date_created":1428422722,"date_modified":1428422722,"content":"Sure."},{"author":"Patrick","date_created":1428942039,"date_modified":1428942039,"content":"@nrgaway any updates?"},{"author":"nrgaway","date_created":1429023809,"date_modified":1429023809,"content":"Sorry, these messages sometime are ending up in spam folder.\n\nNo, I have been unable to complete testing.  Last week I had a bad system crash and took 2 days to recover my file system.  Since then my system has crashed 2 more times in similar fashion when attempting to do template build.  I am in process to try to determine cause since SSD smartctl tests pass as well as scrubbing and balancing my file system. \n\nI only have one functional computer to do these builds and can not afford another at the current moment.\n\nI suppose the best thing for you is not to list this as a blocker I can always work around the issue, or we can fix it in 10.1 if appropriate. "},{"author":"Patrick","date_created":1429025745,"date_modified":1429025745,"content":"Yes, this one really would be better off with a Qubes specific patch until Whonix 10.1 or Whonix 11."},{"author":"MemoryLost","date_created":1429209299,"date_modified":1429209299,"content":"May I help?"},{"author":"nrgaway","date_created":1429739482,"date_modified":1429739482,"content":"I have written a tor systemd unit file that seems to be working.  I have added it to the qubes-whonix package.\n[[ https://github.com/nrgaway/qubes-whonix/blob/master/etc/systemd/system/tor.service | https://github.com/nrgaway/qubes-whonix/blob/master/etc/systemd/system/tor.service ]].\n\nSystemd unit files should be more reliable when attempting to probe the status when using commands such as 'systemctl is-active tor', and 'systemctl is-enabled tor'.\n\nI still need to test further since I do receive some network errors like sock connection refused.  I am thinking it could be related to the watchdog setting.  When the initial unit file looks stable I have also started on a hardened one [[ https://github.com/nrgaway/qubes-whonix/blob/master/tests/wip/tor.service | https://github.com/nrgaway/qubes-whonix/blob/master/tests/wip/tor.service ]]\n\nAt the same time I have also created a whonixcheck unit file which is not in use currently but did seem to work when testing with it. [[ https://github.com/nrgaway/qubes-whonix/blob/master/tests/wip/whonixcheck.service | https://github.com/nrgaway/qubes-whonix/blob/master/tests/wip/whonixcheck.service ]].  Main reason I am not using it is it had a status conditional that would return a different result based on a file being present or not and I am not sure if that is possible to do with systemd and may require a separate 'oneshot' unit file to report that?  Anyway,  we can discuss this further in a seperate issue as well if you want me to continue working on it.\n\nI initially also glanced at the `sdwdate` startup script but would need more documentation as to the expected operation.  If you want me to attempt to create the systemd unit file for that, just stat a new topic with some documentation of its use so we can discuss further.\nNote, that both unit files have corresponding configuration files in /etc/tmpfiles.d directory to create the `/var/run` directories.\n\n@MemoryLost Help is always welcome :)  How would you like to help?\n\n"},{"author":"Patrick","date_created":1429743388,"date_modified":1429743388,"content":"Yes, please help with systemd stuff.\n\nCan you commit the whonixcheck and other systemd files to their corresponding packages please i.e. whonixcheck etc? Now, that Whonix 11 is jessie-only, that should be easier.\n\nThe Tor systemd file belong to:\nhttps://github.com/Whonix/anon-gw-anonymizer-config\n\nFor sdwdate, also a standard systemd file suffices. Forget about the non-standard `restartnd`, `restartndclean` actions. This has to be somehow re-done in the timesync package itself.\n\n> Main reason I am not using it is it had a status conditional that would return a different result based on a file being present or not and I am not sure if that is possible to do with systemd and may require a separate 'oneshot' unit file to report that?\n\nYou most likely mean `do_status` from `/etc/init.d/whonixcheck`, `/var/run/whonixcheck/whonixcheck_done`. No. Just forget about this. What I cooked up there is fancy, non-standard and not what either sysvinit or systemd status command is for. A simple, standard conform service running or not thing would be sufficient. Nothing fancy."},{"author":"Patrick","date_created":1432131008,"date_modified":1432131008,"content":"The original issue of this ticket is solved for now as of `11.0.0.1.7-developers-only`. The Tor daemon is automatically started on first boot.\n\nWill leave this open until T316 is sorted out and then check again."},{"author":"Patrick","date_created":1432144152,"date_modified":1432144152,"content":"This is fixed, but there is a similar outstanding issue. Created T320 for it."}]},"PHID-TASK-6jgsfzeilsppesu4yr7k":{"id":"250","title":"extra fields in phabricator for severity and difficulty as alternative for priority","status":"open","priority":"Normal","author":"Patrick","description":"Let's take for example T203, T207, T31.\n\nThose are currently priority \"normal\". But what do we use the priority field for at the moment anyhow? Mostly it's set to \"normal\".\n\nCan we developers use it perhaps the priority field for some kind of \"high means, should be done as fast as possible\" [because it would otherwise block a point release or otherwise make someone else's task harder than necessary]? For easy tasks such as \"add package xyz with signed tag to repository\"?\n\nWhat I find not useful on most bug trackers is users bickering about priority \"high means important\". By that logic, we would never get to work on the priority \"normal\" tasks.\n\nSo I hereby suggest extra fields:\n\n* severity: Describing the impact. For example T203, T207, T31 could be declared that they might have a \"high\" impact. I.e. those could significantly increase security. Alternatively we could call it \"impact\" rather than \"severity\".\n* difficulty: Based on our current team and/or time requirements we estimate, we could also say for example T203, T207, T31 have difficulty \"high\". Not sure if the difficulty field would be any useful or rather deterring?\n\nOther options:\n* we keep leave it as is\n* we also remove the \"priority\" field\n* something else\n\nAny opinions?","comments":[{"author":"HulaHoop","date_created":1427245536,"date_modified":1427245536,"content":">Can we developers use it perhaps the priority field for some kind of \"high means, should be done as fast as possible\"\n\nYes, that's how I always looked at it.\n\n And also the Severity and Difficulty fields make alot of sense as they all represent different but important properties of a ticket.\n\nDifficulty level shouldn't be a deterrent. Lets say someone experienced reads a ticket you describe as hard, they can readjust the difficulty as easy once they claim the task."},{"author":"troubadour","date_created":1427321946,"date_modified":1427321946,"content":"I am not sure either if a difficulty field would be useful.\n\nAn extra field reflecting the impact a task could have on the security (or usability...) of Whonix looks meaningful. Now \"severity\" could be misleading, the highest severity being easily interpreted as the highest priority, which might or might not be the case.\n\nOr what about cleaning up and organizing the tags in a hierarchy? At the moment, a lot of tags link to nowhere, and some of them are probably not needed, like `python` or `bash`, or they seem created for a single task (the title should be self-explanatory).  Some other are dead but could be useful in this perspective (`security`, `usability`).\n\nWe could order the tags (mandatory order):  \n- distribution/version: `whonix`  `whonix 10`  `qubes-whonix` and so on, (`all`).\n- importance:  `normal` `high` `blocker` \n- category: `development`  `maintenance` `update` `bug report` `bug fix` or something like that \n- sub-category: `general` `security` `usability` `research` and probably more.\n\nThis is just a raw suggestion (don't know if it's achieavble in Phabricator). It's hard to cover every possible subject with predefined tags, take it as a general idea for a better readability of the tracker. And it would be nice to have a summary in the form of a road map, as in Tails (https://labs.riseup.net/code/projects/tails/roadmap)."},{"author":"WhonixQubes","date_created":1427433531,"date_modified":1427433531,"content":"I generally like the idea of these extra ticket attribute fields.\n\nBut I question the experience of using the `difficulty` field somewhat.\n\nIf we create a ticket about an issue where we may not be the person -- or only person -- to work on resolving it, then how do we know how \"difficult\" something is?\n\nWhat is easy for one of us might be hard for another, so our own personal bias of rating difficulty may make it not useful for others.\n\nRegarding the other fields...\n\nPriority would maybe be better served with a more time-related term, like \"Urgency\"?\n\nI do like the idea of generally filtering for Severity/Impact too."},{"author":"Patrick","date_created":1427750771,"date_modified":1427750771,"content":"[Added](https://phabricator.whonix.org/config/edit/maniphest.custom-field-definitions/) a new field `Impact` which defaults to `Needs Triage`, but can also be set to `Normal`, `High` or `Low`. All these words and options are arbitrary, i.e. it would be simple to rename it to something else and to add additional options such as `Lowest`, `Highest` or whatever. For new tasks it defaults to `Needs Triage`. Don't worry, if you don't know, just leave it as is. It's not something we need to go crazy about. For existing tasks, when you edit them, you'll add this field.\n\nPriority rename to Urgency:\nGood idea, but phabricator does not support renaming default fields. (asked on IRC.) We try a feature request against phabricator. But until it's not possible, let's use \"Priority\" as a synonym for \"Urgency\".\n\nSorting tags:\nGood idea. Phabricator doesn't have a feature to automatically enforce some order. Doing it manual seems like a lot work. (I am not opposed if one wants to do it, but I guess no one would step up.) We try a feature request against phabricator.\n\nDeprecating tags:\nYes, we can get rid of less useful tags such as `bash` or `python` that aren't used consistently. (Adding `bash` and `python` wherever it's involved seems tiresome.)\n\ndifficulty:\nMight indeed not be that useful. Some projects use integer fields for `estimated hours` and `actual hours`. But as long we are not counting hours for any purpose (which adds overhead by itself), I think we don't need these."}]},"PHID-TASK-wnuy2zozk5g6lzq2hvdo":{"id":"249","title":"move backup raw image build steps out of main source code","status":"resolved","priority":"Normal","author":"Patrick","description":"* build-steps.d/1400_backup-raw-after-grml-debootstrap\n* build-steps.d/1800_backup-raw-after-package-install\n\nThey're mostly useful for debugging, but in most cases for most those are useless. They should be moved to packages/whonix-developer-meta-files/debug-steps/, perhaps with an option to symlink them into the build-steps.d folder.\n","comments":[{"author":"Patrick","date_created":1427209246,"date_modified":1427209246,"content":"Done:\n* https://github.com/Whonix/whonix-developer-meta-files/commit/aa7c8acc454d15ef8e4e98939cce0615ceef0b14\n* https://github.com/Whonix/Whonix/commit/ed8760355973089978aea848c8fd619b438ee6c1\n* https://github.com/Whonix/whonix-developer-meta-files/commit/d2bb39bf6729e0468319b8a62c5f3f0b50e20aa9\n"}]},"PHID-TASK-q43jmvjpy3n5qik432ki":{"id":"248","title":"whonixcheck workaround can be removed in qubes-whonix 10","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/QubesOS/qubes-linux-template-builder/blob/master/scripts_debian/wheezy%2Bwhonix/02_install_groups_packages_installed.sh#L248\n\n```\n    # Prevent whonixcheck error\n    echo 'WHONIXCHECK_NO_EXIT_ON_UNSUPPORTED_VIRTUALIZER=\"1\"' >> \"${INSTALLDIR}/etc/whonix.d/30_whonixcheck_default\"\n```\n\nCan be removed.\n\nThat should be fixed in whonixcheck that comes with Whonix 10. I think we discussed/fixed this elsewhere already but not sure. If you get this updated file for testing, it should work out of the box:\nhttps://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_virtualizer\n\nAs a side note, generally, when having the \".d\" mechanism (https://www.whonix.org/wiki/Whonix_Configuration_Files#.d_style_configuration_folders) it's best not to touch the original file but to ship one that overrules the default setting. (Higher number named file.)","comments":[{"author":"Patrick","date_created":1433992168,"date_modified":1433992168,"content":"Looks like you done this, @nrgaway?"},{"author":"nrgaway","date_created":1434020125,"date_modified":1434020125,"content":"Its now in `etc/whonix.d/40_qubes:WHONIXCHECK_NO_EXIT_ON_UNSUPPORTED_VIRTUALIZER=\"1\"`\nsince I was still getting those errors in Whonix 10.\n\nYou saying I should not have?  Guess we could try removing it for Whonix 11?"},{"author":"Patrick","date_created":1434021869,"date_modified":1434021869,"content":">>! In T248#5442, @nrgaway wrote:\n> Its now in `etc/whonix.d/40_qubes:WHONIXCHECK_NO_EXIT_ON_UNSUPPORTED_VIRTUALIZER=\"1\"`\n> since I was still getting those errors in Whonix 10.\n\nThat's better.\n\n> You saying I should not have?  Guess we could try removing it for Whonix 11?\n\nThe right thing is to fix it upstream in #whonixcheck, no? It should be fixed upstream in #whonixcheck already. I remember discussing this with WhonixQubes and [fixing](https://github.com/Whonix/whonixcheck/commit/6bf5a08e88d83b3728ebc1dd87e5e43ef0a1871f) this. ([check_virtualizer](https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_virtualizer) script)\n\nFor a quick test:\n* no rebuild required\n* (Temporarily) remove the `WHONIXCHECK_NO_EXIT_ON_UNSUPPORTED_VIRTUALIZER` setting.\n* Run: `whonixcheck --function check_virtualizer` | Expected result: nothing\n* Run: `whonixcheck --verbose --function check_virtualizer` | Expected result: supported virtualizer\n\nOtherwise it should be fixed upstream in #whonixcheck for #qubes-whonix_12."},{"author":"Patrick","date_created":1439690854,"date_modified":1439690854,"content":"https://github.com/Whonix/qubes-whonix/commit/390c8db4aff5ff0cb1007d967253f3bf6c44f6ef"}]},"PHID-TASK-7th7cmwnxaxmi647raws":{"id":"247","title":"qubes-whonix 10 ./whonix_build command needs to be updated for Whonix 10","status":"resolved","priority":"Normal","author":"Patrick","description":"To save you some headache figuring out how the command line interface changed for Whonix 10, I looked at your build command.\n\n```\nsudo ~/Whonix/whonix_build \\\n    --build $1 \\\n    --64bit-linux \\\n    --current-sources \\\n    --enable-whonix-apt-repository \\\n    --whonix-apt-repository-distribution $2 \\\n    --install-to-root \\\n    --skip-verifiable \\\n    --minimal-report \\\n    --skip-sanity-tests || { exit 1; }\n```\n\nNo features have been removed. Just the interface is now much more pretty and future proof. So it should still work out all just fine. Here is a table that is an overview of old and new command line parameters.\n\n| old  | new\n| -----  | -----  |\n| --build $1  | --build --flavor whonix-gateway\n|    --64bit-linux | --kernel <Quoted space delimited list of packages.> | --arch amd64 --kernel linux-image-amd64\n|     --current-sources | --freshness current    \n| --enable-whonix-apt-repository | --whonix-repo wheezy\n| --install-to-root | --target root\n| --minimal-report | --report minimal\n| --skip-sanity-tests | --sanity-tests false\n| --skip-verifiable | --verifiable false\n\nThe build command for Whonix 10, will look somewhat like this.\n\n```\nsudo ./whonix_build --flavor whonix-gateway -- --build --target root --[...]\n```\n\nFor more info on command line...\n\n```\nsudo ./whonix_build --help\n```\n\n```\nsudo ./help-steps/whonix_build_one --help\n```\n\nI have two questions or so on why you are using some build options, but I will create threads in the forums.","comments":[{"author":"nrgaway","date_created":1427328052,"date_modified":1427328052,"content":"Guess this is a hint for me to get on it :)\n\nWhat build options would you suggest using.  I will attempt to build with those options.  "},{"author":"Patrick","date_created":1427331443,"date_modified":1427331443,"content":"Good question. As minimal as possible. For Whonix 10...\n\n```\nsudo ~/Whonix/whonix_build \\\n   --build \\\n   --arch amd64 \\\n   --kernel linux-image-amd64 \\\n   --headers linux-headers-amd64 \\\n   --target root \\\n   --report minimal \\\n   --verifiable false \\\n```\n\n* `--headers` depends. It's not really necessary for non-VirtualBox builds, because you don't have to compile any kernel modules (guest additions). But I would say, that having those installed by default increases usability for any kind of kernel module the user may want to use, because otherwise dkms doesn't show any useful hint that kernel headers are missing. Not that important, though. Otherwise for not installing any, `--headers none`.\n* Ideally we can avoid `--freshness current` for Whonix 10 by fixing the underlying issues. Please report them.\n* Maybe in future we can create a `--target qubes` where we do stuff that helps to reduce Qubes specific hacks, such as \"don't install apt-cacher-ng\" and whatnot. I have some ideas on how to prevent the build dependencies being installed in the image (well, because that's also how Whonix usually worked for other targets). Let's open separate tickets for that."},{"author":"nrgaway","date_created":1429733217,"date_modified":1429733217,"content":"Do these build instructions still stand for the development tag version?\n\nI was getting errors with the verifiable option.  Is it important on option order? \n\nPretty much just want to build as stated above"},{"author":"Patrick","date_created":1429734267,"date_modified":1429734267,"content":"> Do these build instructions still stand for the development tag version?\n\nUp to 10.x, i.e. up to 10.0.0.5.5 at the moment, yes. (Not changed in 11.x now either, not planned, but you never know.)\n\n> Is it important on option order?\n\nAs long as those apply to either whonix_build or help-steps/whonix_build_one, the order doesn't matter.\n\nSyntax as per https://www.whonix.org/wiki/Dev/Build_Documentation/10_full.\n```\nwhonix_build <parameters for whonix_build> -- <parameters for help-steps/whonix_build_one>\n```\n\n> I was getting errors with the verifiable option.\n\nMy mistake. Should be `minimal` rather than `false`. Also a small bug. Should have tested it. Anyhow. This works for me.\n\n```\nsudo \\\n   ./whonix_build \\\n  --flavor whonix-gateway \\\n  -- \\\n  --build \\\n  --arch amd64 \\\n  --kernel linux-image-amd64\n  --headers linux-headers-amd64\n  --target root \\\n  --report minimal \\\n  --verifiable minimal\n```\n\nIf it's not a command line parser error, but build issue, please open a new ticket.\n"}]},"PHID-TASK-io7iixvgmsttkemmligo":{"id":"246","title":"use deb [trusted=yes] rather than local signing key for local apt repository during build","status":"resolved","priority":"Normal","author":"Patrick","description":"It's equally secure and uses less code.","comments":[{"author":"Patrick","date_created":1427201264,"date_modified":1427201264,"content":"Done:\nhttps://github.com/Whonix/Whonix/commit/9cf6cb12dfc1a22e7e43e64f4bef3546749e8f02\n"}]},"PHID-TASK-tnvcrvsuenhxbd5vdvu5":{"id":"245","title":"tb-updater installation confirmation screen should show the literal gpg verification message for better security","status":"resolved","priority":"Normal","author":"Patrick","description":"Due to the difficulty of automation of gpg in scripts and therefore many people getting it wrong (for a few references and further information, see [1]), I conclude that, that gpg verification should not be fully automated at this point. Showing the literal gpg verification message to the user, so the user has a chance to double check gpg's output, seems more than justified to me at this point.\n\n-----\n\nTODO:\n\n* add gpg's verification output to tb-updater installation confirmation screen\n\n-----\n\n[1]:\n\n* https://github.com/micahflee/torbrowser-launcher/issues/137\n* https://github.com/micahflee/torbrowser-launcher/pull/148\n* https://github.com/micahflee/torbrowser-launcher/pull/149\n* https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=752275\n* https://github.com/rickard2/grsecurity-Debian-Installer/issues/10\n* https://github.com/rickard2/grsecurity-Debian-Installer/issues/13\n* [gpg-bash-lib](https://github.com/Whonix/gpg-bash-lib)\n* T234\n","comments":[{"author":"Patrick","date_created":1427130008,"date_modified":1427130008,"content":"Done in #gpg-bash-lib:\n* https://github.com/Whonix/gpg-bash-lib/commit/1ba9e1187f7cd845702111ad1dfa3e642e98ddd0\n* https://github.com/Whonix/gpg-bash-lib/commit/aeeeb84d57b6edcdbda721985b1aa93d7bc473f1\n\nDone in #tb-updater:\n* https://github.com/Whonix/tb-updater/commit/a41f640de4655362a4b5601434a2ec115b047da3\n\nTODO:\ntb_updater_gui (#msgcollector) window needs to become a tiny bit wider. Working on that now...."},{"author":"Patrick","date_created":1427130296,"date_modified":1427130296,"content":"This is how it's currently looking:\n{F51}\n\nOutput of gpg is broken in a non-ideal way.\n\n(Don't worry - I won't be signing Tor Browser. My key won't be used for verification. Just running the test script for better debuggability.)"},{"author":"Patrick","date_created":1427130683,"date_modified":1427130683,"content":"This is how I would like to it look:\n{F53}\n\n(Upstream won't be using the `gpg: Signature notation: issuer-fpr@notations.openpgp.fifthhorseman.net=6E979B28A6F37C43BE30AFA1CB8D50BB77BB3C48` line, so that will be gone.)\n\nI was wrong. It's not tb_updater_gui that needs to be changed. That's msgdispatcher_dispatch_x."},{"author":"Patrick","date_created":1427131400,"date_modified":1427131400,"content":"Test command:\n```\n/usr/lib/msgcollector/generic_gui_message warning 'Tor Browser Updater (by Whonix developers)' '<p><b>Installation confirmation</b></p><p><table><tr>\n<td>Currently installed version:</td> <td><tt> 4.0.4</tt></td></tr><tr>\n<td>Downloaded version         :</td> <td><tt> 4.5a3</tt></td></tr></table></p>\n<p><b>You could be target of an indefinite freeze attack!</b> The downloaded signature has the same creation date as the last known signature. Unless you are re-installing the same version, you should abort now and try again later!</p><p><table><tr>\n<td>Previous Signature Creation Date:</td> <td><tt> January 30 12:32:47 UTC 2015</tt></td></tr><tr>\n<td>Last Signature Creation Date    :</td> <td><tt> January 30 12:32:47 UTC 2015</tt></td></tr></table></p>\n<p><b>The signature looks quite old already.</b>\n<br></br>\n<br></br>Either,\n<br></br>- your clock might be fast (at least 22 days 4 hours 44 minutes 11 seconds fast). In that case, please run Timesync: <code>Start menu -> Applications -> System -> Timesync</code>. Or in Terminal: <code>timesync</code>.\n<br></br>- there is really no newer signature yet. The signature is really older than 30 days already. (Older than 22 days 4 hours 44 minutes 11 seconds already.)\n<br></br>- this is a update-torbrowser bug\n<br></br>- this is an attack</p>\n<p><u>gpg reports</u>:<br></br>\ngpg: Signature made Fri 20 Mar 2015 12:27:58 AM UTC using RSA key ID F65C2036<br />\ngpg: Good signature from \"Tor Browser Developers (signing key) <torbrowser@torproject.org>\" [unknown]<br />\nPrimary key fingerprint: EF6E 286D DA85 EA2A 4BA7  DE68 4E2C 6E87 9329 8290<br />\n     Subkey fingerprint: 5242 013F 02AF C851 B1C7  36B8 7017 ADCE F65C 2036</p>\n<p><a href=https://www.whonix.org/wiki/Tor_Browser/Installation_Confirmation_Screen>Learn more about this Installation Confirmation Screen.</a></p>' 'Install now?' yesno\n```"},{"author":"Patrick","date_created":1427131592,"date_modified":1427131592,"content":"I don't know how msgdispatcher_dispatch_x decided width, where to break lines.\n\n@troubadour could you please make these change in msgdispatcher_dispatch_x?"},{"author":"troubadour","date_created":1427230075,"date_modified":1427230075,"content":"The width is fixed in gneric_gui_messge, the height is dynamically adjusted. The lines break at word level.\nHave increased the width to accomodate the `Primary key fingerprint` in a single line.\nhttps://github.com/troubadoour/msgcollector/commit/07cfe95051b95b40d89cb69d0d6ed22c204efe25\n\nIf we run in other similar situations (one line should not be broken for better reading), we could add an `minimum_width` argument."},{"author":"HulaHoop","date_created":1427230797,"date_modified":1427230797,"content":"Anything that makes a reader stop and think is a welcome development. A recent study said that users brains switch off when they see a security warning because they've become used to ignoring them."},{"author":"Patrick","date_created":1427231837,"date_modified":1427231837,"content":"Merged. Looks good!\n\nScreenshot:\n{F55}\n"}]},"PHID-TASK-h3ywvrpdqxqdlscyeuby":{"id":"244","title":"br_add duplicate output","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/msgcollector/blob/master/usr/lib/msgcollector/br_add\n\n```\n#!/usr/bin/python\n\n## Copyright (C) 2014 troubadour <trobador@riseup.net>\n## Copyright (C) 2014 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\nimport sys\nin_ = sys.argv[1]\nprint in_\nout = '<br />\\n'.join(in_.split('\\n'))\nprint out\n```\n\nI am pretty sure the `print in_` is a leftover from debugging Will remove it.","comments":[{"author":"Patrick","date_created":1427048554,"date_modified":1427048554,"content":"Done:\nhttps://github.com/Whonix/msgcollector/commit/aa6e5c7d04626d79976d5329806082e00265f87e"}]},"PHID-TASK-dmbpwu6mekal7tnnh27l":{"id":"243","title":"control-port-filter-python improvement","status":"resolved","priority":"Normal","author":"troubadour","description":"So we have an expert opinion (https://mailman.boum.org/pipermail/tails-dev/2015-March/008461.html) on control-port-filter in Whonix. It looks like we could work on improving `cpfp.py`. \n\nI was expecting some of the points (especially the depth of `if`'s in the configuration file parsing). I'll see to that point by point.\n\nAbout logging, would it be an advantage to use syslog or systemd journal instead of a dedicated log file? For debugging, it seems better to keep it separate. ","comments":[{"author":"Patrick","date_created":1426862743,"date_modified":1426862743,"content":"Great!\n\nMy answer, that also \"answers\" the logging one by asking questions:\nhttps://mailman.boum.org/pipermail/tails-dev/2015-March/008471.html\n"},{"author":"troubadour","date_created":1427060218,"date_modified":1427060218,"content":"Some commits.\n- [configuration class](https://github.com/troubadoour/control-port-filter-python/commit/b043238d68b6ac68fd0432563de8024a9adeb789): all the global variables are moved into a new class.\n- [log only configuration file errors](https://github.com/troubadoour/control-port-filter-python/commit/2250f3de84697368bdcd3956c84bdb3530f1ed0d): no message if a configuration file is found. If we drop a snippet, only the last file read would be logged. It would be possible to give the list of found files. To be decided.\n- [bug If only ~ terminated or dpkg file in /etc/cpfpy.d](https://github.com/troubadoour/control-port-filter-python/commit/baf9ab9ca537a40421a30babbbb5f749f6af5dab): the daemon does not start (variables are not set) -> loads default configuration. \n"},{"author":"Patrick","date_created":1427062266,"date_modified":1427062266,"content":"You are missing a dot here:\n```\nselfDISABLE_FILTERING = False\n```"},{"author":"troubadour","date_created":1427062358,"date_modified":1427062358,"content":"Typo:\nhttps://github.com/troubadoour/control-port-filter-python/commit/eb11f771e36075999542e7aeadac5140f32e1137\n(which was not a typo)."},{"author":"troubadour","date_created":1427063336,"date_modified":1427063336,"content":"Missing dot:\nhttps://github.com/troubadoour/control-port-filter-python/commit/cc43e0684f41f134241fdf077aaf8daa3a1781a3"},{"author":"Patrick","date_created":1427146506,"date_modified":1427146506,"content":"Works for me. Merged."},{"author":"troubadour","date_created":1427491705,"date_modified":1427491705,"content":"Removed some redundant lines in the configuration file parsing loop:\n https://github.com/troubadoour/control-port-filter-python/commit/98151e803dda34b9c567399c857225baebd6c849\nhttps://github.com/troubadoour/control-port-filter-python/commit/8201de3fb0c6fe6902011733f83bcfc0fa240934"},{"author":"Patrick","date_created":1427655885,"date_modified":1427655885,"content":"Nice and merged."},{"author":"Patrick","date_created":1427998125,"date_modified":1427998125,"content":"Can the Whonix 10 tag be removed?"},{"author":"troubadour","date_created":1428084969,"date_modified":1428084969,"content":"Yes, the remaining work is cosmetic (so far).\n\nPushed two commits (pep8 and readability):\nhttps://github.com/troubadoour/control-port-filter-python/commit/bc514fefdea536aefe81f0bb9e1a9f842514d627\nhttps://github.com/troubadoour/control-port-filter-python/commit/b6c1c11fe4363f2d813ab639e1973779fa076b5c"},{"author":"Patrick","date_created":1449320628,"date_modified":1449320628,"content":"Is there anything left to do here?"}]},"PHID-TASK-ycfwuq573ngu7s6hwiv2":{"id":"242","title":"Whonix-Gateway support for multiple internal network interfaces","status":"open","priority":"Normal","author":"Patrick","description":"It's possible.\n\nDocumentation for it is basically ready:\nhttps://www.whonix.org/wiki/Connections_between_Whonix-Gateway_and_Whonix-Workstation#Using_additional_.28isolated.29_network_interfaces\n\nNeed to be polished and re-tested.","comments":[]},"PHID-TASK-kebjb44g5bdgidog5t3t":{"id":"241","title":"bandwidth quota per Whonix-Workstation traffic feature","status":"open","priority":"Normal","author":"Patrick","description":"Optional feature for limiting how much traffic a Whonix-Workstation may use in total per month.\n\nNot very Whonix specific. Probably just missing documentation on how to do that with any proxy server for any client.","comments":[{"author":"HulaHoop","date_created":1426814588,"date_modified":1426814588,"content":"Can be done on gw with the iptables quota feature:\nhttp://www.netfilter.org/documentation/HOWTO/netfilter-extensions-HOWTO-3.html#ss3.13\n\nThe only reliable way to do this is on an interface basis because a malicious workstation can spoof it's IP and bypass rules based on that.\n\nThis will then need gw to support managing multiple internal networks/interfaces.\n\n"},{"author":"Patrick","date_created":1426844283,"date_modified":1426844283,"content":"> Can be done on gw with the iptables quota feature:\n> http://www.netfilter.org/documentation/HOWTO/netfilter-extensions-HOWTO-3.html#ss3.13\n\nCommand works in Debian wheezy, although I didn't test yet if it stops if the actual quota is hit.\n\nAdding such rules in the right place could be cumbersome. So alternative solutions are still welcome.\n\n> This will then need gw to support managing multiple internal networks/interfaces.\n\nNot necessarily, but somewhat, yes. -> T242\n\n> The only reliable way to do this is on an interface basis because a malicious workstation can spoof it's IP and bypass rules based on that.\n\nThere are also other ways. These are documented here:\nhttps://www.whonix.org/wiki/Connections_between_Whonix-Gateway_and_Whonix-Workstation\nIf you wish to discuss those, please open [and link] a new forum thread[s] or new ticket[s]."}]},"PHID-TASK-dpryg2wwqtabiqt4qmcn":{"id":"240","title":"bandwidth throttling per Whonix-Workstation traffic feature","status":"open","priority":"Normal","author":"Patrick","description":"Optional feature for limiting how much KB/s a Whonix-Workstation may send.\n\nNot very Whonix specific. Probably just missing documentation on how to do that with any proxy server for any client.","comments":[{"author":"HulaHoop","date_created":1426814050,"date_modified":1426814050,"content":"http://libvirt.org/formatnetwork.html#elementQoS"}]},"PHID-TASK-ir3ccaskoe63igdu2ir5":{"id":"239","title":"DHCP support","status":"open","priority":"Normal","author":"Patrick","description":"Latest considerations on DHCP:\nhttps://www.whonix.org/wiki/Dev/DHCP\n\nMain TODO for now:\n* Does DHCP have some feature which a compromised Whonix-Workstation could abuse? Does DHCP have a feature such as \"tell me the IP of your upstream router\"?\n** TODO: Read this stuff...\n*** https://www.ietf.org/rfc/rfc2131.txt\n*** https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol\n\nForum discussion:\nhttps://forums.whonix.org/t/dhcp-server-on-the-gateway/195/3\n\nHelp welcome.","comments":[{"author":"HulaHoop","date_created":1426809572,"date_modified":1426809572,"content":"Running a DHCP on the gateway is bad for many reasons.\n\nThe default DHCP daemon was vulnerable to shellshock because it uses environment variables.\n\nAddress exhaustion attacks by a malicious workstation can disrupt other workstations even if they are on different internal networks because they share the same server. Unfortunately this is a protocol deficiency and is not going away anytime soon.\n\n\nKVM supports giving each internal network its own simplified dhcp server and address range."},{"author":"Patrick","date_created":1426842327,"date_modified":1426842327,"content":"Won't become a standard feature. Optional. Anything that works for #data_center_support."},{"author":"HulaHoop","date_created":1457921986,"date_modified":1457921986,"content":"From what I see DHCP servers have their own DNS resolver set by default and pass queries recursively upstream if they cannot answer it for whatever reason.\n\n\nhttps://en.wikipedia.org/wiki/Domain_Name_System\n\n\n\n> such a user will either have configured that server's address manually or allowed DHCP to set it; however, where systems administrators have configured systems to use their own DNS servers, their DNS resolvers point to separately maintained name servers of the organization. In any event, the name server thus queried will follow the process outlined above, until it either successfully finds a result or does not.\n\n\n\nhttps://libvirt.org/formatnetwork.html\n\n\n\n> The name attribute on the domain element defines the DNS domain of the DHCP server. This element is optional, and is only used for those networks with a <forward> mode of \"nat\" or \"route\" (or an isolated network with no <forward> element). Since 0.4.5\n> \n> If the optional localOnly attribute on the domain element is \"yes\", then DNS requests under this domain will only be resolved by the virtual network's own DNS server - they will not be forwarded to the host's upstream DNS server. If localOnly is \"no\", and by default, unresolved requests will be forwarded. Since 1.2.12 \n\n\n\n"},{"author":"Patrick","date_created":1457974810,"date_modified":1457974810,"content":"This is a huge task. Reading all the protocol and protocol extensions.\nPlus DHCP server documentation and possibly source code.\n\nIf someone wants to help with this...\n\n1) get an overview of available DHCP servers in Debian\n2) pick the more minimal ones\n3) ask the developers of the DHCP server if they work or can be\nconfigured to work with Whonix's threat model [1] [2]\n\n***\n\n[1] No IP discovery from the workstation, no clearnet DNS leaks.\n[2] be simple as in only provide IP addressed to workstations that\nconnect, no other fancy features"},{"author":"HulaHoop","date_created":1458008106,"date_modified":1458008106,"content":"The DHCP functionality in Libvirt can be customized to stop that harmful behavior as documented. A generic DHCP package will run into the problems described here however.\n\nAt least now we know what the limitations are."},{"author":"HulaHoop","date_created":1474678562,"date_modified":1474678562,"content":"Why do we insist on running the server on the GW? It will always increase attack surface. Alternatively I think its fine if it runs on Workstation-zero where other new cloned WSs on the internal network can bootstrap from.\n\npydhcplib is the best choice for client/server combo because its memory safe."},{"author":"Patrick","date_created":1474694671,"date_modified":1474694671,"content":"> Alternatively I think its fine if it runs on Workstation-zero where other new cloned WSs on the internal network can bootstrap from.\n\nI don't understand?\n\n>   Why do we insist on running the server on the GW? It will always\nincrease attack surface.\n\nGood question. Has long not been reconsidered. In past perhaps because\nof physical isolation, but that would not count anymore nowadays.\n\nVirtualizer specific. Some comments here:\n\nhttps://github.com/Whonix/whonix-gw-network-conf/blob/master/etc/network/interfaces.d/30_non-qubes-whonix\n\n- VirtualBox: as per comments, seams doable.\n- KVM: no idea\n- Qubes: does not need this\n\nSo if I make it work for VirtualBox, I wouldn't know if the same config\nwould work for KVM. In case of VirtualBox, I don't remember if it caused\nconflicts with real LAN, other VMs or cloned Whonix-Gateways.\n\n>   pydhcplib is the best choice for client/server combo because its memory safe.\n\nYes, memory safe language would be nice. However, that's a lib, not a\nbinary. If you can make it work, we can consider it."},{"author":"HulaHoop","date_created":1474720750,"date_modified":1474720750,"content":"There is the original WS with IP 10.152.152.11. Why not turn it into a DHCP server for any new clones added to the internal network? \n\nA clone when it boots up checks for DHCP requests and disables its own server copy if it detects and sets a dynamic IP.\n\n> I don't remember if it caused conflicts with real LAN, other VMs or cloned Whonix-Gateways.\n\nWhat kind of conflicts? Could you fool the Gateway filtering rules with spoofed IPs?\n\n> However, that's a lib, not a binary. If you can make it work, we can consider it.\n\nI'll look into it."},{"author":"Patrick","date_created":1474725822,"date_modified":1474725822,"content":"I messed that up. My last comment T239#10445 was an answer for T559 - please scratch my last comment.\n\n-----\n\nMoving the DHCP server to another place than Whonix-Gateway, one that doesn't know its own real external IP address, is a good idea.\n\nThere are some challenges:\n\n* How does the original Whonix-Workstation know it is the original Whonix-Workstation and not number two or a clone?\n* I am not yet convinced, that a Whonix-Workstation as currently defined is a proper place for that. That is kinda a strange idea.\n\nImagine a data center. Many workstations, many wires to Whonix-Gateway. How would they connect to the master workstation for DHCP? That seems strange.\n\nPerhaps for data center support, two gateway would be better. A Whonix-Workstation -> Whonix-DHCP-Server -> Whonix-Gateway.\n\nSo a Whonix-Workstation master that runs a DHCP server would not really work for data center support. It's still an interesting for VirtualBox / KVM. "},{"author":"HulaHoop","date_created":1474770261,"date_modified":1474770706,"content":"> How does the original Whonix-Workstation know it is the original Whonix-Workstation and not number two or a clone?\n\nGood question. The way this happens is pydhcp listens to the network to see if there are any DHCP packets broadcasted and parses it. If it does not detect anything (in case of master WS) it assumes the role of the server and starts broadcasting. The good thing about this is network DHCP server is auto-replaced if master WS goes down for any reason. There should be a sufficiently long interval for checking to allow a comfortable race condition.\n\nWhen subordinate WSs detect DHCP packets they immediately override the hardcoded static IP and only keep client functionality on.\n\n> I am not yet convinced, that a Whonix-Workstation as currently defined is a proper place for that. That is kinda a strange idea.\n\nIts not unreasonable given that enabling DHCP for internal networks means DNSMASQ instance on the host is used to communicate with high risk VMs. My goal is fix usability problems while not risking anything more than we have to.\n\nIMO though the multi WS behind a GW is not as critical a usecase because one must assume that these VMs are of the same trust level which would not justify the extra resources needed to spin them up.  - might as well use the same WS then. The proper way is to have different GW-WS pairs to isolate activities. So I don't think this particular ticket is a good investment of time if its difficult.\n\n> Imagine a data center. Many workstations, many wires to Whonix-Gateway. How would they connect to the master workstation for DHCP? That seems strange.\n\nIt could work for physical isolation builds supposing they are wired to the same switch (equivalent of an internal net I guess)"},{"author":"HulaHoop","date_created":1475264392,"date_modified":1475264392,"content":"From my tests in the other ticket:\n\n> Tested that multiple GWs using the same static ip works. No documentation changes needed for that.\n\nSince this is true for the external net then multiple identical static ips on inet should work without conflicting too (without DHCP support at all). The reason multi-WS isn't working has something to do with cpfp limitations in answering multiple WS requests I think."},{"author":"HulaHoop","date_created":1475270000,"date_modified":1475270000,"content":"Tests confirm that TBB on multi-WSs work without changing the static IP. Timesync on both VMs finishes successfully. TPO check reports the same IP in both TBB instances. The problems I see is Tor Button is confused and reports Tor is not working and New identity sometimes hangs with a \"cannot connect to controlport to change IP\"\n"},{"author":"Patrick","date_created":1475341047,"date_modified":1475341047,"content":"I don't know. May work. Sounds rather difficult. At the moment I cannot even think this through. #data_center_support currently is no focus to me. No prospective sponsor for this at the moment. And we don't have anyone who would actually implement this anyhow at the moment.\n\nIf someone wanted #data_center_support, I'd probably also not implement this one and rather go for Qubes-Whonix. That seems a lot more manageable for #data_center_support. It can service many ws behind the same gw without need for any dhcp. And it has qrexec, a service service that allows to easily and securely copy around files from one VM to another. And allows to run commands inside a VM, invoked from outside a VM. All controlled by policy which VM can control which other VM.\n\nA data center that wanted to provide custom Tor hidden services for clients had various options available to script this.\n\nDHCP support would have been interesting to more easily support multi ws behind same gw. (T567) But since the increased attack surface, probably a better solution has to be found to simplify this. Would perhaps not be that hard. Just each ws needs a unique IP. That must be doable somehow. We could just go for a random IP and hope that is not used by another ws. Or ask the user for a unique number for the VM in a specific range and then automatically adjust it. Worth another ticket.\n\n>>! In T239#10619, @HulaHoop wrote:\n> The reason multi-WS isn't working has something to do with cpfp limitations in answering multiple WS requests I think.\n\nIt should be perfectly capable to do this. If not, there is very good chance it will in Whonix 14."},{"author":"HulaHoop","date_created":1478906125,"date_modified":1478984923,"content":"For the record:\n\n>Fact. AFL uncovered many serious 0days in the DHCP server reference implementation.\n\nisc-dhcp\n\nhttps://www.cvedetails.com/vulnerability-list.php?vendor_id=64&product_id=17706&version_id=0&page=1&hasexp=0&opdos=0&opec=0&opov=0&opcsrf=0&opgpriv=0&opsqli=0&opxss=0&opdirt=0&opmemc=0&ophttprs=0&opbyp=0&opfileinc=0&opginf=0&cvssscoremin=0&cvssscoremax=0&year=0&month=0&cweid=0&order=1&trc=19&sha=962c7d6b1c11cc74fc9698948983fb909135a10f\n\nEspecially https://www.cvedetails.com/cve/CVE-2009-0692/\n\n***\n\ndnsmasq\n\nhttps://blog.skullsecurity.org/2015/how-i-nearly-almost-saved-the-internet-starring-afl-fuzz-and-dnsmasq"}]},"PHID-TASK-dgznbaujum3oa3d5nc3s":{"id":"238","title":"gpg-bash-lib compare signed_on_unixtime with stored value feature","status":"invalid","priority":"Normal","author":"Patrick","description":"Consider adding a feature to gpg-bash-lib for comparing $gpg_bash_lib_output_signed_on_date and $gpg_bash_lib_output_signed_on_unixtime stored values (T237).\n\nRelated code:\nhttps://github.com/Whonix/tb-updater/blob/468f6e9406ac8dab92fea2568a7a59edd048ab59/usr/bin/update-torbrowser#L1080\n\n```\n      if [ \"$last_used_gpg_bash_lib_output_signed_on_unixtime\" -lt \"$gpg_bash_lib_output_signed_on_unixtime\" ]; then\n         signature_freshness_msg=\"The downloaded signature is newer than the last known signature as expected.\"\n```\n\nThat would help to avoid having that code in applications that use gpg-bash-lib.","comments":[{"author":"Patrick","date_created":1459871868,"date_modified":1459871868,"content":"T237#8580"}]},"PHID-TASK-m57igfrlf52ulfuesr4c":{"id":"237","title":"gpg-bash-lib gpg_bash_lib_output_signed_on_[...] storage feature","status":"invalid","priority":"Normal","author":"Patrick","description":"Consider adding a feature to gpg-bash-lib for storing `$gpg_bash_lib_output_signed_on_date` and `$gpg_bash_lib_output_signed_on_unixtime` inside a configureable `/path/to/file`.\n\nThat would help to avoid having that code in applications that use gpg-bash-lib.\n\nRelated to:\nT238","comments":[{"author":"Patrick","date_created":1459871854,"date_modified":1459871854,"content":"Difficult to implement. Not worth it."}]},"PHID-TASK-4n3dsakgj5kyv7sjoy7r":{"id":"236","title":"post gpg-bash-lib RFP\n","status":"wontfix","priority":"Normal","author":"Patrick","description":"- post gpg-bash-lib RFP (request for packaging) against Debian\n* consider cc\n-- debian-devel\n-- pkg-anonymity-tools@lists.alioth.debian.org\n-- pkg-gnupg-maint@lists.alioth.debian.org\n","comments":[{"author":"Patrick","date_created":1428062293,"date_modified":1428062293,"content":"Waiting for feedback for T235. Therefore postponing to #Whonix_11."},{"author":"Patrick","date_created":1459368124,"date_modified":1459368124,"content":"There hasn't been any feedback whatsoever so likely this would be in vain."}]},"PHID-TASK-gdvlq3sphmzyfbe4hse3":{"id":"235","title":"initial gpg-bash-lib release and announcement","status":"resolved","priority":"Normal","author":"Patrick","description":"After T234 has been solved:\n\n* create a release\n* announce on\n** Whonix blog\n** gpg-dev mailing list\n** libtech mailing list","comments":[{"author":"Patrick","date_created":1427981725,"date_modified":1427981725,"content":"Done:\n* https://github.com/Whonix/gpg-bash-lib/releases/tag/0.5-1\n* https://www.whonix.org/blog/gpg-bash-verification-library\n* https://lists.gnupg.org/pipermail/gnupg-users/2015-April/053370.html\n* https://lists.gnupg.org/pipermail/gnupg-devel/2015-April/thread.html\n* https://twitter.com/Whonix/status/583622802269405184\n"}]},"PHID-TASK-n3tputgqi6smjz5lgjy5":{"id":"234","title":"--verify --status-fd separator for multiple signatures","status":"resolved","priority":"Normal","author":"Patrick","description":"I am not yet sure on how to best parse the status-fd, if there are multiple signatures.\n\nRelated code:\nhttps://github.com/Whonix/gpg-bash-lib/blob/master/usr/lib/gpg-bash-lib/modules.d/50_common#L326\n\nAsked on gnupg-users mailing list:\n`--verify --status-fd separator for multiple signatures?`:\nhttps://lists.gnupg.org/pipermail/gnupg-users/2015-March/053253.html","comments":[{"author":"Patrick","date_created":1427139319,"date_modified":1427139319,"content":"It should be fine. Checking for all the \"something not okay\" keywords:\nhttps://github.com/Whonix/gpg-bash-lib/blob/368e4106832a8bf34934696ee932ee746a1a5e1e/usr/lib/gpg-bash-lib/modules.d/50_common#L340\n\nAdditionally, added this.\n`stop parsing after first signature`:\nhttps://github.com/Whonix/gpg-bash-lib/commit/368e4106832a8bf34934696ee932ee746a1a5e1e\n\nAs extra safeguard, `tb-updater installation confirmation screen should show the literal gpg verification message for better security`: T245\n"}]},"PHID-TASK-vr45bevb6fa5h2rwzooo":{"id":"233","title":"qubes-whonix update issue because of bug in whonix-setup-wizard / whonix_repository","status":"resolved","priority":"Normal","author":"Patrick","description":"T232 affects `qubes-whonix`.\n\nDue due `qubes-whonix` `9.6` using packages `whonix-repository` and `whonix-setup-wizard` that are affected by T232, users will run into issues when attempting to upgrade from `9.6` to higher versions.\n\n`qubes-whonix` users are using the the literal `stable` code name in `/etc/apt/sources.list.d/whonix.list`, which this repository is no longer in use. It was last updated for Whonix `8`,\n\nTo let users `qubes-whonix` `9.6` users do binary upgrade, they also have to be told to use at least once `sudo whonix_repository --codename wheezy` beforehand or we need to get the repository with the code name `stable` up again. The latter would break systems of remaining users of Whonix `8` that are still having the `stable` repository enabled ([because 8 -> 9 upgrades were kinda \"bumpy\"](https://www.whonix.org/wiki/Upgrading_Whonix_8_to_Whonix_9)). But since Whonix `8` is no longer supported for a long time now anyhow, that would be acceptable.\n\nI somehow knew it wasn't ideal to derivate from Whonix default package selection and to sneak in features into the stable that are purposed for the development version.","comments":[{"author":"WhonixQubes","date_created":1426802087,"date_modified":1426802087,"content":"I can confirm that this is happening. Where `whonix-repository` is using `wheezy` repo and `whonix-setup-wizard` is using literal `stable` repo.\n\nI do suggest running `sudo whonix_repository` on the TemplateVMs, which will then use the `wheezy` repo, as part of the Binary Update Guide: https://www.whonix.org/wiki/Qubes/Binary_Update\n\nLooks like this is where the whonix-setup-wizard package is being installed from independently of Whonix in the QubesBuilder build process: https://github.com/marmarek/qubes-builder/blob/master/example-configs/templates.conf\n\nMarek mentioned to me that he will soon be building a new Whonix template, due to another problem. Maybe we could suggest fixing this too at the same time by using a different version of `whonix-setup-wizard` than `0.5-1` which would consistently use the `wheezy` repo instead?"},{"author":"nrgaway","date_created":1426806974,"date_modified":1426806974,"content":"I will test latest whonix-setup-wizard version tonight and if it works we can just get a signed tag and I will switch the qubes-builder scripts to use new version."},{"author":"WhonixQubes","date_created":1426807676,"date_modified":1426807676,"content":"Sounds good. Thanks @nrgaway. Does this sound okay for making updated `whonix-setup-wizard` tag @Patrick?"},{"author":"Patrick","date_created":1426842559,"date_modified":1426842559,"content":"You also need updated #whonix-repository tool (cli version, which is the backend)."},{"author":"nrgaway","date_created":1426844628,"date_modified":1426844628,"content":"Okay, thanks.  Its building now.  Think I just got that component built just in time for it to be installed ;)"},{"author":"Patrick","date_created":1426844836,"date_modified":1426844836,"content":"Ah, please tell me, if you need, I can bump changelog version and create a signed git tag for either one or both."},{"author":"WhonixQubes","date_created":1426845614,"date_modified":1426845614,"content":"Posted notification of this to Qubes devs...\n\nhttps://groups.google.com/d/topic/qubes-devel/qKJ1YxrAVzU"},{"author":"nrgaway","date_created":1426845903,"date_modified":1426845903,"content":">>! In T233#3200, @Patrick wrote:\n> Ah, please tell me, if you need, I can bump changelog version and create a signed git tag for either one or both.\n\nThe builds started about 15 minutes ago and will most likely take about another hour or so if there are no issues (I have one building and one in queue).  I will let you know my test results as soon as possible."},{"author":"nrgaway","date_created":1426855849,"date_modified":1426855849,"content":"I just finished testing with `whonix-setup-wizard` and only found a few issues.\n\nThe first issue is that argparse is is not allowing any of QT's command line arguments and terminates the program.  I start whonix-setup-wizard passing the QT style argument like follows: `XDG_CURRENT_DESKTOP=gnome sudo /usr/bin/whonix-setup-wizard setup -style gtk+`. This allows a nice pretty dialog to display instead of an ugly non styled root dialog.  I could also forgo calling with the style if I provide a default `trolltech.conf` file in `/root/.config/trolltech.conf`.\n\nAnyway, the fix is easy.  Change line number 29 from:\n`args = parser.parse_args()`\nto\n`args, unknown_args = parser.parse_known_args()`\n\nThe other issue I have to track down which is not related to whonix-setup-wizard.  I set an environmental variable `QT_X11_NO_MITSHM=1` which is not being set it seems.  That option prevents QT from using the `MIT-SHM X11` shared memory extension.\n\nIf you could see to the change and then tag and sign `whonix-setup-wizard` and `whonix-repository` I will finalize the changes on my side and re-test."},{"author":"Patrick","date_created":1426864971,"date_modified":1426864971,"content":">>! In T233#3209, @nrgaway wrote:\n>I could also forgo calling with the style if I provide a default `trolltech.conf` file in `/root/.config/trolltech.conf`.\n\nI think shipping a `/root/.config/trolltech.conf` should be avoided if possible. (More hacks, more room for new issues.)\n\nI am getting confused. This is is a separate issue, unrelated here?\n\n> Anyway, the fix is easy.  Change line number 29 from:\n> `args = parser.parse_args()`\n> to\n> `args, unknown_args = parser.parse_known_args()`\n\nDepends on what @troubadour thinks and how @troubadour wants to proceed. I don't know if @troubadour reads this Qubes specific ticket. Since it's off-topic here.\n\nFor small, simple changes, we got used to just posting the commit message followed by a colon with a link to the change. Here is an example:\nhttps://www.whonix.org/forum/index.php/topic,705.msg7421.html#msg7421\n\nFor more complicated issues, we got used to create separate tickets.\n\nThen the other reviews, tests, and merged it.\n\n> The other issue I have to track down which is not related to whonix-setup-wizard.  I set an environmental variable `QT_X11_NO_MITSHM=1` which is not being set it seems.  That option prevents QT from using the `MIT-SHM X11` shared memory extension.\n\nI am wondering why this is. Looks like this turns into fixing further, unrelated issues?\n\nWe are using these startup wrappers:\n\n* https://github.com/Whonix/whonix-setup-wizard/blob/master/usr/lib/whonix-setup-wizard/whonix-setup-wizard-setup\n* https://github.com/Whonix/whonix-setup-wizard/blob/master/usr/lib/whonix-setup-wizard/whonix-setup-wizard-repository\n \n(These are required for root. `kdesudo` is unappropriated, because KDE specific, and the generic `su-to-root` supports no command line parameters [submitted a patch: T85].)\n\nLooks like those should work differently if some gtk marker file or detection exists and also work differently if some qubes marker file or detection exists? Anyhow, seems like those should go into separate tickets.\n\n> If you could see to the change\n\nSee above.\n\n> and then tag and sign `whonix-setup-wizard` and `whonix-repository`\n\nDone with `whonix-repository` `1.1-1`."},{"author":"nrgaway","date_created":1426906721,"date_modified":1426906721,"content":">>! In T233#3219, @Patrick wrote:\n>>>! In T233#3209, @nrgaway wrote:\n>>I could also forgo calling with the style if I provide a default `trolltech.conf` file in `/root/.config/trolltech.conf`.\n> \n> I think shipping a `/root/.config/trolltech.conf` should be avoided if possible. (More hacks, more room for new issues.)\n> \n> I am getting confused. This is is a separate issue, unrelated here?\n> \n\nNow I am confused :)  The issue I have with `whonix-setup-wizard` at the moment is that it is preventing command line arguments from reaching the `QTGui` since the current argparse call throws an error when unknown command line arguments are provided.  A solution to this is in the example I provided  below.\n\n>> Anyway, the fix is easy.  Change line number 29 from:\n>> `args = parser.parse_args()`\n>> to\n>> `args, unknown_args = parser.parse_known_args()`\n> \n> Depends on what @troubadour thinks and how @troubadour wants to proceed. I don't know if @troubadour reads this Qubes specific ticket. Since it's off-topic here.\n> \n> For small, simple changes, we got used to just posting the commit message followed by a colon with a link to the change. Here is an example:\n> https://www.whonix.org/forum/index.php/topic,705.msg7421.html#msg7421\n> \n> For more complicated issues, we got used to create separate tickets.\n> \n> Then the other reviews, tests, and merged it.\n> \n>> The other issue I have to track down which is not related to whonix-setup-wizard.  I set an environmental variable `QT_X11_NO_MITSHM=1` which is not being set it seems.  That option prevents QT from using the `MIT-SHM X11` shared memory extension.\n> \n> I am wondering why this is. Looks like this turns into fixing further, unrelated issues?\n> \n\nYes, this issue not directly related to `whonix-setup-wizard`, although it would prevent `whonix-setup-wizard` from displaying any text in dialog boxes it creates.  The Qubes template does not allow access to shared memory and setting `QT_X11_NO_MITSHM` instructs `QT` not to attempt to use it.  \n\nIt should only effect Qubes release 3 at the moment and there have been no whonix-* releases published by ITL for release 3. I am investigating the issue on my end. \n\n> We are using these startup wrappers:\n> \n> * https://github.com/Whonix/whonix-setup-wizard/blob/master/usr/lib/whonix-setup-wizard/whonix-setup-wizard-setup\n> * https://github.com/Whonix/whonix-setup-wizard/blob/master/usr/lib/whonix-setup-wizard/whonix-setup-wizard-repository\n>  \n> (These are required for root. `kdesudo` is unappropriated, because KDE specific, and the generic `su-to-root` supports no command line parameters [submitted a patch: T85].)\n> \n> Looks like those should work differently if some gtk marker file or detection exists and also work differently if some qubes marker file or detection exists? Anyhow, seems like those should go into separate tickets.\n> \n>> If you could see to the change\n> \n> See above.\n> \n>> and then tag and sign `whonix-setup-wizard` and `whonix-repository`\n> \n> Done with `whonix-repository` `1.1-1`.\n\nThanks, I have implement the change to use `whonix-repository` `1.1-1`.  I will wait on @troubadour  to see if he can implement my suggested change otherwise I will need to create some type of work-around.\n\n"},{"author":"Patrick","date_created":1426954023,"date_modified":1426954023,"content":">>! In T233#3226, @nrgaway wrote:\n> Now I am confused :)  The issue I have with `whonix-setup-wizard` at the moment is that it is preventing command line arguments from reaching the `QTGui` since the current argparse call throws an error when unknown command line arguments are provided.  A solution to this is in the example I provided  below.\n\n> Yes, this issue not directly related to `whonix-setup-wizard`, although it would prevent `whonix-setup-wizard` from displaying any text in dialog boxes it creates.  The Qubes template does not allow access to shared memory and setting `QT_X11_NO_MITSHM` instructs `QT` not to attempt to use it.  \n\nLooks like two separate issues to me. None of them is related to this one. Let me explain where I am coming from. There seem to be too many unoutspoken, implicit assumptions. I would like to keep this ticket focused on the topic of this one:\n`qubes-whonix update issue because of bug in whonix-setup-wizard / whonix_repository`\nSee also original ticket description. About binary updates, apt repository line creation, `--codename` vs `--repository` and `stable` vs `wheezy` and `/etc/apt/sources.list.d/whonix.list`. Very limited scope.\nWhat's the good for? Well, for example\n* T232 was mostly my area. About the bug in whonix-repository and whonix-setup-wizard.\n* T233, this one, is mostly @nrgaway's and @WhonixQubes's area. About how T232 effects qubes-whonix. I assumed, this one would be about how to tell existing qubes-whonix users that are affected by this bug how to update, about signed git tags and a bug fix release.\n* whonix-setup-wizard, argparse is mostly @troubadour's area\n* whonix-setup-wizard, setting env var QT_X11_NO_MITSHM condionally, is mostly @troubadour's area\n\nThese are all very different tasks. Now, when we are in the middle of a ticket, this one, that is about `/etc/apt/sources.list.d/whonix.list`, I find it very non-ideal to discuss for example argparse there, because the ticket where it's written, is not @troubadour's main area. It may be read, but without having a reminder set up, the request is easily forgotten in the overwhelming flood of tasks. To find out what's to do next, I for one, have a bookmark for the [Whonix 10 tag open+review search](https://phabricator.whonix.org/maniphest/query/yHU1wrj09Qeb/#R). I am not sure, but I guess others do similar searches for other tags (components, such as whonix-setup-wizard). But when viewing those search results, I only read the subjects. That's why good subjects are very important. From there I decide on what to work on next. Any task that is off-topic in the middle of some ticket gets overlooked at that point. When you are lucky, it gets addressed when working on the ticket, because one might re-reads the whole discussion or when closing the ticket when hopefully checking if everything has been addressed.\n\nPerhaps when there are easy changes (ex: argparse), that are important to you for point releases and need them to be done quickly, because otherwise you'd need to apply workarounds, create a new ticket, that only talks about argparse. Perhaps, use priority \"high\". This should help to know to get it done next. (Changing priority of T203, T207, etc. to priority \"high\", does not look so useful to me. It's true that those would be great enhancements, but those tasks do not get any simpler and cannot/will not be implemented any faster, because priority is set to \"high\".)"},{"author":"nrgaway","date_created":1426957549,"date_modified":1426957549,"content":"I do actually see the `argparse` being related to this ticket on a broad scope since the issue directly impacted the ability to use `whonix-setup-wizard`.  \n\nOn a narrow scope, I understand your method and reasoning for separating out tickets and agree that they have merit to create their own tickets at this point.  My goal was to provide the impact this bug had which contains the necessary information for someone reading this ticket.  My other comments were in direct response to your questions and comments and again detailing the issues.\n\nUnfortunately I have not had the time to become very familiar with the functionality of this ticketing system and therefore welcome @WhonixQubes or yourself to move the appropriate messages into its own task.  I can not see an option to do that.  I will try to set aside some time in the coming weeks to familiarize myself better with the system.\n\n"},{"author":"troubadour","date_created":1426974154,"date_modified":1426974154,"content":">I do actually see the argparse being related to this ticket on a broad scope since the issue directly impacted the ability to use whonix-setup-wizard.\nDoes it impact the ability to use the wizard or is that a cosmetic issue? When run with sudo or kdesudo (or gksu), the style defaults to a root one, not that pretty, I agree.\n\nI have implemented the proposed change in `argparse` without  usability issue (if the second argument is not recognized, it's ignored) but before I push the change, could you check that there is no problem with the layout. The styles are changed and the `tor status` page is sort of messed up with the gtk style (no dynamic resizing in the wizard). Even if it reports:\n```QGtkStyle was unable to detect the current GTK+ theme.```\nthe buttons are changed, and so it seems, the font and spacing.\n\nIn order that the two versions of Whonix don't start to drift apart, the solution would be the patch to `su-to-root` proposed by Patrick in T85, Tested, it works and respects the environment style (Oxygen in Whonix). I assume you would not have to specify gtk+ in Gnome. \n\n"},{"author":"Patrick","date_created":1426996166,"date_modified":1426996166,"content":">>! In T233#3236, @troubadour wrote:\n> In order that the two versions of Whonix don't start to drift apart, the solution would be the patch to `su-to-root` proposed by Patrick in T85, Tested, it works and respects the environment style (Oxygen in Whonix). I assume you would not have to specify gtk+ in Gnome. \n\nThe patch won't land in Debian before Debian stretch. So quite some time to go.\n\nThe wrappers are here:\n\n* https://github.com/Whonix/whonix-setup-wizard/blob/master/usr/lib/whonix-setup-wizard/whonix-setup-wizard-setup\n* https://github.com/Whonix/whonix-setup-wizard/blob/master/usr/lib/whonix-setup-wizard/whonix-setup-wizard-repository\n\nWe could add some \"if qubes\" (or \"if gtk\"), then \"set these env vars...\" logic to thse wrappers."},{"author":"nrgaway","date_created":1427127542,"date_modified":1427127542,"content":">>! In T233#3236, @troubadour wrote:\n>>I do actually see the argparse being related to this ticket on a broad scope since the issue directly impacted the ability to use whonix-setup-wizard.\n> Does it impact the ability to use the wizard or is that a cosmetic issue? When run with sudo or kdesudo (or gksu), the style defaults to a root one, not that pretty, I agree.\n> \n> I have implemented the proposed change in `argparse` without  usability issue (if the second argument is not recognized, it's ignored) but before I push the change, could you check that there is no problem with the layout. The styles are changed and the `tor status` page is sort of messed up with the gtk style (no dynamic resizing in the wizard). Even if it reports:\n> ```QGtkStyle was unable to detect the current GTK+ theme.```\n> the buttons are changed, and so it seems, the font and spacing.\n\nI ran the tests with your changes and everything seems fine with the visual tests with the one exception you mentioned.  The top part of the `Tor status` page scrolls a bit but is acceptable IMO.  I am still not finished with my overall tests since I have a problem on initial run of `whonix-setup-wizard` where Tor is not restarting.  Will get back on that once I can find the problem.\n"},{"author":"Patrick","date_created":1427129319,"date_modified":1427129319,"content":">>! In T233#3268, @nrgaway wrote:\n> I have a problem on initial run of `whonix-setup-wizard` where Tor is not restarting.  Will get back on that once I can find the problem.\n\nI bumped into this issue when creating Debian jessie based Whonix builds. My speculation is, that it's a bug in Tor and/or Tor's systemd unit / sysvinit script. I think it only happens on first boot, so for debugging it would make sense to make a snapshot at the point where Tor gets reload etc. I am quite certain the issue is not directly caused by whonixsetup or whonix-setup-wizard. For debugging purposes, I think it would be easiest if the the Tor enable logic should be tested in a simple, minimal shell script. Scripts that can be manually run for testing:\n\n* whonixsetup: https://github.com/Whonix/whonixsetup/blob/master/usr/lib/whonixsetup_/ft_m_1\n* whonix-setup-wizard: https://github.com/Whonix/whonix-setup-wizard/blob/master/usr/share/pyshared/whonix_setup_wizard/tor_status.py\n\nFixing the likely systemd related issue requires to make those scripts compatible with systemd."},{"author":"nrgaway","date_created":1427257977,"date_modified":1427257977,"content":">>! In T233#3269, @Patrick wrote:\n>>>! In T233#3268, @nrgaway wrote:\n>> I have a problem on initial run of `whonix-setup-wizard` where Tor is not restarting.  Will get back on that once I can find the problem.\n> \n> I bumped into this issue when creating Debian jessie based Whonix builds. My speculation is, that it's a bug in Tor and/or Tor's systemd unit / sysvinit script. I think it only happens on first boot, so for debugging it would make sense to make a snapshot at the point where Tor gets reload etc. I am quite certain the issue is not directly caused by whonixsetup or whonix-setup-wizard. For debugging purposes, I think it would be easiest if the the Tor enable logic should be tested in a simple, minimal shell script. Scripts that can be manually run for testing:\n> \n> * whonixsetup: https://github.com/Whonix/whonixsetup/blob/master/usr/lib/whonixsetup_/ft_m_1\n> * whonix-setup-wizard: https://github.com/Whonix/whonix-setup-wizard/blob/master/usr/share/pyshared/whonix_setup_wizard/tor_status.py\n> \n> Fixing the likely systemd related issue requires to make those scripts compatible with systemd.\n\nCreated a task T251"},{"author":"troubadour","date_created":1427313228,"date_modified":1427313228,"content":">>! In T233#3268, @nrgaway wrote:\n> I ran the tests with your changes and everything seems fine with the visual tests with the one exception you mentioned.  The top part of the `Tor status` page scrolls a bit but is acceptable IMO. \nPushed the modified argparser (+ `unknown_args`) and increased the vertical size to accommodate the style change with GTK (looks better than the top text box with a scroll bar). Would have had to do it with Qt too, and the root \"style\" is only slightly shifted.\n\nhttps://github.com/troubadoour/whonix-setup-wizard/commit/33b63f7d6aca34cf47b2d12e22180205050598ef\n\n"},{"author":"nrgaway","date_created":1427340576,"date_modified":1427340576,"content":">>! In T233#3359, @troubadour wrote:\n>>>! In T233#3268, @nrgaway wrote:\n>> I ran the tests with your changes and everything seems fine with the visual tests with the one exception you mentioned.  The top part of the `Tor status` page scrolls a bit but is acceptable IMO. \n> Pushed the modified argparser (+ `unknown_args`) and increased the vertical size to accommodate the style change with GTK (looks better than the top text box with a scroll bar). Would have had to do it with Qt too, and the root \"style\" is only slightly shifted.\n> \n> https://github.com/troubadoour/whonix-setup-wizard/commit/33b63f7d6aca34cf47b2d12e22180205050598ef\n\nAwesome.  I will add it to my build config once Patrick gets the chance to tag and sign it.  Thanks for going to the effort to get this issue resolved so quickly."},{"author":"Patrick","date_created":1427718293,"date_modified":1427718293,"content":"Signed git tag `0.7-1` contains that change."},{"author":"nrgaway","date_created":1427838193,"date_modified":1427838193,"content":">>! In T233#3369, @Patrick wrote:\n> Signed git tag `0.7-1` contains that change.\n\nThanks, Will try running tests tonight."},{"author":"Patrick","date_created":1427997684,"date_modified":1427997684,"content":"If there is anything todo in the Whonix core for Whonix 10 release, please re-add the Whonix 10 tag.\n\nActually, I am not sure about the tag. Does this contain anything, that would speak against a stable release of Whonix 10? If you don't know yet, it's also fine to re-add the Whonix 10 tag. Just want to make sure, that this won't needlessly block the release of Whonix 10."},{"author":"nrgaway","date_created":1431781463,"date_modified":1431781463,"content":"Resolved with `qubes-whonix` `unreleased 9.6.9` and `10`"}]},"PHID-TASK-v6k2qqosejtmrohtwqtu":{"id":"232","title":"whonix-setup-wizard repository - code names issue - stable vs wheezy","status":"resolved","priority":"Normal","author":"Patrick","description":"I noticed that files created by `whonix_repository` vs `whonix-setup-wizard repository` differ.\n\nWhen users are choosing `stable` in `whonix_repository` tool (cli), it actually uses `wheezy` in  `/etc/apt/sources.list.d/whonix.list`. This is because `wheezy` means nothing to most users and because it's better to use specific (ex: `wheezy`) rather than generic codenames (ex: `stable`) as apt sources. The full reasoning and discussion behind this change can be found here:\nhttps://www.whonix.org/forum/index.php/topic,445\n\nWhen users however run `whonix-setup-wizard repository` and choose `stable`, it will run `whonix_repository --codename stable`, resulting in a literal `stable` rather than `wheezy` in `/etc/apt/sources.list.d/whonix.list`.\n\nThe idea behind `--codename codename` was an advanced user option to use the literal `codename`.\n\nWhat `whonix_repository` is missing is a switch that uses the same logic as the menu in `whonix_repository`. Such as a new switch `--repository stable|testers|developers` should be added, that translates to a specific codename (currently: `wheezy`). Rather the `--codename`, `whonix-setup-wizard repository` should then use `--repository`.","comments":[{"author":"Patrick","date_created":1426767211,"date_modified":1426767211,"content":"Done in #whonix-repository:\n- https://github.com/Whonix/whonix-repository/commit/18cc260948770986daf17d85b26553536aa604c2\n- https://github.com/Whonix/whonix-repository/commit/27c8f77e4cb96e6fcf2dfad4dd34f183ae77fe7b\n"},{"author":"Patrick","date_created":1426767615,"date_modified":1426767615,"content":"Done in #whonix-setup-wizard.\n`use --repository rather then --codename to fix \"whonix-setup-wizard repository - code names issue - stable vs wheezy\" - https://phabricator.whonix.org/T232`:\nhttps://github.com/Whonix/whonix-setup-wizard/commit/b84a98ea7a88ff15477a3ed71f51e05da6267a0b\n"}]},"PHID-TASK-cpn7rbjcjjcygkqgn63c":{"id":"231","title":"break when attempting to build from non-tagged git by default","status":"resolved","priority":"Normal","author":"Patrick","description":"Some support requests are generated because users do not check out a tag, i.e. effectively build from master. This sometimes causes difficult support requests.\n\nA sanity test could be easily implemented.\n\n```\n--allow-untagged false|true\nfalse: Break when build from non-tag. Default.\ntrue: Do not use unless you know what you are doing.\n```\n\nIn essence by comparing the output of\n\n```\ngit describe --always --abbrev=0\n9.6\n```\n\nvs\n\n```\ngit describe --always --abbrev=1000000000\n10.0.0.3.7-developers-only-6-g505c39d44d2a08451f7ff53ce67d78745e05816b\n```\n\nSimilar to function [`check_for_uncommited_changes`](https://github.com/Whonix/Whonix/blob/fe73443fb3548b4dad8de70d79a23ca5cec4cf4e/build-steps.d/1200_create-debian-packages#L134) with a good error message that suggests to just add `--allow-untagged true` for developers / advanced users.","comments":[{"author":"Patrick","date_created":1426268775,"date_modified":1426268775,"content":"Done:\nhttps://github.com/Whonix/Whonix/commit/e5fc6610cae73a320e52edb3da8b9b8866c5703f"}]},"PHID-TASK-k2ptw3ljmozfxhovnyla":{"id":"230","title":"whonix-setup-wizard - if /etc/tor/torrc does not exist","status":"resolved","priority":"Normal","author":"Patrick","description":"From `usr/lib/whonix-setup-wizard/whonixsetup_check_for_start`:\n```\n    if not os.path.exists('/etc/tor/torrc'):\n        # TODO: add gui message.\n        return 'no_torrc'\n```\nI am wondering if it would be best to remove that. Users could manually start whonix-setup-wizard anyhow, and then whonix-setup-wizard would have to be able to cope up with non-existing /etc/tor/torrc anyhow. (By just reporting the issue. Should be quite seldom. Unless you have a better idea. :)","comments":[{"author":"troubadour","date_created":1426106483,"date_modified":1426106483,"content":"> (By just reporting the issue. Should be quite seldom. Unless you have a better idea. :)\nThat's what it does does, reporting the error and giving some basic instructions to fix the problem (and re-run the wizard)."},{"author":"Patrick","date_created":1426107011,"date_modified":1426107011,"content":"Okay, then I suggest, we just remove this?\n\n```\nif not os.path.exists('/etc/tor/torrc'):\n    # TODO: add gui message.\n    return 'no_torrc'\n```"},{"author":"troubadour","date_created":1426194814,"date_modified":1426194814,"content":"It's one of the statuses returned to the wizard. If we remove it, the tor status page will be blank, as well as the finish page. \n\nWhat's confusing is the line\n``` # TODO: add gui message.```\nI'll remove it since the message is dispayed in the wizard."},{"author":"troubadour","date_created":1426194951,"date_modified":1426194951,"content":" If we remove it and `/etc/tor/torrc` does not exist, the tor status page will be blank,"},{"author":"Patrick","date_created":1426198553,"date_modified":1426198553,"content":"troubadour (troubadour):\n> What's confusing is the line\n> \n>   # TODO: add gui message.\n> \n> I'll remove it since the message is dispayed in the wizard.\n\nYes."},{"author":"Patrick","date_created":1426205962,"date_modified":1426205962,"content":">>! In T230#3038, @troubadour wrote:\n>  If we remove it and `/etc/tor/torrc` does not exist, the tor status page will be blank,\n\nI guess that would be better than not starting it at all."},{"author":"troubadour","date_created":1426623129,"date_modified":1426623129,"content":"Do you mean starting tor?\n\nIf we start the tor service but `/etc/tor/torrc` does not exist, it says \n```[....] Starting tor daemon...Mar 17 20:00:57.116 [warn] Couldn't find $HOME environment variable while expanding \"~/.torrc\"; defaulting to \"\".\ndone.```\n\nThe reported status is `tor is running`, the tor socket and pid are created, but it's unusable (by Tor Browser or whonixcheck). Al least here... "},{"author":"Patrick","date_created":1426626665,"date_modified":1426626665,"content":"No, I meant `I guest that would be better than not starting whonix-setup-wizard at all.`\n\nMy only suggestion for now for file `usr/lib/whonix-setup-wizard/whonixsetup_check_for_start`, the removal of this:\n\n```\nif not os.path.exists('/etc/tor/torrc'):\n    # TODO: add gui message.\n    return 'no_torrc'\n```\n\nPreferring to start whonixsetup anyhow in such situations. It seems wrong to check for non-existance of `/etc/tor/torrc` in `whonixsetup_check_for_start` and then just silently doing nothing."},{"author":"troubadour","date_created":1426712070,"date_modified":1426712070,"content":"I got mixed up in my own code.\n\nIt's a bug actually. The wizard is not started if `etc/tor/torrc`does not exist AND if the line `DisableNetwork 0` does not exist. The user is left in the dark.\n\nThe wizard is now started in either case.\nhttps://github.com/troubadoour/whonix-setup-wizard/commit/162f8d95fcc9a8ceeec92ea291ef1bfe4c728a38\n"},{"author":"Patrick","date_created":1426715447,"date_modified":1426715447,"content":"Merged. Works fine.\n\nCloseable?"},{"author":"troubadour","date_created":1426793675,"date_modified":1426793675,"content":"Yes."}]},"PHID-TASK-3rhcbiuo7gs2q24obiis":{"id":"229","title":"/var/lib/whonix/do_once/whonixsetup.done will change to /var/cache/whonix-setup-wizard/status-files/whonixsetup.done in Whonix 10","status":"resolved","priority":"Normal","author":"Patrick","description":"As per T155.","comments":[{"author":"nrgaway","date_created":1433607714,"date_modified":1433607714,"content":"Implemented\n"}]},"PHID-TASK-5ra7zp3ysittc6e3t2ay":{"id":"228","title":"no longer install anon-gw-first-run-notice by default?","status":"resolved","priority":"Normal","author":"Patrick","description":"Since https://github.com/Whonix/anon-gw-first-run-notice has been integreated into #whonix-setup-wizard, it no longer needs to be installed by default?\n\nWhat do you think, @troubadour?","comments":[{"author":"troubadour","date_created":1426103837,"date_modified":1426103837,"content":"Yes, we can forget it, we'll never run it when whonix-setup-wizard is installed."},{"author":"Patrick","date_created":1426109765,"date_modified":1426109765,"content":"Done:\nhttps://github.com/Whonix/anon-meta-packages/commit/2e4738e0062202f95427761233fefe4c761d7f76"}]},"PHID-TASK-2yr6jh5qvjed6xk7qrtu":{"id":"227","title":"control-port-filter-python should rotate logs using logrotate","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1425840409,"date_modified":1425840409,"content":"Done:\nhttps://github.com/Whonix/control-port-filter-python/commit/0317ed71742916c2fe8a6b0b86f862fe429bff98"}]},"PHID-TASK-knzm27ud2ix6islkz5rk":{"id":"226","title":"make limit to 5 simultaneous connections configureable to any amount","status":"resolved","priority":"Normal","author":"Patrick","description":"Looks easy, no? I can handle this if you wish, @troubadour. I don't mind who is doing it.","comments":[{"author":"troubadour","date_created":1425842921,"date_modified":1425842921,"content":"Please do it, since you'll write the bash side..."},{"author":"Patrick","date_created":1425843583,"date_modified":1425843583,"content":"It's the python side `spawn=5` is currently hardcoded. Could be made configurable using the usual /etc config read mechanism. Nevermind. Can do."},{"author":"troubadour","date_created":1426103629,"date_modified":1426103629,"content":"Done.\nhttps://github.com/troubadoour/control-port-filter-python/commit/ecced265b9f4f8cf065dfdb6013989c29b63858e"},{"author":"Patrick","date_created":1426107864,"date_modified":1426107864,"content":"Great!\n\nMinor:\n\n* new line at the end missing in the config file.\n* Variable name in config file is `CONCURRENT_CONNECTIONS_LIMIT`. The others were always prefixed `CONTROL_PORT_FILTER_`. Do you think this could become an issue?"},{"author":"troubadour","date_created":1426194196,"date_modified":1426194196,"content":"It should not become an issue, but for the sake of consistency, I modified it.\nhttps://github.com/troubadoour/control-port-filter-python/commit/8b3e361559887e5f8b89805ffd83a5b9fd79f6eb"},{"author":"Patrick","date_created":1426206125,"date_modified":1426206125,"content":"Looks good."}]},"PHID-TASK-zqgthoknptvjzuccjldc":{"id":"225","title":"inform Tails developers about the existence of control-port-filter-python","status":"resolved","priority":"Normal","author":"Patrick","description":"Since we forked tor-controlport-filter by Tails, it might be useful to inform them about the fork. I don't think they'll switch to it anytime soon. But perhaps when they need its awesome new features. My experience tells me that they'll likely, as time permits, will have a cursory look and comment on security and whatnot.\n\nWould you like to be the messenger of the good news or prefer if I did this, @troubadour? I wouldn't really mind doing it, I am discussing on their mailinglist various stuff some time now anyhow.\n\nWant you/me to formulate a draft first?","comments":[{"author":"troubadour","date_created":1425835952,"date_modified":1425835952,"content":"I'd prefer if you brought the news to Tails. You are probably more accustomed to their language, and I'm still feeling a little shy. That would be great if they were interested in the development of their original script, and above all, if they could come back with comments on security, or whatnot. :) \n\nAre there any digests of the numerous Tails mailing lists, like https://lists.torproject.org/pipermail/tor-talk or https://lists.torproject.org/pipermail/tor-dev? My mail is already crowded with some other lists."},{"author":"Patrick","date_created":1425837752,"date_modified":1425837752,"content":"Okay. I'll work on a draft.\n\n-----\n\nI don't know any useful digests of mailing lists I could work with. The most useful thing could be some (third party) web interface that just shows subjects. Here is tails-dev sorted by subject:\nhttps://mailman.boum.org/pipermail/tails-dev/2015-March/subject.html\n\nYou could just look into those subjects that are of interest to you. There might be third party mailing list archives that you like better usability wise. And I recommend a separate e-mail account for medium and high volume mailing lists. Additionally I configured my mail client to sort those mails into folders separated by mailing list. I guess it's impossible to read [not even speaking about grasping] everything on tor-talk and still doing development. It's just too high traffic.\n\nIt would be useful if you were registered on the tails-dev mailing list with such a secondary e-mail account. Then you could make a reply if required without \"breaking the thread\" [in reference to header]."},{"author":"Patrick","date_created":1425840125,"date_modified":1425840164,"content":"Here is the draft.\n\n```\nDear Tails developers,\n\nI would like to inform you about the existence of control-port-filter-python, a fork of tor-controlport-filter by Tails.\n\nImprovements:\n\n* Supports parallel connections.\n* Configurable by dropping .d-style configuration snippets into /etc/cpfpy.d. I.e. whitelist can be extended by dropping snippets.\n* Supports logging.\n* Support to answer 'getinfo net/listeners/socks' with the lie '250-net/listeners/socks=\"127.0.0.1:9150\"'.\n* Honors signals sigterm, sigint.\n* Complete sysvinit script.\n* Lintian clean /debian packaging folder.\n\nCode:\nhttps://github.com/Whonix/control-port-filter-python\n\nMain script:\nhttps://github.com/Whonix/control-port-filter-python/blob/master/usr/lib/control-port-filter-python/cpfp.py\n\nWiki page:\nhttps://www.whonix.org/wiki/Dev/Control_Port_Filter_Proxy\n\nIt has been mostly written by troubadoour with some reviewing and testing by me.\n\nWe would like to hear your feedback, comments, etc.\n\nA comparison of the three Tor ControlPort filters that exist so far can be found here:\nhttps://www.whonix.org/wiki/Dev/Control_Port_Filter_Proxy#Comparison_of_Control_Port_Filters\n\nThank you for writing tor-controlport-filter!\n\nCheers,\nPatrick\n```\nAny changes you recommend or should I go ahead posting it?"},{"author":"troubadour","date_created":1425842746,"date_modified":1425842746,"content":"Thanks for the tails-dev link, that's what I was looking for (the archive, not a digest, wrong wording).   \n\nPlease go ahead posting. It's more comprehensive than whatever I would have written."},{"author":"Patrick","date_created":1425908175,"date_modified":1425908175,"content":"Done:\n`[Tails-dev] Announcing control-port-filter-python - a fork of tor-controlport-filter by Tails`\nhttps://mailman.boum.org/pipermail/tails-dev/2015-March/008388.html"}]},"PHID-TASK-aaiaxkg7hsvaykeu6njp":{"id":"224","title":"update Control Port Filter Proxy design documentation","status":"resolved","priority":"Normal","author":"Patrick","description":"https://www.whonix.org/wiki/Dev/Control_Port_Filter_Proxy#Comparison_of_Control_Port_Filters needs to list differences between Tails' control port filter vs https://github.com/Whonix/control-port-filter-python.","comments":[{"author":"Patrick","date_created":1425833106,"date_modified":1425833106,"content":"Done:\nhttps://www.whonix.org/wiki/Dev/Control_Port_Filter_Proxy#Comparison_of_Control_Port_Filters\n\nIf something is missing/etc., please just hit the edit button and/or reopen and/or ... :)"}]},"PHID-TASK-prvlisjb6zh7hemv5tee":{"id":"223","title":"cpfp.py polishing","status":"resolved","priority":"Normal","author":"troubadour","description":"A bunch of commits in control-port-filter-python, mostly cleaning up and comments.\n\nTwo commits for corrections to some of the errors reported by `pylint` and `pep8`.\n\n`pylint` global evalution is 9.79/10, with the following errors disabled.\n\nFile pylint.rc\n```[MESSAGES CONTROL]\n# C0103: Invalid name \n# (cpfp parameters are UPPERCASE -> inconsitency with variable names)\n# C0111: Missing docstring (to be added)\n# C0301: Line too long\n# E1101: %s %r has no %r member \n# (gevent.socket has no 'AF_UNIX', 'SOCK_STREAM' members, according to pylint)\n# E1103: %s %r has no %r member (but some types could not be inferred)\n# (socket fileobject has no 'readline', 'write', 'flush' members, according to pylint)\n# (from doc) False positives: This message may report object members that are created dynamically, but exist at the time they are accessed.\ndisable=C0103,C0111,C0301,E1101, E1103```\nTo test:\n```pylint --rcfile /pathto/pylint.rc /usr/lib/control-port-filter-python/cpfp.py```\n`pep8` reports a few `line too long`.","comments":[{"author":"Patrick","date_created":1425831949,"date_modified":1425831949,"content":"Looks all good. Merged."}]},"PHID-TASK-dt5kpzrojzfhojtkmafv":{"id":"222","title":"control-port-filter-python improved debug output","status":"resolved","priority":"Normal","author":"Patrick","description":"To help with T218, I thought it would help to have improved debug/log output.\n\nTo avoid merge conflicts, I didn't know if you are doing any bigger changes at this moment, I have created a branch instead of committing to master:\nhttps://github.com/adrelanos/control-port-filter-python/tree/debugging\n\nJust one commit for now:\nhttps://github.com/adrelanos/control-port-filter-python/commit/4fd944156a3c7690449b14b805af0c8869ded71f\n\nIt would have been difficult to translate those all into speech / tickets. Code talks more.\n\n* Moved the logging commands around. Wanted to make sure we learn as early as possible about connection contents and and what is being replied in all cases.\n* Log lying instead of just doing it.\n* minor: removed extraneous ` ` for more consistent logs\n* minor: comment\n* T221\n\nPlease merge this branch, and if there are merge conflicts or mistakes, please just manually (re-) implement if applicable.","comments":[{"author":"Patrick","date_created":1425662733,"date_modified":1425662733,"content":"@troubadour merged this:\nhttps://github.com/Whonix/control-port-filter-python/commit/4fd944156a3c7690449b14b805af0c8869ded71f\n\nTherefore implemented. Closing."}]},"PHID-TASK-ct3r7yyp3pcdy6ox3o3f":{"id":"221","title":"control-port-filter-python should exit non-zero if setting up listener fails","status":"resolved","priority":"Normal","author":"Patrick","description":"When it's already running as okay... And you run...\n\n```\nsudo -u debian-tor /usr/lib/control-port-filter-python/cpfp.py\n```\n\nThen it fails to start up (as per log) and exits 0. This is a bug.\n\nCurrent:\n\n```\n  except IOError as e:\n    logger.critical('Server error %s' % (e))\n```\n\nProposed:\n```\n  except IOError as e:\n    logger.critical('Server error %s' % (e))\n    logger.critical('Exiting.')\n    sys.exit(1)\n```\n\nThat would be more correct, have helped what I reported in T218 a bit, help sysvinit / systemd.","comments":[{"author":"Patrick","date_created":1425668616,"date_modified":1425668616,"content":"Done:\nhttps://github.com/Whonix/control-port-filter-python/commit/4fd944156a3c7690449b14b805af0c8869ded71f\n"}]},"PHID-TASK-7fvyma6k4itatdctyryz":{"id":"220","title":"remove CONTROL_PORT_FILTER_PROXY from control-port-filter-python config file","status":"resolved","priority":"Normal","author":"Patrick","description":"From config file...\n\n```\n##############################\n## CONTROL_PORT_FILTER_PROXY #\n##############################\n## Enable or disable.\n## 0 disabled.\n## This setting can not disable the filter function,\n## it only prevents starting Control Port Filter Proxy.\nCONTROL_PORT_FILTER_PROXY=1\n```\n\nIt unnecessary. Not implemented. Not needed anymore as far as I can see. (Those who don't want to use it can uninstall it or disable the daemon in sysvinit or in future in systemd.)\n\nCan be removed. What do you think, @troubadour?","comments":[{"author":"Patrick","date_created":1425587535,"date_modified":1425587535,"content":"Same for ...\n\n```\n################################\n## CONTROL_PORT_FILTER_VERBOSE #\n################################\n## Enable or disable.\n## 0 disabled.\n## Very verbose logging.\nCONTROL_PORT_FILTER_VERBOSE=0\n```\n\n?"},{"author":"troubadour","date_created":1425588225,"date_modified":1425588225,"content":"Yes. Was wondering about `CONTROL_PORT_FILTER_PROXY` since it's not used in either script. Will remove them. "},{"author":"Patrick","date_created":1425588757,"date_modified":1425588757,"content":"Okay, please merge my minor fixes first so we avoid merge conflicts:\nhttps://www.whonix.org/forum/index.php/topic,560.msg7226.html#msg7226\n"},{"author":"troubadour","date_created":1425591853,"date_modified":1425591853,"content":"Done. Have merged your fixes beforehand."},{"author":"Patrick","date_created":1425593139,"date_modified":1425593139,"content":"Merged. Looks good."}]},"PHID-TASK-jdmg4sm7lg6327t3vn3w":{"id":"219","title":"control-port-filter-python case sensitive issue","status":"resolved","priority":"Normal","author":"Patrick","description":"Noticed this while testing for T218.\n\nFunctional:\n\n```\nSIGNAL NEWNYM\n```\n\nGets filtered:\n\n```\nsignal newnym\n```\n\nIt should be totally case insensitive. (Tor itself accepts either combination of upper and lower case.)","comments":[{"author":"troubadour","date_created":1425588423,"date_modified":1425588423,"content":"Yes, a missing bit. Have seen `authenticate` too. Will make it case insensitive."},{"author":"troubadour","date_created":1425591934,"date_modified":1425591934,"content":"Done. \nhttps://github.com/troubadoour/control-port-filter-python/commit/d2d3b95e305a902ef79d170c1b5d1f97449f5f19"},{"author":"Patrick","date_created":1425593195,"date_modified":1425593195,"content":"Tested. Works fine. Merged.\n\n!close"}]},"PHID-TASK-mxgnsazk223dgxft7yco":{"id":"218","title":"cpfp.py hangs on Tor Browser 4.5a[3-4] new requests","status":"resolved","priority":"Normal","author":"troubadour","description":"When using cpfp-python in place of cpfp-bash, after filtering the three requests (`authenticate \"password\"`, `setevents stream`, `getinfo config-text`), cpfp.py stops passing subsequent requests, including `SIGNAL NEWNYM`, as long as Tor Browser is running.\n\nThe same happens when `CONTROL_PORT_FILTER_DISABLE_FILTERING` is set to true.\n\nAlready tried a lot on that problem. @Patrick Could you try to reproduce the bug? I'd like to make sure it's not a specific issue on my side","comments":[{"author":"Patrick","date_created":1425585802,"date_modified":1425585802,"content":"Will look into it soon."},{"author":"Patrick","date_created":1425588582,"date_modified":1425588582,"content":"Looks like you are working on cool stuff. :)\n\n-----\n\nYes, there is some bug going on here.\n\n-----\n\nDeveloper toolbox:\n\nNormal start command.\n\n```\nsudo bash -x /etc/init.d/control-port-filter-python start\n```\n\nStop command.\n\n```\nsudo bash -x /etc/init.d/control-port-filter-python stop\n```\n\nIf the stop command goes fast, almost instantly, then the process could be killed using sigterm. If it takes \"long\" (~5 seconds), then cpfpy did not respond to sigterm, and the process is killed using sigkill. The latter is bad. On new startup attempts, you might see in the log.\n\n```\nCRITICAL:19927:Server error [Errno 98] Address already in use\n```\n\nTo find any eventual leftovers, stale processes, try this.\n\n```\nps aux | grep cpf\n```\n\nor\n\n```\nps aux | grep python\n```\n\nSometimes I was not able to start a new instance even if ps aux didn't show an old error. Same address already in use error. That baffles me.\n\n-----\n\nWill post more soon."},{"author":"Patrick","date_created":1425590789,"date_modified":1425590789,"content":"More stuff the the dev toolbox:\n\nOn the gateway, talk to cpfpy directly.\n\n```\nnc 10.152.152.10 9052\n```\n\nTo check if the port is free, if cpfpy really has shut down.\n\n```\nsudo lsof -i :9052\n```\n\n```\nCOMMAND   PID       USER   FD   TYPE DEVICE SIZE/OFF NODE NAME\ncpfp.py 27653 debian-tor    4u  IPv4  73153      0t0  TCP 10.152.152.10:9052 (LISTEN)\n```\n\n-----\n\nIssue:\n\nThe sigterm trap doesn't really work.\n\n```\nkill -sigterm 24140\n```\n\nExample from log that I've just seen:\n\n```\nINFO:24140:Configuration read from \"/etc/cpfpy.d/30_controlportfilt_default\"\nINFO:24140:Configuration read from \"/etc/cpfpy.d/50_user\"\nINFO:24140:Trying to start Tor control port filter on IP 10.152.152.10 port 9052\nINFO:24140:Tor control port filter started, listening on IP 10.152.152.10 port 9052\nINFO:24140:Request: SIGNAL NEWNYM\nINFO:24140:Answer : 250 OK\nINFO:24140:Request: xxx\nINFO:24140:Answer : 510 Unrecognized command \"xxx\"\nINFO:24140:Signal sigterm received. Exiting.\nINFO:24140:Request: GETINFO status/bootstrap-phase\nINFO:24140:Answer : 250-status/bootstrap-phase=NOTICE BOOTSTRAP PROGRESS=100 TAG=done SUMMARY=\"Done\"\n```\n\nIt says exiting, but then doesn't really exit. It does on the the requests, and then when you send another sigterm, then it actually does exit. Could all be somewhat related to this bug. Perhaps the first sigterm only closes the current still open connection? And the next sigterm really shuts it down?\n\n-----\n\nI couldn't reproduce the original bug you reported here. Perhaps what I have reported is still somewhat connected. I don't think it's Tor Browser specific. Perhaps try to connect to it using `nc` twice using two Konsole tabs."},{"author":"troubadour","date_created":1425593809,"date_modified":1425593809,"content":"I believe what you report is connected, and it's not Tor specific because ther is no issue with cpfp-bash. \n\nBefore I go deeper following your tests: \nWhen saying cpfp.py hangs, it's not true. The process is stil running, but not accepting any request. (to monitor it, in another terminal I use htop  -> `F4` (Filter) -> `cpf`).\n\nWhen running \n```sudo service control-port-filter restart```\nthe process stops but does not restart, because of\n ```CRITICAL:12387:Server error [Errno 98] Address already in use```\nIt takes ~1 minute waiting (trying to restart it or not) and it starts again. \n\nSo far, the whole thing baffles me too. Have replaced the TCP server by a socket in a `while True` loop, like in the Tails original script, to no avail. "},{"author":"Patrick","date_created":1425594294,"date_modified":1425594294,"content":"Now I am sure of it. You cannot have two connections of `nc` (or anything) talking to cpfpy at the same time. I think this is one of the two original limitations. [1)Only one connection at a time; 2) connections to source aren't help open until other side closes them, not listening to what Tor continues to output, therefore subscribing to events unsupported] [Tails is also affected by those, I think.]\n\nT221 is super simple and will help us debugging this a bit. (Because then 'sudo service control-port-filter-python start/restart' will tell us if that actually failed.)"},{"author":"Patrick","date_created":1425597191,"date_modified":1425597191,"content":"I thought python would clean up after us. I thought after exiting the script, all listens would be automatically closed. That might not be the case? Did some searching... Perhaps we have to cleanly shut down the server using python code before we exit? (That would be a bit cleaner anyhow.)\n\nJust saw, there is a comment `# Accept parallel connections.`. Doesn't seem to actually work anymore.\n\nThe problem of this thread seems to be, that Tor Browser is keeping the connection open and that multiple connections are broken at the moment. Maybe Tor Browser is using multiple connections. Wouldn't wonder about that."},{"author":"troubadour","date_created":1425661064,"date_modified":1425661064,"content":">The problem of this thread seems to be, that Tor Browser is keeping the connection open and that multiple connections are broken at the moment. Maybe Tor Browser is using multiple connections. Wouldn't wonder about that.\nThat's what seems to happen, Tor Browser keeping the connection(s) open.\n\nI thought that using a TCP server instead of a socket would solve the concurrent connections issue. It does not and  the comment in the script is false.\n\nThe obvious path was to try threading the process, with all the alledged performance and error penalties. Fortunately, there is a neat solution: **gevent** [gives you threads, but without using threads](http://blog.pythonisito.com/2012/07/introduction-to-gevent.html).\n\nIn the following commit, cpfp.py handles simultaneous connections. Tested with nc, telnet, whonixcheck and Tor Browser (open/close, new identity) at the same time. The number of concurrent connections is limited to 5, modifiable in\n```server = StreamServer((IP, PORT), handle, spawn=5)```\n\nhttps://github.com/troubadoour/control-port-filter-python/commit/9447486676f8720e444b330b28dbf2e40d3e5362\n\nWe are left with the way python handles the clean up after receiving the terminate signal. At the moment, with \n```sudo service control-port-filter stop```\nor \n```sudo bash -x /etc/init.d/control-port-filter start```\nthe process really stops (it takes ~2 seconds), but nothing is logged. Looking into it.\nThe latter is looking for `cpf-tcpserver` (`pgrep`) but that should not be an issue.\n"},{"author":"Patrick","date_created":1425662118,"date_modified":1425662118,"content":"Will test now.\n\n> /etc/init.d/control-port-filter\n\nPlease don't use that anymore. I recommend:\n```\nsudo update-rc.d control-port-filter remove\n```\nAnd.\n```\nsudo rm /etc/init.d/control-port-filter\n```\n\n/etc/init.d/control-port-filter-python and/or control-port-filter-python instead please.\n"},{"author":"Patrick","date_created":1425662666,"date_modified":1425662666,"content":"Tested. Merged. Works for me."},{"author":"troubadour","date_created":1425675509,"date_modified":1425675509,"content":"> /etc/init.d/control-port-filter-python and/or control-port-filter-python instead please.\nYes, done. Removed control-port-filter and installed control-port-filter-python. Had to modify `whonixcheck/check_control_port_filter` with `/var/run/control-port-filter-python/pid`.\n\ncpfp.py exits and restarts normally (no 2 seconds delay), stopping the server and logging the signal.\nhttps://github.com/troubadoour/control-port-filter-python/commit/ef69916111a4c24780623b0dd6be42c2f88796da"},{"author":"Patrick","date_created":1425682247,"date_modified":1425682247,"content":"I can only keep repeating myself. :)\nTested. Merged. Works for me."},{"author":"Patrick","date_created":1425682316,"date_modified":1425682316,"content":"(Latest whonixcheck is already adjusted for control-port-filter-python by the way in https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_control_port_filter)"}]},"PHID-TASK-2tzdnjmls5ayggelm67x":{"id":"217","title":"genmkfile: turn generic makefile into a build dependency to reduce code duplication","status":"resolved","priority":"Normal","author":"Patrick","description":"__Introduction__:\n\nHaving the same `Makefile` and `make-helper.bsh` in every package is less than ideal.\n\n* It's a giant code duplication (although [packaging-helper-script](https://github.com/Whonix/whonix-developer-meta-files/blob/master/debug-steps/packaging-helper-script)'s function `pkg_packaging_files_diff` helps to check if they all match).\n* Cumbersome to update.\n* Requires package version bump just because makefile generic was updated even if that update is not required for that package.\n\nInstead a genmkfile package that ships a file `/usr/bin/genmkfile` could be installed. Instead of `make deb-pkg` etc., we could then type `genmkfile deb-pkg`.\n\n-----\n\n__Advantages__:\n\n* much less code duplication\n* when grepping the code, fewer results are shown\n* easier to update generic make files\n* in most cases (unrelated generic make file updates), packages would stay the same, would still have an identical hash\n* much less packages have to be updated when updating makefile generic\n\n-----\n\n__Disadvantages__:\n\n* new package to be created\n* packages would be no longer \"standalone\" (they are not anyhow, a lot other build dependencies required to create Debian packages)\n* new build dependency that we would either, and/or:\n** require builders to install before building,\n** ~~or requiring builders to at least adding `genmkfile` to `PATH`,~~ [1]\n** ~~or by typing for example `/path/to/somewhere/genmkfile deb-pkg` instead of `make deb-pkg`~~ [1]\n\n------\n\n__Why should always all generic makefile be updated?__\n\nOtherwise it would be hard to audit ~100 slightly different generic makefiles for non-maliciousness. Since they all match, the following can be used to automate auditing them.\n\n```\n./debug-steps/packaging-helper-scrip pkg_packaging_files_diff\n```\n\n(Or perhaps others are using other custom scripts for such tasks.)\n\n-----\n\n__Related__:\nhttps://wiki.debian.org/UpstreamGuide\n\n-----\n\nDebian's UpstreamGuide (a pre-condition to get stuff merged into Debian) wants:\n\n* Out-of-Tree Builds\n\n-----\n\nMaybe it's not all that simple.\n\n* Major: Debian build tools expect common make targets such as `make install` and `make clean`. By having a `/usr/bin/genmkfile` most likely changes to `debian/rules` would be required.\n* Minor: having a `Makefile` around enables `make`'s / bash's competition feature. If we were to expect a `genmkfile` package by default, we could also ship a bash complementation snippet.\n\n-----\n\nBrainstorming welcome!\n\n-----\n\n[1] Not possible, otherwise would be an \"optional build dependency\", which would be strange. Either we will be using `Build-Depends: genmkfile` or not. Making it optional is not possible in any clean way.","comments":[{"author":"Patrick","date_created":1425688465,"date_modified":1425688465,"content":"Since \"update generic makefiles\" is on my TODO list, I am wondering if I should solve this one once and for all for Whonix 10.\n\n-----\n\n@nrgaway generally speaking - do you have any opinion on this ticket?"},{"author":"Patrick","date_created":1427909098,"date_modified":1427909098,"content":"Made significant progress. Created a new package genmkfile:\nhttps://github.com/Whonix/genmkfile\n\n90% or how much of Make for packaging scripts can be abstracted in that package.\n\nIt will become a build dependency for most of Whonix's packages will depend on. It will need to be build and installed on the build system before building the other packages. (Will be automated by the build script.)\n\nIndividual packages (such a whonix-setup-wizard etc. etc.) will then only need to ship a minimal [Makefile](https://github.com/Whonix/genmkfile/blob/master/usr/share/genmkfile/Makefile) as their `./Makefile`.\n\n```\n#!/usr/bin/make -f\n\n## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\n## genmkfile - Makefile - version 1.5\n\n## This is a copy.\n## master location:\n## https://github.com/Whonix/genmkfile/blob/master/usr/share/genmkfile/Makefile\n\nGENMKFILE_PATH ?= /usr/share/genmkfile\nGENMKFILE_ROOT_DIR := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))\n\nexport GENMKFILE_PATH\nexport GENMKFILE_ROOT_DIR\n\ninclude $(GENMKFILE_PATH)/makefile-full\n```\n\nThat will be the only - probably unavoidable - code duplication. Hopefully, there will be little need to update that minimal Makefile ever again.\n\nThe [full Makefile](https://github.com/Whonix/genmkfile/blob/master/usr/share/genmkfile/Makefile) will be included by that specific packages (ex: whonix-setup-wizard) `./Makefile` from `/usr/share/genmkfile/Makefile`. [make-helper.bsh](https://github.com/Whonix/genmkfile/blob/master/usr/share/genmkfile/make-helper.bsh) will only be in `/usr/share/genmkfile/make-helper.bsh`. Should the full Makefile or make-helper.bsh be updated, there will hopefully be no need to update specific packages `./Makefile`s.\n\nMost likely ready for #Whonix_10."},{"author":"Patrick","date_created":1427998270,"date_modified":1427998270,"content":"Updated all packages. Example:\n* https://github.com/Whonix/whonix-setup-wizard/commit/a34acdfb0e34aba11e8e928f65753c9d975e5c03\n* https://github.com/Whonix/whonix-setup-wizard/commit/b6aa9cc4d7206efbb773369264f19ed3e5f7231d\n\nTODO:\n* adding the build dependency genmkfile to all packages\n* modifying the build script to automate build and installation fo genmkfile"},{"author":"Patrick","date_created":1428000506,"date_modified":1428000506,"content":">>! In T217#3433, @Patrick wrote:\n> TODO:\n> * adding the build dependency genmkfile to all packages\n\nDone."},{"author":"Patrick","date_created":1428001151,"date_modified":1428001151,"content":">>! In T217#3433, @Patrick wrote:\n> TODO:\n> * modifying the build script to automate build and installation fo genmkfile\n\nDone:\nhttps://github.com/Whonix/Whonix/commit/0a05087557d466a3ca0deba5ca4d4dc3165ca7fd"}]},"PHID-TASK-vo43vy4ohepzkarkywxo":{"id":"216","title":"start using /usr/lib/msgcollector/br_add\n","status":"resolved","priority":"Needs Triage","author":"Patrick","description":"Follow up task of T97.","comments":[{"author":"Patrick","date_created":1425571722,"date_modified":1425571722,"content":"Done:\n\n* https://github.com/Whonix/whonixcheck/commit/e747056589288abcf7c019a9ff8f814428452b36\n* https://github.com/Whonix/tb-updater/commit/243b60da10afe506e34b16a801680209d2e52194\n\nWhen others cases are found, those can be easily added as well."}]},"PHID-TASK-4g7ig6t7bohmq2k5cw5p":{"id":"215","title":"install electrum bitcoin thin client by default?","status":"open","priority":"Normal","author":"Patrick","description":"package, only available from `stretch-backports`, however that version may be outdated, dysfunctional:\n\n* https://packages.debian.org/stretch-backports/electrum\n* https://packages.debian.org/buster/electrum\n\nNot as simple as just installing the package.\n\nTails design documentation:\nhttps://tails.boum.org/contribute/design/#index55h3\n\nTails config:\nhttps://git-tails.immerda.ch/tails/tree/config/chroot_local-includes/etc/skel/.electrum\n\nTails user documentation:\nhttps://tails.boum.org/doc/anonymous_internet/electrum/index.en.html\n\nExisting Whonix documentation about `electrum`:\nhttps://www.whonix.org/wiki/Electrum\n\nElectrum Bitcoin Wallet in Whonix ™ Development Notes:\nhttps://www.whonix.org/wiki/Dev/electrum\n\nCriteria for installing applications by default in Whonix:\nhttps://www.whonix.org/wiki/Dev/Default_Application_Policy\n\nPolicy for Inclusion of Compiled Software:\nhttps://forums.whonix.org/t/policy-for-inclusion-of-compiled-software/6635","comments":[{"author":"troubadour","date_created":1425584107,"date_modified":1425584107,"content":"Yes."},{"author":"HulaHoop","date_created":1426215275,"date_modified":1426215275,"content":"To counteract the Bitcoin ddos problem discussed in \"Bitcoin over Tor\n is not a good idea\" until its fixed at the blockchain level, its proposed to configure Electrum to use a pool of trusted hidden services:\n https://mailman.boum.org/pipermail/tails-dev/2015-March/008302.html\n\nFrom the thread I saw they collected about 5:\n\nelectrumupzx5w5f.onion kngqe2mrt4wnpxtt.onion k33y7ns2ma65xgtr.onion\n\nhttps://mailman.boum.org/pipermail/tails-dev/2015-March/008381.html\n(s7r Thomas White)\n\nsbow7bnje2f4gcvt.onion:50001\n\n56ckl5obj37gypcu.onion\n"},{"author":"HulaHoop","date_created":1426780712,"date_modified":1426780712,"content":"http://www.deepdotweb.com/jolly-rogers-security-guide-for-beginners/bitcoin-clients-tails-blockchain-electrum/\n\nThis article goes thru the commands to connect electrum via onion services. \n\nA script can possibly accomplish the same thing."},{"author":"WhonixQubes","date_created":1426846801,"date_modified":1426846801,"content":"As a general point... I think Whonix + Bitcoin (cryptocurrency) is a good position to acquire in more people's minds for attracting more Whonix success."},{"author":"Patrick","date_created":1426849700,"date_modified":1426849700,"content":"Generally, it's nice to have. Sure. But... Not as simple as just installing the package. Many related issues:\n\n* those are quite well documented in [Tails' electrum documentation](https://tails.boum.org/doc/anonymous_internet/electrum/index.en.html)\n> ** Bitcoin is not anonymous.\n> ** Do not blindly trust the bitcoin balance that Electrum displays.\n\nUnfortunately. Seems like this would require a package just for configuring electrum so it's save by default. A startup wrapper script would be relatively simple. Tails uses a more extensive [config](https://git-tails.immerda.ch/tails/tree/config/chroot_local-includes/etc/skel/.electrum/config) with more settings than just a different server. We'd have to research if we would need the same settings or if we can wretch these settings into a startup wrapper script. Since electrum apparently has no [.d Style Configuration Folder](https://www.whonix.org/wiki/Whonix_Configuration_Files#.d_style_configuration_folders), writing into the user's homedir `~/.electrum` comes with the usual issues, such as \"what if that file needs to be updated later\" (then there can be conflicts with what we set in past, various settings changes by user/program and then trying to change settings there again with a script is fragile). So I think the startup wrapper script - if it is possible - would be a much more robust solution.\n\nEven when using trusted server[s], users are at mercy of a server. Servers occasionally go down [forever] and are hacked. Having it installed by default, and having users skip reading the user documentation could lead to cases, where they thought, they have received money, where in reality the server had put them on a fake network. This is in my opinion a pretty severe security issue where one could loose a lot money.\n\nInstalling applications by default encourages using them? Somewhat implies, that it's a recommended application, no? If that happens and someone were to ask \"Why did you encourage use of electrum by installing it by default?\", I would not have a good answer.\n\nWhat seems responsible to me would be a dismissable (\"[ ] understood, do not show again\" popup) that will be shown before starting electrum that explains the major issues and links to documentation.\n\nTails has more reasons to install applications by default than Whonix. ([Recently discussed here.](https://www.whonix.org/forum/index.php/topic,1003.0.html))\n\nHaving all that said, I am wondering if it wouldn't be better to not install it by default and to just polish [Whonix's documentation about money](https://www.whonix.org/wiki/Money).\n\nWhat do you think?"},{"author":"HulaHoop","date_created":1426868922,"date_modified":1426868922,"content":"What is Whonix if not a platform to nake it easy and safe to anonymize internet activity?\n\nWe should aim to include defaults when they make sense. For example if they software is easy to use and carries out a useful function.\n\nThe way Electrum works doesn't allow a malicious server to abscond with the money. That was never possible. What we are protecting against is a communication chokepoint with the rest of the bitcoin network ie. a malicious exit that can block financial data syncing which can give a fake view of transactions. By relying on a trusted pool  of onions (and not a single server) we make this possibility much less likely. And soon its going to be fixed anyway.\n\nHow you want to approach this is up to you. I prefer sticking with TAILS' work because it covers more configuration if it takes less work also because there are more people keeping track of Electrum there. How it gets around the absence of .d is something to consider. If the Tails script can be made into a startup wrapper then its best?"},{"author":"Patrick","date_created":1426870377,"date_modified":1426870377,"content":">>! In T215#3221, @HulaHoop wrote:\n> The way Electrum works doesn't allow a malicious server to abscond with the money. That was never possible. What we are protecting against is a communication chokepoint with the rest of the bitcoin network ie. a malicious exit that can block financial data syncing which can give a fake view of transactions.\n\nAnd this fake view could lead to do stuff, such as shipping goods, which you would not have done if you had the real view. A pretty severe issue.\n\n> By relying on a trusted pool  of onions (and not a single server) we make this possibility much less likely.\n\nDoes electrum auto cylce servers?\n\n> And soon its going to be fixed anyway.\n\nUntil that fix lands in Debian, it could take until Debian stretch.\n\n> How you want to approach this is up to you. I prefer sticking with TAILS' work because it covers more configuration if it takes less work also because there are more people keeping track of Electrum there.\n\nSure, if Tails' solution is secure, robust and applicable to Whonix, it's best to copy it rather than reinvent.\n\n> How it gets around the absence of .d is something to consider.\n\nTODO: #research. Tails' solution's are not always as easily applicable, because it's an amnesic distribution with limited persistence. It could mixture of \"no issue with upgrading, because we're amnesic [no apt-get upgrades for major versions, therefore no config file issues]\" + \"if you are using persistence you are on your own\". Or perhaps they haven't through this through. That's why it's TODO: #research."},{"author":"HulaHoop","date_created":1426898464,"date_modified":1426898464,"content":"> Does electrum auto cylce servers?\n\nYes. The TAILS electrum.conf enables auto cycling.\n\nI did some more research and re read the mailing list thread and here is what I learned.\n\nThe trusted onion services I listed are also running as Bitcoin only traffic exits, eliminating bad exits as a possibility. \n\nElectrum connects to multiple servers simultaneously rather than trusting only one.\n\n***\n\nLooks to me the TAILS file us very relevant to reuse but we need to change the settings from localhost to gw and also the port number for streaming isolation."},{"author":"Patrick","date_created":1458554502,"date_modified":1458554502,"content":"At the moment the electrum version from Debian stable (currently: jessie) is too old to even work. The one from jessie-backports should still work?\n\nBtw there is currently an unreviewed documentation edit that adds electrum to the money wiki page that needs more work:\nhttps://www.whonix.org/w/index.php?title=Money&diff=cur&oldid=22500\n"},{"author":"HulaHoop","date_created":1458618704,"date_modified":1458618704,"content":"Major clean up done."},{"author":"Patrick","date_created":1565344200,"date_modified":1565344200,"content":"install electrum appimage by default:\nhttps://github.com/Whonix/anon-meta-packages/commit/71d40f5316ee7eb38eb04142d80d23c56a48407b\n\nelectrum appimage is shipped by this package:\nhttps://github.com/Whonix/binaries-freedom\n\nAs per:\nhttps://forums.whonix.org/t/policy-for-inclusion-of-compiled-software/6635"}]},"PHID-TASK-aeap6dr5mso7jdzy3uym":{"id":"214","title":"tb-updater's download confirmation screen multiple version numbers usability","status":"resolved","priority":"Normal","author":"Patrick","description":"This is how tb-updater's download confirmation screen currently looks like:\n\n{F45}\n\n-----\n\nI think it needs an additional comment or something. Otherwise users are likely to choose the highest version number without knowing that this is neither recommended nor required.\n\nWhat about this...?\n\n> Only versions still considered secure should be listed here. Higher version numbers does not necessarily mean more secure here. Could be alpha or beta versions. In most cases you are best off choosing the lowest version number among them.\n\n-----\n\nAs per Tor Browser version [tor-browser-spec](https://gitweb.torproject.org/tor-browser-spec.git/tree/processes/VersionNumbers):\n\n* `a` stands for `alpha`\n* `b` stands for `beta`\n\n-----\n\nRelated documentation:\nhttps://www.whonix.org/wiki/Tor_Browser#Download_Confirmation_Screen","comments":[{"author":"Patrick","date_created":1427045850,"date_modified":1427045850,"content":"Done. Since no one had any better suggestions, went with my best guess, the one from above. Commit:\nhttps://github.com/Whonix/tb-updater/commit/bfd6fac5909b3f637a7cf42b3ec1fe8fd408a413\n"}]},"PHID-TASK-5prabbbjcczft5e2aitv":{"id":"213","title":"KVM is longer maintained, whonixcheck should not recommend against it therefore","status":"resolved","priority":"Normal","author":"Patrick","description":"~~KVM is no longer maintained:~~\n~~https://www.whonix.org/forum/index.php/topic,982 ~~\n\n~~So it should be recommended against in whonxicheck.~~","comments":[{"author":"Patrick","date_created":1425598103,"date_modified":1425598103,"content":"Done:\nhttps://github.com/Whonix/whonixcheck/commit/b0bdb4a44b6f8ada93d3b586143e68bcef4ece13"},{"author":"Patrick","date_created":1426011483,"date_modified":1426011483,"content":"HulaHoop is back. (https://www.whonix.org/forum/index.php/topic,982.msg7272.html#msg7272)\n\nTherefore need to undo this."},{"author":"Patrick","date_created":1426011661,"date_modified":1426011661,"content":"Done:\nhttps://github.com/Whonix/whonixcheck/commit/143abd942d31ccbaa4a3b04494fb49bc91458d5b"}]},"PHID-TASK-iemlabltythhnzd2ulft":{"id":"212","title":"ask about Alpine Linux package manager security","status":"wontfix","priority":"Normal","author":"Patrick","description":"At first sight it looks like alpine's package manager suffers from the same issues as gentoo's. (Being vulnerable to indefinite freeze and downgrade attacks.)\n\nTODO:\nAsk Alpine Linux mailing list about this.\n","comments":[{"author":"Patrick","date_created":1425840716,"date_modified":1425840716,"content":"The more I am considering to switch to other distributions, the more I am getting convinced, that moving away from Debian is not a good idea at this point. Debian provides so much that is difficult to get from another distribution. updated - Reasons for being based on Debian:\nhttps://www.whonix.org/wiki/Dev/Operating_System#About_Debian\n"},{"author":"ncopa","date_created":1435061146,"date_modified":1435061146,"content":"care to give any details about indefinite freeze and downgrade attacks that gentoo has?\n\nWhy do you think apk-tools has it too?"},{"author":"Patrick","date_created":1435071595,"date_modified":1435071595,"content":"Too long ago... Trying to find this again...\n\nGentoo: downgrade attacks, source:\n* https://github.com/Whonix/Gentoo-Port/issues/10#issuecomment-67735154\n\nMight also contain some info:\n* [gentoo-portage-dev] Security and Comparison of Portage with other Package Managers: https://archives.gentoo.org/gentoo-portage-dev/message/bda425ee6c676ec7a6b3c9500a9b00bf\n* [gentoo-portage-dev] Portage and Update Security: https://archives.gentoo.org/gentoo-portage-dev/message/94425239fcaedcee6c49ef398f12aa85\n\nYou might be interested in this:\n* https://github.com/Whonix/Gentoo-Port/labels/security\n\nRather, maybe also in this:\n* https://github.com/Whonix/Gentoo-Port/issues\n\nAlpine apk:\n* If I remember right...\n* only packages are signed\n* package metadata is not signed\n* package metadata does not expire (no Valid-Until field) (http://blog.ganneff.de/blog/2008/09/23/valid-until-field-in-release-f.html)"}]},"PHID-TASK-bnmiiwwovqypjlqe7su6":{"id":"211","title":"Plan to create sub-pages for Qubes wiki documentation","status":"resolved","priority":"Normal","author":"WhonixQubes","description":"I'm planning a more extensive and cleaner format for the new Qubes + Whonix wiki documentation, by partitioning it across multiple sub-pages.\n\nOn the [[ https://www.whonix.org/wiki/Qubes | main Qubes documentation page ]], I will create a general overview along with summaries and links for the sub-pages that deal with individually meaningful pieces of documentation.\n\nI will plan to have all directly related Qubes documentation sub-pages canonically under the URL of the main page like this...\n\nhttps://www.whonix.org/wiki/Qubes/sub-page\n\nFor example:\n\n- Install guides will be sub-pages\n- How To guides will be sub-pages\n- Specific informational pages can be sub-pages, like Whonix vs. TorVM\n\nAnd on each sub-page, to deal with people getting disoriented and stuck who may have been deep linked to a sub-page and not be aware of the main Qubes page, I will create a wiki template of a section that briefly explains what the Qubes + Whonix platform is, that they are on a documentation sub-page and provide them a clear link to the main Qubes documentation page. I will insert this template at the top and bottom of each sub-page so people are more likely to see it.\n\nOverall this sub-page format should help us achieve more extensive, organized, and useful documentation for Qubes + Whonix, I believe.","comments":[{"author":"WhonixQubes","date_created":1426709316,"date_modified":1426709316,"content":"Resolved: Have implemented this plan for the wiki sub-pages documentation format of Whonix Qubes."}]},"PHID-TASK-xuufugvactrf5zh2fvu5":{"id":"210","title":"Set user xattrs and patch cffi for PaX","status":"invalid","priority":"Wishlist","author":"John","description":"Currently, whonixcheck and sdwdate don't work with a kernel patched with grsecurity. This is because of two problems:\n\n* /usr/bin/python2.7 is not labelled with user.pax.flags='E'\n* cffi tries to create rwx pages\n\nThe first is easy to fix, just setfattr -n user.pax.flags -v E /usr/bin/python2.7\n\nThe second requires a patch¹. Given that Whonix uses Debian stable, I'm guessing that it will take a Very Long Time Indeed until a working release ends up in Whonix without preemptive action.\n\n¹ https://bitbucket.org/cffi/cffi/issue/177/foo-segfaults-with-grsec-denied-rwx-mmap","comments":[{"author":"Patrick","date_created":1425396009,"date_modified":1425396009,"content":"We don't have the manpower to ship a custom patched kernel at this time.\n\nIsn't this a patch that should be suggested to the grsecurity developers?\n\nPlease share how you got grsecurity working in Whonix in a separate ticket or T203."},{"author":"John","date_created":1425457938,"date_modified":1425457938,"content":">>! In T210#2722, @Patrick wrote:\n> We don't have the manpower to ship a custom patched kernel at this time.\n> \n> Isn't this a patch that should be suggested to the grsecurity developers?\n> \n> Please share how you got grsecurity working in Whonix in a separate ticket or T203.\n\nI didn't mean to imply that you should ship a custom kernel, only that it would be nice if you set the appropriate xattrs and ideally patched your copy of cffi.\n\nThe patch shouldn't be suggested to grsecurity developers, since it's a patch to cffi. The penultimate comment in the linked thread explains what it does.\n\nAs for how I got grsecurity working in Whonix, I simply copied over a kernel (hardened-sources) from a Gentoo install."},{"author":"Patrick","date_created":1425486160,"date_modified":1425486160,"content":">>! In T210#2748, @John wrote:\n> I didn't mean to imply that you should ship a custom kernel, only that it would be nice if you set the appropriate xattrs\n\nIsn't this something that should be rather suggested and implemented to Debian's python package or python upstream?\n\n> and ideally patched your copy of cffi.\n> The patch shouldn't be suggested to grsecurity developers, since it's a patch to cffi. The penultimate comment in the linked thread explains what it does.\n\nI see. cffi merged the patch. I don't think we have the manpower to maintain patched versions of packages in Whonix's repository. So it will likely indeed take a long time until Debian stretch."},{"author":"John","date_created":1427077200,"date_modified":1427077270,"content":"> I see. cffi merged the patch. I don't think we have the manpower to maintain patched versions of packages in Whonix's repository. So it will likely indeed take a long time until Debian stretch.\n\nJust fyi, the problem isn't cffi, but a much earlier change in libffi (included in 3.1).\n\nI hadn't quite realized just how antiquated debian stable was, and so had assumed it must be the later cffi problem. I tried installing libffi from debian testing, but that pulled in glibc from testing, which triggered what seemed like a complete removal of whonix packages. I had no idea how to specify dependency preferences in apt as would be specified by USE flags in portage, so I gave up.\n\nwrt taking this issue to debian, considering the manpower of debian and its nonchalance toward rwx pages thus far, I think that doing so would be painful to say the least.\n\nIt's probably easier to just inspect and copy whonix config over to Gentoo and use that until libffi 3.1 reaches debian stable."},{"author":"HulaHoop","date_created":1432126115,"date_modified":1432127796,"content":"Why not set PaX exceptions for cffi with paxctl? Exceptions for any flags can be done per binary. It should work but it won't fully benefit from PaX until upstream cffi supports mprotect."},{"author":"John","date_created":1432241054,"date_modified":1432243475,"content":">>! In T210#4702, @HulaHoop wrote:\n> Why not set PaX exceptions for cffi with paxctl? Exceptions for any flags can be done per binary. It should work but it won't fully benefit from PaX until upstream cffi supports mprotect.\n\nPrimarily because granting rwx pages isn't the only problem. Without patching ffi tries to create and then execute writable files(!). The patch makes ffi see that it's on a kernel that enforces basic security/sanity, and if it is, elect not to do so.\n\nAlso, ELF header marking has been deprecated for over a year, so I don't build my kernels with support for it.* This is a good thing, because altering the hash of installed files removes any \"outsourced\" trust afforded by using upstream binaries.\n\n\\* Running a secure system on hardened Gentoo profiles is piss easy. I hadn't quite (read: at all) appreciated that fact until I tried to use Whonix/debian."},{"author":"HulaHoop","date_created":1432260949,"date_modified":1432260949,"content":">Primarily because granting rwx pages isn't the only problem. Without patching ffi tries to create and then execute writable files(!)\n\nYes I implied there is a temporary security tradeoff because python won't be fully protected but  I still think the problem is not a blocker for grsecurity support  because exceptions can still make cffi work. Interpreters like python and java need PaX exceptions to work."},{"author":"John","date_created":1432263158,"date_modified":1432263158,"content":">>! In T210#4790, @HulaHoop wrote:\n>>Primarily because granting rwx pages isn't the only problem. Without patching ffi tries to create and then execute writable files(!)\n> \n> Yes I implied there is a temporary security tradeoff because python won't be fully protected but  I still think the problem is not a blocker for grsecurity support  because exceptions can still make cffi work. Interpreters like python and java need PaX exceptions to work.\nI don't understand what part of that quote you're addressing. Writable files are outside of PaX's scope. TPE is what protects against writable executables, and TPE isn't part of PaX. Sure, you could disable it, if you like living dangerously. I sure as hell wouldn't."},{"author":"HulaHoop","date_created":1432272302,"date_modified":1432272482,"content":"There are ways to make TPE exemptions more fine grained than shutting it off completely. Add the python scripts under a separate group then use tpe_invert. Its not ideal but definitely better than nothing and better than not having grsecurity at all until the next Debian stable.\n\ngrsec manual:\n\n>kernel.grsecurity.tpe_invert\nIf you say Y here, the group you specify in the TPE configuration will\ndecide what group TPE restrictions will be *disabled* for.  This\noption is useful if you want TPE restrictions to be applied to most\nusers on the system.  If the sysctl option is enabled, a sysctl option\nwith name \"tpe_invert\" is created.  Unlike other sysctl options, this\nentry will default to on for backward-compatibility."},{"author":"John","date_created":1432274190,"date_modified":1432274190,"content":">>! In T210#4792, @HulaHoop wrote:\n> There are ways to make TPE exemptions more fine grained than shutting it off completely. Add the python scripts under a separate group then use tpe_invert. Its not ideal but definitely better than nothing and better than not having grsecurity at all until the next Debian stable.\n> \n> grsec manual:\n> \n>>kernel.grsecurity.tpe_invert\n> If you say Y here, the group you specify in the TPE configuration will\n> decide what group TPE restrictions will be *disabled* for.  This\n> option is useful if you want TPE restrictions to be applied to most\n> users on the system.  If the sysctl option is enabled, a sysctl option\n> with name \"tpe_invert\" is created.  Unlike other sysctl options, this\n> entry will default to on for backward-compatibility.\n\nYou'll also have to disable GRKERNSEC_TPE_ALL, since TPE then blocks any executable file that's world-writable regardless of tpe_gid's value  (which /tmp usually is). I suggest having a seriously strict MAC/RBAC policy before considering turning it off though (on your own machines: I agree with your implication that debian users are fscked already ;))"},{"author":"HulaHoop","date_created":1493482849,"date_modified":1493482849,"content":"upstream ceased open development: https://www.grsecurity.net/passing_the_baton_faq.php"}]},"PHID-TASK-zhx6bgdyihlhkdga4vhe":{"id":"208","title":"better TRNG support","status":"wontfix","priority":"Normal","author":"Patrick","description":"TODO:\n* Consider installing more TRNG supporting packages by default in Whonix. ([Non-exhaustive list](https://www.whonix.org/wiki/Dev/Entropy))\n* Suggest to upstream, to Debian's installer to install havegend and/or TRNG supporting packages by default for better security.\n\nGood discussion on entropy mixing of rngd and haveged, which may not be that simple:\nhttps://labs.riseup.net/code/issues/5650#note-16\n([Asked](https://www.whonix.org/pipermail/whonix-devel/2015-July/000391.html) David if he could please follow up on that ticket.)\n","comments":[{"author":"HulaHoop","date_created":1437858394,"date_modified":1437858394,"content":"The common wisdom is \"more entropy can't hurt\" but given the almost certain probability of Intel hardware RNG being subverted [1] and the doubts about this common idea by cryptologist Daniel Bernstein [2] I thing we should throw out the idea of supporting TRNG and add only on fully open and trusted RNG packages that are authored by knowledgeable people. A malicious vs broken rng is actually harmful.\n\n[1]https://www.schneier.com/blog/archives/2013/09/surreptitiously.html\n[2]http://blog.cr.yp.to/20140205-entropy.html"},{"author":"Patrick","date_created":1437892597,"date_modified":1437892597,"content":"This isn't tied to Intel. There are other vendors."},{"author":"HulaHoop","date_created":1437931982,"date_modified":1437931982,"content":"Right. Same applies to any closed hardware implementation not open to public review."},{"author":"Patrick","date_created":1437995927,"date_modified":1437995927,"content":"What about Open Hardware implementations? Such as [onerng](http://onerng.info/)?"},{"author":"HulaHoop","date_created":1438002416,"date_modified":1438002416,"content":"Open Hardware implementations are great to have.  Does onerng use a different pakage? \n"},{"author":"Patrick","date_created":1438003452,"date_modified":1438003452,"content":"As per http://onerng.info/onerng/ instructions, it also uses rng-tools. (+ The onerng driver package.) (Note: this ticket is not necessarily limited to rngd either.)"},{"author":"Patrick","date_created":1438003998,"date_modified":1438003998,"content":"Back to the proprietary hardware issue.\n\n> but given the almost certain probability of Intel hardware RNG being subverted [1]\n\nIf you find this likely... I also wouldn't be surprised by such a backdoor... Haven't we reached the seemingly non-solveable trustworthy hardware problem? If you find it likely, that Intel has a backdoor, you probably also find it likely, that AMD has a backdoor. What about CPU backdoors then? Is it consistent to recommend avoiding Intel RNG while not recommending to avoid Intel CPU's?"},{"author":"HulaHoop","date_created":1438006684,"date_modified":1438006684,"content":"Subverting the HWRNG is the lower hanging fruit and is the most effective to target. It needs minimal conspiracy as only a very simple and small modification is done to sabotage it during the manufacturing process so no one in the design process even knows about it. Its the ultimate backdoor because without a good RNG everything else falls apart.\n\nBefore the Snowden revelations and this paper on RNG backdooring there was intense pressure on Ted Tso (kernel RNG developer) by Intel to make Linux rely exclusively on their HWRNG. Fortunately he did not cave in and it was limited to one of the entropy sources not the only one.\n\n***\n\nI'm looking if rngd can be configured to use only specific entropy generating hardware devices (to use the trusted one only) but it doesn't seem possible at this level. It may be an option only at the hw_random kernel module.\n\nhttp://man.cx/rngd%288%29\n\n> WARNING\n> \n> Depending on its settings, rngd can dominate the kernel’s entropy pool, by feeding it so much data, so often, that other sources of entropy are mostly ignored or lost. Do not to that unless you trust rngd’s source of random data ultimately.\n> \n> Also, there is only so much bandwidth available from a TRNG, and it is often not much. Don’t drain too much with too low a feed-interval, or rngd may not have enough data on its buffers when the kernel gets low on entropy.\n\n\n"},{"author":"Patrick","date_created":1438099596,"date_modified":1438099596,"content":">>! In T208#6040, @HulaHoop wrote:\n> The common wisdom is \"more entropy can't hurt\" [...]\n> the doubts about this common idea by cryptologist Daniel Bernstein [2] I think we should throw out the idea of supporting TRNG [...]\n> [2]http://blog.cr.yp.to/20140205-entropy.html\n\nDiscussion:\nhttps://groups.google.com/forum/#!topic/randomness-generation/eNnepJ_65eQ\n\nDaniel Bernstein makes a good argument. I guess we can close this as wontfix then?\n"},{"author":"HulaHoop","date_created":1438107165,"date_modified":1438107165,"content":"Yes."}]},"PHID-TASK-wksg25ygbvhnvmibndbm":{"id":"207","title":"Build Debian Packages from Source Code","status":"open","priority":"Normal","author":"Patrick","description":"__Info__:\n\n- For better security, ideally, we wouldn't pull binary packages from Debian's repository during the build of Whonix, but compile all packages from source code.\n\n- sponsor-B would pay a bounty for implementing this. We agreed to try bountysource to get offers.\n\n- For building packages from source code, there is `apt-get source --compile pkg-name`. But for it to work, one has to run `apt-get build-dep pkg-name` beforehand, which downloads binary packages. Is it possible to get to a point, where all packages that are installed/updated, are compiled from source code beforehand? Seems difficult to break the dependency loops. Some more info: https://unix.stackexchange.com/questions/184812/how-to-update-all-debian-packages-from-source-code\n\n- The debootstrap system has a fair number of circular dependencies, and no trivial way to break them. Is it allowed to have a leap of faith, to trust some minimal amount of binary packages for the initial bootstrap. Use local system packages and set of \"known-good\" binaries to do the initial bootstrap build, then rebuild up from there. (One loop that is non-trivial to break for instance is GCC; which requires an Ada compiler to build the Ada compiler. Another one I can think of is OpenJDK, and ghc.) (modified quote by @NCommander)\n\n- The user should be able to build Debian / Whonix from scratch from source code. (Whonix already got a functional build script, using debootstrap [binary packages] and apt-get [binary packages], that can be used by anyone to build from source.)\n\n- The user should be able to run self rebuilds. For one, `apt-build world` in theory would work nicely for rebuilds from within the running system for us. (Useful to add more compile flags.) Unfortunately, `apt-build` is unmaintained, `world` is broken and written in perl. `apt-build`'s feature set and man page looks very good.\n\n- Do you think you could re-implement all the features of `apt-build` as an apt [download] method, if that makes sense? Aka \"apt-build re-implementation in apt\". So upstream apt devs get eager to merge and maintain this? So anyone could install any package from Debian sources repository, build and install from source code?\n\n- [rebootstrap](https://wiki.debian.org/HelmutGrohne/rebootstrap) is a nice project, but I don't see how that implements the TODO part.\n\n- [apt-build](https://www.whonix.org/wiki/Dev/apt-build) [...](http://askubuntu.com/questions/29856/how-to-build-all-my-installed-package-from-sources/45257#45257) could help. Unfortunately it is an [orphaned package](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=365427). And might have a [security issue](https://lists.debian.org/debian-security/2015/03/msg00020.html).\n\n\n- If helpful, this ticket could be split into smaller tasks.\n\n-----\n\n__TODO__:\n\n* add an option to `debootstrap` to install the compile all source packages rather than downloading binary ones\n* add an option to or wrapper around `apt-get` to allow installation/upgrade of packages from source code\n* It is essential, that patches should be upstreamed to and merged by Debian!\n* have an option to modify compile flags per package, so we can for example enable compiling as PIE\n\n-----\n\nNon-Topics:\n\n- Yes, there is really a $ 3000 USD bounty on this ticket.\n\n- We do not want to use EC2 and/or remotely rebuild/maintain the binary archive.\n\n- We don't think we can host our own [binary] repository of the whole Debian package archive anytime soon.\n\n- We are aware of [reproducible builds](https://wiki.debian.org/ReproducibleBuilds). We still want this. Also because we are also after the compiler hardening enhancements.\n\n- apt-get source verification is not the issue here. Verifying the signature of the maintainer may fail indeed, but apt-get source is also always verified against the apt repository singing key. ([See also for explanation](http://askubuntu.com/a/509816/389275).) If you want to discuss this further, let's move this to the [forums](https://www.whonix.org/forum/) or a separate [ticket](http://phabricator.whonix.org/).\n\n- Port to Gentoo. No. (We've been through this (Gentoo) and decided no. (https://github.com/Whonix/Gentoo-Port/issues) Would trade this feature against new issues, including security issues [unsigned files]. [off-topic - if you want to discuss this further, please move it to the Whonix forums])\n\n- Port to other Distributions. No.\n\n- Debian only. Not Ubuntu.\n\n-----\n\nprevious / more / archived discussion:\nhttp://www.webcitation.org/6gTIAk6Yj\n\n-----\n\n__Bounty too low?__:\n\n1) Go to https://www.bountysource.com/issues/9115540-build-debian-packages-from-source-code\n2) Click on \"Developers\"\n3) Click on \"Get Started\"\n4) Select Status \"Bounty too low\"\n5) Enter your offer and press \"Save\".\n\n-----\n\nMirrored from:\nhttps://phabricator.whonix.org/T207\n\n-----\n\nMirrored to ([restarted the discussion](https://www.whonix.org/blog/debian-packages-from-source-code)):\nhttps://github.com/Whonix/Whonix/issues/400\n\n-----\n\nOn bountysource `[*]`:\nhttps://www.bountysource.com/issues/9115540\n\n`[*]` Contains full history discussion. When you are reading on bountysource.com, to save time, I recommend to skip everything up to `I have rewritten the original ticket description.`.","comments":[]},"PHID-TASK-mobzeer5yqq4seda6ydq":{"id":"206","title":"package manager security comparison","status":"wontfix","priority":"Normal","author":"Patrick","description":"Write a comparison of various package mangers, Debian's apt-get vs Gentoo's emerge.","comments":[{"author":"Patrick","date_created":1425511707,"date_modified":1425511707,"content":"Started:\nhttps://www.whonix.org/wiki/Comparison_Of_Package_Managers\n\nContacted The Update Framework (TUF) people:\nhttps://groups.google.com/forum/#!topic/theupdateframework/msrdXOiOQGY\n"},{"author":"Patrick","date_created":1425656686,"date_modified":1425656686,"content":"It was naive of me to attempt to create such a comparison table. Takes much more time than I have available for this.\n\nIt was to be expected that there are disagreements and I cannot resolve them without checking the code myself and perhaps without coming up with proof of concept exploitation code to settle it.\n\nTo prevent spreading false information, I took that wiki page offline."}]},"PHID-TASK-2wu5e3qvskb767sijk2r":{"id":"205","title":"better mobile device support for whonix.org by using mediawiki MobileFrontend","status":"resolved","priority":"Normal","author":"Patrick","description":"Enable mediawiki mobile frontend.\n\nhttps://www.mediawiki.org/wiki/Extension:MobileFrontend\n\nIt's already installed. Works quite well. Imprint footer links now functional.\n\nhttps://github.com/varnish/varnish-devicedetect could be the way to go.\n\nhttps://www.mediawiki.org/wiki/Extension:MobileFrontend#Using_the_mobile_view contains some info on how to make MobileFrontend work with varnish.","comments":[{"author":"Patrick","date_created":1425977821,"date_modified":1425977821,"content":"This is done. The related varnish vlc snippet:\n\n```\n##########################################################################################\n## mediawiki mobile frontend\n##########################################################################################\n\n## credits:\n## https://github.com/varnish/varnish-devicedetect/blob/master/INSTALL.rst\n\n## transparently adding \"?useformat=mobile\" to backend requests\n## https://www.whonix.org/wiki/Main_Page\n## https://www.whonix.org/wiki/Main_Page?useformat=mobile\n\ninclude \"devicedetect.vcl\";\n\nsub vcl_recv {\n   call devicedetect;\n}\n\nsub vcl_backend_fetch {\n   if ( bereq.url == \"/wiki/\" || bereq.url == \"/w\" || bereq.url ~ \"^/wiki/\" || bereq.url ~ \"^/w/\" ) {\n      if ( bereq.http.X-UA-Device ~ \"^mobile\" || bereq.http.X-UA-device ~ \"^tablet\" ) {\n         if ( bereq.method == \"GET\" ) {\n            set bereq.url = bereq.url + \"?useformat=mobile\";\n         }\n      }\n   }\n}\n\nsub vcl_deliver {\n   set resp.http.X-UA-Device = req.http.X-UA-Device;\n}\n```\n"}]},"PHID-TASK-qonfna6ji35dqiidlb4z":{"id":"204","title":"comparison of security related compile flags - Hardened Gentoo vs Debian","status":"resolved","priority":"Normal","author":"Patrick","description":"Create a comparison of ~10 network accessing applications used by Whonix. (Tor, curl, etc.) Using checksec.sh or so.\n\nTo be added here:\nhttps://www.whonix.org/wiki/Dev/Operating_System\n","comments":[{"author":"Patrick","date_created":1425430319,"date_modified":1425430319,"content":"In progress:\nhttps://www.whonix.org/wiki/Dev/Operating_System#Comparison_of_Hardening_Compile_Flags\n\n(Now compiling firefox and thunderbird for more results.)"},{"author":"Patrick","date_created":1425498966,"date_modified":1425498966,"content":"Done:\nhttps://www.whonix.org/wiki/Dev/Operating_System#Comparison_of_Hardening_Compile_Flags"}]},"PHID-TASK-nm4elxvrwnlbxpsolnw6":{"id":"203","title":"grsecurity kernel installation instructions","status":"invalid","priority":"Normal","author":"Patrick","description":"The purpose of this ticket is to get a grsecurity kernel to work in Whonix (same as Debian for these purposes here) at all. Having #user_documentation on how a user could install it. From there we could build up with automation, perhaps installation by default, verifiable (kernel) builds, etc.\n\n-----\n\nSee also:\nhttps://unix.stackexchange.com/questions/186837/how-to-get-a-grsecurity-kernel-on-debian-wheezy-using-the-linux-patch-grsecurity\n\n-----\n\nAlso started a discussion with the mempo developers of deterministic grsecurity kernel deb:\nhttps://github.com/mempo/mempo-kernel/issues/created_by/adrelanos\n\n-----\n\nhttps://github.com/rickard2/grsecurity-Debian-Installer looks most promising for now. Much simpler than the mempo-kernel.\n\nLicensing is not sorted out yet:\nhttps://github.com/rickard2/grsecurity-Debian-Installer/issues/12\n\nHas some other issues:\nhttps://github.com/rickard2/grsecurity-Debian-Installer/issues/created_by/adrelanos\n\nThat script is relatively small and simple. Fixing these issues and/or forking and/or rewriting it depending on how responsive upstream is should be no issue.\n\nTODO:\n* Foremost, check if that installer is actually working.","comments":[{"author":"troubadour","date_created":1425427487,"date_modified":1425427487,"content":"The installer seems to work. Currently using kernel `3.2.67-grsec`. Will come back in T210. whonixcheck and sdwdate are working with AppArmor disabled."},{"author":"Patrick","date_created":1426201728,"date_modified":1426201728,"content":"Licensing sorted out:\nhttps://github.com/rickard2/grsecurity-Debian-Installer/commit/7ba1695c20b573d5b979deeb60205c4cc7f122ad"},{"author":"Patrick","date_created":1429069973,"date_modified":1429069973,"content":"Done with initial packaging:\n- https://github.com/Whonix/grsecurity-installer\n- https://github.com/rickard2/grsecurity-Debian-Installer/pull/15"},{"author":"Patrick","date_created":1429102441,"date_modified":1429102441,"content":">>! In T203#2744, @troubadour wrote:\n> The installer seems to work. Currently using kernel `3.2.67-grsec`.\n\nAre you sure grsecurity is really active? I've run the script with debugging and saw that applying the patch failed. The script succeeded anyhow and installed a kernel that included grsec in its name. But checksec.sh reports, that grsecurity is disabled. Did you make sure grsecurity is enabled using checksec.sh or some other means?\n\n> whonixcheck and sdwdate are working with AppArmor disabled.\n\nIt's possibly not because of grsecurity, but because a newer kernel version is being used. So these are possibly AppArmor issues due to a newer kernel version unrelated to grsecurity."},{"author":"Patrick","date_created":1429194798,"date_modified":1429194798,"content":"Using that script you need to manually enable grsecurity using menuconfig. Otherwise the kernel is named grsecurity but doesn't have grsecurity enabled. I succeeded building a grsecurity enabled kernel (as per checksec), but it cannot open a graphical KDE desktop yet and there is also a vbox guest additions specific issue (https://www.virtualbox.org/manual/ch12.html#idp100531824)."},{"author":"troubadour","date_created":1429338091,"date_modified":1429338091,"content":"Yes, the kernel name was appended with -grsec but it was not enabled.\n\nPerhaps a non related issue. Built a kernel after enabling grsec in menuconfig. It did not run because of (apparently) some virtualbox issue (selected Virtualbox guest in the menu). I purged the guest additions. No change with the grsec kernel, but after rebooting with `3.2.0-4-686-pae`, kdm does not start automatically. `sudo kdm` returns nothing.\n\nAfter reinstalling the guest additions, Workstation boots normally."},{"author":"HulaHoop","date_created":1452097571,"date_modified":1452097571,"content":"linux-grsec now in Debian unstable\n\nhttps://twitter.com/benhutchingsuk/status/684437715941744640\n\n\nFor future out of the box support efforts we would only have to look into maintaining paxctld exception list. A less major task than developing/maintaining grsec-installer. Also changes like default apt-pinning suport would be needed because grsec kernels will stay exclusively in Debian unstable."},{"author":"Patrick","date_created":1452102004,"date_modified":1452102004,"content":"What is the status of https://www.whonix.org/wiki/Grsecurity? Tested / working in Whonix?\n\n-----\n\n\n\n>>! In T203#7843, @HulaHoop wrote:\n> linux-grsec now in Debian unstable\n> \n> https://twitter.com/benhutchingsuk/status/684437715941744640\n\nNice!\n\n> \n> For future out of the box support efforts we would only have to look into maintaining paxctld exception list. A less major task than developing/maintaining grsec-installer.\n\nWould you create/maintain that list?\n\n> Also changes like default apt-pinning suport would be needed because grsec kernels will stay exclusively in Debian unstable.\n\nNot a problem as long this is a user documentation only thing. The [Apt-Pinning wiki template](https://www.whonix.org/wiki/Template:Apt-Pinning) looks good and unlikely to cause issues.\n\nLet's implement this a user documentation only thing first. Have some wider testing. [Write a blog post to encourage testing.]\n\nCan you get the Debian `linux-grsec` package way to use this in Whonix documented/tested?\n\n-----\n\nWhen that works... Later for more automation / simplification we could reconsider [Whonix Dev/APT_Pinning](https://www.whonix.org/wiki/Dev/APT_Pinning) and perhaps create a package that simplifies this.\n"},{"author":"HulaHoop","date_created":1452110103,"date_modified":1452110103,"content":"> Would you create/maintain that list?\n\nYes. I am thinking about taking the Arch paxctld list and adjusting executable paths for Debian's choices. As it is now, the grsec package cannot work with Xorg and so that will need to be sorted out first.\n\n> Can you get the Debian linux-grsec package way to use this in Whonix documented/tested?\n\nI will post updates after testing.\n\nPaxrat suggested by Jacob makes exceptions handling easier to manage across package upgrades so they don't break after the first apt update is downloaded:\n\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=605090#487\n\nhttps://github.com/subgraph/paxrat\n\nincorporating this package in Whonix is essential for a long term solution."},{"author":"Patrick","date_created":1452111876,"date_modified":1452111876,"content":"`Debian packaging`:\nhttps://github.com/subgraph/paxrat/issues/1\n"},{"author":"Patrick","date_created":1452112415,"date_modified":1452112452,"content":"Can you write/post draft/submit an Debian RFP (Request for Package) for paxrat please?\n\n(More info, what should go into it, compare with this one: https://github.com/theupdateframework/tuf/issues/263)"},{"author":"HulaHoop","date_created":1452122932,"date_modified":1452186733,"content":"First I applied the Apt-pinning instructions (https://www.whonix.org/wiki/Template:Apt-Pinning) then:\n\n```\nsudo su -c \"echo -e 'deb http://security.debian.org unstable/updates main contrib non-free\\ndeb http://ftp.us.debian.org/debian unstable main contrib non-free' > /etc/apt/sources.list.d/debian-unstable.list\"\n```\n```\nsudo apt-get install linux-image-4.3.0-1-grsec-686-pae linux-grsec-support-4.3.0-1 linux-grsec-base paxctl\n```\n\nAll relevant grsec packages:\n\n```\nlinux-grsec-source-4.3 - Linux kernel source for version 4.3 with Debian patches\nlinux-grsec-support-4.3.0-1 - Support files for Linux 4.3\nlinux-headers-4.3.0-1-common-grsec - Common header files for Linux 4.3.0-1-grsec\nlinux-headers-4.3.0-1-grsec-686-pae - Header files for Linux 4.3.0-1-grsec-686-pae\nlinux-image-4.3.0-1-grsec-686-pae - Linux 4.3 for modern PCs, Grsecurity protection\nlinux-grsec-base - Linux image base package, grsec featureset\npaxctl - new PaX control program for using the PT_PAX_FLAGS marking\n```\n\nList of changes an install triggers. Note gradm2 is installed as a dependency:\n\n```\nThe following extra packages will be installed:\n  firmware-linux-free gradm2 irqbalance libc6-i686 libnuma1 pax-utils\nSuggested packages:\n  linux-patch-grsecurity2 linux-doc-4.3 debian-kernel-handbook\nThe following packages will be REMOVED:\n  xserver-xorg-input-all xserver-xorg-input-vmmouse\nThe following NEW packages will be installed:\n  firmware-linux-free gradm2 irqbalance libc6-i686 libnuma1 linux-grsec-base\n  linux-grsec-support-4.3.0-1 linux-image-4.3.0-1-grsec-686-pae pax-utils\n  paxctl\n0 upgraded, 10 newly installed, 2 to remove and 13 not upgraded.\nNeed to get 35.5 MB of archives.\nAfter this operation, 129 MB of additional disk space will be used.\n```\n \nPaxrat without packaging needs some work to get running like figuring out the correct paths for the binaries and configuration files.\n\nsudo apt-get install golang\n\n\nThats how far I got yet and I'll make a request draft."},{"author":"HulaHoop","date_created":1452144089,"date_modified":1452144089,"content":"ETA for subgraphOS alpha: https://twitter.com/attractr/status/684075394509717505\n\n```\nAlmost there, SGOS alpha first week of March.\n```\n\n\nHere it is. There are some blanks that I need help filling and important things like licensing need attention.\n\n\n* Package name    : paxrat\n   Version         : 1\n   Upstream Author : Name <info@subgraph.com>\n* URL               : https://subgraph.com/\n* License         : ?\n   Programming Lang: Go\n   Description  : PaX exception daemon for Debian packages.\n\n\nThe newly packaged grsec kernel makes it easier for anyone to run a more secure kernel. However some major packages like Iceweasel/Tor Browser, JIT interpreters and main components of Gnome and KDE require PaX exceptions because they are not compatible with memory protection features of the enhanced kernel. \n\nPaxrat from the SubgraphOS project is a daemon that maintains and applies rules from an exception list. It has dpkg hooks for taking care of binaries even when updated.\n\nPaxrat is implemented in GoLang and is simple to use.\n\nAlso a Grsecurity kernel maintainer are interested to have paxrat packaged. [1]\n\n[1] https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=605090#487\n"},{"author":"HulaHoop","date_created":1452186809,"date_modified":1452186809,"content":"Asked for comments support:\n\nhttps://github.com/subgraph/paxrat/issues/2"},{"author":"Patrick","date_created":1452202047,"date_modified":1452202047,"content":"What blanks?\n\nHulaHoop (HulaHoop):\n> It has dpkg hooks for taking\n> care of binaries even when updated.\n\nReally? Sure? Code? Not sure if this comment by Jacob was\nmisinterpreted. It would be useful if there were dpkg hooks."},{"author":"HulaHoop","date_created":1452204895,"date_modified":1452204895,"content":"> What blanks?\n\nI have no idea what their licensing for this and other packages in Subgraph is.\n\nWho do I put as the upstream author? What email should I use - is the address for general contact enough?\n\nWhat mail list do I post to?\n\n\n>  Sure? \n\n\nYes. This is very much what paxd does except its another project and coded in C, Also take a look at the original comment:\n\n```\npaxctl one off runs isn't great for a full solution.\n\npaxrat improves on this as package updates and other things can stomp\non pax related xattributes. paxrat seems very very useful in this\ncontext - we get configuration files as well as dpkg hooks.\n```"},{"author":"Patrick","date_created":1452205585,"date_modified":1452205585,"content":"Until now there is no license file and no license information in the source files either. So for the moment it cannot be considered Libre Software and must be considered proprietary. Please open an issue on paxrat github.\n\nCannot fill-out upstream author yet either because it's not declared either. Please open an issue on paxrat github.\n\nForget the comment. You need to know where to find the code for the hooks. That paxrat repository does not include any dpkg hooks nor claims to ship any of them. These are usually shell scripts, easy to identify. It only writes \"Runnable as a hook to a package manager such as dpkg\". Yes sure. Any tools is runnable as hook to dpkg. Doesn't mean the hook has been written yet. Looks to me those still have to be written.\n\nWhere to send [and how (!) - the header does the magic] - is documented here:\nhttps://wiki.debian.org/RFP\nAnd here:\nhttps://www.debian.org/devel/wnpp/#l2\n"},{"author":"HulaHoop","date_created":1452206600,"date_modified":1452206600,"content":"https://github.com/subgraph/paxrat/issues/4\n\nI see.  Do I open a ticket for adding the dpkg shell scripts? Do we just wait?"},{"author":"Patrick","date_created":1452207626,"date_modified":1452207626,"content":"Feature request won't harm probably."},{"author":"HulaHoop","date_created":1452213789,"date_modified":1452213897,"content":"Dpkg hooks request filed: https://github.com/subgraph/paxrat/issues/5\n\nSource package feedback:\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=605090#572"},{"author":"Patrick","date_created":1452281955,"date_modified":1452285971,"content":"Upstream has sorted out a lot. Licensing, dpkg hooks and config file comments (pull request by Alexey Derlaft).\n\nRequested release and signed git tags:\nhttps://github.com/subgraph/paxrat/issues/6\n\nUpdated the RFP proposal.\n\n-----\n\nTo: submit@bugs.debian.org\nSubject: RFP: paxrat -- PaX exception daemon for Debian packages\n\n-----\n\n```\nPackage: wnpp\nX-Debbugs-CC: desktops@secure-os.org\nX-Debbugs-CC: corsac@debian.org\nX-Debbugs-CC: jacob@appelbaum.net\nX-Debbugs-CC: whonix-devel@whonix.org\n\n* Package name: paxrat\n  Version         : 1\n  Upstream Author : David McKinney <mckinney@subgraph>\n* URL             : https://github.com/subgraph/paxrat\n* License         : GPLv3\n  Programming Lang: Go\n  Description     : PaX exception daemon for Debian packages.\n\nThe newly packaged grsec kernel makes it easier for anyone to run a more secure kernel. However some major packages like Iceweasel/Tor Browser, JIT interpreters and main components of Gnome and KDE require PaX exceptions because they are not compatible with memory protection features of the enhanced kernel. \n\nPaxrat from the SubgraphOS project is a daemon that maintains and applies rules from an exception list. It has dpkg hooks for taking care of binaries even when updated. [2]\n\nPaxrat is implemented in GoLang and is simple to use.\n\nAlso a Grsecurity kernel maintainer are interested to have paxrat packaged. [1]\n\n[1] https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=605090#487\n[2] https://github.com/subgraph/paxrat/blob/master/etc/apt/apt.conf.d/70paxrat\n```\n"},{"author":"HulaHoop","date_created":1452285197,"date_modified":1452285541,"content":"Awesome.\n\nThere is also a linux-grsec backported kernel package available for Jessie which means we don't have to mess with apt-pinning or a dependency mess to build the source one optionally.\n\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=605090#582\n\nEDIT:\n\nApt-pinning may be still needed for jessie-backports but the dependency problems will be gone."},{"author":"Patrick","date_created":1452286026,"date_modified":1452286026,"content":"Want to post the RFP?"},{"author":"HulaHoop","date_created":1452286117,"date_modified":1452286117,"content":"RFP sent.\n\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=810479\n"},{"author":"HulaHoop","date_created":1452441451,"date_modified":1452441451,"content":"\nLatest post by Yves on status of grsec support and comments on the default settings chosen for  the kernel pacage.\n\nIt will take some planning for rolling out the package to stable but its available in his repo right now.\n\nhttp://www.corsac.net/?rub=blog&post=1583\n\n"},{"author":"Patrick","date_created":1452443348,"date_modified":1452443348,"content":"Did you remove the X-Debbugs-CC's? I worry that no one up to package it got actually informed by the RFP. Maybe not super important, since the RFP may not necessarily speed up things."},{"author":"HulaHoop","date_created":1452523197,"date_modified":1452523197,"content":"No. Should I resend them with these heading removed?"},{"author":"Patrick","date_created":1452528508,"date_modified":1452528508,"content":"HulaHoop (HulaHoop):\n> Should I resend them with these heading removed?\n\nNo. Resend would result in duplicate report.\n\nRemoving the header results in adding fewer people to cc. Perhaps it was\nmy mistake to think multiple of these cc headers are allowed."},{"author":"Patrick","date_created":1452534723,"date_modified":1452534723,"content":"Do you think paxrat will require a `.d` config file folder? Would we need a custom paxrat.conf?"},{"author":"HulaHoop","date_created":1452545479,"date_modified":1452545479,"content":"\n> Do you think paxrat will require a .d config file folder?\n\nCurrently no although I think its planned but its optional thanks to Derlaft's commit. # style comments are suppoted in the main conf file:\n\nhttps://github.com/derlaft/paxrat/commit/865273c1feb871d89adbbcb266779c836ee6b186\n\n\n> Would we need a custom paxrat.conf?\n\nProbably. The conf should cover as many packages as possible to be useful to Debian users. Subgraph will be just focusing on a very limited selection of software because they are adding their own curated repo by default AFAIK. "},{"author":"Patrick","date_created":1452549341,"date_modified":1452549341,"content":"Actually,\n\n> Do you think paxrat will require a `.d` config file folder? Would we need a custom paxrat.conf?\n\nwas the same question. Just in other words.\n\nIf we do need a custom paxrat.conf, then we also need a `.d` config folder. Otherwise we would have to use config-package-dev displace. Which is not pretty. Should be avoided if upstream is open to `.d` config folder."},{"author":"HulaHoop","date_created":1452552942,"date_modified":1452552942,"content":"Good question. I asked upstream because it depends on what direction they'll take:\n\nhttps://github.com/subgraph/paxrat/issues/7"},{"author":"Patrick","date_created":1452970474,"date_modified":1452970474,"content":"https://github.com/subgraph/paxrat/issues/1#issuecomment-172149998\n\nCan you shed light on paxctld vs paxrat?"},{"author":"HulaHoop","date_created":1452990469,"date_modified":1453041272,"content":""},{"author":"HulaHoop","date_created":1453041575,"date_modified":1453042257,"content":"My last comment is wrong. David's description is on point.\n\nI think their main reason for paxrat wouldn't apply to Whonix as its not a live environment.\n\nFlags can be maintained paxctld's .conf file"},{"author":"HulaHoop","date_created":1453043935,"date_modified":1453049004,"content":"All we need is a dpkg hook and a conf file for paxctld (the latter mirrors the Arch Linux one)\n\n/etc/apt/apt.conf.d/70paxctld\n\nDPkg::Post-Invoke { \"/sbin/paxctld -c /etc/paxctld.conf\";}\n\nOr it can be run as  daemon. Should there be a systemd service file for paxctld? "},{"author":"HulaHoop","date_created":1453048837,"date_modified":1453048837,"content":"To land a grsec  kernel ASAP we can use corsac's Jessie repo.\n\nI will translate the list here into a format understood by paxctld:\nhttps://github.com/thestinger/paxd/blob/master/paxd.conf\n\nhttps://github.com/coldhakca/coldkernel/blob/master/paxctld.conf\nhttps://github.com/tweksteen/paxctld/blob/master/paxctld.conf"},{"author":"Patrick","date_created":1453060558,"date_modified":1453060558,"content":"> To land a grsec kernel ASAP we can use corsac's Jessie repo.\n\nTo obtain a binary package or source package to compile?\n\n> To land a grsec kernel ASAP we can use corsac's Jessie repo.\n\nCan we? Or will this result in the many issues I experience when I compiled a grsecurity kernel inside VirtualBox? Namely, X no longer starting, conflicts with AppArmor that were not there before and other obscure error messages?\n\nAt very least I want this kernel capable to run inside Qubes also.\n\n> Or it can be run as daemon. Should there be a systemd service file for paxctld?\n\nYou tell me. What would the daemon by doing?\n\nIn systemd terms, what would be the `ExecStart=` line? \n\nDoes [arch linux's](https://aur.archlinux.org/packages/paxctld/) package require a systemd unit? And if not, why would we need one? And if it has one, can re-use it?\n"},{"author":"HulaHoop","date_created":1453090548,"date_modified":1453090548,"content":"> To obtain a binary package or source package to compile?\n\nBoth are possible because he supports Debian Stable dependencies in his repo but my priority is for a binary package installed by default. More details to follow.\n\n> Can we? Or will this result in the many issues I experience when I compiled a grsecurity kernel inside VirtualBox? Namely, X no longer starting, conflicts with AppArmor that were not there before and other obscure error messages?\n\nThere shouldn't be any probems with Apparmor. Exceptions for X and other software is what paxctld is for. The settings probably do conflict with Xen and Virtualbox and may need the custom built source package with the appropriate hypervisor compatibility setting enabled:\n\nhttps://wiki.archlinux.org/index.php/Grsecurity#Compatibility\n\nI'm not sure so  testing on these platforms may be needed.\n\nIf that is the situation, then some service can boot the hardened kernel based on virt-what output.\n\n> You tell me. What would the daemon by doing?\n\nAll examples I saw have paxctld running as a service with no dpkg hooks. Their service files should be reusable."},{"author":"HulaHoop","date_created":1453091551,"date_modified":1453093803,"content":"Package roadmap:\n\n* paxctld-conf \n** contains rules from paxd reformatted for compatibility at /etc/paxctld.conf\n** contains service file\n\n* grsec-conf\n** contains a grsec customized settings conf to make it suitable for desktops by enabling system usb support and some other recommended settings by Yves at /etc/sysctl.d/grsec.conf\n\n* anon-shared-build-apt-sources-corsac\n** /etc/apt/sources.list.d/corsac.list\n** can imitate chroot scripts provided with anon-shared-build-apt-sources-tpo but Yves is a Debian developer and his keys are already in the system keyring?\n\nEDIT:\n\nIt makes sense to merge the first two packages together because they rely on each other to give a usable desktop experience.\n"},{"author":"Patrick","date_created":1453125489,"date_modified":1453125489,"content":"Yes. Merge the first two packages.\n\nI am trying to get rid of the third package also. Why are we back to using corsac's repository? Why not use Debian sid repository and apt pinning instead?\n\n/etc/sysctl.d/grsec.conf -> needs a `digitdigit-` notation. For example `30-grsec.conf` or so. Trying to foresee Debian shipping that name which would then conflict with our package.\n\nIf we ship an apt pinning file, we should also have it start with a digit, following by an underscore and ending with the .conf extension. For example `30_grsec.conf`. I think the days of processing files in `.d` folders are counted because of Debian internal extensions `.dpkg-old` and temporary or backup files by editors such as `file-name~`.\n\n> If that is the situation, then some service can boot the hardened kernel based on virt-what output.\n\nSo it would only work with KVM and for all others it would use the non-grsec kernel?\n\n> If that is the situation, then some service can boot the hardened kernel based on virt-what output.\n\nThis is super difficult. virt-what is a userspace tool that requires an already running kernel. At the stage you would need to this detection, there is only grub. And doing such magic at the boot loader stage is very difficult. Another way would be to boot into a temporary kernel/system that runs the detection and then the required kernel using kexec, but this is also very difficult.\n\n-----\n\nhttps://wiki.archlinux.org/index.php/Grsecurity#Compatibility indicates, that the binary kernel *might* not work depending on Debian's config. Quote:\n\n> Xen and virtualbox are not supported (conflicts with CONFIG_PAX_KERNEXEC and CONFIG_PAX_MEMORY_UDEREF)\n\nWhat's Debian's config?\n\n-----\n\n> Yves is a Debian developer and his keys are already in the system keyring?\n\nProbably included in the `debian-keyring` package, which ships a huge aggregated public key file. With the appropriate gpg command that single key could be extracted from there and then copied to `/etc/apt/trusted.gpg.d/corsac.gpg`. I don't remember off hand but could certainly figure out this again. However, as said above I hope this route can be avoided by using Debian sid instead."},{"author":"HulaHoop","date_created":1453132554,"date_modified":1453134744,"content":"> Yes. Merge the first two packages.\n\nOK\n\n> Why are we back to using corsac's repository? Why not use Debian sid repository and apt pinning instead?\n\nWe can but for source builds it won't be possible to do on stable because dependencies. (for now)\n\n> /etc/sysctl.d/grsec.conf -> needs a digitdigit- notation. For example 30-grsec.conf or so. Trying to foresee Debian shipping that name which would then conflict with our package.\n\nI foresaw this and followed the number scheme used by Arch: 05-grsecurity.conf\n\n> So it would only work with KVM and for all others it would use the non-grsec kernel?\n\nLikely and it would need testing to determine.\n\n> This is super difficult.\n\nAnother option would be to have the grsec kernel package installed but not set as the default in grub.  On first run a script would run \n\n$ grep menuentry /boot/grub/grub.cfg | cut -d \"'\" -f2 | grep \"grsec$\"\n\nNow edit /etc/default/grub and change the GRUB_DEFAULT= line be to \"Advanced options for Debian GNU\\/Linux> followed by the kernel version string. Put the whole things in quotes, like this: GRUB_DEFAULT=\"Advanced options for Debian GNU\\/Linux>Debian GNU/Linux, with Linux 4.3.3-grsec\"\n\nbased on a user's choice from the first run wizard to enable default boot from a hardended kernel.\n\nDebian GNU/Linux, with Linux 4.3.3-grsec\n\nhttps://micahflee.com/2016/01/debian-grsecurity/\n\n> What's Debian's config?\n\nI'll check.\n\n> I don't remember off hand but could certainly figure out this again. However, as said above I hope this route can be avoided by using Debian sid instead.\n\nUp to you it depends on what want to do with source builds.\n\n"},{"author":"Patrick","date_created":1453150533,"date_modified":1453150533,"content":">> Why are we back to using corsac's repository? Why not use Debian sid repository and apt pinning instead?\n\n> We can but for source builds it won't be possible to do on stable because dependencies. (for now)\n\nAnd how does corsac's repository help with that compared to Debian sid repository?\n\nFramed this question another way: What's better/worse/different with corsac's repository vs Debian sid repository?\n\n> We can but for source builds it won't be possible to do on stable because dependencies. (for now)\n\nCannot work around that by downloading them from testing or sid? Or building inside a debootstrap sid chroot?\n\n-----\n\nI don't think we should install a grsecurity kernel by default for the first iteration. That change is too complex. Apt pinning what what not. At first it would be good to have lots of users test this so we can iron out any issues. Specifically not breaking Whonix for most users.\n\n> Up to you it depends on what want to do with source builds.\n\nI think they really matter. Since you can get some security improvements only when you compile from source, and since this is for increased security, and for advanced users, there will always be demand for it. The binary downloaded kernel would not be the full solution.\n\n> Now edit /etc/default/grub\n\nCan be avoided by using `/etc/default/grub.d` or `/etc/grub.d`? (They both work. Have a different purpose.)\n\n>> So it would only work with KVM and for all others it would use the non-grsec kernel?\n\n> Likely [...]\n\nThis is unacceptable as final solution. In the solution must potentially be room to make other platforms, Qubes [and VirtualBox] work also.\n\n-----\n\nAnyhow. I think we reached consensus on the combined grsec-conf package already. (Combination of grsec-conf and paxctld-conf.) There should be no blocker anymore that prevents you working on this?"},{"author":"HulaHoop","date_created":1453150802,"date_modified":1453150802,"content":"I'm almost done with the exceptions list. I merged some rules to cover Tor Browser and a few other binaries that weren't included. Changed some binary paths to reflect those on Debian...\n\nI will link to it shortly.\n\nWith the sheer number of exceptions I'm questioning if we should just make pax softmode = 1 in grsec conf to make PaX protections  opt-in. Hardly anything is covered anyhow: java, python, all gtk,qt, kde binaries web browsers and email clients are exempted."},{"author":"Patrick","date_created":1453151693,"date_modified":1453151693,"content":"Yes. Let's go simple for start and then see where we get."},{"author":"HulaHoop","date_created":1453152344,"date_modified":1453152344,"content":"> And how does corsac's repository help with that compared to Debian sid repository?\n\nThe idea was you can just use the stable version of gcc to compile without needing the versions in sid.\n\n> Cannot work around that by downloading them from testing or sid? Or building inside a debootstrap sid chroot?\n\nInteresting. I don't see why it shouldn't work.\n\n> I don't think we should install a grsecurity kernel by default for the first iteration. That change is too complex. Apt pinning what what not. At first it would be good to have lots of users test this so we can iron out any issues. Specifically not breaking Whonix for most users.\n\nOf course. Then it would be available in developer's only?\n\n> I think they really matter. Since you can get some security improvements only when you compile from source, and since this is for increased security, and for advanced users, there will always be demand for it. The binary downloaded kernel would not be the full solution.\n\nAgreed. We can have our cake and eat it too with the upstreaming progress thats happened.\n\n> Can be avoided by using /etc/default/grub.d or /etc/grub.d? (They both work. Have a different purpose.)\n\nOK.\n\n> This is unacceptable as final solution. In the solution must potentially be room to make other platforms, Qubes [and VirtualBox] work also.\n\nSome compatibility work for grsec to work inside Xen has happened though I can't remember where I saw it. It should work but because of Xen's design you can't have full grsec protection. Needs testing nothing is certain yet.\n\n> Anyhow. I think we reached consensus on the combined grsec-conf package already. (Combination of grsec-conf and paxctld-conf.) There should be no blocker anymore that prevents you working on this?\n\nNo blockers. I am done."},{"author":"HulaHoop","date_created":1453153531,"date_modified":1453153531,"content":"https://github.com/HulaHoopWhonix/grsec-desktop-conf\n\nSome notes: When copying paxctld all my tabbing disappeared and the file looks hideous.\n\nchangelog.upstream will give problems until its fixed up. I'll try."},{"author":"Patrick","date_created":1453159217,"date_modified":1453159309,"content":"This can very well go to the testers and also the stable repository just\nas any package. As long as it's not installed by default there really is\nno reason a against it since it requires a manual action to install that\nwon't be happening accidentally without reading documentation.\n\n- 05-grsecurity.conf needs a license header.\n\n- paxctld.conf license?\n\n- You need debian/rules using dh-systemd. See some Whonix package that ships a systemd service as example.\n\n- /etc/paxctld.conf will be owned by another package? So we cannot overwrite it just like this. dpkg would complain about a conflict and abort installing either package. In this case, and in the absence of a '.d' folder, we would have to use config-package-dev. How to do this or finding a git commit to emulate would take me longer than actually doing it. So when you are ready to not make some changes to that file for a few hours and ask me to do it, I will do it quickly.\n\n- run 'make deb-uachl-bumpup' to generate changelog.upstream and to add a second entry to the changelog (lintian would otherwise throw a warning that does not apply to us [[initial release does not close ITP bug]])\n\n- make sure you have lintian installed (sudo apt-get install lintian) and make sure it runs during 'make deb-pkg', or just run 'make deb-pkg' and then run lintian manually ('lintian'). Or better, the the right env variable to make lintian fail closed during genmkfile run.\n\nmake_use_lintian=true make deb-pkg\n\n- And after we fixed all of that, try to actually install the package (make_use_lintian=true make deb-icup) and see if it's actually working."},{"author":"HulaHoop","date_created":1453219274,"date_modified":1453219274,"content":"> needs a license header.\n\nIts all gplv3. Do you have an example?\n\n> debian/rules using dh-systemd.\n\nPlease point to a package I can emulate.\n\n> /etc/paxctld.conf will be owned by another package?\n\nI don't know. I opened a bu upstream to ask and see if some of my configs can be upstreamed.\n\nWhat do you think about?\n\n\n> With the sheer number of exceptions I'm questioning if we should just make pax softmode = 1 in grsec conf to make PaX protections opt-in. Hardly anything is covered anyhow: java, python, all gtk,qt, kde binaries web browsers and email clients are exempted.\n"},{"author":"Patrick","date_created":1453222145,"date_modified":1453222145,"content":"HulaHoop (HulaHoop):\n>   > needs a license header.\n>   \n>   Its all gplv3. Do you have an example?\n\nThese marked two lines:\n\nhttps://github.com/Whonix/sdwdate/blob/50fd9eb567da5128c53d0592ee99a75334c6efa9/lib/systemd/system/sdwdate.service#L2-L3\n\n>   > debian/rules using dh-systemd.\n>   \n>   Please point to a package I can emulate.\n\nsdwdate, control-port-filter-python, whonixcheck\n\n>   > /etc/paxctld.conf will be owned by another package?\n>   \n>   I don't know. I opened a bu upstream to ask and see if some of my configs can be upstreamed.\n>   \n>   What do you think about?\n\nUpstreaming is great so at some point we would not have to ship a\n/etc/paxctld.conf file at all anymore. But in meanwhile if you want to\nship a /etc/paxctld.conf file which is owned by another package, then we\nneed config-package-dev to do the trick."},{"author":"HulaHoop","date_created":1453236765,"date_modified":1453236861,"content":"OK did the changes but need to test package.\n\nDoes this look good now? \n\nhttps://github.com/HulaHoopWhonix/grsec-desktop-conf/blob/master/lib/systemd/system/paxctld.service\n\nEDIT:\n\nLink to upstream bug report:\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=811451"},{"author":"Patrick","date_created":1453237175,"date_modified":1453237175,"content":"debian/rules debian/control misses systemd entries."},{"author":"HulaHoop","date_created":1453395600,"date_modified":1453395600,"content":"I tried manually testing the 05-grsec.conf settings with no success. Editing the original grsec.conf doesn't work too. (I tried with the kernel conf lock setting disabled). I don't know what to try now..."},{"author":"Patrick","date_created":1453396103,"date_modified":1453396103,"content":"What does not work? The package build/install or the grsecurity kernel\nitself?\n\nIf you did not reboot you need to run 'sysctl -p' to make sysctl.d\nchanges take effect. Not sure it's useful to add to postinst since\nreboot will be required anyhow?"},{"author":"Patrick","date_created":1453396259,"date_modified":1453396259,"content":"You want softmode, right? So why use 'kernel.pax.softmode=0' instead of\n'kernel.pax.softmode=1'?"},{"author":"HulaHoop","date_created":1453430246,"date_modified":1453430277,"content":"> What does not work? The package build/install or the grsecurity kernel itself?\n\nThe grsec kernel with these settings. It doesn't matter if its 05-grsecurity.conf or the default grsec.conf are changed, the settings don't apply and so the desktop cannot boot. I restarted the system each time and i tested with sysctl restrictions turned off (a security feature that was enabled to stop code from modifying a running kernel).\n\n>  You want softmode, right? So why use 'kernel.pax.softmode=0' instead of 'kernel.pax.softmode=1'?\n\nYes I know it was set to 1."},{"author":"HulaHoop","date_created":1453750767,"date_modified":1453750767,"content":"The problem is the Debian kernel is not compiled with any virtualization support.\n\nI could ask for it but it won't solve this for the other two hypervisors you want to support - unless they are custom builds which defeats the whole purpose of a binary package."},{"author":"Patrick","date_created":1453848030,"date_modified":1453848030,"content":"Could support for all hypervisors be enabled at the same time?"},{"author":"HulaHoop","date_created":1453865008,"date_modified":1453865008,"content":"> Could support for all hypervisors be enabled at the same time?\n\nNo because different feature tradeoffs are made depending on the hypervisor."},{"author":"Patrick","date_created":1453905052,"date_modified":1453905052,"content":"What about separate binary packages per hypervisor?"},{"author":"HulaHoop","date_created":1453950854,"date_modified":1453950854,"content":"Not gonna happen. It took this long to package grsec for Debian because of their no duplicate packages policy so the patch had to be adjusted to work with the Debian flavor of the linux kernel.\n\nThe odds of them maintain different binary packages for this feature are nil.\n\nI haven't been successful in getting upstream to understand that enabling this option is simple. Related: They opted to disable Grsecurity's MAC, RBAC because its \"duplicate\" functionality to Apparmor even though they don't conflict..."},{"author":"Patrick","date_created":1453972675,"date_modified":1453972675,"content":"There is no \"no duplicate package\" policy in that sense. There is a \"no\nduplicate source code\" policy. [Compare: linux-image-686 vs\nlinux-image-686 are not considered duplicates either. Sharing the very\nsame source package.] Therefore linux-grsec-generic, linux-grsec-xen,\netc. should not be a policy issue."},{"author":"HulaHoop","date_created":1454652930,"date_modified":1454652930,"content":"Coldkernel is a project that is better at what grsecurity-installer was meant to be:\n\nhttps://github.com/coldhakca/coldkernel\n\nAdvantages:\n\n* Actively maintained and updated\n* Paxctld conf included\n* Virtualization suport for multiple hypervisors\n* Downloads over Tor (planned)\n"},{"author":"Patrick","date_created":1454671593,"date_modified":1454671593,"content":"HulaHoop (HulaHoop):\n>   https://github.com/coldhakca/coldkernel\n\nHaving had a glimpse at the code, it is still missing tons of required\nfeatures. Almost everything listed in T301. Anyhow. Good to know."},{"author":"HulaHoop","date_created":1454685666,"date_modified":1454685666,"content":"The author (Collin Childs) is associated with Tor\n\nhttps://twitter.com/Phoul"},{"author":"HulaHoop","date_created":1456771226,"date_modified":1456771226,"content":"\nOpened feature request:\n\nlinux-grsec-base: Multiple Compiled Grsec Kernels for Virtualization Compatibility\n\nhttp://bugs.debian.org/cgi-bin/bugreport.cgi?bug=816309"},{"author":"Patrick","date_created":1456782224,"date_modified":1456782224,"content":">>! In T203#8183, @HulaHoop wrote:\n> \n> Opened feature request:\n> \n> linux-grsec-base: Multiple Compiled Grsec Kernels for Virtualization Compatibility\n> \n> http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=816309\n\nAwesome! Looks like it was recognized as valid."},{"author":"HulaHoop","date_created":1456856923,"date_modified":1456856923,"content":"Unfortunately the maintainer said that its a big maintenance burden for him but is open to outside help. I asked for this functionality to be added as optional for the source package."},{"author":"HulaHoop","date_created":1493482802,"date_modified":1493482802,"content":"upstream ceased open development: https://www.grsecurity.net/passing_the_baton_faq.php"}]},"PHID-TASK-l7fb2zpalcumpuuga7j5":{"id":"202","title":"check available entropy in whonixcheck","status":"resolved","priority":"Normal","author":"Patrick","description":"It should not be an issue in most cases, but when someone attempts a port to another platform it might be an issue. Good to check for it protectively.\n\nSimilar to:\nhttps://github.com/martincmelik/Securix-Linux/blob/master/securix-control/securix-monitor#L165\n\n```\n# Check entropy available bits, 112 is FIPS-140 requirement\nENTROPYSIZE=\"$(cat /proc/sys/kernel/random/entropy_avail)\"\nif [ \"${ENTROPYSIZE}\" -lt \"112\" ]; then\n    echo \"--- PROBLEM: You have low available entropy. It can potentially affect or DoS your server/service. Install rng-tools to temporary solve it\"\n    touch \"${SECURIXVAR}/entropy.critical\"\nelse\n    echo \"--- OK: You have enough entropy available\"\n    rm -f \"${SECURIXVAR}/entropy.critical\"\nfi\n```\n","comments":[{"author":"Patrick","date_created":1429712059,"date_modified":1429712059,"content":"Done:\nhttps://github.com/Whonix/whonixcheck/commit/8d2276ec02a9fc2e0a40db20c835477c6e93c8a1\n"}]},"PHID-TASK-r27h2zrscvsek4vsln5e":{"id":"201","title":"install apparmor profiles for software developed under the Whonix umbrella by default","status":"resolved","priority":"Normal","author":"Patrick","description":"Since that software is only updated by Whonix, there is little risk of totally breaking functionality, therefore profiles can be installed by default.\n\nMerge\n\n* apparmor-profile-sdwdate\n* apparmor-profile-timesync\n* apparmor-profile-whonixcheck\n\ninto their corresponding packages.","comments":[{"author":"Patrick","date_created":1453314025,"date_modified":1453314025,"content":"- https://github.com/Whonix/sdwdate/commit/6b7407c107b55d8e2d4e8a219540d64bd173cdbe\n- https://github.com/Whonix/timesync/commit/86116241d574372566f0e17bb05f8fa2f30f43a0\n- https://github.com/Whonix/whonixcheck/commit/155071aee36895a30d65f05a2fea54667e18cfb7\n- https://github.com/Whonix/Whonix/commit/f898762006e896ea113fe7cd970ddf6535ba3aa0\n- https://github.com/Whonix/anon-meta-packages/commit/d8827700b40d03e6545e4ba9fdcf188ede8a1fb0\n"}]},"PHID-TASK-v2ejqr7tr6dwnfmcokau":{"id":"200","title":"stable-proposed-updates repository required","status":"resolved","priority":"Normal","author":"Patrick","description":"At the moment (work on Whonix `10` in progress) there is a discrepancy with Whonix's apt repository. Currently packages are Whonix `10`ish. Any fixes for Whonix `9` are difficult to test. Those packages have naturally lower version numbers. So people who just want to help testing the small fixes so they can migrate into the `stable` repository, don't really want or should use the `testers` repository, because that comes with a lot more changes. The only solution I can see so far is introducing a forth, `stable-fixes-testers` repository. Then we'd have:\n\n* `stable`\n* `stable-fixes-testers`\n* `testers`\n* `developers`\n\nIf you can think of a better solution or got a better suggestion for the name as alternative to `stable-fixes-testers`, I am all ears.","comments":[{"author":"Patrick","date_created":1425067453,"date_modified":1459366946,"content":"mitm suggested (https://forums.whonix.org/t/tickets/855/57?u=patrick) using same naming scheme as Debian, i.e. naming it `stable-proposed-updates`."},{"author":"Patrick","date_created":1459368021,"date_modified":1459368021,"content":"Debian has currently:\n\n* jessie\n* jessie-backports\n* [jessie-proposed-updates](https://wiki.debian.org/StableProposedUpdates)\n* [jessie-updates](https://wiki.debian.org/StableUpdates)\n\nQubes has currently:\n\n* jessie\n* jessie-testing\n* jessie-securitytesting\n* jessie-unstable\n\nWhonix currently has:\n\n* jessie\n* testers\n* developers\n\n-----\n\nThe Whonix approach does not scale anymore that's the reason for this ticket.\n\n-----\n\nI think Qubes securitytesting might be overkill, but I don't know the reasoning. Might be simpler to have testing only. Certainly overkill for Whonix.\n\nHas it become in Qubes jessie-testing rather than jessie-proposed-updates because of a reasoning or was proposed-updates terminology just unknown? If it was unknown, would it be considered a bug fix to mirror Debian terminology at some point? @marmarek \n\nDepending on that, to implement this I must manage to decide if I rather want to mimic the Debian or Qubes approach."},{"author":"marmarek","date_created":1459368894,"date_modified":1459368894,"content":"> I think Qubes securitytesting might be overkill, but I don't know the reasoning. Might be simpler to have testing only. Certainly overkill for Whonix.\n\nYes, overkill for Whonix. It is explained in [[ https://github.com/QubesOS/qubes-secpack/blob/master/QSBs/qsb-023-2015.txt | every QSB ]].\n\n> Has it become in Qubes jessie-testing rather than jessie-proposed-updates because of a reasoning or was proposed-updates terminology just unknown? If it was unknown, would it be considered a bug fix to mirror Debian terminology at some point? @marmarek\n\nMostly unknown terminology, we've simply mirrored Fedora names (and to match builder commands like update-repo-current-testing). But at this point IMHO changing it not worth the effort (and all the breakage it could lead to).\n\n> Depending on that, to implement this I must manage to decide if I rather want to mimic the Debian or Qubes approach.\n\nGo with Debian approach."},{"author":"Patrick","date_created":1459392742,"date_modified":1459392742,"content":"Great!\n\n-----\n\nDone:\n- https://github.com/Whonix/Whonix/commit/b95d9cb0365804c525f6beffa3aae705f6705413\n- https://github.com/Whonix/whonix-repository/commit/dbfb7a99856386dd7d087f645cbf8375345c0e7c\n- https://github.com/Whonix/whonix-setup-wizard/commit/8a20a48799f66fa256033c24313cbd9675d59725\n"},{"author":"Patrick","date_created":1461980828,"date_modified":1461980828,"content":"It works.\n\nTODO:\nActually create a jessie-proposed-updates repository."}]},"PHID-TASK-36hu53n5hc4qd5pfifjc":{"id":"199","title":"gpg-bash-lib should automatically set/unset trap, pipefail, errtrace as required","status":"resolved","priority":"Normal","author":"Patrick","description":"Quote.\n\n> A prerequisite is that you set\n> set -o pipefail\n> set -o errtrace\n\nAnd.\n\n> Before execution of this library, enable the ERR trap that it provides.\n> trap \"gpg_bash_lib_function_error_handler\" ERR\n\nIt's too inconvenient. It should be automated for simplicity and to avoid forgetting it.","comments":[{"author":"Patrick","date_created":1424781619,"date_modified":1424781619,"content":"Done:\nhttps://github.com/Whonix/gpg-bash-lib/commit/e9ec9d8993168fe3b7431405803ec9cf9d89517e\n"}]},"PHID-TASK-pgowqldamimaramq6wvb":{"id":"198","title":"TorChat broken in qubes-whonix?","status":"resolved","priority":"Normal","author":"Patrick","description":"Just a guess.\n```\ninterest-noawait /usr/share/anon-torchat/.torchat/torchat.ini\n```\nThat's probably just part of the solution. The file on the workstation that matters that gets created by the postinst script (https://github.com/Whonix/anon-torchat/blob/master/debian/anon-torchat.postinst#L30) is:\n\n```\n/home/user/.torchat/torchat.ini\n```","comments":[{"author":"Patrick","date_created":1441731109,"date_modified":1441731109,"content":"`/home/user/.torchat/torchat.ini` is now also everywhere in the usual locations.\n\n```\ngrep -r torchat\n```\n\n```\nusr/lib/qubes-whonix/replace-ips:    '/home/user/.torchat/torchat.ini',\nusr/lib/qubes-whonix/replace-ips:    '/usr/share/anon-torchat/.torchat/torchat.ini',\ndebian/qubes-whonix.triggers:interest-noawait /home/user/.torchat/torchat.ini\ndebian/qubes-whonix.triggers:interest-noawait /usr/share/anon-torchat/.torchat/torchat.ini\ndebian/qubes-whonix.postinst:                /home/user/.torchat/torchat.ini | \\\ndebian/qubes-whonix.postinst:                /usr/share/anon-torchat/.torchat/torchat.ini | \\\n```"}]},"PHID-TASK-7zdr2kfq7qflgvsom5wn":{"id":"197","title":"Starting wiki documentation for new Qubes + Whonix platform","status":"resolved","priority":"Normal","author":"WhonixQubes","description":"So based on where I'm at with my Whonix free time now...\n\nI'd like to soon get started on developing and updating the wiki documentation for the new Qubes + Whonix platform.\n\nWiki Documentation:\n- https://www.whonix.org/wiki/Qubes\n\nUnless there are any objections, I'd like to most likely start this week.\n\nSeveral people are already using the new native ProxyVM + AppVM platform.\n\nThe old Dual-HVM platform is semi-dysfunctional and highly inconvenient for supporting people doing proper VM privacy/anonymity isolation of their computing tasks, likely enabling unwarranted behavioral risks.\n\nAs requested by @Patrick my original Dual-HVM documentation will be deprecated and copied here:\n- https://www.whonix.org/wiki/Deprecated\n\nRegarding leak testing...\n\nI've done some leak testing of the new platform (Whonix 9.4 based) for myself to my own personal satisfaction to have confidence in it.\n\nI also started publishing a few of the more simplistic public leak tests in the forums.\n\n@nrgaway is gearing up to soon release newly refactored Whonix 9.6 based templates, which ITL will build and publish, which will obsolete any leak tests of Whonix 9.4 based templates of the past anyway.\n\nSo I'd like to re-order the administration tasks a bit and first get the wiki documentation switched over to the new platform.\n\nThen focus on public leak testing later. And offer clear status of leak testing progress as time goes on.\n\nSo, unless there are strong objections, I'm going to start on this soon and get something published so users can be better informed, supported, etc, with the new platform.","comments":[{"author":"Patrick","date_created":1424721632,"date_modified":1424721632,"content":"No objections from me.\n\n> As requested by @Patrick my original Dual-HVM documentation will be deprecated and copied here:\n\nSmall misunderstanding prevention:\nI only suggested to copy deprecated stuff to the Deprecated wiki page and have no opinion on the hvm vs pvm."},{"author":"WhonixQubes","date_created":1424722264,"date_modified":1424722264,"content":"Sounds good, @Patrick.\n\nRight. Understood.\n\nI am the one deciding to deprecate the original Dual-HVM platform.\n\nAnd, per suggestion, will copy the old instructions to the Whonix Deprecated page.\n\nThanks!"}]},"PHID-TASK-6j5zui5qvdg5gcyy3mdt":{"id":"196","title":"document qubes-whonix updating from Whonix APT Repository","status":"resolved","priority":"Normal","author":"Patrick","description":"> <nrgaway> apt-get update works.  when updating gateway or ws you update via the template for persistent change.  template must use gateway proxy as netvm or you will be prevented from updating\n\nI don't think this is currently documented.","comments":[{"author":"WhonixQubes","date_created":1424721281,"date_modified":1424721281,"content":"This is briefly documented here, which people are being referred to by wiki and personally:\n\nhttps://www.whonix.org/forum/index.php/topic,896.0.html\n\nAlso, just posted my plans for starting full wiki documentation for the new platform: T197"},{"author":"WhonixQubes","date_created":1426709586,"date_modified":1426709586,"content":"Resolved: https://www.whonix.org/wiki/Qubes/Binary_Update"}]},"PHID-TASK-c7afyscgu2ic64swjx2m":{"id":"195","title":"Download Table Usability Improvement","status":"resolved","priority":"Wishlist","author":"Patrick","description":"https://forums.whonix.org/t/download-page-redesign-for-kvm-qubes-and-more-needed\n","comments":[{"author":"Patrick","date_created":1438868890,"date_modified":1438868890,"content":"We deprecated the Download page, have a new platform comparison table on the main page:\nhttps://www.whonix.org/wiki/Main_Page#Download_Whonix\n\nSince my personal focus shifted to Qubes, that doesn't use the download table, I don't think anyone will work on the download table."},{"author":"Patrick","date_created":1466726078,"date_modified":1466726078,"content":"Probably done, outdated, not clear what remains to do."}]},"PHID-TASK-k35dt4kyqz2ismx7yvag":{"id":"194","title":"whonixcheck security workaround for \"apt-get update\" zero exit code discrepancy for network, gpg failures","status":"resolved","priority":"Normal","author":"Patrick","description":"upstream bug:\n[provide meaningful exit codes for network failures](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=776152)\n\nSimilar to T169. #whonixcheck should use the same workaround.","comments":[{"author":"Patrick","date_created":1424707107,"date_modified":1424707107,"content":"Done:\nhttps://github.com/Whonix/whonixcheck/commit/f0f356af26633ec6607ab347d7fb1ef1a4207a50"},{"author":"Patrick","date_created":1435621646,"date_modified":1435621646,"content":"`/usr/lib/apt-get-wrapper`:\n* https://github.com/Whonix/whonixcheck/blob/12b77823d3df94075f447212bd279e1c578ca65d/usr/lib/apt-get-wrapper\n* https://github.com/Whonix/whonixcheck/blob/master/usr/lib/apt-get-wrapper\n"}]},"PHID-TASK-jhbp3kvupb5b3xx4n6ja":{"id":"193","title":"handling of changelog for qubes-whonix package","status":"resolved","priority":"Low","author":"Patrick","description":"`debian/changelog` is supposed to be only used by the Debian packager.\n\n`changelog.upstream` (or an alternative file) is supposed to be used by upstream.\n\nAdded this here:\nhttps://github.com/adrelanos/qubes-whonix or here https://github.com/Whonix/qubes-whonix\n\nPlease merge. Unless you disagree.","comments":[{"author":"Patrick","date_created":1424647999,"date_modified":1424647999,"content":"Talked with @nrgaway about this on IRC. Summary:\n\n* @nrgaway will be upstream* with https://github.com/nrgaway/qubes-whonix.\n** *upstream as per definition of Debian packaging.\n** It will be a little bit strange, because @nrgaway will also be the one maintaining the debian maintainer scripts, i.e. postinst etc.\n* In future,\n** with my qubes-whonix contributor hat, I will git push to https://github.com/adrelanos/qubes-whonix. Any even remotely risky changes I will propose and push to https://github.com/adrelanos/qubes-whonix for @nrgaway to review and merge.\n** with my Whonix Debian packager maintainer hat, I will fetch from https://github.com/nrgaway/qubes-whonix and merge into https://github.com/Whonix/qubes-whonix.\n** https://github.com/Whonix/qubes-whonix might be ahead a very few commits, but only with almost 100% risk free changes, i.e. bumping version numbers and signing git tags. No functional changes. `debian/changelog` will only say \"bumped debian/changelog\".\n* @nrgaway will maintain `upstream.changelog`.\n** Feel free to totally wipe and rewrite `upstream.changelog`. No need to use the cheap autogenerated changelog.upstream which is just a \"git log\". You could use the same style as [currently in debian/changelog](https://github.com/Whonix/qubes-whonix/blob/6ff6f30233e2a5d9434691c5b4b910600e20d36f/debian/changelog). Whatever you prefer.\n\nPlease feel free to correct my summary.\n"},{"author":"Patrick","date_created":1431516012,"date_modified":1431516012,"content":"Opened a pull request for this one:\nhttps://github.com/nrgaway/qubes-whonix/pull/1\n"},{"author":"Patrick","date_created":1432399507,"date_modified":1432399507,"content":"Was merged (https://github.com/nrgaway/qubes-whonix/pull/1#issuecomment-102685084) by nrgaway."}]},"PHID-TASK-dgxin42roeqwl3f5ai5g":{"id":"192","title":"TBB's use of SocksSocket will break Whonix's Tor Browser implementation","status":"resolved","priority":"Normal","author":"Patrick","description":"__Impact__:\n\nTor Browser developers plan changes that would break Whonix's [Tor over Tor](https://www.whonix.org/wiki/DoNot#Prevent_Tor_over_Tor_scenarios.) prevention. Changes, that would make it hard for manually downloaded, unmodified TBB tarballs to work in Whonix out of the box while preventing Tor over Tor.\n\n__Details__:\n\nThe current implementation of `anon-ws-disable-stacked-tor` using `rinetd` ([design documentation, see footnote](https://www.whonix.org/wiki/Tor_Browser#Whonix_Proxy_Settings)) will not work forever.\n\nTor [implemented](https://blog.torproject.org/blog/tor-0263-alpha-released) [`SocksSocket`](https://trac.torproject.org/projects/tor/ticket/12585) option ([unix domain sockets](https://en.wikipedia.org/wiki/Unix_domain_socket)) version `0.2.6.3-alpha`. Tor Browser will start using . ([Reference](https://trac.torproject.org/projects/tor/ticket/14270))\n\nTo make things worse, currently the environment variables `TOR_SOCKS_HOST` and `TOR_SOCKS_PORT` are broken. ([upstream bug report](https://trac.torproject.org/projects/tor/ticket/8336)) \n\n~~__Related Upstream Bug__:~~\n\n~~[torrc's SocksSocket breaks tor-service-defaults-torrc's SocksPort](https://trac.torproject.org/projects/tor/ticket/15261)~~\n\n__Solution?__\n\nWe might be able to solve this using `socat`. Because `socat` is apparently able to man-in-the-middle unix domain sockets. By using something like this (untested). ([source](https://unix.stackexchange.com/questions/169228/how-does-moving-a-unix-domain-socket-enable-socat-to-monitor-traffic))\n\n```\nsudo mv /path/to/sock /path/to/sock.original\nsudo socat -t100 -x -v UNIX-LISTEN:/path/to/sock,mode=777,reuseaddr,fork UNIX-CONNECT:/path/to/sock.original\n```\n\nWe might be able to redirect that unix domain socket to Whonix-Gateway.\n\nEither directly to Whonix-Gateway (if we want to abolish `rinetd`).\n\n```\nsudo socat -t100 -x -v UNIX-LISTEN:/path/to/sock,mode=777,reuseaddr,fork TCP4:10.152.152.10:9150\n```\n\nOr to existing `rinetd` to keep things simpler for custom gateway IP's and #qubes.\n\n```\nsudo socat -t100 -x -v UNIX-LISTEN:/path/to/sock,mode=777,reuseaddr,fork TCP4:127.0.0.1:9150\n```\n\nTiming the renaming of TBB's unix domain socket file so we can intercept and redirect it seems difficult and error prone. Therefore it would be best if TBB supported an environment variable to connect to existing unix domain socket files. -> [upstream feature request](https://trac.torproject.org/projects/tor/ticket/14272#comment:3)\n\n__Dev Test Toolbox__:\n\nFor installation of Tor that comes with the SocksSocket option. /etc/apt/sources.list.d/torproject.list\n```\ndeb http://deb.torproject.org/torproject.org tor-experimental-0.2.6.x-wheezy main\n```\n\n/etc/apparmor.d/local/system_tor AppArmor permission.\n```\n  /{,var/}run/tor/socket rw,\n```\n\n/etc/tor/torrc\n```\nSocksSocketsGroupWritable 1\nSocksPort unix:/var/run/tor/socket\n```\n\nTest if the socket can be talked to.\n\n```\nsocat - UNIX-CONNECT:/var/run/tor/socket\nGET\n```\n\nCreate unix domain socket file /home/user/test.socket and forward to /var/run/tor/socket as proof of concept.\n\n```\nsudo socat -t100 -x -v UNIX-LISTEN:/home/user/test.socket,mode=777,reuseaddr,fork UNIX-CONNECT:/var/run/tor/socket\n```\n\nTest if the socket can be talked to.\n\n```\nsocat - UNIX-CONNECT:./test.socket\nGET\n```\n\nProof of concept is functional.\n\n-----\n\nForum user support thread:\nhttps://forums.whonix.org/t/tor-browser-6-5a4-connectivity-broken-blocked-by-apparmor-profile-since-tbb-changed-to-sockssocket","comments":[{"author":"Patrick","date_created":1440040507,"date_modified":1440040507,"content":"```\n    Try to cope up with planned changes by the Tor Browser Bundle (TBB) developers. Try keeping Tor Browser being able to connect while preventing Tor over Tor.\n    The Tor Project (TPO) plans ( https://trac.torproject.org/projects/tor/ticket/14270 ) to modify TBB to use unix domain sockets (Tor SocksSocket option) instead of TCP to talk to Tor.\n    To make things worse, currently the environment variables TOR_SOCKS_HOST and TOR_SOCKS_PORT are broken. ( upstream bug report: https://trac.torproject.org/projects/tor/ticket/8336 )\n    Therefore creating unix domain sockets using socat in folder /var/run/anon-ws-disable-stacked-tor that are forwarded rinetd on localhost which forwards them to the gateway.\n    (Not directly forwarding those to the gateway to make the Qubes implementation simpler. This way no IP replacement is required.)\n    Optimistically setting environment variables to configure TBB in hope that those are later implemented by TPO.\n    export TOR_PRE_EXIST_UNIX_SOCKET_SOCKS=\"/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9150.sock\"\n    export TOR_PRE_EXIST_UNIX_SOCKET_CONTROL=\"/var/run/anon-ws-disable-stacked-tor/127.0.0.1_9151.sock\"\n    As long it is ignored, there is no harm.\n    And once Tor Browser supports it, chances are better that it is still able to make connections See also:\n    - https://trac.torproject.org/projects/tor/ticket/14272#comment:3\n    - https://phabricator.whonix.org/T192\n```\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/commit/c246d61189015f14e806fbb34bfade5d6cfe6e3c"},{"author":"Patrick","date_created":1440040732,"date_modified":1440040732,"content":"Nothing else can be done here before The Tor Project proceeds."},{"author":"Patrick","date_created":1441758635,"date_modified":1441758635,"content":"`added missing systemd directions - https://phabricator.whonix.org/T192#6573`:\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/commit/db8df21d02798819ffd6c2b143e8eab246c748a9\n"},{"author":"Patrick","date_created":1459172445,"date_modified":1459172445,"content":"Other crazy approaches:\n\n* a) ld preload magic\n* b) search and replace Tor binary\n"},{"author":"marmarek","date_created":1459212747,"date_modified":1459212747,"content":"How is Tor started in TBB? If it is possible to disable it (I hope so), there should be no race condition with it. When user start TBB, the socket should be already there, and wont be overwritten because Tor is disabled. Right?"},{"author":"Patrick","date_created":1459265343,"date_modified":1459265343,"content":"marmarek (Marek Marczykowski-Górecki):\n> How is Tor started in TBB?\n\nIn a nutshell:\n\n1) Tor Browser (which is a Firefox with patches by TPO) starts with its\nmain window hidden by default.\n\n2) Tor Launcher (which is a Firefox addon) provides the connection\nwizard window.\n\n3) Then Tor Launcher starts Tor and allows Tor Browser to open its main\nwindow.\n\n4) Then Tor Browser uses 127.0.0.1 9150 (Socks) / 9151 (Control).\n\n5) In Whonix-Workstation we redirect these local ports to the\nWhonix-Gateway.\n\n(\nhttps://www.whonix.org/wiki/Tor_Browser#tor-launcher_vs_torbrowser-launcher\n)\n\n> If it is possible to disable it (I hope\n> so),\n\nWe are already disabling the bundled Tor that comes with Tor Browser.\n\n( https://www.whonix.org/wiki/Tor_Browser#tor-launcher )\n\n> there should be no race condition with it.\n\nNo race condition indeed.\n\n> When user start TBB,\n> the socket should be already there,\n\nYes, Tor Browser would require the socket to be already existing.\n\n> and wont be overwritten because\n> Tor is disabled. Right?\n\nYes.\n\nNow the problem is, when they implement this, they might expect the\nsocket to be existing in\n`~/.tb/tor-browser/Browser/TorBrowser/Data/Tor/`. Writing into the home\nfolder is troublesome. And in past they changed the folder structure\nquite often so things could break.\n\nTo keep things stable connected, I requested the following environment\nvariables.\n\n- `TOR_PRE_EXIST_UNIX_SOCKET_SOCKS`\n- `TOR_PRE_EXIST_UNIX_SOCKET_CONTROL`\n\nhttps://trac.torproject.org/projects/tor/ticket/14272#comment:3\n\nAt the moment I can only wait what TPO says / does next."},{"author":"HulaHoop","date_created":1459709997,"date_modified":1459709997,"content":"Ricochet is moving to UNIX sockets too:\n\nhttps://twitter.com/ioerror/status/716633244033220608"},{"author":"Patrick","date_created":1473601827,"date_modified":1473601827,"content":"In latest torbutton version there already is environment variable `TOR_CONTROL_SOCKET`.\n\nThere will be another one for the path to socks socket file. [Asked](https://trac.torproject.org/projects/tor/ticket/20111#comment:5) what path that will be."},{"author":"Patrick","date_created":1473799140,"date_modified":1473799140,"content":"Got an answer. Will be probably `TOR_SOCKS_SOCKET`.\n\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/commit/ad86ce9d4285c5f749697c0d3bf34c37ac39eb2f\n"},{"author":"Patrick","date_created":1479407903,"date_modified":1479407943,"content":"The variable names ended up being:\n\n* `TOR_SOCKS_IPC_PATH`\n* `TOR_CONTROL_IPC_PATH`\n\nHappy to report that Whonix `14` with Tor Browser `6.5a4-hardened` unix domain socket files redirection works for me."},{"author":"Patrick","date_created":1480171914,"date_modified":1480171914,"content":"#anon-ws-disable-stacked-tor stable upgrade package was released:\nhttps://forums.whonix.org/t/tor-browser-6-5a4-connectivity-broken-blocked-by-apparmor-profile-since-tbb-changed-to-sockssocket/3154/10?u=patrick\n"},{"author":"Patrick","date_created":1480290607,"date_modified":1480290607,"content":"* https://github.com/Whonix/anon-ws-disable-stacked-tor/commit/24421e2dadbcec6911ecb41bc8f7fce5b23a018f\n* https://github.com/Whonix/anon-ws-disable-stacked-tor/commit/678d81fd2d1a87517c54874792b6d18935507878\n"}]},"PHID-TASK-7b2xayydowr5cmfngynn":{"id":"191","title":"Consider qubes-whonix-tests package","status":"wontfix","priority":"Normal","author":"WhonixQubes","description":"If we would like to have dev/test code or scripts for the `qubes-whonix` package, then I would like to establish a policy of isolating them out into an independent package that is not installed by default, but can be optionally installed by users on-demand.\n\nThis is for achieving more simple, efficient, clearer security audits of the `qubes-whonix` package codebase and removing attack surface for 1st and 3rd party apps.\n\nAdditional discussion on this in these forum posts...\n\n- https://www.whonix.org/forum/index.php/topic,961.msg6999.html#msg6999\n- https://www.whonix.org/forum/index.php/topic,961.msg7010.html#msg7010\n- https://www.whonix.org/forum/index.php/topic,961.msg7012.html#msg7012\n- https://www.whonix.org/forum/index.php/topic,961.msg7014.html#msg7014\n- https://www.whonix.org/forum/index.php/topic,961.msg7017.html#msg7017\n- https://www.whonix.org/forum/index.php/topic,961.msg7035.html#msg7035\n\nSo, if we would like to include such dev/test code and scripts, I propose we establish a `qubes-whonix-tests` package for them.\n\nAlternatively, we could just have a policy of leaving them out entirely for `qubes-whonix`, but I do see their positive uses in software and am not philosophically opposed. Just looking for default isolation of such non-production code/scripts.\n\nRight now, @nrgaway is writing the majority of code for the `qubes-whonix` package, so if he would like to simply leave them all out for simplicity of not dealing with an additional `qubes-whonix-tests` package, then I would be okay with that.\n\nSimilarly, this isolated \"-tests\" package principle could be considered for other Whonix packages, but I will let @Patrick and others decide upon these other Whonix packages at this time.\n\n#qubes","comments":[{"author":"WhonixQubes","date_created":1425109153,"date_modified":1425109153,"content":"Additional discussion:\n\n- https://www.whonix.org/forum/index.php/topic,961.msg7039.html#msg7039\n\n- https://www.whonix.org/forum/index.php/topic,961.msg7040.html#msg7040\n\n- https://www.whonix.org/forum/index.php/topic,961.msg7045.html#msg7045\n\n- https://www.whonix.org/forum/index.php/topic,961.msg7046.html#msg7046\n\n- https://www.whonix.org/forum/index.php/topic,961.msg7076.html#msg7076\n\n- https://www.whonix.org/forum/index.php/topic,961.msg7121.html#msg7121\n\n- https://www.whonix.org/forum/index.php/topic,961.msg7138.html#msg7138\n\n- https://www.whonix.org/forum/index.php/topic,961.msg7139.html#msg7139\n\nConcluding that extra \"-tests\" packages won't be pursued."}]},"PHID-TASK-hi76ppvxnq5zpw74khat":{"id":"190","title":"whonix-setup-wizard polishing","status":"invalid","priority":"Normal","author":"troubadour","description":"Task created for the miscellaneous standard compatibility and improvement updates to whonix-setup-wizard.\n\ncommand line parameter parsing in https://github.com/troubadoour/whonix-setup-wizard/commit/98e6ff2f7a0318c2a1a73c793a66b94aeed1c16c","comments":[{"author":"Patrick","date_created":1424204625,"date_modified":1424204625,"content":"Looks good. Merged.\n\nFor starting from command line, what would be good would be a helpful default output if not argument was given."},{"author":"troubadour","date_created":1424211976,"date_modified":1424211976,"content":"https://github.com/troubadoour/whonix-setup-wizard/commit/ab7348d85cf9b0f5df9498a3040aafa971613e2e\n\n`argparse` handles nicely all the situations. Will change `url_to_unixtime` too."},{"author":"Patrick","date_created":1424251672,"date_modified":1424251672,"content":"Nice. Merged."},{"author":"Patrick","date_created":1427998129,"date_modified":1427998129,"content":"Can the Whonix 10 tag be removed?"},{"author":"troubadour","date_created":1428085004,"date_modified":1428085004,"content":"Yes, nothing critical."},{"author":"Patrick","date_created":1513626776,"date_modified":1513626776,"content":"Not clear what's missing."}]},"PHID-TASK-xp22smevondewp3mwn56":{"id":"189","title":"document versioning format conventions","status":"resolved","priority":"Normal","author":"Patrick","description":">>! In T188#2307, @WhonixQubes wrote:\n> @Patrick is there documentation that describes the versioning format conventions used for the structure and incrementing of other Whonix packages?\n\n","comments":[{"author":"Patrick","date_created":1424182732,"date_modified":1424182732,"content":"Done:\nhttps://www.whonix.org/wiki/Dev/Versioning_Format_Conventions\n\nAny questions? Any feedback? @WhonixQubes"},{"author":"WhonixQubes","date_created":1424401230,"date_modified":1424401230,"content":"Looks good for documenting the process.\n\nWould suggest also documenting what the components are of the numbering format and how the numbers increment.\n\nLike:\n\n- What is the original starting point for package version numbers?\n\n- The numbering format is \"X:X.X-X\" or \"X.X-X\"?\n\n- What does the \"X:\" position represent?\n\n- What does the \"X.\" position represent?\n\n- What does the \".X\" position represent?\n\n- What does the \"-X\" position represent?\n\n- Does \"1.9\" increment to \"1.10\" or \"2.0\"?\n\n- Anything else you think of related to understanding the numbering format.\n\nThanks!"},{"author":"Patrick","date_created":1424424943,"date_modified":1424424943,"content":"Done on the wiki page. Please check."},{"author":"WhonixQubes","date_created":1424439501,"date_modified":1424439501,"content":"All looks good."}]},"PHID-TASK-pcplruxkrh4fv2jcwnzs":{"id":"188","title":"qubes-whonix package version numbers","status":"resolved","priority":"High","author":"Patrick","description":"One last thing before adding the qubes-whonix package to Whonix's repository. (T182) We should discuss which version scheme to use.\n\nI mindlessly bumped the version number in [`debian/changelog`](https://github.com/Whonix/qubes-whonix/blob/master/debian/changelog) from `(0:9.6-1)` to `(0:9.7-1)`. (Did that, because the changelog needs to include at least two entries (otherwise we run into the \"requires close ITP\" lintian warning).\n\nNow realized, that you want to make the version numbers of the package on par with Whonix release.\n\nI don't think this is going to work out well. Let's say I or you made a signed git tag using `9.6`. Then realized, that we need any last minute fixes. What version number would we use then? Deleting git tags seems out of question. (Users who already got them, won't get them overridden by git design for security reasons. Unless they manually delete them, there would be two different git tags in the wild pointing to different git hashes.) Or another case. Let's say you wanted to make the package work with Whonix 10, but there are no final tags for it yet.\n\nWhat about using a version scheme that is independent from the Whonix release?","comments":[{"author":"WhonixQubes","date_created":1424159183,"date_modified":1424159183,"content":"Maybe what @nrgaway was intending was to bump the trailing dash number suffix, like from `9.6-1` to `9.6-2` etc.\n\nI had been thinking something similar as @Patrick that anchoring the `qubes-whonix` package versioning to the main Whonix version might be too rigid and limiting in various cases.\n\nOr falsely anchoring to the main Whonix version could put social pressure on a new package version release, even when one is not needed for `qubes-whonix`, as some people might be confused and assume `qubes-whonix` is out of date every single time the Whonix version goes up. As some Whonix releases probably won't affect `qubes-whonix` at all.\n\nMaybe having normal independent versioning of `qubes-whonix` like the other Whonix packages would be okay?"},{"author":"WhonixQubes","date_created":1424160114,"date_modified":1424160114,"content":"@Patrick is there documentation that describes the versioning format conventions used for the structure and incrementing of other Whonix packages?"},{"author":"Patrick","date_created":1424180991,"date_modified":1424180991,"content":"Yes.\n\n>>! In T188#2305, @WhonixQubes wrote:\n> Maybe what @nrgaway was intending was to bump the trailing dash number suffix, like from `9.6-1` to `9.6-2` etc.\n\nThat would work, but it would be a very hackish solution. Trailing dash numbers are for Debian revisions as per Debian policy. Only supposed to be changed if upstream code didn't change, but if the Debian packaging changed.\n\n>>! In T188#2307, @WhonixQubes wrote:\n> @Patrick is there documentation that describes the versioning format conventions used for the structure and incrementing of other Whonix packages?\n\nCreated T189 for it."},{"author":"nrgaway","date_created":1424294192,"date_modified":1424294192,"content":"Then I would use 9.6.1, 9.6.2\n"},{"author":"Patrick","date_created":1424373955,"date_modified":1424373955,"content":"What if we reach `9.9`? I was wondering about such cases. Hopefully would never happen. We're not that far away with `9.6`. Then I'd use for Whonix `9.9.1`, 2, 3, etc. Which would confuse that plan."},{"author":"nrgaway","date_created":1424638736,"date_modified":1424638736,"content":"After 9.9 is 9.10 :)  Yes it may look confusing if you are interpreting the 10 as a decimal point, but for software this is common practise.\n\nI changed by version scheme to use `9.6.x` since the `qubes-whonix` code is so closely tied to Whonix versions.  It is very possible that no changes would need to be done to `qubes-whonix` for a 9.8  Whonix release, and in that case would carry on using 9.6 version or just create a new tag.\n\nI changed the `debian/changelog` to reflect the version change so you will have a merge conflict.\n\nI also added a `version` file in the root directory that contains the current version number.  It is used within `qubes-builder` to increase the `debian/changelog` version and history.\n\nI also created a `Whonix9` branch within the `qubes-whonix` repo as that is where all `qubes-whonix` code and tags related to `Whonix9` will reside (stable).  I will soon create a `Whonix10` branch to begin packaging for it as well.  I plan on using the `master` branch for development.\n\nI am thinking you can use an epoc of 1, where I use an epoc of 0.  That should resolve any conflicts you are having and you can then version the Debian package the same as mine for the initial version like follows:\n\nnrgaway repo version:\n- 0:9.6.2-1\n\nWhonix/Patrick version:\n- 1:9.6.2-1\n- 1:9.6.2-2 - Some change you make different from upstream\n- 1:9.6.2-3 - Some more changes you make different from upstream\n\nIf you still have an issue with my name as a maintainer, just replace it with yours or do what ever is required to make this a smooth process.\n\nThis should remove the last blocker as currently listed in T182. If you are satisfied with these changes, I would ask if you could create a signed version tag since I am using your git repo to do the actual building of the `qubes-whonix` package and it fails when a tag is not signed or present.\n\n\nAny time I release an update I will bump version, so next version will be:\n- 0:9.6.3-1"},{"author":"Patrick","date_created":1424644421,"date_modified":1424644421,"content":"Sounds good.\n\n>>! In T188#2392, @nrgaway wrote:\n> I changed the `debian/changelog` to reflect the version change so you will have a merge conflict.\n\nIf you could merge and add on top, I would prefer that. Not a big deal in this case. But in other cases, perhaps I am just a bit inexperienced with merge conflict resolution.\n\n> If you still have an issue with my name as a maintainer\n\nNone.\n\n> I am thinking you can use an epoc of 1, where I use an epoc of 0. That should resolve any conflicts you are having and you can then version the Debian package the same as mine for the initial version like follows:\n\nYou lost me here. What conflicts do you mean?\nAn epoch of 1 will always and forever take precedence over an epoch of 0."},{"author":"Patrick","date_created":1424644833,"date_modified":1424644833,"content":"Got time for IRC at this moment? Still wondering on how to do a few things..."},{"author":"nrgaway","date_created":1424645094,"date_modified":1424645094,"content":"I was talking about the version conflict you had with Debian package lintian warnings (\"requires close ITP\" lintian warning.  Now there are more than 2 log entries this may not be the case anymore.\n\nI just thought the version number of 9.7-1 was confusing.  Anyway, if there is no problem with lintian anymore you could just version it as 9.6.2-1?  or something like that.  The only reason I suggested epoc of one was to override my versions always while being able to keep same version numbers."},{"author":"Patrick","date_created":1424645612,"date_modified":1424645612,"content":"> I was talking about the version conflict you had with Debian package lintian warnings (\"requires close ITP\" lintian warning.\n\nAh. (Anyhow, but epoch wouldn't help there.)\n\n> Now there are more than 2 log entries this may not be the case anymore.\n\nOk.\n\n> Anyway, if there is no problem with lintian anymore you could just version it as 9.6.2-1?\n\nThere are still lintian issues (T186), but those aren't a blocker here.\n\n> could just version it as 9.6.2\n\nTagged as `9.6.2` and pushed to github.\n\nThere could be one issue. The one I wanted to talk about. My branch is 1 commit ahead. Added `changelog.upstream` as well as upstream changelog creation to `debian/rules`.\n\nIf that is no issue, I can upload it to Whonix's APT repository. (T182)"},{"author":"Patrick","date_created":1424648283,"date_modified":1424648283,"content":"Sorted that out. Summary of IRC discussion can be found here:\nhttps://phabricator.whonix.org/T193#2430\n\n-----\n\nFrom my side, feel free to close this... Or discuss further... Or change... Thanks to Debian packaging's epoch feature, the version format can always be changed."},{"author":"Patrick","date_created":1432767447,"date_modified":1432767447,"content":"Closeable? @nrgaway?"}]},"PHID-TASK-okjkkxefgxa7ub6q7hml":{"id":"187","title":"Architecture: \"any\" vs \"all\", i386, platforms support","status":"resolved","priority":"High","author":"Patrick","description":"Unless there are any objections, I think we should change in `debian/control` from.\n```\nArchitecture: any\n```\nThat would create a file `qubes-whonix_9.7-1_i386.deb`. To...\n\n```\nArchitecture: all\n```\n\nThat creates a file `qubes-whonix_9.7-1_all.deb`.\n\nWhy?\n\n* It's not i386 dependent.\n* If anything, surely it's not i386?\n* It's not dependent on any platform.\n* We like to add a `all` package to the repository. (T182)\n* Causes issues with #makefile-generic-packages that currently hardcodes `all`. (Maybe that's a bug that should be fixed for #Whonix_11 ?)\n* High priority, because it currently breaks Whonix's build script.","comments":[{"author":"Patrick","date_created":1424157702,"date_modified":1424157702,"content":"Done:\nhttps://github.com/Whonix/qubes-whonix/commit/5a13ac2617c974128cfb2b3b4c0613cb91ca3cfd\n\nPlease review."},{"author":"WhonixQubes","date_created":1424159397,"date_modified":1424159397,"content":"Looks good to me."},{"author":"nrgaway","date_created":1424294348,"date_modified":1424294348,"content":"I will test it out here but do not see any issues with it at the moment"},{"author":"nrgaway","date_created":1424635897,"date_modified":1424635897,"content":"I changed `Architecture` in the control file to `all` [[ https://github.com/nrgaway/qubes-whonix/commit/e52bc1e577dbfef08a0d564961b5a72ccce8a59b | https://github.com/nrgaway/qubes-whonix/commit/e52bc1e577dbfef08a0d564961b5a72ccce8a59b ]] (Git commit message is mis-labelled; says I changed it from all to any when I really changed it from any to all :)\n\nYou are correct as the files are building and create a file similar to `qubes-whonix_9.7-1_all.deb`.  I actually believe though that the former `any` may be more correct if there are any packages that may be hardware dependant since in that case builds need to be compiled against the multi-architectures  When built via qubes-builder with the `Architecture` set to `any` the file that is created looks like this: `qubes-whonix_9.7-1_amd64.deb` as it was built within an amd64 environment.\n\nIn our case there would not be much of an issue since there is no hardware dependent scripts contained within qubes-whonix so `all` would be most correct in this scenario I would agree.\n\nLooks like this issue can be removed as a blocker now?"},{"author":"Patrick","date_created":1424643191,"date_modified":1424643191,"content":"If you merged\nhttps://github.com/Whonix/qubes-whonix/commit/5a13ac2617c974128cfb2b3b4c0613cb91ca3cfd then there would have been no need for https://phabricator.whonix.org/T187 but nevermind.\n\nCan be considered resolved, as always, feel free to reopen."}]},"PHID-TASK-ntoscyana76ndr4ej3cp":{"id":"186","title":"many lintian warnings in qubes-whonix package","status":"resolved","priority":"Normal","author":"Patrick","description":"As of qubes-whonix [731e3e8ab0a5958341a96c4d4877b72ea0084209](https://github.com/Whonix/qubes-whonix/commit/731e3e8ab0a5958341a96c4d4877b72ea0084209):\n\n```\n+ lintian --pedantic --info --display-info --fail-on-warnings\nI: qubes-whonix: output-of-updaterc.d-not-redirected-to-dev-null tor postinst\nN: \nN:    The output messages of the update-rc.d command should be redirected to\nN:    /dev/null because it is currently very chatty per default.\nN:    \nN:    Severity: wishlist, Certainty: certain\nN:    \nN:    Check: init.d, Type: binary\nN: \nI: qubes-whonix: output-of-updaterc.d-not-redirected-to-dev-null sdwdate postinst\nI: qubes-whonix: output-of-updaterc.d-not-redirected-to-dev-null network-manager postinst\nI: qubes-whonix: output-of-updaterc.d-not-redirected-to-dev-null spice-vdagent postinst\nI: qubes-whonix: output-of-updaterc.d-not-redirected-to-dev-null swap-file-creator postinst\nI: qubes-whonix: output-of-updaterc.d-not-redirected-to-dev-null whonix-initializer postinst\nE: qubes-whonix: postrm-does-not-call-updaterc.d-for-init.d-script etc/init.d/spice-vdagent\nN: \nN:    An /etc/init.d script which has been registered in the postinst script\nN:    is not de-registered in the postrm script.\nN:    \nN:    Refer to Debian Policy Manual section 9.3.3.1 (Managing the links) for\nN:    details.\nN:    \nN:    Severity: important, Certainty: certain\nN:    \nN:    Check: init.d, Type: binary\nN: \nE: qubes-whonix: postrm-does-not-call-updaterc.d-for-init.d-script etc/init.d/sdwdate\nE: qubes-whonix: postrm-does-not-call-updaterc.d-for-init.d-script etc/init.d/whonix-initializer\nE: qubes-whonix: postrm-does-not-call-updaterc.d-for-init.d-script etc/init.d/swap-file-creator\nE: qubes-whonix: postrm-does-not-call-updaterc.d-for-init.d-script etc/init.d/network-manager\nE: qubes-whonix: postrm-does-not-call-updaterc.d-for-init.d-script etc/init.d/tor\nW: qubes-whonix: init.d-script-not-marked-as-conffile etc/init.d/spice-vdagent\nN: \nN:    /etc/init.d scripts should be marked as conffiles.\nN:    \nN:    This is usually an error, but the Policy allows for managing these files\nN:    manually in maintainer scripts and Lintian cannot reliably detect that.\nN:    \nN:    Refer to Debian Policy Manual section 9.3.2 (Writing the scripts) for\nN:    details.\nN:    \nN:    Severity: important, Certainty: wild-guess\nN:    \nN:    Check: init.d, Type: binary\nN: \nE: qubes-whonix: init.d-script-not-included-in-package etc/init.d/spice-vdagent\nN: \nN:    The /etc/init.d script is registered in the postinst script, but is not\nN:    included in the package.\nN:    \nN:    Severity: important, Certainty: certain\nN:    \nN:    Check: init.d, Type: binary\nN: \nW: qubes-whonix: init.d-script-not-marked-as-conffile etc/init.d/sdwdate\nE: qubes-whonix: init.d-script-not-included-in-package etc/init.d/sdwdate\nW: qubes-whonix: init.d-script-not-marked-as-conffile etc/init.d/whonix-initializer\nE: qubes-whonix: init.d-script-not-included-in-package etc/init.d/whonix-initializer\nW: qubes-whonix: init.d-script-not-marked-as-conffile etc/init.d/swap-file-creator\nE: qubes-whonix: init.d-script-not-included-in-package etc/init.d/swap-file-creator\nW: qubes-whonix: init.d-script-not-marked-as-conffile etc/init.d/network-manager\nE: qubes-whonix: init.d-script-not-included-in-package etc/init.d/network-manager\nW: qubes-whonix: init.d-script-not-marked-as-conffile etc/init.d/tor\nE: qubes-whonix: init.d-script-not-included-in-package etc/init.d/tor\nW: qubes-whonix: script-not-executable etc/uwt.d/32_qubes\nN: \nN:    This file starts with the #! sequence that marks interpreted scripts,\nN:    but it is not executable.\nN:    \nN:    Severity: normal, Certainty: certain\nN:    \nN:    Check: scripts, Type: binary\nN: \nE: qubes-whonix: python-script-but-no-python-dep usr/lib/qubes-whonix/alert\nN: \nN:    Packages with Python scripts should depend on the package python. Those\nN:    with scripts that specify a specific version of Python must depend on\nN:    that version of Python (exactly).\nN:    \nN:    For example, if a script in the package uses #!/usr/bin/python, the\nN:    package needs a dependency on python. If a script uses\nN:    #!/usr/bin/python2.6, the package needs a dependency on python2.6. A\nN:    dependency on python (>= 2.6) is not correct, since later versions of\nN:    Python may not provide the /usr/bin/python2.6 binary.\nN:    \nN:    If you are using debhelper, adding ${python:Depends} to the Depends\nN:    field and ensuring dh_pysupport or dh_pycentral are run during the build\nN:    should take care of adding the correct dependency.\nN:    \nN:    In some cases a weaker relationship, such as Suggests or Recommends,\nN:    will be more appropriate.\nN:    \nN:    Severity: important, Certainty: certain\nN:    \nN:    Check: scripts, Type: binary\nN: \nE: qubes-whonix: python-script-but-no-python-dep usr/lib/qubes-whonix/init/replace-ips\nW: qubes-whonix: script-not-executable usr/lib/qubes-whonix/utility_functions.sh\nW: qubes-whonix: maintainer-script-ignores-errors preinst\nN: \nN:    The maintainer script doesn't seem to set the -e flag which ensures that\nN:    the script's execution is aborted when any executed command fails.\nN:    \nN:    Refer to Debian Policy Manual section 10.4 (Scripts) for details.\nN:    \nN:    Severity: normal, Certainty: certain\nN:    \nN:    Check: scripts, Type: binary\nN: \nW: qubes-whonix: maintainer-script-ignores-errors postrm\nW: qubes-whonix: maintainer-script-ignores-errors prerm\nW: qubes-whonix: maintainer-script-ignores-errors postinst\nN: 2 tags overridden (2 warnings)\n```\n\nMost of these warnings have already been reported by me in separate tickets.\n\nThere could be a few disagreements about some of them. Anyhow.\n\nA few are easy to fix (maintainer-script-ignores-errors...).","comments":[{"author":"Patrick","date_created":1439669428,"date_modified":1439669428,"content":"Those are all fixed in latest master."}]},"PHID-TASK-dhpayjgzwzo5sqezlemd":{"id":"185","title":"reply to maniphest tasks by e-mail","status":"resolved","priority":"Normal","author":"Patrick","description":">>! In T176#2227, @nrgaway wrote:\n> Another thing to note is that the email notifications I receive do not seem to have a proper return email address so a reply can be made from email to a subject tag.  The return address displays as 'noreply@phabricator.example.com' in my email reader.\n\nCould be doable:\nhttps://secure.phabricator.com/book/phabricator/article/configuring_inbound_email/\n\nNOTE: The entire contents of your email will be included in the post, so remove the quoted part before you send it.","comments":[{"author":"fortasse","date_created":1425334291,"date_modified":1425334291,"content":"I'm commenting on this to check what address the outbound mail comes from."},{"author":"fortasse","date_created":1425334325,"date_modified":1425334325,"content":"Works as expected, I'll work on inbound now."},{"author":"fortasse","date_created":1425335426,"date_modified":1425335426,"content":"I'm am posting this comment on the web interface."},{"author":"fortasse","date_created":1425335464,"date_modified":1425335464,"content":"I'm replying to my hastily written, grammatically incorrect post with email."},{"author":"Patrick","date_created":1425335737,"date_modified":1425335737,"content":"fortasse (fortasse):\n> fortasse added a comment.\n> \n> I'm replying to my hastily written, grammatically incorrect post with email.\n\nTesting reply via e-mail."},{"author":"Patrick","date_created":1425335870,"date_modified":1425335870,"content":"@nrgaway this is now implemented. You can now reply also via e-mail.\n\nThis is amazing, @fortasse!\n\n!close"},{"author":"Patrick","date_created":1425335923,"date_modified":1425335923,"content":"Closing now.\n\nMail content was:\n\n```\n!close\n\nClosing now.\n```"},{"author":"WhonixQubes","date_created":1425392156,"date_modified":1425392156,"content":"Test email comment from @WhonixQubes."},{"author":"Patrick","date_created":1429833703,"date_modified":1429833703,"content":"Test if it's still working."},{"author":"nrgaway","date_created":1429834601,"date_modified":1429834601,"content":"Test if it is working for me"}]},"PHID-TASK-tr54unslb2kptgnzudh3":{"id":"184","title":"Add missing docstrings to Python classes and methods","status":"resolved","priority":"Normal","author":"WhonixQubes","description":"Add missing docstrings to Python classes and methods\n\n\n\n#qubes-whonix-next\n\n\n\nOld Description:\n\nExcess commenting in WhonixMessageBox Class...\n\n/usr/lib/qubes-whonix/alert\n\nhttps://github.com/Whonix/qubes-whonix/blob/master/usr/lib/qubes-whonix/alert\nhttps://github.com/nrgaway/qubes-whonix/blob/master/usr/lib/qubes-whonix/alert\n\n```\nclass WhonixMessageBox(QtGui.QMessageBox):\n    '''\n    '''\n    def __init__(self, message):\n```\n\nshould likely be:\n\n\n```\nclass WhonixMessageBox(QtGui.QMessageBox):\n    def __init__(self, message):\n```","comments":[{"author":"nrgaway","date_created":1424089267,"date_modified":1424089267,"content":"IMO, The way is currently is listed is more correct that more properly reflect python syntax although it is still not correct in a PEP8 standard sense since the comment doc string is empty, although this does reflect my personal coding style.\n\nEvery class and method should have a doc string if wanting to comply with PEP257 conventions.\n\nOne deviation to those standards in my coding style is that:\n1. I usually provide an empty docstring when creating a method as a placeholder since it improves readability\n2. I use single quotes instead of double quotes as many are projects are starting to use.\n\nTherefore the expected change here should be to add a docstring.  Maybe you can create that whonix-next tag and add this item to that tag?"},{"author":"WhonixQubes","date_created":1424091037,"date_modified":1424091037,"content":"Agreed. Will update this ticket now."},{"author":"nrgaway","date_created":1433606958,"date_modified":1433606958,"content":"Done.\n\n[[ https://github.com/nrgaway/qubes-whonix/commit/c7c59ba5e2f74c707a5c44f255633ae3c9191b5a | https://github.com/nrgaway/qubes-whonix/commit/c7c59ba5e2f74c707a5c44f255633ae3c9191b5a ]]"}]},"PHID-TASK-yu5pfu2imvq3lthbgu6c":{"id":"183","title":"Typo in README.md: \"honix\" should be \"Whonix\"","status":"resolved","priority":"Normal","author":"WhonixQubes","description":"Typo in README.md: \"honix\" should be \"Whonix\".\n\nAlso affects display of main webpage for GitHub repos.\n\nhttps://github.com/Whonix/qubes-whonix/blob/master/README.md\nhttps://github.com/nrgaway/qubes-whonix/blob/master/README.md","comments":[{"author":"nrgaway","date_created":1424087258,"date_modified":1424087258,"content":"Fixed.\n\n[[ https://github.com/nrgaway/qubes-whonix/commit/5b8df1b7c5fea511638d8d3c4af07495ad6136c9 | https://github.com/nrgaway/qubes-whonix/commit/5b8df1b7c5fea511638d8d3c4af07495ad6136c9 ]]"}]},"PHID-TASK-p67fooi4ayfyv77yin3h":{"id":"182","title":"Add qubes-whonix 9.6.2-1 to Whonix APT Repository","status":"resolved","priority":"Normal","author":"WhonixQubes","description":"Once audited (T181) and signed off for release, @Patrick shall make and add the qubes-whonix package to the Whonix APT repository (currently hosted on SourceForge.net), so that from this 9.6-1 version onward the Qubes + Whonix template can be largely updated by users via \"apt-get\".\n\nUpdated package version number to 9.6.2-1.","comments":[{"author":"Patrick","date_created":1424693390,"date_modified":1424693390,"content":"Uploaded `qubes-whonix_9.6.2-1_all.deb` to `developers` and `testers` repository.\n\nCan migrate to `stable` repository on request.\n\nNote, \"apt-get dist-upgrade\" from `developers` or `testers` repository would upgrade to Whonix `10`ish packages. We have no \"stable-fixes-testers\" repository yet.\n\nBy the way, for the future, I suggest testing to manually install `qubes-whonix_9.6.2-1_all.deb` in existing qubes-whonix VMs to check if the upgrade runs smoothly causes dpkg errors. It's not a 100% simulation (you'd need a local apt repository for an almost 100% simulation), but would catch most issues. Not sure, if you already did that? That way would be much more efficient than remotely debugging through the Whonix apt repository."},{"author":"WhonixQubes","date_created":1425110106,"date_modified":1425110106,"content":"Mirrored ticket to forum:\n\n- https://www.whonix.org/forum/index.php/topic,983.0.html\n\nJust waiting for @nrgaway for readiness to request migration of the \"qubes-whonix\" deb package to \"stable\" apt repo."},{"author":"WhonixQubes","date_created":1426710178,"date_modified":1426710178,"content":"Looks like the \"qubes-whonix\" 9.6.2-1 deb package has been migrated to the \"stable\" apt repo.\n\nWill mark as resolved."},{"author":"Patrick","date_created":1426710342,"date_modified":1426710342,"content":"It was not. Not by me. And no one else can do that currently.\n\nNo one followed up on this one, so I didn't do anything. Was wondering about this one, though."},{"author":"WhonixQubes","date_created":1426710738,"date_modified":1426710738,"content":"oops, thought it was.\n\nHaven't heard from @nrgaway.\n\nThe new templates have been compiled and released by ITL which seems to install \"qubes-whonix\" at the build stage.\n\nqubes-whonix 9.6.2-1 gets built and installed via the source code it seems.\n\nEven if it won't affect current templates, maybe others will build/install/update in a different way and want to use it from the stable repo.\n\nSeems like it can be migrated now."},{"author":"Patrick","date_created":1426712407,"date_modified":1426712407,"content":"Done."}]},"PHID-TASK-hpizsihslbyqdbooajog":{"id":"181","title":"Audit qubes-whonix 9.6-1","status":"resolved","priority":"Normal","author":"WhonixQubes","description":"Audit of qubes-whonix 9.6-1 package release, primary developed by @nrgaway, and potentially secondarily contributed to later by others, is already underway and nearing completion by @Patrick and @WhonixQubes.\n\nWould like it to be signed off by all of @Patrick and @WhonixQubes and @nrgaway.\n\n\nForum Discussion:\n\n- https://www.whonix.org/forum/index.php/topic,961.0.html","comments":[{"author":"Patrick","date_created":1424084281,"date_modified":1424084281,"content":"Added a minor commit on top:\nhttps://github.com/Whonix/qubes-whonix/commit/6d88b9284c5cc634e57a95b2c9993f39a21431ac\n\n(This helps me with https://github.com/Whonix/whonix-developer-meta-files/blob/master/debug-steps/packaging-helper-script `pkg_packaging_files_diff`.)"},{"author":"Patrick","date_created":1424084495,"date_modified":1424084495,"content":"added \"Uploaders: Patrick Schleizer <adrelanos@riseup.net>\" to debian/control:\nhttps://github.com/Whonix/qubes-whonix/commit/7592d6b49004e7d9151195a768d8a0ff384f5268\n"},{"author":"Patrick","date_created":1424084547,"date_modified":1424084547,"content":"added changelog.upstream to fix lintian warning:\nhttps://github.com/Whonix/qubes-whonix/commit/cd5f3d83d36ec31867f78a73bf2fa9ea6ca7d171"},{"author":"Patrick","date_created":1424084863,"date_modified":1424084863,"content":"added changelog.upstream to fix lintian warning:\nhttps://github.com/Whonix/qubes-whonix/commit/cd5f3d83d36ec31867f78a73bf2fa9ea6ca7d171\n\nbumped changelog version (to fix lintian warning about missing close ITP):\nhttps://github.com/Whonix/qubes-whonix/commit/448f0353be69442b466f28149b6e67d038461e5d\n\nadded creation of upstream changelog to fix lintian warning:\nhttps://github.com/Whonix/qubes-whonix/commit/8bbc0ae3a157e74621fb20ca3209cc67045f6f4b"},{"author":"Patrick","date_created":1424091774,"date_modified":1424091774,"content":"To be overly correct, I could have created separate issues for these. But these are so minor. You could still create them if there is any doubt about any of them."},{"author":"WhonixQubes","date_created":1424105974,"date_modified":1424105974,"content":"Cross-posted: https://www.whonix.org/forum/index.php/topic,961.msg7015.html#msg7015\n\n---\n\nSo I'm now satisfied with my cursory audit of the proposed \"qubes-whonix\" 9.6-1 package version.\n\nI have now looked through the entire code in the @nrgaway and @Whonix GitHub repos for the \"qubes-whonix\" package up to the following commits...\n\n- https://github.com/nrgaway/qubes-whonix/commit/18437a8d99281773dafc4bd2b25ccab948bba0dd\n\n- https://github.com/Whonix/qubes-whonix/commit/8bbc0ae3a157e74621fb20ca3209cc67045f6f4b\n\nMy cursory review and stamp of approval -- for what its worth -- should not be taken as any kind of in-depth or professional security audit by others following along.\n\nOK stamp given from me. :)\n\nAfter any remaining issues of Patrick's are resolved, I assume the .deb for the Whonix APT repo can be produced, uploaded, and made available for when the new ITL compiled Whonix templates come online?\n\n\n---\n\n\nI would like to establish a more formal coordination process, with more time available for community awareness and audits before moving to release, for future versions. Will be following up on hammering out the details of this topic later.\n\n\n---\n\n\nThanks for your development work @nrgaway and auditing/finalizing work @Patrick. :)\n\nI have a few things to wrap up on a lagging project with my day job this week, then I'll be back to finishing public leak testing and the new documentation for this platform."},{"author":"Patrick","date_created":1424118319,"date_modified":1424118319,"content":"Reviewed for non-maliciousness only. I got some major problems with the other stuff, but it's fine for upload. Will/have created other tickets for that."}]},"PHID-TASK-rf47bsg62kkfgh74qkrg":{"id":"180","title":"add qubes-whonix package to Whonix source code folder","status":"resolved","priority":"Normal","author":"Patrick","description":"There is one issue why I haven't added the https://github.com/nrgaway/qubes-whonix package to https://github.com/Whonix/Whonix/tree/master/packages folder yet. It `Build-Depends:` on `dh-systemd`. That dependency isn't available as long as Whonix is based on Debian wheezy. So building Whonix would break when attempting to build the qubes-whonix package.\n\nWe could add another hack to https://github.com/Whonix/Whonix/blob/master/build-steps.d/1100_prepare-build-machine#L415 to install it from jessie in meanwhile. Want me to do this?","comments":[{"author":"Patrick","date_created":1424082062,"date_modified":1424082062,"content":"install dh-systemd from jessie:\nhttps://github.com/Whonix/Whonix/commit/aeec7ace871dff5b266a8af21d8fd2562d637961\n"},{"author":"Patrick","date_created":1424084295,"date_modified":1424084295,"content":"added qubes-whonix package to Whonix source code folder:\nhttps://github.com/Whonix/Whonix/commit/740599c8b33e4cd33a8767d6a417aefa2e8ca8fc"}]},"PHID-TASK-vigpx5mntgemwivy7gqw":{"id":"179","title":"tag tracker page got messed up","status":"wontfix","priority":"Normal","author":"WhonixQubes","description":"Something just recently today just messed up the view of the Qubes (and looks like other) \"tag\" pages of this tracker.\n\nThis is concerning the main Qubes tracker page that we've been promoting.\n\nNow a very unuseful \"Qubes Workboard\" has taken over the page with hardly any info.\n\nThis page no longer shows all of the relevant Qubes ticket info it had before, including historical tickets and activity, making it hard to offer an easy public view into what's going on...\n\nhttps://phabricator.whonix.org/tag/qubes\n\nThis URL with using capitalized \"Qubes\" used to offer the same exact page as the lowercase version, and matched our other \"Qubes\" pretty URLs on the Whonix site, but is now throwing a 404 Not Found error...\n\nhttps://phabricator.whonix.org/tag/Qubes\n\nI don't know know if this change was intentional or not?\n\nCould we restore the original page for the Qubes tag?\n","comments":[{"author":"Patrick","date_created":1424078979,"date_modified":1424078995,"content":"No intentional change. I updated phabricator today. That caused the change.\n\nThe best you can do from there is press \"open tasks\" on the left.\n\nI don't know if this can be configured.\n\n* irc.freenode.net `#phabricator`\n* https://secure.phabricator.com/book/phabricator/article/feedback/\n"},{"author":"WhonixQubes","date_created":1424080114,"date_modified":1424080114,"content":"Ok, oh well, I will have to play with things and figure out something later.\n\nDoesn't seem to be anything to do for now. Resolving as Wontfix status for now."},{"author":"Patrick","date_created":1424124193,"date_modified":1424124193,"content":"I think we should at least ask upstream about this and/or leave a feature request. For most questions we had in past there were solutions. They're quite responsive and implemented lots of stuff requested by the community."},{"author":"troubadour","date_created":1424193398,"date_modified":1424193398,"content":"The change happened to all the \"tags\". `https://phabricator.whonix.org/tag/whonix/` shows a `Whonix Workboard` with a list of opentasks on the left. To get something barely usable, have to press `Open Tasks` (anchor icon) and `Open Task` again (text) to get rid of the query. No activity messages."},{"author":"Patrick","date_created":1424634003,"date_modified":1424634003,"content":"They got a ticket for that.\n\nFix the bog of questionable value that is Project detail pages:\nhttps://phabricator.whonix.org/T179"},{"author":"Patrick","date_created":1424640908,"date_modified":1424640908,"content":"I suggest to leave your suggestions in phabricator's tracker. Probably no more we can do here."}]},"PHID-TASK-vmlhcsjlozhgkdvefby6":{"id":"178","title":"distinguish between open tickets and tickets that need review","status":"resolved","priority":"Normal","author":"Patrick","description":">>! In T166#2083, @nrgaway wrote:\n> Is there a way to remove this from Qubes tasks now so I don't see the task in current Qubes tasks?\n\n","comments":[{"author":"Patrick","date_created":1424075298,"date_modified":1424075298,"content":"Good question. Was wondering about that also. For now, I just remember and ignore them. Which is a bit weird, because I mentally go through that ticket every time I read it.\n\nFor the Whonix 10 milestone (which is also just a project / tag), I created a work board:\nhttps://phabricator.whonix.org/project/board/2/\n\nIt contains a column \"wait\". Similarly you could also move tickets to a to be created \"needs review\" column.\n\nHere is the Qubes work board:\nhttps://phabricator.whonix.org/project/board/17/query/all/\n\n(Any project/tag can easily get a work board if desired with \"1\" click.)\n\nFor whatever that's worth. Does that sound usable?\n\nNot for me, because then I have to keep remembering to go to the workboard and manually move tickets back and forth between columns \"open\" and \"needs review\".\n\nMaybe we can get a new \"Action\" where we can set the status to stuff like \"open\", \"needs review\", \"needs information\" (if that is useful) and so forth in the ticket. Then you can modify the status accordingly and have some custom advanced search, where you only search for open tickets, that do not require review yet.\n\n@nrgaway did I try to answer the question you asked or am I on wrong track? In the latter case, please open a new ticket."},{"author":"Patrick","date_created":1424077467,"date_modified":1424077467,"content":"Likely this is possible:\nhttps://phabricator.whonix.org/config/edit/maniphest.statuses/\n\nThe \"change status\" action is configurable.\n\nI'll remove the \"Spite\" one, since it was never used and unless someone has an idea what it's good for. Will Add \"duplicate\" and \"needs review\"."},{"author":"Patrick","date_created":1424077945,"date_modified":1424077945,"content":"Accidentally closed.\n\nNow setting status to review."},{"author":"Patrick","date_created":1424078212,"date_modified":1424078212,"content":"We now have\n\n* Open\n* Resolved\n* Wontfix\n* Invalid\n* Review\n\nNot yet \"duplicate\". Somehow my config doesn't work. But it's not that important, no?\n\nYou could now make a custom phabricator search and it should only show open tasks. Not those which are marked review.\n\nNow that we have a \"Review\" status, that should do @nrgaway?"},{"author":"Patrick","date_created":1424079110,"date_modified":1424079110,"content":"Maybe you also need a status \"needs answer\"?"},{"author":"nrgaway","date_created":1424089633,"date_modified":1424089633,"content":"I'm not too sure.  Getting lost in finding items though; just a learning curve.  Took me 2 minutes to refind this topic :)\n\nIs it possible when reviewing the open items or workboard or whatever to show if there have been any replies to a ticket since I last viewed it.  That would help alot."},{"author":"WhonixQubes","date_created":1424090750,"date_modified":1424090750,"content":"@nrgaway\n\nPersonally, for sorting new updates to tickets fast, I use the email notifications to filter them and then browse directly to the tickets that I know I need to further look at or respond to.\n\nEnsuring you are subscribed for email notifications and creating alert/filtering rules in your email client would be one way to help manage this process."},{"author":"Patrick","date_created":1424092823,"date_modified":1424092823,"content":"> I'm not too sure. Getting lost in finding items though; just a learning curve. Took me 2 minutes to refind this topic :)\n\nI found this one by e-mail notification and alternatively by searching for the \"phabricator\" tag and then clicking all tickets on the left.\n\n> Is it possible when reviewing the open items or workboard or whatever to show if there have been any replies to a ticket since I last viewed it. That would help alot.\n\nOne thing, you could set up e-mail notification. Have yourself added to CC for tickets of all or specific components (Qubes etc.), see:\nhttps://www.whonix.org/wiki/Dev/Bug_Tracker#Get_E-Mail_Notification_for_all_New_Maniphest_Tasks\n\nThere is also a feed, that is now linked (pinned) on the phabricator.whonix.org main page as \"feed\". Check if this helps:\nhttps://phabricator.whonix.org/feed/\n\nIt's more a general feed. Not a personal \"check what I have missed\" thing. Would e-mail notification work for you?\n\nOtherwise I can check if we can get this \"check what I have missed\" thing. Phabricator should be able to do almost everything. I mean, if much it works for much bigger projects (facebook, mediawiki), it should work for us as well."},{"author":"Patrick","date_created":1424201585,"date_modified":1424201585,"content":"Check this out. There is also:\nhttps://phabricator.whonix.org/notification/\n\nApparently (as per IRC support), there are no features alike\n\n* \"Show unread posts since last visit.\"\n* \"Show new replies to your posts.\""},{"author":"Patrick","date_created":1424201729,"date_modified":1424201729,"content":"There is also unread notifications!\n\nCheck this out:\nhttps://phabricator.whonix.org/notification/query/unread/\n"},{"author":"Patrick","date_created":1424428852,"date_modified":1424428852,"content":"Added a link to https://phabricator.whonix.org/notification/query/unread/ as \"Unread Notifications\" to the page footer of phabricator.whonix.org."}]},"PHID-TASK-sbskbl7z7vkbf3ij4lyu":{"id":"177","title":"remove duplicate ipv4 forwarding disable","status":"resolved","priority":"Normal","author":"Patrick","description":"```\ngrep -r ipv4 *\n```\n\nI think this is unnecessary.\n\n```\nusr/lib/qubes-whonix/init/network-proxy-setup:        echo \"0\" > /proc/sys/net/ipv4/ip_forward\nusr/lib/qubes-whonix/init/network-proxy-setup:echo \"0\" > /proc/sys/net/ipv4/ip_forward\nusr/lib/qubes-whonix/init/qubes-whonix-firewall:echo \"0\" > /proc/sys/net/ipv4/ip_forward\n```\n\nThis is already done by the https://github.com/Whonix/ipv4-forward-disable package.","comments":[{"author":"nrgaway","date_created":1424072140,"date_modified":1424072140,"content":"Without the disables, whonixcheck reports that ip_forward is disabled right before/after whonix-setup so to be on the safe side I added this in.  Again Qubes enables it."},{"author":"Patrick","date_created":1424123579,"date_modified":1424123579,"content":"I advice to fix this in a later version of Qubes upstream and in the qubes-whonix version."},{"author":"nrgaway","date_created":1433607470,"date_modified":1433607470,"content":"Done\n\n[[ https://github.com/nrgaway/qubes-whonix/commit/1e4a32dfe70074a42e8fe141ba1032c9055bbb49 | https://github.com/nrgaway/qubes-whonix/commit/1e4a32dfe70074a42e8fe141ba1032c9055bbb49 ]]"}]},"PHID-TASK-ed7c4cko62aigoif5gj5":{"id":"176","title":"use GATEWAY_IPv4_DROP_INVALID_INCOMING_PACKAGES_POST_HOOK instead of editing /usr/bin/whonix_firewall","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/nrgaway/qubes-whonix/blob/master/usr/lib/qubes-whonix/init/qubes-whonix-firewall#L30\n```\n# Inject custom firewall rules into whonix_firewall\n```\n\n~~I would be happy if we could add some suitable hook mechanism to whonix_firewall or add some if/then code to whonix_firewall to simplify that code. Sed injection doesn't look future proof.~~ (Done.)\n\nCreate a file `/etc/whonix_firewall.d/32_qubes` with a content like this:\n```\nGATEWAY_IPv4_DROP_INVALID_INCOMING_PACKAGES_POST_HOOK=`/path/to/script`\n```\nThen you can add your injected rules there instead of using `sed` to edit `/usr/bin/whonix_firewall`.","comments":[{"author":"Patrick","date_created":1424023277,"date_modified":1424023277,"content":"Done,\nprovide hook after drop ipv4 invalid packages through variable `GATEWAY_IPv4_DROP_INVALID_INCOMING_PACKAGES_POST_HOOK`:\nhttps://github.com/Whonix/whonix-gw-firewall/commit/5ebca43416269a5fd42c98a80af1b0b3d38adecf\n"},{"author":"Patrick","date_created":1424023617,"date_modified":1424023617,"content":"Does that new hook work for you? @nrgaway"},{"author":"nrgaway","date_created":1424074877,"date_modified":1424074877,"content":"I feel much better having this built into the whonix_firewall.  On the surface it looks great!\n\nWhat version is this slated for?  I am not changing the qubes-whonix code at this point to include the fix since I am prepping it for the 9.6 release unless this will be included in that release.\n\nCan you remove the qubes tag and move it either to qubes-next or qubes-10 (or whatever version your fix will be available in?) so at that point I will not forget to implement it?"},{"author":"Patrick","date_created":1424079432,"date_modified":1424079432,"content":"> What version is this slated for?\n\nWhonix 10.0.0.3.2-developers-only / whonix-gw-firewall 0.8-1\n\n> I am not changing the qubes-whonix code at this point to include the fix since I am prepping it for the 9.6 release unless this will be included in that release.\n\nSure. I suggest creating a development git branch where such features go.\n\n> Can you remove the qubes tag and move it either to qubes-next or qubes-10 (or whatever version your fix will be available in?) so at that point I will not forget to implement it?\n\nI think anything related to Qubes should be tagged with \"Qubes\". Just as a general catch all to be able to find everything ever related to Qubes.\n\nWhat about a `Qubes 9.6` and `Qubes 10` tag?\n\nYou can create new tags using `Create Task` -> `Create New Project`. And then just add additional tags to the existing tickets which are already tagged Qubes."},{"author":"Patrick","date_created":1424079704,"date_modified":1424079704,"content":"Maybe a tag `qubes-whonix` would be useful for everything related to the `qubes-whonix` package.\n\nAnd maybe a tag `qubes-whonix 10`, `qubes-whonix 11` and so forth."},{"author":"WhonixQubes","date_created":1424081003,"date_modified":1424081003,"content":"The tag format of `Qubes 9.6` and `Qubes 10` don't really seem to make sense, since it could be easily confused as a Qubes OS version.\n\nUsing `qubes-whonix 9.6` etc, or just using both `Qubes` and `Whonix 9.6` together maybe."},{"author":"Patrick","date_created":1424081147,"date_modified":1424081147,"content":">>! In T176#2146, @WhonixQubes wrote:\n> The tag format of `Qubes 9.6` and `Qubes 10` don't really seem to make sense, since it could be easily confused as a Qubes OS version.\n\nYeah. Wasn't the idea of the day. :)"},{"author":"nrgaway","date_created":1424088289,"date_modified":1424088289,"content":"I prefer qubes-whonix-next for anything 9.X related\n\nI have been used to using the -next in previous projects which is good, since items can get bumped again to -next if needed on next minor version update (remain in -next) \n\nand \n\nqubes-whonix-development maybe for 10.X?  <-- not so sure about this one though\nqubes-whonix-[10|future|proposed|unstable] ???\n"},{"author":"WhonixQubes","date_created":1424090384,"date_modified":1424090384,"content":"Unless there are other opinions, I'm fine with `qubes-whonix-next`.\n\nI like `qubes-whonix-future` for the latter one, as the term balances conceptually with the `qubes-whonix-next` tag. As in \"the very next .X release\" versus \"future major release\". Or something conceptually similar to that being represented."},{"author":"Patrick","date_created":1424093300,"date_modified":1424093300,"content":"I find `next` confusing. Have more like \"next major version\" in mind.\n\nWhat about `qubes-whonix-stable` and `qubes-whonix-devel`? The former would be for `9.6` while the latter would be for `10.x` or later. Are those any worse or would those equally well work for you?\n\nNot sure if `next` and `future`, or `stable` and `devel` would work that good. I mean, now there is the `9.6` stable release. Whonix `10` doesn't look that far away. I am already beginning to assign some tickets to the `Whonix 11` tag while we are finishing the `Whonix 10` milestone. Some tickets from the `Whonix 10` milestone are postponed to the `Whonix 11` milestone. I think versioned milestones are a lot better.\n\nYou got the last word, since it's you who maintains it. Just trying to prevent confusion by newcomers."},{"author":"WhonixQubes","date_created":1424094746,"date_modified":1424094746,"content":"I can see the type of issues that Patrick is mentioning.\n\nVersioned milestones are more explicitly meaningful, especially to other people looking in.\n\nAlso, I tried adding on these `qubes-whonix-next` and `qubes-whonix-future` tags as part of the Qubes project in the tracker and they seem to collapse their usage into the primary Qubes tag. Seems there would have to be a new dedicated project in the tracker for each? Which seems like a logically \"heavy\" solution.\n\nI can also see that a `next` and `future` convention takes less time to think about making use of, instead of hunting for version numbers, needing them to already be in place for the tracker, in order to sort the way @nrgaway wants.\n\nLong-term we should be looking towards creating a shared development process with conventions and procedures that support more people in the mix. Yet, for now, @nrgaway is taking the primary lead on code development with the `qubes-whonix` package and switching small conventions like this later shouldn't be too bad.\n\nAlso, I wonder if intended usage of these tags might bleed over beyond the scope of the `qubes-whonix` package, where other Whonix components become involved.\n\nI also wonder if relying too much on these personal tagging conventions for the `qubes-whonix` package might cause you @nrgaway to miss out on other people's more generic usage of tags? Maybe predicting this requires better understanding of the tracker software.\n\nJust expressing some thoughts that come to mind. No need to answer these. I don't have strong preferences at this time. No problem for me either way."},{"author":"nrgaway","date_created":1424102065,"date_modified":1424102065,"content":"I'll go with whatever Patrick thinks is best.  I personally do not like too much clutter when developing and prefer to have quick access to what needs to be done.  If a feature is put off to the next version, I don't want to see it again until I begin working on that version.  That way people will also have a better understanding when something may be implemented.\n\nA 'develop' should work fine for any development in current release 9.X cycle then you could use the 'next' tag for 10.X+ ?  Then once qubes-whonix 9.6 is officially released, action items can be moved to 'develop' if it can be foreseen to be completed in that release cycle.\n\nAnother thing to note is that the email notifications I receive do not seem to have a proper return email address so a reply can be made from email to a subject tag.  The return address displays as 'noreply@phabricator.example.com' in my email reader.\n\n\n"},{"author":"Patrick","date_created":1424120468,"date_modified":1424120468,"content":">>! In T176#2227, @nrgaway wrote:\n> I'll go with whatever Patrick thinks is best.\n\nOk. I think `qubes-whonix 9.6`, `qubes-whonix 10`, `qubes-whonix 11` etc. is best. Since we can add an \"unlimited\" amount of tags, you could always add additional tags if that helps.\n\n> I personally do not like too much clutter when developing and prefer to have quick access to what needs to be done.  If a feature is put off to the next version, I don't want to see it again until I begin working on that version.  That way people will also have a better understanding when something may be implemented.\n\nThe tag scheme I suggest would work for that, I think.\n \n> Another thing to note is that the email notifications I receive do not seem to have a proper return email address so a reply can be made from email to a subject tag.  The return address displays as 'noreply@phabricator.example.com' in my email reader.\n\nCreated T185 for it.\n\n-----\n\nOn topic:\n\nDo we need to use a hook at all? Why not just add this to whonix-gw-firewall /usr/bin/whonix_firewall for Whonix 10? It's just a short snippet. Wouldn't decrease readability of /usr/bin/whonix_firewall a lot. As long as it has a safe \"if running in Qubes\" mechanism (such as `if [ -f /usr/lib/qubes-whonix ]; then ...`, then I don't think it would be a problem.\n\nNot using a hook has one disadvantage: firewall rules for Qubes could not be updated without updating the whonix-gw-firewall package.\n\nYou tell me which way you find better. Feel free to either use the hook or to make a pull request for whonix-gw-firewall."},{"author":"nrgaway","date_created":1424639389,"date_modified":1424639389,"content":"I am trying to figure out how to add this to `qubes-whonix 10`.  Any advice is welcome :)"},{"author":"Patrick","date_created":1424642952,"date_modified":1424642952,"content":"In the upper right, click click the big `+` and choose `project`. As name, choose `qubes-whonix 10` or so.\n\nThen reload (or just go back) to this page, press edit task, and add to projects - or - above the `Comments` field, choose `Action` `Associate Project` and add the newly created project (tag) there."},{"author":"Patrick","date_created":1429748582,"date_modified":1429748582,"content":"If current hooks are insufficient... (T272) And I guess we don't want to add a million more hooks. Unless you have a better idea...\n\n@nrgaway Could you send a pull request for the whonix-gw-firewall package with some \"if qubes file exists then\"? So we can get this merged for Whonix 11 or Whonix 12?"},{"author":"nrgaway","date_created":1430377863,"date_modified":1430377863,"content":"Done \n\n[[ https://github.com/nrgaway/qubes-whonix/blob/master/etc/whonix_firewall.d/32_qubes | https://github.com/nrgaway/qubes-whonix/blob/master/etc/whonix_firewall.d/32_qubes ]]"}]},"PHID-TASK-7bkiyeb3komrzy2cgyid":{"id":"175","title":"typos","status":"resolved","priority":"Normal","author":"Patrick","description":"```\nusr/lib/qubes-whonix/init/init:# Make sure we are using a copy of the annondist file and if not\nusr/lib/qubes-whonix/init/init:# copy the annondist file and set it immutable\n```\n\nannondist -> anondist\n\n```\nusr/lib/qubes-whonix/init/qubes-whonix-firewall:    # XXX: TODO:  Take down all network accesss if firewall fails\n```\n\naccesss -> access","comments":[{"author":"nrgaway","date_created":1424069712,"date_modified":1424069712,"content":"Done\n\n[[ https://github.com/nrgaway/qubes-whonix/commit/0dc46aa4d8809fb19046465b107a79a2c247d39e | https://github.com/nrgaway/qubes-whonix/commit/0dc46aa4d8809fb19046465b107a79a2c247d39e ]]"}]},"PHID-TASK-endsn6qd4qg3tm4wnsr5":{"id":"174","title":"rather than modify /etc/sdwdate.d/31_anon_dist_stream_isolation_plugin ship /etc/sdwdate.d/35_qubes_stream_isolation_plugin","status":"resolved","priority":"Normal","author":"Patrick","description":"Similar to T163...\n\nThis is unnecessary:\n\n```\ninterest-noawait /etc/sdwdate.d/31_anon_dist_stream_isolation_plugin\n```\n\nInstead of modifying `31_anon_dist_stream_isolation_plugin`, shipping a file:\n\n```\n/etc/sdwdate.d/35_qubes_stream_isolation_plugin\n```\n\nor so could be a better way.\n\nThe only required content, for Whonix 9:\n\n```\nPROXY=\"10.152.152.10:9108\"\n```\n\n(Replace IP with Qubes one.)\n\nFor Whonix 10:\n\n```\nPROXY_IP=\"10.152.152.10\"\n```\n\n(Replace IP with Qubes one.)\n\n(Adding both `PROXY` and `PROXY_IP` at the same time wouldn't do any bad to make it work with Whonix 9 and Whonix 10 at the same time.)","comments":[{"author":"nrgaway","date_created":1424074196,"date_modified":1424074196,"content":"Done.\n\n[[ https://github.com/nrgaway/qubes-whonix/commit/a86b58c6fcc02face96f4e101a6ebbdcfc5c2bc3 | https://github.com/nrgaway/qubes-whonix/commit/a86b58c6fcc02face96f4e101a6ebbdcfc5c2bc3 ]]"},{"author":"Patrick","date_created":1424082380,"date_modified":1424082380,"content":"Code only review: looks good."}]},"PHID-TASK-idmycgk3uihjndsrfgzi":{"id":"173","title":"triggers interest-noawait /etc/resolv.conf will probably not work","status":"resolved","priority":"Low","author":"Patrick","description":"I've never used triggers, but it's most interesting. I see a potential issue here.\n\n```\n# Reset back to Whonix defaults\ninterest-noawait /etc/resolv.conf\ninterest-noawait /etc/hosts\ninterest-noawait /etc/hostname\n```\n\nI think you might want to use /etc/resolv.conf.anondist instead. Because the file known to dpkg is\nhttps://github.com/Whonix/anon-gw-dns-conf/blob/master/etc/resolv.conf.anondist\n(or https://github.com/Whonix/anon-ws-dns-conf/blob/master/etc/resolv.conf.anondist).\nMoving /etc/resolv.conf out of the way and the symlink magic is done by config-package-dev. And I suppose that dpkg uses triggers on files it knows to manage. Probably not on dpkg-diverted files. But I might be wrong about this. I advice to actually test this if you want to make sure this really works.\n\n(Related: T171)\n","comments":[{"author":"nrgaway","date_created":1424068040,"date_modified":1424068040,"content":"It has been tested and does work.\n\nThose 3 files are managed by qubes.whonix and also have a chattr+i attribute set upon them to prevent Qubes from over-writing them.\n\n[[ https://github.com/nrgaway/qubes-whonix/blob/master/usr/lib/qubes-whonix/init/init | https://github.com/nrgaway/qubes-whonix/blob/master/usr/lib/qubes-whonix/init/init ]]\n[[ https://github.com/nrgaway/qubes-whonix/blob/master/usr/lib/qubes-whonix/utility_functions.sh#L56 | https://github.com/nrgaway/qubes-whonix/blob/master/usr/lib/qubes-whonix/utility_functions.sh#L56 ]]"},{"author":"Patrick","date_created":1424123539,"date_modified":1424123539,"content":"I advice to fix this in a later version of Qubes upstream and in the qubes-whonix version."},{"author":"Patrick","date_created":1441727279,"date_modified":1441727279,"content":"`fixed 'triggers interest-noawait /etc/resolv.conf will probably not work' - https://phabricator.whonix.org/T173`:\nhttps://github.com/Whonix/qubes-whonix/commit/d299505b6c7bbf7b2e856e5e2d87b5de4d664f9e"}]},"PHID-TASK-naohcphnirej2wmja3fy":{"id":"172","title":"qubes-whonix.triggers code duplication","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/nrgaway/qubes-whonix/blob/master/debian/qubes-whonix.triggers uses twice:\n\n```\ninterest-noawait /etc/network/interfaces.whonix\n```\n\nI suggest to remove one of the two.","comments":[{"author":"nrgaway","date_created":1424067672,"date_modified":1424067672,"content":"Done\n\n[[ https://github.com/nrgaway/qubes-whonix/commit/4c22b942418cd650e5fd9c26c2a202da81152b80 | https://github.com/nrgaway/qubes-whonix/commit/4c22b942418cd650e5fd9c26c2a202da81152b80 ]]\n\n(Can't seem to make issue as resolved)"},{"author":"Patrick","date_created":1424068762,"date_modified":1424068762,"content":"> (Can't seem to make issue as resolved)\n\nYou weren't admin. Made you admin. Please try to self-assign and close."}]},"PHID-TASK-rog5ls3chmkkpf4ddzzw":{"id":"171","title":"remove /etc/hosts from qubes-whonix package","status":"invalid","priority":"Normal","author":"Patrick","description":"Why ship https://github.com/nrgaway/whonix-qubes/blob/master/etc/hosts ?\n\nI think those are likely to conflict with anon-base-files (https://github.com/Whonix/anon-base-files), with https://github.com/Whonix/anon-base-files/blob/master/etc/hosts.anondist\n\nCan you remove those from qubes-whonix package or are they required for something? I think at the moment those files are not in use anyhow. Due to anon-base-files use of config-package-dev and .anondist extension, those will take precedence.","comments":[{"author":"nrgaway","date_created":1424067216,"date_modified":1424067216,"content":"Currently the qubes-whonix package is the last packages to be installed when creating the Whonix templates.\n\nThe process of creating a Whonix template goes something like this:\n- Create initial Debian image (debootstrap)\n- Configure locale, keyboard\n- Prepare image for Whonix (install / configure required depends)\n- Install Whonix using Whonix build scripts in chroot ENV\n- Install additional software as expected for qubes-templates (some gnome stuff, etc)\n- Install systemd; any other repo definitions\n- Install all required Qubes packages\n- Install python-guimessages, whonix-setup-wizard then last qubes-whonix\n\nThe /etc/hosts is then required to remove default Qubes hosts and therefore is required or Whonix will report an error message that hosts is not setup correctly.\n"},{"author":"Patrick","date_created":1424123705,"date_modified":1424123705,"content":"So one of Qubes' packages recreates it?\n\nI advice to fix this in a later version of Qubes upstream and in the qubes-whonix version."}]},"PHID-TASK-iw63l5dh22mjdg7tlia5":{"id":"170","title":"check Qubes build script for apt-get update network / gpg failure security issues","status":"invalid","priority":"Normal","author":"Patrick","description":"There are [various security issues when using apt-get update in scripts](https://www.whonix.org/wiki/Dev/Automatic_Updates#apt-get_upstream_bugs):\n\n* [apt: Provide meaningful exit codes for gpg failures](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=745735)\n* [provide meaningful exit codes for network failures](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=776152)\n* [audit 'apt-get update' exit codes](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=778357)\n\nTODO:\n\nCheck if Qubes' build script for building Debian and/or Whonix templates catch those issues and fix them if necessary.","comments":[{"author":"nrgaway","date_created":1424066508,"date_modified":1424066508,"content":"Currently the build process will fail and exit if any non-zero exit code is received.\n\nNo meaningful messages are reported; only the reason for exit as reported by apt-get.  If VERBOSE mode is set, one can easily see why the failure happened,\n\nA not-so-common problem is network failures.  I do not have any retries or mirrors set up and do not foresee adding that feature in the current version since I may be re-factoring all the qubes template code again."},{"author":"Patrick","date_created":1424079610,"date_modified":1424079610,"content":"> Currently the build process will fail and exit if any non-zero exit code is received.\n\nProblem is, apt exit codes aren't reliable in scripts.\n\n> and do not foresee adding that feature in the current version since I may be re-factoring all the qubes template code again.\n\nProbably best to do this for Whonix Qubes (or qubes-whonix ?) 11."},{"author":"nrgaway","date_created":1424090149,"date_modified":1424090149,"content":"yeah, add it to qubes-whonix-next"},{"author":"Patrick","date_created":1433289091,"date_modified":1433289091,"content":"Is this done?"},{"author":"nrgaway","date_created":1433608377,"date_modified":1433608377,"content":"The Qubes build script will fail the install of the template if any apt-get errors are returned.\n\nthe --force option has also been removed as well as adding retry.\n\nThere are no meaningful exit codes for failure but if verbose mode is turned on you can see what the error was by reviewing the output.\n\n"},{"author":"Patrick","date_created":1433654487,"date_modified":1435621874,"content":">>! In T170#5334, @nrgaway wrote:\n> the --force option has also been removed\n\nGood.\n\n> The Qubes build script will fail the install of the template if any apt-get errors are returned.\n\nI don't think this can be worked around at the moment without parsing the output of apt-get.\n\n> There are no meaningful exit codes for failure but if verbose mode is turned on you can see what the error was by reviewing the output.\n\n(Just so we don't talk past each other: Nevermind meaningful exit codes for the build script. Not my point here.)\n\nThe issue is, that apt-get does not provide meaningful exit codes for gpg and network failures. \"Not meaningful\" here means, that `apt-get update` exits `0`, even if it failed. This makes it hard to figure out in scripts if `apt-get update` actually succeeded loading repository metadata or failed.\n\nThe threat model here is using multiple repositories. Such as Debian's main repository as well as Debian's security repository. For consistent and secure builds, both have to be enabled. Now, an adversary could make fetching the Debian main repository succeed, but simulate a gpg or network failure for the Debian security repository. Then the build would go on only with the Debian main repository, without the Debian security repository.\n\nIn other words... Here is a practical example...\n\nConsider the following sources.list which is fine.\n\n```\ndeb http://security.debian.org wheezy/updates main contrib non-free\ndeb http://ftp.us.debian.org/debian wheezy main contrib non-free\n```\n\nConsider the following sources.list which is fine which contains an intentional typo for demonstration purposes.\n\n```\ndeb http://not-security.debian.org wheezy/updates main contrib non-free\ndeb http://ftp.us.debian.org/debian wheezy main contrib non-free\n```\n\nNow, when you run...\n\n```\nsudo apt-get update ; echo $?\n```\n\nThe output shows.\n\n```\nErr http://not-security.debian.org wheezy/updates Release.gpg                                                                                                                      \n  Could not resolve 'not-security.debian.org'\nHit http://ftp.us.debian.org wheezy Release.gpg                                                                                                                                    \n...\nW: Failed to fetch http://not-security.debian.org/dists/wheezy/updates/Release.gpg  Could not resolve 'not-security.debian.org'\n\nW: Some index files failed to download. They have been ignored, or old ones used instead.\n0\n```\n\nSecurity repository was excluded. That's an attack an adversary can mount or it can happen for other reasons also. The bad thing here is, apt-get exited `0`. Therefore hard to detect these situations in scripts. (Bugs are reported upstream - see ticket description - could take a very long time until fixed upstream.)\n\nThe way this was solved in Whonix 10 is by using a wrapper. [`/usr/lib/apt-get-wrapper`](https://github.com/Whonix/whonixcheck/blob/master/usr/lib/apt-get-wrapper), that parses `apt-get update`'s output. Awful hack, but the real fix would require fixing apt-get upstream at Debian. I think the only way to make [qubes-builder-debian](https://github.com/QubesOS/qubes-builder-debian) equally secure would be using that or a similar script/way."},{"author":"nrgaway","date_created":1435626097,"date_modified":1435626097,"content":"I see your point.\n\nI don't like really like the idea of using a wrapper if we don't need to since it would need to be installed before qubes packages are installed.\n\nHow about using something like this?\n\n```\napt-get update 2>&1 | gawk 'BEGIN{} /^W:/{ret_code=125;}/^/ ; END{exit ret_code}' ; echo $?\n```"},{"author":"Patrick","date_created":1435630379,"date_modified":1444989172,"content":"If we don't have duplicate sources[1][2][3] while building... And that should be doable... Then this could work.\n\nFew points:\n\n* should match for both, `W:` and `E:`\n* match `W:` and `E:` case-insensitive, i.e. also for `w:` and `e:` (You'll never know if apt-get changes the output at some point.)\n* there is no need to always `exit 125` just because a `W:` or `E:` was found in the output, for many cases apt-get properly exits non-zero in case of `W:` or `E:`\n* applies to 'apt-get update' only\n* ideally, that new apt-get command should be a variable or function, so it does not have to be copied verbatim multiple times (but looks like you have this anyhow)\n* support for builders to inject options must not be broken (APT_GET_OPTIONS)\n* enable pipefail, `set -o pipefail`, otherwise apt-get's exit code that comes first in the pipe will not be forwarded to gawk\n* this stuff is fragile, some unit testing for these parsers would be good, but this can be left for future work\n\n-----\n\nFootnotes:\n\n[1] Because then the matching command gets too complex.\n[2] Ignoring the duplicate sources issue, because it's not serious.\n[3] https://github.com/Whonix/whonixcheck/blob/12b77823d3df94075f447212bd279e1c578ca65d/usr/lib/apt-get-wrapper#L55-57\n\n-----\n\nTrivia:\n\n* Whonix copies the wrapper at build time before installing any packages so the wrapper can be used.\n** I don't like this solution too much."},{"author":"Patrick","date_created":1438869968,"date_modified":1438869968,"content":"Moved to Qubes' tracker...\n`Debian Template: build script security - deal with 'apt-get update' unreliable exit codes`:\nhttps://github.com/QubesOS/qubes-issues/issues/1107\n"}]},"PHID-TASK-nagjwpkqwnutx33qf53i":{"id":"169","title":"check for network failures during build","status":"resolved","priority":"Normal","author":"Patrick","description":"upstream bug:\n[provide meaningful exit codes for network failures](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=776152)\n","comments":[{"author":"Patrick","date_created":1424266558,"date_modified":1424266558,"content":"Wrote a wrapper that can detect such situations:\nhttps://github.com/Whonix/whonixcheck/commit/302d3825da673618826606a70e1e96fc4219920a\n\nUsing that wrapper is still TODO."},{"author":"Patrick","date_created":1424693566,"date_modified":1424693566,"content":"Done."}]},"PHID-TASK-w57ivbll7beruqvfaezi":{"id":"168","title":"missing features in make-helper.bsh for qubes-whonix package?","status":"resolved","priority":"Normal","author":"Patrick","description":"Besides T167, are there any missing features in `make-helper.bsh` for the `qubes-whonix` package? @nrgaway?\n\nWhile I am at implementing T167, and before I update the generic makefile in the packages, I could add a few more changes if required.\n\n-----\n\nBy the way, you can now drop snippets into a to-be-created-if-needed `./make-helper-overrides.d/` folder. When they are executable, they will be sourced in lexical order. Alternatively use `./make-helper-overrides.bsh`. Useful to overwrite functions by `make-helper.bsh`.\n\nAlso added generic `_hook_pre` and `_hook_post` mechanism. Before calling any make helper `function`, function `function-name_hook_pre` would be called and `function-name_hook_post` after running the the make helper function. \n\nFor example. Let's take function `make_deb-pkg`. You could define a `make_deb-pkg_hook_pre` or `make_deb-pkg_hook_post` using overrides.","comments":[{"author":"nrgaway","date_created":1424065984,"date_modified":1424065984,"content":"Sounds interesting.\n\nCurrently I do not use any of the Whonix makefiles when building qubes-whonix, whonix-setup-wizard or python-guimessages as they are built by qubes-builder before Whonix is installed.\n\nOnce those 3 packages are part of the Whonix repo, they can be build along with the other packages Whonix builds and then at that point I can test if anything else would be required."},{"author":"Patrick","date_created":1424123439,"date_modified":1424123439,"content":"Those are now all inside Whonix's source code folder and build along with the other packages. Soon in the repo. (T182) The makefile is able to build those.\n\nIf the makefile lacks any features, please open feature requests."}]},"PHID-TASK-c66rrokggyx7vnnn4t2t":{"id":"167","title":"implement deb-pkg-build-dep and deb-pkg-update-build-dep","status":"resolved","priority":"Normal","author":"Patrick","description":"As per https://www.whonix.org/forum/index.php/topic,841.msg6261.html#msg6261.","comments":[{"author":"Patrick","date_created":1424007268,"date_modified":1424007268,"content":"Done,\nimplemented `make deb-build-dep`. Install build dependencies listed in `debian/control` under `Build-Depends` using `apt-get`. Various environment variables supported.:\nhttps://github.com/Whonix/Whonix/commit/5883fbdbbf8729f0d474e18231cde0bf2713f4e8\n\nI didn't implement running `apt-get update` beforehand, because __securely__ running `apt-get update` in scripts is very difficult due to unreliability of exit codes. (See: https://www.whonix.org/wiki/Dev/apt-get#Bugs) It would be best if running `apt-get update` was left to the user or the build script that builds the package (such as Whonix's or Qubes's build script).\n\n(Whonix's build script checks for `apt-get update` `gpg` failures in [help-steps/pre](https://github.com/Whonix/Whonix/blob/master/help-steps/pre), function `aptgetgpgvcreatetmp` and function `aptgetgpgvparsetmp`. `apt-get update` network failures: T169)\n\nAnother limitation is, that it does not check the version numbers of the build dependencies. Installs those from the repository, that you `apt-get update`d beforehand. Isn't able to resolve or fetch packages if download from newer (such as `testing`) repository is required. That would require more implementation effort. I think that is also the reason, why I didn't implement `make deb-build-dep` any earlier."}]},"PHID-TASK-jacuxrlx623nyp3clirj":{"id":"166","title":"rename /etc/uwt.d/32_uwt_default to /etc/uwt.d/32_uwt_qubes","status":"resolved","priority":"Normal","author":"Patrick","description":"Please rename `/etc/uwt.d/32_uwt_default` to `/etc/uwt.d/32_uwt_qubes` or `/etc/uwt.d/32_qubes`. Because it's not the uwt default file.\n\n(The `_uwt_` is superfluous since the folder name already includes `uwt`. It's a relict from times where it was inside the whonix.d folder.)\n\nMost correct file names would be:\n\n* `/etc/uwt.d/30_default`\n* `/etc/uwt.d/32_qubes`","comments":[{"author":"nrgaway","date_created":1424072545,"date_modified":1424072545,"content":"32_uwt_default renamed to 32_qubes\n\n[[ https://github.com/nrgaway/qubes-whonix/commit/559694e1f699f52a1fb099786843efbfa101ddf6 | https://github.com/nrgaway/qubes-whonix/commit/559694e1f699f52a1fb099786843efbfa101ddf6 ]]\n\nIs there a way to remove this from Qubes tasks now so I don't see the task in current Qubes tasks?\n\n"},{"author":"Patrick","date_created":1424074542,"date_modified":1424074542,"content":">>! In T166#2083, @nrgaway wrote:\n> Is there a way to remove this from Qubes tasks now so I don't see the task in current Qubes tasks?\n\nCreated T178 for it."}]},"PHID-TASK-dn66cyz45u6w56ibd4kz":{"id":"165","title":"anonymous package rebuilds difficult when changing debian/changelog e-mail address","status":"resolved","priority":"Normal","author":"Patrick","description":"__abstract issue description__:\n\nWhen in e-mail address /name of the maintainer in `debian/control` does not match `debian/changelog`, then `lintian` will show a warning.\n\n`lintian` runs as part of the generic makefile's `make deb-pkg` by default, unless environment variable `make_use_lintian` is set to `false`. This is useful to catch newly introduced errors that `lintian` would report.\n\n__example issue description__:\n\nExample `debian/control`:\n\n```\nMaintainer: Patrick Schleizer <adrelanos@riseup.net>\n```\n\nWorking `debian/changelog`:\n```\n -- Patrick Schleizer <adrelanos@riseup.net>  Wed, 04 Feb 2015 00:53:01 +0000\n```\n\nDefunct `debian/changelog`:\n```\n -- X Y <x@y.com>  Wed, 04 Feb 2015 00:53:01 +0000\n```\n\n__lintian warnings__:\n\n```\n+ lintian --pedantic --info --display-info --fail-on-warnings\nW: whonix-repository source: changelog-should-mention-nmu\nN: \nN:    When you NMU a package, that fact should be mentioned on the first line\nN:    in the changelog entry. Use the words \"NMU\" or \"Non-maintainer upload\"\nN:    (case insensitive).\nN:    \nN:    Maybe you didn't intend this upload to be a NMU, in that case, please\nN:    doublecheck that the most recent entry in the changelog is byte-for-byte\nN:    identical to the maintainer or one of the uploaders. If this is a local\nN:    package (not intended for Debian), you can suppress this warning by\nN:    putting \"local\" in the version number or \"local package\" on the first\nN:    line of the changelog entry.\nN:    \nN:    Refer to Debian Developer's Reference section 5.11.3 (Using the DELAYED/\nN:    queue) for details.\nN:    \nN:    Severity: normal, Certainty: certain\nN:    \nN:    Check: nmu, Type: source\nN: \nW: whonix-repository source: source-nmu-has-incorrect-version-number 3:1.1-1\nN: \nN:    A source NMU should have a Debian revision of \"-x.x\" (or \"+nmuX\" for a\nN:    native package). This is to prevent stealing version numbers from the\nN:    maintainer.\nN:    \nN:    Maybe you didn't intend this upload to be a NMU, in that case, please\nN:    doublecheck that the most recent entry in the changelog is byte-for-byte\nN:    identical to the maintainer or one of the uploaders. If this is a local\nN:    package (not intended for Debian), you can suppress this warning by\nN:    putting \"local\" in the version number or \"local package\" on the first\nN:    line of the changelog entry.\nN:    \nN:    Refer to Debian Developer's Reference section 5.11.2 (NMUs and\nN:    debian/changelog) for details.\nN:    \nN:    Severity: normal, Certainty: certain\nN:    \nN:    Check: nmu, Type: source\nN:\n```\n\n__current workarounds__:\n\n* Adding to `debian/control` for example something like this:\n\n```\nUploader: Patrick Schleizer <adrelanos@riseup.net>\n```\n\n* \"Keeping the false names.\"\n\n__Why is that problematic?__:\n\nIt makes package rebuilds by anonymous people harder. They wouldn't just have to bump `debian/changelog`, but also have to modify `debian/control`.\n\nAs a current practical example, for building the [qubes-whonix](https://github.com/nrgaway/qubes-whonix) package, Patrick would have to modify `debian/control` first (and get that patch merged), then bump the changelog version, then build the package. Or as a really non-ideal solution, keep Jason's name.\n\n__non-solutions__:\n\n* Adding `lintian` overrides to all the packages. Would make inclusion of packages into the Debian repository harder - maintainers would have to remove these files first.\n* Not failing closed on `lintian` warnings by default would be a pity, now that all `lintian` warnings, even when running `--pedantic` are fixed, no?\n\n__possible solution__:\n\nHaving a [`lintian` vendor profile](https://lintian.debian.org/manual/section-2.5.html), that disables these `lintian` tests.","comments":[{"author":"nrgaway","date_created":1423998237,"date_modified":1423998237,"content":"I can change or modify it to whatever works. \n\nDo you already have a vendor profile I can use that you know works?  Or maybe another suggestion. I will then implement it; or you can push changes and I will update the master branch."},{"author":"Patrick","date_created":1424000441,"date_modified":1424000441,"content":"> Do you already have a vendor profile I can use that you know works?\n\nNot yet, but it looks simple."},{"author":"Patrick","date_created":1424014877,"date_modified":1424014877,"content":"Instead of using.\n\n```\nanon-base-files (3:0.8-1) unstable; urgency=low\n\n  * New upstream version.\n\n -- Patrick Schleizer <adrelanos@riseup.net>  Wed, 04 Feb 2015 00:51:16 +0000\n```\n\nAlso using the following would work.\n\n```\nanon-base-files (3:0.8-1) unstable; urgency=low\n\n  * New upstream version (local package).\n\n -- X Y <x@y.net>  Wed, 04 Feb 2015 00:51:16 +0000\n```\n\nIn other words. So instead of using as changelog message.\n\n```\n  * New upstream version.\n```\n\nChanging the changelog message to.\n\n```\n  * New upstream version (local package).\n```\n\nDoes the trick.\n\nUnless there are objections, I a solution along this implementation path should be preferred. Much simpler than a lintian profile, that would require setting the `LINTIAN_ROOT` environment variable."},{"author":"Patrick","date_created":1424022026,"date_modified":1424022026,"content":"done,\nmakefile generic: set default message for make deb-chl-bumpup to \"New upstream version (local package).\" and made it configurable by DEBCHANGE_MSG environment variable to ease anonymous package rebuilds when changing debian/changelog e-mail address:\nhttps://github.com/Whonix/Whonix/commit/c1174ecaad44492f733ce73874328dd990082394"}]},"PHID-TASK-mgo4wqtlefhjkze3sesd":{"id":"164","title":"/etc/xdg/autostart/ NotShowIn necessary?","status":"invalid","priority":"Normal","author":"Patrick","description":"https://github.com/nrgaway/qubes-whonix/blob/51ec5194008e71bcfdd9b8e82aa9f76dc2077dc3/debian/qubes-whonix.postinst#L195\n\n```\n# Modify desktop files not to show in Qubes\nfor item in = /etc/xdg/autostart/pulseaudio-kde.desktop \\\n/etc/xdg/autostart/gateway_first_run_notice.desktop \\\n/etc/xdg/autostart/spice-vdagent.desktop \\\n/etc/xdg/autostart/whonixsetup.desktop \\\n/etc/xdg/autostart/whonix-setup-wizard.desktop ; do\nshowIn \"${item}\" 'NotShowIn=QUBES;'\ndone\n```\n\nWhat's the good for? Does it actually make a difference? As far I know, elements in `/etc/xdg/autostart` are not shown in start menu anyhow. The `NotShowIn` would be without effect there.\n\nI advice to not modify these files that way, otherwise users run into an interactive dpkg conflict resolution dialog on upgrade of the qubes-whonix package.","comments":[{"author":"nrgaway","date_created":1423997747,"date_modified":1423997747,"content":"Yes its required.  It will prevent items from starting in Qubes that we do not want started.  The may not show, but they will start if in the autostart directory.  This is a Qubes function [[ https://github.com/nrgaway/gui-agent-linux/commit/3287ae87cf00b61d0e9ba8a8f5ca301f9123b3b7#diff-d8b9296a2c6a78a087ed04f21ceadf8aR61 | https://github.com/nrgaway/gui-agent-linux/commit/3287ae87cf00b61d0e9ba8a8f5ca301f9123b3b7#diff-d8b9296a2c6a78a087ed04f21ceadf8aR61 ]]\n\nConfiguration files should not create Debian conflicts and should prompt the user to use maintainers version or keep existing. Overdidden files are actually not touched; a copy of them is moved into the /usr/share/qubes/xdg/autostart which is given priority over /etc/xdg.\n\nI use this to prevent whonix setup from starting, since I manually start it; otherwise it starts too early in Qubes and you get problems like errors popping up ot it can block for upto a minute.\n\nIts also used for pulseaudio so system apps are not started and only qubes are."},{"author":"Patrick","date_created":1423998658,"date_modified":1423998658,"content":"> Configuration files should not create Debian conflicts and should prompt the user to use maintainers version or keep existing.\n\nThat's what I mean by interactive dpkg conflict resolution dialog. And I find that really non-ideal. Creates lots of concerned noise in the forums.\n\n> I use this to prevent whonix setup from starting, since I manually start it; otherwise it starts too early in Qubes and you get problems like errors popping up ot it can block for upto a minute.\n\nIssue introduced by Qubes or Whonix? Does Qubes or Whonix have a ticket for that? I think that is something worth fixing in a way that won't need that kinds of overrides."},{"author":"nrgaway","date_created":1423999464,"date_modified":1423999464,"content":"Its a Whonix issue at this point; mostly related to systemd I would think.  Once you have proper systemd scripts I can easily over-ride them properly.  I had to get creative to get the VM to boot reliablably and was one of the reasons tor and swdate is disabled until right before I manually enable them and run the setup-wizard.\n\nAs for the xdg/autostart files, the original files located in that directory are not modified at all.  The stay in the original state.  A copy of it, say whonix-setup-wizard is copied to /usr/share/qubes/xdg/autostart and that files is patches with the 'NotShownIn=Qubes' and since the path to the qubes-xdg directory is before the /etc/xdg/autostart path, the original file will never be processed as I implemented in that code snippet above."},{"author":"Patrick","date_created":1424000346,"date_modified":1424000346,"content":"> Once you have proper systemd scripts I can easily over-ride them properly.\n\nWhy would they need to be overwritten? Can we solve this in Whonix as well?"},{"author":"nrgaway","date_created":1424065231,"date_modified":1424065231,"content":"I am not too sure.  Currently all the startup logic is handled in [[ https://github.com/nrgaway/qubes-whonix/blob/9.6-1/usr/lib/qubes-whonix/qubes-whonixsetup | https://github.com/nrgaway/qubes-whonix/blob/9.6-1/usr/lib/qubes-whonix/qubes-whonixsetup ]].\n\nIt is separated into 3 sections, gateway, workstation and template.  Currently as stated above I handle the starting of whonix-setup-wizard, tor and sdwdate due to some race conditions as described earlier which should be solved when systemd unit files are created.\n\nI also execute whonix-setup-wizard as follows:\nXDG_CURRENT_DESKTOP=gnome sudo /usr/bin/whonix-setup-wizard setup -style gtk+\n\nAdding a gtk+ style so it does not look so ugly on bootup. A common issue among all distros is having styles set for root users.  I would like this issue solved across the board so all the Whonix programs started as root are using a preferred style (maybe create another issue for this).\n\nThe other thing the qubes-whonixsetup script does is prevent setup from running in a template; since the template does not have complete Internet access (only for apt-get via proxy) AND replacing IP addresses would not work correctly.  It also blocks all access, even to updates if the netvm is not set to a whonix-gateway proxy (therefore only allowing updates via tor).\n\n"},{"author":"Patrick","date_created":1424123341,"date_modified":1424123341,"content":"I hope in most cases the hiding/deactivation of these files could be prevented by using cleaner solutions. For some, that might not be possible (maybe not for pulseaudio-kde.desktop, we'll see).\n\nFor all files to be hidden I highly recommend using [config-package-dev](http://debathena.mit.edu/config-packages/)'s (available from Debian repo) hide operation. Messing around with files owned by other packages is hard and leads to many issues when updated. That's why there is an abstraction to handle all these cases. Here is a super simple example package, that hides a single file:\nhttps://github.com/Whonix/knetattach-hide\n\nI think the root causes should be fixed in a later version. Feel free to reopen and assign this to a later tag/version."}]},"PHID-TASK-ufr5r4md7rwavxynq2s5":{"id":"163","title":"use /etc/whonix_firewall.d/32_qubes rather than /etc/whonix_firewall.d/30_default","status":"resolved","priority":"Normal","author":"Patrick","description":"Use `/etc/whonix_firewall.d/32_qubes` rather than `/etc/whonix_firewall.d/30_default`. Otherwise users run into an [dpkg interactive conflict resolution dialog](https://www.whonix.org/wiki/Whonix_Configuration_Files#dpkg_interactive_conflict_resolution_dialog) next time Whonix is upgraded.\n\n`/etc/whonix_firewall.d` is a [.d Style Configuration Folder](https://www.whonix.org/wiki/Whonix_Configuration_Files#.d_Style_Configuration_Folders). So you can just drop your snippet and overrule existing settings.","comments":[{"author":"nrgaway","date_created":1423996975,"date_modified":1423996975,"content":"/etc/whonix_firewall.d/30_default was identified by you as one of the configurations files that needed it IP address changed.  The only change is to update the IP address to those of Qubes.\n\nShould a complete copy of 40_qubes be written to 30_default and will that completely override 40_qubes?"},{"author":"Patrick","date_created":1423998174,"date_modified":1423998174,"content":"Don't write to `30_default` at all (or dpkg interactive conflict resolution dialog will pop up on update).\n\nA complete copy is neither useful nor required.\n\nLet's say for example `30_default` contains `CONTROL_PORT_FILTER_PROXY_ENABLE=1` and you dislike that setting. Then just create a file `40_something` and the only code relevant line would be `CONTROL_PORT_FILTER_PROXY_ENABLE=0`. That's it. (Additional stuff: license header, comments for explanation.)\n\nThen the `CONTROL_PORT_FILTER_PROXY_ENABLE` setting from `30_ default` would never be used. Only the one from `40_something`.\n\nSo just set the IP variable you want to override in the config file with the higher (lexical) name.\n\n(I am not sure if `32_` or `40_` is best. https://www.whonix.org/forum/index.php/topic,841.msg6207.html#msg6207)"},{"author":"nrgaway","date_created":1424073116,"date_modified":1424073116,"content":"Removed /etc/whonix_firewall.d/30_default from the replace-ips scripts since all the IP addresses within 30_default are commented out which resolves the issue of modifying the file to begin with.\n\n[[ https://github.com/nrgaway/qubes-whonix/commit/f2678cf2de8ebde15a62929d5c1ea14d16a37008 | https://github.com/nrgaway/qubes-whonix/commit/f2678cf2de8ebde15a62929d5c1ea14d16a37008 ]]"}]},"PHID-TASK-nckcyib6vzku7qmzkcb2":{"id":"162","title":"qubes-whonix handling of /etc/timezone and /etc/localtime","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/nrgaway/qubes-whonix/commit/51ec5194008e71bcfdd9b8e82aa9f76dc2077dc3\n\n```\n# Set timezone to UTC and make files immutable\ntimezone='UTC'\ncp -p /usr/share/zoneinfo/${timezone} /etc/localtime\ncp -p /usr/share/zoneinfo/${timezone} /etc/localtime.anondist\necho \"${timezone}\" > /etc/timezone\necho \"${timezone}\" > /etc/timezone.anondist\nchattr +i /etc/localtime\nchattr +i /etc/timezone\n```\n\nWhat's the good for? Anything wrong with the [timezone-utc](https://github.com/Whonix/timezone-utc) package?\n\nIssues:\n\n* `chattr +i` is problematic, because in a later upgrade, `echo \"${timezone}\" > /etc/timezone` will fail and the postinst script will abort.\n* There is no file `/etc/timezone.anondist`.\n* It robs the user's ability to choose custom setting. Would be re-applied on upgrade of the `qubes-whonix` package.\n* Doesn't belong in that package?\n","comments":[{"author":"nrgaway","date_created":1423996646,"date_modified":1423996646,"content":"Qubes resets the timezone on start and syncs it to dom0.\n[[ https://github.com/nrgaway/core-agent-linux/blob/master/vm-systemd/qubes-sysinit.sh#L78 | https://github.com/nrgaway/core-agent-linux/blob/master/vm-systemd/qubes-sysinit.sh#L78 ]]\n\n```\ntimezone=`$QDB_READ /qubes-timezone 2> /dev/null`\nif [ -n \"$timezone\" ]; then\ncp -p /usr/share/zoneinfo/$timezone /etc/localtime\nif [ -e /etc/debian_version ]; then\n    echo \"$timezone\" > /etc/timezone\nelse\n    echo \"# Clock configuration autogenerated based on Qubes dom0 settings\" > /etc/sysconfig/clock\n    echo \"ZONE=\\\"$timezone\\\"\" >> /etc/sysconfig/clock\nfi\n```\nThe chattr +i is to prevent timezone from being changed as that is part of the over all security.  An update to the Qubes package could trigger a timezone change.  \n\nThe /etc/timezone.anondist is created in the post init script.  An update could handle the error by either testing for chattr first, disabling it or trapping the error alla || true.  The init scripts also make sure its properly in place as well.\n\nWe could always add a utility to change the behaviour in an update.\n\nCan you think of another way to secure the timezone, as I don't believe it should just be left as-is."},{"author":"nrgaway","date_created":1423998900,"date_modified":1423998900,"content":"I just went to add 'chattr -i'  and noticed I already had that in place: [[ https://github.com/nrgaway/qubes-whonix/blob/9.6-1/debian/qubes-whonix.postinst#L209 | https://github.com/nrgaway/qubes-whonix/blob/9.6-1/debian/qubes-whonix.postinst#L209 ]].  I wonder if you need to pull changes?\n\nCurrently both my master and 9.6-1 branch should be in sync"},{"author":"Patrick","date_created":1423999000,"date_modified":1423999000,"content":"I have a simpler solution in mind.\n\nfeature request against `core-agent-linux` that basically says:\n\"If setting Y is set in X (.d style folder preferred), then omit syncing vm timezone to dom0, because ... anonymity distributions ...\"\n\nWhat do you think?\n\nIn long term, implement that feature. In short term, add a comment that references that ticket."},{"author":"nrgaway","date_created":1423999786,"date_modified":1423999786,"content":"Yes, it would be best handled in Qubes.  In the mean time we keep it as is, since I do have the code to prevent failure to write on an update and I would assume anything else writing to a configuration file that is not its own would have a graceful way of failing."},{"author":"Patrick","date_created":1439409947,"date_modified":1439409947,"content":"Actually there is a very elegant solution to this that requires no changes in Qubes.\n\n`/etc/qubes/protected-files.d/30_qubes-whonix`:\n\n```\n/etc/timezone\n/etc/localtime\n/etc/hostname\n/etc/hosts\n/etc/resolv.conf\n```\n\nI am just wondering in which package it fits best #anon-base-files, #anon-gw-dns-conf and #anon-ws-dns-conf or just to #qubes-whonix_12. Ideally, the #qubes-whonix_12 package could be made obsolete one day? Or be reduced to a bare minimum? It's a code style question. Having all the Qubes specific tweaks for various things within one package (\n(#qubes-whonix_12) versus having those added in \"upstream packages\"."},{"author":"Patrick","date_created":1439581174,"date_modified":1439581174,"content":"State of `/usr/lib/qubes-whonix/init/qubes-whonix-sysinit` at time of writing:\nhttps://github.com/Whonix/qubes-whonix/blob/df04392a60c6c0c9edc0fe0909610f9711b31d4c/usr/lib/qubes-whonix/init/qubes-whonix-sysinit\n\nCurrently you are creating the protected files list dynamically. I think this can be avoided as commented above by dropping config files into `/etc/qubes/protected-files.d/`.\n\nNow,\n\n* since we are no longer using `chattr +i`\n* since the qubes-whonix package is installed in chroot during build, therefore no Qubes services are started that could modify any of the protected files\n* since the `/etc/qubes/protected-files.d/` mechanism prevents qubes-core-agent from modifying the protected files...\n\nI think the whole code block could be removed. Marked here:\nhttps://github.com/Whonix/qubes-whonix/blob/df04392a60c6c0c9edc0fe0909610f9711b31d4c/usr/lib/qubes-whonix/init/qubes-whonix-sysinit#L27-L48\n\nAlso the following could be removed:\nhttps://github.com/Whonix/qubes-whonix/blob/df04392a60c6c0c9edc0fe0909610f9711b31d4c/usr/lib/qubes-whonix/init/qubes-whonix-sysinit#L62-L63\n\nI am planning to do this.\n\nDoes anything speak against this? @nrgaway\n"},{"author":"nrgaway","date_created":1439643035,"date_modified":1439643035,"content":"Go nuts at it ;)\n\nNow you can do actual testing, changes like this are acceptable to me.\n\nI think you should be housing the master `qubes-whonix` and `template-whonix` now also so you are better able to integrate into Whonix code base."},{"author":"Patrick","date_created":1439664776,"date_modified":1439664776,"content":"Alright! :)"},{"author":"Patrick","date_created":1441727552,"date_modified":1441727552,"content":"`abolished hack to write to /etc/localtime and /etc/timezone because now using Qubes protected files mechanism`:\nhttps://github.com/Whonix/qubes-whonix/commit/d11e42836f027c00e321c2660e332bbd47bd2670\n"},{"author":"Patrick","date_created":1441727599,"date_modified":1441727599,"content":">>! In T162#1975, @Patrick wrote:\n> I have a simpler solution in mind.\n> \n> feature request against `core-agent-linux` that basically says:\n> \"If setting Y is set in X (.d style folder preferred), then omit syncing vm timezone to dom0, because ... anonymity distributions ...\"\n\nThis is now implemented by the Qubes protected files mechanism:\nhttps://github.com/marmarek/qubes-core-agent-linux/blob/master/vm-systemd/qubes-sysinit.sh\n"}]},"PHID-TASK-qit7i3nji3dedllrsrdf":{"id":"161","title":"use 'getinfo consensus/packages' rather than RecommendedTBBVersions","status":"open","priority":"Normal","author":"Patrick","description":"```\ngetinfo consensus/packages\n```\n\nIntroduced in `tor` `0.2.6.3-alpha`.\n\nReference:\n* https://trac.torproject.org/projects/tor/ticket/10395\n\nRelated:\n* T130\n","comments":[{"author":"Patrick","date_created":1439598592,"date_modified":1439598592,"content":"Cannot be implemented at this point. `getinfo consensus/packages` exists, but it's not populated yet. Upstream tickets:\n\n* https://trac.torproject.org/projects/tor/ticket/10393\n* https://trac.torproject.org/projects/tor/ticket/14676\n"}]},"PHID-TASK-l34otfxrkimqvb7z4xzv":{"id":"160","title":"whonix-setup-wizard release 0.5-1","status":"resolved","priority":"Normal","author":"Patrick","description":">>! In T155#1895, @nrgaway wrote:\n> Patrick, Can you create a branch/tag and sign it for whonix-setup-wizard / pythton-guimessages so I can include it in the Qubes Whonix 9.6 release that I hope to have completed today or tomorrow?\n","comments":[{"author":"Patrick","date_created":1423779527,"date_modified":1423779527,"content":"Not sure it's a good idea to sneak in new packages into 9.6 or maintenance releases in general. It creates more diversity that could lead to dpkg dependency issues when the real upgrade to the next major version comes. That's perhaps a separate discussion.\n\nAnyhow. Since it's just a very few packages and signing is mostly scripted... And since you maintain it...\n\nDone with python-guimessages `0.3-1` and whonix-setup-wizard `0.5-1`.\n"},{"author":"nrgaway","date_created":1423780451,"date_modified":1423780451,"content":"Thanks!"}]},"PHID-TASK-m64ng5bcqsvjrk2b7fwt":{"id":"159","title":"WhonixBackupScript","status":"resolved","priority":"Normal","author":"Patrick","description":"https://www.whonix.org/wiki/WhonixBackupScript should be moved to #usability-misc package to make it better accessible and be prettied up a bit.","comments":[{"author":"Patrick","date_created":1459621547,"date_modified":1459621547,"content":"```\nimplemented Whonix website and source code backup utility\n\n/usr/bin/whonix-dev-backup\n\nhttps://phabricator.whonix.org/T159\n```\nhttps://github.com/Whonix/usability-misc/commit/ddef42a5b383c82d107c00aac22c1836004a8158"}]},"PHID-TASK-lqcv43rwjmjw3vfpufwi":{"id":"158","title":"whonix-ws-firewall needs a VPN_FIREWALL feature","status":"resolved","priority":"Normal","author":"Patrick","description":"bug report:\nhttps://forums.whonix.org/t/vpn-firewall-doesnt-work/858\n\ndesign discussion for this feature:\nhttps://forums.whonix.org/t/whonix-workstation-firewall-vpn-firewall-feature-design-discussion/886","comments":[{"author":"Patrick","date_created":1452287273,"date_modified":1452287273,"content":"`work on Whonix-Workstation VPN_FIREWALL feature`:\nhttps://github.com/Whonix/whonix-ws-firewall/commit/10a5366cb5ea32928a4b0d945621d291da43cdcc"},{"author":"Patrick","date_created":1452372508,"date_modified":1452372508,"content":"https://github.com/Whonix/whonix-ws-firewall/commit/057cafbca9f44c43dad47c2320840bd176d2f45c"},{"author":"Patrick","date_created":1453062272,"date_modified":1453062272,"content":"https://github.com/Whonix/whonix-ws-firewall/commit/d065fab590b4793791d6ee0424f40d6e6d2321ea"},{"author":"Patrick","date_created":1461983624,"date_modified":1461983624,"content":"```  \nApr 20 03:50:45 host systemd-tmpfiles[281]: Two or more conflicting lines for /run/openvpn configured, ignoring.\n```\nBut since user `tunnel` has access to `/var/run/openvpn`, it should be alright."},{"author":"Patrick","date_created":1462381009,"date_modified":1462381009,"content":"This is now documented including a fix for T460.\n\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_a_VPN#Setup_Tor_before_a_VPN_.28User_-.3E_Tor_-.3E_VPN_-.3E_Internet.29\n\nAnd tested.\n\nHowever, the documentation doing this with openvpn including a fix for T460 ridiculously difficult. Perhaps bitmask would do a bettter job than openvpn, created T506 to figure that out."}]},"PHID-TASK-hntrcpqrulmdmitglosq":{"id":"157","title":"find alternative to git submodules","status":"open","priority":"Normal","author":"Patrick","description":"__Current - Status__:\n\n* There are ~110 packages.\n* The [Whonix main repository / build script](https://github.com/Whonix/Whonix) references packages as git sub modules. I.e. The main repository points to the exact git commit hash of every package.\n* This has the advantage, when `git tag`ing a release (such as Whonix 9.6) it points to the exact commit hashes that have been used to create that release (such as 9.6).\n* There is no need to manually maintain a list such as \"of package X, version Y\" should go into Whonix 10.\n\n-----\n\n__Current - Git Submodule Disadvantages__:\n\n* consensus by many developers Patrick spoke to, that those are a pain to work with and should be avoided\n* those are a pain to merge\n* git branching the main repository is effectively useless as soon as changes to the packages are made `2`\n* when switching to older tags, branches or commits, package folders from newer versions are leftovers shown as non-commited folders) ([a known issue](http://stackoverflow.com/questions/5383863/git-submodules-switching-branches-and-the-recommended-way-to-include-external))\n\n-----\n\n__Alternative - Requirements__:\n\n* Individual Whonix Debian Packages ([list](https://github.com/Whonix)) (such as for example, [rads](https://github.com/Whonix/rads)) should stay in their own separate git repository. `1`\n* Allow everyone to audit each and every commit. But do not require them to review the same commits twice because of code duplication.\n\n-----\n\n__Alternative - Maybe Goals__:\n\n* Avoiding code duplication. Having all the packages code in the packages repositories as well as in the main repository seems wrong.\n* Similarly, avoiding duplication of git history.\n\n-----\n\n__Alternatives to be considered__:\n\n* git subfolders\n\n-----\n\n__Footnotes__:\n\n`1` A long time ago, all the files that Whonix ships were inside one single git repository. Later, all of Whonix's Debian Packages were inside one single git repository. Both methods made Whonix more difficult to grasp and harder to contribute. Splitting Whonix into multiple packages was a very good decision. Much more people are now working on specific functionality of Whonix in separate packages.\n`2` When merging, it branches and merges commit hashes rather than files.\n\n-----\n\n__TODO__:\n\n* Think this more throughly through (requirements, goals).\n* After having a good overview, discussion it with various developers to find suggestions on how alternatives could look like.","comments":[{"author":"HulaHoop","date_created":1426937524,"date_modified":1426937524,"content":"http://stackoverflow.com/questions/6714785/git-submodule-alternative\n\nhttp://blogs.atlassian.com/2013/05/alternatives-to-git-submodule-git-subtree/ (git-subtrees are another option)"},{"author":"Patrick","date_created":1426956355,"date_modified":1426956355,"content":"Just tested git subtree. It duplicates all code in the main repository. I don't think it would make things any simpler."},{"author":"HulaHoop","date_created":1426973225,"date_modified":1426973225,"content":"What about:\n\nhttps://github.com/ingydotnet/git-subrepo/  "},{"author":"Patrick","date_created":1427979227,"date_modified":1427979227,"content":"I haven't tested it. Essentially same issues as git subtree, looks like. Useful to know it exists.\n\n(Its author got some other interesting stuff. -> [off-topic](https://www.whonix.org/pipermail/whonix-devel/2015-April/000327.html))"}]},"PHID-TASK-gzbz3l2a2g5tszcnwrbh":{"id":"156","title":"whonix-setup-wizard start bug if /usr/bin/kcmshell4 does not exist","status":"resolved","priority":"Normal","author":"Patrick","description":"I think here is currently a bug:\n\n```\n    if not os.path.exists('/usr/bin/kcmshell4'):\n        sys.exit(0)\n```\n\nBecause whole whonix-setup-wizard will refuse to work just because `/usr/bin/kcmshell4` does not exist. While the real intent is just to skip running `locale_settings`.","comments":[{"author":"Patrick","date_created":1423540226,"date_modified":1423540226,"content":"Done:\nhttps://github.com/Whonix/whonix-setup-wizard/commit/ec04e296843ff09dcdb890474963bc161ee0efd3\n\nCan you review and merge please, @troubadour?"},{"author":"troubadour","date_created":1423601443,"date_modified":1423601443,"content":"There was an issue in `if kcmshell == \"\":`. Should be `if kcmshell == None:` in python.\n\nReorganized it a bit to add a warning finish page if `kcmshell4` is not found (no `print`).\nhttps://github.com/troubadoour/whonix-setup-wizard/commit/730f693bed51966b128fb051faee804aff3b9f5a\n\nThe `distutils.spawn` was a good find. The less we use `os`, the better."},{"author":"troubadour","date_created":1423602795,"date_modified":1423602795,"content":"Forgot to push the updated translations.\nhttps://github.com/troubadoour/whonix-setup-wizard/commit/161f7304be95f5f7fc1c25be13ebd6c4b25d3c78"},{"author":"Patrick","date_created":1423617771,"date_modified":1423617771,"content":"Merged.\n\nI think there is a problem. It doesn't exit anymore without showing a message. ;)\n\nBackground: we supposed to run it for default builds, for KDE users. For custom builds using other desktops such as GNOME, we wanted to just skip it and exit. Now when `whonix-setup-wizard locale_settings` is being run, it would interrupt the boot process (we wanted to start it using `xinit`) without working for these type of users. Not a good idea?"},{"author":"troubadour","date_created":1423668968,"date_modified":1423668968,"content":"Some misunderstanding here. Have put the check for `kcmshell4` in the main function, so that it exits without starting the wizard if not found.\nhttps://github.com/troubadoour/whonix-setup-wizard/commit/02da9d4fb6873087c3aa8450b75cba0476af1f2e"},{"author":"Patrick","date_created":1423670150,"date_modified":1423670150,"content":"```\n                        command = '/usr/bin/kcmshell4 language'\n```\nvs\n\n```\n                            command = '%s language' % (kcmshell)\n```\n\nThe latter is more correct. Because it does not hard code the path to `/usr/bin`. Let's say the path changed to `/usr/sbin` (unlikely in this case, but generally), then we're better off using the latter.\n\nThe latter works for any default path, that can (probably?) be set using the PATH environment variable. Some people like to add wrappers to `/usr/local/bin`, that are always preferred over `/usr/bin`. Or manually compile and install to `/usr/local/bin`. Not a big deal, but more correct and a future bug report we can prevent.\n\n-----\n\n`locale settings are designed for KDE desktop.` -> Really? I'd rather say `locale settings are currently only implemented for KDE desktop.`"},{"author":"troubadour","date_created":1423672739,"date_modified":1423672739,"content":"Yes to both. For the first one, just have to add the line `kcmshell = distutils.spawn.find_executable(\"kcmshell4\")` before the commands. Wiil do right away."},{"author":"troubadour","date_created":1423673303,"date_modified":1423673303,"content":"Done."},{"author":"Patrick","date_created":1423676797,"date_modified":1423676797,"content":"Alright. :)"}]},"PHID-TASK-tzqbaoqwiqfbuqswjma2":{"id":"155","title":"whonix-setup-wizard, more generic state file mechanism for status files","status":"resolved","priority":"Normal","author":"Patrick","description":"We have\n\n* `/home/user/.gateway/first_use_check.done`\n* `/var/lib/whonix/do_once/whonixsetup.done` as whonix-repository-wizard done file\n* We also need one for `locale_settings_finish`?\n\n------\n\nI am prosing a more generic approach. Here is an example:\n\n* `/var/lib/whonix-setup-wizard/status-files/disclaimer.skip`\n* `/var/lib/whonix-setup-wizard/status-files/disclaimer.done`\n\n* `/var/cache/whonix-setup-wizard/status-files/disclaimer.skip`\n* `/var/cache/whonix-setup-wizard/status-files/disclaimer.done`\n\n-----\n\n`/var/lib/whonix-setup-wizard`:\n\nUsers, custom builders and derivative distributions (Whonix Qubes can be considered a derivative of Whonix) can use that one. whonix-setup-wizard never touches folder for writing. Also not during `apt-get purge`. Only for reading.\n\nWhonix Qubes does not need/want the disclaimer, so their `qubes-whonix` package could ship a `/var/lib/whonix-setup-wizard/status-files/disclaimer.skip` file.\n\n-----\n\n`/var/cache/whonix-setup-wizard/status-files`:\n\nUsed by whonix-setup-wizard for status files. Once the user accepted the disclaimer, a file `/var/lib/whonix-setup-wizard/status-files/disclaimer.done` could be created. And on next run, we can skip the disclaimer wizard page. The `/var/cache/whonix-setup-wizard/status-files` folder would not be deleted on `apt-get remove`, but it would be removed on `apt-get purge`.\n\n-----\n\nWe could also stick to the current convention `whonix/do_once`, since it's a Whonix specific application.\n\n-----\n\nHaving this mechanism, we could have a python function, that abstracts checking these two folders for existing status files. So we can run that function and say \"if function says, state file exists, skip it, otherwise continue\".\n\n-----\n\nThe `apt-get` `remove` vs `purge` distinction can very easily be implemented by me in `debian/` maintainer scripts.\n\n-----\n\nWhat do you think?","comments":[{"author":"troubadour","date_created":1423605631,"date_modified":1423605631,"content":"Yes, it's certainly better to skip the disclaimer pages when the user re-run the wizard. That means that in Workstation, it could be shown only once, at first boot (it has only disclaimer and whonix repository, if `disclaimer.done` and  `whonixsetup.done`, that's it, only whonix repository available. It's not a problem).\n\nWe still need `whonix/do_once` anyhow, in order not to run the wizard at each boot (in Workstation), but it looks like only two new files are sufficient for achieving this.\n\n- `/var/lib/whonix-setup-wizard/status-files/disclaimer.skip` for Whonix Qupes or other derivatives not wanting the disclaimer. If the file exists,  never show the pages.\n\n- `/var/cache/whonix-setup-wizard/status-files/disclaimer.done` could work the same way as `/var/lib/whonix/do_once/whonixsetup.done`(do not show the pages if the file exists).\n\n> Having this mechanism, we could have a python function, that abstracts checking these two folders for existing status files. So we can run that function and say \"if function says, state file exists, skip it, otherwise continue\".\n\nThe only place where to implement the check seems to be the wizard itself (a few more `if`. At some stage, will have to comment all that in the code, for future re-reading)."},{"author":"Patrick","date_created":1423618223,"date_modified":1423618223,"content":"Yes."},{"author":"troubadour","date_created":1423684281,"date_modified":1423684281,"content":"`done` state files: we have `first_use_check.done`, `disclaimer.done` and `whonixsetup.done`. Since they are all used exclusively by whonix-setup-wizard, they could be grouped in a single directory instead of being scattered in three different places."},{"author":"troubadour","date_created":1423685811,"date_modified":1423685811,"content":"`whonixsetup.done` could become `whonix_repository.done`. That's its exact function in Gateway, and in Workstation too, if we put aside the disclaimer.\n\nThe change for the `done` files is completed in whonix-setup-wizard. Provisionally, will create `/var/cache/whonix-setup-wizard/status-files/` and write the state files there, except may be for `disclaimer.skip`."},{"author":"Patrick","date_created":1423690269,"date_modified":1423690269,"content":"Did you git push yet?"},{"author":"troubadour","date_created":1423691211,"date_modified":1423691211,"content":"Done now.\n\nWas a problem with whonix-repository when going back from the finish page. Do not delete the repository pages any longer, so the back button goes through all the pages. Apart from fixing the issue, it's sensible, I think, and the code is clearer."},{"author":"Patrick","date_created":1423692168,"date_modified":1423692168,"content":"Yeah, maybe just one folder with \".skip\" and \".done\" files will be better. Not 100% Debian policy compliant, but whonix-setup-wizard won't get into Debian anyhow, so it does not matter. This simpler solution is better overall.\n\nYou have one `/var/lib/` left at the moment. The rest uses `/var/cache`.\n\nWhat makes this non-intuitive is, that \".skip\" and \".done\" files are not supported for every action. That's why I suggested a function that abstracts `/var/cache/whonix-setup-wizard/status-files/$varname[.skip|.done]`.\n"},{"author":"troubadour","date_created":1423692605,"date_modified":1423692605,"content":"Pushed two commits.\n- bug when running repository only.\n- issue with locale_settings wizard size.\n\nSo, we say that all the status files should be in `/var/cache/whonix-setup-wizard/status-files/`?"},{"author":"Patrick","date_created":1423694476,"date_modified":1423694476,"content":"Yes."},{"author":"troubadour","date_created":1423773575,"date_modified":1423773575,"content":"Done, plus some cleaning."},{"author":"nrgaway","date_created":1423776922,"date_modified":1423776922,"content":"Awesome!  I will test it out tonight.\n\nPatrick, Can you create a branch/tag and sign it for whonix-setup-wizard / pythton-guimessages so I can include it in the Qubes Whonix 9.6 release that I hope to have completed today or tomorrow?"},{"author":"Patrick","date_created":1423777358,"date_modified":1423777358,"content":"I am wondering, if instead of having.\n```\n        if environment == 'gateway' and show_disclaimer:\n```\n```\n        elif environment == 'gateway' and not show_disclaimer:\n```\nIf it would require less code/duplication to skip the disclaimer in the actual function? But I don't know, it might not be (easily) possible.\n\n```\n    show_disclaimer = (not os.path.exists('/var/cache/whonix-setup-wizard/status-files/disclaimer_done') and\n                       not os.path.exists('/var/cache/whonix-setup-wizard/status-files/disclaimer_skip'))\n```\nWhy `_`, i.e. why `_skip` and `_done` instead of `.`[...]?\n\nFor consistency, I think it would be better to also have `whonix_repository.skip` and `first_use_check.skip`.\n\nAnd I am wondering, how could we deal with locale_settings[.done|.skip]? Because then whonix-setup-wizard runs as user, not root. Means there would be no write access to /var/cache/whonix-setup-wizard/status-files/, unless we set it to writeable by anyone. That would be easily doable by using a Debian maintainer script, if that is acceptable. (The policy conform way would be to write into the user's home folder, but then we wouldn't have a consistent /var/cache/whonix-setup-wizard/status-files/ folder.)"},{"author":"Patrick","date_created":1423778447,"date_modified":1423778447,"content":"Added postinst script that creates /var/cache/whonix-setup-wizard/status-files folder:\nhttps://github.com/Whonix/whonix-setup-wizard/commit/e7ab058dcc40de3a2c77d64aafed6da8191771d9\n"},{"author":"Patrick","date_created":1423778799,"date_modified":1423778799,"content":">>! In T155#1895, @nrgaway wrote:\n> Patrick, Can you create a branch/tag and sign it for whonix-setup-wizard / pythton-guimessages so I can include it in the Qubes Whonix 9.6 release that I hope to have completed today or tomorrow?\n\n--> T160"},{"author":"troubadour","date_created":1423858876,"date_modified":1423858876,"content":">If it would require less code/duplication to skip the disclaimer in the actual function? But I don't know, it might not be (easily) possible.\nNo, we have to leave with this one (tried reducing the code duplication, could not find a way). \n\n> Why _, i.e. why _skip and _done instead of .[...]?\nMy mistake. https://github.com/troubadoour/whonix-setup-wizard/commit/04a7a34fd87616af0e428334eabdffce6edd79c1\n\n>The policy conform way would be to write into the user's home folder, but then we wouldn't have a consistent /var/cache/whonix-setup-wizard/status-files/ folder.\nI'm not familiar with Debian policy, but, why not write  all the files in `~/.whonix-setup-wizard/`. That would solve the issue with `locale_settings[.done|.skip]`? This part of the wizard is run as user.\n\n"},{"author":"Patrick","date_created":1423883917,"date_modified":1423883917,"content":"Okay, merged.\n\n>>! In T155#1915, @troubadour wrote:\n>>The policy conform way would be to write into the user's home folder, but then we wouldn't have a consistent /var/cache/whonix-setup-wizard/status-files/ folder.\n> I'm not familiar with Debian policy, but, why not write  __all__ the files in `~/.whonix-setup-wizard/`. That would solve the issue with `locale_settings[.done|.skip]`? This part of the wizard is run as user. (underline added by me)\n\nThere would be two issues. 1) Which `~`? `user` or `root`? 2) The worse issue is, that as per Debian policy, packages must not write into `~/`. If the `qubes-whonix` package would add its `.skip` files there, then they would also have to add a `lintian` override, because `lintian` would report a grave issue for installing files to `~/`."},{"author":"troubadour","date_created":1424034390,"date_modified":1424034390,"content":"OK.\n>> In T155#1896, @Patrick wrote:\n> And I am wondering, how could we deal with locale_settings[.done|.skip]? Because then whonix-setup-wizard runs as user, not root. Means there would be no write access to /var/cache/whonix-setup-wizard/status-files/, unless we set it to writeable by anyone. That would be easily doable by using a Debian maintainer script, if that is acceptable. (The policy conform way would be to write into the user's home folder, but then we wouldn't have a consistent /var/cache/whonix-setup-wizard/status-files/ folder.)\nI don't know what is better, policy wise, but as whonix-setup-wizard is too specific to be ever upstreamed, perhaps we're free to put it in `/var/cache/whonix-setup-wizard/status-files/`, writeable by anyone.\n"},{"author":"Patrick","date_created":1424072517,"date_modified":1424072517,"content":"It just occurred to me, that I think I heard, that Tails managed to upstream tails-installer to Debian or is in process to. So it may not be impossible. Anyhow. Yes. For now that's the simplest and fastest solution. Let's go for it. Done, made it writeable by everyone:\nhttps://github.com/Whonix/whonix-setup-wizard/commit/2cba459e7a2bba9b54b326177cf5af71b727b95b\n"},{"author":"troubadour","date_created":1424118198,"date_modified":1424118198,"content":"Ok. Pushed a cosmetic update (PEP8 compatibility, step 1)."},{"author":"Patrick","date_created":1424121469,"date_modified":1424121469,"content":"Merged."},{"author":"Patrick","date_created":1425931763,"date_modified":1425931763,"content":"instead of /var/lib/whonix/do_once/whonixsetup.done create /var/cache/whonix-setup-wizard/status-files/whonixsetup.done - https://phabricator.whonix.org/T155 :\nhttps://github.com/Whonix/whonix-setup-wizard/commit/3203700c6ad08e08ca0a987601c675a552eed987"},{"author":"Patrick","date_created":1425932122,"date_modified":1425932122,"content":"fix, create /var/cache/whonix-setup-wizard/status-files/whonixsetup.done also on Whonix-Gateway:\nhttps://github.com/Whonix/whonix-setup-wizard/commit/563462322791d060bb49d8c5632c8e50bb357b7c"},{"author":"Patrick","date_created":1425932453,"date_modified":1425932453,"content":"Also done in whonixcheck.\n\ninstead of /var/lib/whonix/do_once/whonixsetup.done check for /var/cache/whonix-setup-wizard/status-files/whonixsetup.done - https://phabricator.whonix.org/T155 :\nhttps://github.com/Whonix/whonixcheck/commit/fb02875f069f282aafb00218760c1f800c61c8cb"},{"author":"Patrick","date_created":1425933039,"date_modified":1425933039,"content":"Done in whonixsetup (cli).\n\ninstead of /var/lib/whonix/do_once/whonixsetup.done use /var/cache/whonix-setup-wizard/status-files/whonixsetup.done - https://phabricator.whonix.org/T155:\nhttps://github.com/Whonix/whonixsetup/commit/847b62eb81eed4e98e5dca2599484f08aa13e2d0"},{"author":"Patrick","date_created":1425979221,"date_modified":1425979221,"content":"Last one.\n\ninstead of /var/lib/whonix/do_once/whonixsetup.done use /var/cache/whonix-setup-wizard/status-files/whonixsetup.done - https://phabricator.whonix.org/T155:\nhttps://github.com/Whonix/whonix-setup-wizard/commit/5b379ec2e2dd27fd93e163fb4f35132d55d9fe0a"},{"author":"Patrick","date_created":1425979620,"date_modified":1425979620,"content":"implemented /var/cache/whonix-setup-wizard/status-files/whonix_repository.skip and /var/cache/whonix-setup-wizard/status-files/first_use_check.skip:\nhttps://github.com/Whonix/whonix-setup-wizard/commit/fc7aae5689f99755228a252916d18e874ff44c6d"},{"author":"Patrick","date_created":1425980526,"date_modified":1425980526,"content":"support for legacy /var/lib/whonix/do_once/whonixsetup.done:\n* https://github.com/Whonix/whonixcheck/commit/534e9a2df829744f2f2b3d4f1b5841ccded80216\n* https://github.com/Whonix/whonixsetup/commit/811d05e7c6f8ccbbba15f144dd59d0c394f1bdfd\n"},{"author":"Patrick","date_created":1425980612,"date_modified":1425980612,"content":"added support for /var/cache/whonix-setup-wizard/status-files/whonixsetup.skip:\nhttps://github.com/Whonix/whonix-setup-wizard/commit/c10ec2c5e45fa765536aba9ca372ea7aa68107a6"},{"author":"Patrick","date_created":1425980740,"date_modified":1425980740,"content":"support for legacy /var/lib/whonix/do_once/whonixsetup.done:\nhttps://github.com/Whonix/whonix-setup-wizard/commit/4a45a757d2e29b62ad66e27024a5d97701868cc4"},{"author":"Patrick","date_created":1425983124,"date_modified":1425983124,"content":"various whonixsetup (cli) improvements:\nhttps://github.com/Whonix/whonixsetup/commit/14f79aa21dd96fcc20281f3690ef2e12e1a9d581\n"},{"author":"Patrick","date_created":1425989002,"date_modified":1425989002,"content":"Anything missing here, @troubadour?"},{"author":"troubadour","date_created":1426105815,"date_modified":1426105815,"content":"No, it looks done, after https://www.whonix.org/forum/index.php/topic,705.msg7290.html#msg7290."}]},"PHID-TASK-niozqewfsvuteunwsdcq":{"id":"154","title":"control-port-filter-python should log pid rather than random uid","status":"resolved","priority":"Normal","author":"Patrick","description":"I suggested in past to add a random unique uid to the log so one could find out by viewing the log if multiple instances of control-port-filter-python got \"entangled\", i.e. if multiple were running at the same time. (Perhaps due to porting control-port-filter-python to some new platform / systemd etc.)\n\nBut why an uid? A pid seems much more simple, shorter and is perfect for this use case.\n\nTODO:\nChange from uid to pid.","comments":[{"author":"Patrick","date_created":1423529782,"date_modified":1423529782,"content":"Done:\nhttps://github.com/Whonix/control-port-filter-python/commit/be78ae7844603ad7fbd39677b16f5b7b434869a4\n\nCould you review this change please, @troubadour?"},{"author":"troubadour","date_created":1423601943,"date_modified":1423601943,"content":"Checked. OK. Yes, more readable."}]},"PHID-TASK-ockb5movkbxigth7dctc":{"id":"153","title":"control-port-filter-python should log when it terminates","status":"resolved","priority":"Normal","author":"Patrick","description":"At the moment only logs startup and received commands. Currently does not log when it terminates, so the log looks like there is an issue.\n\nRelated:\nT117\n","comments":[{"author":"Patrick","date_created":1423529380,"date_modified":1423529380,"content":"Done:\nhttps://github.com/Whonix/control-port-filter-python/commit/455dff33af4abd54f8ea61ada03accd5848ebfa5\n\nCan you review this change please, @troubadour?"},{"author":"troubadour","date_created":1423596758,"date_modified":1423596758,"content":"Tested, works fine. :)"},{"author":"Patrick","date_created":1423617134,"date_modified":1423617134,"content":"Thanks!"}]},"PHID-TASK-5ilxvkcp4f6yo74xbdce":{"id":"152","title":"profile rule deduplication of apparmor-profile-sdwdate and apparmor-profile-timesync by creating an sdwdate AppArmor abstraction file","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/apparmor-profile-sdwdate and\nhttps://github.com/Whonix/apparmor-profile-timesync\ncurrently share a lot profile rules.\n\nWhen making changes to sdwdate or timesync, most times both profiles need to be modified. This is often forgotten and error prone.\n\nWould be better if most of these profile rules were inside a shared sdwdate AppArmor abstractions file.","comments":[{"author":"troubadour","date_created":1424106819,"date_modified":1424106819,"content":"Something that could have been done, but has been postponed several times. As there are other tasks in the pipeline, it's  not high priority. First, what do we call the file? `abstractions/sdwdate` sounds good."},{"author":"Patrick","date_created":1424118472,"date_modified":1424118472,"content":"Yes."},{"author":"troubadour","date_created":1424236646,"date_modified":1424236646,"content":"The name became `abstractions/whonix`, the reason being that it's used by the three Whonix specific profiles, sdwdate, timesync and whonixcheck.\n\nThe repositories are updated with the trimmed profiles.  `abstractions/whonix` is added to `apparmor-profile-anondist`, which seems its natural place."},{"author":"Patrick","date_created":1424247064,"date_modified":1424247064,"content":"That I find a bad idea. Because sdwdate, timesync is are standalone packages, supposed to enter official Debian repository one day. Mixing them with whonix-anything entails unrelated packages."},{"author":"troubadour","date_created":1424379044,"date_modified":1424379044,"content":"I was not aware of that. Let's rename it sdwate.\n\nPerhaps we should keep the AppArmor discussion in the forum. It looks like there in an audience from outside Whonix, and it's sort of buried in all the tasks here in Phabricator."},{"author":"Patrick","date_created":1424380076,"date_modified":1424380076,"content":"> Let's rename it sdwate.\n\n`sdwdate`\n\n> Perhaps we should keep the AppArmor discussion in the forum. It looks like there in an audience from outside Whonix, and it's sort of buried in all the tasks here in Phabricator.\n\nI don't mind either way. It's just stuff in the forums is getting lost and forgotten in long threads.\n\n-----\n\nWould whonixcheck depend on sdwdate then? That would not be as worse, but also non-ideal."},{"author":"troubadour","date_created":1424381175,"date_modified":1424381175,"content":"Yes. it would. But is that a concern? We have this abstraction available, why not use it for any profile requiring the whole or part of it. It would become an issue only if sdwdate is ported to another language."},{"author":"Patrick","date_created":1424382057,"date_modified":1424382057,"content":"Yes. Situations were one likes to use whonixcheck, but not sdwdate. It would introduce a new, strange dependency. whonixcheck would depend on sdwdate. That seems strange, unprofessional, hard to sell. Or were one wants to temporarily remove sdwdate for whatever use/test case and notices, that this would also remove whonixcheck."},{"author":"troubadour","date_created":1424383008,"date_modified":1424383008,"content":"Ok. Then I'll revert the change in whonixcheck profile. Have pushed the name change in apparmor-profile-anondist."},{"author":"Patrick","date_created":1424383599,"date_modified":1424383599,"content":"I am afraid, apparmor-profile-anondist is also the wrong place. Because then sdwdate, a generic package, would depend on an anondist/Whonix specific package, apparmor-profile-anondist. The latter is a Debian non-policy-conform package. (Because diverting /etc/apparmor.d/abstractions/base.)\n\n/etc/apparmor.d/abstractions/sdwdate belongs into package apparmor-profile-sdwdate (or into sdwdate when we merge a few apparmor-profile-* packages into their corresponding application packages)."},{"author":"troubadour","date_created":1424389275,"date_modified":1424389275,"content":"Makes sense. Will make the changes. "},{"author":"troubadour","date_created":1424550726,"date_modified":1424550726,"content":"Done. The abstraction is in `apparmor-profile-sdwdate/etc/apparmor.d/abstractions`\n\n`apparmor-profile-anondist` is updated."},{"author":"Patrick","date_created":1424629289,"date_modified":1424629289,"content":"Added small fix on top of apparmor-profile-sdwdate. Otherwise works fine at first sight. Will naturally test more by running it in the following days.\n\nCan you also update apparmor-profile-timesync please?"},{"author":"Patrick","date_created":1467046823,"date_modified":1467046823,"content":"timesync and apparmor-profile-timesync were deprecated so this task in invalid."}]},"PHID-TASK-n2ig3pwvolnn67iytzlw":{"id":"151","title":"sdwdate Tor Consensus Time Sanity Check","status":"resolved","priority":"Normal","author":"Patrick","description":"__problem description__:\n\nWhen the host's system clock is too much off, Tor won't be able to connect and since `sdwdate` runs through Tor, it won't be able to fix the clock. At the moment in such situations there is no good feedback to the user.\n\n-----\n\n__proposal__\n\n* A sdwdate sanity test could be created.\n* Before attempting to fetch the time from Tor hidden services, it could check what Tor is telling us about the clock.\n* Check if times from remote servers match Tor are within consensus/valid-after and consensus/valid-until, otherwise reject those.\n\n-----\n\n__caution__\n\n* As per [chat log with Roger](https://forums.whonix.org/t/tor-dev-mailinglist-proposal/489/10) directory authorities can lie about time - so we need to use this with care.\n* Tor consensus isn't always downloaded from directly from directory authorities, sometimes Tor downloads the Tor consensus from directory mirrors. And the latter aren't trusted as much as directory authorities. Those are just like normal relays.\n* We should have the courtesy to not explicitly download from directory authorities, because... `armadev: oh. i think that would be horrible. hundreds of thousands of users doing that could overwhelm the directory authorities.`\n\n-----\n\n__misc__:\n\n* anondate\n* https://www.whonix.org/wiki/Dev/TimeSync#anondate\n * `anondate` is a fork of `tordate` and already parses Tor consensus file. It's already part of `anon-shared-helper-scripts` (https://github.com/Whonix/anon-shared-helper-scripts/blob/master/usr/lib/anon-shared-helper-scripts/anondate).\n * [Why not use tordate by Tails instead of reinventing the wheel with anondate?](https://www.whonix.org/wiki/Dev/TimeSync#Why_not_use_tordate_by_Tails_instead_of_reinventing_the_wheel_with_anondate.3F)\n\n* Another option, from [control-spec.txt](https://gitweb.torproject.org/torspec.git/tree/control-spec.txt):\n```\n     \"consensus/valid-after\"\n     \"consensus/fresh-until\"\n     \"consensus/valid-until\"\n      Each of these produces an ISOTime describing part of the lifetime of\n      the current (valid, accepted) consensus that Tor has.\n      [New in Tor 0.2.6.3-alpha]\n```\n* Related: https://www.whonix.org/wiki/Dev/TimeSync#Tor_Consensus_Method\n* Related: T56\n\n-----\n\n__Deprecated__:\n\n* ~~We could then inform the user and/or - if it is safe - even roughly fix the clock for the user so sdwdate can fix it. (From verified Tor consensus (vs unverified Tor consensus). Needs research.)~~\n* ~~plugin `sdwdate-plugin-anondate`~~ (Not required as a plugin, because sdwdate now depends on Tor anyhow.)\n* ~~Migrated from: https://github.com/Whonix/Whonix/issues/244 (contains extensive discussion)~~ (outdated)\n* ~~[Tails-dev - tordate: why is it safe to set time from unverified-consensus?](https://mailman.boum.org/pipermail/tails-dev/2012-January/000822.html)~~ (threat model does not include fingerprinting)\n\n-----\n\n__credits__:\n\nExtensive research and guess work done by @HulaHoop and @Patrick.\n\n-----\n\n__scope__:\n\nThe scope of this ticket is to create a sdwdate sanity test. It would be a user of `anondate`.\n","comments":[{"author":"Patrick","date_created":1487977004,"date_modified":1487977004,"content":"WIP https://github.com/Whonix/sdwdate/commit/c626798651f263b06190cd7d9f03d3976f99c68a\n\nDone:\n\n- Checks if system clock is between consensus/valid-after and consensus/valid-until. Otherwise a warning is logged.\n- Disregards any remote times not between consensus/valid-after and consensus/valid-until.\n\nQuestions:\n\nDo you think the following information from the Tor control connection is safe to have for Whonix-Workstation?\n\n```\n./tor_consensus_valid-after.py \n2017-02-24 22:00:00\n\n./tor_consensus_valid-until.py \n2017-02-25 01:00:00\n```"},{"author":"Patrick","date_created":1487996783,"date_modified":1487996783,"content":"https://github.com/Whonix/Whonix/commit/db688595fcad0a84875f50186634e761137f4d17"},{"author":"Patrick","date_created":1494943493,"date_modified":1494943493,"content":"TODO: test what happen if Tor cannot fetch Tor consensus"},{"author":"Patrick","date_created":1512249644,"date_modified":1512249644,"content":"https://github.com/Whonix/anon-shared-helper-scripts/commit/b6909067c2834fb04d514dc15b6223776ed3372a\nhttps://github.com/Whonix/anon-shared-helper-scripts/commit/1eb7cde03039d6488e782f25171f2d47017add50\n"}]},"PHID-TASK-yasskb5w73atx6mxku66":{"id":"150","title":"Rewrite msgdispatcher_dispatch_x after bug found in generic_gui_message","status":"resolved","priority":"Normal","author":"troubadour","description":"The window is not properly centered on the screen when required (timesync). Was not obvious because whonixcheck result window is placed in the top left corner. It might show on a timesync issue report. ","comments":[{"author":"troubadour","date_created":1423672327,"date_modified":1423672327,"content":"For the time being, pushed an \"old style\" `msgdispatcher_dispatch_x` with a fix to center the window.\n\nSome issue with the `generic_gui_message` like script. It cannot display the special characters used `whonixcheck/check_news`.\n```#008000>√</span> \n#ff0000>✘</span>```\nI don't want to spend too much time on that, but while I'm at it, where did you find these characters? They are not in the extended ASCII table."},{"author":"Patrick","date_created":1423672994,"date_modified":1423672994,"content":"Tested and merged. Works fine. Never noticed this bug before.\n\n@JasonJAyalaP where did you find these characters?\n"},{"author":"Patrick","date_created":1424703442,"date_modified":1424703442,"content":"Looks fine to me. Screenshot:\n{F40}\n\n@troubadour anything left to do here?"},{"author":"troubadour","date_created":1424720318,"date_modified":1424720318,"content":"We can close that one. We'll reopen if necessary."}]},"PHID-TASK-cntjqvkwys4i5hhnvm7a":{"id":"149","title":"multiple choices support in generic_gui_message","status":"resolved","priority":"Normal","author":"Patrick","description":"I am wondering how T130 could be solved in the long run due to the [absence of a stable version format](https://trac.torproject.org/projects/tor/ticket/14383).\n\nMaybe it's best to provide the user with a multiple choice drop down menu, where they can choose the version. Could be added to tb-updater's _download verification screen_*.\n\nWould it be doable to write a multiple choice feature to generic_gui_message? Or do you have any other suggestions? @troubadour\n\nOtherwise I could try to fall back to a zenity multiple choice solution, but that would introduce another screen and would be kinda ugly.\n\n*(Looking similar to [this](https://phabricator.whonix.org/file/data/vpnt2zhsknhtmh2hicxt/PHID-FILE-4cyo5qtznfehtsn4nzlo/Selection_002.png).)\n","comments":[{"author":"troubadour","date_created":1423413364,"date_modified":1423413364,"content":"No zenity, for the reason you mentioned.\n\nIt should be doable, adding an options group. We would have to pass more arguments to generic_gui_message for all messages, like:\n- number of versions available (if one, don't show the options).\n- each version text.\n\nKind of messy, so wondering it it's not nicer to have a separate GUI for tb_updater, included in the package. There is always an alpha release available, I believe. We could give the user the choice to install stable or alpha."},{"author":"Patrick","date_created":1423472163,"date_modified":1423472163,"content":"> wondering it it's not nicer to have a separate GUI for tb_updater, included in the package\n\nI don't mind either way.\n\nproposed layout:\n\n```\n[x] likely stable | 4.0.3\n[] likely alpha | 4.5a3\n\nYes | No [default]\n```\n\nOr something like that.\n\nMaybe similar to [this](https://lh3.ggpht.com/_1QSDkzYY2vc/S697SXYKqTI/AAAAAAAAAr0/PjQ04HSVWos/s800/Select%2520a%2520file%2520extension_001.png)?\n\nproposed command line interface:\n\n```\n/path/to/tool \\\n   \"$type\" \"$TITLE\" \"$MSG\" \"$question\" \"$button\" \\\n   --choice-default 1 \\\n   --choice-1-version \"4.0.3\" --choice-1-text \"likely a still security supported and fine stable version\" \\\n   --choice-1-version \"4.0.3\" --choice-1-text \"might be a newer stable version\" \\\n   --choice-3-version \"4.5a3\" choice-3-text \"likely alpha version (name contains an 'a')\" \\\n   --choice-4-...\n```\n\nOr something like that?\n\n> We could give the user the choice to install stable or alpha.\n\nYes. And a version list in general, since it's impossible to recommend the \"best\" one.\n\nI think recommending the lowest version number by default could be best. Then chances are best it's a stable version and no alpha. Since it comes from the [RecommendedTBBVersions](https://www.torproject.org/projects/torbrowser/RecommendedTBBVersions) file, it would also still be a perfectly security supported and save version. Those who wish to use higher version numbers or even alphas, could just pick to do so."},{"author":"Patrick","date_created":1423496432,"date_modified":1423496432,"content":"Maybe the same multiple choices feature could be used (with different values) for T138?"},{"author":"troubadour","date_created":1423602416,"date_modified":1423602416,"content":"> Maybe the same multiple choices feature could be used (with different values) for T138?\nWas thinking on the same line. Will see. "},{"author":"troubadour","date_created":1424388372,"date_modified":1424388372,"content":"What change can we expect from T161, in the number of versions available? "},{"author":"Patrick","date_created":1424424006,"date_modified":1424424006,"content":"Dunno. In past with RecommendedTBBVersions maximum was ~6 or so. Best to have a good buffer to be able to scale up if needed."},{"author":"troubadour","date_created":1424545970,"date_modified":1424545970,"content":"Added a specific GUI for tb_updater. It's in msgcollector, for not findinf a better place.\nhttps://github.com/troubadoour/msgcollector/commit/ae09f9c695401bcc8bcc54c0a46d3b81244b8fe7\n\nIt takes two new parameters: `installed_version` and `online_versions`.\n\nThe online versions are a comma separated list. The script returns the selected version text (as passed by `update-torbrowser`) in the options group. \n\nAll this is provisional can be modified to suit the bash script.\n\nTo test:\n```./tb_updater_gui info \"Tor Browser Updater\" \"4.0.3\" \"Stable,Alpha1,Alpha2\" \"Message\" \"Question\" yesno```\n"},{"author":"Patrick","date_created":1424609241,"date_modified":1424609241,"content":"It's very nice already! I am in process of porting tb-updater to it.\n\n* Currently installed version cannot be copied.\n* Online detected version cannot be copied.\n* ~~\"Download confirmation\" is currently hardcoded. It needs also some way to show \"Installation Confirmation\".~~ (No it does not - can continue to use generic gui tool as is.)\n* Can you please make the warning and error sign bigger as with generic gui tool?\n* The window is a bit too short (or narrow, you tell me). Need to click the scroll down button 3 times. Command for testing (can be copies as is into Konsole etc.):\n\n```\n/usr/lib/msgcollector/tb_updater_gui \\\n   \"warning\" \\\n   \"Tor Browser Updater (by Whonix developers)\" \\\n   \"4.5a3\" \\\n   \"4.5a3,4.0.3\" \\\n   \"<p>Looks like Tor Browser is already up to date.</p>\n\n<p>Please close Tor Browser if you want to (re-)install!</p>\n\n<p>If your currently installed version is:<blockquote>\n   - higher: you are likely target of a downgrade attack, SAY NO NOW.<br></br>\n   - equal : only proceed, if you want to create a new browser profile.<br></br>\n   - lower : you should upgrade.</blockquote></p>\n\n<p>YOUR BROWSER WILL BE KILLED.<br></br>\nYOUR WHOLE BROWSER PROFILE INCLUDING BOOKMARKS AND PASSWORDS WILL GET REPLACED.</p>\n\n<p>A backup of your old Tor Browser and settings will be created in your home folder.\n<br></br>It is a good idea to delete old TBB backups once in a while if you are running low with disk space.</p>\n\n<p><a href=https://www.whonix.org/wiki/Tor_Browser/Download_Confirmation_Screen>Learn more about this Download Confirmation Screen.</a></p>\" \\\n   \"Download now?\" \\\n   \"yesno\"\n```\n"},{"author":"Patrick","date_created":1424609458,"date_modified":1424609458,"content":"* When the window gets closed, can you please also echo `65536` (same as click \"no\") cancel so the script can detect this and abort?"},{"author":"troubadour","date_created":1424637846,"date_modified":1424637846,"content":">Currently installed version cannot be copied.\nFixed.\n>Online detected version cannot be copied.\nNot doable. The text is part of the button and do not accept `TextSelectableByMouse`\n>Can you please make the warning and error sign bigger as with generic gui tool?\nHere, it's the same size as `Confirm Open`, for example (64x64).\n>The window is a bit too short (or narrow, you tell me).\nFixed. Made the window slightly wider so that when link confirmation pops, the vertical borders are separated.\n>When the window gets closed, can you please also echo 65536 (same as click \"no\") cancel so the script can detect this and abort?\nDone. generic_gui_message is updated with this too."},{"author":"Patrick","date_created":1424694596,"date_modified":1424694596,"content":">>Can you please make the warning and error sign bigger as with generic gui tool?\n> Here, it's the same size as `Confirm Open`, for example (64x64).\n\nHere is how tb updater gui is looking for me:\n\n{F38}\n\n"},{"author":"troubadour","date_created":1424719697,"date_modified":1424719697,"content":"Same for me. The icon is the same size as the generic_gui_message and msgdispacher_dispatch_x."},{"author":"Patrick","date_created":1424720160,"date_modified":1424720160,"content":"Didn't you in increase to 128x128 or so in past? Could you increase it again please?"},{"author":"troubadour","date_created":1424722557,"date_modified":1424722557,"content":"Yes I did, and reverted. Do we want 128x128 for warning and error in all the GUIs?"},{"author":"Patrick","date_created":1424722753,"date_modified":1424722753,"content":"> Do we want 128x128 for warning and error in all the GUIs?\n\nGood question. I don't know. No one suggested that yet. And it didn't occur to me. Dunno what's best so I am open for suggestions."},{"author":"Patrick","date_created":1424722906,"date_modified":1424722906,"content":"On a second thought, we also need this for msgdispatch_x. Otherwise tb updater gui would show a big one (Download confirmation) and later msgdispatch_x would show a small one (Installation confirmation). So probably best to increase it for all?"},{"author":"troubadour","date_created":1424723315,"date_modified":1424723315,"content":"May be leave generic_gui_message with smaller icons? The messages like `Confirm Open` or `Not root` are not critical. Or we could add an argument `icon_size`, but that would be a lot of bash updates."},{"author":"Patrick","date_created":1424724014,"date_modified":1424724014,"content":">>! In T149#2521, @troubadour wrote:\n> May be leave generic_gui_message with smaller icons?\n\nYeah, good idea.\n\n> The messages like `Confirm Open` or `Not root` are not critical.\n\nIndeed.\n\n> Or we could add an argument `icon_size`, but that would be a lot of bash updates.\n\nYes. Probably not required at this time.\n\n> but that would be a lot of bash updates.\n\n(As a side note: Wouldn't be if it defaulted if something, i.e. 64 or so.)"},{"author":"troubadour","date_created":1424725406,"date_modified":1424725406,"content":"OK. Pushed the change in msgdispatch_x and tp_updater_gui.  A small issue. Because of the layout, the `Online versions` option group is shifted down, below the bottom of the icon.\n\nNext step would be T138. Not sure yet how to integrate it. Same window, an extra line `Select language` with a drop-down list? A separate GUI? Or perhaps from the desktop environment installed language?"},{"author":"Patrick","date_created":1424726833,"date_modified":1424726833,"content":">>! In T149#2533, @troubadour wrote:\n> OK. Pushed the change in msgdispatch_x and tp_updater_gui.  A small issue. Because of the layout, the `Online versions` option group is shifted down, below the bottom of the icon.\n\nI see. Can this be fixed?\n \n> Next step would be T138. Not sure yet how to integrate it. Same window, an extra line `Select language` with a drop-down list? A separate GUI? Or perhaps from the desktop environment installed language?\n\nThat is somewhat T72, which you partially already implemented in \"whonix-setup-wizard locale_settings\". When we start that (using xinit) (perhaps in Whonix 11?), then system language gets set. tb-updater could use the same language. The question is, how could tb-updater figure out what was set in KDE (or..)?"},{"author":"Patrick","date_created":1424728922,"date_modified":1424728922,"content":">>! In T149#2535, @Patrick wrote:\n> The question is, how could tb-updater figure out what was set in KDE (or..)?\n\nAnswered my own question here:\nhttps://phabricator.whonix.org/T72#2538"},{"author":"troubadour","date_created":1424984876,"date_modified":1424984876,"content":">>! In T149#2535, @Patrick wrote:\n>>>! In T149#2533, @troubadour wrote:\n>> OK. Pushed the change in msgdispatch_x and tp_updater_gui.  A small issue. Because of the layout, the `Online versions` option group is shifted down, below the bottom of the icon.\n> \n> I see. Can this be fixed?\nYes :) https://github.com/troubadoour/msgcollector/commit/e2cdfa3cc8416260d3fa56bbd888dd46e91d4416"},{"author":"Patrick","date_created":1424985747,"date_modified":1424985747,"content":"Nice. Merged and tested. Closeable?"},{"author":"troubadour","date_created":1424985798,"date_modified":1424985798,"content":"Yes."}]},"PHID-TASK-4plgwzq33xcgb2bnrgn4":{"id":"148","title":"master mirror down - switch to new server","status":"resolved","priority":"High","author":"Patrick","description":"Whonix's master mirror is currently down.\n\nWe need to bring it up again as soon as we receive our new sponsored server which should happen until 01.03.2015.\n\nThen we can also move whonix.org website to the new server and install varnish (T78) to speed up the website.","comments":[]},"PHID-TASK-g2ia5pyaf26jq3rmwveo":{"id":"147","title":"increase sdwdate interval","status":"resolved","priority":"Normal","author":"Patrick","description":"[Current settings](https://github.com/Whonix/sdwdate/blob/master/etc/sdwdate.d/30_sdwdate_default#L69):\n```\n## How often sdwdate should run in minutes.\n## 0 disables it and sdwdate exits after run.\nINTERVAL=\"60\"\n\n## How many minutes should be waited before running sdwdate again.\n## Only has an effect when RANDOMIZE is set to 1 as well.\nMIN_INTERVAL=\"10\"\n\n## Randomize the interval above.\n## Minimum 10 minutes.\n## Maximum $INTERVAL minutes.\n## 0 disabled.\n## 1 enabled.\nRANDOMIZE=\"1\"\n```\n\nI think the interval should be increased. Any basis for comparison? Any suggestions?","comments":[{"author":"Patrick","date_created":1423404963,"date_modified":1423404963,"content":"Done:\nhttps://github.com/Whonix/sdwdate/commit/b4c4f4ee5228acd953c91818722f3a9e3b09012a\n\nIncreased to:\n```\n## How often sdwdate should run in minutes.\n## 0 disables it and sdwdate exits after run.\nINTERVAL=\"180\"\n\n## How many minutes should be waited before running sdwdate again.\n## Only has an effect when RANDOMIZE is set to 1 as well.\nMIN_INTERVAL=\"60\"\n```\n\nArbitrarily chosen.\n\nPlease reopen if you have other suggestions."}]},"PHID-TASK-is4hmnmrg62px5r56vux":{"id":"146","title":"direct SSL certificate pinning for check.torproject.org and torproject.org (python method)","status":"open","priority":"Normal","author":"Patrick","description":"Since `direct SSL certificate pinning for check.torproject.org and torproject.org (curl method)` (T80) would have to wait a long time, until Debian stretch, this ticket is for an alternative approach.\n\nPlease make sure you've read T80 first.\n\n[mitm](https://www.whonix.org/forum/index.php?action=profile;u=948) suggested [in the forums](https://www.whonix.org/forum/index.php/topic,942.msg6873.html#msg6873) to:\n\n> Learn from the code for downloading while direct pinning TPO's certificate from [launcher.py](https://github.com/micahflee/torbrowser-launcher/blob/master/torbrowser_launcher/launcher.py) (see `VerifyTorProjectCert`).\n\nSeems the most promising method for now.","comments":[]},"PHID-TASK-gadkusif53cjgwegkdon":{"id":"145","title":"SSL/TLS Mirrors","status":"wontfix","priority":"Normal","author":"Patrick","description":"__Migrated from__:\nhttps://github.com/Whonix/Whonix/issues/177\n\n-----\n\n__Justification__:\n\nSSL mirrors may sound like a bad idea for security, may seem like an oxymoron. A justification why we believe it improves security can be found here:\n\n* https://www.whonix.org/wiki/Download_Security\n* and here: https://mailman.stanford.edu/pipermail/liberationtech/2014-March/013129.html\n\nAs another justification. Here is an argument from authority, as I understand, Jacob Appelbaum preferred if Tails download was https by default. Source:\nhttps://mailman.boum.org/pipermail/tails-dev/2013-June/003211.html\n\n-----\n\n__Implementation ideas__:\n\nSSL/TLS Mirrors are difficult to implement because of the trust / key issues.\n\nLet mirrors use whatever certs/domains they have (hopefully from a \"trusted\" CA so it doesn't throw alerts to the user), and include their URL in a list. When a user visits the download page, one of those URL is placed into the article using something like [Extension:RandomInclude](https://www.mediawiki.org/wiki/Extension:RandomInclude). This would be a little cumbersome with caching. Perhaps we could have a static link to something like \"whonix.org/download/ssl.php\", which would then in turn point to an SSL mirror randomly. \n\nThere was a helpful answer on libtech mailing list on how to implement this:\nhttps://mailman.stanford.edu/pipermail/liberationtech/2014-March/013130.html\n\nComments by Mick:\nhttps://github.com/Whonix/Whonix/issues/96#issuecomment-26475207\n\n@fortasse and I agreed on the following plan:\n\n* We indefinitely keep all http mirrors.\n* Those are useful as backup.\n* Useful for users who do manual verification.\n* Useful for possible later Whonix downloader/installer that does verification.\n* Useful as host for Whonix's APT repository and Whonix News (#178) [those use verification using gpg, no https required].\n* We need a mirror manager (one that contacts prospective new mirrors, stays in touch with mirrors in case of issues).\n* After we have a stable http mirror network and enough mirror contacts - we're not there yet - we ask them if they would be willing to provide optional ssl access. If not, they stay http mirrors. If yes, they become http + https mirrors.\n\n__Non-Solutions__:\n\nSharing a separate SSL private key with mirrors. Because once that key is just one in false hands, all mirrors are compromised.\n","comments":[{"author":"Patrick","date_created":1460389905,"date_modified":1460389905,"content":"We are now serving all downloads from whonix.org over https. Therefore no need to implement this ticket."}]},"PHID-TASK-l4bigtpt4634scsvdow6":{"id":"144","title":"automatic shared folder mounting in VMs","status":"resolved","priority":"Normal","author":"Patrick","description":"__Migrated from__:\nhttps://github.com/Whonix/Whonix/issues/223\n\n-----\n\n__Where we are__:\n\nThe `/mnt/shared` folder gets already created by the shared-folder-help package.\n\n\n-----\n\n__Non-solutions__:\n\n* [There is no `/etc/fstab.d`.](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=663623)\n* Patching `/etc/fstab` by a script seems too fragile.\n\n__TODO__:\n\nImplement this using systemd.\n\nFor VirtualBox, use `Requires=vboxguest` [or so, just do nothing if vboxguest or just output an info if not installed], then run.\n\n```\nmount -t vboxsf -o uid=1000,gid=1000 shared /mnt/shared\n```\n\nFor kvm/qemu/libvirt, check necessary conditions(?), then run.\n\n```\nmount -t 9p -o trans=virtio shared /mnt/shared -oversion=9p2000.L\n```\n\n","comments":[{"author":"HulaHoop","date_created":1430613760,"date_modified":1430613760,"content":"With the migration to systemd, is it now easier to add this?"},{"author":"Patrick","date_created":1430625899,"date_modified":1430625899,"content":"Neither easier nor harder."},{"author":"HulaHoop","date_created":1434152426,"date_modified":1434152583,"content":"fstab.d should be available in the libmount version in Jessie:\nhttps://bugs.debian.org/cgi-bin/bugreport.cgi?bug=666163   \n\n\n\nA bug in the kernel causes the regular expression for mounting 9p shares to fail. A tested workaround works in /etc/fstab : \n\nshared /mnt/shared 9p x-systemd.automount,x-systemd.device-timeout=10,trans=virtio,version=9p2000.L,rw 0 0\n\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1184122\n\n\n\nTests with fstab.d giving me problems. It could be a matter of not knowing how it works. I first didn't know that there should be a directory called fstab.d and not a file. Apparently configuration files in there should be named a special way:\n\n/etc/fstab.d/00_header.fstab, /etc/fstab.d/50_middle.fstab, /etc/fstab.d/99_end.fstab\n\nA different option for share mounting is /sbin/mount.filetype  for example /sbin/mount.nfs. Needs more research doesn't seem as easy as dropping a text file in sbin\n\nhttps://unix.stackexchange.com/a/62826 "},{"author":"Patrick","date_created":1434163700,"date_modified":1434163700,"content":"https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=666163 says fstab.d support has been removed. Not a great long term solution.\n\n#systemd could help. It supports `ConditionVirtualization=kvm`. Has `tmpfiles.d`. + Running the mount command. Should be doable.\n\nAnyone feel free to submit a tested patch."},{"author":"HulaHoop","date_created":1434206839,"date_modified":1434206886,"content":"systemd can understand mount entries but they still have to be specified in /etc/fstab which won't solve anything.\n\n\nMore information on fstab.d:\n\nTurns out fstab.d is not supported by default in libmount however the mount option can take an alternate mount table file/directory as specified in a command. Please read the linked answer that I'm trying to paraphrase here:\n\nhttps://askubuntu.com/a/169995\n\n\n***\n\nAlternatives to system-wide fstab is to tell udsisks to mount a directory for a user account upon login:\n\nhttps://askubuntu.com/questions/364954/do-personal-fstab-files-exist-for-user-accounts"},{"author":"Patrick","date_created":1434207486,"date_modified":1434207486,"content":"If the manual mount command that does not involve /etc/fstab, i.e. `mount -t 9p -o trans=virtio shared /mnt/shared -oversion=9p2000.L` work for you in terminal, then a systemd unit file could do the same. Also without requiring /etc/fstab."},{"author":"HulaHoop","date_created":1434220788,"date_modified":1434224356,"content":"Excellent example of shared folder mounting with systemd files in Arch documentation. It will take changing them from vmware to suit KVM and drop them in the same paths for testing:\n\nhttps://wiki.archlinux.org/index.php/VMware/Installing_Arch_as_a_guest#Systemd\n\nNotes:\n\nfiletype=9p\n\nThese units must be \"enabled\" to make them automatically start with subsequent system startups\n\n\n***\nCommand cheat sheet:\n\nhttps://wiki.archlinux.org/index.php/Systemd#Using_units\n\nShow the status of a unit, including whether it is running or not:\n\n$ systemctl status unit\n\nCheck whether a unit is already enabled or not:\n\n$ systemctl is-enabled unit\n\nEnable a unit to be started on bootup:\n\n# systemctl enable unit\n"},{"author":"Patrick","date_created":1434223785,"date_modified":1434223785,"content":"Nice. Much better than manually running mount from systemd."},{"author":"HulaHoop","date_created":1434230202,"date_modified":1434230504,"content":"How far I've gone:\nI managed to debug errors until I corrected the parameters in the unit files so they should be correct. The remaining error has something to do with the 9p kernel module and I'm not sure where to go from here.\n\n\n  host mount[8341]: mount: mount(2) failed: No such file or directory\n  host kernel: 9pnet_virtio: no channels available\n  host systemd[1]: mnt-shared.mount mount process exited, code=exited status=32\n  host systemd[1]: Failed to mount Load KVM shared folders.\n\n\n\n/etc/systemd/system/mnt-shared.mount\n\n```\n[Unit]\nDescription=Load KVM shared folders\nConditionPathExists=/mnt/shared\nConditionVirtualization=kvm\n\n[Mount]\nWhat=/mnt/shared\nWhere=/mnt/shared\nType=9p\nOptions=defaults\nDirectoryMode=0777\nTimeoutSec=10\n\n[Install]\nWantedBy=multi-user.target\n```\n\n/etc/systemd/system/mnt-shared.automount\n\n```\n[Unit]\nDescription=Load KVM shared folders\nConditionPathExists=/mnt/shared\nConditionVirtualization=kvm\n\n[Automount]\nWhere=/mnt/shared\nDirectoryMode=0777\n\n[Install]\nWantedBy=multi-user.target \n```\n\n\n\n\n\nDebugging:\nRun as root\n\nsystemctl daemon-reload\nsystemctl start mnt-shared.mount\njournalctl -xn\n\nq to quit detailed error report by journalctl\n\nedit the files once again and save thenreload daemons and so on."},{"author":"HulaHoop","date_created":1434231386,"date_modified":1434231386,"content":"This option is dead because of some rare bug. There are only 4 search results for it and none of the situations really applies to our setup here.\n"},{"author":"HulaHoop","date_created":1434242612,"date_modified":1434242612,"content":"\n\nA solution you probably won't like is patching the fstab file directly.\n\nSomething based on the third method on here:\nhttp://blog.allanglesit.com/2012/05/bash-programmatically-add-entries-in-fstab/\n\nFollowed by column -t /etc/fstab  to make it reader friendly:\nhttps://unix.stackexchange.com/a/96046\n\n"},{"author":"Patrick","date_created":1434243217,"date_modified":1434243217,"content":"HulaHoop (HulaHoop):\n> A solution you probably won't like is patching the fstab file directly.\n\nIndeed.\n\nHave systemd run the 'mount' command would be better and should be possible."},{"author":"HulaHoop","date_created":1434288749,"date_modified":1434288749,"content":"Ok I see what you're talking about.\n\nThe mount command is placed in a regular script file and then a custom systemd service is configured to execute it on startup:\n\nhttps://unix.stackexchange.com/questions/47695/how-to-write-startup-script-for-systemd\n\n\nI can do the systemd service file part but I'm unsure as to how the script should look like. If its as simple as pasting the command I use in there, no problem. "},{"author":"Patrick","date_created":1434293376,"date_modified":1434293376,"content":"Yes, somewhat.\n\nI don't think you need a separate script. Instead of running a single\nline script, you could try running the mount command directly from the\nsystemd unit file."},{"author":"HulaHoop","date_created":1434309938,"date_modified":1434325693,"content":"Great news! automatic shared folders is now achieved :D\n\n\nI used this as an example:\nhttp://lukas.zapletalovi.com/2013/08/execute-command-during-start-with-systemd.html\n\n\nTwo systemd service files were created under /etc/systemd/system/\n\nTo enable and start them:\n\nsudo systemctl enable service-name\nsudo systemctl start service-name\n\n\nmnt-shared-kvm.service\n\n\n```\n[Unit]\nDescription=Mounts KVM shared folder during start\nConditionPathExists=/mnt/shared\nConditionVirtualization=kvm\n\n[Service]\nType=oneshot\nExecStart=/bin/mount -t 9p -o trans=virtio shared /mnt/shared -oversion=9p2000.L\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target\n```\n\n\nmnt-shared-vbox.service\n\n\n```\n[Unit]\nDescription=Mounts VirtualBox shared folder during start\nConditionPathExists=/mnt/shared\nConditionVirtualization=oracle\nAfter=vboxguest.service\nAfter=virtualbox-guest-utils.service\n\n[Service]\nType=oneshot\nExecStart=/bin/mount -t vboxsf -o uid=1000,gid=1000 shared /mnt/shared\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target\n```\n\n\n"},{"author":"Patrick","date_created":1434314224,"date_modified":1434326375,"content":"Nice!\n\nTODO:\n\n* ~~In section `[Unit]` it should probably use `After=` something. I.e. make it run after VBox / KVM guest additions.~~\n* debian/rules modifications\n* debian/control modifications\n* use /lib/systemd/system/\n* commit to shared-folder-help package\n* build package, test if it actually works\n"},{"author":"HulaHoop","date_created":1434323068,"date_modified":1434323625,"content":"What is the name of the systemd vbox guest additions service so I can add it? KVM does not rely on spice or a guest additions equivalent to share folders.\n\nA vbox guest additions dependency only makes sense if its installed by default."},{"author":"Patrick","date_created":1434325541,"date_modified":1434325541,"content":"How to find out? Look manually into `/etc/init.d/virtualbox-guest-utils`\n(or systemd unit files if it had those) and/or 'grep -i provides\n/etc/init.d/virtualbox-guest-utils'.\n\n```\nAfter=vboxguest.service\nAfter=virtualbox-guest-utils.service\n```"},{"author":"HulaHoop","date_created":1434325807,"date_modified":1434325807,"content":"OK I edited my comment and added those in under the Unit section."},{"author":"HulaHoop","date_created":1434908061,"date_modified":1434908061,"content":"https://github.com/Whonix/shared-folder-help/pull/1\nhttps://github.com/Whonix/shared-folder-help/pull/2\nhttps://github.com/Whonix/shared-folder-help/pull/3\nhttps://github.com/Whonix/shared-folder-help/pull/4"},{"author":"Patrick","date_created":1438874873,"date_modified":1438874873,"content":"Merged. Requires testing when new test images get available."},{"author":"Patrick","date_created":1448032660,"date_modified":1448032660,"content":">>! In T144#6289, @Patrick wrote:\n> Merged. Requires testing when new test images get available.\n\nhttps://forums.whonix.org/t/whonix-12-0-0-3-2-rc-testers-wanted/\n\nDoes it work in KVM?"},{"author":"Patrick","date_created":1448822305,"date_modified":1448822305,"content":"`do not let systemd service enter failed state of host config has not been applied`:\nhttps://github.com/Whonix/shared-folder-help/commit/24143991888ab900effe4b11f7eb55172af6793d\n"},{"author":"Patrick","date_created":1458142966,"date_modified":1458142966,"content":"@HulaHoop reported it works in KVM."},{"author":"Patrick","date_created":1463236808,"date_modified":1463236808,"content":"https://github.com/Whonix/shared-folder-help/commit/d797f2ad9e4f385d4873ad137056a1e9807b9ecb"}]},"PHID-TASK-kmgxl6zvwudnpyi3b5ai":{"id":"143","title":"decide how to best set settings for the user (create settings file [by script] vs install a settings package)","status":"open","priority":"Normal","author":"Patrick","description":"Either,\n\n* a) whonixadvsetup directly apply/remove settings for the user.\n* b) whonixadvsetup run a (bash) script that applies/removes the settings for the user. This has the advantage, that the code for setting/unsetting the setting can be shared between whonixsetup and whonix-setup-wizard and that it would also be possible to manually run it by the user or other scripts. Advanced users / custom builders could create a script that runs such settings scripts to customize their system for them.\n* c) whonixadvsetup could install a package, that applies these settings. For example, to add the necessarily settings for T142 it could install a `anon-ws-tunnel-t-tor` package. (It would be trivial for me to create such a settings package.) It would have the advantage, that custom builders could install such packages by default. I worry, that settings become too complex, that it would require too many packages for too many custom settings.\n\n-----\n\nApplying a setting just means for example:\n\n> Creating a file `/etc/uwt.d/40_uwt_disabled_by_script.conf` with the content `uwtwrapper_global=\"0\"`.\n\nRemoving a setting just means for example:\n\n> Delete  `/etc/uwt.d/40_uwt_disabled_by_script.conf`.","comments":[{"author":"Patrick","date_created":1423328730,"date_modified":1423328730,"content":"`b)` is my current favorite. I could easily add scripts such as:\n\n* `/usr/lib/uwt/set-by-script/uwt-global-disable`\n* `/usr/lib/uwt/set-by-script/uwt-global-enable`\n\nThose could be run by whonixsetup / whonix-setup-wizard and/or whoever.\n\nwhonixsetup / whonix-setup-wizard would then be just a graphical user interface and documentation around these.\n\n-----\n\n@troubadour, what do you think?"},{"author":"nrgaway","date_created":1423333318,"date_modified":1423333318,"content":"Personally I would prefer to see something along the line of option b.  Develop some type of API that applications can communicate with to change these settings and at the same time allow a command line interface.\n\nAgain, IMO the API should be centralized for all settings; get, set, delete.  One API so that a user or developer does not have to search around what configuration file to run.  type **whonix-config --help** and all the options are right there.  The advantage of this approach allows the API to be re-written without effecting any of the applications using it, or command line interfaces.  For instance, it would be trivial to then add on a web interface which would communicate with a well defined API.\n\nI also think the front-end to the API should be written in python since it has a nice arg parser which is very configurable and easy to use.  Take a look at that Debian parser code I made at the argparse section ([[ https://github.com/nrgaway/qubes-whonix/blob/master/debian-parser#L32 | debian-parser ]].  This allows for easy help and command line access like:\nwhonix-config uwt disable [option]\n\nSince I know you prefer scripting at the moment, the python API can make the system calls to your scripts to do the actual work leaving the python portion solely to handle processing the jobs.  Bash scripts can just call the API as an end user would with parameters on the command line while python applications can access the API more directly.\n\nI would also prefer to see the worker scripts you create all be named well and placed in the same directory structure so everything is easy to find and review which provides incentive for more developers to help out.  One of my biggest frustrations is trying to follow the logic of some of the scripts since they often have many includes and gets really difficult to understand.\n\nI really do not want to see even more packages if they are not absolutely necessary :)\n\nAnyway, that's my two cents worth!"},{"author":"Patrick","date_created":1423337592,"date_modified":1423337592,"content":"I'd consider shipping `/usr/lib/*/set-by-script/set-del-or-get-command` a service by a friendly upstream. To get an overview, by convention `ls /usr/lib/*/set-by-script/` could be used. How does that sound?\n\nA centralized API aka whonix-config gets difficult. Most packages worth configuration that way I consider not tied to Whonix, such as uwt, tb-updater, sdwdate, and will try to get them upstreamed or upstream them at some point.\n\nIt would have to be a generalized method, that can be reused by any package from anywhere. I worry about reinventing the wheel. The closest that exists is debconf, that is tied to Debian. Is there any generalized alternative?\n"},{"author":"nrgaway","date_created":1423355695,"date_modified":1423355695,"content":"hehe, I may start sounding like a broken record here...\n\nSalt is like debconf but not tied to any distribution or even operating system as it also works on the Mac and Windows.  You would only need to use the minion.  If you developed a configuration system around Salt (as this is what it is designed for) it can be easily ported to other management platforms like Puppet if someone had the inkling to do so.\n\nYou would create salt states and sometimes modules for more complicated configurations.  They already have a command line interface and python interface. For the simpler configurations where you are just modifying a file, adding one, deleting one etc you just need to create simple yaml configuration files.  The system can also be used to check every part of the sytem is in an expected state, and change it if not (file permissions are correct. files exist or do not exist).  So using your example above, this is how you do it in salt.\n\nFrom the command line:\nsalt '*' state.sls uwt.absent  - disabled globally\nsalt '*' state.sls uwt.present  - enabled globally\n\nConfiguratoin file would look like:\n\nuwt/present.sls\n\n```\n/etc/uwt/50-uwt:\nfile.managed:\n- source: salt://salt/files/50-uwt\n- user: root\n- group: root\n```\n\nuwt/absent.sls\n\n```\n/etc/uwt/50-uwt:\nfile\n  -absent\n```\n\nThere is also what they call a top file that lists all the states you want enforced and this can be run at any time, enforcing all the states at once; or just one or a group at a time.  \n\nThis provides a standardized configuration option which I think meets your needs although there is a learning curve to use it, but you have way more than enough technical skills to get going on it quickly.  Just start with the more simple configurations that do not require a value like present, absent, or adding, removing predefined vars/text from files.  You can later add web interface and python scripts can use the python api, while your scripting can use the command line interface.\n\nIt might be overkill though for your needs as it is primarily meant to be a remote management and configuration system.  I personally use it to set up my virtual machine quickly to a base state, then I have more configurations for different machines [[ https://github.com/nrgaway/qubes-template-salt | Salt on Qubes ]]\n\nThe system can do pretty much anything you can think of as its built for large enterprises to mange and deploy thousand of machines. \n\nYou can do it all using scipts, but this gives the advantage of built in api and standardized approach with a very structured but at the same time very flexible configuration system.  Any new package or module you come across just plugs in.  There are also commands to list available commands and states.\n"},{"author":"Patrick","date_created":1423533966,"date_modified":1423533966,"content":"That would be a complete config file architecture change?\n\nUsing `/etc/uwt` rather than `/etc/uwd.d`?\n\nNo more `/etc/uwd.d` folder, where snippets can be dropped and extend preconfigured settings?\n\nShell scripts using that config system would then use the salt command line interface to figure out their settings rather than `source`ing configuration files?\n\nDo you know any example shell script that uses salt? How much effort would it be for you to create a proof of concept example using salt? For example porting uwt's config to salt?"},{"author":"nrgaway","date_created":1423535308,"date_modified":1423535308,"content":"All current configuration snippets could be kept in current locations and salt can be used to update them.  Salt is just a configuration management system.  I will look into a few script examples for you.\n\nEven if you do not use salt, once thing that IMO would be very nice is to have all whonix related configuration scripts in one place, so you can easily see what is available to modify and configure.  The proper location for this would be in the '/srv/' directory.  Something like this:\n\n/srv/whonix <- root dir\n/srv/whonx/uwt  <- all configurations related to uwt, no libs or binaries\n/srv/whonix/tor  <- tor configs\n/srv/whonix/admin <- admin?  contains first_boot_completed, .whonix_setup_completed, type things\n\nSo anything that the use can modify that is part of Whonix would go in /srv; just the configurations, no scripts.  Scripts, can remain where they are."},{"author":"Patrick","date_created":1423539008,"date_modified":1423539008,"content":"> All current configuration snippets could be kept in current locations and salt can be used to update them. Salt is just a configuration management system. I will look into a few script examples for you.\n\nOk.\n\n> Even if you do not use salt, once thing that IMO would be very nice is to have all whonix related configuration scripts in one place, so you can easily see what is available to modify and configure. The proper location for this would be in the '/srv/' directory. Something like this:\n\nMost packages worth configuration that way I consider not tied to Whonix, such as uwt, tb-updater, sdwdate, and will try to get them upstreamed or upstream them at some point. Those are generic packages and anyone or any distribution is welcome to use them outside of Whonix. That is also the idea behind `anondist`. Putting configuration files into a non-standard location `/src/` would prevent these packages from ever entering Debian, because it is a policy violation. Standard location for configuration files on Debian [and most distributions?] is `/etc/`.\n\nWhat however maybe could be done is creating a optional package, that symlinks folders such as `/etc/uwt.d` to `/srv/whonix` for all packages developed under the Whonix umbrella. But how would that help?\n\n> /srv/whonix/tor <- tor configs\n\nTor does not have a [.d style configuration folder](https://trac.torproject.org/projects/tor/ticket/1922) yet. And taking over ownership of `/etc/tor/torrc` without breakage when the maintainer of the Debian `tor` package updates it is non-trivial. We are using `config-package-dev` as a robust solution.\n\nThe other Tor config file is `/usr/share/tor/tor-service-defaults-torrc` [`.anondist`]. But it is not supposed to be edited by users or scripts at the moment. Only option is `/etc/tor/torrc`. Anything else seems not feasible at the moment.\n\n> /srv/whonix/admin <- admin? contains first_boot_completed, .whonix_setup_completed, type things\n\nI had something similar in mind. Created T155 for it."}]},"PHID-TASK-bjs2bsipitqvjemqahcr":{"id":"142","title":"improve usability of user -> Tor -> VPN/proxy Tunnel support ","status":"open","priority":"Wishlist","author":"Patrick","description":"Issue:\n\nTunneling lovers are often confused why there applications are \"only\" routed through Tor and not user -> Tor -> VPN/proxy/ssh due to [Whonix's stream isolation design](https://www.whonix.org/wiki/Stream_Isolation).\n\n-----\n\n~~To aid this, in such cases, we could on documentation side:~~\n\n* ~~disable uwt wrappers (documented [here](https://www.whonix.org/wiki/Stream_Isolation#Deactivate_uwt_Stream_Isolation_Wrapper))~~ (done)\n* ~~enable Transparent Proxying for Tor Browser (documented [here](https://www.whonix.org/wiki/Tor_Browser#Remove_Proxy_Settings))~~ (done)\n\nAnd on technical side:\n\n* whonix-ws-firewall needs a VPN_FIREWALL feature -> T158\n\n-----\nImplementation idea:\n\nwhonixadvsetup on Whonix-Workstation could get a new menu point I would like to keep as simple by default for users who are not interested in user -> Tor -> VPN/proxy/ssh.\n\nTitle:\n\n> VPN/proxy/ssh Tunnel support\n\nText:\n\n> Do you plan to tunnel a VPN, proxy or ssh through Tor (user -> Tor -> VPN/proxy/ssh -> destination)?\n\n> Most users don't need this. If you don't know, just choose No.\n\nQuestion:\n\n> Yes / No (Default: No)\n\nAlso also a details button, where it is explained in detail or links to documentation.\n\nIf \"No\" gets chosen -> just do nothing and continue.\n\nIf \"Yes\" gets chosen. It could be either a textual feature or really do something (T143).\n","comments":[]},"PHID-TASK-rqiopynfubg3ezrmzhuv":{"id":"141","title":"reorganize 'Computer Security Education' vs 'Post Install Advice' vs 'Security Guide' vs 'Advanced Security Guide'","status":"resolved","priority":"Normal","author":"Patrick","description":"Migrated from:\nhttps://github.com/Whonix/Whonix/issues/77\n\n-----\n\nPages in question:\n* https://www.whonix.org/wiki/Computer_Security_Education\n* https://www.whonix.org/wiki/Post_Install_Advice\n* https://www.whonix.org/wiki/Security_Guide\n* https://www.whonix.org/wiki/Download\n* https://www.whonix.org/wiki/Advanced_Security_Guide\n\n-----\n\nI supposed that steps in Computer Security Education, Post Install Advice and Security Guide should be realistic to be applied by mortals. Advanced Security Guide is supposed to contain the hardcore stuff requiring more skill.\n\nIn Security Guide, the Anonymous 3G modem and Anonymous WiFi adapter chapters don't really fit. From a logical flow it would fit better in Computer Security Education, but realistically it probably better fits into Advanced Security Guide. Maybe a section in Pre Install Advice that only addresses advanced users would be best.\n\n-----\n\nTODO:\nReoganize Computer Security Education vs Post Install Advice vs Security Guide vs Advanced Security Guide.","comments":[]},"PHID-TASK-fmfckf46hede24dqp4hj":{"id":"140","title":"apt-revoker - Check for Revocation Certificates before running apt-get","status":"open","priority":"Normal","author":"Patrick","description":"Migrated from:\nhttps://github.com/Whonix/Whonix/issues/125\n\n----\n\nDebian has no good mechanism to revoke apt keys in case of compromise, neither a way to inform users in emergency situations:\nhttps://lists.debian.org/debian-security/2013/10/msg00065.html\n\nAn apt key revoker should be written:\nhttps://lists.debian.org/debian-security/2013/12/msg00031.html\n\nAnd up-streamed to Debian.\n\n* Keyservers may not be used: https://lists.nongnu.org/archive/html/sks-devel/2013-12/msg00076.html\n* The code for downloading the revocation certificates should be configurable.\n* .d style configuration folder. Where distributions and PPA's can drop configuration snippets. Using arrays.\n* Code should be re-usable for Whonix News key revocation as well (using configuration snippet).\n\n-----\n\nRelated:\n\n* https://packages.debian.org/sid/parcimonie\n* https://github.com/EtiennePerot/parcimonie.sh\n* https://www.whonix.org/wiki/Dev/emergency-news\n\n-----\n\nImplementation:\nOne should discuss this with debian-security list / debian apt developers (`sh` vs #bash [arrays] vs #python vs `...`) as more sophisticated implementation plans materialized.","comments":[{"author":"HulaHoop","date_created":1481856957,"date_modified":1481856957,"content":"I want to help with the brainstorming for this. It will get more attention especially with the recent CVEs. This particular utility is a good candidate for Core Infrastructure funding IMO.\n\n"},{"author":"HulaHoop","date_created":1481857696,"date_modified":1481930874,"content":""},{"author":"HulaHoop","date_created":1481932240,"date_modified":1481932240,"content":"Removed previous comment. The task is big enough no need to bite more than we can chew.\n\n***\n\n* To avoid getting into a trust bootstrapping nightmare - its not enough to revoke a key but also send a new one via the emergency notification system to replace the revoked one. The emergency notification messages should be signed with a different key than the one for repo package signing old and new. In a sense the emergency key is a master key that should be very well guarded and only used in such situations - because it has authority over repo keys. Its sounds bad but I don't have better ideas for this.\n\n* Should revocation be automated? IMO nothing should ever be done automatically. Fortunately apt in Whonix doesn't do automatic updates. Imagine how bad that would have been!\n\n* The key handling/revoking should be done via GPG itself of course. We should only be concerned about the scripting that handles a remote emergency command and its execution on the machine. \n\n* Language choice: Up to you. Whichever you are comfortable with is best unless upstream is prejudiced against one or the other for security reasons.\n\n* I did not get the feeling that keyserver use is unwelcome however this is just one pool - there are still many other operators. Also it might be a redundancy with either centralized server-client used instead or a decentralized storage alternative. The priority is to support server-client model first because this is likely what the most common usecase will be."},{"author":"Patrick","date_created":1481936561,"date_modified":1481936561,"content":"HulaHoop (HulaHoop):\n> - To avoid getting into a trust bootstrapping nightmare - its not\n> enough to revoke a key but also send a new one via the emergency\n> notification system to replace the revoked one.\n\nEmergency news should only inform about the new key. Not add the new\nkey. Otherwise that functionality would exceed the competence of\nemergency news.\n\n> The emergency\n> notification messages should be signed with a different key than the\n> one for repo package signing old and new.\n\nadded here:\nhttps://www.whonix.org/wiki/Dev/emergency-news\n\n> In a sense the emergency\n> key is a master key that should be very well guarded and only used in\n> such situations - because it has authority over repo keys. Its sounds\n> bad but I don't have better ideas for this.\n\nShould use multi sig (key splitting).\n\nThe Debian apt signing key is on an official debian.org server. The\nrevocation key is on Debian Developer's (DD) machines. (Not necessarily\noffline machines.)\n\nThey would need at least a 7/12 signature to create the Debian apt\nsigning key revocation certificate.\n\nSource:\nhttps://ftp-master.debian.org/keys.html\n\nSo by using multi sig and not keeping the the emergency news signing key\nonly on DD's machines, it would be safer than Debian's apt signing key.\n\nAdded here:\nhttps://www.whonix.org/wiki/Dev/emergency-news\n\n> - Should revocation be automated? IMO nothing should ever be done\n> automatically. Fortunately apt in Whonix doesn't do automatic\n> updates. Imagine how bad that would have been!\n\nPerhaps it should be checked for revocation certificates on every run of\napt-get update but not otherwise automated? [Unless users opted in for\nauto apt updates but then that's there choice - no difference to the\ncurrent situation.]\n\n> - The key handling/revoking should be done via GPG itself of course.\n> We should only be concerned about the scripting that handles a remote\n> emergency command and its execution on the machine.\n\nI'd advice against signing the emergency news on any official debian.org\nsystem. That should be done be done only on demand by DDs. Does that\naddress your point?\n\n> - Language choice: Up to you. Whichever you are comfortable with is\n> best unless upstream is prejudiced against one or the other for\n> security reasons.\n\nWhat do you mean by language choice? Do you mean the final wording of\nthe proposal?\n\nI am not eager to do the clean wording of the proposals.\n\n> - I did not get the feeling that keyserver use is unwelcome however\n> this is just one pool - there are still many other operators. Also it\n> might be a redundancy with either centralized server-client used\n> instead or a decentralized storage alternative. The priority is to\n> support server-client model first because this is likely what the\n> most common usecase will be.\n\nMade a note here:\nhttps://www.whonix.org/wiki/Dev/apt-revoker\n\nWe now have two proposals.\n\n- https://www.whonix.org/wiki/Dev/emergency-news\n- https://www.whonix.org/wiki/Dev/apt-revoker\n\nThere will be some overlap.\n\nI guess we should present only one concept at a time? Perhaps start with\napt-revoker?\n\n(Doesn't mean we cannot already discuss/write the emergency-news\nproposal. We can discuss/write any concept as thoughts are incoming.)"},{"author":"HulaHoop","date_created":1482021428,"date_modified":1482021428,"content":">Perhaps it should be checked for revocation certificates on every run of apt-get update but not otherwise automated? \n\nBy \"automating\" it can run with apt-update even with an apt.cron setup maybe?\n\n>What do you mean by language choice? \n\nBash vs Python\n\n>I guess we should present only one concept at a time? Perhaps start with apt-revoker?\n\nYes.\n\n>There will be some overlap.\n\nBoth tools can be used together in some situations but they are very different in what they do. If this is presented clear enough the overlap in people's minds should be eliminated.\n\n>(Doesn't mean we cannot already discuss/write the emergency-news proposal. We can discuss/write any concept as thoughts are incoming.)\n\nRight."},{"author":"Patrick","date_created":1482065612,"date_modified":1482065612,"content":">>! In T140#11042, @HulaHoop wrote:\n>>Perhaps it should be checked for revocation certificates on every run of apt-get update but not otherwise automated? \n> \n> By \"automating\" it can run with apt-update even with an apt.cron setup maybe?\n\nIf apt.cron runs apt-get update, then yes. apt.cron -> apt-get update -> apt-revoker -> real apt-get updating.\n\n>>What do you mean by language choice? \n> \n> Bash vs Python\n\nI would leave this open.\n"},{"author":"Patrick","date_created":1482068304,"date_modified":1482068304,"content":"Renamed from emergency news to project news. It does not have to be limited to emergencies if it's configureable. Users could subscribe to various channels, i.e. emergencies only, testers wanted etc.\n\nhttps://www.whonix.org/wiki/Dev/project-news\n\nAdded more points:\n* https://www.whonix.org/w/index.php?title=Dev%2Fproject-news&type=revision&diff=26955&oldid=26953\n* https://www.whonix.org/w/index.php?title=Dev%2Fproject-news&type=revision&diff=26956&oldid=26955\n* https://www.whonix.org/w/index.php?title=Dev%2Fproject-news&type=revision&diff=26959&oldid=26958\n\nShould only distributions be allowed to drop in news plugins or application packages also?"},{"author":"HulaHoop","date_created":1482074030,"date_modified":1482074030,"content":">Should only distributions be allowed to drop in news plugins or application packages also?\n\nApplications too. Its useful when upstream wants to communicate non backwards-compatible changes. Though it would be good to make this configurable allowed/not allowed in case distros have a problem with package news not going thru them first."},{"author":"Patrick","date_created":1482075528,"date_modified":1482075528,"content":"Ok, added."}]},"PHID-TASK-wxduo7yugm4n2goac64j":{"id":"139","title":"device auto mounter broken","status":"open","priority":"Normal","author":"Patrick","description":"Migrated from:\nhttps://web.archive.org/web/20220000000000*/https://github.com/Whonix/Whonix/issues/168\n\nKnown issue with workaround:\nhttps://www.whonix.org/wiki/Known_Issues#Mounting_(CD_/_DVD)_Devices\nShould still be fixed for better usability.\n\nAsked on mailing list:\nhttp://lists-archives.com/kde/15416-device-auto-mounter-can-not-mount-the-following-device.html\n","comments":[]},"PHID-TASK-b4zmnfisu5a3wdc3ya6w":{"id":"138","title":"Internationalization Support for tb-updater","status":"open","priority":"Wishlist","author":"Patrick","description":"Most of this has already been implemented:\nhttps://www.whonix.org/wiki/Language#Tor_Browser\n\nWhat's missing is a GUI option in tb-updater to advertise this feature.","comments":[{"author":"Patrick","date_created":1446660717,"date_modified":1446660717,"content":"Lowering priority, because Tor Browser now has it's own internal updater and because tb-updater has been degraded to being a downloader only.\n\nAlso fixing torbrowser-launcher might be a better use of time:\n* T18\n* https://www.whonix.org/forum/index.php/topic,404.0.html"}]},"PHID-TASK-5undful5tnhia3gcjlbt":{"id":"137","title":"whonix-setup-wizard usability feedback blog post","status":"resolved","priority":"Normal","author":"Patrick","description":"Write a blog post (+ automatic forum post) that explains our current usability approach with screenshots and so forth. \n\nAnd keep that usability discussion clean of technical discussion. Talk there more about formulating things, the order of pages, if xinit looks sane and so forth.","comments":[{"author":"Patrick","date_created":1424714692,"date_modified":1424714692,"content":"Done:\nhttps://www.whonix.org/blog/whonix-setup-wizard-feedback"},{"author":"troubadour","date_created":1424718972,"date_modified":1424718972,"content":"Don't know why, the windows sizes are wrong in the post. The disclaimer pages should not have scroll bars, and the connection page should be resized to something nicer. Strange.\n\nTwo reasons I left that one aside, lack of time and I could find the way to login or create an account in the blog. Perhaps I could modify it."},{"author":"Patrick","date_created":1424719564,"date_modified":1424719564,"content":"Most likely my host system resolution and installed guest additions made the difference.\n\nYeah, I had in mind to ask if you can modify the disclaimer pages so they don't show scroll bars.\n\n(Used a very recent git revision by the way: https://github.com/Whonix/whonix-setup-wizard/commit/157710e28de19a4410b44617a01a1dd644140376 - so it's not because of an old version.)\n\nBlog login link:\nhttps://www.whonix.org/blog/wp-login.php\n\nBlog registration link:\nhttps://www.whonix.org/blog/wp-login.php?action=register\n\nAfter registration, I need to promote the account."},{"author":"troubadour","date_created":1424721898,"date_modified":1424721898,"content":"I was already registered (as troubadour). Did that some day around 4 AM, it's probably why I forgot. "},{"author":"Patrick","date_created":1424722346,"date_modified":1424722346,"content":"Okay, promoted account."},{"author":"troubadour","date_created":1424894230,"date_modified":1424894230,"content":"Changed the disclaimer pages and the first connection page. I left the one with tooltip. How did you manage to get a snapshot of the tooltip?\n\nA remark: had to do it from clearnet (HTTP error in WordPress wit Whonix)."},{"author":"Patrick","date_created":1424899567,"date_modified":1424899567,"content":"Off-topic: also wrote you an e-mail.\n\n> Changed the disclaimer pages and the first connection page.\n\nDid you make changes in git?\n\n> How did you manage to get a snapshot of the tooltip?\n\n1) hover over option to see tooltip in VM\n2) Virtual Box -> Machine -> Disable Mouse Integration \n3) Press Virtual Box host key to leave VM and be back on the host. Mouse in VM will stay where it was.\n4) Running \"shutter\" (from official Debian package) on the host. Made a shoot of a manual selection of the screen.\n\n> A remark: had to do it from clearnet (HTTP error in WordPress wit Whonix).\n\nWhat kind of error?"},{"author":"Patrick","date_created":1424900835,"date_modified":1424900835,"content":"> What kind of error?\n\nAn ssl mixed content error? That one is fixed. It was because wordpress uses http rather than https links for images by default. Manually fixed for now. If it happens again, I'll look into some wordpress https enforce plugin or perhaps T70."},{"author":"troubadour","date_created":1425071272,"date_modified":1425071272,"content":"Still getting a plain `HTTP error` when trying to upload an image.\n\nThe connection page with tooltip is  updated."},{"author":"Patrick","date_created":1425094879,"date_modified":1425094879,"content":"That's not one that I ever experienced. (Therefore not the one I talked about fixing.) Seems to be some wordpress bug.\n\nYou can also upload images to mediawiki and then link them from the blog. Perhaps it would have been better if I did that in the first place so we can later reuse those for documentation. [if documentation is required, seems pretty self explanatory]"},{"author":"Patrick","date_created":1425231775,"date_modified":1425231775,"content":"Don't worry about that blog post too much. It served its purpose. The blog is more like a journal. If something is on your mind, if you want to write something, forget about editing old posts. Just make a new one \"hi, I am troubadour, see this updated screenshot etc.\""},{"author":"Patrick","date_created":1426078835,"date_modified":1426078835,"content":"I guess this is done. Feel free to reopen."}]},"PHID-TASK-ziw4i2rhph3fcpwy22kr":{"id":"136","title":"install whonix-setup-wizard by default","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1423264109,"date_modified":1423264109,"content":"Done:\nhttps://github.com/Whonix/anon-meta-packages/commit/837e181dd627e7309a6034455afd91cb202a062e"}]},"PHID-TASK-tdyojm657xusmg66py6f":{"id":"135","title":"find packages without security support / consider installation of debian-security-support by default","status":"open","priority":"Normal","author":"Patrick","description":"When the Debian security team ends security support for packages, and an affected package is already installed, those packages will by default not be reported. Therefore the user will likely continue to use those eventually vulnerable packages. This also applies to Debian `stable`.\n\nThe [debian-security-support](https://packages.debian.org/search?keywords=debian-security-support) package helps to solve this issue. It provides a [check-support-status](http://manpages.debian.org/cgi-bin/man.cgi?query=check-support-status&apropos=0&sektion=0&manpath=Debian+testing+jessie&format=html&locale=en) command that can list those packages as well as automatically runs during `apt-get dist-upgrade`.\n\nAs of Debian `wheezy`, examples include kde4libs, pidgin, qtwebkit, webkit. (Check output of `debian-security-support`.)\n\nInstalling `debian-security-support` would cause more confusion than gain. Reporting something like `kde4libs` and a bunch of libs, tells the user nothing. [showing reverse depends](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=776548) is a missing feature in `debian-security-support`.\n\n`debian-security-support` is a a `sh` shell script.\n\nTODO:\n* This is something, that needs to be documented in [updating documentation](https://www.whonix.org/wiki/Security_Guide#Updates).\n* Implement showing reverse depends into `debian-security-support`. ([upstream feature request](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=776548))\n* Think about whatever else is missing in `debian-security-support` to make it useful for the user.\n* Finally, after improving `debian-security-support`, install it by default.","comments":[]},"PHID-TASK-kp6up2iwwpnsgy7yvjcx":{"id":"134","title":"Audio Sometimes Not Working in Qubes","status":"resolved","priority":"Normal","author":"WhonixQubes","description":"Audio output is sometimes not working in Qubes.\n\nExperienced in both Whonix-Workstation and Whonix-Gateway.\n\nWhen audio is working, the \"Attach/Detach audio-input to the VM\" option is enabled for the VM in the Qubes Manager.\n\n\n\n#qubes\n\n\n\nForum Discussion:\n- https://www.whonix.org/forum/index.php/topic,908.0.html","comments":[{"author":"nrgaway","date_created":1424073288,"date_modified":1424073288,"content":"Resolved with commit to upstream qubes-agent-linux.  Will be available in 9.6 release of Whonix.\n\n[[ https://github.com/nrgaway/gui-agent-linux/commit/3287ae87cf00b61d0e9ba8a8f5ca301f9123b3b7#diff-d8b9296a2c6a78a087ed04f21ceadf8aR61 | https://github.com/nrgaway/gui-agent-linux/commit/3287ae87cf00b61d0e9ba8a8f5ca301f9123b3b7#diff-d8b9296a2c6a78a087ed04f21ceadf8aR61 ]]"}]},"PHID-TASK-dxz6eratyrdgthljuqhl":{"id":"133","title":"url_to_unxtime https support","status":"resolved","priority":"Low","author":"Patrick","description":"url_to_unxtime currently has no https support.\n\n~~Maybe we need this. Maybe not. Currently depends on T131, because we it's not clear yet if we still need an https fallback mode.~~ There is no urge to add an https fallback mode for performance reasons, because there were no performance warnings after asking about this [on the tor-talk mailing list](https://lists.torproject.org/pipermail/tor-talk/2015-February/036842.html).\n\nActually, it's not an either - or - situation. It's not either Tor hidden services or SSL. Some Tor hidden services offer SSL. For reasons why they might do this, see [Notes about End-to-end security of Hidden Services](https://www.whonix.org/wiki/Hidden_Services#Notes_about_End-to-end_security_of_Hidden_Services).\n\nSo https support in url_to_unixtime would still be useful.\n\nBut for now, I am only aware of 2 or 3 non-anonymous, trustworthy Tor hidden services that support SSL. Facebook's Tor hidden services which we probably do not want to add to the sdwdate time source pool list. And some self signed ones?\n\nSo this is not that important and can maybe be done a lot later. Depending on how the combination of Tor hidden services and SSL evolves. Therefore decreasing priority to low.","comments":[{"author":"Patrick","date_created":1610203659,"date_modified":1610203659,"content":"This was implemented. Now using python3 `requests`.\n\nWas implemented in order to add `HTTP/1.1` support. (Previously only had `HTTP/1.0` support.) https support was a \"free bonus\".\n\nhttps://github.com/Whonix/sdwdate/blob/master/usr/bin/url_to_unixtime\n\nhttps://forums.whonix.org/t/sdwdate-and-sdwdate-gui-development-thread/1137/371"}]},"PHID-TASK-iksqyedru7kkryda5alz":{"id":"132","title":"port sdwdate to url_to_unixtime","status":"resolved","priority":"Normal","author":"Patrick","description":"url_to_unixtime has been implemented. (T102)\n\nTODO:\nport sdwdate (currently using curl) to url_to_unixtime.\n\nThis is currently blocked by\n* T131, because we it's not clear yet if we still need an https fallback mode","comments":[{"author":"Patrick","date_created":1423263577,"date_modified":1423263577,"content":"Done."},{"author":"Patrick","date_created":1423472250,"date_modified":1423472250,"content":"fix, don't give more weight to a pool member, just because it provides mirrors; changed pool format; refactoring:\nhttps://github.com/Whonix/sdwdate/commit/a1e79fcf2354af361eedc6bdb99acc87b5deaeac"}]},"PHID-TASK-wsa5ym6q6hfxjl5w4e3e":{"id":"131","title":"Hidden Services as sdwdate time sources","status":"resolved","priority":"Normal","author":"Patrick","description":"Migrated from:\nhttps://github.com/Whonix/Whonix/issues/351\n\n----\n\nTODO:\n\nNot so technical work:\n\n~~1) asking the hidden service news sites if they agree to this use case~~ ([Done](https://www.whonix.org/pipermail/whonix-devel/2015-February/000289.html).)\n\n----\n\n~~2) asking tor-talk if this is a sane idea or if it would overload hidden services~~ [Done](https://lists.torproject.org/pipermail/tor-talk/2015-February/036789.html).\n\n----\n\n~~3) Ask which Tor Hidden Services we could use for this. Done:~~\n\n* [blog post](https://www.whonix.org/blog/sdwdate-onion-sources)\n* [forum thread](https://www.whonix.org/forum/index.php/topic,943)\n* [tor-talk post](https://lists.torproject.org/pipermail/tor-talk/2015-February/036842.html)\n\n----\n\n4) Currently waiting for and reading responses.\n\n----\n\n~~Technical work:~~\n\n~~5) Depending on 1, either switch sdwdate's code to use onion-only, either per default or not and either leaving https compatibility mode or not. -> T132~~\n","comments":[{"author":"Patrick","date_created":1423148555,"date_modified":1423148555,"content":"asking the hidden service news sites if they agree to this use case:\n[Done](https://www.whonix.org/pipermail/whonix-devel/2015-February/000289.html). Replies/results:\n\n* balkanleaks.eu: contact e-mail unreachable.\n"},{"author":"Patrick","date_created":1423679066,"date_modified":1423679066,"content":"This is done. Adding more hidden services to the pools as they are being suggested."}]},"PHID-TASK-6xadzkejd33b4355ltdi":{"id":"130","title":"Tor Browser Alpha rather than Tor Browser Stable being installed","status":"resolved","priority":"High","author":"Patrick","description":"https://www.whonix.org/blog/bug-alpha-stable-tor-browser\n\nhttps://www.whonix.org/forum/index.php/topic,939.html\n\n([This is how torbrowser-launcher solved this.](https://github.com/micahflee/torbrowser-launcher/blob/143cbf4ee13fa4b227688b1e55f69fd65b2decfc/torbrowser_launcher/launcher.py#L517\n))","comments":[{"author":"Patrick","date_created":1424698451,"date_modified":1424698451,"content":"Thanks to @troubadour for creating tb_updater_gui (T149), I was able to fix this in tb-updater by porting to tb_updater_gui."}]},"PHID-TASK-ju33uncgjm6uymgyf4gz":{"id":"129","title":"research PyPy for better python script security","status":"resolved","priority":"Normal","author":"Patrick","description":"Find out if PyPy and/or PyPy's sandbox would be useful to increase security.\n\nA good good candidate for testing and confinement, because relatively simple to play with, would be [url_to_unixtime](https://github.com/Whonix/sdwdate/blob/master/usr/lib/sdwdate/url_to_unixtime) (T102). Later also [control-port-filter-python](https://github.com/troubadoour/control-port-filter-python).\n\nSee also:\n\n* [Security Enhancements for Python scripts - PyPy](https://www.whonix.org/forum/index.php/topic,662)\n\nRelated:\n\n* research seccomp for better python script security: T128 [if we start using pypy, we might not need T128]\n","comments":[{"author":"HulaHoop","date_created":1434589870,"date_modified":1434589916,"content":"PyPy's sandbox is an experimental proof-of-concept and will not be operational any time soon.\n\nThe project's dev's comments point out that even the only python module that worked with it, the 'time' module, no longer does and was removed. To support a decent amount of python features a lot of work is needed in addition to long-term maintenance investment.\n\nhttps://stackoverflow.com/a/29890408\n\n***\n\nsystemd.exec integrates and exposes Linux's security features in an easy to use manner. It was chosen instead.\n\nhttps://www.whonix.org/forum/index.php/topic,1313\n\n"}]},"PHID-TASK-jabdssnf7ycrcodmvutb":{"id":"128","title":"research seccomp for better python script security","status":"resolved","priority":"Normal","author":"Patrick","description":"Find out if seccomp (and/or seccomp.py) would be useful to increase security.\n\nA good good candidate for testing and confinement, because relatively simple to play with, would be [url_to_unixtime](https://github.com/Whonix/sdwdate/blob/master/usr/lib/sdwdate/url_to_unixtime) (T102). Later also [control-port-filter-python](https://github.com/troubadoour/control-port-filter-python).\n\nSee also:\n* [Security Enhancements for Python scripts - seccomp.py](https://www.whonix.org/forum/index.php/topic,663.0.html)\n\nRelated:\n\n* research PyPy for better python script security: T129 [if we start using pypy, we might not need seccomp.py T128]","comments":[{"author":"Patrick","date_created":1429990017,"date_modified":1429990017,"content":"`[Whonix-devel] hardening python scripts with seccomp.py`:\nhttps://www.whonix.org/pipermail/whonix-devel/2015-April/000347.html"},{"author":"HulaHoop","date_created":1434590391,"date_modified":1434590391,"content":"seccomp.py would have needed a lot of effort to extend to be able to meet cpfp's syscall requirements while making sure its still secure. prctl's interface is far from pythonic to deal with. Not a solution that scales.\n\n***\nsystemd.exec integrates and exposes Linux's security features in an easy to use manner. It was chosen instead.\n\nhttps://www.whonix.org/forum/index.php/topic,1313"},{"author":"Patrick","date_created":1487014754,"date_modified":1487014969,"content":">>! In T128#5598, @HulaHoop wrote:\n> https://www.whonix.org/forum/index.php/topic,1313\n\nnew link:\nhttps://forums.whonix.org/t/cpfpd-data-options-control-port-filter-python-hardening"}]},"PHID-TASK-a735yuot6xyxisbhqxcr":{"id":"127","title":"use a random socks auth/pass for better stream isolation?","status":"resolved","priority":"Normal","author":"Patrick","description":"Now that T126 is done, we can consider using a random socks auth/pass for #tb-updater. Because of Tor's `IsolateSOCKSAuth` this would lead to use a fresh circuit and therefore maybe a different Tor exit every time tb-updater is run. If one Tor exit is mounting a denial of service or perhaps other attack [ssl mitm + downgrade attack etc.], chances would be better that it would be solved by next run.\n\nDoes anyone see any bad effects when doing this?","comments":[{"author":"Patrick","date_created":1466684722,"date_modified":1466684722,"content":"https://github.com/Whonix/tb-updater/commit/4ea87fc2e8e6ea37a160e1a779c517d113217ffa"}]},"PHID-TASK-yck7v3vr23xr6mr52m6t":{"id":"126","title":"instead of --socks5-hostname, use more modern --proxy + user:password@ip:port syntax for curl for better stream isolation","status":"resolved","priority":"Normal","author":"Patrick","description":"Old syntax:\n```\n      --socks5-hostname \"socks5h://$GATEWAY_IP:$SOCKS_PORT_WHONIXCHECK/\" \\\n```\n\nProposed syntax:\n```\n      --proxy \"socks5h://user:password@$GATEWAY_IP:$SOCKS_PORT_WHONIXCHECK\" \\\n```\n","comments":[{"author":"Patrick","date_created":1423060555,"date_modified":1423060555,"content":"Why?\nEven if the user used those ports for its own stuff, streams would still be isolated, thanks to Tor's `IsolateSOCKSAuth`.\n\nDone:\n* https://github.com/Whonix/whonixcheck/commit/73171bc8bda784e7656e2a4809e8d7d2073a7ed5\n* https://github.com/Whonix/tb-updater/commit/d040c12085a527f4d39cb1751f2e514642c7ebaa\n* https://github.com/Whonix/sdwdate/commit/5724d83b258a469b7a9a7bbc65153987f986369b\n* https://github.com/Whonix/sdwdate-plugin-anon-shared-streamiso/commit/7a8983187169110874d1622291305f0678c10fa3\n"}]},"PHID-TASK-l2w7kss5m6htaqaecsfl":{"id":"125","title":"Tunnel, VPN, proxy, SSH documentation needs to be restructured","status":"resolved","priority":"Normal","author":"Patrick","description":"**Short Task Description**:\n\nSee https://www.whonix.org/wiki/Features#VPN_.2F_Tunnel_support then use your brain and restructure it in a usable way. ;)\n\n-----\n\n**Details**:\n\nThese pages are historically grown. When we started documenting this, we didn't know everything we know now. Knowing what we know now, we should restructure that knowledge so it can be easier understood by the user.\n\nFor example, https://www.whonix.org/wiki/Tunnel_Tor_through_proxy_or_VPN_or_SSH has an \"introduction\" chapter, that is supposed to be read by all, proxy, VPN and SSH tunnel users.\n\nAnd https://www.whonix.org/wiki/Tunnel_Proxy_or_SSH_or_VPN_through_Tor has a \"required knowledge\" chapter that applies to all of these.\n\nAlso for VPN related stuff, these two pages are theoretical and for the practical part, we tell users to see the https://www.whonix.org/wiki/TestVPN page.\n\nWe also tell them for VPN related stuff \"Fail Closed Mechanism\", but instead of explaining how to do this to them, we link to other pages.\n\nFor better usability, these 3 pages (tunnel Tor through X + tunnel X through Tor + TestVPN) should be split into 6. Like this:\n\n*    Tunnel Tor through proxy (user -> proxy -> Tor)\n*    Tunnel Tor through SSH (user -> SSH -> Tor)\n*    Tunnel Tor through VPN (user -> VPN -> Tor)\n\n*    Tunnel proxy/proxychains through Tor (user -> Tor -> proxy)\n*    Tunnel SSH through Tor (user -> Tor -> SSH)\n*    Tunnel VPN through Tor (user -> Tor -> VPN)\n\nKnowledge that applies to multiple tunnel scenarios should be moved to wiki templates and these templates should then be used where required.","comments":[{"author":"JasonJAyalaP","date_created":1448828934,"date_modified":1448828934,"content":"I'd like one page that briefly introduces two types of connections (tunnel before; tunnel after), with links to 6 pages for each configuration/setup.\n\nHere's my rough draft of the intro page. Tell me if any technical details are wrong or unclear:\n\n---\n\n\nIt is possible to combine Tor with tunnels and proxies such as VPN, Socks and SSH. Your traffic can be sent through both Tor and the second tunnel, in either order. However, this is an advanced topic and appropriate only for special cases. Adding a second connection does not automatically add security, but will add significant complexity. In fact, improper combination of Tor and another service may decrease your security and anonymity. For almost all users of Whonix, using Tor alone – without a VPN or proxy – is the right choice.\n\nConnecting to a VPN or encrypted proxy before Tor\n\nBy first connecting to a VPN (or proxy) then connecting to Tor, your internet traffic will (1) pass through your ISP as encrypted VPN or proxy traffic; (2) exit your VPN server as encrypted Tor traffic; (3) enter to the Tor network; (4) exit the Tor network at a Tor exit node as normal internet traffic (encrypted or unencrypted).\n\nPossible uses:\n* You must connect to your VPN or proxy to access the internet.\n* Your ISP blocks Tor and Tor bridges but doesn’t block VPNs or proxies. Your ISP doesn’t inspect VPN or proxy traffic for possible Tor connections.\n* Fear of de-anonymizing attacks against the Tor network; belief that your VPN is able to hide your identity in such case.\n\nWarnings:\n* A VPN or proxy that knows your identity and/or location may be more willing and able to compromise your privacy than your ISP.\n* If your software configuration doesn’t block all traffic when your connection to your VPN or proxy suddenly disconnects, your Tor traffic will go through your ISP without warning.\n* HTTP, HTTPS, and Socks proxies are much less likely to hide your Tor traffic than VPNs.\n* If the use of Tor is dangerous in your area, VPNs and proxies may not provide enough protection.\n\nConfiguring a VPN before Tor\nConfiguring a Proxy before Tor\nConfiguring SSH before Tor\n\n\nConnecting to a VPN or encrypted proxy after Tor\n\nBy first connecting to Tor, then to a VPN or proxy, your internet traffic will (1) pass through your ISP as encrypted Tor traffic; (2) exit the Tor network at a Tor exit node as encrypted VPN or proxy traffic; (3) exit your VPN or proxy as normal internet traffic (encrypted or unencrypted).\n\nPossible uses:\n* As one component of using a VPN or proxy anonymously for some specific reason.\n* You must use Tor, but need to connect to an internet server who bans Tor exit nodes.\n\nWarnings:\n* Even though Tor will hide your IP address from your VPN or proxy, you can still be located with your payment method, usages logs, or other identifying information the service knows about you.\n* You will not be able to access Tor hidden services.\n\nConfiguring a VPN after Tor\nConfiguring a Proxy after Tor\nConfiguring SSH after Tor"},{"author":"Patrick","date_created":1448830953,"date_modified":1448830953,"content":"Looks good overall. A general overview page sounds very good. Feel free to create [temporary] wiki pages. After you're done we can simply move them where they really belong. [Just want to spare you from once writing the text using phabricator and one mediawiki markup.]\n\nSince these introduction pages are often skipped by users, since they find the links elsewhere, these general info and warnings should be actually hosted in wiki templates. So these can be reused at the specific pages.\n\nHow to use wiki templates? Template:somepage. Add the text. Then import that template from a normal wiki page using {{tempalte-name}}. A random example:\n\n* https://www.whonix.org/wiki/Template:Supported_Platforms_Table\n* https://www.whonix.org/wiki/Download\n\nSome minor technical points.\n\n> improper combination of Tor and another service may decrease your security and anonymity\n\nI am certain, the \"may\" will generate inquiries. The 'may' should be a link. Or a footnote linking to https://trac.torproject.org/projects/tor/wiki/doc/TorPlusVPN should be added after that sentence.\n\n> encrypted proxy\n\nThat combination of words is problematic. Please have a look here:\nhttps://www.whonix.org/wiki/Comparison_Of_Tor_with_CGI_Proxies,_Proxy_Chains,_and_VPN_Services\n\n> If your software configuration doesn’t block all traffic when your connection to your VPN or proxy suddenly disconnects, your Tor traffic will go through your ISP without warning.\n\nPerhaps a footnote or something, that makes clear, that Whonix does not introduce this issue, the we're only documenting this mess that we did not create. Would be pointless if users therefore concluded \"I not use Whonix then\".\n\n> Configuring a Proxy before Tor\n\n\"before\" is ambiguous because traffic flows in two directions. So many got this wrong.\n\n> By first connecting to Tor, then to a VPN or proxy\n\nWe should keep the current wordings in this style.\n\n* Connecting to a tunnel-link (proxy/VPN/SSH) before Tor\n* Connecting to a proxy before Tor\n\nAnd also keep the connection schemes.\n\n* (User -> proxy/VPN/SSH -> Tor -> Internet)\n\nTo make sure no one can misunderstand. This has always been a source for major confusion."},{"author":"JasonJAyalaP","date_created":1448846115,"date_modified":1448846115,"content":"https://www.whonix.org/wiki/Using_Tunnels_with_Whonix2\n\nI'll begin making separate pages for the setup."},{"author":"Patrick","date_created":1448851009,"date_modified":1448851009,"content":"While we're at it, we could also consider a page hierarchy. Such as:\n\n* https://www.whonix.org/wiki/Tunnel/Introduction\n* https://www.whonix.org/wiki/Tunnel/...\n* etc.\n"},{"author":"JasonJAyalaP","date_created":1448932443,"date_modified":1448932443,"content":"https://www.whonix.org/wiki/Configure_VPN_before_Tor\n\nA made the \"VPN before Tor\" page. The last part (configure whonix-gateway) was copy and pasted from the original page. I'll revisit those instructions once all the pages are in place.\n\nI like the page heirarchy idea. Is that how you want it? Maybe \"Tunnels\" instead?\n\nTunnels/Introduction\nTunnels/VPN_Before_Tor\nTunnels/SSH_After_Tor\n\nor\n\nTunnel/VPN/Before_Tor\nTunnel/SSH/After_Tor\n\n?"},{"author":"Patrick","date_created":1448983057,"date_modified":1448983057,"content":"The before and after is ambiguous.\n\nIt all comes down to one's perspective. i.e. am I talking about the\ntunnel-link being \"behind\" Tor and therefore before it reaches my\ninternet destination (User -> x -> Tor -> Internet)? Or, am I talking\nabout the tunnel-link being \"behind\" Tor before the data reaches me?\n(User -> Tor -> X -> Internet)\n\nThat's why it was changed to.\n\n- Connecting to a tunnel-link (proxy/VPN/SSH) before Tor\n- Connecting to a VPN before Tor\n\n- Connecting to Tor before a tunnel-link\n- Connecting to Tor before a VPN\n\nWhen \"before\" is coupled with \"connecting\", it makes it rather obvious\nthat one is speaking from the mindset of the [User] connecting to [X]\nbefore [i.e. connecting to X first, and then connecting to] Y.\n\nHierarchy proposal:\n\n- Tunnels/Connecting_to_a_VPN_before_Tor\n- Tunnels/Connecting to_Tor_before_a_VPN"},{"author":"JasonJAyalaP","date_created":1449185239,"date_modified":1449185239,"content":"https://www.whonix.org/wiki/Tunnels/Introduction\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_a_VPN_before_Tor\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_a_proxy_before_Tor\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_SSH_before_Tor\n(I heavily editted the SSH directions. They were very messy. I think I found a decent compromise between describing what we know and what we don't yet know).\n\n"},{"author":"Patrick","date_created":1449195258,"date_modified":1449195258,"content":"Nice!"},{"author":"JasonJAyalaP","date_created":1449618677,"date_modified":1449619574,"content":"https://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_a_VPN\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_a_VPN/Examples\n(I separated the riseup-vpn example from the instructions and gave it its own page. I thought /Examples was a cute url that could be added to the other pages)\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_a_proxy\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_SSH"},{"author":"Patrick","date_created":1449619399,"date_modified":1449619399,"content":"JasonJAyalaP (Jason J. Ayala P.):\n>   https://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_a_VPN/Examples\n\nShould just be https://www.whonix.org/wiki/Tunnels/Examples for now,\nsince these examples aren't tied to Connecting_to_Tor_before_a_VPN.\n\n(mediawiki has a page move function. At the top menu. action -> move)"},{"author":"JasonJAyalaP","date_created":1449619820,"date_modified":1449619933,"content":"\nEDIT: Oh wait, I see. The riseup example is about connecting to a VPN, before or after.\n\nOriginal:\nThe rise-up example on VPN/Examples is about Tor_before_a_VPN, and it's longer than most of the individual tunnel pages. When we have one or multiple proxy_before_Tor example(s), you'd rather have them on the same long page as the rise-up Tor_before_a_VPN example than on \"proxy_before_Tor/Examples\" ?\n"},{"author":"JasonJAyalaP","date_created":1449620455,"date_modified":1449620455,"content":"OK\nhttps://www.whonix.org/wiki/Tunnels/Examples\n"},{"author":"JasonJAyalaP","date_created":1449620895,"date_modified":1449620895,"content":"https://www.whonix.org/wiki/Tunnels/Introduction\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_a_VPN_before_Tor\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_a_proxy_before_Tor\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_SSH_before_Tor\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_a_VPN\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_a_proxy\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_SSH\nhttps://www.whonix.org/wiki/Tunnels/Examples\n\nIt still needs review for obvious stuff like in-page anchor links that were broken by page separation.  I made a few editorial judgements, but nothing too drastic. The task of separation seems to be done. Can we close this topic? However, these pages could still need some minor formatting improvements (What's the markup to change the page title display?). And, of course, there is room for improvement generally speaking."},{"author":"Patrick","date_created":1449626939,"date_modified":1449626961,"content":"JasonJAyalaP (Jason J. Ayala P.):\n> (What's the markup to change\n> the page title display?).\n\nOne method would be to add\n```\n__NOTITLE__\n```\nat the very top. That magic word is hidden in the final html output and\nwill suppress the title."},{"author":"Patrick","date_created":1449627543,"date_modified":1449627543,"content":"If we want a title replacement, we should perhaps do that using html.\nJust now created a template:\nhttps://www.whonix.org/wiki/Template:Title\n\nusage:\n```\n{{Title|\ntitle=Connecting to a VPN before Tor\n}}\n```\n\nUsage example:\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_a_VPN_before_Tor\n"},{"author":"Patrick","date_created":1449630446,"date_modified":1449630446,"content":"Do you have a rough list of editorial changes?\n\nComparison Table should be included in the introduction.\n\nWe also need SEO descriptions for all pages. (Most Whonix pages have them. See for comparison.)\n```\n{{#seo:\n|description=Whonix Documentation. Crash Course in Anonymity and Security on the Internet.\n}}\n```\n\nShouldn't we somehow optically separate `<references />` as done by other pages? (On other pages they have their own chapter.) It doesn't have to be its own chapter, but just writing them at the page end without and optical separation seems wrong.\n\nLooks good overall.\n\nOnce that is sorted out, and [anchor] links and https://www.whonix.org/wiki/Features#VPN_.2F_Tunnel_support is working... We move https://www.whonix.org/wiki/Using_Tunnels_with_Whonix to https://www.whonix.org/wiki/Deprecated/Using_Tunnels_with_Whonix. Then this ticket can be closed.\n\nWe still wouldn't have actionable, usable pages one can read and apply from top to bottom, but still a huge improvement over the previous mess."},{"author":"JasonJAyalaP","date_created":1449887848,"date_modified":1449887901,"content":"I added {{Title| and #seo to each page. (But some pages are showing the __NOTITLE__ effect, some aren't.)\n\nI copy-pasted the comparison table to the intro page.\n\nI don't have a list of editorial judgements. Most were very minor. I think biggest was splitting out the details of 'https://www.whonix.org/wiki/Using_Tunnels_with_Whonix#Things_to_keep_in_mind_when_connecting_to_Tor_before_a_tunnel-link' to different pages (one point went to the introduction warnings, one point went to proxy pages... I think. Stuff like that). \n\noptically separate <references /> ? I don't understand.\n\nI linked \"https://www.whonix.org/wiki/Features#VPN_.2F_Tunnel_support\" to the new pages\n"},{"author":"JasonJAyalaP","date_created":1449888548,"date_modified":1449888548,"content":"I did a visual scan for anchor links in all 6 sub-pages, but only needed to correct one link.\n\nThis link is very odd though\nhttps://www.whonix.org/wiki/Tunnels/Connecting_to_Tor_before_a_proxy#Generally\n\nWhat exactly is \"read first\" ? And is the #introduction link susposed to be the info about fixing tor browser (and does it still have the bug?)."},{"author":"Patrick","date_created":1449888880,"date_modified":1449888880,"content":"https://www.whonix.org/wiki/Documentation still needs fixing."},{"author":"Patrick","date_created":1449889078,"date_modified":1449889078,"content":">>! In T125#7586, @JasonJAyalaP wrote:\n> optically separate <references /> ? I don't understand.\n\nLike this:\nhttps://www.whonix.org/w/index.php?title=Tunnels%2FIntroduction&diff=20259&oldid=20256"},{"author":"JasonJAyalaP","date_created":1449948142,"date_modified":1449948142,"content":"Which part of wiki/Documentation? The \" Tunnel Support / Chaining Support \" is using a template that I changed.\n\nReferences is just a matter of putting \n= Footnotes =\n<references />\n\nat the end of each page?"},{"author":"Patrick","date_created":1449948242,"date_modified":1449948242,"content":"Fixed wiki/Documentation.\n\nYes."},{"author":"Patrick","date_created":1449948564,"date_modified":1449948564,"content":"The double title sux, but I haven't found out how to get rid of it yet. Perhaps some CSS trick ( https://www.whonix.org/wiki/Dev/CSS !!!) could get rid of the ugly titles on all wiki pages."}]},"PHID-TASK-wowm3gw7mz65bdnz2y5l":{"id":"124","title":"generic gui tool - set default to \"no\" button","status":"resolved","priority":"Normal","author":"Patrick","description":"Current default is \"yes\". Could you set it to \"no\" please?","comments":[{"author":"troubadour","date_created":1422651302,"date_modified":1422651302,"content":"Done.\nhttps://github.com/troubadoour/msgcollector/commit/1999fd9c7ec0471da68f25824520b94be6ad9dd3"},{"author":"Patrick","date_created":1422655501,"date_modified":1422655501,"content":"Awesome. Tested and merged. Thanks!"}]},"PHID-TASK-vxazaradyghnb3jrpby2":{"id":"123","title":"how to write two strings exactly below each other using generic gui tool","status":"resolved","priority":"Normal","author":"Patrick","description":"As per screenshot:\n{F24}\n\nThe version numbers are exactly below each other. Using the `<blockquote>` tag here. But it's ugly. Too many empty lines in between.\n\nThe dates are not exactly below each other, which looks also bad.\n\nIs it possible to write them exactly below each other? Any idea @troubadour?","comments":[{"author":"Patrick","date_created":1422537568,"date_modified":1422537568,"content":"Looks possible using the `<pre>` tag. Open to nicer solutions."},{"author":"Patrick","date_created":1423085310,"date_modified":1423085310,"content":"Regression. Due to changes in T122, this is an issue again."},{"author":"troubadour","date_created":1423089495,"date_modified":1423089495,"content":"Testing with this:\n```#!/bin/bash\n\nmsg=\"<p>Download Confirmation<br></br>\n----------------------------------------------------------------------</p>\nPrevious Signature Creation Date : Fri<br>\nCurrent Signature Creation Date&nbsp; : Fri\n\n<pre>\nPrevious Signature Creation Date : Fri\nCurrent Signature Creation Date  : Fri\n</pre>\n\nPrevious Signature Creation Date : Fri<br>\nCurrent Signature Creation Date&nbsp;&nbsp; : Fri\n\n<pre>\nPrevious Signature Creation Date : Fri\nCurrent Signature Creation Date   : Fri\n</pre>\"\n\n/usr/lib/msgcollector/generic_gui_message info title \"$msg\" \"\" yesno\n```\nWhatever, the dates are still not aligned. I guess we would need a mono font to achieve it."},{"author":"Patrick","date_created":1423243996,"date_modified":1423243996,"content":"`<tt>` alone doesn't work. What might work are tables. This example looks good:\n\n```\n<p>Download Confirmation<br></br>\n----------------------------------------------------------------------</p><p><table><tr>\n<td>Currently installed version:</td> <td><tt>$tbb_locally_installed_version</tt></td></tr><tr>\n<td>Online detected version(s) :</td> <td><tt>$tbb_recommended_versions_inside_one_line_list</tt></td></tr></table></p>\n```\n\nStill experimenting..."},{"author":"Patrick","date_created":1423245629,"date_modified":1423245629,"content":"Somewhat fixed using tables:\nhttps://github.com/Whonix/tb-updater/commit/d9a8775a390377066c144db68f459cc4910c04c4\n\nBut it would require another change in generic_gui_tool. Changing from `500` to `590`.\n\n```\n        if messageHeight <= maximumHeight:\n            self.resize(590, messageHeight + 60)\n        else:\n            self.resize(590, maximumHeight - 20)\n```\n\nOtherwise the `Previous Signature Creation Date` line gets too long and broken. Does that change look sane?"},{"author":"troubadour","date_created":1423251453,"date_modified":1423251453,"content":"Yes, it does. Tested OK (with the new window width). "},{"author":"Patrick","date_created":1423251831,"date_modified":1423251831,"content":"Ok, will change in git..."},{"author":"Patrick","date_created":1423252006,"date_modified":1423252006,"content":"Done in git:\nhttps://github.com/Whonix/msgcollector/commit/66f6a8a93e38fc7160d542b762f9422706830fec\n\nTherefore this issue has been fixed."}]},"PHID-TASK-3vrlcmk4wp62uihaiue7":{"id":"122","title":"enable hyperlink support in generic gui tool","status":"resolved","priority":"Normal","author":"Patrick","description":"Opening external links is currently unsupported. Could you take care of this please @troubadour?\n\nThis would be useful for T104.","comments":[{"author":"troubadour","date_created":1422719855,"date_modified":1422719855,"content":"Something that has been on my TODO list for a while. \n\n**Short**: generic_gui_message does not support opening external links.\n\n**Long**: the script is using Qt's QMessageBox class, which has a restricted default behavior, not modifiable unless one rewrites it. One of the missing features is \"setOpenExternalLinks\", \n\n**Possible solution**: use msgdispatcher_dispatch_x (more versatile). It should be rewritten to accept other buttons than \"OK\", and to be cleaned from some extra code (most of it was generated with PyQt4-Designer and translated from C++ to Python). That should not be a big deal.\n \nThe issue is to pass the result (Yes-No) to the calling bash script. It may look as trivial as `print \"1\"` or `print \"0\"`, but we are in the Qt event loop... I remember trying (long) before, but there should be a solution."},{"author":"Patrick","date_created":1422729358,"date_modified":1422729358,"content":"That possible solution sounds good to me. Wouldn't be a lot work for me to port from generic_gui_message to msgdispatcher_dispatch_x."},{"author":"troubadour","date_created":1422938545,"date_modified":1422938545,"content":"Pushed a new version of generic_gui_message. It supports opening external links,and does not require any change in the bash scripts using it.\n\nI think it's better to keep msg_dispatcher_x and generic_gui_message as separate scripts, even if they will share the same code once the former is rewritten. Reasons are that the arguments differ (ex: position and [whonixcheck/timesync] icon in msg_dispatcher_x only, question in generic_gui_message only), and the window size differ.\n\nAlthough it is possible to merge them, we would end up with hard to read, difficult to maintain code."},{"author":"troubadour","date_created":1422941068,"date_modified":1422941068,"content":"Referring to T104 `The warning sign is not scary enough.`, it's BIG now, as well as the error sign.\n\nNo longer \"No\" button set as default. looking into it.\n"},{"author":"troubadour","date_created":1422943695,"date_modified":1422943695,"content":"Default button is \"No\".\nhttps://github.com/troubadoour/msgcollector/commit/b6362bf21f2cbbf40638727b03ad588f98510a37"},{"author":"troubadour","date_created":1422983789,"date_modified":1422983789,"content":"Pushed a commit fixing a richtext issue, but there is a big issue when opening links. Basically, generic_gui_message is calling itself, displaying the the same message. Coming back on that."},{"author":"Patrick","date_created":1422984002,"date_modified":1422984002,"content":"Agreed. The approach sounds good.\n\nThere is a typo:\n`blocquote`\n\nIt doesn't parse the rich text yet. It shows it as is. Example:\n```\n/usr/lib/msgcollector/generic_gui_message info 'Tor Browser Updater (by Whonix developers)' 'Download Confirmation\n<br></br>----------------------------------------------------------------------\n<pre>Currently installed version: None installed. (/home/user/tor-browser_en-US does not exist.)\nOnline detected version(s) : 4.5a3 4.0.3 </pre>' 'Download now?' yesno\n```\n"},{"author":"troubadour","date_created":1422984034,"date_modified":1422984034,"content":" When trying to open a link, the default browser is set to open_link_confirmation, which calls generic_gui_message."},{"author":"Patrick","date_created":1422984265,"date_modified":1422984265,"content":"Richtext works now, but shows an error as per git 79e4dfda022c2ee15492f1a1cc6186765cbc7ced.\n\n```\n/usr/lib/msgcollector/generic_gui_message info 'Tor Browser Updater (by Whonix developers)' 'Download Confirmation\n<br></br>----------------------------------------------------------------------\n<pre>Currently installed version: None installed. (/home/user/tor-browser_en-US does not exist.)\nOnline detected version(s) : 4.5a3 4.0.3 </pre>' 'Download now?' yesno\nTraceback (most recent call last):\n  File \"/usr/lib/msgcollector/generic_gui_message\", line 95, in setSize\n    messageHeight = self.text.document().size().height()\nAttributeError: 'QLabel' object has no attribute 'document'\n6553\n```\n"},{"author":"troubadour","date_created":1422995986,"date_modified":1422995986,"content":"Fixed. Something weird here. There was a bug, and I could not spot it in the normal course of the TBB installation, all looking normal (with `Install now?`though). Nevermind.\n\nAnother small issue.  In `update-torbrowser`, when the signature verification fails, it looks like the message is going to msgdispatcher.\n```   if [ ! \"$tb_gpg_verify_exit_code\" = \"0\" ]; then\n      local MSG=\"<p><b>GPG download signature could NOT be verified.</b>\n<br></br>Tor Browser update failed! Try again later.</p>\"\n      $output ${output_opts[@]} --progressbaridx \"$progressbaridx\" --progressx \"100\" || true\n\n      $output ${output_opts[@]} --messagex --typex \"error\" --message \"$MSG\" --done\n      $output ${output_opts[@]} --messagecli --typecli \"error\" --message \"$MSG\" --done\n      exit 1\n   fi\n```\nWould it not make sense to pop a generic gui, with a big red icon?"},{"author":"Patrick","date_created":1423006214,"date_modified":1423006214,"content":"Yes, that one is fixed.\n\nIssues:\n* cannot copy from the window\n* no scrollbar if too much vertical text\n* no scrollbar if too much horizontal text\n* text gets truncated without scrollbar, i.e. when you run\n\n```\n/usr/lib/msgcollector/generic_gui_message info 'Tor Browser Updater (by Whonix developers)' 'Download Confirmation\n<br></br>----------------------------------------------------------------------\n<pre>Currently installed version: None installed. (/home/user/tor-browser_en-US does not exist.)\nOnline detected version(s) : 4.5a3 4.0.3 </pre>' 'Download now?' yesno\n```\n\nYou can only see `Currently installed version: None installed. (/home/user/t`.\n\n> Would it not make sense to pop a generic gui, with a big red icon?\n\nDunno. I would prefer to not overuse the big one. That error message is \"not that important\". I mean, the signature confirmation users could result in a downgrade attack. But that \"it failed, nothing too bad happened one\", users will notice sooner or later, try again etc."},{"author":"troubadour","date_created":1423082799,"date_modified":1423082799,"content":"Everything should be back to normal. There was strange combination of circumstances: the HTML in update-torbrowser was not right AND the examples above are wrong too. Need double quotes to pass parameters to python from the shell and `<pre>` is not recognized, apparently.\n\nFor testing:\n```/usr/lib/msgcollector/generic_gui_message info title \"<p>Download Confirmation<br></br>----------------------------------------------------------------------</p><p>Currently installed version: tbb_locally_installed_version<br></br>Online detected version(s) : tbb_recommended</p> <p>up_to_date_or_not_text</p><p>re_install_or_install_text</p><p>If your currently installed version is:<blockquote> - higher: you are likely target of a downgrade attack, SAY NO NOW<br></br>- equal : only proceed, if you want to create a new browser profile.<br></br>- lower : you should upgrade.</blockquote></p><p>YOUR BROWSER WILL BE KILLED.<br></br>YOUR WHOLE BROWSER PROFILE INCLUDING BOOKMARKS AND PASSWORDS WILL GET REPLACED.</p><p>A backup of your old Tor Browser and settings will be created in your home folder.<br></br>It is a good idea to delete old TBB backups once in a while if you are running low with disk space.</p><p>Download Confirmation<br></br>----------------------------------------------------------------------</p><p>Currently installed version: tbb_locally_installed_version<br></br>Online detected version(s) : tbb_recommended</p> <p>up_to_date_or_not_text</p><p>re_install_or_install_text</p><p>If your currently installed version is:<blockquote> - higher: you are likely target of a downgrade attack, SAY NO NOW<br></br>- equal : only proceed, if you want to create a new browser profile.<br></br>- lower : you should upgrade.</blockquote></p><p>YOUR BROWSER WILL BE KILLED.<br></br>YOUR WHOLE BROWSER PROFILE INCLUDING BOOKMARKS AND PASSWORDS WILL GET REPLACED.</p><p>A backup of your old Tor Browser and settings will be created in your home folder.<br></br>It is a good idea to delete old TBB backups once in a while if you are running low with disk space.</p><p>Download Confirmation<br></br>----------------------------------------------------------------------</p><p>Currently installed version: tbb_locally_installed_version<br></br>Online detected version(s) : tbb_recommended</p> <p>up_to_date_or_not_text</p><p>re_install_or_install_text</p><p>If your currently installed version is:<blockquote> - higher: you are likely target of a downgrade attack, SAY NO NOW<br></br>- equal : only proceed, if you want to create a new browser profile.<br></br>- lower : you should upgrade.</blockquote></p><p>YOUR BROWSER WILL BE KILLED.<br></br>YOUR WHOLE BROWSER PROFILE INCLUDING BOOKMARKS AND PASSWORDS WILL GET REPLACED.</p><p>A backup of your old Tor Browser and settings will be created in your home folder.<br></br>It is a good idea to delete old TBB backups once in a while if you are running low with disk space.</p>\" \"\" yesno\n```\nThe text copy is fixed in the last commit in msgcollector and the HTML in https://github.com/troubadoour/tb-updater/commit/2582f6c29baee9635d49dd0afd1d13b5874aefe9 (done it twice because you updated tb-updater a few hours ago :).\n"},{"author":"Patrick","date_created":1423085347,"date_modified":1423085347,"content":"Merged.\n\nDo you have a test command that isn't in one line?\n\nCaused a regression that has a separate ticket: T123"},{"author":"Patrick","date_created":1423246695,"date_modified":1423246695,"content":"Two issues:\n\n* The \"no\" button is not is not visibly selected by default. (\"Yes\" is not the default either, but the \"no\" button has no blue surrounding.) Using arrow keys is not possible. I think none of the buttons is selected by default.\n* The window is not centered for some reason.\n\nExample test command (for copy and paste):\n\n```\n/usr/lib/msgcollector/generic_gui_message warning 'Tor Browser Updater (by Whonix developers)' '<p>Download Confirmation<br></br>\n----------------------------------------------------------------------</p><p><table><tr>\n<td>Currently installed version:</td> <td><tt>4.0.3</tt></td></tr><tr>\n<td>Online detected version(s) :</td> <td><tt>4.5a3 4.0.3 </tt></td></tr></table></p>\n\n<p>Looks like there is an upgrade for Tor Browser.</p>\n\n<p>Please close Tor Browser if you want to (re-)install!</p>\n\n<p>If your currently installed version is:<blockquote>\n   - higher: you are likely target of a downgrade attack, SAY NO NOW.<br></br>\n   - equal : only proceed, if you want to create a new browser profile.<br></br>\n   - lower : you should upgrade.</blockquote></p>\n\n<p>YOUR BROWSER WILL BE KILLED.<br></br>\nYOUR WHOLE BROWSER PROFILE INCLUDING BOOKMARKS AND PASSWORDS WILL GET REPLACED.</p>\n\n<p>A backup of your old Tor Browser and settings will be created in your home folder.\n<br></br>It is a good idea to delete old TBB backups once in a while if you are running low with disk space.</p>' 'Download now?' yesno\n```"},{"author":"troubadour","date_created":1423337590,"date_modified":1423337590,"content":"There was a couple of issues, the main one not being able to properly set the \"no\" button to default with QT \"StandardButtons\" (I'll pass the details) . So it was rewritten with push buttons, looking identical.\n\nOther changes :\n- width increased to 600. Looks better in some situations.\n- fixed size window (no maximize button). Had to do it because of the fixed position of the buttons when resizing the window. Now it behaves like a standard message box (with some extras). \n\nThe window is centered when called from the scripts. For an unknown reason, it moves down when called from a terminal.\n\nhttps://github.com/troubadoour/msgcollector/commit/9ced2031af6dd8a9df3b8f17d5c2803c3f21afc6"},{"author":"Patrick","date_created":1423338571,"date_modified":1423338571,"content":"Merged. Looks good so far.\n\nTwo issues:\n* moved down also when called from script\n* hyperlinks can not be clicked / opened"},{"author":"Patrick","date_created":1423338666,"date_modified":1423338666,"content":"Another issue:\n\n* selecting text works, but right click menu is disabled / no copy/paste possible"},{"author":"Patrick","date_created":1423338725,"date_modified":1423338725,"content":"Another issue:\n* When moved down (also when called from script), the buttons are outside the visible space. One would need to move the window up first to see the buttons."},{"author":"troubadour","date_created":1423409360,"date_modified":1423409360,"content":"https://github.com/troubadoour/msgcollector/commit/54b094306d458dab56252989f0354d9a408edeb7 should fix it all (amazing how a task that was looking like a piece of cake can become a burden when you take for granting that it works, without proper testing...).\n\n- open external links working.\n- select and copy text working.\n- vertical scroll bar as needed.\n- \"No\" button set as default on opening, highlighted with blue border.\n- window properly centered on screen.\n- window resizeable (maximize button too). "},{"author":"Patrick","date_created":1423410002,"date_modified":1423410002,"content":"All tested. All works nice! Merged."}]},"PHID-TASK-zbbqpbv56x4rkkhwftqn":{"id":"121","title":"provide an option WORKSTATION_ALLOW_SOCKSIFIED to skip Tor SocksPort iptables rules","status":"resolved","priority":"Normal","author":"Patrick","description":"When using:\n* multiple internal network interfaces (T109)\n* and only being interested in transparent proxying (Whonix-Custom-Workstations)\n\nLoading all the iptables rules that allow access to Tor SocksPorts (for stream isolation) are useless. And bad. Because the more iptables rules, the higher the CPU usage and the slower the network speed.\n\nTODO:\nprovide an option `WORKSTATION_ALLOW_SOCKSIFIED` to skip Tor SocksPort iptables rules","comments":[{"author":"Patrick","date_created":1422320319,"date_modified":1422320319,"content":"Implemented:\nhttps://github.com/Whonix/whonix-gw-firewall/commit/9b0345f9ede5aed4c90c2d6a9f956b3220900071\n\n`sudo iptables --list` didn't show any difference in default settings."}]},"PHID-TASK-updaec7diy2f6tge6h5n":{"id":"120","title":"support multiple external interfaces","status":"resolved","priority":"Low","author":"Patrick","description":"Analog to T109. For consistency. Makes documenting and explaining this a lot easier than explaining what disadvantages one would have without this feature.","comments":[{"author":"Patrick","date_created":1422318964,"date_modified":1422318964,"content":"Done:\nhttps://github.com/Whonix/whonix-gw-firewall/commit/dfdaf72382436c110ae10d835c94a3995fb47553\n\n`iptables --list` didn't notice any differences."}]},"PHID-TASK-ptbhnv3rzasa7pmysb4q":{"id":"119","title":"grml-debootstrap apt-get unsigned package install security bug workaround","status":"resolved","priority":"High","author":"Patrick","description":"It combines `apt-get install` with `--yes` and `--force-yes`, which could lead to installation of unsigned packages.\n\nHappens only for `jessie` and later based builds.\n\nupstream bug report:\nhttps://github.com/grml/grml-debootstrap/issues/62\n","comments":[{"author":"Patrick","date_created":1422318174,"date_modified":1422318174,"content":"Research:\nhttps://www.whonix.org/wiki/Dev/apt-get\n\nAdded a workaround:\nhttps://github.com/Whonix/Whonix/commit/7ce93134bb9226c7a1062674f443f5c980fa6627\n\nBut I leave this open as a reminder for testing and while I wait for [comments](https://github.com/grml/grml-debootstrap/issues/62#issuecomment-71561788)."},{"author":"Patrick","date_created":1423020745,"date_modified":1423020745,"content":"Tested the workaround. Looked how grml-debootstrap would call it.\n\n```\n~ $ sudo su\nroot@host:/home/user# \nroot@host:/home/user# DEBIAN_FRONTEND=noninteractive apt-get --force-yes -y --no-install-recommends install -o Acquire::http::Timeout=180 -o Acquire::ftp::Timeout=180 -o Acquire::Retries=3 -o Acquire::Check-Valid-Until=false -o APT::Get::force-yes=0 libreoffice\nReading package lists... Done\nBuilding dependency tree       \nReading state information... Done\nThe following packages were automatically installed and are no longer required:\n  libavahi-core7 libdaemon0\nUse 'apt-get autoremove' to remove them.\nThe following extra packages will be installed:\n  fonts-sil-gentium-basic libcolamd2.7.1 libhsqldb-java liblucene2-java libreoffice-base libreoffice-calc libreoffice-draw libreoffice-filter-mobiledev libreoffice-impress\n  libreoffice-report-builder-bin libservlet2.5-java libvisio-0.0-0 lp-solve ttf-sil-gentium-basic\nSuggested packages:\n  java-virtual-machine libhsqldb-java-doc libhsqldb-java-gcj hunspell-dictionary libreoffice-help-3.5 libreoffice-l10n-3.5 unixodbc cups-bsd libsane hyphen-hyphenation-patterns\n  mythes-thesaurus libreoffice-grammarcheck libreoffice-gnome libreoffice-kde openclipart-libreoffice pstoedit gstreamer0.10-plugins-ugly libreoffice-officebean libmyodbc\n  odbc-postgresql libsqliteodbc tdsodbc mdbtools libmysql-java libpg-java libjtds-java libreoffice-gcj libreoffice-report-builder\nRecommended packages:\n  fonts-sil-gentium libcommons-beanutils-java libcommons-collections3-java libcommons-compress-java libcommons-digester-java libcommons-logging-java libdb-java libdb-je-java\n  libicu4j-java libjline-java libjtidy-java libregexp-java ttf-liberation ttf-mscorefonts-installer\nThe following NEW packages will be installed:\n  fonts-sil-gentium-basic libcolamd2.7.1 libhsqldb-java liblucene2-java libreoffice libreoffice-base libreoffice-calc libreoffice-draw libreoffice-filter-mobiledev\n  libreoffice-impress libreoffice-report-builder-bin libservlet2.5-java libvisio-0.0-0 lp-solve ttf-sil-gentium-basic\n0 upgraded, 15 newly installed, 0 to remove and 0 not upgraded.\nNeed to get 19.3 MB of archives.\nAfter this operation, 60.1 MB of additional disk space will be used.\nWARNING: The following packages cannot be authenticated!\n  fonts-sil-gentium-basic libcolamd2.7.1 libservlet2.5-java libhsqldb-java liblucene2-java lp-solve libreoffice-calc libvisio-0.0-0 libreoffice-draw libreoffice-impress\n  libreoffice-base libreoffice-report-builder-bin ttf-sil-gentium-basic libreoffice-filter-mobiledev libreoffice\nE: There are problems and -y was used without --force-yes\nroot@host:/home/user# \n```\n\nThe workaround isn't pretty. Would be better if upstream fixed it. But the workaround is sufficient."}]},"PHID-TASK-uznkkqp52s5363c2ix6g":{"id":"118","title":"make TBB usable as \"system Tor\", so latest pluggable transports and the tor-launcher graphical user interface can be used in Whonix","status":"open","priority":"Wishlist","author":"Patrick","description":"Currently being discussed in the forums:\nhttps://forums.whonix.org/t/tor-launcher-better-circumvention-user-interface\n\nUpstream Feature request:\n`make TBB usable as \"system Tor\"`\nhttps://trac.torproject.org/projects/tor/ticket/14121\n\nRelated:\nT116","comments":[{"author":"HulaHoop","date_created":1438522869,"date_modified":1438522900,"content":"At the moment we have three choices:\n\n* Run TBB headlessly (xvfb) on GW and configure pluggable transports through torrc. Its a compromise on usability but gains us the advantage of the latest pluggable transports and reproducible binaries. Should upstream ever add standlone support for torlauncher-gui it should be easy to enable it for GW.\n\n* Run TBB with its full GUI but make sure the browser window cannot connect anywhere, to allow using torlauncher-gui too. This might however trigger the redistribution problems we avoid with running headlessly.\n\n* Keep the status quo - the \"worst\" option because the poor situation of pluggable transport support  outside TBB."},{"author":"Patrick","date_created":1438524982,"date_modified":1438524982,"content":"Good ideas! I would call this development / TODO #research tasks, though.\n\n>>! In T118#6198, @HulaHoop wrote:\n> At the moment we have three choices:\n\nFour. Don't forget the best solution described in the original ticket description. It just doesn't materialize because no one speaks/contributes #javascript. I am wondering how useful it is to go through any of the hacks below and not using that time to learn javascript and doing the real fix.\n\n> * Run TBB headlessly (xvfb) on GW and configure pluggable transports through torrc. Its a compromise on usability but gains us the advantage of the latest pluggable transports and reproducible binaries. Should upstream ever add standlone support for torlauncher-gui it should be easy to enable it for GW.\n\nWe would still need scripts for starting/stopping TBB then. Or documentation on which commands to run. Would also need to check which config file changes are required to make TBB just connect without needing to click anything in tor-launcher (which would then not be visible). And debugging we would need documentation on how to make it visible? (Imagine it doesn't work for someone.)\n \n> * Run TBB with its full GUI but make sure the browser window cannot connect anywhere, to allow using torlauncher-gui too. This might however trigger the redistribution problems we avoid with running headlessly.\n\nWould also cause an #usability issue, because of the redundant (from usability perspective, not technical) browser window.* Also a #security issue, because blocking the browser from connecting anywhere would be hard. Would either need some patch upstream (environment variable TBB_LOCKDOWN or so) or modifying TBB after extracting it (which can break due to upstream changes).\n\n*Especially a #usability issue on #Qubes, because there the window would not be hidden in a different VM window but end up on the usual task bar. The user could move the redundant window to another virtual desktop, though.\n\n-----\n\nIn any case, please consider implementing T116 first."},{"author":"HulaHoop","date_created":1438581408,"date_modified":1438581408,"content":"\nLaunching Tor and TBB from command line:\nhttps://askubuntu.com/questions/320545/how-to-launch-tor\n\n/etc/rc.local for xvfb auto startup on Debian:\nhttp://technology.manyask.com/viewtopic.php?t=1488398\n\nI'm still trying to figure out how to run TBB under xvfb. With firefox the command is: \nxvfb-run firefox\nhttp://elementalselenium.com/tips/38-headless\n\n\n\n> We would still need scripts for starting/stopping TBB then. Or documentation on which commands to run. Would also need to check which config file changes are required to make TBB just connect without needing to click anything in tor-launcher (which would then not be visible). And debugging we would need documentation on how to make it visible? (Imagine it doesn't work for someone.)\n\nThe browser part of TBB will always be necessary for some pluggable transports that directly depend on it like meek. So I'm not sure the upstream solution for stopping TBB from starting will help us here. We have to hide the window."},{"author":"Patrick","date_created":1438600939,"date_modified":1438600939,"content":"HulaHoop (HulaHoop):\n> Launching Tor and TBB from command line: \n\nEasy. No need to worry about this right now. tb-starter must already\nknow how to start it, no? Just type `torbrowser`. Or `bash -x\ntorbrowser` to see what it's doing. Just `cd` into the TBB folder, run\n`./start-tor-browser.desktop`\n\n> https://askubuntu.com/questions/320545/how-to-launch-tor\n\nOutdated and not required.\n\n> /etc/rc.local for xvfb auto startup on Debian: \n> http://technology.manyask.com/viewtopic.php?t=1488398\n\nThe autostart is one of the simplest things here. (Can be implemented as\nsystemd service, and/or /etc/xdg/autostart, there are many ways.) No\nneed to worry about this right now.\n\n> I'm still trying to figure out how to run TBB under xvfb. With\n> firefox the command is: xvfb-run firefox \n> http://elementalselenium.com/tips/38-headless\n\nWon't work with `torbrowser` script. Launches into the background using\n`&`. (Just remove the `&` in `/usr/bin/torbrowser` for lines containing\n`start-tor-browser`.\n\nOr `cd` into the TBB folder. `xvfb-run ./start-tor-browser.desktop`\nwon't work. (Using detached start.) `xvfb-run\n./Browser/start-tor-browser` works.\n\n> The browser part of TBB will always be necessary for some pluggable\n> transports that directly depend on it like meek. So I'm not sure the\n> upstream solution for stopping TBB from starting will help us here.\n> We have to hide the window.\n\nStopping the whole thing, TBB, required for restarting Tor and clean\nshutdowns. The process will likely be stoppable by a usual sigterm. Not\nhard. Just needs to be implemented.\n\nThe easiest would be, if tor-launcher wouldn't open the Tor Browser\nwindow and just stay as is. Perhaps as a tray icon. (By the time you can\nsee tor-launcher, Firefox is already running. Just it's main window does\nnot come up because tor-launcher prevents this. tor-launcher is an\nadd-on running inside Firefox itself.)\n\n-----\n\nThe next step really should be T116. Auto start, stop, xvfb are\nperiphery. T116 requires more difficult work. (compatibility with system\nTor, stopping system Tor, maybe no longer auto starting system Tor,\nhaving TBB's Tor provide as system wide Tor, have TBB use Whonix's\n/usr/share/tor/tor-service-defaults-torrc. All needs instructions.)"},{"author":"HulaHoop","date_created":1438626758,"date_modified":1438626758,"content":"I'm assuming we are completely replacing Debian repo's system Tor with TBB Tor.\n\nWhere torrc is for Tor Browser Bundle:\nhttps://tor.stackexchange.com/a/1072\n\n\n(will need to update paths to torrc in wiki documentation and for shortcuts. A benefit of this change is users can replace torrc files before first run because its in a non-root directory)\n\n\nConfigure xvfb for Vivid (15.04) as a service using systemd:\nhttp://askubuntu.com/questions/621246/configure-xvfb-for-vivid-15-04-as-a-service-using-systemd\n\nTor Browser environment variables controlling how Tor starts and exits:\nhttps://trac.torproject.org/projects/tor/ticket/13005"},{"author":"Patrick","date_created":1438726359,"date_modified":1438726359,"content":"> I'm assuming we are completely replacing Debian repo's system Tor with TBB Tor.\n\nI didn't. But forgot to make explicit, that this should be optional. At least for its initial implementation. Due to the volatileness of TBB. (Upstream is moving files around and making otherwise bold changes.) I think this whole thing is a hack. Should therefore just be optional. It's also more likely to break. Too experimental to make it the default for everyone. And cumbersome. Instructions would likely include steps such as:\nsudo cp [/usr/share/tor/tor-service-defaults-torrc](https://github.com/Whonix/anon-gw-anonymizer-config/blob/master/usr/share/tor/tor-service-defaults-torrc) /home/debian-tor/.tb/tor-browser_en-US/Browser/TorBrowser/Data/Tor/torrc-defaults\nOr somehow this would need to be scripted.\n\n\n\n`~/.tb/tor-browser_en-US/Browser/TorBrowser/Data/Tor/torrc` gets edited by tor-launcher. See comments.\n```\n# This file was generated by Tor; if you edit it, comments will not be preserved\n# The old torrc file was renamed to torrc.orig.1 or similar, and Tor will ignore it\n\nBridge scramblesuit [...]\n```\n\n`~/.tb/tor-browser_en-US/Browser/TorBrowser/Data/Tor/torrc-defaults` is static, but also very likely be updated by upstream in future.\n\nMerging in Whonix's `/usr/share/tor/tor-service-defaults-torrc` is also required. Difficult in the absence of [torrc.d-style configuration directories](https://trac.torproject.org/projects/tor/ticket/1922).\n\nImplementing this ticket is hard. Start with T116 first."},{"author":"HulaHoop","date_created":1438782623,"date_modified":1438782623,"content":">  I think this whole thing is a hack. Should therefore just be optional. It's also more likely to break. Too experimental to make it the default for everyone. And cumbersome.\n\nThen for a stable based OS like Whonix this is not an option. Eventually more pluggable transport binaries will make it into their repos upstream so we don't //really// have to go thru all this to eventually use them.\n\nWe still support obfsproxy at the moment and its not just a PT but a framework that supports many types of pluggable transports."},{"author":"Patrick","date_created":1438790594,"date_modified":1438790594,"content":"But then we'll don't get a pluggable transports gui (tor-launcher) within the next how many years. And no access to recent (working!) pluggable transports.\n\nAt least T116 is good to have. When T116 is done, this one will be will be more in reach.\n\nAnother option would be documenting how to use TBB running on the host or in another VM and having Whonix-Gateway use it. But that should become another ticket."},{"author":"HulaHoop","date_created":1438832908,"date_modified":1438832908,"content":"Another blocker problem: TBB will refuse to run as root. Not going to be possible to run it as system Tor. Cannot use debian-tor group.\n\nIts a sound design decision because why would they want users running a vulnerable browser as root? but its a showstopper unless upstream changes their core development plans to include target users other than jut desktop users for TBB.\n\nhttps://tor.stackexchange.com/questions/3224/the-tor-browser-bundle-should-not-be-run-as-root-why\n\nhttps://tor.stackexchange.com/questions/6705/make-tor-browser-bundle-use-debian-tor-tor-and-not-tbb-tor\n\n"},{"author":"Patrick","date_created":1439002318,"date_modified":1439002318,"content":"I succeeded starting TBB as user `debian-tor`.\n\n```\nsudo mkdir /home/user/debian-tor\nsudo chown --recursive debian-tor:debian-tor /home/user/debian-tor\nsudo usermod debian-tor -s /bin/bash\n```\n\nMoved the TBB folder to /home/user/debian-tor and started it there.\n\nAll tested only on regular Debian for now. Should not be that hard to do the same on Whonix.\n\n-----\n\nI succeeded starting TBB as user `root`. Just commented out the root check in the startup script.\n\nFile: `Browser/start-tor-browser`\nComment out:\n\n```\nif [ \"`id -u`\" -eq 0 ]; then\n        complain \"The Tor Browser Bundle should not be run as root.  Exiting.\"\n        exit 1\nfi\n```\n\nThis could be doable with `sed`. Also submitting a patch upstream would not be hard. Getting it merged a little harder. But judging from when I [talked last time with Isis on tor-talk](https://lists.torproject.org/pipermail/tor-talk/2014-August/034322.html), I guess she could be supportive. Simple patch after all.\n\n-----\n\nBut I don't think we'd need to run as user `root` anyhow. The only port below 1024 we're listen on is the DNS port. And there is no reason to not move that DNS port up."},{"author":"HulaHoop","date_created":1439074045,"date_modified":1439074045,"content":"\nNice progress! \n\nI looked for ways to enable TBB's automatic update functionality when its running headless. It can be done by shipping a custom pref.js/user.js settings file. We can configure when updates happen and if they happen automatically without having to interact with a GUI notification to permit it. This way we can bundle TBB with Whonix Gateway and not have to rely on any updater mechanisms outside TBB itself.\n\nApp.update.auto \n\n\nhttp://kb.mozillazine.org/Category:Preferences\nhttp://kb.mozillazine.org/App.update.auto\nhttp://kb.mozillazine.org/About:config_entries#Update._and_Update_notifications.\n\nhttp://kb.mozillazine.org/Editing_configuration\n\n> While it's easier to use about:config for a single profile, it may be easier to use a user.js file if you need to make the same changes in many profiles (see the linked article for more information). \n\n\nhttp://kb.mozillazine.org/About:config\n\n> about:config is a feature of Mozilla applications which lists application settings (known as preferences) that are read from the profile files prefs.js and user.js, and from application defaults. Many of these preferences are not present in the Options or Preferences dialog. Using about:config is one of several methods of modifying preferences and adding other \"hidden\" ones. \n\nhttps://support.mozilla.org/en-US/questions/965842#answer-459525\nhttps://developer.mozilla.org/en-US/docs/Mozilla/Preferences/A_brief_guide_to_Mozilla_preferences\n\n> User pref. files\n>\n>  In the profile directory are two user pref files: prefs.js and user.js.  prefs.js is automatically generated by the application and should not be edited manually, whereas user.js is an optional file the user can create to override preferences initialized by other preferences files.\n\n***\n\nOn stability problems, I think the stable branch of Tor Browser is very reliable and solid they are based on upstream Firefox long term releases.\n"},{"author":"HulaHoop","date_created":1439333915,"date_modified":1439333915,"content":"TBB 5+ enables automatic updates by default. No custom modifications needed.\n\n> Starting with this release, Tor Browser will now also download and apply upgrades in the background, to ensure that users upgrade quicker and with less interaction. This behavior is governed by the about:config pref app.update.auto, but we do not recommend disabling it unless you really know what you're doing.\n\n\nhttps://blog.torproject.org/blog/tor-browser-50-released"},{"author":"Patrick","date_created":1439651025,"date_modified":1439651025,"content":">>! In T118#6361, @HulaHoop wrote:\n> TBB 5+ enables automatic updates by default. No custom modifications needed.\n> \n>> Starting with this release, Tor Browser will now also download and apply upgrades in the background, to ensure that users upgrade quicker and with less interaction. This behavior is governed by the about:config pref app.update.auto, but we do not recommend disabling it unless you really know what you're doing.\n> \n> \n> https://blog.torproject.org/blog/tor-browser-50-released\n\nYes. Nice. That helps. So in theory we start TBB headless to have it upgrade itself. The same would likely apply if we could implement what this ticket was originally for."},{"author":"HulaHoop","date_created":1439950601,"date_modified":1439950601,"content":"One problem I can see is the need to restart TBB for updates to take effect. Without a GUI it's not possible for a user to know this information directly but needrestart can detect updated daemons by open file descriptors and restart them.\n"},{"author":"Patrick","date_created":1439996732,"date_modified":1439996732,"content":">>! In T118#6510, @HulaHoop wrote:\n> One problem I can see is the need to restart TBB for updates to take effect. Without a GUI it's not possible for a user to know this information directly but needrestart can detect updated daemons by open file descriptors and restart them.\n\nReference? I am skeptical about that. TBB is not a daemon in the sense that needrestart knows daemons. And TBB upgrades itself in a unique way from perspective of needrestart. For regular daemons that come as deb packages it's easier. Because their dependencies also come as deb packages. And when the dependencies are updated by apt-get/dpkg, needrestart has a chance to notice that and to recommend restart of the daemon."},{"author":"HulaHoop","date_created":1440007495,"date_modified":1440007495,"content":"https://gehrcke.de/2014/06/good-to-know-checkrestart-from-debian-goodies/\n\n> Checkrestart is a Python application wrapping lsof (“list open files”). It tries to identify files used by processes that are not in the file system anymore. How so?\n>\n> Note that during an update a certain binary file becomes replaced: the new version is first downloaded to disk and then rename()ed in order to overwrite the original. During POSIX rename() the old file becomes deleted. But the old file is still in use! The standard says that if any process still has a file open during its deletion, that file will remain “in existence” until the last file descriptor referring to it is closed. While these files that are still held “in existence” for running processes by the operating system, they are not listed in the file system anymore. They can however easily be identified via the lsof tool. And this is exactly what checkrestart does.\n>\n> Hence, checkrestart “compares” the open files used by running processes to the corresponding files in the file system. If the file system contains other (e.g. newer) data than the process is currently using, then checkrestart proposes to restart that process. In a tidy server environment, this usually is the case only for updated shared library files."},{"author":"Patrick","date_created":1440015616,"date_modified":1440015616,"content":"I see. Sounds interesting. It's still unclear if checkrestart is capable of monitoring arbitrary processes that are not managed by dpkg/apt-get. And if it would be easier to replicate this lsof based check rather than bending checkrestart to do that. (Also undesirable to have both checkrestart and needrestart installed at the same time, see T324.)\n\nAnyhow. I don't think that this lsof based approach would work. Apparently TBB does not replace it's own binaries before it's restarted. In comparison, also deb packages shipping daemons do not replace their own binaries. dpkg does that. TBB asks users to restart. Even if the latest version automatically updates, it does not automatically restart itself. A not asked for restart would be undesirable from a user perspective, so that's unlikely. But the restart is required."},{"author":"Patrick","date_created":1440016829,"date_modified":1440016829,"content":"Did some analysis, had the `tor-browser_en-US` folder managed by git before/during/post update.\n\n-----\n\nEarly during upgrade download:\n\n* Folder `Browser/updates/0/` is empty. [No update ever before.]\n* File `Browser/updates.xml` is created.\n* `cat Browser/active-update.xml`\n> <updates xmlns=\"http://www.mozilla.org/2005/app-update\"><update appVersion=\"5.5a1\" buildID=\"20000101000000\" channel=\"alpha\" displayVersion=\"5.5a1\" extensionVersion=\"5.5a1\" installDate=\"1440016394100\" isCompleteUpdate=\"false\" isOSUpdate=\"false\" name=\"Tor Browser 5.5a1\" serviceURL=\"https://www.torproject.org/dist/torbrowser/update_2/alpha/Linux_x86_64-gcc3/5.0a3/en-US?force=1\" showNeverForVersion=\"false\" showPrompt=\"false\" promptWaitTime=\"172800\" type=\"minor\" version=\"5.5a1\" detailsURL=\"https://www.torproject.org/projects/torbrowser.html.en\" platformVersion=\"38.2.0\" previousAppVersion=\"5.0a3\" foregroundDownload=\"true\"><patch type=\"complete\" URL=\"https://www.torproject.org/dist/torbrowser/5.5a1/tor-browser-linux64-5.5a1_en-US.mar\" finalURL=\"https://dist.torproject.org/torbrowser/5.5a1/tor-browser-linux64-5.5a1_en-US.mar\" hashFunction=\"SHA512\" hashValue=\"a5a8225a287c81bd5756120abbd85042bc12094e8dc737cc9dd2670df43f1f883de580a1e0a83cdf9a25064dde50e54bbdd367d0a817892a9c34f46781f65c16\" size=\"78383226\" selected=\"true\" state=\"downloading\"/></update></updates>\n* Above contains `state=\"downloading\"`\n\n-----\n\nLater during download:\n\n* File `Browser/updates/0/update.status` is created.\n\n`cat Browser/updates/0/update.status`\n```\ndownloading\n```\n\n-----\n\nAfter download finished, but not yet restarted:\n\n`cat Browser/updates/0/update.status`\n\n```\napplied\n```\n\n`cat Browser/updates/0/update.version`\n```\n5.5a1\n```\n\n-----\n\nAfter clicking \"restart browser\":\n\n* File `Browser/updates/0/update.version` no longer exists.\n* File `Browser/updates/0/update.status` no longer exists.\n* File `Browser/updates/last-update.log` contains a lot, including a line `UPDATE TYPE complete`.\n* `cat Browser/updates.xml`\n\n> <updates xmlns=\"http://www.mozilla.org/2005/app-update\"><update appVersion=\"5.5a1\" buildID=\"20000101000000\" channel=\"alpha\" displayVersion=\"5.5a1\" extensionVersion=\"5.5a1\" installDate=\"1440015600400\" isCompleteUpdate=\"false\" isOSUpdate=\"false\" name=\"Tor Browser 5.5a1\" serviceURL=\"https://www.torproject.org/dist/torbrowser/update_2/alpha/Linux_x86_64-gcc3/5.0a3/en-US\" showNeverForVersion=\"false\" showPrompt=\"false\" promptWaitTime=\"172800\" type=\"minor\" version=\"5.5a1\" detailsURL=\"https://www.torproject.org/projects/torbrowser.html.en\" platformVersion=\"38.2.0\" previousAppVersion=\"5.0a3\" statusText=\"The Update was successfully installed\" foregroundDownload=\"true\"><patch type=\"complete\" URL=\"https://www.torproject.org/dist/torbrowser/5.5a1/tor-browser-linux64-5.5a1_en-US.mar\" finalURL=\"https://dist.torproject.org/torbrowser/5.5a1/tor-browser-linux64-5.5a1_en-US.mar\" hashFunction=\"SHA512\" hashValue=\"a5a8225a287c81bd5756120abbd85042bc12094e8dc737cc9dd2670df43f1f883de580a1e0a83cdf9a25064dde50e54bbdd367d0a817892a9c34f46781f65c16\" size=\"78383226\" selected=\"true\" state=\"succeeded\"/></update></updates>\n* Above contains `state=\"succeeded\"`.\n\n-----\n\nAfter another browser restart.\n\n`cat Browser/active-update.xml`\n```\n<updates xmlns=\"http://www.mozilla.org/2005/app-update\"/>\n```"},{"author":"Patrick","date_created":1443959481,"date_modified":1443959481,"content":"* Couldn't talk to the ones working on tor-launcher at Tor summer dev meeting 2015. mp / geko not working on this. Therefore still no feedback on how a patch could be designed.\n* Roger said,\n** it's not worth it going through lengths to make TBB/tor-launcher work as system Tor.\n** Pluggable transports will not be changing that fast for now. Duplicating an alternative to tor-launcher and proper packaging for meek would be the way forward.\n* Fragile / crazy idea.\n"},{"author":"Patrick","date_created":1444146200,"date_modified":1444146200,"content":">>! In T90#6837, @troubadour wrote:\n> A note about T118. Been on and off on that one. It looks like tor-launcher is merely settings variables, and that the actual work (like editing torrc or starting meek-client) is done downstream, in firefox or wherever. So I'm not sure it's even possible achieve the bridges settings that way, without starting Tor browser.\n"},{"author":"Patrick","date_created":1444148222,"date_modified":1444148222,"content":"I don't think it's important for the implementation of this ticket. However, this is as I guess things internally work...\n\nBy the time tor-launcher [a Firefox is visible, Tor Browser is already running \"in the background\". Just not visible. Not popping up at that point. It's Tor Browser's (Firefox's) code that processes tor-launcher's [Firefox addon's] code. Therefore showing the tor-launcher gui.\n\nhttps://gitweb.torproject.org/tor-launcher.git/tree/src/components/tl-process.js uses Tor ControlPort command SAFECONF to store settings.\n\n`grep -r extensions.torlauncher.default_bridge_type`\n```\nBrowser/TorBrowser/Data/Browser/profile.default/extensions/tor-launcher@torproject.org/components/tl-process.js:  kPrefDefaultBridgeType: \"extensions.torlauncher.default_bridge_type\",\nBrowser/TorBrowser/Data/Browser/profile.default/extensions/tor-launcher@torproject.org/chrome/content/network-settings.js:const kPrefDefaultBridgeType = \"extensions.torlauncher.default_bridge_type\";\nBrowser/TorBrowser/Data/Browser/profile.default/extensions/tor-launcher@torproject.org/modules/tl-util.jsm:    const kPrefName = \"extensions.torlauncher.default_bridge_type\";\nBrowser/TorBrowser/Data/Browser/profile.default/prefs.js:user_pref(\"extensions.torlauncher.default_bridge_type\", \"meek-amazon\");\n```\n`grep -r awsstatic.com`\n```\nBrowser/TorBrowser/Data/Browser/profile.default/preferences/extension-overrides.js:pref(\"extensions.torlauncher.default_bridge.meek-amazon.1\", \"meek 0.0.2.0:2 4EE0CC769EB4B15A872F742EDE27D298A59DCADE url=https://d2zfqthxsdq309.cloudfront.net/ front=a0.awsstatic.com\");\nBrowser/TorBrowser/Data/Tor/torrc:Bridge meek 0.0.2.0:2 4EE0CC769EB4B15A872F742EDE27D298A59DCADE url=https://d2zfqthxsdq309.cloudfront.net/ front=a0.awsstatic.com\n```\n\nFile `Browser/TorBrowser/Data/Browser/profile.default/preferences/extension-overrides.js` might not be shipped by tor-launcher (perhaps by Tor Browser or TorButton), but it's processed by tor-launcher.\n\nIt seems, that Tor writes torrc.\n\n`grep -r \"comments will\"`\n```\nBinary file Browser/TorBrowser/Tor/tor matches\nBrowser/TorBrowser/Data/Tor/torrc:# This file was generated by Tor; if you edit it, comments will not be preserved\n```\n\nBut only because tor-launcher issues SAFECONF. And I would reasonably speculate, that tor-launcher sets any [bridge] settings in Tor using the Tor control protocol. After its ready, it uses SAFECONF."}]},"PHID-TASK-yravw3g3eyjzmpbt2xdc":{"id":"117","title":"all python scripts need sigterm and sigint traps","status":"resolved","priority":"Normal","author":"Patrick","description":"Problem, when you start something like\n\n```\n/usr/lib/msgcollector/msgdispatcher_dispatch_x info \"test title\" \"test msg\" 1 \"\"\n```\n\nfrom terminal, you cannot terminate using ctrl + c. This makes it difficult for calling scripts to terminate them (in case those would receive a signal themselves) and then that process could either hang or stay open. Not critical, but an issue we can fix.\n\nTo find them.\n```\ngrep -r \\#\\!/usr/bin/python *\n```\n\nWhat do do... I suggest this.\n\n* on sigterm -> \"Signal sigterm received! Exiting.\" -> exit 143\n* on sigint (ctrl + c) -> \"Signal sigint received! Exiting.\" -> exit 130\n\nIdeally we have some small code snippet that we can easily reuse and copy and paste into all the scripts.","comments":[{"author":"Patrick","date_created":1422311132,"date_modified":1422311132,"content":"Ideally, we could set up one global signal trap per script. In most cases we don't need any cleanup code. Or? By \"global signal trap\", I mean just to set it up once at the very top. Not below in every function and loop and so forth.\n\nI failed to setup a working global trap for the Qt script. Maybe you have any ideas, @troubadour?"},{"author":"troubadour","date_created":1422403651,"date_modified":1422403651,"content":"We could put this at the top of every script.\n```#!/usr/bin/python\n\nimport signal\nimport os, sys\nimport time\n\nf_name = os.path.basename(__file__) + '.pid'\nf = open(f_name, 'w')\nf.write(str(os.getpid()) + '\\n')\nf.close()\n\ndef receive_signal(signum, signal):\n    #print signum\n    if signum == 15:    # SIGTERM\n        sys.exit(143)\n    elif signum == 2:   # SIGINT\n        sys.exit(130)\n\nsignal.signal(signal.SIGTERM, receive_signal)\nsignal.signal(signal.SIGINT, receive_signal)\n\n# for testing\nwhile True:\n    print 'Waiting...'\n    time.sleep(5)\n\n```\nA bash script (!!) for testing (implies that both scripts are in the same directory).\n```#!/bin/bash\n\npid=$(cat kill_signal.pid)\nkill -SIGINT $pid  # replace with any signal\n```\n\nBut that is may be overkill for the graphical scripts (Qt). A more typical use is with daemons.\n"},{"author":"troubadour","date_created":1422437752,"date_modified":1422437752,"content":"The above does not work once the Qt event handler loop is running. There is a hack for SIGINT (Ctrl+C), when the script is run from command line. Two lines at the very beginning of the script.\n ```#!/usr/bin/python\n# -*- coding: utf-8 -*-\nimport signal\nsignal.signal(signal.SIGINT, signal.SIG_DFL)\n```\nDon't know if it allows custom traps.\nTested with `generic_gui_message`, `msgdispatcher_dispatch_x`and `whonix-setup-wizard`"},{"author":"Patrick","date_created":1422518998,"date_modified":1422518998,"content":"Let's find some small code easy solution for the simple non-QT command line tools and then worry about the QT tools later?\n\nTried your above code. It works when using the sleep testing code. But it doesn't work when connection really hangs (such as tor bootstrap).\n\nTest case, theoretical, bad firewall rules. Practical simulation, on the gateway: Put `exit 0` below `iptables -t mangle -X` in `/usr/bin/whonix_firewall`, then reload it, `sudo whonix_firewall.`.\n\nOn the workstation, see the following test script.\n\n```\n#/bin/bash\nset -x\n/usr/lib/anon-shared-helper-scripts/tor_bootstrap_check.py 127.0.0.1 9151 0 &\npid=\"$!\"\nsleep 1\nkill -sigterm \"$pid\"\nwait \"$pid\"\ntrue \"exit code: $?\"\n```\n\nOutput:\n\n```\n++ pid=30266\n++ sleep 1\n++ /usr/lib/anon-shared-helper-scripts/tor_bootstrap_check.py 127.0.0.1 9151 0\n++ kill -sigterm 30266\n++ wait 30266\n```\n\n(The `sleep 1` is used to interrupt python during the connection phase, not very early during initialization where sigterm does still function. The `wait` indicates, that the process is still running, even though signal sigterm was sent.)\n"},{"author":"hqi","date_created":1441239317,"date_modified":1441239317,"content":"I tried this command:\n/usr/lib/msgcollector/msgdispatcher_dispatch_x\nand found the output is like this: \nuser@host:~$ /usr/lib/msgcollector/msgdispatcher_dispatch_x \nTraceback (most recent call last):\n  File \"/usr/lib/msgcollector/msgdispatcher_dispatch_x\", line 91, in <module>\n    if str(sys.argv[1]) == \"info\":\nIndexError: list index out of range\n\nSo I added some code between '#---' to avoid it:\nif __name__ == \"__main__\":\n    import sys\n#-------------------------------------------------\n    if len(sys.argv) == 1:\n        sys.exit(\"'msgdispatcher_dispatch_x'. There is no option\")\n#-------------------------------------------------\n    app = QtGui.QApplication(sys.argv)\n    Dialog = QtGui.QDialog()\n"},{"author":"Patrick","date_created":1441281095,"date_modified":1441281095,"content":"Try this.\n\n```\n/usr/lib/msgcollector/msgdispatcher_dispatch_x \"info\" \"test title\" \"test msg\" 0 \"/path/to/optional/icon\"\n```\n"},{"author":"hqi","date_created":1441291558,"date_modified":1441291558,"content":"there is no problem with options, but I think we may need to cover the scenario if there is no opton"},{"author":"Patrick","date_created":1441292009,"date_modified":1441292009,"content":"Yes.\n\nPlease provide a git branch implementing this. Or a github pull request.\n\ngithub repository location:\n\nhttps://github.com/Whonix/msgcollector\n\nhttps://github.com/Whonix/msgcollector/blob/master/usr/lib/msgcollector/msgdispatcher_dispatch_x"},{"author":"hqi","date_created":1441322158,"date_modified":1441322158,"content":"So any better error message can be put ?\n\"sys.exit(\"'msgdispatcher_dispatch_x'. There is no option\")\"\n"},{"author":"Patrick","date_created":1441322236,"date_modified":1441322236,"content":"Exit non-zero, write to stderr and explain the syntax."},{"author":"joysn1980","date_created":1484653033,"date_modified":1484653033,"content":"https://github.com/joysn/msgcollector/blob/master/usr/lib/msgcollector/msgdispatcher_dispatch_x\n\nIs this what is required here?\n\n\nError message for incorrect # of arguments\n\n'msgdispatcher_dispatch_x'. Invalid number of options \nmsgdispatcher_dispatch_x requires 4 manadatory and 1 optional arguments\n    1) Message Type = info|warning|error\n    2) Title of the message box\n    3) Message in the message box\n    4) Position of the message (Value 0 or more)\n    5) Icon to be used (optional)\n\nWorking commands\n/usr/lib/msgcollector/msgdispatcher_dispatch_x \"info\" \"test title\" \"test msg\" 0 \nusr/lib/msgcollector/msgdispatcher_dispatch_x \"info\" \"test title\" \"test msg\" 0 \"/path/to/optional/icon\"\n\nIf there are lesser arguments, we will see the error."},{"author":"Patrick","date_created":1484654121,"date_modified":1484654121,"content":"No. However, that's good to have.\n\nWhat is missing here... When you run:\n\n    /usr/lib/msgcollector/msgdispatcher_dispatch_x info \"test title\" \"test msg\" 1 \"\"\n\nAnd then press `ctrl + c` or `ctrl + d`, nothing happens. The sigterm / sigint signal is ignored. The wanted behavior is to exit.\n\n* on sigterm -> \"Signal sigterm received! Exiting.\" -> exit 143\n* on sigint (ctrl + c) -> \"Signal sigint received! Exiting.\" -> exit 130\n"},{"author":"joysn1980","date_created":1484658557,"date_modified":1484658557,"content":"With couple of more lines made ctrl+c to work. Can you verify please?\n\nhttps://github.com/joysn/msgcollector/commits/master/usr/lib/msgcollector/msgdispatcher_dispatch_x"},{"author":"Patrick","date_created":1484665719,"date_modified":1484665719,"content":"Yes, awesome! Works for me. Merged."},{"author":"joysn1980","date_created":1484666331,"date_modified":1484666349,"content":"Is this task about doing this for all python scripts?\n\nThere 4 more in this directory\n\nbr_add:#!/usr/bin/python\ngeneric_gui_message:#!/usr/bin/python\nstriphtml:#!/usr/bin/python\ntb_updater_gui:#!/usr/bin/python\n\nAre all these standalone python scripts? Are all these needs to be modified to have same changes - ctrl+c ?"},{"author":"Patrick","date_created":1484667414,"date_modified":1484667414,"content":"Right. (ctrl+c as well as ctrl+d)"},{"author":"Patrick","date_created":1484667710,"date_modified":1484667710,"content":"A few more projects are involved, where this is TODO. Btw there are all our components where #python is involved.\n\nSome of them (perhaps #sdwdate and #control-port-filter-python) might already have proper signal handling."},{"author":"joysn1980","date_created":1484726767,"date_modified":1484726840,"content":"br_add - nothing to add\nstriphtml nothing to add\ngeneric_gui_message - done\ntb_updater_gui - done\n\nhttps://github.com/joysn/msgcollector/tree/master/usr/lib/msgcollector\n\ntested using\n./generic_gui_message \"info\" \"hi\" \"hi\" 1 2\n./tb_updater_gui \"info\" \"hi\" 1 2 \"hi\" \"hi\" \"hi\"\n\nThis is all for msgcollector"},{"author":"joysn1980","date_created":1484727417,"date_modified":1484727417,"content":"From sdwdate-gui \n\nhttps://github.com/joysn/sdwdate-gui\n/usr/bin/sdwdate-gui - changes made\ntested using - ./sdwdate-gui\n/usr/lib/sdwdate-gui/show_message - no change required\ntested using ./show_message \"hi\" \"1\" \"3\""},{"author":"joysn1980","date_created":1484729074,"date_modified":1484729074,"content":"From guimessages - 1 change required and it done\nhttps://github.com/joysn/python-guimessages\n\n/usr/share/pyshared/guimessages/guimessage.py - changes done\n/usr/share/pyshared/guimessages/translations.py - no change required\n\n\nFrom anon-shared-helper-scripts - no change required\n/usr/lib/anon-shared-helper-scripts/tor_circuit_established_check.py - no change required\n/usr/lib/anon-shared-helper-scripts/tor_circuit_established_check.py - no change required\n/usr/lib/anon-shared-helper-scripts/tor_circuit_established_check.py - no change required\n"},{"author":"joysn1980","date_created":1484729204,"date_modified":1484731697,"content":"**So we are done with**\n\n\n```\nmsgcollector - to be merged\nsdwdate-gui - to be merged\npython-guimessages - to be merged\n```\n\n**No changes required for**\n\n```\nsdwdate\ntor-controlport-filter\nanon-shared-helper-scripts\n```\n\nLet me know if there any places which still requires the changes, I can make them\n"},{"author":"joysn1980","date_created":1484731595,"date_modified":1484731722,"content":"whonix-setup-wizard, 1 change required, to be merged\n\nThis was left I guess\nhttps://github.com/joysn/whonix-setup-wizard\n\n/usr/bin/whonix-setup-wizard - changes done\n\n\n**Summary**\n\n\n\n> msgcollector - to be merged\n> sdwdate-gui - to be merged\n> python-guimessages - to be merged\n> whonix-setup-wizard - to be merged\n\n\n"},{"author":"Patrick","date_created":1484739703,"date_modified":1484739703,"content":"Excellent! All merged."}]},"PHID-TASK-ktydvmvzvflsymyvtxup":{"id":"116","title":"document how to use TBB as \"system Tor\" inside Whonix-Gateway","status":"invalid","priority":"Normal","author":"JasonJAyalaP","description":"Until we are done with a full integration, i.e. the similar `make TBB usable as \"system Tor\"` (T118) task, we might leave this a \"user can do this itself\" thing.\n\nTODO:\ndocument how to use TBB as \"system Tor\" inside Whonix-Gateway\n\nhttps://www.whonix.org/wiki/Bridges#Using_Tor_.2F_Pluggable_Transports_from_the_Tor_Browser_Bundle","comments":[{"author":"Patrick","date_created":1439034988,"date_modified":1439034988,"content":"Significant progress has been made:\n[Using Tor / Pluggable Transports from the Tor Browser Bundle](https://www.whonix.org/wiki/Bridges#Using_Tor_.2F_Pluggable_Transports_from_the_Tor_Browser_Bundle)"},{"author":"Patrick","date_created":1483961277,"date_modified":1483961277,"content":"Calling this a duplicate of T118."}]},"PHID-TASK-frtkpwcepicpp3mpx2ez":{"id":"115","title":"add bash completion to Whonix apps","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"Would be great to have bash competition for most of Whonix's apps.\n\nTo find them, run in Whonix's source code folder.\n```\nfind . -type f | grep /usr/bin\n```\n\nMight be helpful:\nhttps://github.com/Whonix/Whonix/blob/9558183a870be6a4093b06d0c8af43248189a35e/bash_completion/whonix_shared/time_privacy","comments":[]},"PHID-TASK-k7j6lm6si5yenz4byylz":{"id":"114","title":"Permanent Takedown Attack Defender","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"Implement the [Permanent Takedown Attack Defender Proposal](https://www.whonix.org/wiki/Dev/Permanent_Takedown_Attack_Defender) into #whonixcheck.\n\nOr better. Upstream the whole thing; Create an emergency news notification mechanism including a Permanent Takedown Attack Defender implementation that Debian would adapt.","comments":[{"author":"HulaHoop","date_created":1433481922,"date_modified":1433481922,"content":" **apt-listchanges**  and Whonix-News are similar?"},{"author":"Patrick","date_created":1433512361,"date_modified":1433512361,"content":"No."},{"author":"HulaHoop","date_created":1481904402,"date_modified":1481904402,"content":"Should I attempt to talk with Freenet devs and see if they will make the necessary changes so we can use it?"},{"author":"Patrick","date_created":1481905722,"date_modified":1481905722,"content":"Freenet does not work directly over Tor. Do you think they would change\nthat?"},{"author":"HulaHoop","date_created":1481907008,"date_modified":1481907008,"content":"Maybe if they see the potential to grow their userbase they may be convinced.\n\nDRAFT:\n\nHi. Whonix [0] dev here. \n\nWe are looking for a censorship-resistant and decentralized way to communicate notifications about critical situations [1] to our users and host the project metadata and files themselves to resist a Permanent Takedown Attack threat.[2] Freenet meets our needs perfectly but unfortunately as documented it cannot work over Tor. If this changes in the short term we will be able to ship it in our distro to a userbase of 15K users by conservative estimates.\n\nOther points:\n\n* pyFreenet is very convenient in communicating with Freenet with scripts. Is there a similar mechanism that we can use to customize node settings?\n\n* Before including pyFreenet we would need it to be signed by its respective dev so we can validate it before running anything of course.\n\n\n***\n[0] Whoix is an anonymous Debian based OS (whonix.org)\n\n[1] Apt CVE-2016-1252: During apt-get upgrading signature verification can be\ntricked resulting in arbitrary package installation, system compromise. We would have liked a way to notify users to avoid running apt entirely and instead the necessary manual steps to download/verify the patched binaries.\n\n[2] https://www.whonix.org/wiki/Dev/Permanent_Takedown_Attack_Defender"},{"author":"Patrick","date_created":1481908177,"date_modified":1481908177,"content":"Ready to go.\n\n(We'd also need something else very important: freenet entering packages.debian.org, otherwise, oh well... But can be communicated later.)"},{"author":"HulaHoop","date_created":1481912179,"date_modified":1481912179,"content":"Done. Added your point. \n\nhttps://emu.freenetproject.org/pipermail/devl/2016-December/039437.html"},{"author":"Patrick","date_created":1481914946,"date_modified":1481914946,"content":"Not some custom package repo. packages.debian.org\n\nNever mind, thanks for posting!"},{"author":"HulaHoop","date_created":1481930625,"date_modified":1481937191,"content":"Got a reply: https://emu.freenetproject.org/pipermail/devl/2016-December/039438.html\n\nMy response (Please make suggestions/necessary additions) :\n\n\n> There is a way to route connections over Tor, but it isn’t tested regularly and currently only works in friend-to-friend mode. For details see:\n\nWhile a neat workaround unfortunately its days are numbered. The upstream development of onioncat is dead and with the Tor project's upgrading of the Hidden Service crypto (within the upcoming year) onioncat will no longer function. We also don't want every user to run a Hidden Service by default since some deanonymization attacks become easier to do.\n\nI do not doubt Freenet's anonymity capabilities. You should be proud of the fact that you got the NSA's attention. However for this to work we need it to run for all our users out of the box and a number of them live behind state firewalls that block Freenet and Tor without bridges. So without a solution that is compatible with Tor, it won't be enough - an emergency notification system is of little use if it works for some users some of the time.\n\nAnother point is that even in \"free\" societies the police are convincing the courts to give them warrants with fraudulent data to raid people running Freenet. A couple of high coverage arrests are enough to scare away a number of people. While running nodes over Tor with TCP support is not optimal for Freenet network performance it is still to your advantage than not having those nodes run at all IMHO.\n\nI am not conceited to assume that your priorities are planned around our wishlist. I also understand that building an alternative transport is a major task. If it wasn't for this obstacle we could immediately use Freenet for our purposes. Thank you for the work you have put into creating a better internet.\n\n>Also you can modify the configuration from pyFreenet but I did not test that in a long time:\n\nGood to know. Thanks.\n\n> auto-spawning currently downloads Freenet over the internet, though. Doing this download over Tor shouldn’t be hard. In fact it just requires setting the proxy:\n\nIs that when updating Freenet?\n\n>I’m the current maintainer. Do you need gpg signed git revisions or tags, signed release tarballs or signed Mercurial commits?\n\nSigned tarballs should do it.\n\n>Tell me how I can easily integrate that into my release process and I can do that.\n\n[This is the part where Patrick shares his packaging expertise]\n\n>pyFreenet consist purely of Python packages, without need of compilation steps.\n\nI understand. We can't rely on pip because it lacks GPG support. Please also consider providing Freenet in signed .deb form so we can easily provide that package via our repos.\n\n"},{"author":"Patrick","date_created":1481937235,"date_modified":1481937235,"content":">>! In T114#11035, @HulaHoop wrote:\n> Got a reply: https://emu.freenetproject.org/pipermail/devl/2016-December/039438.html\n> \n> My response (Please make suggestions/necessary additions) :\n> \n> \n>> There is a way to route connections over Tor, but it isn’t tested regularly and currently only works in friend-to-friend mode. For details see:\n> \n> While a neat workaround unfortunately its days are numbered. The upstream development of onioncat is dead and with the Tor project's upgrading of the Hidden Service crypto (within the upcoming year) onioncat will no longer function. We also don't want every user to run a Hidden Service by default since some deanonymization attacks become easier to do.\n\nAlthough I could not read his link (no freenet running), but I guess this is valid since onionshare deprecated, everyone running hidden service deal breaker indeed.\n\n\"Ideally\" we need Freenet in open mode over Tor so it just works. Otherwise if infrastructure maintenance is required it could take a very long time until we get there.\n\n> I do not doubt Freenet's anonymity capabilities. You should be proud of the fact that you got the NSA's attention. However for this to work we need it to run for all our users out of the box and a number of them live behind state firewalls that block Freenet and Tor without bridges. So without a solution that is compatible with Tor, it won't be enough - an emergency notification system is of little use if it works for some users some of the time.\n\nYes.\n\n> Another point is that even in \"free\" societies the police are convincing the courts to give them warrants with fraudulent data to raid people running Freenet. A couple of high coverage arrests are enough to scare away a number of people. While running nodes over Tor with TCP support is not optimal for Freenet network performance it is still to your advantage than not having those nodes run at all IMHO.\n\nMaybe make the last sentence a question instead.\n\n>>Also you can modify the configuration from pyFreenet but I did not test that in a long time:\n> \n> Good to know. Thanks.\n\n\n>> auto-spawning currently downloads Freenet over the internet, though. Doing this download over Tor shouldn’t be hard. In fact it just requires setting the proxy:\n> \n> Is that when updating Freenet?\n\nGood question.\n\n>>I’m the current maintainer. Do you need gpg signed git revisions or tags, signed release tarballs or signed Mercurial commits?\n> \n> Signed tarballs should do it.\n\nWe need a signed deb.\n\n>>Tell me how I can easily integrate that into my release process and I can do that.\n> \n> [This is the part where Patrick shares his packaging expertise]\n\nWell, not something I can do in 5 minutes.\n\nreprepro - https://mirrorer.alioth.debian.org/\n\nWorks really nice and really nice upstream that can be contacted by mail.\n\n\"If you have problems and/or suggestions, just write me an email. (You can read the FAQ first if you fear to ask a stupid question, but I really get few enough mails that some more will not harm).\"\n\nCan be be scripted. Once Debian packaging is done - not easy - I never packages anything-java - I can certainly help with write some bash scripts to automate reprepro debian repository creation.\n\nThe bigger blocker for now is getting freenet to work in \"easy\" mode, i.e. in open mode directly over Tor. Also other modes where we need to set up infrastructure may be doable - one day. Or modes where freenet runs in parallel to Tor on the gateway (probably hard and a lot to think about, bridges, liabilities and whatnot). The \"harder\" mode just make the implementation of this ticket even less realistic anytime soon - unless someone takes the lead on this one.\n\n>>pyFreenet consist purely of Python packages, without need of compilation steps.\n> \n> I understand. We can't rely on pip because it lacks GPG support. Please also consider providing Freenet in signed .deb form so we can easily provide that package via our repos.\n\nYes."},{"author":"HulaHoop","date_created":1481947947,"date_modified":1481947947,"content":"Sent. https://emu.freenetproject.org/pipermail/devl/2016-December/039440.html\n\n>Although I could not read his link (no freenet running), but I guess this is valid since onionshare deprecated, everyone running hidden service deal breaker indeed.\n\nIts a mirror of this post:\n\nhttps://bluishcoder.co.nz/2016/08/18/using-freenet-over-tor.html\n\nAnd since it depends on onioncat its not a solution. Neither does the suggestion to roll our own infrastructure since that too depends on onioncat and running everyone as a HS - both a no go."},{"author":"HulaHoop","date_created":1482023929,"date_modified":1482023929,"content":"\nUpdates:\nhttps://emu.freenetproject.org/pipermail/devl/2016-December/039451.html\nhttps://emu.freenetproject.org/pipermail/devl/2016-December/039452.html\n\nNot happening anytime soon. Though I decided to discuss FreenetBox and see if its possible with the way Freenet works.\n"},{"author":"HulaHoop","date_created":1482025755,"date_modified":1482025755,"content":"Huzzah. Unto the GNUnet. Could be our ace in the hole.\n\nAdvantages:\n\n* Packaged in Debian\n* Clean/extremely modular design\n* Been around forever (since 2001)\n* Co-op between some of their devs and TPO's\n* A hybrid protocol that supports both stream communication (like Tor) and shifting data blocks around.\n* A large selection of [[ https://gnunet.org/transport-service | transports ]]: TCP, UDP, HTTP, HTTPS, heck even Bluetooth\n\n\nI'm planning a mail for the GNUnet [[ https://gnunet.org/contact_information | list ]]. As usual add any points you care about.\n\n\nDRAFT:\n\nHi. I am a Whonix [0] developer.\n\nWe are looking for a decentralized and censorship-resistant storage network to communicate notifications about critical situations [1] to our users and host the project metadata and files themselves to resist a Permanent Takedown Attack.[2]\n\nGNUnet seems a perfect match for our purposes. I have some questions:\n\n* Is the GNUnet version in stable current enough to connect with the live network or is it usually obsolete because of stable's freeze policy? (I haven't been able to connect with it in Whonix yet) If its the latter could you please consider running your own standalone repo?\n\n* We have approx. 15K users - are you okay with us adding such a number of users to your current network?\n\n* Since we are Tor based (and we need our notifications to reach users who live behind firewalls) we will be tunneling our GNUnet communications over Tor. Has anyone experimented with this so far with the TCP transports?\n\n* What tools can be used to customize GNUnet node settings via scripting in Bash/Python?\n\n\n***\n\n[0] Whonix is an anonymous Debian based OS (whonix.org) Some of you may know us from the Tor lists ;)\n\n[1] Apt CVE-2016-1252: During apt-get upgrading signature verification can be\ntricked resulting in arbitrary package installation, system compromise. We would have liked a way to notify users to avoid running apt entirely and instead the necessary manual steps to download/verify the patched binaries.\n\n[2] https://www.whonix.org/wiki/Dev/Permanent_Takedown_Attack_Defender"},{"author":"Patrick","date_created":1482067285,"date_modified":1482067285,"content":"re freenet reprepro\n\n    sudo apt-get install reprepro yelp\n    yelp man:reprepro\n\n----\n\n> * Is the GNUnet version in Debian stable (currently: jessie) current enough to connect with the GNUnet live network or is it usually obsolete because of Debian's stable freeze policy?\n\n^ modified that sentence a bit.\n\n> I haven't been able to connect GNUnet over Tor in Whonix yet (user -> Tor -> GNUnet). Did anyone manage to run GNUnet over Tor using the TCP based transports?\n\n^ modified that sentence a bit.\n\nOtherwise ready to go.\n\n-----\n\nNice overview on anonymous p2p and similar (it was nice when I compared them like 4 years ago):\nhttps://www.planetpeer.de/wiki/index.php/Main_Page"},{"author":"HulaHoop","date_created":1482078860,"date_modified":1482078860,"content":"Posted:\n\nhttps://lists.gnu.org/archive/html/gnunet-developers/2016-12/msg00032.html\n\n***\n\n>Nice overview on anonymous p2p and similar\n\n+1 Where should we add it?"},{"author":"HulaHoop","date_created":1482083427,"date_modified":1482083427,"content":"Got a reply by project lead Christian Grothoff:\n\nhttps://lists.gnu.org/archive/html/gnunet-developers/2016-12/msg00033.html"},{"author":"Patrick","date_created":1482095000,"date_modified":1482095000,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>   Posted:\n>   \n>   https://lists.gnu.org/archive/html/gnunet-developers/2016-12/msg00032.html\n\nVery good!\n\n>   ***\n>   \n>   > Nice overview on anonymous p2p and similar\n>   \n>   +1 Where should we add it?\n\nDunno. Perhaps https://www.whonix.org/wiki/File_Sharing?\n\n> \n>   Got a reply by project lead Christian Grothoff:\n>   \n>   https://lists.gnu.org/archive/html/gnunet-developers/2016-12/msg00033.html\n\nHm. Friendly reply, looks like not ready for prime time. Looking forward\nto a stable release."},{"author":"HulaHoop","date_created":1482109606,"date_modified":1482109606,"content":"My reply: https://lists.gnu.org/archive/html/gnunet-developers/2016-12/msg00034.html\n\nI suggested that we'll look at torservers hosting some GNUnet nodes at some point. Do you want to contact them? Work on a draft for this in this ticket?\n\n>Hm. Friendly reply, looks like not ready for prime time. Looking forward to a stable release.\n\n+1\n\n>Dunno. Perhaps https://www.whonix.org/wiki/File_Sharing?\n\nNo that page seems more about torrenting over Tor than anything else. I'll tack it on the Freenet intro."},{"author":"HulaHoop","date_created":1482323464,"date_modified":1482323464,"content":"Got another reply: https://lists.gnu.org/archive/html/gnunet-developers/2016-12/msg00035.html\n\nTurns out that Carlo tested running Tor thru a GNUnet exit  with good results (yes its not a closed network). In principle we do not need dedicated GNUnet nodes for this to work but it would be helpful for their network. \n\nTalked with Moritz and they are open to running nodes and have looked at doing so before but they need more recent versions released in packaged form.\n\n"},{"author":"HulaHoop","date_created":1482591558,"date_modified":1482591558,"content":"Debian ticket:\nhttps://bugs.debian.org/849236\n849236@bugs.debian.org"},{"author":"HulaHoop","date_created":1482847709,"date_modified":1482847709,"content":"Ticket reply:\n\nhttps://bugs.debian.org/849236#10\n\nNo he won't being doing it. Was worth a try."},{"author":"HulaHoop","date_created":1483917198,"date_modified":1483917198,"content":"GNU Guix RFP for more recent GNUnet versions:\n\nhttps://bugs.debian.org/850644"},{"author":"HulaHoop","date_created":1519695224,"date_modified":1519695384,"content":"Whonix project metadata could be distributed using Tahoe-LAFS - a redundant, encrypted storage array accessible over Tor. Instructions to users about alternative download mechanisms of the project's code and documentation can be passed thru this channel.\n\n*Tahoe-LAFS runs a public grid for testing. The latest introducer is listed on their IRC channel which you would point Tahoe clients to.\n\n*Tahoe-LAFS is packaged in Debian and includes support for running over Tor cleanly.\n\n*Whonixcheck would need to be changed to poll Tahoe shares for updates and display the emergency warning it fetches to users.\n\n*Alternative distribution of project files includes and is not limited to: regular torrent magnet links or I2P Snark (I2P's torrenting application)\n\nCompleting this task satisfies this ticket."},{"author":"HulaHoop","date_created":1519752847,"date_modified":1519752847,"content":"\nAsked the devs some questions about integration:\n\nhttps://tahoe-lafs.org/pipermail/tahoe-dev/2018-February/009902.html"},{"author":"HulaHoop","date_created":1519841875,"date_modified":1519841875,"content":"*Most recet info on test grid can be found from their freenode IRC channel\n\n* As far as configuration goes, there is no config.d and there is work to improve config file abstraction. As far as the current way to do things:\n\n\n\n\n> The main file is named “tahoe.cfg”, and is an “.INI”-style configuration file (parsed by the Python stdlib ConfigParser module: “[name]” section markers, lines with “key.subkey: value”, RFC822-style continuations). There are also other files containing information that does not easily fit into this format. The “tahoe create-node” or “tahoe create-client” command will create an initial tahoe.cfg file for you. After creation, the node will never modify the tahoe.cfg file: all persistent state is put in other files.\n\n\n\nhttps://tahoe-lafs.readthedocs.io/en/latest/configuration.html"},{"author":"HulaHoop","date_created":1525012784,"date_modified":1525012784,"content":"The public tahoeLAFS introducer is dormant:\nhttps://tahoe-lafs.org/pipermail/tahoe-dev/2018-April/009913.html\n\nAn alternative is to use I2P's grid instead but only in the event that whonix news messages stop for some reason. Here's how this can be implemented:\n\n1. 2 types of whonixnews messages: one normal the other, a silent \"ping\" type.\n\n2. If the local news daemon does not receive a ping within say 30 days then it would activate I2P/tahoe and check for updates at a preset address.\n\n"}]},"PHID-TASK-z5iswx64xcfcrjjs72ic":{"id":"113","title":"Install Icedove (Thunderbird) + TorBirdy + Enigmail","status":"resolved","priority":"High","author":"JasonJAyalaP","description":"migrated from:\nhttps://github.com/Whonix/Whonix/issues/17\n\n-----\n\ninstall:\n\n- https://packages.debian.org/jessie/icedove\n- https://packages.debian.org/jessie/xul-ext-torbirdy\n- https://packages.debian.org/jessie/enigmail\n\n-----\n\nupdate documentation for next Whonix version: \nhttps://www.whonix.org/wiki/E-Mail#Mozilla_Thunderbird_with_TorBirdy\n","comments":[{"author":"HulaHoop","date_created":1432339629,"date_modified":1432339629,"content":"Ticket addition: include enigmail package from Debian repos with IceDove."},{"author":"Patrick","date_created":1432387172,"date_modified":1432387172,"content":"`sudo apt-get install icedove xul-ext-torbirdy enigmail` requires __92.4 MB__ of additional disk space. Still worth it?"},{"author":"HulaHoop","date_created":1432390306,"date_modified":1432390509,"content":"Email is a basic activity that we should provide a secure answer for. However I can see how a growing image size isn't good for Whonix infrastructure.\n\nHow about introducing install scripts that fetch packages optionally and configure them as needed?  Its like tbb-launcher except the distribution and verification is all handled by apt. Icedove doesn't need configuration of safe defaults but electrum would. Uninstalling would be manual and not covered by scripts . \n\nThat way we can give people secure defaults while not bloating up the image to cover every use case under the sun.\n\nHow we present these scripts is another thing:\n\n Will they be icons that run the script like tbb? Not a solution because desktop clutter.\n\nHow about a folder on the desktop with the install scripts inside and a way to run them be double clicking - no terminal needed? The script names would be straightforward for example this one is called \"Email\" and so on."},{"author":"HulaHoop","date_created":1432392001,"date_modified":1432392001,"content":"\nFor example let's say electrum creates a folder under the user's home directory for its settings (like xchat). Can whonix ship with an artificially created folder containing the wrapper script or will it be overwritten when the user installs the program?\n\nIf its the latter, the install script will need to move the wrapper script into the program's directory from another location, after the install is done.\n\n\n"},{"author":"Patrick","date_created":1432398725,"date_modified":1432398725,"content":"install scripts:\nProbably not. apt-get automation is very difficult due to issues introduced at a higher levels. More info:\nhttps://www.whonix.org/wiki/Dev/Automatic_Updates\n\nelectrum:\nhttps://phabricator.whonix.org/T215#3208\n"},{"author":"HulaHoop","date_created":1432428858,"date_modified":1432428858,"content":"FAI is a flexible framework for unattended Debian installs but can be used for much more including automatic package installs. Its a decade old and robust, used for massive Debian deployments. Each feature can be used alone. \n\nThe idea here is to tell FAI the packages we want and it handles apt completely. Seems to get around the problems of talking to apt directly. What do you think?\n\nhttps://wiki.debian.org/FAI\n\nhttp://fai-project.org/fai-guide/_anchor_id_config_xreflabel_config_installation_details.html#packageconfig"},{"author":"Patrick","date_created":1432442170,"date_modified":1432442170,"content":"It's a different category of tool. More like in the category as grml-debootstrap. A handy tool for sysadmins. Not so much for distributions. Not for install scripts after the system has already been installed."},{"author":"HulaHoop","date_created":1433550317,"date_modified":1433550317,"content":"I'm happy with the documentation. You can close this if you want."},{"author":"Patrick","date_created":1433557489,"date_modified":1433557489,"content":"I am not happy with documentation yet.\n\nIf you read the help for Convenient Encryption (help button next to this button), it sounds pretty insecure. I am not opposed to anyone using gpg like this in a causal not so caring way, but it's not something to encourage in a security guide. Also 'confirm before sending', 'Always' should stay recommended for serious usage.\n\nAlso, we're not jessie based yet (therefore install from Debian repository unfortunately not yet possible), Whonix 11 stable not out yet."},{"author":"HulaHoop","date_created":1433602918,"date_modified":1433602918,"content":"\n>  Also 'confirm before sending', 'Always' should stay recommended for serious usage.\n\nI don't see this option in Enigmail the menus have changed since the instructions were made and so I thought this obsolete option became Convenient Encryption.\n\n> Also, we're not jessie based yet (therefore install from Debian repository unfortunately not yet possible), Whonix 11 stable not out yet.\n\nPlease change them to Jessie instructions whenever you release stable."},{"author":"Patrick","date_created":1433603205,"date_modified":1433603205,"content":">>! In T113#5304, @HulaHoop wrote:\n> \n>>  Also 'confirm before sending', 'Always' should stay recommended for serious usage.\n> \n> I don't see this option in Enigmail the menus have changed since the instructions were made and so I thought this obsolete option became Convenient Encryption.\n\nSee this screenshot:\n{F79}\n\nThese settings should do."},{"author":"HulaHoop","date_created":1435515296,"date_modified":1435515296,"content":"If you decided to integrate Icedove in Whonix can you please set it to open links in messages from Tor Browser?\n"},{"author":"Patrick","date_created":1435533565,"date_modified":1435533565,"content":"You mean\n1) open icedove\n2) see some link\n3) click the link\n4) opens the link in Tor Browser\n?\n\nWe're already doing this.\n\nImplemented by:\nhttps://github.com/Whonix/tb-default-browser\n\nThere is just a related apparmor question:\nhttps://www.whonix.org/forum/index.php/topic,97.msg8765.html#msg8765\n"},{"author":"HulaHoop","date_created":1435535167,"date_modified":1435535167,"content":">You mean\n>\n>   open icedove\n>   see some link\n>   click the link\n>   opens the link in Tor Browser\n\n\nYeah. \n\nGood stuff, thanks"},{"author":"Patrick","date_created":1438023256,"date_modified":1438023256,"content":"`Install Icedove (Thunderbird) + TorBirdy + Enigmail, added icedove, enigmail and xul-ext-torbirdy to anon-workstation-packages-recommended - https://phabricator.whonix.org/T113`:\nhttps://github.com/Whonix/anon-meta-packages/commit/33c41008270345b8f780e0a4afaf35afde8ec56d\n"}]},"PHID-TASK-iuj5kstg225ckrdqlrhz":{"id":"112","title":"fix whonix-ws-firewall","status":"resolved","priority":"Normal","author":"Patrick","description":"See forum thread:\nhttps://www.whonix.org/forum/index.php/topic,834.0.html","comments":[{"author":"Patrick","date_created":1422299605,"date_modified":1422299605,"content":"Fixed:\nhttps://www.whonix.org/forum/index.php/topic,834.msg6723.html#msg6723"},{"author":"Patrick","date_created":1423017754,"date_modified":1423017754,"content":"Same issue happening again.\n\n```\ntime /usr/lib/anon-shared-helper-scripts/tor_bootstrap_check.py 127.0.0.1 9151 0\n```\n\nStill needs ~ 10 seconds.\n\nUnless the following rule is removed.\n\n```\niptables -A INPUT -j REJECT --reject-with icmp-port-unreachable\n```\n\nSo some input rule must be missing."},{"author":"Patrick","date_created":1423018498,"date_modified":1423018498,"content":"Cause is a package being blocked. From Whonix-Workstation `/var/log/kern.log`:\n\n```\nWhonix blocked input4: IN=eth0 OUT= MAC=redacted SRC=10.152.152.10 DST=10.152.152.11 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=redacted DF PROTO=TCP SPT=34628 DPT=113 WINDOW=14600 RES=0x00 SYN URGP=0\n```\n\nNo idea why python-stem (or any of its dependencies) needs to do that."},{"author":"Patrick","date_created":1423018701,"date_modified":1423018701,"content":"Adding\n\n```\niptables -A INPUT -p tcp --dport 113 -j ACCEPT\n```\n\nabove\n\n```\niptables -A INPUT -j REJECT --reject-with icmp-port-unreachable\n```\n\nfixes it. But I don't like to fix it by opening that port. A better solution is desired."},{"author":"Patrick","date_created":1423019375,"date_modified":1423019375,"content":"Adding\n\n```\niptables -A INPUT -p tcp -j REJECT --reject-with tcp-reset\n```\n\nabove\n\n```\niptables -A INPUT -j REJECT --reject-with icmp-port-unreachable\n```\ndoes the trick."},{"author":"Patrick","date_created":1423019822,"date_modified":1423019822,"content":"Fixed:\nhttps://github.com/Whonix/whonix-ws-firewall/commit/1ac1b6649ef973ce25a12358dbf6e0714dc22f1a"},{"author":"Patrick","date_created":1423019998,"date_modified":1423019998,"content":"fixed, undo:\n    Disable for now, until someone researches this further, because causing issues...\n    iptables -A OUTPUT ! -p tcp -j REJECT --reject-with icmp-port-unreachable\n    Very low priority. See also:\n    https://www.whonix.org/forum/index.php/topic,834\n    https://phabricator.whonix.org/T112\n"}]},"PHID-TASK-pqo5itlz3feh2anpge4k":{"id":"111","title":"whonix-ws-firewall outgoing rule simplification","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/whonix-ws-firewall/blob/master/usr/bin/whonix_firewall\n\n```\niptables -A OUTPUT -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT\n```\n\nSince we're blocking invalid outgoing packages above already anyhow and since there are no other states besides these 4, we can also drop the whole `-m state --state NEW,ESTABLISHED,RELATED`.\n\n`sudo iptables --list` shows no differences. Save to do.","comments":[{"author":"Patrick","date_created":1422298174,"date_modified":1422298174,"content":"Done:\nhttps://github.com/Whonix/whonix-ws-firewall/commit/56896122da6e751ef01bec4ecc6a598d4c271301"}]},"PHID-TASK-alt3sgtg52cozbnysu2p":{"id":"110","title":"better support for TBB / TPO software downloaders","status":"resolved","priority":"Normal","author":"Patrick","description":"Posted loads of feature requests...\n\nbetter support for TBB / TPO software downloaders:\nhttps://trac.torproject.org/projects/tor/ticket/14386\n\nfinalize RecommendedTBBVersions format:\nhttps://trac.torproject.org/projects/tor/ticket/14383\n\nhave a permanent link to RecommendedTBBVersions:\nhttps://trac.torproject.org/projects/tor/ticket/14384\n\nuse a download similar folder layout as TBB:\nhttps://trac.torproject.org/projects/tor/ticket/14385\n\nConsider adding yourself to cc at torproject's trac if you wish to follow the discussions there.\n","comments":[]},"PHID-TASK-dwz5v7ho3lqzbet5prvj":{"id":"109","title":"support multiple internal interfaces","status":"resolved","priority":"Normal","author":"Patrick","description":"That would help hosting multiple Whonix-Workstations that are all using separate internal networks.\n\nFeature request describing the goal:\nhttps://www.whonix.org/forum/index.php/topic,918.0.html\n\nThis ticket is a feature request for one technical improvement to get closer to that goal.","comments":[{"author":"Patrick","date_created":1422247369,"date_modified":1422247369,"content":"Done:\nhttps://github.com/Whonix/whonix-gw-firewall/commit/917d69bd746eca05399341c1a2de61efefeb94c8"}]},"PHID-TASK-htqnbkksch2snrlcys2o":{"id":"108","title":"document gpg-bash-lib","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1422292368,"date_modified":1422292368,"content":"Done:\nhttps://github.com/Whonix/gpg-bash-lib"}]},"PHID-TASK-ygh6xxuyo7b34hjz6e2x":{"id":"107","title":"Tor Messenger Support","status":"resolved","priority":"Normal","author":"Patrick","description":"Will use...\n\n```\nSocksPort 9152\nControlPort 9153\n```\n","comments":[{"author":"Patrick","date_created":1422123660,"date_modified":1422123660,"content":"Work on Tor Messenger Support:\n\n* https://github.com/Whonix/anon-gw-anonymizer-config/commit/672b3e3430c09c53a3e53ca25d46e5530edbb7da\n* https://github.com/Whonix/anon-ws-disable-stacked-tor/commit/275f072b03510324c6e8cdf3556b1d1a83cc90ca\n* https://www.whonix.org/w/index.php?title=Stream_Isolation&diff=14639&oldid=14390\n"},{"author":"Patrick","date_created":1422125014,"date_modified":1422125014,"content":"Tor Messenger Release Announcement:\nhttps://lists.torproject.org/pipermail/tor-dev/2014-December/007981.html"},{"author":"Patrick","date_created":1422125865,"date_modified":1422125865,"content":"With these small changes, (technically only https://github.com/Whonix/anon-ws-disable-stacked-tor/commit/275f072b03510324c6e8cdf3556b1d1a83cc90ca matters) I managed to get Tor Messenger to establish an IRC connection."},{"author":"Patrick","date_created":1422126483,"date_modified":1422126483,"content":"Asked Sukhbir Singh a few questions by e-mail. Now waiting for an answer."},{"author":"Patrick","date_created":1422300007,"date_modified":1422300007,"content":"enable Stream Isolation:\nhttps://trac.torproject.org/projects/tor/ticket/14382"},{"author":"Patrick","date_created":1422300178,"date_modified":1422300178,"content":"Current Status:\nWhen manually downloading Tor Messenger in Whonix 10, it will work out of the box and without Tor over Tor.\n\n(Will work similar to Tor Browser and https://www.whonix.org/wiki/Manually_Updating_Tor_Browser when manually downloading it.)"},{"author":"Patrick","date_created":1422300261,"date_modified":1422300261,"content":"In future, when Tor Messenger is released as stable, then `tb-updater` can be transformed into `tpo-updater`. To make this possible, posted feature request.\n\nuse a download similar folder layout as TBB:\nhttps://trac.torproject.org/projects/tor/ticket/14385"},{"author":"Patrick","date_created":1423143246,"date_modified":1423143246,"content":"For now, there is nothing more than can be done here before Tor Messenger is released."},{"author":"Patrick","date_created":1447773555,"date_modified":1447773555,"content":"https://www.whonix.org/wiki/Chat#Tor_Messenger"}]},"PHID-TASK-uqxkdxdo2btly54y5m2j":{"id":"106","title":"port Whonix's init.d scripts to systemd","status":"resolved","priority":"High","author":"Patrick","description":"(To find them...)\n```\nfind . -type f | grep init.d\n```\n\nComments on roughly guessed difficulty.\n\n* ~~easy: ./packages/whonixcheck/etc/init.d/whonixcheck~~\n* ~~easy: ./packages/ksm/etc/init.d/ksm~~ (patches welcome) -> https://packages.debian.org/sid/ksmtuned\n* ~~hard: ./packages/sdwdate/etc/init.d/sdwdate~~\n* ~~hard: timesync~~\n* ~~medium: ./packages/swap-file-creator/etc/init.d/swap-file-creator~~\n* ~~easy: ./packages/msgcollector/etc/init.d/msgcollector~~\n* ~~medium: ./packages/vbox-disable-timesync/etc/init.d/vbox-disable-timesync (not ported to systemd, but made compatible, see below)~~\n* medium: ./anon-ws-disable-stacked-tor/etc/init.d/tor.anondist -> T303\n* ~~easy: ./packages/timesanitycheck/etc/init.d/timesanitycheck~~\n* ~~harder: ./packages/whonix-initializer/etc/init.d/whonix-initializer ([done](https://github.com/Whonix/whonix-initializer/blob/master/lib/systemd/system/whonix-initializer.service))~~\n* ~~easy: ./packages/bootclockrandomization/etc/init.d/bootclockrandomization~~\n* ~~unknown: https://github.com/troubadoour/control-port-filter-python in Whonix 10. (See also: https://git-tails.immerda.ch/tails/tree/config/chroot_local-includes/lib/systemd/system/tor-controlport-filter.service?h=feature/jessie): T274~~\n* ~~hard: rads: T57~~\n\nForum thread:\nhttps://www.whonix.org/forum/index.php/topic,707\n","comments":[{"author":"Patrick","date_created":1427986592,"date_modified":1427986592,"content":"https://github.com/Whonix/swap-file-creator/commit/cba4e22135737f2966766711bfb606c0f905a4c4"},{"author":"Patrick","date_created":1427989245,"date_modified":1427989245,"content":"I won't do create a systemd unit as replacement for `./packages/ksm/etc/init.d/ksm` myself, because the package does not get installed by default and because there is now https://packages.debian.org/sid/ksmtuned. Patches welcome. @HulaHoop"},{"author":"Patrick","date_created":1427990614,"date_modified":1427990614,"content":"control-port-filter-python - added systemd service:\nhttps://github.com/Whonix/control-port-filter-python/commit/d8e1d5711d2a71a9ab638c03e84a0d9b48d7ae48\nCould you review that systemd unit please, @nrgaway?\n"},{"author":"HulaHoop","date_created":1428101564,"date_modified":1428101564,"content":"May be helpful for systems configuration. Debian directory structure could be different:\n\nhttps://access.redhat.com/articles/754933\n\nPaths of the ksm/ksmtuned services on RHEL family:\n/usr/lib/systemd/system/ksmtuned.service \n/usr/lib/systemd/system/ksm.service \n\nIs adding this for ksmtuned a matter of emulating your commit?"},{"author":"Patrick","date_created":1428146020,"date_modified":1428146020,"content":"No."},{"author":"nrgaway","date_created":1429741846,"date_modified":1429741846,"content":">>! In T106#3482, @HulaHoop wrote:\n> May be helpful for systems configuration. Debian directory structure could be different:\n> \n> https://access.redhat.com/articles/754933\n> \n> Paths of the ksm/ksmtuned services on RHEL family:\n> /usr/lib/systemd/system/ksmtuned.service \n> /usr/lib/systemd/system/ksm.service \n> \n> Is adding this for ksmtuned a matter of emulating your commit?\n\nDebian systemd layout is same as fedora.\n\nIf you plan on overriding an upstream packages unit files, there are a few options:\n1. If you just adding a path or something, add a snippet\n2. place overridden unit file in /etc/system/systemd (This is wehre local modifications go).  If you are using another name than the original systemd file, add an `Alias` in the install section\n\n```\n[Install]\nWantedBy=multi-user.target\nAlias=qubes-network.service\n```\n\nThen you would need to disable and enable the service to take effect."},{"author":"Patrick","date_created":1429747882,"date_modified":1429747882,"content":"> add a snippet\n\nCan you please elaborate?"},{"author":"Patrick","date_created":1430055743,"date_modified":1430055743,"content":"@nrgaway?"},{"author":"Patrick","date_created":1430056019,"date_modified":1430056019,"content":"I am not sure if we should remove old sysvinit scripts from packages once systemd units are available. They don't conflict. And someone might wish to use/port the package on systems without systemd. Mailed Paul Wise from Debian what the best practice about this is."},{"author":"nrgaway","date_created":1430056330,"date_modified":1430056330,"content":">>! In T106#3814, @Patrick wrote:\n>> add a snippet\n> \n> Can you please elaborate?\n \nFrom [[ https://lwn.net/Articles/542609/ | https://lwn.net/Articles/542609/ ]]\n          Configuration of unit files may now be extended via drop-in\n          files without having to edit/override the unit files\n          themselves. More specifically, if the administrator wants to\n          change one value for a service file foobar.service he can\n          now do so by dropping in a configuration snippet into\n          /etc/systemd/systemd/foobar.service.d/*.conf. The unit logic\n          will load all these snippets and apply them on top of the\n          main unit configuration file, possibly extending or\n          overriding its settings. Using these drop-in snippets is\n          generally nicer than the two earlier options for changing\n          unit files locally: copying the files from\n          /usr/lib/systemd/system/ to /etc/systemd/system/ and editing\n          them there; or creating a new file in /etc/systemd/system/\n          that incorporates the original one via \".include\". Drop-in\n          snippets into these .d/ directories can be placed in any\n          directory systemd looks for units in, and the usual\n          overriding semantics between /usr/lib, /etc and /run apply\n          for them too.\n"},{"author":"Patrick","date_created":1430056511,"date_modified":1430056511,"content":"Great stuff. Needless to say I am a huge fan of drop-in snippets."},{"author":"nrgaway","date_created":1430056638,"date_modified":1430056638,"content":">>! In T106#3920, @Patrick wrote:\n> I am not sure if we should remove old sysvinit scripts from packages once systemd units are available. They don't conflict. And someone might wish to use/port the package on systems without systemd. Mailed Paul Wise from Debian what the best practice about this is.\n\nThey can confilct and it is a PITA to debug.  You can keep the sysv init scripts in your Debian package but don't install them.  I just went though that with `network-manager`; was wondering why 2 of them were popping up.\n\nAlso in order for a systemd unit file to override the sysv init one, you have to first disable it, then re-enable it and they should be both of the same name or you may need to set an alias"},{"author":"Patrick","date_created":1431527009,"date_modified":1431527009,"content":"whonixcheck:\nhttps://github.com/Whonix/whonixcheck/commit/c91dc77a1dae49be4635380e330fdfda9cb4ada2\n"},{"author":"Patrick","date_created":1431528108,"date_modified":1431528108,"content":"msgcollector:\nhttps://github.com/Whonix/msgcollector/commit/ff50e3c286fea6663f6d45906411177080f9a1bd"},{"author":"Patrick","date_created":1431546740,"date_modified":1431546740,"content":"bootclockrandomization:\nhttps://github.com/Whonix/bootclockrandomization/commit/77d3e620017dd067e1660e7bebf582f042484c47\n"},{"author":"Patrick","date_created":1431548760,"date_modified":1431548760,"content":"timesanitycheck:\nhttps://github.com/Whonix/timesanitycheck/commit/03640195a9c6b18ae1259b62a44994c32619add9"},{"author":"Patrick","date_created":1431550224,"date_modified":1431550224,"content":"swap-file-creator:\nhttps://github.com/Whonix/swap-file-creator/commit/a8f58cf240763599613e3ab4598a3e7e34400caa\n"},{"author":"Patrick","date_created":1431601718,"date_modified":1431601718,"content":"vbox-disable-timesync, no port to systemd, because upstream does not provide a systemd unit, diverting it, `more robust implementation that is compatible with systemd`:\nhttps://github.com/Whonix/vbox-disable-timesync/commit/958086eb0d55e0669492ab16ec15d810a533f597\n"},{"author":"Patrick","date_created":1431607151,"date_modified":1431607151,"content":"sdwdate:\nhttps://github.com/Whonix/sdwdate/commit/62c32cb2cd2bb9f518bb8b5cd7c84906a4294f1e\n\ntimesync:\nhttps://github.com/Whonix/timesync/commit/270a1f3fb397deda261e11e5d4c38e435bbb40d4\n\nsdwdate pidfile is still missing and timesync complains about that. Working on that."},{"author":"Patrick","date_created":1431645478,"date_modified":1431645478,"content":"Fixed that:\n- https://github.com/Whonix/sdwdate/commit/f1f8d4c41a55241b46aa4a847aab168c09a132c0\n- https://github.com/Whonix/sdwdate/commit/9b722218b9a7911cf214c0f3c5b482f0e57d2ba3\n"},{"author":"Patrick","date_created":1431646117,"date_modified":1431646117,"content":"TODO: most should use `SuccessExitStatus`."},{"author":"Patrick","date_created":1431646959,"date_modified":1431646959,"content":">>! In T106#4449, @Patrick wrote:\n> TODO: most should use `SuccessExitStatus`.\n\nDone:\n- https://github.com/Whonix/sdwdate/commit/2f7960a0217605eaf05950ca467df4f2484a3f57\n- https://github.com/Whonix/whonixcheck/commit/7091c9d136f2a7a0051f6f6f94e4a5a86ef1763f\n"},{"author":"Patrick","date_created":1431648614,"date_modified":1431648614,"content":"So far everything done here. Created follow up tasks for remaining work."},{"author":"Patrick","date_created":1431748522,"date_modified":1431748522,"content":"`fix, renamed lib/systemd/system/timesanitycheck to lib/systemd/system/timesanitycheck.service`:\nhttps://github.com/Whonix/timesanitycheck/commit/fee20a038d26f281fbbcfe904ece3bd11f556bf9"},{"author":"Patrick","date_created":1431860207,"date_modified":1431860207,"content":"`fix, lib/systemd/msgcollector.service -> lib/systemd/system/msgcollector.service - https://phabricator.whonix.org/T106`:\nhttps://github.com/Whonix/msgcollector/commit/a708e9180eb22038aad68e5fb0990a4122eb9daa"},{"author":"Patrick","date_created":1431860520,"date_modified":1431860520,"content":"`fix`:\nhttps://github.com/Whonix/msgcollector/commit/8132e8a8ffaeede8557f9482ff64464c5c998296"},{"author":"Patrick","date_created":1431863104,"date_modified":1431863104,"content":"`systemd unit: added 'KillMode = process', because the daemon handles terminating child processes itself - https://phabricator.whonix.org/T106`:\nhttps://github.com/Whonix/sdwdate/commit/3a14c5ecc0649c66df43a396a20a47da4b27383d\n\n`systemd unit: added 'KillMode = process', because the daemon handles terminating child processes itself - https://phabricator.whonix.org/T106`\nhttps://github.com/Whonix/whonixcheck/commit/7cb379710c081a3e14a68b41d1f30c68ca5f1b0e\n"},{"author":"Patrick","date_created":1431949874,"date_modified":1431949874,"content":"`systemd unit: added 'Before=rads.service' to prevent output by rads mixing up with output by whonix-initializer and to prevent the login manager from starting before whonix-initializer rebooted the system`:\nhttps://github.com/Whonix/whonix-initializer/commit/80dbb25732d58cab3a3abbe7634345d42848d4a5"},{"author":"Patrick","date_created":1431951952,"date_modified":1431951952,"content":"`when timesync (sdwdate gui plugin) is installed, then the sdwdate.service needs an additional 'Requires = msgcollector.service' - https://phabricator.whonix.org/T106`:\nhttps://github.com/Whonix/timesync/commit/e1e88c84c07697825a4aea14ac1c723192a58075"},{"author":"Patrick","date_created":1432066375,"date_modified":1432066375,"content":"`systemd unit: added 'Before=control-port-filter-python.service`:\nhttps://github.com/Whonix/whonix-initializer/commit/ace6738ef5ebb00ac5bc645d80577011b873e506"},{"author":"Patrick","date_created":1432304498,"date_modified":1432304498,"content":"`more work on systemd support - https://phabricator.whonix.org/T106`:\nhttps://github.com/Whonix/timesync/commit/0a76d86a8e37ae9691374da69bdef452b6def7cc"},{"author":"Patrick","date_created":1432396974,"date_modified":1432396974,"content":"`systemd unit: added 'StandardOutput=tty' for better look and feel. - https://phabricator.whonix.org/T106`\nhttps://github.com/Whonix/swap-file-creator/commit/f49f572e5a06ed33eeacc5647f0f85751cc611b9\n"},{"author":"Patrick","date_created":1432404444,"date_modified":1432404444,"content":"`more work on systemd support - https://phabricator.whonix.org/T106`:\n- https://github.com/Whonix/sdwdate/commit/0f6e50748eaeab34f9f00ce7dfbd80e980cb2a5b\n- https://github.com/Whonix/timesync/commit/b506ea4186a50bb50ae9b198deefaf2c9a7ca5d8\n"},{"author":"Patrick","date_created":1432406452,"date_modified":1432406452,"content":"`systemd unit: added 'Before=tor.service' and 'After=swap-file-creator.service' for better look and feel. - https://phabricator.whonix.org/T106`:\nhttps://github.com/Whonix/whonix-initializer/commit/0c1490942edd4c58207980785bb658afa163cb15"},{"author":"Patrick","date_created":1432992715,"date_modified":1432992715,"content":"`systemd unit: added 'Before=graphical.target' and 'Before=getty.target' - https://phabricator.whonix.org/T106`:\nhttps://github.com/Whonix/msgcollector/commit/ab24bd261d8ac2027f6a3ad85da4b4a3d416b044\n"}]},"PHID-TASK-owfsrjut4klyhxo2r5le":{"id":"105","title":"consider removal of deactivation of TBB's internal updater because upstream fixed the issue","status":"resolved","priority":"Normal","author":"Patrick","description":"There was an security issue with TBB's native updater:\nhttps://trac.torproject.org/projects/tor/ticket/13379\n\nThe Tor Project has fixed this in TBB version `4.5a3`. (As per blog post.)\nhttps://blog.torproject.org/blog/tor-browser-45a3-released\n\nForum discussion:\nhttps://www.whonix.org/forum/index.php/topic,807.0.html\n\nIf `4.5a3` is the new stable at next Whonix release, then the patch mechanism to deactivate TBB's internal updater (function `tb_run_function tb_patch_internal_updater_disable_maybe`) should be deactivated.","comments":[{"author":"Patrick","date_created":1427990799,"date_modified":1427990799,"content":"> <Patrick> do you have an ETA  or roadmap when TBB alpha becomes TBB stable?\n> <GeKo> 4.5 becomes stable in around 2 weeks\n> <GeKo> it might not contain all the things we have in the current alpha though\n> <GeKo> but as far as I currently see only the code for #14429 might not make it\n> -zwiebelbot/#tor- tor#14429: Automated rounding of content window dimensions - https://bugs.torproject.org/14429\n"},{"author":"Patrick","date_created":1427994702,"date_modified":1427994702,"content":"Found an elegant solution to get this done right now.\n\nremoved deactivation of TBB internal updater for TBB versions equal or higher than 4.5 because upstream fixed the security issue:\nhttps://github.com/Whonix/tb-updater/commit/5269eca39da11a2cbb3a9a5e190a1eb37ddb3f63\n"}]},"PHID-TASK-6bgxtxwl7czjom6stcuw":{"id":"104","title":"tb-updater signature/install confirmation screen usability review","status":"resolved","priority":"Normal","author":"Patrick","description":"Due to lots of recent #tb-updater security enhancements (T88 T95 T96 T98 T103), tb-updater needs a usability review.\n\nHere is a screenshot of the old, usual `update confirmation screen`. Unchanged except for previously asking \"Install now?\" it's not asking \"Download now?\".\n\n{F22}\n\nTo increase security (assisted detection of downgrade or indefinite freeze attack), a new `signature/install confirmation screen` has been introduced. It will be shown after `update confirmation screen` and after download. Here is a screenshot how it's looking for now.\n\n{F24}\n\n-----\n\nIf you are wondering if these two screens should be combined. I think probably not. Because the first screen is shown before download (after parsing https://www.torproject.org/projects/torbrowser/RecommendedTBBVersions that can only be verified by https). And the second screen is shown after actual file downloads and gpg verification, before installation.\n\n-----\n\n1) As you can see, it starts with showing again currently installed version and downloaded version. Should be simple so far.\n\n2) It goes on with a `signature_freshness_msg`. What is a \"last known signature\". tb-updater after (first) successful installation will store the creation date of the gpg signature that signed the tbb file. In subsequent runs, it compares the known gpg signature date with the creation date of the new gpg signature that signed the new tbb file. Depending on that, tb-updater attempts to give useful advice to the user. That message could contain three different messages.\n\n```\nsignature_freshness_msg=\"Downloaded signature is newer than last known signature. Looks alright.\"\n\nsignature_freshness_msg=\"Downloaded signature is older than last known signature. You are likely victim of a downgrade attack, SAY NO NOW!\"\n\nsignature_freshness_msg=\"Downloaded signature has same creation date as last known signature. \\\nUnless you are re-installing the same version, you could be victim of an indefinite freeze attack.\"\n```\n\n3) It goes on with the `signature creation dates`. \"Previous Signature Creation Date\" is the signature creation date of the gpg signature that we stored in a previous run. \"Current Signature Creation Date\" is the creation date of the signature we just downloaded. Maybe those terms should be renamed? \"Current System Date\" is just what it says. (But frozen, that clock won't move while looking at that window.) The user could also just have a look at its system clock in the taskbar. So maybe \"Current System Date\" should be removed?\n\n4) Currently the last text block is the `signature_creation_msg`. Depending on the local clock of the system (that could be far in past or future on broken systems), tb-updater tries to give useful advice. `signature_creation_msg` could take 4 different values depending on the state that tb-updater concluded. Examples.\n\n```\nsignature_creation_msg=\"<b>Your clock might be slow.</b> $clock_hint\nAccording to your system clock, signature was created 20 minutes before current time.\nYou can probably ignore this, because it still is within range. (Okay up to 30 minutes before.)\"\n\nsignature_creation_msg=\"<b>Your clock might be slow.</b> $clock_hint\nAccording to your system clock, signature was created 5 days, 5 hours, 45 minutes and 34 seconds before current time.\"\n\nsignature_creation_msg=\"Signature looks quite old already.\nEither,\n- your clock might be fast (at least 4 months, 4 hours and 24 seconds fast). $clock_hint\n- there is really no newer signature yet. Signature is really older than 3 months, 2 weaks, 5 hours and 43 seconds. already. (Older than 3 months.)\n- this is a tb-updater bug\n- this is an attack\"\n\nsignature_creation_msg=\"According to your system clock, signatures was created 2 days, 8 hours, 40 minutes and 12 seconds ago.\"\n```\n\n-----\n\nQuestions:\n\nAny suggestions for better wording of the existing components?\n\nShould the ordering of the se components be changed?\n\nAnything else?\n\n-----\n\nfunction `tb_confirm_install`:\nhttps://github.com/Whonix/tb-updater/blob/master/usr/bin/update-torbrowser#L987\n\n-----\n\n(Added everyone to cc who came first to my mind who might have suggestions on how to phrase these things. If you're not interested in this ticket, please just un-cc.)\n\nPlease try to keep discussion in this ticket on the usability ticket. In case security/code should be discussed, please reopen one of the existing closed tickets or open a new one.\n","comments":[{"author":"Linostar","date_created":1421869967,"date_modified":1421869967,"content":"I see the phrasing and the sentences are very clear.\n\nConcerning point 3, it is better to remove the current system datetime as you suggested.\n\nConcerning point 4, I assume that tb-updater is comparing the local clock with an internet clock? If that's the case, I have no objection on the scenarios, except that using \"current time\" is a little ambigous, since it is not mentioned whether it's the local current time or the current internet (real) time. Depending on which time you mean, you may need to change \"before\" to \"after\" in the sentences."},{"author":"Patrick","date_created":1421951756,"date_modified":1421951756,"content":"> Concerning point 3, it is better to remove the current system datetime as you suggested.\n\nDone.\n(https://github.com/Whonix/tb-updater/commit/b7ab03ea51906c2273fe1789aa4161756d373135)\n\n> Concerning point 4, I assume that tb-updater is comparing the local clock with an internet clock?\n\nIt's comparing the local clock with the creation date/time of the gpg signature. No internet clock.\n\n> If that's the case, I have no objection on the scenarios, except that using \"current time\" is a little ambigous, since it is not mentioned whether it's the local current time or the current internet (real) time. Depending on which time you mean, you may need to change \"before\" to \"after\" in the sentences.\n\nIt's \"Signature Creation Date of the Signature that was just now downloaded\". Any idea how to phrase this?"},{"author":"Linostar","date_created":1421953317,"date_modified":1421953317,"content":"Simply \"Creation date of the last downloaded signature\"?"},{"author":"Patrick","date_created":1421953764,"date_modified":1421953764,"content":"It's a bit long. But if we don't have better ideas, I'll take it.\n\nThen we'd have:\n```\nPrevious Signature Creation Date:\nCreation date of the last downloaded signature:\n```\n\nDoes that make sense?"},{"author":"Linostar","date_created":1421955594,"date_modified":1421955594,"content":"Simply \"Creation date of the last downloaded signature\"?\n\n>>! In T104#1089, @Patrick wrote:\n> It's a bit long. But if we don't have better ideas, I'll take it.\n> \n> Then we'd have:\n> ```\n> Previous Signature Creation Date:\n> Creation date of the last downloaded signature:\n> ```\n> \n> Does that make sense?\n\nIn that case, how about:\n```\nPrevious Signature Creation Date:\nMost Recent Signature Creation Date:\n```\n?"},{"author":"Patrick","date_created":1421966283,"date_modified":1421966283,"content":"Certainly much shorter.\n\nOne concern. I would like to avoid any kind of positive value judgment here. I mean, \"Most Recent\" should not imply \"we somehow know this the most recent one\". We don't. It's really just the signature creation date of the signature we just now downloaded. But if a native English speaker (you?) thinks it's no problem, it's fine with me."},{"author":"Linostar","date_created":1421995437,"date_modified":1421995437,"content":"Nope, I am not a native English speaker. In that case, your last suggestion is better:\n```\nCreation date of the last downloaded signature:\n```"},{"author":"Patrick","date_created":1422019613,"date_modified":1422019613,"content":"So for consistency... We could make it...\n```\nCreation date of previously downloaded signature:\nCreation date of last downloaded signature:\n```\n?\n\nOr what about this... A bit shorter...\n\n```\nPrevious Downloaded Signature Creation Date:\nLast Downloaded Signature Creation Date:\n```\n?\n\n```\nLast Downloaded Signature Creation Date:\nThis Downloaded Signature Creation Date:\n```\n\nIf there is no non-confusing way to word this shortly, then we must defer to the long version."},{"author":"Linostar","date_created":1422020270,"date_modified":1422020270,"content":"Perhaps we can cross out the word 'Downloaded', so they become:\n```\nPrevious Signature Creation Date:\nLast Signature Creation Date:\n```\n\nIf not, I go with the second choice."},{"author":"Patrick","date_created":1422068998,"date_modified":1422068998,"content":"Ok.\n\n> ```\n> Previous Signature Creation Date:\n> Last Signature Creation Date:\n> ```\n\nUsing that now:\nhttps://github.com/Whonix/tb-updater/commit/64e5a160b4353450195ab888a7408b97e3da6972\n\nI have the feeling this will generate quite some more confusion and suggestions. By no later than the first Whonix 10 based testers-only version or stable release. Might require quite some more rewording."},{"author":"Patrick","date_created":1422515744,"date_modified":1422515744,"content":"Got a bunch of anonymous feedback.\n\n> * The warning sign is not scary enough.\n\n> * victim -> target\n\n> * Needs more focus. \"You could be the target of an indefinite freeze attack!\" belongs at the beginning, not the end.\n\n> * A link \"Learn more\" / \"Tell me more\" / \"What is that?\" should be added.\n\n> * Missing `the` multiple times. -> \"[The d]ownloaded signature has [the] same creation [..]\"\n\n> * Date/time comparison should be exactly below each other.\n\n> * Use either full strings \"Friday\" or numbers. No contractions such as \"Fri\" that need more mental effort.\n\nAny comments?"},{"author":"Linostar","date_created":1422534512,"date_modified":1422534512,"content":"They sound logical to me."},{"author":"Patrick","date_created":1422535973,"date_modified":1422535973,"content":"Good. Sounds good to me as well. Will implement them.\n\n> victim -> target\n\nDone:\nhttps://github.com/Whonix/tb-updater/commit/d35c279c3ace1027a089fa716dd9f1d705bd5829\n\n> Needs more focus. \"You could be the target of an indefinite freeze attack!\" belongs at the beginning, not the end.\n\nUsing these now...\n\n* `Looks alright. Downloaded signature is newer than last known signature.`\n\n* `You are likely target of a downgrade attack, SAY NO NOW! Downloaded signature is older than last known signature. Unless you are downgrading, you should abort now and try again later!`\n\n* `You could be target of an indefinite freeze attack! Downloaded signature has same creation date as last known signature. Unless you are re-installing the same version, you should abort now and try gain later!`\n\n(Done: https://github.com/Whonix/tb-updater/commit/a387cb84e21ec254d185dd3d636b58d874cf12f5)\n"},{"author":"Patrick","date_created":1422536201,"date_modified":1422536201,"content":"> Missing the multiple times. -> \"[The d]ownloaded signature has [the] same creation [..]\"\n\nDone:\nhttps://github.com/Whonix/tb-updater/commit/6bbc38ebf978d0a36e47a29810f3d8eb65817720\n\n> A link \"Learn more\" / \"Tell me more\" / \"What is that?\" should be added.\n\nCurrently blocked by T122."},{"author":"Patrick","date_created":1422536578,"date_modified":1422536578,"content":"> Date/time comparison should be exactly below each other.\n\nCurrently blocked by T123. Will see and discuss this with troubadour in a separate ticket. If it can be solved, we can do this one as well."},{"author":"Patrick","date_created":1422539695,"date_modified":1422539695,"content":">>! In T104#1326, @Patrick wrote:\n>> Date/time comparison should be exactly below each other.\n> \n> Currently blocked by T123. Will see and discuss this with troubadour in a separate ticket. If it can be solved, we can do this one as well.\n\nDone:\nhttps://github.com/Whonix/tb-updater/commit/eaa391c01257c36e96c84ccaba3b1130630b7fc6"},{"author":"Patrick","date_created":1422539946,"date_modified":1422539946,"content":"> Use either full strings \"Friday\" or numbers. No contractions such as \"Fri\" that need more mental effort.\n\nDone:\nhttps://github.com/Whonix/gpg-bash-lib/commit/6312e5439985f6b466f46f030eb5c8ebd45ef4ca\n"},{"author":"Patrick","date_created":1422541800,"date_modified":1422541800,"content":"Since there were quite a few changes between the original post and the current version... Here are two new screenshots.\n\nDownload Confirmation:\n\n{F29}\n\nInstallation Confirmation:\n\n{F31}"},{"author":"Patrick","date_created":1422542383,"date_modified":1422542383,"content":"Last one not addressed yet:\n\n> The warning sign is not scary enough.\n\nThis could be an optimization issue. We wanted to use only images, that come from Debian repository:\nhttps://github.com/Whonix/Whonix/issues/318\n\nNeed to look which ones are already installed and what Debian might have to offer.\n\nAlso [`generic_gui_message`](https://github.com/Whonix/msgcollector/blob/master/usr/lib/msgcollector/generic_gui_message) doesn't support choosing the symbolic (warning) sign yet. Perhaps if we find a stronger one, we just hard code it as \"strongwarning\" or so into `generic_gui_message`."},{"author":"Patrick","date_created":1422553075,"date_modified":1422553075,"content":"Few more anonymous suggestions:\n\n* `use warning sign rather than info sign when Tor Browser is already installed because it will be terminated and moved` -> [done](https://github.com/Whonix/tb-updater/commit/f7d1aa302b2d067d041f6c191171f92e76150cf8)\n\n* `default button should be no` -> Created T124 for it.\n\n* `disable buttons for a few seconds` - What do you think?"},{"author":"Patrick","date_created":1422620859,"date_modified":1422620859,"content":"As per...\n\n```\nPrevious Signature Creation Date: Friday January 16 08:37:06 UTC 2015\nLast Signature Creation Date    : Friday January 16 08:37:06 UTC 2015\n```\n\nI am wondering, if the day is useful at all?"},{"author":"Linostar","date_created":1422623241,"date_modified":1422623241,"content":"Yes, I think it is. Consider the case where the time is around midnight. It may look confusing otherwise."},{"author":"Patrick","date_created":1422626971,"date_modified":1422626971,"content":"Ok, done:\nhttps://github.com/Whonix/gpg-bash-lib/commit/0a74694502d104d998280608540ae007b33edc74"},{"author":"Patrick","date_created":1422655600,"date_modified":1422655600,"content":"> * `default button should be no` -> Created T124 for it.\n\nThanks to @troubadour, this is now done."},{"author":"Patrick","date_created":1423079232,"date_modified":1423079232,"content":"@troubadour has increased the symbol (warning sign) size, so that anonymous suggestion has been implemented.\n\nAnd @troubadour is currently working on T122, so we might get default button no as well as hyperlink support soon, so we can also add a link to this confirmation screen(s)."},{"author":"Patrick","date_created":1423540458,"date_modified":1423540458,"content":">>! In T104#1434, @Patrick wrote:\n> And @troubadour is currently working on T122, so we might get default button no as well as hyperlink support soon, so we can also add a link to this confirmation screen(s).\n\nThis is done."},{"author":"Patrick","date_created":1423678717,"date_modified":1423678717,"content":"added links to download and installation confirmation screen documentation:\nhttps://github.com/Whonix/tb-updater/commit/8520b854aad0167eb9fae7800dba8334753daf02\n"},{"author":"Patrick","date_created":1423737625,"date_modified":1423737625,"content":"I guess that's it for now. We'll get more feedback after the releases."}]},"PHID-TASK-jqzfmscrqyzkyyjbhn6w":{"id":"103","title":"tb-updater compare signature creation date with local clock","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1421689896,"date_modified":1421689896,"content":"Done:\nhttps://github.com/Whonix/tb-updater/commit/0ec299763e7b6384cf102ce4403a31897e366340"}]},"PHID-TASK-buo4lmumyhknvqpjbj7e":{"id":"102","title":"url_to_unixtime - extract time stamps from http headers","status":"resolved","priority":"Normal","author":"Patrick","description":"__Requirements__:\n\n* Not using `libcurl` (because that's a C binding, then we'd have no security enhancement and could just stick to `curl`).\n* force use TLSv1, not SSL\n* Download head only. (Similar to `curl`s `--head`.)\n* Features. With example.\n\n```\n/usr/lib/sdwdate/url_to_unixtime \\\n   --max-time 180 \\\n   --socks5-hostname 10.152.152.10:9108 \\\n   --tls true \\\n   https://check.torproject.org\n```\n\nExpected output, unixtime, example:\n`1413814230`\n\n-----\n\n__Bonus__:\n\n```\n--max-file-size-bytes 2097152\n--user-agent\n--verbose\n```\n\n-----\n\n__SSL__:\nDepending on the outcome of [this](https://github.com/Whonix/Whonix/issues/351#issuecomment-69648747) we might not need SSL support.\n\n__date_to_unixtime__:\nThe code for date to unixtime is already done:\nhttps://github.com/Whonix/sdwdate/blob/master/usr/lib/sdwdate/date_to_unixtime\n\n__python-requests__:\nImplementing this using the [`python-requests`](http://docs.python-requests.org) library [was trivial](https://github.com/Whonix/sdwdate/blob/development/usr/lib/sdwdate/date_to_unixtime), but unfortunately, `python-requests` [does not support socks proxies yet](https://github.com/kennethreitz/requests/issues/2156), which is a deal breaker for Whonix.\n\n__urllib3__:\n[Has no yet socks proxy support either.](https://github.com/shazow/urllib3/pull/68)\n\n__TODO__:\nSo we have to find some python library that has socks proxy as well as TLSv1 support, that is installable from Debian repository. Does this exist?","comments":[{"author":"troubadour","date_created":1422056018,"date_modified":1422056018,"content":"Might be some progress on this one. It's not really my domain of competence, so...\n\nIn Whonix-Gateway, install python-socksipy python-openssl packages.\n\nTry this script.\n  #!/usr/bin/python\n  \n  import socks, ssl\n  \n  s = socks.socksocket()\n  s.setproxy(socks.PROXY_TYPE_SOCKS5, \"127.0.0.1\", port=9050)\n  s.connect(('check.torproject.org', 443))\n  ss = ssl.wrap_socket(s)\n  print ss.cipher()\n  s.close()\n  ss.close()\n  \n  s = socks.socksocket()\n  s.setproxy(socks.PROXY_TYPE_SOCKS5, \"127.0.0.1\", port=9050)\n  s.connect(('whonix.org', 443))\n  ss = ssl.wrap_socket(s)\n  print ss.cipher()\n  s.close()\n  ss.close()\n\nIf that looks sound,we'll have to find the way to get the time from the header. That must be possible, because the shell openssl command returns (in Whonix-Workstation):\n\n  $ openssl s_client -connect whonix.org:443     \n  CONNECTED(00000003)\n  depth=1 C = FR, O = GANDI SAS, CN = Gandi Standard SSL CA\n  verify error:num=20:unable to get local issuer certificate\n  verify return:0\n  --\n  Certificate chain\n  0 s:/OU=Domain Control Validated/OU=Gandi Standard SSL/CN=whonix.org\n    i:/C=FR/O=GANDI SAS/CN=Gandi Standard SSL CA\n  1 s:/C=FR/O=GANDI SAS/CN=Gandi Standard SSL CA\n    i:/C=US/ST=UT/L=Salt Lake City/O=The USERTRUST Network/OU=http://www.usertrust.com   \n  ---\n  Server certificate\n  -----BEGIN CERTIFICATE-----\n  MIIE1zCCA7+gAwIBAgIRAKuuBHjHjvVq22Vahgk4QZYwDQYJKoZIhvcNAQEFBQAw\n  QTELMAkGA1UEBhMCRlIxEjAQBgNVBAoTCUdBTkRJIFNBUzEeMBwGA1UEAxMVR2Fu\n  ~~\n  A1UW8F3H49PDn/FmBM0qOXhiWY9O0wcyZcOVUiBkw6Phq163lqkeleDlqA==\n  -----END CERTIFICATE-----\n  subject=/OU=Domain Control Validated/OU=Gandi Standard SSL/CN=whonix.org\n  issuer=/C=FR/O=GANDI SAS/CN=Gandi Standard SSL CA\n  ---\n  No client certificate CA names sent\n  ---\n  SSL handshake has read 3128 bytes and written 431 bytes\n  ---\n  New, TLSv1/SSLv3, Cipher is ECDHE-RSA-AES256-GCM-SHA384\n  Server public key is 2048 bit\n  Secure Renegotiation IS supported\n  Compression: NONE\n  Expansion: NONE\n  SSL-Session:\n      Protocol  : TLSv1.2\n      Cipher    : ECDHE-RSA-AES256-GCM-SHA384\n  ~~\n      Start Time: 1422055124\n      Timeout   : 300 (sec)\n      Verify return code: 20 (unable to get local issuer certificate)\n  ---\n  closed\n\nIf we pipe a command in it\n\n  $ ls | openssl s_client -connect whonix.org:443\n\nthe connection closes immediately (no 10~20 seconds waiting).\n\n  ~~\n    Start Time: 1422055553\n    Timeout   : 300 (sec)\n    Verify return code: 20 (unable to get local issuer certificate)\n  ---\n  DONE\n\n"},{"author":"Patrick","date_created":1422067578,"date_modified":1422067578,"content":"Will try soon.\n\n> If that looks sound,we'll have to find the way to get the time from the header. That must be possible, because the shell openssl command returns (in Whonix-Workstation):\n\nWe don't want to extract from SSL. ([Because likely unreliable in long term.](https://github.com/ioerror/tlsdate/issues/150) + Doesn't work for `.onion` domains.) We want to extract time from http headers.\n\nSimilar to this.\n```\ncurl --head check.torproject.org\n```\n```\ncurl --silent --head check.torproject.org | grep \"Date:\"\n```\n"},{"author":"Patrick","date_created":1422068427,"date_modified":1422068427,"content":"> Try this script.\n\nDoes what I thought it does. :)"},{"author":"troubadour","date_created":1422090065,"date_modified":1422090065,"content":"I was mislead by this:\n> So we have to find some python library that has socks proxy as well as TLSv1 support,\n\nPerhaps this is more acceptable (actually simpler, since we can use the socket directly).\n\nScript 'socks_socket.py'.\n  #!/usr/bin/python\n  \n  import sys, socks\n  \n  site = sys.argv[1]\n  \n  s = socks.socksocket()\n  s.setproxy(socks.PROXY_TYPE_SOCKS5, '127.0.0.1', 9050)\n  s.connect((site, 80))\n  s.send('HEAD / HTTP/1.1\\r\\n\\r\\n')\n  \n  data = ''\n  buf = s.recv(1024)\n  while len(buf):\n      data += buf\n      buf = s.recv(1024)\n  s.close()\n  \n  print('HTTP header from \"%s:\":\\n\\n%s' % (site, data))\n\nThese commands have ((almost) the same output as curl.\n```python socks_socket.py \"check.torproject.org\"```\n \n```python socks_socket.py \"check.torproject.org\" | grep \"Date:\"```\n\nIt's for example (no error handling, time out...). If you try 'google.com', it hangs indefinitely."},{"author":"troubadour","date_created":1422110196,"date_modified":1422110196,"content":"The example above supports socks proxies, but for TLSv1, it looks like we would need python-socksipychain, which is available in jessie, not in wheezy."},{"author":"Patrick","date_created":1422121481,"date_modified":1422121481,"content":"We switch to jessie sooner or later anyhow. So that should not be considered a blocker.\n\nIf it helps a lot to leave out timeout, then leave out timeout. ;) Because, after thinking again, timeout isn't that important inside the python script. The python script can be called using `timeout`, which is apparently a reliable tool to enforce timeouts from \"the outside\" (\"from bash\"). Maybe that's easiest/best and should be done in any case anyhow.\n\nDo you think you can re-use `python-request`'s code to parse the http header? I.e. to extract the date field from the http header.\n\n```\ndate = response.headers.get('date')\n```\n\nSimilar to:\nhttps://github.com/Whonix/sdwdate/blob/5a6c1729df8caaaddcabc8caeb2108faca199ca7/usr/lib/sdwdate/url_to_unixtime#L54\n"},{"author":"Patrick","date_created":1422121749,"date_modified":1422121749,"content":"Good news: the last script you posted works while transparent dns and transparent tcp is disabled! So stream isolation is apparently functional.\n\nCurl gets a `HTTP/1.1 302 Found` response while the script gets a `HTTP/1.1 400 Bad Request` response."},{"author":"troubadour","date_created":1422128444,"date_modified":1422128444,"content":"> We switch to jessie sooner or later anyhow. So that should not be considered a blocker.\nYes, I have donwloaded the package from Debian (not available from backports), checked with sha256sum. Currently testing, working even if still rather obscure. \n\nRegarding timeout, if the script hangs, sdwdate won't be able to call it again. Or is the external `timeout`managing the process?\n\n> Do you think you can re-use python-request's code to parse the http header? I.e. to extract the date field from the http header.\n\nThat's the next logical step. The script could take the URL as argument and returns unixtime.\n\n> Curl gets a HTTP/1.1 302 Found response while the script gets a HTTP/1.1 400 Bad Request response.\n\nYes, and the location field is missing with the script too. Is that a problem?"},{"author":"troubadour","date_created":1422128704,"date_modified":1422128704,"content":"timeout is on line to add;\n  socket.settimeout(10[orso])"},{"author":"Patrick","date_created":1422130110,"date_modified":1422130110,"content":"Yes, the external `timeout` command is managing the process. It sends signal `SIGTERM` after a configurable amount of time, optionally followed (using this) of signal `SIGKILL` after another configurable amount of time. See also:\nhttp://manpages.debian.org/cgi-bin/man.cgi?&query=timeout\nIt's a GNU coreutil and quite old already. Expected to be very reliable.\n\nThe timeout would need to be configurable by commandline if you wish to add it.\n\n> Is that a problem?\n\nNot sure. Better to look similar to curl, similar to a usual request. So sysadmins don't get afraid and add some magic to block it."},{"author":"troubadour","date_created":1422132434,"date_modified":1422132434,"content":"It's not easy to handle all the exceptions in python, and the script may hang on other errors than timeout. So it looks actually better to manage it externally. Conclusion:\n> Maybe that's easiest/best and should be done in any case anyhow.\nYes, most likely."},{"author":"troubadour","date_created":1422178873,"date_modified":1422178873,"content":"Before starting the next stage (on github, I guess), an update to the script.\n\n  #!/usr/bin/python\n  \n  import sys, socks\n  \n  site = sys.argv[1]\n  \n  s = socks.socksocket()\n  s.setproxy(socks.PROXY_TYPE_SOCKS5, '127.0.0.1', 9050)\n  \n  try:\n      s.connect((site, 80))\n  except IOError as e:\n      print e\n      sys.exit(1)\n    \n  s.send('HEAD / HTTP/1.0\\r\\n\\r\\n')\n  \n  data = ''\n  buf = s.recv(1024)\n  while len(buf):\n      data += buf\n      buf = s.recv(1024)\n  s.close()\n  \n  print('HTTP header from \"%s:\":\\n\\n%s' % (site, data))\n\nSetting aside the exceptions handling, the significant change is the request with 'HTTP/1.0' instead of  'HTTP/1.1'. check.torproject.org returns '200 OK', which looks like an improvement, less likely to be tagged by sysadmins.  "},{"author":"troubadour","date_created":1422179200,"date_modified":1422179200,"content":"Or not?"},{"author":"Patrick","date_created":1422202683,"date_modified":1422202683,"content":"Best answer is \"very same as a mainstream browser as possible\", but that is kinda impossible. Realistic answer is \"similar like curl or wget\".\n\nGetting this.\n\n```\nHTTP header from \"check.torproject.org:\":\n\nHTTP/1.1 504 Gateway Time-out\nDate: Sun, 25 Jan 2015 16:15:39 GMT\nConnection: close\n```"},{"author":"troubadour","date_created":1422281666,"date_modified":1422281666,"content":"It's kinda impossible too to have a reply consistently similar to curl or wget. Depending on the URL, It can be identical, differ by one line, or the the reply be different (\"200 OK\" instead of  \"302 Found\").\n\nHave integrated date_to_unixtime.\n\n\n``` \n#lang=\n#!/usr/bin/python\n\nimport sys, socks\nfrom dateutil.parser import parse\n\ntry:\n    socket_ip =sys.argv[1]\n    socket_port = int(sys.argv[2])\n    url = sys.argv[3]\nexcept IndexError as e:\n   print >> sys.stderr, \"Parsing command line parameter failed. | e: %s\" % (e)\n   sys.exit(1)\n\ns = socks.socksocket()\ns.setproxy(socks.PROXY_TYPE_SOCKS5, socket_ip, socket_port)\n\ntry:\n    s.connect((url, 80))\nexcept IOError as e:\n    print >> sys.stderr, e\n    sys.exit(1)\n  \ns.send('HEAD / HTTP/1.0\\r\\n\\r\\n')\n\ndata = ''\nbuf = s.recv(1024)\nwhile len(buf):\n    data += buf\n    buf = s.recv(1024)\ns.close()\n\ndate = ''\ndate_pos = data.find('Date:') + 6\ndate = data[date_pos:date_pos + 30].strip()\nif date == '':\n   print >> sys.stderr, 'Parsing HTTP header date failed.'\n   sys.exit(2)\n\ntry:\n    ## Thanks to:\n    ## eumiro\n    ## http://stackoverflow.com/a/3894047/2605155\n    unixtime = parse(date).strftime('%s')\nexcept ValueError as e:\n   print >> sys.stderr, ('Parsing date from server failed. | date: %s \\\n\t\t\t | dateutil ValueError: %s' % (date, e))\n   sys.exit(3)\n\n#print data\n#print date\nprint \"%s\" % unixtime\n\n```\nExample:\n```python url_to_unixtime.py 127.0.0.1 9100 whonix.org```\n\nIf this is OK, is it necessary to create a separate package? It could be bundled in sdwdate.\n"},{"author":"Patrick","date_created":1422308657,"date_modified":1422308657,"content":"Please remove the `#lang=` (unless that's good for something) and the trailing spaces.\n\nYeah. Unless we get a feature requests to maintain this in a separate repository, it's fine to keep this in the sdwdate package. `/usr/lib/sdwdate/url_to_unixtime`?"},{"author":"troubadour","date_created":1422365051,"date_modified":1422365051,"content":"The `#lang=` was for syntax highlighting.\n\nTested with the different pools from `/usr/bin/sdwdate`. The replies range from `200 OK` to `403 Forbidden`, which looks OK.\n\nDo you want me to add it to sdwdate?"},{"author":"Patrick","date_created":1422372110,"date_modified":1422372110,"content":"Yes."},{"author":"troubadour","date_created":1422440442,"date_modified":1422440442,"content":"Done. <https://github.com/troubadoour/sdwdate>"},{"author":"Patrick","date_created":1422493346,"date_modified":1422493346,"content":"Thanks! Merged."},{"author":"Patrick","date_created":1422493485,"date_modified":1422493485,"content":"Changed exit codes a bit."},{"author":"Patrick","date_created":1422493886,"date_modified":1422493886,"content":"Some more sanity testing, done:\ncheck if date conversion result is numeric\n"},{"author":"Patrick","date_created":1422494386,"date_modified":1422494386,"content":"Done:\ncheck that string length is no bigger than 10\n\nI guess 10 suffices...\n\n```\ndate --date @1999999999\n```\n```\nWed May 18 03:33:19 UTC 2033\n```\n"},{"author":"Patrick","date_created":1422495881,"date_modified":1422495881,"content":"Just noticed, that file needs a license header. Could you add it please?\n\nDo my changes look good so far?\n\nCan you make `data.find` case insensitive please? Some servers in the wild indeed used `date:`. We could use tolower, but I don't know what provides best performance. (Imagine faulty or even malicious replies.) IF that makes sense at all.\n\nAnd would it make sense to check the return code of `data.find`? To abort if it didn't find such a line? I am trying to imagine all sorts of invalid input.\n\nAlso would it make sense to check if the size of `data` is reasonable before processing it further? (Having performance in mind here again if a server replies a super long string so we would abort earlier and waste less processing power.)"},{"author":"troubadour","date_created":1422651016,"date_modified":1422651016,"content":"All the checks should be in the last two commit.\n\n- max `data length` = 1024 \n- `data.find`sarch for uppersace and lowercase in the header, return an error if not found.\n- `date string length`: max length = date string length,  min length = max length, return an error if too short.\n- your unixtime sanity checks (minor modification).\n- extra: `time offset`: check local time/HTTP header time difference, max offset value hard-coded, return an error if outside.\n\nNot sure the last check is relevant, as I have to check which local time python is returning. "},{"author":"Patrick","date_created":1422656750,"date_modified":1422656750,"content":"> Not sure the last check is relevant, as I have to check which local time python is returning.\n\nThe last check is overkill. That's something sdwdate should do itself.\n\n> ```\n> http_time = http_time(data)\n> ```\n\nI am not much of a python coder, but is it a good or common way to have a variable that has the same name as a function?\n\n> ```\n>         ## \"Date:\" not found.\n>         print >> sys.stderr, 'Parsing HTTP header date failed.'\n> ```\n\nDoes speak anything against writing `data` to stderr? In case this happens at some time somewhere and some user reports it, then it would be interesting to see what went wrong instead of needing to add more debug code by then.\n\n> if unixtime_sanity_check(unixtime_http):\n\nWondering if we could simplify the code by either using `if not ...` (non-ideal) take make the indent shorter or to just run `unixtime_sanity_check(unixtime_http)` and leave it there - because that function is supposed to exit anyhow if some sanity check goes wrong. (You did this that way using function `http_time` already.)"},{"author":"troubadour","date_created":1422717137,"date_modified":1422717137,"content":"Let's say the ptrevious commit was a draft.\nIn https://github.com/troubadoour/sdwdate/commit/315728bfff5e56055c4927a11c0188d35f402e77\n\n- offset check removed.\n- three separate sanity check functions (received data, http time, unix time). No `if` or `if not` left in the main body of the program (makes sense, thanks).\n- write \"data\" to stderr if header parsing error."},{"author":"Patrick","date_created":1422724877,"date_modified":1422724877,"content":"I am going to add some refactoring on top."},{"author":"Patrick","date_created":1422726353,"date_modified":1422726353,"content":"Done for now. Please review and merge.\n\nManually tested all the functions with bogus input to see if they correct report and exit if something goes wrong.\n\nOne exception remains.\n\n```\n./usr/lib/sdwdate/url_to_unixtime 127.0.0.1 9050 \"nonexisting\"\n```\n\n```\nTraceback (most recent call last):\n  File \"./usr/lib/sdwdate/url_to_unixtime\", line 81, in <module>\n    s.connect((url, 80))\n  File \"/usr/lib/python2.7/dist-packages/socks.py\", line 369, in connect\n    self.__negotiatesocks5(destpair[0],destpair[1])\n  File \"/usr/lib/python2.7/dist-packages/socks.py\", line 236, in __negotiatesocks5\n    raise Socks5Error(ord(resp[1]),_generalerrors[ord(resp[1])])\nTypeError: __init__() takes exactly 2 arguments (3 given)\n```\n\nCan you look into it please?"},{"author":"troubadour","date_created":1422784935,"date_modified":1422784935,"content":"Solved in https://github.com/troubadoour/sdwdate/commit/3b48433bdf4bcddcf4009ca242408bd32e8088f3.\n\nIt returns a pure python exception from socks.py \"`: __init__() takes exactly 2 arguments (3 given)`\" which seems to mean that the the url  was not found. Perhaps we could translate it in something more meaningful.\n\nAlso, change `main_function()` to `main()`. More pythonic (if we ever want to import the script, `main()` is required.) \n"},{"author":"Patrick","date_created":1422798514,"date_modified":1422798514,"content":"Merged.\n\nOkay. Because that error message sounds more like a python syntax error than url not found.\n\nI would also like to make the port configurable (easy, can do).\n\nHave you experience creating unit tests for python scripts yet? While I am at it, now that everything is inside functions I would be motivated to write unit test that test the functions using valid and invalid input to see if they output as expected. If you get that started, I could finish it. Or you do it. And if you don't know, I can also research the whole thing. I don't really mind."},{"author":"troubadour","date_created":1422895440,"date_modified":1422895440,"content":"Done the translation in https://github.com/troubadoour/sdwdate/commit/c34a9332b2fcec89d4d08910e3be05f649b6d919.\n\nI have never created uni tests. A quick research tells me that it might be a bit late for that script (using python-test or mock, to name a few). It makes sense to create the unit test BEFORE starting to write the code.\n\nurl-to-unixtime has been extensively tested for good and bad input, first by me, then you (spotting the bad URL). And I made another round of bogus inputs before pushing the last commit.  "},{"author":"troubadour","date_created":1422895643,"date_modified":1422895643,"content":"Forgot. I saw the ad on sourceforge for creating a test suite with cucumber. I guess it could be used for any language (bash, python)."},{"author":"Patrick","date_created":1422896286,"date_modified":1422896286,"content":"Test suite cocumber is different. It is more like a simulated user who boots up the system, clicks here and there, runs several tests and checks the results. It's more for testing the interaction with the whole system. For example, see:\nhttps://en.wikipedia.org/wiki/Cucumber_%28software%29\n\nUnit tests work on a lower level, testing function in/output alike. Useful when functions are later changed/refactored/whatever to see if they still work as expected. I agree it's not super important, just nice to have unit tests for this.\n\nOne isn't supposed to be a replacement for the other. A unit test is more for us devs who have enough ram, dependencies installed and so forth checking functions. A test suite is more testing if the whole thing is functional or if some interaction breaks it."},{"author":"Patrick","date_created":1422896965,"date_modified":1422896965,"content":"Merged and tested."},{"author":"Patrick","date_created":1422906360,"date_modified":1422906360,"content":"* Made remote port configurable.\n* Added usage example comment on top.\n\nI am wondering, if these comments could be improved?\n\n```\n    ## max accepted string length.\n    http_time = data[date_string_start_position:date_string_start_position + 29].strip()\n```\n\n```\n    ## min string length = max string length.\n    if http_time_string_length < 29:\n```\n"},{"author":"Patrick","date_created":1422907342,"date_modified":1422907342,"content":"Added verbose output mode. In verbose mode, variables will be written to `stderr`.\n\nUsage (also as per comment at the top of the script):\n```\nusr/lib/sdwdate/url_to_unixtime 127.0.0.1 9050 check.torproject.org 80 true\n```\n\nThis is useful to make the script show what the server replied, and if the conversion back and forth is fully functional.\n\n```\ndate --date \"@$(usr/lib/sdwdate/url_to_unixtime 127.0.0.1 9050 check.torproject.org 80 true)\"\n```\n\n```\ndata: HTTP/1.1 200 OK\nDate: Mon, 02 Feb 2015 19:56:01 GMT\nServer: Apache\nLast-Modified: Thu, 23 Feb 2012 18:45:14 GMT\nETag: \"211-1e8-4b9a60b6ecade\"\nAccept-Ranges: bytes\nContent-Length: 488\nVary: Accept-Encoding\nConnection: close\nContent-Type: text/html\nX-Pad: avoid browser bug\n\n\nhttp_time: Mon, 02 Feb 2015 19:56:01 GMT\nparsed_unixtime: 1422906961\nMon Feb  2 19:56:01 UTC 2015\n```\n\nThe last line shows how `date` converted `url_to_unixtime`'s `stdout` back to a human readable date. We see that the value of the `Date:` field exactly matches (besides formatting, but it's the `unixtime` that matters, because that will be used by sdwdate)."},{"author":"Patrick","date_created":1423082278,"date_modified":1423082278,"content":"Added python-socksipy dependency:\nhttps://github.com/Whonix/sdwdate/commit/13736580ca53c351724e87ded276eb3230f23e5e\n\nAny other dependencies missing?"},{"author":"Patrick","date_created":1423144324,"date_modified":1423144324,"content":"Created follow up tasks...\n\nHardening:\n* T128\n* T129\n\nImplementation:\n* T131\n* T132\n* T133\n\nI think this can be considered resolved. Please feel free to reopen, if you disagree."},{"author":"troubadour","date_created":1424032505,"date_modified":1424032505,"content":"> It returns a pure python exception from socks.py \": __init__() takes exactly 2 arguments (3 given)\" which seems to mean that the the url was not found. Perhaps we could translate it in something more meaningful.\nAn update for this issue. In jessie, python-pysocks is an upgrade to python-socksipy, which fixes some bugs, amongst them this situation.\n\nExamples, without code modification:\n```$ ./url_to_unixtime 127.0.0.1 9050 whonix.or 80 true\nconnect error: 0x04: Host unreachable```\n```$ ./url_to_unixtime 127.0.0.1 9050 whonix+org 80 true\nconnect error: 0x01: General SOCKS server failure```\nThat looks better."},{"author":"troubadour","date_created":1424036399,"date_modified":1424036399,"content":"Pushed the change.\nhttps://github.com/troubadoour/sdwdate/commit/298c00941ddfecc1a31b104be9954207cc60af78"},{"author":"Patrick","date_created":1424073413,"date_modified":1424073457,"content":"Good catch. Although that change made it incompatible with wheezy. (Because python-pysocks is not available in wheezy.) Therefore I added a commit on top to make it compatible with wheezy and jessie:\nhttps://github.com/Whonix/sdwdate/commit/b015142d64f31d849991d9d1794110baaab1c19b\n\nAt the current rate of progress, and [the few left tickets](https://phabricator.whonix.org/maniphest/?statuses=open&allProjects=PHID-PROJ-azftsdqyk3mbrlzazoc6#R), I think chances are good, that Whonix 10 will be ready before jessie becomes the new Debian stable. So Whonix 10 might still be a wheezy based release. (Although hopefully ready to be upgraded to jessie without hassle.) (The related, \"maybe wait for jessie ticket\": T24)"},{"author":"Patrick","date_created":1424078440,"date_modified":1424078440,"content":"Introduced a new status \"review\". Hope you like it. (T178)"}]},"PHID-TASK-ijeykxvvadnf5mnshbgg":{"id":"101","title":"pre.bsh enable errtrace","status":"resolved","priority":"Normal","author":"Patrick","description":"TODO:\nEnable `set -o errtrace` in https://github.com/Whonix/anon-base-files/blob/master/usr/lib/pre.bsh. Test that it doesn't break any packages.","comments":[{"author":"Patrick","date_created":1421533475,"date_modified":1421533475,"content":"Done:\nhttps://github.com/Whonix/anon-base-files/commit/2328a02c7e5162cc81e26fafbff2b21b96c2d7aa\n\nWill test during the next rebuild."}]},"PHID-TASK-mjqtdq42l2rrohmfteqy":{"id":"100","title":"KEYEXPIRED Error upon apt-get update from Whonix Repository","status":"resolved","priority":"High","author":"WhonixQubes","description":"KEYEXPIRED error upon apt-get update from Whonix repository reported and confirmed as happening in Qubes + Whonix.\n\nW: GPG error: http://sourceforge.net wheezy Release: The following signatures were invalid: KEYEXPIRED 1421449064 KEYEXPIRED 1421449064 KEYEXPIRED 1421449064 KEYEXPIRED 1421449659 KEYEXPIRED 1421449659 KEYEXPIRED 1421449064 KEYEXPIRED 1421449064 KEYEXPIRED 1421449064 KEYEXPIRED 1421449659 KEYEXPIRED 1421449064 KEYEXPIRED 1421449064 KEYEXPIRED 1421449064 KEYEXPIRED 1421449659\n\nWonder if this is happening on other Whonix platforms, such as VirtualBox?\n\n#qubes\n\n\n\n\nForum Discussion:\n- https://www.whonix.org/forum/index.php/topic,892.0.html","comments":[{"author":"troubadour","date_created":1421532758,"date_modified":1421532758,"content":"Confirmed here, also from the testers and developers repositories."},{"author":"Patrick","date_created":1421548800,"date_modified":1421548800,"content":"Manual action required by users to fix this. Documented in wiki. Blogged about this. Posted Whonix News.\n\n* https://www.whonix.org/blog/whonix-signing-key-expired-keyexpired-error\n* https://www.whonix.org/wiki/Download#KEYEXPIRED_Error\n\nStable upgrade 9.6 testers-only version in the works."},{"author":"WhonixQubes","date_created":1421994181,"date_modified":1421994181,"content":"Whonix Qubes solution for this error is documented here:\n\n- https://www.whonix.org/forum/index.php/topic,909.0.html"}]},"PHID-TASK-nhdlnnqsxrtnuqdghjc5":{"id":"99","title":"generic_gui_message itype consistency","status":"resolved","priority":"Normal","author":"Patrick","description":"Two super simple changes.\n\n* https://github.com/Whonix/msgcollector/commit/1ed2ce01877c9e34909891cb1bfc5645db9a095b\n* https://github.com/Whonix/anon-gw-first-run-notice/commit/87acfa7cd94fcdd7e767da9397cf0db20d373edb\n\nWhy? For consistency. Using the `info`, `warning`, `error` scheme everywhere else.\n\nShouldn't cause any issues. Are you okay with those changes, @troubadour?","comments":[{"author":"troubadour","date_created":1421528120,"date_modified":1421528120,"content":"Yes. Double checked, it's okay."}]},"PHID-TASK-zgfpxpxchdbs3xzqnfvc":{"id":"98","title":"tb-updater should authenticate file names","status":"resolved","priority":"Normal","author":"Patrick","description":"To do this, the `sha256sums.txt` file needs to be verified using the `sha256sums.txt.asc` file. When that succeeded, the hash for the archive needs to be created and looked up within `sha256sums.txt`.\n\nThis is useful to detect a downgrade or indefinite freeze attack.","comments":[{"author":"Patrick","date_created":1421472003,"date_modified":1421472003,"content":"Done:\nhttps://github.com/Whonix/tb-updater/commit/67907c315922933a71a73d429ed5bf4139c4577a"}]},"PHID-TASK-xv5wmicz6qznmnr45kd2":{"id":"97","title":"msgdispatcher_dispatch_x lacks new lines for output from console applications","status":"resolved","priority":"Normal","author":"Patrick","description":"Sometimes it is useful for whonixcheck to add stuff like this to the output.\n\n```\nsudo -u debian-tor tor --verify-config\n```\n\nNaturally, lines aren't prepended or terminated with `<br></br>`. Therefore new lines are ignored. They end all up in one huge line.\n\nhttps://github.com/Whonix/msgcollector/blob/master/usr/lib/msgcollector/msgdispatcher_dispatch_x","comments":[{"author":"Patrick","date_created":1421453763,"date_modified":1421453763,"content":"Example. Result...\n\n```\nJan 17 00:15:03.916 [notice] Tor v0.2.5.10 (git-43a5f3d91e726291) running on Linux with Libevent 2.0.19-stable, OpenSSL 1.0.1e and Zlib 1.2.7. Jan 17 00:15:03.916 [notice] Tor can't help you if you use it wrong! Learn how to be safe at https://www.torproject.org/download/download#warning Jan 17 00:15:03.916 [notice] Read configuration file \"/etc/tor/torrc\". Jan 17 00:15:03.918 [warn] /var/run/tor is not owned by this user (root, 0) but by debian-tor (106). Perhaps you are running Tor as the wrong user? Jan 17 00:15:03.918 [warn] Failed to parse/validate config: Couldn't access/create private data directory \"/var/run/tor\" Jan 17 00:15:03.918 [err] Reading config failed--see warnings above.\n```\n\nDesired:\n```\nJan 17 00:15:03.916 [notice] Tor v0.2.5.10 (git-43a5f3d91e726291) running on Linux with Libevent 2.0.19-stable, OpenSSL 1.0.1e and Zlib 1.2.7.\nJan 17 00:15:03.916 [notice] Tor can't help you if you use it wrong! Learn how to be safe at https://www.torproject.org/download/download#warning\nJan 17 00:15:03.916 [notice] Read configuration file \"/etc/tor/torrc\".\nJan 17 00:15:03.918 [warn] /var/run/tor is not owned by this user (root, 0) but by debian-tor (106). Perhaps you are running Tor as the wrong user?\nJan 17 00:15:03.918 [warn] Failed to parse/validate config: Couldn't access/create private data directory \"/var/run/tor\"\nJan 17 00:15:03.918 [err] Reading config failed--see warnings above.\n```\n"},{"author":"Patrick","date_created":1421453868,"date_modified":1421453868,"content":"@troubadour, do you think there is any good way to do this on the python level? (Without requiring us to do lots of formating changes...)\n\nOtherwise I guess I could also inject the `<br></br>` at the end of each line using a bash function."},{"author":"troubadour","date_created":1421530126,"date_modified":1421530126,"content":"There is no easy way to do this in msgdispatcher_dispatch_x. It just shows what it receives. The formatting of the messages is all done in whonixcheck and /usr/lib/msgcollector/msgcollector (pretty_type_x), and I don't think it makes sense to even try to do it at python level."},{"author":"Patrick","date_created":1421555811,"date_modified":1421555811,"content":"We indeed shouldn't mix this into msgdispatcher_dispatch_x.\n\n-----\n\nAre you any good at string manipulation stuff?\n\nMaybe you could write a small python tool that does the trick?\n\nFor testing purposes, suppose any input as this.\n\n```\nx=\"$(telnet -h 2>&1)\"\n```\n\nVariable `$x` will now contain the following content.\n\n```\ntelnet: invalid option -- 'h'\nUsage: telnet [-4] [-6] [-8] [-E] [-L] [-a] [-d] [-e char] [-l user]\n        [-n tracefile] [ -b addr ] [-r] [host-name [port]]\n```\n\nLet's say I was running something like this...\n\n```\nx=\"$(telnet -h 2>&1)\" ; ./some-python-script \"$x\"\n```\n\nCould you come up with an output that looks like this?\n\n```\ntelnet: invalid option -- 'h'<br></br>\nUsage: telnet [-4] [-6] [-8] [-E] [-L] [-a] [-d] [-e char] [-l user]<br></br>\n        [-n tracefile] [ -b addr ] [-r] [host-name [port]]\n```\n\nIn other words, can you append `<br></br>` at the end of every line but the last line?\n\nDon't put too much effort into this."},{"author":"troubadour","date_created":1421961041,"date_modified":1421961041,"content":"It's not that much a question of string manipulation than of finding a common mark in each line to place the extra html. Do we want a universal script?\n\nIn this:\n  Jan 17 00:15:03.916 [notice] Tor v0.2.5.10 (git-43a5f3d91e726291) running on Linux with Libevent 2.0.19-stable, OpenSSL 1.0.1e and Zlib 1.2.7. Jan 17 00:15:03.916 [notice] Tor can't help you if you use it wrong! Learn how to be safe at https://www.torproject.org/download/download#warning Jan 17 00:15:03.916 [notice] Read configuration file \"/etc/tor/torrc\". Jan 17 00:15:03.918 [warn] /var/run/tor is not owned by this user (root, 0) but by debian-tor (106). Perhaps you are running Tor as the wrong user? Jan 17 00:15:03.918 [warn] Failed to parse/validate config: Couldn't access/create private data directory \"/var/run/tor\" Jan 17 00:15:03.918 [err] Reading config failed--see warnings above.\nif there is no newlines, we could take the colon, providing the preceding characters(mmm dd hh) have always the same format/length.\n\nIn the telnet output example, in python, we would first have to know that we want to grab stderr, and replace \\n with ,br></br> \n\n  >>> repr(err)\n  '\"telnet: invalid option -- \\'y\\'\\\\nUsage: telnet [-4] [-6] [-8] [-E] [-L] [-a] [-d] [-e char] [-l user]\\\\n\\\\t[-n tracefile] [ -b addr ] [-r] [host-name [port]]\\\\n\"'\n\nThat's a lot of conditions.\n\n\n"},{"author":"troubadour","date_created":1421961263,"date_modified":1421961263,"content":"Was carired a little. ./some-python-script \"$x\" is possible if we have new lines"},{"author":"Patrick","date_created":1421962710,"date_modified":1421962710,"content":"> Do we want a universal script?\n\nYes, universal. To terminate any kind of terminal output\n\n> common mark in each line\n\nThe common mark is `\\n`, the newline character. Before (or after?) that, we need to inject `<br></br>`. Except for the last line."},{"author":"Patrick","date_created":1423082543,"date_modified":1423082543,"content":"How to append a string at the end of each line of a string in python?:\nhttps://stackoverflow.com/questions/28331040/how-to-append-a-string-at-the-end-of-each-line-of-a-string-in-python"},{"author":"troubadour","date_created":1423083327,"date_modified":1423083327,"content":"Forgot that one. Yeah, the solution is there. Only, do we expect a `\\n` at the end of the last line?"},{"author":"Patrick","date_created":1423084136,"date_modified":1423084136,"content":"Good question. Dunno. Is it important?\n\nDamn. Looks like I messed up that question highlighting \"except last line\"."},{"author":"troubadour","date_created":1423084557,"date_modified":1423084557,"content":"Dunno either. The question is, if it is there, do we want to strip it?"},{"author":"Patrick","date_created":1423085464,"date_modified":1423085464,"content":"We probably don't want to strip any `\\n` at all?"},{"author":"troubadour","date_created":1424897610,"date_modified":1424897610,"content":"I believe I made it complicated from the beginning. The following should do the job.\n```#!/usr/bin/python\nimport sys\nin_ = sys.argv[1]\nout = '<br />'.join(in_.split('\\n'))\nprint out```\n\nNote the `'<br />'`. Just found it.\n\nExample:\n```x=\"$(ls -l)\"\npython add_html.py \"$x\"```"},{"author":"Patrick","date_created":1424900017,"date_modified":1424900017,"content":"Looks good. Works fine! :)\n\nPerhaps change that line to.\n\n```\nout = '<br />\\n'.join(in_.split('\\n'))\n```\n\nThen it looks a bit better when running scripts using xtrace for debugging.\n\nCould you commit that to `usr/lib/msgcollector/br_add` or so? Not sure. Perhaps you have a better name in mind."},{"author":"Patrick","date_created":1424900066,"date_modified":1424900066,"content":"Ah. Overlooked `add_html`. Fine either way."},{"author":"troubadour","date_created":1424985158,"date_modified":1424985158,"content":">>! In T97#2559, @Patrick wrote:\n> Looks good. Works fine! :)\n> \n> Perhaps change that line to.\n> \n> ```\n> out = '<br />\\n'.join(in_.split('\\n'))\n> ```\n> \n> Then it looks a bit better when running scripts using xtrace for debugging.\nThe problem is that the `\\n` will be displayed literally in the html, not interpreted as new line."},{"author":"Patrick","date_created":1424986357,"date_modified":1424986357,"content":"I don't think so. It works for me. Perfectly. Example:\n\n(Stored the modified script as \"a\" for testing.)\n\n```\nx=\"$(cat --help)\"\n\nbr_added=\"$(./a \"$x\")\"\n\n/usr/lib/msgcollector/msgdispatcher_dispatch_x \"info\" \"test title\" \"$br_added\" \"\" \"\"\n```\n\n```\necho \"$br_added\"\nUsage: cat [OPTION]... [FILE]...<br />\nConcatenate FILE(s), or standard input, to standard output.<br />\n<br />\n  -A, --show-all           equivalent to -vET<br />\n  -b, --number-nonblank    number nonempty output lines, overrides -n<br />\n  -e                       equivalent to -vE<br />\n  -E, --show-ends          display $ at end of each line<br />\n  -n, --number             number all output lines<br />\n  -s, --squeeze-blank      suppress repeated empty output lines<br />\n  -t                       equivalent to -vT<br />\n  -T, --show-tabs          display TAB characters as ^I<br />\n  -u                       (ignored)<br />\n  -v, --show-nonprinting   use ^ and M- notation, except for LFD and TAB<br />\n      --help     display this help and exit<br />\n      --version  output version information and exit<br />\n<br />\nWith no FILE, or when FILE is -, read standard input.<br />\n<br />\nExamples:<br />\n  cat f - g  Output f's contents, then standard input, then g's contents.<br />\n  cat        Copy standard input to standard output.<br />\n<br />\nReport cat bugs to bug-coreutils@gnu.org<br />\nGNU coreutils home page: <http://www.gnu.org/software/coreutils/><br />\nGeneral help using GNU software: <http://www.gnu.org/gethelp/><br />\nFor complete documentation, run: info coreutils 'cat invocation'\n```\n\nThe `\\n` is not inside `$br_added`, so it won't be visible in the html either."},{"author":"troubadour","date_created":1424988193,"date_modified":1424988193,"content":"Nice demonstration. Was testing by adding `\\n` randomly in the text.\n\nAdded file `br_add` to msgcollector.\nhttps://github.com/troubadoour/msgcollector/commit/c68878afb05d9d9e5560fa819f3027b57ffd1918"},{"author":"Patrick","date_created":1424996579,"date_modified":1424996579,"content":"Merged.\n\nCan you please add a license header on top and a newline at the end?"},{"author":"troubadour","date_created":1425067287,"date_modified":1425067287,"content":"Done.\nhttps://github.com/troubadoour/msgcollector/commit/2e2c464bc503db257d08a9bb2b38018512b72de0"},{"author":"Patrick","date_created":1425067671,"date_modified":1425067671,"content":"Thanks! Merged. And added a minor fix on top (right order for license header and shebang).\nhttps://github.com/Whonix/msgcollector/commit/ef03b5dc44873e441207667df9b813a991c9fdd9\n"},{"author":"Patrick","date_created":1425571089,"date_modified":1425571089,"content":"Created a follow up task: T216\n\nAnything left to do here or closable, @troubadour?"},{"author":"troubadour","date_created":1425583609,"date_modified":1425583609,"content":"We can close it."}]},"PHID-TASK-z6ojpynnynz4i4fh3lo7":{"id":"96","title":"tb-updater should store and show last known signature creation date","status":"resolved","priority":"Normal","author":"Patrick","description":"Useful to detect downgrade or infinite freeze attack.","comments":[{"author":"Patrick","date_created":1421444598,"date_modified":1421444598,"content":"Done:\nhttps://github.com/Whonix/tb-updater/commit/d3fc92d010574f06f9db6384231a718a086abfd9"}]},"PHID-TASK-uqnafxfoic4nemmbrpas":{"id":"95","title":"tb-updater should show when signature was made and ask for confirmation","status":"resolved","priority":"Normal","author":"Patrick","description":"Useful to detect downgrade or infinite freeze attack.","comments":[{"author":"Patrick","date_created":1421441128,"date_modified":1421441128,"content":"Done:\nhttps://github.com/Whonix/tb-updater/commit/763fb38964e7c54abc777082747b61a877fc5176"}]},"PHID-TASK-jnaivhgs2gg7gswuuymy":{"id":"94","title":"research non-persistent entry guards","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"__older info__:\n\n* https://tor.stackexchange.com/questions/698/tracking-user-location-using-entry-guards (http://www.webcitation.org/6RTwwSWvw)\n* https://tor.stackexchange.com/questions/636/is-it-dangerous-to-use-tails-without-persistent-entry-guards (http://www.webcitation.org/6RTwx8bil)\n* Support more stable guards for live CDs: https://trac.torproject.org/projects/tor/ticket/2653\n* https://lists.torproject.org/pipermail/tor-talk/2012-October/subject.html#25975\n* https://lists.torproject.org/pipermail/tor-talk/2012-October/025980.html\n\n__update__:\n\nNumber of entry guards was reduced to 1 since then. (As per [changelog](https://gitweb.torproject.org/tor.git/tree/ChangeLog).)\n\n__see also__:\n\n* https://tails.boum.org/blueprint/persistent_Tor_state/\n* https://blog.torproject.org/blog/tor-weekly-news-%E2%80%94-june-17th-2015#A_persistent_Tor_state_for_Tails section `A persistent Tor state for Tails?`\n\n__TODO__:\n\n* Under the new situation of reduced number of default entry guards, ask the above questions again to see if situation has changed. \n\nDocumentation could explain how to stop the Tor service; wipe Tor's data dir; start Tor service; connect.\n\nEditing `/etc/tor/torrc` by adding the following could do the trick.\n\n```\nDataDirectory /var/run/tor\n```\n\nAfter every reboot, Tor would use new entry guards. Maybe extra AppArmor rules would be required.\n","comments":[{"author":"JasonJAyalaP","date_created":1421438504,"date_modified":1421438504,"content":"`Adding DataDirectory /var/run/tor to /etc/tor/torrc could do the trick. After every reboot, Tor would use new entry guards. Maybe extra AppArmor rules would be required.`\n\nSo, first, we need someone to study and test this and report back."},{"author":"Patrick","date_created":1421454145,"date_modified":1421454145,"content":"`/var/lib/tor` is owned by user/group `debian-tor`.\n`/var/run/tor` is owned by user/group `root`.\nTherefore using `DataDirectory /var/run/tor` in `/etc/tor/torrc` would maybe not be a great idea. (Would lead to permission issue.)\n\nMust be some non-persistent folder owned by user/group `debian-tor`."},{"author":"HulaHoop","date_created":1434916434,"date_modified":1434916523,"content":"A script on boot up that runs\n\nchgrp -R debian-tor /var/run/tor\n\ncan do it?\n\n\nhttp://ss64.com/bash/chgrp.html"},{"author":"Patrick","date_created":1434925408,"date_modified":1434925408,"content":"Seems like on jessie there is no permission issue anymore. `/var/run/tor` is owned by user/group `debian-tor` by default. Check `/etc/init.d/tor` function `check_torpiddir`. Therefore `/etc/tor/torrc` setting `DataDirectory /var/run/tor` works out of the box in Whonix 11.\n\n[`/usr/lib/whonixcheck/check_tor_pid`](https://github.com/Whonix/whonixcheck/blob/master/usr/lib/whonixcheck/check_tor_pid) in whonixcheck needs a patch. That whonixcheck test fails because it's hardcoded to `/var/run/tor/tor.pid`. For Whonix 11 purposed you could add to documentation to skip this test then.* \n\n*(Somewhat documented in `/etc/whonix.d/30_whonixcheck_default`. Create a file `/etc/whonix.d/50_user` with content `whonixcheck_skip_functions+=\" check_tor_pid \"`.)\n"},{"author":"Patrick","date_created":1434990158,"date_modified":1434990158,"content":"Where to add this? Not sure where this fits best.\n\nMaybe on https://www.whonix.org/wiki/Tor?\n\nLink from:\n\n* https://www.whonix.org/wiki/Documentation\n\nMaybe mentioned on:\n\n* https://www.whonix.org/wiki/Bridges and/or\n* https://www.whonix.org/wiki/Hide_Tor_and_Whonix_from_your_ISP\n"},{"author":"HulaHoop","date_created":1435001840,"date_modified":1435001840,"content":">Where to add this? Not sure where this fits best.\n>\n>Maybe on https://www.whonix.org/wiki/Tor?\n\nYes I added it there."},{"author":"Patrick","date_created":1435014590,"date_modified":1435014590,"content":"Good work! Added to https://www.whonix.org/wiki/Documentation. Moved/incorporated Tor chapter from https://www.whonix.org/wiki/Advanced_Security_Guide#Tor to https://www.whonix.org/wiki/Tor. Made some changes.\n\nOn https://www.whonix.org/wiki/Documentation the page https://www.whonix.org/wiki/Tor is listed under advanced topics. Non-ideal. Too buried. Not something regular users read.\n\nWhat about making https://www.whonix.org/wiki/Tor#Introduction a template (https://www.whonix.org/wiki/Template:Persistent_Entry_Guards_Introduction), and adding a new chapter to the https://www.whonix.org/wiki/Warning page 'Guard Relays can make you fingerprintable Across Different Physical Locations' or so? (Is \"fingerprintable\" the right term here?) What do you think? Could you do that please?"},{"author":"Patrick","date_created":1455125573,"date_modified":1455125573,"content":"https://www.whonix.org/wiki/Warning#Persistent_Tor_Entry_Guard_Relays_can_make_you_trackable_Across_Different_Physical_Locations\n"}]},"PHID-TASK-t7q7f2gbk2j27gxpj6hg":{"id":"93","title":"copy to clipboard button for mediawiki code boxes","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"A \"Copy to clipboard\" link above/below all code boxes. Either always visible or when you hover over it.\n\nInvestigate a mediawiki extension that doesn't require flash.\n\nAny idea how to implement it?","comments":[{"author":"Patrick","date_created":1421443979,"date_modified":1421443979,"content":"Could you please check out http://stackoverflow.com/questions/6355300/copy-to-clipboard-without-flash/9481957#9481957 (what fortasse mentioned [here](https://github.com/Whonix/Whonix/issues/69#issuecomment-23258825)), if that could be used to implement the copy to clipboard button? Or do you have any other thoughts here? @WhonixQubes"},{"author":"Linostar","date_created":1421479699,"date_modified":1421479699,"content":"Actually, that is an issue that has caused frustration to many js developers over the years.\n\nThere are many reasons why it isn't practical (or possible) to implement it with javascript:\n1- Cross-browser compatibility. Each browser handles the clipboard in a different way, and some are more picky than others.\n2- Privacy and Security. It is considered a security issue to allow the browser to write to the clipboard. If it can write there, it can also read, and the clipboard may occasionally contain sensitive information such as credit card numbers, passwords, etc copied by other applications or browser windows. Furthermore, in some browsers like Firefox, one needs to change a variable value in about:config in order to enable this functionality, and ugly message will appear asking the user for permission or warning him whenever javascript triggers a clipboard copy.\n\nFor those reasons, developers usually use third-party apps such as Flash to implement this feature. Not only it will look less ugly with Flash, but implementing it with javascript wouldn't be more secure than implementing it with Flash.\n\nThe example linked to in the comment above, that uses jQuery, does not in fact copy the text to clipboard. All it does is to select the text for the user so he/she can press CTRL+C to copy it. Needless to say, it is a method that can be coded with js only without requiring jQuery. It is like half a solution, where you do the selection (which may spare the user the effort when the content to select is large) and leave the other half of the copying procedure to the user fingers. It's an approach that is somewhat popular among those who want to rely only on javascript.\n\nI tested myself many js snippets in the past, that claim to do the job completely, and found that most of them don't work anymore (use deprecated functions) or work only for certain browsers and with certain constraints and limitations. I suggest that making a \"select all text\" button is sufficient, since anything beyond isn't worth the effort.\n\nSorry for the short essay... err... the long post."},{"author":"Patrick","date_created":1421628831,"date_modified":1421628831,"content":"Okay. If that is most we can do, then we should go for it. I think I saw such a box before somewhere. Dunno where. But it's useful, no?\n\nWould you know how to implement it in the wiki? Could you try on some test page such as https://www.whonix.org/wiki/Translatetest please?\n\nUsually we're using the `<pre>` tag for stuff that is supposed to be copied.\n\n```\n<pre>\ntest text box here\n</pre>\n```\n\nWe can also use the `<html>` tag.\n\nWhen it works, we should be able to make that a mediawiki template."},{"author":"crackman","date_created":1421630581,"date_modified":1421630581,"content":"Hey guys,\nif we wait a while it might become more commonplace and then we could potentially get this to work.\nthere's api support within HTML5 called ClipboardEvent.\nit's currently supported by Firefox only, but i'm hoping other browsers will add support.\n\ncheck out http://stackoverflow.com/questions/23238236/using-the-clipboard-api-throws-error-is-not-defined \ndo remember it's not universally supported yet, so it might not be the best to work with right now.\nbut it's something to consider :)"},{"author":"Patrick","date_created":1421632556,"date_modified":1421632556,"content":"Forgot to say... This shouldn't make things worse for users that have javascript disabled or using browser that don't have that feature yet.\n\nGiven that, I don't think we need to wait? We could deploy it now and then wait for browser supporting it?\n\nCould you try getting up a demo using ClipboardEvent on the https://www.whonix.org/wiki/Translatetest2 please?\n"},{"author":"crackman","date_created":1421644554,"date_modified":1421644554,"content":"Patrick,\nTrying a bit now. Can you enable javascript in the wiki settings somewhere for the testing to work?\nAs it stands I cannot make any javascript work - it gets read as text rather than a script.\n\nMake sure you can only enable in that one page, lest someone try to hijack the site.\nIf we cannot get Javascript to work, we'll have to just leave it as \"user selects, copies, pastes themselves\""},{"author":"Linostar","date_created":1421682596,"date_modified":1421682596,"content":">>! In T93#1044, @crackman wrote:\n> Patrick,\n> Trying a bit now. Can you enable javascript in the wiki settings somewhere for the testing to work?\n> As it stands I cannot make any javascript work - it gets read as text rather than a script.\n> \n> Make sure you can only enable in that one page, lest someone try to hijack the site.\n> If we cannot get Javascript to work, we'll have to just leave it as \"user selects, copies, pastes themselves\"\n\nJavascript is enabled by default in the wiki. You just forgot to enclose your <script> tags within <html> tags.\n\nSince ClipboardEvent API works only on Firefox currently, the same goes for it as I explained in my previous comment. It isn't practical to deploy a solution that won't work for some of the users.\n\nI'll work on making a template for the \"select code\" button."},{"author":"Patrick","date_created":1421683059,"date_modified":1421683059,"content":"Javascript is enabled and the test popup is working. Security is not an issue here. We are using [FlaggedRevs](https://www.mediawiki.org/wiki/Extension:FlaggedRevs) extension. New edits won't be shown to regular users by default as long as admins have not confirmed these changes."},{"author":"Linostar","date_created":1421683838,"date_modified":1421683838,"content":">>! In T93#1046, @Patrick wrote:\n> Javascript is enabled and the test popup is working. Security is not an issue here. We are using [FlaggedRevs](https://www.mediawiki.org/wiki/Extension:FlaggedRevs) extension. New edits won't be shown to regular users by default as long as admins have not confirmed these changes.\n\nI forgot to mention that I added the forgotten <html> tags so the script can work. It wasn't working before, just as crackman said.\n\nPatrick, can you give me the privilege necessary for creating a Template page on the wiki. My username there is Linostar."},{"author":"Patrick","date_created":1421684005,"date_modified":1421684005,"content":"Yes, you are now wiki admin."},{"author":"Linostar","date_created":1421866366,"date_modified":1421866495,"content":"I managed to do it. I found that there are some constraints on javascript code in wikimedia and the normal selecting methods don't work. As a workaround, I had to substitue the <pre> element with a <textarea> element and changed the style of the latter to look like the former. \n\nThe template can be used as in the following syntax:\n**{{CodeSelect|**//number_of_rows//**|**//actual_code_goes_here//**}}**\n\nNote: If your code is longer in lines that the number_of_rows you specified, a vertical scrollbar will auto-appear.\n\nYou can find a working example here:\nhttps://www.whonix.org/wiki/Translatetest4"},{"author":"Patrick","date_created":1421952586,"date_modified":1421952586,"content":"Nice template!\n\nCould you make it work for special chars such as `=`?\n\nCould you the `Select code` to the right side and make it a very small `[select code]`? I think that is the \"standard\" for such boxes? Unless someone else has a better suggestion for the style?\n\nCan you make it disappear when javascript is disabled? Probably not?"},{"author":"Linostar","date_created":1421955148,"date_modified":1421955203,"content":"I made a change that gets '=' to display properly instead of being a treated as a part of the template. As consequence, the new syntax for the template has become:\n**{{CodeSelect**|//number_of_rows//|**code=**//actual_code_goes_here//**}}**\n\nSee https://www.whonix.org/wiki/Translatetest4 for examples.\n\nI moved the button to the right and made its caption in small chars. Is that how you want it to look like?\n\nFurthermore, I just made it so the button disappear when javascript is disabled. It turns out it's not impossible ;-)\n"},{"author":"Patrick","date_created":1422020542,"date_modified":1422020542,"content":"Can the number of rows be auto detected?\n\n> Is that how you want it to look like?\n\nNot exactly. Can the \"button-style\" be removed? I mean, the removing the gray surrounding. Using blue color. Text: `[select code]`. And text size -3.\n\nBut that's not super important. Just what I think looks best. I also go with whatever others suggest for a good style.\n\n> It turns out it's not impossible\n\nAmazing!"},{"author":"Linostar","date_created":1422022916,"date_modified":1422022916,"content":">>! In T93#1110, @Patrick wrote:\n> Can the number of rows be auto detected?\n\nI am afraid not. Yes, it can be done with javascript, but if javascript is disabled, the code boxes will just look ugly.\n\n>> Is that how you want it to look like?\n> \n> Not exactly. Can the \"button-style\" be removed? I mean, the removing the gray surrounding. Using blue color. Text: `[select code]`. And text size -3.\n> \n> But that's not super important. Just what I think looks best. I also go with whatever others suggest for a good style.\n\nThe button can be customized. If you can show me an example (e.g. a webpage or an image) of what you have in mind, it'll be easier to make it look exactly like that.\n"},{"author":"Patrick","date_created":1422068215,"date_modified":1422068215,"content":"> I am afraid not. Yes, it can be done with javascript, but if javascript is disabled, the code boxes will just look ugly.\n\nHow does the `<pre>` tag do this then? Would require a mediawiki extension then?\n\n> The button can be customized. If you can show me an example (e.g. a webpage or an image) of what you have in mind, it'll be easier to make it look exactly like that.\n\nHaven't found a website, but the html code is simple.\n\n```\n<a href=just-to-make-it-look-blue>\n<font size=-3>[select code]</font>\n</a>\n```\n\nHere is a screnshot.\nScreenshot:\n{F27}\n"},{"author":"Linostar","date_created":1422086464,"date_modified":1422086464,"content":">>! In T93#1114, @Patrick wrote:\n>> I am afraid not. Yes, it can be done with javascript, but if javascript is disabled, the code boxes will just look ugly.\n> \n> How does the `<pre>` tag do this then? Would require a mediawiki extension then?\n> \n\n<pre> is like <div>, they autoresize based on their content because they are gifted elements of the DOM family (so it is done internally without javascript). Unfortunately, <textarea> is not gifted and pampered like them, and we seem to be stuck with <textarea> due to the restrictions on the 'window' object imposed by mediawiki.\n\n> <a href=just-to-make-it-look-blue>\n> <font size=-3>[select code]</font>\n> </a>\n> ```\n> \n> Here is a screnshot.\n> Screenshot:\n> {F27}\n\nDone. See https://www.whonix.org/wiki/Translatetest4 (I made it \"font size  = -2\" since -3 seems too small for my eyes)."},{"author":"Patrick","date_created":1422122312,"date_modified":1422122312,"content":"Looks perfect."},{"author":"Patrick","date_created":1422533300,"date_modified":1422533300,"content":"We needed to disable raw html (the `<html>` tag) for security reasons [otherwise evil javascript could steal admin cookies due to edits by non-admin users] and are now using the safer [Extension:Widgets](https://www.mediawiki.org/wiki/Extension:Widgets).\n\nTherefore moved https://www.whonix.org/wiki/Template:CodeSelect to https://www.whonix.org/wiki/Widget:CodeSelect.\n\nThe `Widget:` namespace does not support mediawiki variables (such as `{{{1}}}`) directly, but also supports parameters. See:\nhttps://www.mediawiki.org/wiki/Extension:Widgets#Usage\n\nSee also example widget:\nhttps://www.whonix.org/wiki/Widget:Share\n\nAnd how to use it in an example template:\nhttps://www.whonix.org/wiki/Template:Share\n\nHaving said that... Does anything change? I guess we can still use your CodeSelect code if we adjust the parameter syntax?\n\nCan we now somehow auto detect number of rows?\n\nTo manually enter the number of rows would be kinda cumbersome. If you look through the wiki, how often we are using the `<pre>` tag, if we were to change them all by hand and not forget updating that number each time the content is changed, that would be kind hard. So maybe, if it doesn't work with special chars such as `=` as first char, could rows be auto detected?"},{"author":"Linostar","date_created":1422534383,"date_modified":1422534383,"content":"Does not seem that widgets allow html/js code on their own when raw html is disabled, as in your:\nhttps://www.whonix.org/wiki/Widget:Share\n\nPerhaps you should enable <html> tags only in template pages instead? (if that's possible)\n\nAs for detecting row numbers, the best I can come with is the following: if javascript is enabled, detect row numbers and adjust the height accordingly using js; if js is disabled, then display the textarea with fixed row number (6 for example) and vertical scrolling arrows if number of rows exceed 6.\n\nHow does that sound?"},{"author":"Patrick","date_created":1422535088,"date_modified":1422535088,"content":"> Does not seem that widgets allow html/js code on their own when raw html is disabled, as in your:\n> https://www.whonix.org/wiki/Widget:Share\n\nNot sure I understand. The raw html is not correctly rendered on that https://www.whonix.org/wiki/Widget:Share page. But the calling page https://www.whonix.org/wiki/Template:Share shows the correctly rendered html that is based on the widget page's html code.\n\n> Perhaps you should enable <html> tags only in template pages instead? (if that's possible)\n\nUnfortunately, that's not possible. (Not saying it's impossible, but would require writing a mediwiki extension for that and html extensions getting right seems very hard - judged by all the attempts that were made in past.)\n\n> As for detecting row numbers, the best I can come with is the following: if javascript is enabled, detect row numbers and adjust the height accordingly using js; if js is disabled, then display the textarea with fixed row number (6 for example) and vertical scrolling arrows if number of rows exceed 6.\n\n> How does that sound?\n\nBetter but still impractical.\n\nIf you go to https://www.whonix.org/wiki/Special:ReplaceText - be careful with that one - and enter `<pre>` as search term, then continue and look at the results... And then abort... You see how many times we are using that tag. Going through all of them would be a lot work and I am sure editors would be confused and/or mess up entering correct row number."},{"author":"Linostar","date_created":1422538903,"date_modified":1422538903,"content":">>! In T93#1312, @Patrick wrote:\n>> Does not seem that widgets allow html/js code on their own when raw html is disabled, as in your:\n>> https://www.whonix.org/wiki/Widget:Share\n> \n> Not sure I understand. The raw html is not correctly rendered on that https://www.whonix.org/wiki/Widget:Share page. But the calling page https://www.whonix.org/wiki/Template:Share shows the correctly rendered html that is based on the widget page's html code.\n> \n>> Perhaps you should enable <html> tags only in template pages instead? (if that's possible)\n> \n> Unfortunately, that's not possible. (Not saying it's impossible, but would require writing a mediwiki extension for that and html extensions getting right seems very hard - judged by all the attempts that were made in past.)\n\n\nMy mistake. I assumed the widget would render correctly on its own page like template pages do. Since the widget can render html tags correctly, I'll make the necessary changes so the 'code' parameter is replaced properly in the widget.\n\n>> As for detecting row numbers, the best I can come with is the following: if javascript is enabled, detect row numbers and adjust the height accordingly using js; if js is disabled, then display the textarea with fixed row number (6 for example) and vertical scrolling arrows if number of rows exceed 6.\n> \n>> How does that sound?\n> \n> Better but still impractical.\n> \n> If you go to https://www.whonix.org/wiki/Special:ReplaceText - be careful with that one - and enter `<pre>` as search term, then continue and look at the results... And then abort... You see how many times we are using that tag. Going through all of them would be a lot work and I am sure editors would be confused and/or mess up entering correct row number.\n\nI think you misunderstood me a bit. By making a default value for the number of rows, it means we need not to insert the row number manually in the widget tag. If javascript is enabled, the default value will be overrided based on the height of the element. Otherwise, vertical scrollbars (if js is disabled) will show to allow the users to scroll within the CodeSelect element."},{"author":"Linostar","date_created":1422618212,"date_modified":1422618354,"content":"I've added the auto-resizing feature. You can test with js enabled/disabled to see how it would look on:\nhttps://www.whonix.org/wiki/Translatetest5\n\nFurthermore, I made the template page use the CodeSelect widget instead of redirecting to the widget page. That way, you can write: {{CodeSelect|code=<your code here>}} which is a bit easier (from a wiki editor perspective) than putting a widget tag. But both will lead to the same result (see the sources of Template:CodeSelect and Translatetest5 for more info)."},{"author":"Patrick","date_created":1422766646,"date_modified":1422766646,"content":"Without javascript, it's too much scrolling. Just two lines are visible. The rest needs to be scrolled.\n\nDid you remove the configure lines number feature?\n\nHere is an good example, on how we are using the `<pre>` tag:\nhttps://www.whonix.org/wiki/Security_Guide#Updates\n\nI am afraid to say, manually counting the number of lines, adjusting that for the whole wiki looks like too impractical, because that would be too much work. And fail, as soon as the content within that tag is changed, I am sure wiki editors would forget the update the number of lines.\n\nCould the line number without javascript feature be implemented using a mediawiki extension?\nhttps://www.mediawiki.org/wiki/Manual:Developing_extensions\n\nWe could look if we find a similar extension that implements a different `<tag>` and see how they implemented that. Surely it could then be \"gifted\"?\n\nNot sure if that would be overkill / too much work."},{"author":"Linostar","date_created":1422774423,"date_modified":1422774423,"content":"The problem is that mediawiki doesn't allow full access (or any access) to the //window// object in javascript. That's why I am unable to select the contents of an element unless it is an //input text// or a //textarea//, both containing an embedded selecting function and don't need to use the //window// object.\n\nI'll look into mediawiki extensions. Hopefully, we'll find some kind of solution there."},{"author":"Linostar","date_created":1422962723,"date_modified":1422962723,"content":"I was too blind to see the most obvious solution! No need to use mediawiki extensions even.\n\nI fixed it! Now, a user with js disabled will see the code box with auto height. No need to hardcode the number of rows anymore (whether js is enabled or not).\n\nWhat did I do?\ntldr;\nDisplay a normal <pre> if js is disabled, and an auto-height selectable <textarea> if js is enabled.\n\nReason: We aren't showing the \"[select code]\" anyway for users with js disabled, so why bother show them a textarea. It is better to show them a pre element that has the auto-height gift by default.\n\nYou can test the results on: https://www.whonix.org/wiki/Translatetest5\n\nI think that's the last issue in this bug, or is there anything else?"},{"author":"Patrick","date_created":1422982061,"date_modified":1422982061,"content":"Awesome, nice and simple fix!\n\nJust a minor thing, can we abolish the `code=` part for the template?"},{"author":"Linostar","date_created":1422985906,"date_modified":1422985941,"content":"Unfortunately, it is necessary to keep it. Without it, any code that contains a '=' will face a problem.\n\nFor example, if you have a this code:\n\n```\na=15;\nprint(a);\n```\n\nIf you write \n```{{CodeSelect|a=15;\nprint(a);}}```\n\nthe template will think that **a** is a template variable, and everything after the '=' sign will be treated as the value of this variable. And since there is no variable called **a** anywhere in the template code I've written, no text will appear in the code box.\n\ntldr;\nAttributing a parameter name (such as **code**) is necessary so any '=' is properly escaped and not considered as part of the template code."},{"author":"Patrick","date_created":1422986800,"date_modified":1422986800,"content":"Okay, alright.\n\n-----\n\nAs a personal matter of taste, instead of writing the following style (a)\n\n```\n{{CodeSelect|code=sudo apt-get update}}\n```\n\nI prefer to write the following style (b)\n\n```\n{{CodeSelect|code=\nsudo apt-get update\n}}\n```\n\nBecause then I can abstract the \"markup magic\", forget about it, and just concentrate on what I really wanted to write.\n\nThere is no difference at the moment and I guess I am lucky it is parsed that way.\n\n-----\n\nCurrently doing a beta test here:\nhttps://www.whonix.org/wiki/Security_Guide\n\nThere is one issue. When writing this (b) [but same as (a)], i.e. just using a single line, with javascript enabled...\n\n```\n{{CodeSelect|code=\nsudo apt-get update\n}}\n```\n\nWithin the CodeSelect area, it adds an extra empty line after \"sudo apt-get update\" at the bottom. Can this be fixed?\n\nAlso there is a bit much space between\nnormal text area and\nCodeSelect area\nand next normal text area.\n\nCould you fix that as well please?"},{"author":"Linostar","date_created":1422995797,"date_modified":1422995852,"content":"> Within the CodeSelect area, it adds an extra empty line after \"sudo apt-get update\" at the bottom. Can this be fixed?\nFixed.\n\n> Also there is a bit much space between\n>normal text area and\n>CodeSelect area\n>and next normal text area.\n>Could you fix that as well please?\nThe apparently extra space you see is because **[select code]** is aligned to the right, leaving much space on the left that is looking like a blank line, especially when the line above it is short.\nOther than that, the space is the standard space between paragraphs in wikis, and it looks like this value can't be easily reduced (I tried but it seems that mediawiki css rules are overriding my css rules)."},{"author":"Patrick","date_created":1423005370,"date_modified":1423005370,"content":"Please read this security advice about editing MediaWiki:Common.css:\nhttps://www.whonix.org/wiki/Dev/CSS\n\nThen... Perhaps you could make the required css changes on the https://www.whonix.org/wiki/MediaWiki:Common.css page? I'd speculate, that you have a lot more freedom there.\n\nAnd if all cords break, I think using mediawiki skins (we are using this one: https://github.com/OSAS/strapping-mediawiki which is open source) one has an almost unlimited options for customization?"},{"author":"Linostar","date_created":1423085868,"date_modified":1423085868,"content":">>! In T93#1398, @Patrick wrote:\n> Please read this security advice about editing MediaWiki:Common.css:\n> https://www.whonix.org/wiki/Dev/CSS\n> \n> Then... Perhaps you could make the required css changes on the https://www.whonix.org/wiki/MediaWiki:Common.css page? I'd speculate, that you have a lot more freedom there.\n> \n> And if all cords break, I think using mediawiki skins (we are using this one: https://github.com/OSAS/strapping-mediawiki which is open source) one has an almost unlimited options for customization?\n\nUnfortunately, css rules in MediaWiki:common.css didn't have the desired effect either (or I am doing it wrong, but I don't think it is the case). Personally, I think it looks acceptable as it currently is."},{"author":"Linostar","date_created":1423491861,"date_modified":1423492009,"content":"I have decided to give it another chance, and got some results. I found that the problem wasn't in the <div> tags, but because of the <textarea>. It turns out that <textarea> has a default margin-bottom value of 10px. I changed that value to 0, which shortened the distance between the CodeSelect box and the line(s) after.\n\nYou can see the result on: http://www.whonix.org/wiki/Translatetest6"},{"author":"Patrick","date_created":1423493036,"date_modified":1423493036,"content":"It looks better.\n\nDo you think the extra spaces can be further reduced?\n\nSee:\nhttps://www.whonix.org/wiki/Security_Guide#Updates\n(Between \"Should look similar to this.\" and the next code block there is too much space for my taste.)"},{"author":"Linostar","date_created":1423505590,"date_modified":1423505590,"content":">>! In T93#1727, @Patrick wrote:\n> It looks better.\n> \n> Do you think the extra spaces can be further reduced?\n> \n> See:\n> https://www.whonix.org/wiki/Security_Guide#Updates\n> (Between \"Should look similar to this.\" and the next code block there is too much space for my taste.)\n\nYes! I removed all the whitespace above the `[select code]` link. Now, there is nothing else except for the standard paragraph spacing in mediawiki. See https://www.whonix.org/wiki/Translatetest6 where I added a long line to illustrate better the distance between the link and what's above."},{"author":"Patrick","date_created":1423533399,"date_modified":1423533399,"content":"Looks better. Yes. Makes sense.\n\nIs it possible to limit the line length, so there can be reserved space for `[select code]`, to further reduce space between text and code boxes?"},{"author":"Linostar","date_created":1423554306,"date_modified":1423554306,"content":"You mean you want `[select code]` link inside the box instead of outside?"},{"author":"Patrick","date_created":1423555754,"date_modified":1423555754,"content":"No.\n\nTo use less space between text and `[select code]`, I was thinking to introduce some \"invisible table\" in the whole textarea. Normal text lines get the left 95% of space. And `[select code]` on the right gets the rest 5% (or how little) space.\n\nIn other words, that way even super long lines like on https://www.whonix.org/wiki/Translatetest6 would not interfere with `[select code]`.\n\nIn the current example, the line would just be `sad fsfsnjksffdgd sfgdgdggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggggg f . A very long` and then broken. Therefore `[select code]` could move up."},{"author":"Linostar","date_created":1423558905,"date_modified":1423558905,"content":"Nope. Controlling something outside the widget is not possible from inside the widget, especially when the lines outside are put in `<p>` element, which is an element that does not possess a `width` attribute.\n\nI propose moving the `[select code]` link to the left. That will make the gap disappear."},{"author":"Patrick","date_created":1423563607,"date_modified":1423563607,"content":"Could it be done using https://www.whonix.org/wiki/MediaWiki:Common.css or the theme?"},{"author":"Linostar","date_created":1423565024,"date_modified":1423565024,"content":"Making only the lines before a `CodeSelect` shorter is not possible, because you can't know what element comes next or before in css. Making all lines shorter is possible perhaps, but will likely break the layout of other elements and the page."},{"author":"Patrick","date_created":1423568307,"date_modified":1423568307,"content":"Okay, I see. So without having this feature natively supported by the skin or even mediawiki itself, there is no way?\n\nWhat about moving `[select code]` inside the codebox? Is that even possible? Optically non-ideal, but in my opinion still better than the gap. Users who manually select `select all`, would they also select the text `[select code]` or could that be made exempt?"},{"author":"Linostar","date_created":1423571320,"date_modified":1423571320,"content":">>! In T93#1816, @Patrick wrote:\n> What about moving `[select code]` inside the codebox? Is that even possible? Optically non-ideal, but in my opinion still better than the gap. Users who manually select `select all`, would they also select the text `[select code]` or could that be made exempt?\n\nLike this?\nhttps://www.whonix.org/wiki/Security_Guide#Updates"},{"author":"Patrick","date_created":1423571709,"date_modified":1423571709,"content":"Yes."},{"author":"Patrick","date_created":1423573900,"date_modified":1423573900,"content":"Closeable or anything left to do here?"},{"author":"Linostar","date_created":1423574393,"date_modified":1423574393,"content":"Closeable."}]},"PHID-TASK-tru2mzonjyh5kn763db6":{"id":"92","title":"apt-transport-tor installed by default","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"https://packages.debian.org/jessie/apt-transport-tor should be installed by default.","comments":[{"author":"Patrick","date_created":1432387374,"date_modified":1432387374,"content":"`added apt-transport-tor to anon-shared-packages-recommended - https://phabricator.whonix.org/T92`:\nhttps://github.com/Whonix/anon-meta-packages/commit/f4153f36cfbe8fec8a13839e775ae93152de48f7"}]},"PHID-TASK-zh27bjb34uy6huihxffd":{"id":"91","title":"64bit vs 32bit","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"64 vs 32 vs pae vs i686 amd-intel etc is confusing to the user.\n\nCan we go all 64bit? 32 is less and less common, and Whonix has never targeted low end hardware.\n\nI believe that we'll benefit more from simplicity (64-bit only) than compatibility.\n\nThere's a documentation issue: where do we tell the user how many bits we are? We could tie ourselves in `knots` naming files and putting big notices on the wiki, but I don't think it will make a difference. 64 bits is the new default and users shouldn't have to worry about it. \n\nMigrated from / `knots`:\nhttps://github.com/Whonix/Whonix/issues/85","comments":[{"author":"Patrick","date_created":1513626698,"date_modified":1513626698,"content":"Whonix 14 is 64 bit only."}]},"PHID-TASK-bfa7qbqtjccvdhtyizwn":{"id":"90","title":"Whonix Tor Controller","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"A GUI/CLI that monitors and controls the Tor connection.\n\nGateway:\n  - new circuit\n  - see Tor status (connected, problem, etc.)\n  - First Time Connection Wizard\n  - setting up (private) (obfuscated) bridges\n  - setting up flash bridges\n  - view Tor logs\n  - restart Tor\n  - run TimeSync\n  - [newnym](https://github.com/Whonix/Whonix/issues/102)\n  - torify Windows (textual feature)\n  - torify Other Operating System (textual feature)\n\nWhonix-Workstation\n  - check if Whoinx-Gateway is reachable\n  - check Tor status on Whonix-Gateway\n  - advise to start on Whonix-Gateway, in case it's not running\n  - get notified about events from Whonix-Gateway\n  - [newnym](https://github.com/Whonix/Whonix/issues/102)\n\n\n@HulaHoop says:\n1.not to implement the functions already being done by arm\n2.designing around the concept that there is no communication between gw and ws.\n\nForum discussion:\nhttps://forums.whonix.org/t/whonix-setup-wizard-graphical-technical-discussion\n\nPrevious discussion of newnym tool:\nhttps://github.com/Whonix/Whonix/issues/102\n\nRelated:\n* T89\n* T72","comments":[{"author":"goldstein","date_created":1443108366,"date_modified":1443108366,"content":"Hi there ,\ni am currently working on this ticket and got some questions.\nHow much control do you want on those options ?\n\n    new circuit (do we want to build custom circuits , extend circuits and so on or just create some ?) (either way already done)\n    see Tor status (connected, problem, etc.) (isnt this handled by arm?)\n    First Time Connection Wizard (Why do we need this when we already got whonixcheck etc ?)\n    view Tor logs (working on that)\n    restart Tor (done)\n    run TimeSync (is this still needed ?)\n    newnym (done)\n    get notified about events from Whonix-Gateway (working on that)\n    \ndo we want to aim this tool for advanced and novice users ? \n\nthe Cli part is almost done , so please stop me if some of this is not needed anymore \n"},{"author":"Patrick","date_created":1443208123,"date_modified":1443208123,"content":">>! In T90#6754, @goldstein wrote:\n> i am currently working on this ticket and got some questions.\n\n> How much control do you want on those options ?\n\n>     new circuit (do we want to build custom circuits , extend circuits and so on or just create some ?) (either way already done)\n\nJust signal newnym. No custom circuits. No extend circuits. Easy.\n\n>     see Tor status (connected, problem, etc.) (isnt this handled by arm?)\n\narm causes loads of confusion. (https://www.whonix.org/wiki/Tor_Controller#Arm_FAQ)\n\n>     First Time Connection Wizard (Why do we need this when we already got whonixcheck etc ?)\n\nRight. #whonix-setup-wizard does this already. So we don't need this in Whonix Tor Controller. This ticket is already very old and has not been updated since.\n\n>     view Tor logs (working on that)\n\nUseful.\n\n>     run TimeSync (is this still needed ?)\n\nNo. We get sdwdate-gui (tray icon).\n\n>     get notified about events from Whonix-Gateway (working on that)\n\n> do we want to aim this tool for advanced and novice users ? \n\nnovice users.\n\n> the Cli part is almost done , so please stop me if some of this is not needed anymore \n\nGood question. @bnvk is an UI designer. I don't know if he is ready yet to suggest what will be useful and how.\n\nI am also wondering now if it should become a \"Whonix Tor Controller\" or general \"Tor Controller\"."},{"author":"Patrick","date_created":1443209496,"date_modified":1443209496,"content":"A lot has changed since this ticket has been created. So I disagree with \"not to implement the functions already being done by arm\".\n\n> Whonix-Gateway\n\n>  - setting up (private) (obfuscated) bridges\n\nSeems difficult. Maintenance intensive. Not sure if you would be up to maintain this?\n\nThe real long term plan for the time being was:\nhttps://phabricator.whonix.org/T118\n\n>  - setting up flash bridges\n\nEven more difficult.\n\n>  - torify Windows (textual feature)\n>  - torify Other Operating System (textual feature)\n\nDifferers per per supported platform. Doable.\n\n-----\n\n> Whonix-Workstation\n> - check if Whoinx-Gateway is reachable\n> - advise to start on Whonix-Gateway, in case it's not running\n\nPerhaps useful alternative diagnosis tool as alternative to whonixcheck. Not really sure we need this since it's probably hard to provide better advice than whonixcheck.\n\n>  - check Tor status on Whonix-Gateway\n>  - get notified about events from Whonix-Gateway\n\nNot good.\n\n>  - [newnym](https://github.com/Whonix/Whonix/issues/102)\n\nHm.\n\n-----\n\nAll in all, this ticket is a disaster. Not actionable. We need an updated proposal on what we're trying to accomplish without stretching it too much. For example if we want a Tor Controller, we should leave Whonix-Workstation out.\n\nI hope you're not deterred by that @goldstein."},{"author":"goldstein","date_created":1443279162,"date_modified":1443279162,"content":"Is there anyway we can chat ? (got some more questions)\n\nIm currently rewriting the whole thing as im still learning the stem api so its no big deal to implement/remove stuff\nI just need some pointers where the whole thing needs to go or if theres even a need for something like this\n\n"},{"author":"goldstein","date_created":1443549967,"date_modified":1443549967,"content":">setting up (private) (obfuscated) bridges\n>Seems difficult. Maintenance intensive. Not sure if you would be up to maintain this?\nlooking into it , but i doubt this could be useful for novice users (but i like it)\n\n> Perhaps useful alternative diagnosis tool as alternative to whonixcheck. Not really sure we need this since it's probably hard to provide better advice than whonixcheck.\nI need to check the whonixcheck source but theres some useful stuff stem could provide there\n\n> setting up flash bridges\n>Even more difficult.\nlooking into it\n\n>arm causes loads of confusion. (https://www.whonix.org/wiki/Tor_Controller#Arm_FAQ)\ni see, found some good to have features for arm : https://trac.torproject.org/projects/tor/wiki/doc/arm#ClientModeUseCases\nThis is the purpose why i started developing this tool , arm kinda sucks for novice users \n\n>I am also wondering now if it should become a \"Whonix Tor Controller\" or general \"Tor Controller\".\nWhonix Tor Controller would be better i think.\n\n> I hope you're not deterred by that @goldstein.\nnah, im glad to help\n\n\n\n\n\n\n\n"},{"author":"Patrick","date_created":1443964770,"date_modified":1443964770,"content":"Just back from the Tor summer dev meeting. Idea T118 has been abandoned. (T118#6811) Pluggable transports will not change that often.\n\nTherefore, now there is some useful work to do. Implementing a [Tor Bridge](https://www.whonix.org/wiki/Bridges) (circumvention) wizard.\n\nDo you know tor-launcher ([screenshots](https://www.whonix.org/wiki/Dev/tor-launcher))? Could you look at the latest version that comes with TBB please? And then copy/re-implement its GUI design? I.e. work on [whonix-setup-wizard](https://github.com/Whonix/whonix-setup-wizard)?\n\n(No Tor Project logo. Initially, only obfs3 and obfs4 bridge support. Later, once meek has been packaged, also meek.)"},{"author":"goldstein","date_created":1443969628,"date_modified":1443969628,"content":">Implementing a Tor Bridge (circumvention) wizard.\nto add Bridges to the torrc or to setup a bridge ?\n>Do you know tor-launcher (screenshots)?\nyes\n>Could you look at the latest version that comes with TBB please? And then copy/re-implement its GUI design? \ngoing to look at it , what do you mean by re-implement / copy its design ? \n> I.e. work on whonix-setup-wizard?\nyou want to add the bridge feature to whonix-setup-wizard and to look like the tor-launcher (im kinda confused here)\n>(No Tor Project logo. Initially, only obfs3 and obfs4 bridge support. Later, once meek has been packaged, also meek.)\nk"},{"author":"Patrick","date_created":1443975482,"date_modified":1443975482,"content":">>! In T90#6816, @goldstein wrote:\n>>Implementing a Tor Bridge (circumvention) wizard.\n> to add Bridges to the torrc or to setup a bridge ?\n\nA setup wizard (similar to tor-launcher) adding a bridge to torrc.\n\n> what do you mean by re-implement / copy its design ?\n\nBy design I meant here, how tor-launcher GUI is looking. How its windows are looking. The UX, user experience. Using the same or very similar textual strings.\n\nUsing tor-launcher's style and then improving whonix-setup-wizard doing this.\n\n> you want to add the bridge feature to whonix-setup-wizard and to look like the tor-launcher\n\nYes.\n\n(At the moment, whonix-setup-wizard bridges feature is only a textual help. Cannot actually add/remove something to/from torrc.) (Back then, the bridge feature seemed daunting and a T118 seemed to be the way to go. But now it got clear, that a T118 is no option and that re-implementing the bridge wizard is the way forward to improve bridge/circumvention usability.)"},{"author":"goldstein","date_created":1444020267,"date_modified":1444071430,"content":">Using tor-launcher's style and then improving whonix-setup-wizard doing this\nK, going to work on that \n\nShould I create a new Issue for that ? \n\nI still think a Whonix-Tor-Controller would be nice to manage all tor/whonix related stuff in one place"},{"author":"troubadour","date_created":1444136199,"date_modified":1444136199,"content":"The bridge options were tested (obs2, obfs3 and scramblesuit at the time, if I remember correctly) when we had the discussion about including them or not in whonix-setup-wizard, and decided to go for T118. \n\nIt would be a matter of retesting first, then enabling the option \"Tor is censored in my area\" and add a page to the wizard that could look like the one in tor-launcher, including the custom brige option (if it's judged necessary).\n\nA note about T118. Been on and off on that one. It looks like tor-launcher is merely settings variables, and that the actual work (like editing torrc or starting meek-client) is done downstream, in firefox or wherever. So I'm not sure it's even possible achieve the bridges settings that way, without starting Tor browser."},{"author":"goldstein","date_created":1444146034,"date_modified":1444146034,"content":">A note about T118. Been on and off on that one. It looks like tor-launcher is merely settings variables, and that the actual work (like editing torrc or starting meek-client) is done downstream, in firefox or wherever. So I'm not sure it's even possible achieve the bridges settings that way, without starting Tor browser.\nI took a brief look at tor-launcher and think your right\n\n> It would be a matter of retesting first, then enabling the option \"Tor is censored in my area\" and add a page to the wizard that could look like the one in tor-launcher, including the custom brige option (if it's judged necessary).\nI think thats the best option (want to go for that ? )\n\n"},{"author":"Patrick","date_created":1444146220,"date_modified":1444146220,"content":">>! In T90#6837, @troubadour wrote:\n> A note about T118. Been on and off on that one. It looks like tor-launcher is merely settings variables, and that the actual work (like editing torrc or starting meek-client) is done downstream, in firefox or wherever. So I'm not sure it's even possible achieve the bridges settings that way, without starting Tor browser.\n\nCopied here:\nT118#6841"},{"author":"Patrick","date_created":1444149109,"date_modified":1444149109,"content":"> I think thats the best option (want to go for that ? )\n\nYes.\n\n-----\n\nI think we should replace the current connection wizard page with the text by tor-launcher as much as possible. Because they did actual usability testing.\n\nCombine the option \"Tor is censored or dangerous in my area\" with option \"I use a proxy or firewall settings to connect to the internet\". Use the same text that tor-launcher uses.\n\nI am not sure if we should keep the \"disable Tor\" option?\n\nHistory: I guess it's only 4 options, because whonix-setup-wizard (graphical desktop gui) originally was a rewrite of [whonixsetup](https://github.com/Whonix/whonixsetup) (cli gui, not very appropriate for a graphical desktop). I didn't know better. Tools were limited. Not sure tor-launcher already existed [in Tor Browser stable]."},{"author":"goldstein","date_created":1444218093,"date_modified":1444218093,"content":">I am not sure if we should keep the \"disable Tor\" option?\nI dont think the user would want/need that (why would you disable Tor when you have just started the Whonix VM to Route your traffic trough tor ?)\n\nI'm at the moment busy with another Project , I can maybe work on this at the Weekend . Its gonna take some time untill i can work on this. \n"},{"author":"Patrick","date_created":1444222732,"date_modified":1444222732,"content":"Alright.\n\n> why would you disable Tor when you have just started the Whonix VM to Route your traffic trough tor ?\n\nA reason I could see is if you want to travel somewhere. Switch from\npublic Tor network to bridges. Or a different set of bridges. Or vice versa.\n\nProbably a minority and insufficient reason to add the extra option that\nmakes it more difficult for most users.\n\nSo unless someone has an argument why we should keep it, let's remove\nthe disable Tor feature."},{"author":"HulaHoop","date_created":1444427043,"date_modified":1444427043,"content":"Please keep the Disable Tor option. Its a minority use case but very important IMO for high risk users who need to avoid guard fingerprinting.\n\nIt shouldn't be that confusing to anyone"},{"author":"goldstein","date_created":1444497752,"date_modified":1444497752,"content":"> Its a minority use case but very important IMO for high risk users who need to avoid guard fingerprinting.\nMaybe a \"advanced settings\" checkbox at the first page that enables the disable Tor option . This would come handy when we want to implement more stuff like Hidden Service Auth , or custom Guard / Circuit selection\n@HulaHoop\nHow does that sound to you ? \n\n"},{"author":"Patrick","date_created":1444500729,"date_modified":1444500729,"content":"Yes, let's keep the default that most (first time) (linux) users see to the minimum. And all the advanced stuff can be burred under an \"advanced settings\" button. Does that sound cool? @bnvk"},{"author":"HulaHoop","date_created":1444525231,"date_modified":1444525231,"content":"@goldstein Sounds great. Can't wait to see what you are working on :)"},{"author":"Patrick","date_created":1445264915,"date_modified":1445264915,"content":"Related: tor-monitor - T422"},{"author":"troubadour","date_created":1445808996,"date_modified":1445809466,"content":"Started Tor Launcher clone interface.\n{F757}\n{F759}\nThose pages are part of the wizard. But the first page (`Connect` or `Configure`) should be a separate GUI which either enable Tor or start the bridges wizard. \n\nI'm not sure where the disclaimer pages fit in that scheme. They are not used in Qubes, do we want to keep them for VirtualBox / KVM?"},{"author":"Patrick","date_created":1445812085,"date_modified":1445812085,"content":"troubadour (troubadour):\n> I'm not sure where the disclaimer pages fit in that scheme.\n\nThey don't.\n\n> They are not used in Qubes, do we have to keep them for VirtualBox / KVM?\n\nThey're real awful, but we need to keep them for VirtualBox / KVM as\nlong no one else builds and redistributes these images."},{"author":"troubadour","date_created":1445946988,"date_modified":1445948150,"content":"> the first page (Connect or Configure) should be a separate GUI\nIt can be in the wizard, and it seems a logical place where to put the `Disable Tor` option.\n\n{F763}"},{"author":"troubadour","date_created":1446066380,"date_modified":1446066380,"content":"Do we want the Whonix logo in the wizard? I guess no."},{"author":"Patrick","date_created":1446068356,"date_modified":1446068356,"content":"No. Keeping it super simple.\n\nI am also wondering if we need the disable Tor option. For this minority use case, wouldn't it make more sense if users disabled the (virtual) network interface then?\n\nPerhaps Whonix Setup Wizard -> Whonix Connection Wizard?"},{"author":"troubadour","date_created":1446070077,"date_modified":1446070077,"content":"> I am also wondering if we need the disable Tor option. For this minority use case, wouldn't it make more sense if users disabled the (virtual) network interface then?\nWill remove it, unless someone has a strong advice against it.\n\n> Perhaps Whonix Setup Wizard -> Whonix Connection Wizard?\nYes, but we still have the disclaimer pages and the repository wizard. I'll be able to create a new branch soon enough. Or perhaps a new package \"Whonix Connection Wizard\" and a separate \"Whonix Repository Wizard\" package?"},{"author":"HulaHoop","date_created":1446078564,"date_modified":1446078564,"content":">Will remove it, unless someone has a strong advice against it.\n\nPlease leave it in. Its useful to have and doesn't clutter up the wizard ui. "},{"author":"Patrick","date_created":1446141781,"date_modified":1446141781,"content":"troubadour (troubadour):\n>>> Perhaps Whonix Setup Wizard -> Whonix Connection Wizard?\n> \n> Yes, but we still have the disclaimer pages and the repository\n> wizard. I'll be able to create a new branch soon enough. Or perhaps a\n> new package \"Whonix Connection Wizard\" and a separate \"Whonix\n> Repository Wizard\" package?\n\nI was only referring to the window title.\n\nWe can have all these GUI in the same package."},{"author":"troubadour","date_created":1446154931,"date_modified":1446154931,"content":"OK.\n\nFor the `Disable Tor` option, implementing the \"Advanced\" button may satisfy everyone.\n\n{F767}\n\n{F769}"},{"author":"HulaHoop","date_created":1446156196,"date_modified":1446156196,"content":"Looks good."},{"author":"troubadour","date_created":1446159094,"date_modified":1446159094,"content":"Created a new branch `tor-launcher-clone`. It's for review only, showing the new pages."},{"author":"troubadour","date_created":1446586745,"date_modified":1446586745,"content":"Progress update.\n\nThe default bridges are implemented. When the wizard restarts tor, it shows the bootstrap progress in a progress bar.\n\nThe default bridges file is in `/etc/bridges` for not finding a better place. It's in json format, so it could be difficult to have a proper .d configuration mechanism. That should not be a big issue since the choice for custom bridges will be given.\n\nThe AppArmor denied message popping when using scramblesuit has gone after disabling and re-enabling the obfsproxy profile. Will look into that."},{"author":"Patrick","date_created":1446682488,"date_modified":1446682488,"content":"troubadour (troubadour):\n> The default bridges file is in `/etc/bridges` for not finding a\n> better place. It's in json format, so it could be difficult to have a\n> proper .d configuration mechanism. That should not be a big issue\n> since the choice for custom bridges will be given.\n\nI guess introducing /etc/bridges would lead to confusion.\n/usr/share/whonix-setup-wizard/bridges_default or something like this\nseems better. A .d configuration mechanism isn't required. Users are\neither using the default bridges (let's see if we can find someone\ninterested to host others than TBB ones) or their own ones. No need to\nhave a .d mechanism to extend the default ones."},{"author":"Patrick","date_created":1447518620,"date_modified":1447518620,"content":">>! In T90#7030, @troubadour wrote:\n> Created a new branch `tor-launcher-clone`. It's for review only, showing the new pages.\n\n* Can https://github.com/troubadoour/whonix-setup-wizard/blob/tor-launcher-clone/etc/apparmor.d/local/usr.bin.obfsproxy be moved to https://github.com/Whonix/anon-gw-anonymizer-config/tree/master/etc/apparmor.d/local please?\n*  What is...\n```\n                    shutil.copy('/etc/tor/torrc', '/etc/tor/torrc.orig')\n                    shutil.copy('/etc/tor/torrc.anondist', '/etc/tor/torrc')\n```\nFor? I don't understand why we should use the anondist file for anything. It should just be a symlink.\n* When rerenning `kdesudo whonix-setup-wizard setup` (or `quick`) I just keep getting the finish screen. Not the connection setup again."},{"author":"troubadour","date_created":1448576484,"date_modified":1448576484,"content":"Pushed a batch of commits.\n\nCould you review https://github.com/troubadoour/whonix-setup-wizard/commit/ca9e0f977dd6ca5d8fd5d556cfb159e49db21b10.\n\nIn tor 0.2.7.5, `tor.service` is a one shot service. When restarted, it returns immediately status 0, regardless of tor status. If used directly, we have to add a time.sleep in order to get the control port ready.\n\nUsing service `tor@default` instead."},{"author":"Patrick","date_created":1448580049,"date_modified":1448580049,"content":"Merged https://github.com/Whonix/anon-gw-anonymizer-config/commit/8ff911fcdc27ec9e34a08ed4efee70ef38411d3e also.\n\n> Using service `tor@default` instead.\n\nSeems okay.\n\n> Could you review https://github.com/troubadoour/whonix-setup-wizard/commit/ca9e0f977dd6ca5d8fd5d556cfb159e49db21b10.\n\n`kdesudo whonix-setup-wizard quick` works great. A totally missing `DisableNetwork 0` in `/etc/tor/torrc` doesn't break it.\n\nobfs3, obfs4, scramblesuit all working.\n\n`kdesudo whonix-setup-wizard quick` -> Disable is broken.\n\nIt's great for debugging that we see the output of Tor service restarts when start from command line.\n\nPlease remove the grayed out transports. I guess the grayed out ones would generate more support requests than not showing them at all.\n\nDuring the bootstrap phase, the back and next buttons don't work. The next button probably would not make sense either way. And the back button, I don't know if we need it. Would fixing the back button be difficult?\n\nThis is the `ClientTransportPlugin` that TBB adds when choosing obfs4.\n```\nClientTransportPlugin obfs2,obfs3,obfs4,scramblesuit exec ./TorBrowser/Tor/PluggableTransports/obfs4proxy\n```\n\nTo simplify the code a bit, I am wondering if when using bridges, if we should always add all `ClientTransportPlugin` lines that Whonix supports. I.e.\n\n```\nClientTransportPlugin obfs2,obfs3,obfs4,scramblesuit exec /usr/bin/obfs4proxy\n```\n\n`man obfs4proxy` indicates this should work. However, it does not work for me, unless I remove `,scramblesuit`."},{"author":"Patrick","date_created":1448580297,"date_modified":1448580297,"content":"Perhaps, in bridge mode, we could always add the following two options?\n\n```\nClientTransportPlugin obfs2,obfs3,scramblesuit exec /usr/bin/obfsproxy managed\nClientTransportPlugin obfs4 exec /usr/bin/obfs4proxy managed\n```\nPerhaps that would make later user manual configurations easier? And always adding all `ClientTransportPlugin` in bridge mode would perhaps also simplify the code a bit?"},{"author":"troubadour","date_created":1448662946,"date_modified":1448662946,"content":"Had some doubts about obfsproxy AppArmor lines working in `system_tor` profile. They don't.\n\nExplanation [attempt, it's a nasty one]. The AppArmor denied messages generated by scramblesuit or obfs3 are one shot errors. For example, after `/var/lib/tor/pt_state/scramblesuit` has been read once , it seems that subsequent uses of scramblesuit don't check for it any longer. The extra lines can then be commented or removed without any effect. \n\nIt was working on your system (like mine) most likely because you tested earlier with the `local/usr.bin.obfsproxy` profile. \n\nThe messages did show up after a fresh whonix-gw / sys-whonix installation (wanted to remove obfsproxy package, but it would remove whonix-gateway too).\n\nCreated `usr.bin.obfsproxy.anondist`\nhttps://github.com/troubadoour/anon-gw-anonymizer-config/commit/4f1c421ef23b08d7fdb52f3cb3787b93d2dd3e1f\n"},{"author":"troubadour","date_created":1448663588,"date_modified":1448663588,"content":"> (wanted to remove obfsproxy package, but it would remove whonix-gateway too).\n\nCould have used `apt-get install --reinstall`..."},{"author":"Patrick","date_created":1448665278,"date_modified":1448665278,"content":">>! In T90#7352, @troubadour wrote:\n>> (wanted to remove obfsproxy package, but it would remove whonix-gateway too).\n> \n> Could have used `apt-get install --reinstall`...\n\nUnfortunately, removing such packages is currently difficult. The technical background and workarounds are documented here:\nhttps://www.whonix.org/wiki/Whonix_Debian_Packages\n"},{"author":"Patrick","date_created":1448739881,"date_modified":1448739881,"content":">>! In T90#7353, @Patrick wrote:\n>>>! In T90#7352, @troubadour wrote:\n>>> (wanted to remove obfsproxy package, but it would remove whonix-gateway too).\n>> \n>> Could have used `apt-get install --reinstall`...\n> \n> Unfortunately, removing such packages is currently difficult. The technical background and workarounds are documented here:\n> https://www.whonix.org/wiki/Whonix_Debian_Packages\n\nAlternatively you could modify the [anon-gateway-packages-recommended](https://github.com/Whonix/anon-meta-packages/blob/3f864c653c8fa751386ddd2aa39a7d265b1a89c1/debian/control#L61-L72) package. Remove `obfsproxy` from its dependencies. Then rebuild [anon-meta-packages](https://github.com/Whonix/anon-meta-packages) usual the usual `make deb-pkg`. Use `dpkg -i` to install the newly build `anon-gateway-packages-recommended ` deb. Then the dependency would be gone and you could uninstall the `obfsproxy` package."},{"author":"Patrick","date_created":1448740285,"date_modified":1448740285,"content":">>! In T90#7351, @troubadour wrote:\n> Created `usr.bin.obfsproxy.anondist`\n> https://github.com/troubadoour/anon-gw-anonymizer-config/commit/4f1c421ef23b08d7fdb52f3cb3787b93d2dd3e1f\n\nMerged."},{"author":"troubadour","date_created":1448829871,"date_modified":1448829871,"content":">>! In T90#7349, @Patrick wrote:\n> During the bootstrap phase, the back and next buttons don't work. The next button probably would not make sense either way. And the back button, I don't know if we need it. Would fixing the back button be difficult?\n\nMade the back button as well as a cancel button available even during the bootstrap phase. For this, a bootstrapping thread is running beside the qt loop. And that brings me to a point I wanted to raise for some time.\n\nWe cannot afford a `sys.exit(0)` in the middle of a secondary thread. Which means that the wizard would be the same for VirtuaBox/KVM and Qubes (an improvement maintenance-wise) starting with a `Next` button, ending with a `Finish` button. \n\nAt this stage, adding the proposed code to the existing whonix-setup-wizard is getting difficult. This piece of software is already overly complicated in my opinion (not mentioning someone else, I can project myself a few years forward, if for any reason I have to find my way in that maze).\n\nThat's why I suggest to split the wizard in two pieces [packages] at least. \n- `whonix-connection-wizard`: a clone of Tor Launcher, in Whonix Gateway/whonix-gw.\n- `whonix-setup-wizard`: locale settings, disclaimer, whonix-repository, first use notice, in both gateway and workstation.\n\nIt would imply a re-work of the initializer, autostart, status files... Doable.\n\nCreated a temporary package whonix-connection-wizard.  It installs the files in `/usr/share/whonix-connection-wizard`. To run it\n```kdesudo python whonix_connection_wizard.py```\nfrom the directory.\n\n https://github.com/troubadoour/whonix-connection-wizard"},{"author":"Patrick","date_created":1448831390,"date_modified":1448831390,"content":"I am fine with the split. Sure, let's make the code simpler and maintainable.\n\nInstead of whonix-connection-wizard, we can even make this even a generic package, anon-connection-wizard?"},{"author":"troubadour","date_created":1448832434,"date_modified":1448832434,"content":"Yes, let's go for anon-connection-wizard.\n\nBug fix.\nhttps://github.com/troubadoour/whonix-connection-wizard/commit/652c4edc51ed2c096846bbc73a1d71b737e6fa20"},{"author":"Patrick","date_created":1448832857,"date_modified":1448832857,"content":"On the design... I've slightly updated:\nhttps://www.whonix.org/wiki/Dev/whonixsetup\n\nDon't take it as face value. And it may look more difficult than it is. A lot has already been sorted out."},{"author":"troubadour","date_created":1449351038,"date_modified":1449351038,"content":"Yes, and it will make the wizard simpler. There is some work in https://github.com/troubadoour/whonix-setup-wizard. The discussion is continued in https://forums.whonix.org/t/whonix-setup-wizard-graphical-technical-discussion/650/202\n\n`anon-connection-wizard` is functional with the bridges, and the `Disable Tor` option is implemented.\nhttps://github.com/troubadoour/anon-connection-wizard\n\nNow, I'll have to digest https://www.whonix.org/pipermail/whonix-devel/2015-December/000467.html before I can reply. That may influence the development."},{"author":"troubadour","date_created":1450469694,"date_modified":1450469694,"content":"Some changes to come in Tor Launcher.\nhttps://trac.torproject.org/projects/tor/ticket/11773#comment:5\n\nThere is a new warning page when trying to connect directly and a bridge/proxy configuration exists.\n\nWill implement that, as well the new text."},{"author":"Patrick","date_created":1450547928,"date_modified":1450547928,"content":"Interesting!\n\nBtw I don't think we should wait for TPO to finish revamping\ntor-launcher. I wouldn't be surprised if they go back and forth changing\nthe interface design over the next few months. We can take it once it\nstabilized. It's of course up to you. Just want to spare you from extra\nwork going back and forth together with them."},{"author":"troubadour","date_created":1450554067,"date_modified":1450554067,"content":"Yes, that sounds sensible. Remembering previous experience with TPO, it's probably better to wait and see what it will look like eventually. I'll try to finish the current version in Whonix with the architecture defined so far. We can redesign when Tor Launcher comes with new features. I'll use the new text though, aware that that will change too, but can be easily updated. "},{"author":"Patrick","date_created":1450555294,"date_modified":1450555294,"content":"Sounds good!"}]},"PHID-TASK-esfyvxfgpkkptpx3pml2":{"id":"89","title":"Whonix Control Panel","status":"open","priority":"Wishlist","author":"JasonJAyalaP","description":"A GUI and CLI to view and adjust all Whonix specific settings. Such as:\n\n* ~~[indication of persistent mode vs live mode](http://forums.whonix.org/t/whonix-live-mode/3894/48)~~ (done is separate systray icon)\n* Whonix Tor Controller - T90\n* ~~single sdwdate-gui showing status for all Whonix-Workstations in Qubes - T534~~\n* Security slider similar to Tor Browser (Low/Medium/High):\n** normal (default): allow `TransPort`\n** enhanced:\n*** disable `TransPort`  (as per [TransPort = privacy issue](https://forums.whonix.org/t/transport-privacy-issue/6925/6))\n*** disable clipboard sharing [requires host access]\n*** [disable speaker output](https://forums.whonix.org/t/disable-speaker-by-default-or-optional-for-better-security/7294/15) [requires host access]\n*** Tor Browser security slider to high ([related faq](https://www.whonix.org/wiki/FAQ#You_Should_Disable_JavaScript_by_Default.21))\n* [DNSCrypt settings](https://forums.whonix.org/t/use-dnscrypt-by-default-in-kicksecure-not-whonix/8117)\n\nRelated:\n\n* T72","comments":[]},"PHID-TASK-q2y36yo7iq5nb7pl2gdo":{"id":"88","title":"port tb-updater to gpg-bash-lib","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1421380022,"date_modified":1421380062,"content":""},{"author":"Patrick","date_created":1421436778,"date_modified":1421436778,"content":"Done:\nhttps://github.com/Whonix/tb-updater/commit/88a8556eb9fa292dd78d5d6b0cb334ad9a293bee"}]},"PHID-TASK-pgc7gsehxtadocigzusl":{"id":"87","title":"port whonixcheck to gpg-bash-lib","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1421380056,"date_modified":1421380056,"content":"Done:\n\n* https://github.com/Whonix/whonixcheck/commit/2e0bf6d63c67e32381d91d60cf88b3745ab5a220\n* https://github.com/Whonix/whonixcheck/commit/15b8b9fbad2e1e69a99c3f2f7ede0e5d0012b5a9\n* https://github.com/Whonix/whonixcheck/commit/085a8c99c09c6251c9f9b94274f5dbaec6137954\n\nNeeds more testing."}]},"PHID-TASK-rwo46xhb6sh6f2v5oozo":{"id":"86","title":"create a gpg bash lib","status":"resolved","priority":"Normal","author":"Patrick","description":"Doing gpg file verification is hard. At least if one wants to defeat rollback and indefinite freeze attacks. Currently whonixcheck (Whonix News) and tb-updater contain code for gpg file verification code.\n\nAlso securix needs some secure gpg file verification code:\nhttps://github.com/martincmelik/Securix-Linux/issues/95\n\nTherefore it's a good idea to create a lib that contains common code, `gpg-bash-lib`.\n\nFor more background, see:\nhttps://github.com/martincmelik/Securix-Linux/issues/95","comments":[{"author":"Patrick","date_created":1421376439,"date_modified":1421376439,"content":"Done:\nhttps://github.com/Whonix/gpg-bash-lib"}]},"PHID-TASK-mwlu5rwvqgd7md6ihdif":{"id":"85","title":"add parameter passing feature to su-to-root ","status":"open","priority":"Normal","author":"Patrick","description":"package: `menu`\nscript: `/usr/bin/su-to-root`\n\nUnsupported: `su-to-root -c command arg1 arg2 arg...`\nUnsupported: `su-to-root command arg1 arg2 arg...`\nSupported: `su-to-root -c 'whonix-setup-wizard setup'`\n\nPurpose:\n\n* Having a desktop environment agnostic tool that can be used rather than hardcoding `kdesudo` or `gksudo` in documentation.\n* Useful for whonix-setup-wizard, so we don't have to hardcode `kdesudo` or `gksudo` there.\n\nOriginal Source:\nhttp://sources.debian.net/src/menu/2.1.47/scripts/su-to-root/","comments":[{"author":"Patrick","date_created":1421290656,"date_modified":1421290656,"content":"Tested and working.\n```\nSU_TO_ROOT_SU=sux su-to-root -p root -c date +%s\nSU_TO_ROOT_SU=sudo su-to-root -p root -c date +%s\nSU_TO_ROOT_SU=su su-to-root -p root -c date +%s\nSU_TO_ROOT_X=gksu su-to-root -X -p root -c dolphin /usr\nSU_TO_ROOT_X=gksudo su-to-root -X -p root -c dolphin /usr\nSU_TO_ROOT_X=kdesudo su-to-root -X -p root -c dolphin /usr\nSU_TO_ROOT_X=sux su-to-root -X -p root -c dolphin /usr\n```\n\nPatch:\n```\nFrom f2fd7c39675b72128754f9052c42e0c7d5a7f5f1 Mon Sep 17 00:00:00 2001\nFrom: Patrick Schleizer <adrelanos@riseup.net>\nDate: Thu, 15 Jan 2015 02:24:47 +0000\nSubject: [PATCH] added ability to pass command line parameters to applications\n\n---\n scripts/su-to-root | 60 ++++++++++++++++++++++++++++++++++++------------------\n 1 file changed, 40 insertions(+), 20 deletions(-)\n\ndiff --git a/scripts/su-to-root b/scripts/su-to-root\nindex 375975e..3a7e2af 100755\n--- a/scripts/su-to-root\n+++ b/scripts/su-to-root\n@@ -17,7 +17,7 @@ gettext=$(which gettext 2>/dev/null)\n transl() {\n   txt=\"$1\";\n   shift;\n-  if [ -n \"$gettext\" ]; then \n+  if [ -n \"$gettext\" ]; then\n     txt=\"$(gettext su-to-root \"$txt\")\";\n   fi\n   printf \"$txt\" \"$@\"\n@@ -35,14 +35,34 @@ usage () {\n   exit 1\n }\n \n+suwrapper() {\n+  case $SU_TO_ROOT_SU in\n+    sux)\n+      sux -p \"$pwuser\" \"$@\"\n+      ;;\n+    sudo)\n+      sudo -u \"$pwuser\" sh -c \"$*\"\n+      ;;\n+    *)\n+      su -p \"$pwuser\" -c \"$*\"\n+      ;;\n+  esac\n+}\n+\n for i in \"$@\"; do\n    case \"$prev\" in\n      -p)\n-       PRIV=\"$i\";;\n+       PRIV=\"$i\"\n+       shift 2\n+       ;;\n      -c)\n-       COMMAND=\"$i\";;\n-     -X) \n-       NEEDS=\"X11\";;\n+       COMMAND=\"$i\"\n+       shift 1\n+       ;;\n+     -X)\n+       NEEDS=\"X11\"\n+       shift 1\n+       ;;\n    esac\n    prev=\"$i\"\n done\n@@ -54,7 +74,7 @@ fi\n euid=$(id -u)\n privid=$(id -u $PRIV)\n if test \"$euid\" = \"$privid\"; then\n-  sh -c \"$COMMAND\"\n+  sh -c \"$*\"\n else\n   case $NEEDS in\n   text)\n@@ -65,14 +85,14 @@ else\n     PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/bin/X11:/usr/local/sbin:/usr/local/bin\n     SHELL=`eshell $PRIV`\n     case $SU_TO_ROOT_SU in\n-      sux)  suname=sux; pwuser=\"$PRIV\"; cmd='sux  -p \"$PRIV\" -c \"$COMMAND\"';;\n-      sudo) suname=sudo;pwuser=\"$USER\"; cmd='sudo -u \"$PRIV\" sh -c \"$COMMAND\"';;\n-      *)    suname=su;  pwuser=\"$PRIV\"; cmd='su   -p \"$PRIV\" -c \"$COMMAND\"';;\n+      sux)  suname=sux; pwuser=\"$PRIV\";;\n+      sudo) suname=sudo;pwuser=\"$USER\";;\n+      *)    suname=su;  pwuser=\"$PRIV\";;\n     esac\n     transl 'Using %s...\\n' \"$suname\"\n     transl 'Enter %s password at prompt.\\n' \"$pwuser\"\n     yesexpr=$(locale yesexpr)\n-    while ! eval $cmd; do\n+    while ! suwrapper $@; do\n       transl 'Incorrect password or command failed. Try again? (y/N)'\n       read ans\n       if echo \"$ans\" | perl -e \"<> =~ /$yesexpr/ and exit(1);\"; then\n@@ -90,30 +110,30 @@ else\n             SU_TO_ROOT_X=kde4su\n           fi;\n         fi;\n-      elif which kdesu >/dev/null 2>&1 ; then \n+      elif which kdesu >/dev/null 2>&1 ; then\n         SU_TO_ROOT_X=kdesu\n       elif test -x /usr/lib/kde4/libexec/kdesu ; then\n         SU_TO_ROOT_X=kde4su\n       elif which ktsuss >/dev/null 2>&1 ; then\n         SU_TO_ROOT_X=ktsuss\n-      elif which sux >/dev/null 2>&1 ; then \n+      elif which sux >/dev/null 2>&1 ; then\n         SU_TO_ROOT_X=sux\n       else\n         SU_TO_ROOT_X=su-to-root\n       fi\n     fi\n     case $SU_TO_ROOT_X in\n-      gksu) gksu -u \"$PRIV\" \"$COMMAND\";;\n-      gksudo) gksudo -u \"$PRIV\" \"$COMMAND\";;\n-      kdesu) kdesu -u \"$PRIV\" \"$COMMAND\";;\n-      kdesudo) kdesudo -u \"$PRIV\" \"$COMMAND\";;\n-      kde4su) /usr/lib/kde4/libexec/kdesu -u \"$PRIV\" \"$COMMAND\";;\n-      ktsuss) ktsuss -u \"$PRIV\" \"$COMMAND\";;\n+      gksu) gksu -u \"$PRIV\" \"$@\";;\n+      gksudo) gksudo -u \"$PRIV\" \"$@\";;\n+      kdesu) kdesu -u \"$PRIV\" \"$@\";;\n+      kdesudo) kdesudo -u \"$PRIV\" \"$@\";;\n+      kde4su) /usr/lib/kde4/libexec/kdesu -u \"$PRIV\" \"$@\";;\n+      ktsuss) ktsuss -u \"$PRIV\" \"$@\";;\n       sux) env SU_TO_ROOT_SU=sux \\\n-        x-terminal-emulator -e su-to-root -p \"$PRIV\" -c \"$COMMAND\";;\n+        x-terminal-emulator -e su-to-root -p \"$PRIV\" -c \"$@\";;\n   # As a last resort, open a new x-terminal-emulator and prompt for the password\n   # Do not use -X here!\n-      *) x-terminal-emulator -e su-to-root -p \"$PRIV\" -c \"$COMMAND\";;\n+      *) x-terminal-emulator -e su-to-root -p \"$PRIV\" -c \"$@\";;\n     esac;;\n   esac\n fi\n-- \n2.1.3\n```\n\nPatched script:\n\n```\n#!/bin/bash\n\nif test -r /etc/su-to-rootrc; then\n. /etc/su-to-rootrc\nfi\n\nif test -r ~/.su-to-rootrc; then\n. ~/.su-to-rootrc\nfi\n\nPRIV=root\nCOMMAND=\nNEEDS=text\n\ngettext=$(which gettext 2>/dev/null)\n\ntransl() {\n  txt=\"$1\";\n  shift;\n  if [ -n \"$gettext\" ]; then\n    txt=\"$(gettext su-to-root \"$txt\")\";\n  fi\n  printf \"$txt\" \"$@\"\n}\n\neshell() {\n   getent passwd $1 | cut -f7 -d:\n}\n\nusage () {\n  transl 'usage: %s [-X] [-p <user>] -c <command>\n  -c command: command to execute as a string (mandatory)\n  -p <user>: user to switch to (default: root)\n  -X: command is a X11 program\\n' \"$0\" >&2\n  exit 1\n}\n\nsuwrapper() {\n  case $SU_TO_ROOT_SU in\n    sux)\n      sux -p \"$pwuser\" \"$@\"\n      ;;\n    sudo)\n      sudo -u \"$pwuser\" sh -c \"$*\"\n      ;;\n    *)\n      su -p \"$pwuser\" -c \"$*\"\n      ;;\n  esac\n}\n\nfor i in \"$@\"; do\n   case \"$prev\" in\n     -p)\n       PRIV=\"$i\"\n       shift 2\n       ;;\n     -c)\n       COMMAND=\"$i\"\n       shift 1\n       ;;\n     -X)\n       NEEDS=\"X11\"\n       shift 1\n       ;;\n   esac\n   prev=\"$i\"\ndone\n\nif [ -z \"$COMMAND\" ] ; then\n   usage;\nfi\n\neuid=$(id -u)\nprivid=$(id -u $PRIV)\nif test \"$euid\" = \"$privid\"; then\n  sh -c \"$*\"\nelse\n  case $NEEDS in\n  text)\n    if test \"$euid\" != 0; then\n      transl 'About to execute %s.\\n' \"$COMMAND\"\n      transl 'This command needs %s privileges to be executed.\\n' \"$PRIV\"\n    fi\n    PATH=/sbin:/bin:/usr/sbin:/usr/bin:/usr/bin/X11:/usr/local/sbin:/usr/local/bin\n    SHELL=`eshell $PRIV`\n    case $SU_TO_ROOT_SU in\n      sux)  suname=sux; pwuser=\"$PRIV\";;\n      sudo) suname=sudo;pwuser=\"$USER\";;\n      *)    suname=su;  pwuser=\"$PRIV\";;\n    esac\n    transl 'Using %s...\\n' \"$suname\"\n    transl 'Enter %s password at prompt.\\n' \"$pwuser\"\n    yesexpr=$(locale yesexpr)\n    while ! suwrapper $@; do\n      transl 'Incorrect password or command failed. Try again? (y/N)'\n      read ans\n      if echo \"$ans\" | perl -e \"<> =~ /$yesexpr/ and exit(1);\"; then\n        exit 1\n      fi\n    done;;\n  X11)\n    if test -z \"$SU_TO_ROOT_X\"; then\n      if which gksu >/dev/null 2>&1 ; then\n        SU_TO_ROOT_X=gksu\n        if test \"X$KDE_FULL_SESSION\" = \"Xtrue\" ; then\n          if which kdesu >/dev/null 2>&1 ; then\n            SU_TO_ROOT_X=kdesu\n          elif test -x /usr/lib/kde4/libexec/kdesu ; then\n            SU_TO_ROOT_X=kde4su\n          fi;\n        fi;\n      elif which kdesu >/dev/null 2>&1 ; then\n        SU_TO_ROOT_X=kdesu\n      elif test -x /usr/lib/kde4/libexec/kdesu ; then\n        SU_TO_ROOT_X=kde4su\n      elif which ktsuss >/dev/null 2>&1 ; then\n        SU_TO_ROOT_X=ktsuss\n      elif which sux >/dev/null 2>&1 ; then\n        SU_TO_ROOT_X=sux\n      else\n        SU_TO_ROOT_X=su-to-root\n      fi\n    fi\n    case $SU_TO_ROOT_X in\n      gksu) gksu -u \"$PRIV\" \"$@\";;\n      gksudo) gksudo -u \"$PRIV\" \"$@\";;\n      kdesu) kdesu -u \"$PRIV\" \"$@\";;\n      kdesudo) kdesudo -u \"$PRIV\" \"$@\";;\n      kde4su) /usr/lib/kde4/libexec/kdesu -u \"$PRIV\" \"$@\";;\n      ktsuss) ktsuss -u \"$PRIV\" \"$@\";;\n      sux) env SU_TO_ROOT_SU=sux \\\n        x-terminal-emulator -e su-to-root -p \"$PRIV\" -c \"$@\";;\n  # As a last resort, open a new x-terminal-emulator and prompt for the password\n  # Do not use -X here!\n      *) x-terminal-emulator -e su-to-root -p \"$PRIV\" -c \"$@\";;\n    esac;;\n  esac\nfi\n```\n\n```\nCopyright (C) 1996-2003  Joost Witteveen, \nModifications:\nCopyright (C) 2002-2005  Bill Allombert and Morten Brix Pedersen.\n\n  This program is free software; you can redistribute it and/or modify\n  it under the terms of the GNU General Public License as published by\n  the Free Software Foundation; either version 2 of the License, or\n  (at your option) any later version.\n\n  This program is distributed in the hope that it will be useful,\n  but WITHOUT ANY WARRANTY; without even the implied warranty of\n  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n  GNU General Public License for more details.\n\n  You should have received a copy of the GNU General Public License with\n  the Debian GNU/Linux distribution in file /usr/share/common-licenses/GPL;\n  if not, write to the Free Software Foundation, Inc., 51 Franklin St, Fifth\n  Floor, Boston, MA 02110-1301, USA.\n```\n\nSent to Bill by private e-mail for review."},{"author":"Patrick","date_created":1433781341,"date_modified":1433781341,"content":"upstream:\n```\ngit clone  https://anonscm.debian.org/git/menu/menu.git\n```\n\nbranch:\nhttps://github.com/adrelanos/menu/tree/parameter_passing\n\ncommit (no changes):\nhttps://github.com/adrelanos/menu/commit/8c46f20ad8688fbb4864ce0ad8eb3fa58724350d\n\ntest results:\n```\n## Untested - sux is not available in Debian jessie/sid.\nSU_TO_ROOT_SU=sux su-to-root -p root -c \"date +%s\"\n\n## Functional in Debian jessie.\nSU_TO_ROOT_SU=sudo su-to-root -p root -c \"date +%s\"\n\n## Functional in Debian jessie.\nSU_TO_ROOT_SU=su su-to-root -p root -c \"date +%s\"\n\n## Functional in Debian jessie.\nSU_TO_ROOT_X=gksu su-to-root -X -p root -c \"dolphin /usr\"\n\n## Functional in Debian jessie.\nSU_TO_ROOT_X=gksudo su-to-root -X -p root -c \"dolphin /usr\"\n\n## Functional in Debian jessie.\nSU_TO_ROOT_X=kdesudo su-to-root -X -p root -c \"dolphin /usr\"\n\n## Untested - sux is not available in Debian jessie/sid.\nSU_TO_ROOT_X=sux su-to-root -X -p root -c \"dolphin /usr\"\n```\n\nSent to Bill by private e-mail for review."},{"author":"Patrick","date_created":1437573441,"date_modified":1437573441,"content":"Bill just explained something to me. My conclusion from it... What currently works in jessie as is without any patch required:\n\n```\nsu-to-root -c 'whonix-setup-wizard setup'\n```\n\nIt would still be desirable to have it work without quotes."}]},"PHID-TASK-apzzbas3sha4zupc73hk":{"id":"84","title":"Should we enable HTTP Public Key Pinning (HPKP) for whonix.org?","status":"wontfix","priority":"Normal","author":"Patrick","description":"https://developer.mozilla.org/en-US/docs/Web/Security/Public_Key_Pinning\n\nhttps://news.netcraft.com/archives/2016/03/22/secure-websites-shun-http-public-key-pinning.html\n\n__**This has a high potential of DDOSing ourselves.**__\n\ncommon pitfalls:\n\n* https://news.netcraft.com/archives/2016/03/30/http-public-key-pinning-youre-doing-it-wrong.html\n* https://community.letsencrypt.org/t/hpkp-best-practices-if-you-choose-to-implement\n\n**`__If__ we ever go for HPKP, we need to test it on a separate test-only domain first (and perhaps even on a separate server).`**\n\nRelated:\nT86","comments":[{"author":"marmarek","date_created":1510245537,"date_modified":1510245537,"content":"Well, google is [going to deprecate HPKP in chrome/chromium](https://groups.google.com/a/chromium.org/forum/#!msg/blink-dev/he9tr7p3rZ8/eNMwKPmUBAAJ)."},{"author":"Patrick","date_created":1531113673,"date_modified":1531113673,"content":">>! In T84#14765, @marmarek wrote:\n> Well, google is [going to deprecate HPKP in chrome/chromium](https://groups.google.com/a/chromium.org/forum/#!msg/blink-dev/he9tr7p3rZ8/eNMwKPmUBAAJ).\n\nAnd others will follow. Since there is no future in this, we don't need to waste time on it.\n\nThanks for the reference! @marmarek "}]},"PHID-TASK-q2ytnq3ap6thptawv56h":{"id":"83","title":"Internationalization Support - bash scripts","status":"open","priority":"Normal","author":"Patrick","description":"Add internationalization to Whonix's bash scripts (whonixcheck etc.).\n\nInspiration:\n\n* `su-to-root` which is part of the debian `menu`\n* Tails\n* /usr/bin/gettext.sh from package `gettext-base`\n* http://www.linuxjournal.com/content/internationalizing-those-bash-scripts\n","comments":[{"author":"troubadour","date_created":1428184909,"date_modified":1428184909,"content":"Or, using the same translation mechanism as whonix-setup-wizard.\n\n- create a .yaml file for each whonixcheck step. Example `/home/user/whonixcheck_10.yaml`:\n```stream_isolation:\n  en:\n    functional:\n      <p>Stream Isolation Test Result&#58; Functional. YEAAAHHH</p```\n- new script `bash_message` or something like that:\n```#!/usr/bin/python\n\nimport sys\nfrom guimessages import translations\n\nfile_path = sys.argv[1]\nsection = sys.argv[2]\nmessage = sys.argv[3]\n\ntranslation = translations._translations(file_path, section)\n_ = translation.gettext\nprint _(message)\n```\n- get whonixcheck messages as follow (example from check_stream_isolation):\n```lang=bash\n      $output ${output_opts[@]} --messagecli --typecli \"info\" --message \"$MSG\"\n      else\t\n         #local MSG=\"<p>Stream Isolation Test Result: Functional.</p>\"\n         ###########################################\n\t local file_path=\"/home/user/whonixcheck_10.yaml\"\n\t local section=\"stream_isolation\"\n\t local msg=\"functional\"\n\t local MSG=\"$(/home/user/bash_message \"$file_path\" \"$section\" \"$msg\")\"\n         ###########################################\n         $output ${output_opts[@]} --messagex --typex \"info\" --message \"$MSG\"\n```\nA big bonus would be to have a standard yaml files format for the people at translatewiki.\n\nIt works, almost. There is a strange issue (for me). whonixcheck reports an error with the new command:\n```## error_cause: error_handler signal ERR detected with BASH_COMMAND: /home/user/bash_message \"$file_path\" \"$section\" \"$msg\" ```\n\nWhen running\n```bash -x whonixcheck --verbose```\nthe message from  `/home/user/whonixcheck_10.yaml` is displayed in the GUI (\"YEAAAHHH\" included), but some errors from msdispatcher:\n```## error_text: title=\"$(cat \"/var/run/msgcollector/$who_ami/${identifier}.titlex\")\" \n## last exit_code: 1 ```\nNo clue, so far. "},{"author":"troubadour","date_created":1428210722,"date_modified":1428210722,"content":"The issue is fixed: access to `bash_message` was denied by AppArmor...\n\nIf we agree on this method, I could start porting all the bash scripts outputting user messages. Then, once a couple of them are done, contact translatewiki to start a Whonix translation project.\n\nWe should agree on a translation file name convention, ie `whonixcheck_stream_isolation.yaml`, `tb_updater_gui.yaml` and so on.\n\n\n"},{"author":"troubadour","date_created":1428352003,"date_modified":1428352003,"content":"Started with three whonixcheck files.\n\nModified whonixcheck files:\nhttps://github.com/troubadoour/whonixcheck/commit/8d52f23214ee3f30027ccf7bd9247db10831df3f\n\nNew translations files:\nhttps://github.com/troubadoour/whonix-setup-wizard/commit/3ea74ae298fe625fd8aeda2fe4d27eead29a9f94\nThere is an extra commir (fix missing new lines).\n\nThe colons used in the yaml text have to be declared with their html ASCII code. Convert back to `:` for the cli:\nhttps://github.com/troubadoour/msgcollector/commit/b412c6cdbec31dd7bf6079b0e554a4e49eab8410\n\n"},{"author":"Patrick","date_created":1428408407,"date_modified":1428408407,"content":"Nice!\n\nI'll look more throughly soon.\n\nSince `local` always returns `0`, and we're using something more complex now than a simple string setting, we need to split it up. Instead of.\n\n```\nlocal MSG=\"$(/usr/share/pyshared/guimessages/bash_message [...]\n```\n\nWe need to switch to this.\n\n```\nlocal MSG\nMSG=\"$(/usr/share/pyshared/guimessages/bash_message [...]\n```\n\nFor better readability, the `local` deceleration could also be mixed with other, former `local` declarations. I mean, if there are any in that function above. Not very important, just refactoring. I.e. `local var1 var2 MSG` etc."},{"author":"Patrick","date_created":1428676127,"date_modified":1428676127,"content":">>! In T83#3553, @troubadour wrote:\n> If we agree on this method, I could start porting all the bash scripts outputting user messages. Then, once a couple of them are done, contact translatewiki to start a Whonix translation project.\n\nWe should ask translatewiki if they like our way at all. Perhaps just start small and simple with whonix-setup-wizard. I want to prevent the possible (although not likely) desaster, that we finish this just to learn at the end that we need to start again, because translatewiki doesn't like our approach.\n\n> We should agree on a translation file name convention, ie `whonixcheck_stream_isolation.yaml`, `tb_updater_gui.yaml` and so on.\n\nYes."},{"author":"Patrick","date_created":1428676817,"date_modified":1428676817,"content":"Looks very good overall.\n\nWhen this is mergeable (let's start small with just a few translated messages), I can do the refactoring with `local`. Really a minor, easy task. Kinda as a template for further porting.\n\nThe following is non-ideal, but easy to improve...\n\n```\nlocal file_path=\"/usr/share/translations/whonixcheck_control_port_filter.yaml\"\n```\n\nApart from the `local` it would be better to make `/usr/share/translations` a variable such as `$translations_path` that gets set in `preparation()`? But that's minor and easily doable by me after the first small merge.\n\nAlso I am unsure if `/usr/share/translations/` is a valid path as per FHS and Debian policy. Perhaps it should be rather `/usr/share/${pkg-name}/translations/`. Would be good to get this right from the start so stuff like this wouldn't block later upstreaming to Debian (unlikely for whonixcheck, whonix-setup-wizard, but more likely for other packages).\n\nMaybe we should prefix variables with `t_`, i.e. `t_file_path`?"},{"author":"Patrick","date_created":1428677982,"date_modified":1428677982,"content":"For scalability, I think putting whonixcheck's messages into whonix-setup-wizard package is confusing and wrong. whonixcheck should ship that messages itself and have a dependency on python-guimessages."},{"author":"troubadour","date_created":1428689722,"date_modified":1428689722,"content":">>! In T83#3580, @Patrick wrote:\n> We should ask translatewiki if they like our way at all. Perhaps just start small and simple with whonix-setup-wizard. I want to prevent the possible (although not likely) desaster, that we finish this just to learn at the end that we need to start again, because translatewiki doesn't like our approach.\nYes, that's the first think to do before contuining. I am trying to contact translatewiki. The best - and perhaps only - mean seems to be IRC. The problem is that they are on freenode (#mediawiki-i18n), which bans Tor. They have a hidden service (difficult to know which one is current) but it's disabled at the moment. http://en.irc2go.com/?q=tor. \n\nWill have to find a way. In https://translatewiki.net/wiki/Translating:New_project, email is specified, but without a link. I will have to try from the host, behind a VPN (if that's good enough, I do not know). I have registered a nick already.\n\n> Also I am unsure if /usr/share/translations/ is a valid path as per FHS and Debian policy. Perhaps it should be rather /usr/share/${pkg-name}/translations/. Would be good to get this right from the start so stuff like this wouldn't block later upstreaming to Debian (unlikely for whonixcheck, whonix-setup-wizard, but more likely for other packages).\n\n\n> For scalability, I think putting whonixcheck's messages into whonix-setup-wizard package is confusing and wrong. whonixcheck should ship that messages itself and have a dependency on python-guimessages.\n\nYes to both. The first commits were for say, presentation. I was thinking of a separate translations package,  but  `/usr/share/${pkg-name}/translations` looks better. Each package with its own translation files is probably the way.\n\n"},{"author":"Patrick","date_created":1428851143,"date_modified":1428851143,"content":"Sounds good."},{"author":"Patrick","date_created":1428851481,"date_modified":1428851481,"content":"On a second thought, I am wondering about performance. Currently for all messages added to msgcollector, two blocking process forks are done (for cli and gui). By running bash_message before, two more blocking process forks are added. It might very well be negligible. Probably doesn't matter if whonixcheck ~3 more seconds."}]},"PHID-TASK-mtmsmzv5ybfui3w5gpie":{"id":"82","title":"direct SSL certificate pinning for check.torproject.org and torproject.org (openssl s_client method)","status":"open","priority":"Normal","author":"Patrick","description":"Since `direct SSL certificate pinning for check.torproject.org and torproject.org (curl method)` (T80) would have to wait a long time, until Debian stretch, this ticket is for an alternative approach.\n\nPlease make sure you've read T80 first.\n\nTODO reserarch:\n\n1.)\n`openssl s_client` can be used to fetch a website:\n\nStep 1.\n```\nopenssl s_client -connect check.torproject.org:443\n```\n\nStep 2\n```\nGET / HTTP/1.1\nhost: check.torproject.org\n```\n\nHow can step two be automated in a script?\n\n2.)\nCan `openssl s_client` be used to fetch (similar to `wget`, `curl`) using direct SSL certificate pinning?\n\nNot to be confused with SSL Certificate Authority (CA) pinning (similar to `curl`s `--cacert` or `--capath` option)!\n\nSimilar to `curl`s `--pinnedpubkey` that was added in version 7.39.0 ([changelog](http://curl.haxx.se/changes.html)).\n\n3.)\nAlternatively... Can one pipe `curl` (or `wget`) through `openssl s_client`?\n","comments":[{"author":"HulaHoop","date_created":1496164007,"date_modified":1496164007,"content":"Since TPO infrastructure now moved to onions couldn't we just download use the onion domains for check.torproject.org, checking TBB version info and downloads?\n\nIf yes this closes T80, T81, and T146 too"},{"author":"Patrick","date_created":1496180465,"date_modified":1496180465,"content":"whonixcheck Whonix 14 optional connectivity / IP leak test:\nThere is no onion for check.torproject.org.\n( https://trac.torproject.org/projects/tor/ticket/6098 )\nWould probably also not a sensible IP leak test then.\nUnfortunately for that SSL pinning would still be useful.\n\n-----\n\ntb-updater: using onions is a good idea. If the onions will be stable and not shut down at some point? Please create a ticket."},{"author":"HulaHoop","date_created":1496234455,"date_modified":1496234522,"content":"> Would probably also not a sensible IP leak test then.\n\nThats right! I totally overlooked that :S\n\n\n> If the onions will be stable and not shut down at some point?\n\nUnlikely. The load balancing problems that caused them to shut down their onions before have since been resolved with onion-balance. They are scalable enough ti support Debian apt mirrors now.\n\n> Please create a ticket.\n\nOK"}]},"PHID-TASK-4bwehywjhygtnz2beidw":{"id":"81","title":"direct SSL certificate pinning for check.torproject.org and torproject.org (wget local CA workaround)","status":"open","priority":"Normal","author":"Patrick","description":"Since `direct SSL certificate pinning for check.torproject.org and torproject.org (curl method)` (T80) would have to wait a long time, until Debian stretch, this ticket is for an alternative approach.\n\nPlease make sure you've read T80 first.\n\n`wget` has no feature for direct certificate pinning ([feature request](https://lists.gnu.org/archive/html/bug-wget/2012-07/msg00008.html)).\n\nEventual Workaround... Creating a own local certificate authority, add only the one certificate we want to use. Approach:\n```\n    wget --ca-certificate <file>\n    openssl s_client -showcerts -connect www.torproject.org:443 >/tmp/x.cert </dev/null\n    openssl x509 -in cert.pem -noout -text -pubkey \n```\n\nOpen question: How to sign a certificate if you have no access to the private key and CSR (certificate signing request)?\n\n[OpenSSL users mailing list: Sign public key without having CSR or private key?](http://www.mail-archive.com/openssl-users@openssl.org/msg67962.html); [might work](http://www.mail-archive.com/openssl-users@openssl.org/msg67968.html) - didn't test, not sure if it could work.\n","comments":[]},"PHID-TASK-tsull3kmksftqnvdtfgy":{"id":"80","title":"direct SSL certificate pinning for check.torproject.org and torproject.org (curl method)","status":"open","priority":"Normal","author":"Patrick","description":"Migrated from:\nhttps://github.com/Whonix/Whonix/issues/24\n\n-----\n\n__Info__:\n\nTerminology in this field is ambiguous. \"(public key) pinning\" is easily misunderstood. Not to be confused with [SSL Certificate Authority (CA) Pinning](https://www.whonix.org/wiki/Dev/SSL_Certificate_Pinning#PIN_Certificate_Authority)! This ticket is for pinning the exact certificate.\n\n[TPO offers fingerprints on their website.](https://www.torproject.org/docs/faq.html.en#SSLcertfingerprint)\n\n[TPO offers no hidden services that could be used as alternative anymore.](https://trac.torproject.org/projects/tor/wiki/WikiStart?sfp_email=&sfph_mail=&action=diff&version=96&old_version=95&sfp_email=&sfph_mail=)\n\n`wget` has no feature for direct certificate pinning ([feature request](https://lists.gnu.org/archive/html/bug-wget/2012-07/msg00008.html)).\n\n#whonixcheck has an [unfinished](https://github.com/Whonix/whonixcheck/commit/5a405cd76f195d28d302914ec14f0e2989571488) `--pin-tpo-cert` feature.\n\n__Status__:\n\nWhonix 14 will be based on Debian stretch, so this could now be implemented.\n\nTODO: Implement using `curl` and `--pinnedpubkey`\n\n-----\n\n__Enable this by default or not?__\n\nIf you want to discuss if this should be enabled by default or not, please see [Defaults Discussion](https://www.whonix.org/wiki/Dev/SSL_Certificate_Pinning#Defaults_Discussion) and create a child ticket.\n\n-----\n\nRelated tickets:\n* sdwdate uses onions rather than SSL: T131\n* wget local CA alternative workaround: T81\n* openssl sclient method: T82\n* python method: T146\n\n-----\n\n__TODO__:\n\n* ~~Wait for `curl` 7.39.0 to appear in Debian.~~ Done, [stretch comes with curl 7.51](https://packages.debian.org/stretch/curl ).\n* Implement this in #whonixcheck and #tb-updater.","comments":[{"author":"HulaHoop","date_created":1449502905,"date_modified":1449502905,"content":"This may not be needed if TPO switches to Let's Encrypt for its own sites. It would be as simple as trusting their CA without worrying about expired certs or MITM. "},{"author":"HulaHoop","date_created":1449603382,"date_modified":1449603382,"content":"Security comparison:\n\nSelf-signed cert > Let's Encrypt > Current CA model\n\n\nOur options are limited but what TPO decides to proceed so we need to ask them and get an idea.\n\nTo be researched: The implications of NSLs on Let's Encrypt's security."},{"author":"Patrick","date_created":1449603978,"date_modified":1449603978,"content":"letsencrypt should go into it's own ticket. Not good to have it under\n\"direct SSL certificate pinning\"."},{"author":"HulaHoop","date_created":1456790696,"date_modified":1456790696,"content":"https://lists.torproject.org/pipermail/tor-talk/2016-February/040462.html"},{"author":"HulaHoop","date_created":1456857432,"date_modified":1456857432,"content":"Key level pinning is not coded yet but planned. Lets Encrypt logs can be checked by users for signs of strange behavior or sudden key changes. Lets Encrypt aims for great transparency and will fight to defeat NSLs but As a CA this type of legal attack can happen. Sticking to the previous idea of direct cert pinning makes more sense for usability and security IMO."},{"author":"HulaHoop","date_created":1539434828,"date_modified":1539434828,"content":"We can now grab the browser tarball from the TPO onion instead which makes this ticket obsolete. Close if you concur."}]},"PHID-TASK-nbaa5qctmbpiciunaij5":{"id":"79","title":"Internationalization Support","status":"open","priority":"Normal","author":"Patrick","description":"When whonix-setup-wizard (Whonix Greeter) T72 is done, we can read the user's language selection in Whonix's apps and scripts.\n\nhttps://translatewiki.net has volunteer translators that would help translating Whonix's apps and scripts.\n\nThis ticket serves as a reminder. Sub tickets should be created for various script languages ( #python, #bash ) and various apps and scripts (whonixcheck etc.).\n\nSub tasks:\n\n* bash scripts: T83\n\n`Chinese fonts and input method`\nhttps://forums.whonix.org/t/chinese-fonts-and-input-method\n","comments":[]},"PHID-TASK-ym4e2qw2gj3htfmo6dco":{"id":"78","title":"install varnish to speed up whonix.org","status":"resolved","priority":"High","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1425231666,"date_modified":1425231666,"content":"See also new speed tests:\nhttps://www.whonix.org/wiki/Dev/Homepage"}]},"PHID-TASK-7ctgftun6uxukfdq43va":{"id":"77","title":"Don't show about:tor after switching identity","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"Tor Browser does not support /etc/ config files to set the homepage. (Iceweasel does, but that lacks the Tor Browser changes.) Neither Firefox, nor Iceweasel nor Tor Browser support setting homepage (or more generally: prefs) by using environment variables.\n\nLess hacky solution:\nWrite a Tor Button patch, when environment Y is set to X, then set homepage to X. Could take a while until patch gets merged. Needs someone capable for writing javascript! We have no one so far.\n\nGood solution:\nImplement setting prefs by environment variables into Firefox. Could take a while until patch gets merged. Needs someone capable for writing C. We have no one so far.","comments":[{"author":"Patrick","date_created":1421196542,"date_modified":1421196562,"content":""},{"author":"Patrick","date_created":1421196585,"date_modified":1421196585,"content":"Done:\n\n* https://trac.torproject.org/projects/tor/ticket/13835\n* https://www.whonix.org/forum/index.php/topic,365.0.html\n* https://github.com/Whonix/whonix-welcome-page/commit/50ba03c3b732972a25532abc46bab97312a90cd8\n* https://github.com/Whonix/whonix-welcome-page/commit/2425778300f1d3bc0a5de5e39dc0950b9c3f0752\n"}]},"PHID-TASK-iocuyxdebbfbjw4e4s56":{"id":"76","title":"whonixcheck Stream Isolation Check via Tor ControlPort","status":"open","priority":"Low","author":"JasonJAyalaP","description":"`Stream isolation functional. TransPort and SocksPort have the same IP. This is normal.`\n\n#whonixcheck should ask Tor's ControlPort, if Tor really isolated streams. This analysis might not be possible form the workstation for security reasons. But could be doable from the gateway.","comments":[]},"PHID-TASK-hxuazaqfo6rdmgi4wvai":{"id":"75","title":"add download speed indicator to the download window of Tor Browser download GUI (tb-updater)","status":"open","priority":"Wishlist","author":"JasonJAyalaP","description":"Suggested by @Occq and discussed here:\nhttps://www.whonix.org/forum/index.php/topic,207.0.html","comments":[{"author":"Patrick","date_created":1421197447,"date_modified":1421197574,"content":"I don't know if this will ever happen. Would require,\n\n* improving zenity (C code). - Probably not.\n* or a zenity replacement that supports updating strings (download speed) while open, that can be called from bash\n* or running a progress bar replacement (python) from tb-updater (bash)\n* or expert bash / zenity scripting skills - somehow updating, already open/existing zenity progress bars\n\nOr how long it will take for T18 to happen."},{"author":"Patrick","date_created":1446660371,"date_modified":1446660371,"content":"Lowering priority, because Tor Browser now has it's own internal updater and because tb-updater has been degraded to being a downloader only.\n\nAlso fixing torbrowser-launcher might be a better use of time:\n* T18\n* https://www.whonix.org/forum/index.php/topic,404.0.html"}]},"PHID-TASK-ognnkpv7wtiodij7w5mq":{"id":"74","title":"Research Circumvention Tools","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"https://www.whonix.org/wiki/Censorship_Circumvention_Tools\n\nNeed to figure out if they can be used on the host or Whonix-Gateway to let Whonix (Tor) connect through them.\n\nRequirements: \n- Tor compatibility\n\nBonus:\n- Usability\n- Nonproprietary\n- Crossplatform\n","comments":[{"author":"HulaHoop","date_created":1456068691,"date_modified":1456068691,"content":"I've thought about it and I don't think we should advise putting censorship circumvention tools between a user and entry guard (except bridges and pluggable transports of course). All other tools besides pluggable transports are ill equipped to resist protocol fingerprinting and can have security problems. Using them to mask Tor traffic would be a red flag that narrows the user base to people who have seen this page which goes against advGoalTracking.\n\nI still think the information is useful but it should be advised to use them as an exit point for traffic beyond Tor if they can work like that."},{"author":"Patrick","date_created":1456089287,"date_modified":1456089287,"content":"HulaHoop (HulaHoop):\n> I've thought about it and I don't think we should advise putting\n> censorship circumvention tools between a user and entry guard (except\n> bridges and pluggable transports of course). All other tools besides\n> pluggable transports are ill equipped to resist protocol\n> fingerprinting and can have security problems. Using them to mask Tor\n> traffic would be a red flag that narrows the user base to people who\n> have seen this page which goes against advGoalTracking.\n\nThen we exactly point that out. These tools may still be useful the\ncensorship-circumvention-but-not-care-about-detection-so-much use case.\n\nThis goes for most circumvention methods anyhow.\n\nQuote by Jacob -\nhttps://www.whonix.org/wiki/Hide_Tor_and_Whonix_from_your_ISP\n\n\"Some pluggable transports may seek to obfuscate traffic or to morph it.\nHowever, they do not claim to hide that you are using Tor in all cases\nbut rather in very specific cases. An example threat model includes a\nDPI device with limited time to make a classification choice - so the\nhiding is very specific to functionality and generally does not take\ninto account endless data retention with retroactive policing.\""},{"author":"HulaHoop","date_created":1456168322,"date_modified":1456168322,"content":"> Then we exactly point that out.\n\nOK\n\n> Quote by Jacob -\n\nYes I know. The goal is to not stand out from a sizable set of users doing circumvention any point in time, not to protect from traffic identification retroactively."}]},"PHID-TASK-4ye5vuidy5kq6o7jl2oo":{"id":"73","title":"default socksification of ssh, wget, curl, etc. is confusing for local connections","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"Many advanced users are confused by Whonix's socksification of default applications such as `ssh`, `wget`, `curl`, etc. (For [stream isolation](https://www.whonix.org/wiki/Stream_Isolation) by `uwt`.\n\nWhen they do `ssh 10.152.152.11`, `uwt` will result in actually executing `torsocks /usr/bin/ssh.anondist-orig 10.152.152.11 `. Therefore traffic will flow though `torsocks` and go a Tor SocksPort. This will fail for local connections. It will result in the following error message:\n\n> libtorsocks(12021): connect: Connection is to a local address (10.152.152.11), may be a TCP DNS request to a local DNS server so have to reject to be safe. Please report a bug to http://code.google.com/p/torsocks/issues/entry if this is preventing a program from working properly with torsocks\n\nMaybe in `~/.bashrc` (as terminal greeting) we should output the contents of the `UWT_DEV_PASSTHROUGH` variable.\n\nUsers can either use `export UWT_DEV_PASSTHROUGH=1` or `ssh.anondist-orig` to circumvent `uwt`. This is [documented](https://www.whonix.org/wiki/Stream_Isolation#Deactivate_uwt_Stream_Isolation_Wrapper).\n\n-----\n\nExample support request: [1](https://forums.whonix.org/t/tor-ssh-dynamic-port-forwarding-error-listen-operation-not-permitted/2246)\n\n```\n$ ssh -NgD 4444 root@111.222.333.444\n```\n```\nlisten: Operation not permitted\nlisten: Operation not permitted\nchannel_setup_fwd_listener_tcpip: cannot listen to port: 4444\nCould not request local forwarding.\n```\n\n-----\n\nTODO:\n\n* run this from [.bashrc](https://github.com/Whonix/whonix-base-files/blob/master/etc/skel/.bashrc.whonix)\n* upgrade existing .bashrc files?\n","comments":[{"author":"JasonJAyalaP","date_created":1421192642,"date_modified":1421192642,"content":"Is there a way to flip socks on and off depending on the destination? That would be the most elegant (and I hope not impossible) solution."},{"author":"Patrick","date_created":1421200269,"date_modified":1421200269,"content":"Not sure. The wrapper or uwt (?) would need to have a concept of local networks and understand the command line of each individual command. Make sure something like `wget https://www.somedoc.com/explain/what_is_10.152.152.11_about` does not trigger it. `uwt` is doing some sort of this already - no the best code:\nhttps://github.com/Whonix/uwt/blob/master/usr/bin/uwt#L247\nNot sure how sane that is. Well, at worst, traffic would pollute Tor's TransPort, rather than use expected Tor SocksPort (stream isolation)."},{"author":"Patrick","date_created":1476306168,"date_modified":1476306168,"content":"Ideally for usability after the user run into some torsocks warning message, a tooltip or konsole message would offer help. But I don't think terminals support that feature.\n\n-----\n\nWIP:\n\nWhen a terminal is opened, [uwt_settings_show](https://github.com/Whonix/uwt/commit/4fa778de2ecfe95aaaffa9c0ecb6885c1b812d23) is run.\n\n> uwt INFO: Stream isolation for some applications enabled. uwt / torsocks will be automatically prepended to some commands. What is that? See:\n> uwt INFO: https://www.whonix.org/wiki/Stream_Isolation/Easy\n\nAny feedback?"},{"author":"entr0py","date_created":1477422165,"date_modified":1477422165,"content":"The other option would be to present INFO every time a wrapped command is invoked, but that would probably be too intrusive for anyone other than occasional terminal users.\n\nIf you want to be verbose, you could append the list of wrapped executables to your INFO message.\n\nIn general, this is a good idea. Took me a while to figure out why I couldn't ssh to a server on my vpn network. This kind of reminder would probably have helped."},{"author":"Patrick","date_created":1477432780,"date_modified":1479779993,"content":"Thanks for the feedback!\n\nentr0py (entr0py):\n> The other option would be to present INFO every time a wrapped command is invoked, but that would probably be too intrusive for anyone other than occasional terminal users.\n\nYes, and break scripts that parse the output of these commands."},{"author":"Patrick","date_created":1483947266,"date_modified":1483947266,"content":"> run this from .bashrc\n\nDone:\nhttps://github.com/Whonix/whonix-base-files/commit/34782f82130e5f99c57aa742fad6b4b962392d49\n\n> upgrade existing .bashrc files?\n\nProbably not worth the effort. Would require changes to https://github.com/Whonix/whonix-base-files/blob/master/usr/lib/anon-base-files/first-boot-skel or so which could introduce some regressions."}]},"PHID-TASK-chunrbiyzamrbg63osr5":{"id":"72","title":"Whonix Greeter","status":"open","priority":"Wishlist","author":"JasonJAyalaP","description":"A Whonix Greeter could ask the user, upon first use of workstation, what language, local time, keyboard layout, etc they want to use.","comments":[{"author":"JasonJAyalaP","date_created":1421192216,"date_modified":1421192216,"content":"Thoughts:\n\nInstead of a one-off \"Select language and we run a shell command to download the apks and change a kde config\", this could be decoupled from the OS and, instead, tied into the \"Whonix Desktop Control Panel\" idea. Essentially, the whonix greeter is the Whonix Workstation Control run for the first time, set to ask essential questions. The ws control panel would then handle the logic of downloading and configuring."},{"author":"Patrick","date_created":1421198047,"date_modified":1515124504,"content":"By chance, we're exactly at that point at the moment, @JasonJAyalaP.\n\n@troubadour and I are discussing usability and implementation of this here:\nhttps://forums.whonix.org/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/122\n"},{"author":"Patrick","date_created":1424728862,"date_modified":1424728862,"content":">>! In T149#2535, @Patrick wrote:\n>>>! In T149#2533, @troubadour wrote:\n>> Next step would be T138. Not sure yet how to integrate it. Same window, an extra line `Select language` with a drop-down list? A separate GUI? Or perhaps from the desktop environment installed language?\n> \n> That is somewhat T72, which you partially already implemented in \"whonix-setup-wizard locale_settings\". When we start that (using xinit) (perhaps in Whonix 11?), then system language gets set. tb-updater could use the same language. The question is, how could tb-updater figure out what was set in KDE (or..)?\n\nTo answer my own question... It is stored here...\n\n```\n~/.kde/share/config/kdeglobals\n```\n\n```\n[Locale]\nCountry=de\nLanguage=de\n```\n\nSo from the `[Locale]` section, the `Language=de` value could be read."},{"author":"iry","date_created":1515274328,"date_modified":1515274328,"content":"The first step for us is to localize Whonix?\n\nIn other words:\n1. install foreign fonts\n2. install input methods for different languages"},{"author":"Patrick","date_created":1515333603,"date_modified":1515333603,"content":"Does #Qubes have any thoughts on internationalization? How to get it localized into several native languages? There is dom0 window manager, Debian template, Fedora template. @marmarek \n\nWhonix is only a small piece in the bigger picture of Qubes internationalization, which would then follow how it is implemented for Debian templates."},{"author":"Patrick","date_created":1515334684,"date_modified":1515334684,"content":"What are the privacy implications of this? @HulaHoop\n\n>>! In T72#15370, @iry wrote:\n> The first step for us is to localize Whonix?\n> \n> In other words:\n> 1. install foreign fonts\n> 2. install input methods for different languages\n\nAlso configure the system applications to have a different language.\n\nhttps://www.whonix.org/wiki/Language\n\n-----\n\nThere are various options.\n\na) native language localized downloadable images for various languages\n * disadvantage: not realistic for Non-Qubes-Whonix as I would have to build all of them\n * advantage: no greeter required\n * advantage: no package installation required\n\nb) install packages and configure, all done by Whonix Greeter\n * advantage: smaller image size\n * disadvantage: hard, since then \"half\" of the system during installation would still be English during installation\n * disadvantage: download (therefore initial time to set up Whonix would take a long time, even longer since we recommend upgrading after installation)\n\nc) install packages by default, and only configure language using Whonix Greeter\n * advantage: no further download required\n * disadvantage: bigger image sizes might be a deal breaker for Qubes?\n  * Are the `kde-i18n-...` packages even relevant for Qubes-Whonix or only for Non-Qubes-Whonix?\n * challenge: have the greeter only show up once in Qubes and not multiple times per VM\n * Ideally Whonix templates would be just informed by the locale setting on dom0?\n   * Good from internationalization point of view but might be unwanted from privacy point of view without prior permission?\n\nBest would be a solution that solves this for whole Qubes or at least Qubes Debian templates first. Otherwise we might venture into an implementation path that is later incompatible with Qubes.\n\nPlease see:\nhttps://forums.whonix.org/t/graphical-gui-whonix-setup-wizard-anon-connection-wizard-technical-discussion/650/122\n\nTo avoid reinvention the wheel and to avoid mistakes... How do other distributions similar to Qubes / Whonix implement this? Let's say Debian, Ubuntu, Fedora, Mint, Elementary OS, Tails?"},{"author":"iry","date_created":1515388088,"date_modified":1515388088,"content":"Another disadvantage for a)  and b):\n\nTor Browser can reveal what fonts have been installed in the system when JavaScript is enabled, which can be used as an effective fingerprint against users.\n\n\n\n> To avoid reinvention the wheel and to avoid mistakes... How do other distributions similar to Qubes / Whonix implement this? Let's say Debian, Ubuntu, Fedora, Mint, Elementary OS, Tails?\n\nI agree with you. Part of the settings from Tails:\n\nhttp://forums.kkkkkkkkkk63ava6.onion/t/chinese-fonts-and-input-method/2698/3\n\n"},{"author":"Patrick","date_created":1515419861,"date_modified":1515419861,"content":"iry (iry):\n> iry added a comment.\n> \n> \n>   Another disadvantage for a)  and b):\n>   \n>   Tor Browser can reveal what fonts have been installed in the system when JavaScript is enabled, which can be used as an effective fingerprint against users.\n\nTor Browser has a feature effectively limit that, no? Or do you mean\nlocalized Tor Browser's for non-English have different fonts? That seems\nplausible, but is it a fact?"},{"author":"iry","date_created":1515775858,"date_modified":1515775858,"content":"> Tor Browser has a feature effectively limit that, no? Or do you mean\n> localized Tor Browser's for non-English have different fonts? That seems\n> plausible, but is it a fact?\n\nPlease educate me if I am wrong. The reason I draw this conclusion is because when doing the fingerprint test on ip-check.info , there is a section called \"Do you see strange symbols here? If yes, your fonts are readable!\"\n\nWhen setting the TB security slide to low(default) or medium, we can see strange symbols, while we can not see the strange symbols when setting security slide to high. Does that mean:\n\n> Tor Browser can reveal what fonts have been installed in the system"},{"author":"Patrick","date_created":1515778543,"date_modified":1515778543,"content":">>! In T72#15382, @iry wrote:\n>> Tor Browser has a feature effectively limit that, no? Or do you mean\n>> localized Tor Browser's for non-English have different fonts? That seems\n>> plausible, but is it a fact?\n> \n> Please educate me if I am wrong. The reason I draw this conclusion is because when doing the fingerprint test on ip-check.info , there is a section called \"Do you see strange symbols here? If yes, your fonts are readable!\"\n\nBrowser tests are problematic generally.\n\nhttps://www.whonix.org/wiki/Browser_Tests\n\nJonDo:\n\nhttps://www.whonix.org/wiki/Browser_Tests#ip-check.info\n\nJonDo and ip-check.info in my opinion at the moment doesn't get much maintenance. In my opinion it's best to look at it with great doubt.\n\n> When setting the TB security slide to low(default) or medium, we can see strange symbols, while we can not see the strange symbols when setting security slide to high. Does that mean:\n> \n>> Tor Browser can reveal what fonts have been installed in the system\n\nMight be true. Could you check/ask with Tor Project what the status of this is?"},{"author":"iry","date_created":1515793988,"date_modified":1515793988,"content":"> Browser tests are problematic generally.\n\nThank you for pointing this out, Patrick!\n\n>> Tor Browser can reveal what fonts have been installed in the system\n> Might be true. Could you check/ask with Tor Project what the status of this is?\n\nI did some searching before asking and it turns out one of the Tor Browser Design goals is:\n\n> Font-based fingerprinting MUST be rendered ineffective\n\nMore detailed information and defensive approach has been descried in the 6. Fonts section in Tor Browser Design document:\nhttps://www.torproject.org/projects/torbrowser/design/ "},{"author":"iry","date_created":1515794245,"date_modified":1515794245,"content":"It is still unclear to me if there is any other known and unknown ways to detect the fonts installed in Whonix by other applications. \n\nTherefore, we may go conservative: pre-install all the fonts in the same Whonix image and may encourage users not to install other fonts themselves? "},{"author":"marmarek","date_created":1515795140,"date_modified":1515795140,"content":">>! In T72#15372, @Patrick wrote:\n> Does #Qubes have any thoughts on internationalization? How to get it localized into several native languages? There is dom0 window manager, Debian template, Fedora template. @marmarek \n> \n> Whonix is only a small piece in the bigger picture of Qubes internationalization, which would then follow how it is implemented for Debian templates.\n\nCurrently we don't have any way to configure locales system-wide. One can configure it in dom0, but is isn't sent to any VM (besides keyboard layout). Then one can configure it manually in each/selected TemplateBasedVM separately, or TemplateVMs.\n\nI see two parts of the problem here:\n - how/when to install appropriate language support (should be done in TemplateVMs)\n - how/when to choose appropriate language (can be done either in TemplateVMs, or individual TemplateBasedVMs)\n\nThe latter probably can be some qvm-prefs setting + QubesDB key + startup service to apply it. As for the former, maybe salt? If that would be planned as one time configuration (or just something rarely changed - especially not for each VM startup), Salt could be used for the second point too (adjust some config in TemplateVM/TemplateBasedVM)."},{"author":"Patrick","date_created":1516827317,"date_modified":1516827317,"content":"iry (iry):\n> iry added a comment.\n> \n> \n>   It is still unclear to me if there is any other known and unknown ways to detect the fonts installed in Whonix by other applications.\n\nCertainly. Custom installed browsers for example. But the package\nselection is Whonix specific either way. No way to blend in with anything.\n\n>   Therefore, we may go conservative: pre-install all the fonts in the same Whonix image and may encourage users not to install other fonts themselves?\n\nAre some fonts incompatible with each other? All input methods at once\nmay be incompatible?\n\nPre-installation of all fonts may bust image size limits. Qubes is (or\nwas?) already DVD oversize.\n\nHow much more MB / GB would we be talking about?"}]},"PHID-TASK-ylb27scpz42cwpuva6fr":{"id":"71","title":"Show desktop clock in local time; keep system in UTC","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"Can we somehow patch the clock to show a local time zone while leaving system time time in UTC?\n\nThis most likely requires a Whonix Greeter first so that we can get the timezone from the user.\n\nIt might be possible to configure the clock in the kde task bar. Time zone in kde clock can be changed without root rights and without affecting /etc/localtime, thus the user can have it's clock show what she wants. It looks like this is either configured in /home/user/.kde/share/config/plasma-desktop-appletsrc and/or /home/user/.kde/share/config/ktimezonedrc.","comments":[{"author":"JasonJAyalaP","date_created":1421191624,"date_modified":1421191624,"content":"Is there a way to automatically get the timezone from the host or virtualizer? That would be much better usability than asking the user to scroll through a list.\n\nWe also have to deal with letting the user change the local (displayed) time whenever (s)he wants. Messing with config files might not be a robust solution. "},{"author":"JasonJAyalaP","date_created":1421193400,"date_modified":1421193416,"content":"This should be part of the \"Whonix Workstation Control Panel\". The user can change their time zone there, and the control panel does the background changes necessary to display that time zone in the current DE, but keep the system in UTC."},{"author":"Patrick","date_created":1421196272,"date_modified":1421196272,"content":"> Is there a way to automatically get the timezone from the host or virtualizer?\n\nNo, it's better to leave it set to UTC. Not as long as we're not controlling the host (`VBoxManage setextradata`). Also this is better on a \"if user wishes only\" base.\n\n> That would be much better usability than asking the user to scroll through a list.\n\nThe most likely ones could be suggested after language selection that @troubadour is working on.\n\n> This should be part of the \"Whonix Workstation Control Panel\"\n\nOr #whonix-setup-wizard ?\n\n> Messing with config files might not be a robust solution.\n\nFinding that out is the TODO of this ticket."},{"author":"HulaHoop","date_created":1439913314,"date_modified":1439913314,"content":"I don't think we should encourage users to set time zones because it can give away their geo location both for an adversary in the VM and for timestamp leaks by applications in the WS."},{"author":"Patrick","date_created":1439916180,"date_modified":1439916180,"content":"Good point.\n\nWhat about hiding the clock in the task bar then by default?"},{"author":"HulaHoop","date_created":1543857306,"date_modified":1543857306,"content":"I think hiding the clock is a bad idea as a user may want to manually run sdwdate to adjust it if it's out of whack before initiating internet traffic. (This is on non-Qubes versions lacking auto time adjust)"}]},"PHID-TASK-njhol25e6ebrdn56c4pu":{"id":"70","title":"Use a Content-Security-Policy","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"whonix.org should use a Content-Security-Policy. Other security headers besides CSP are looking good already ([test service](https://cyh.herokuapp.com/cyh)).\n\nhttps://forums.whonix.org/t/whonix-website-security-rating-b-mozilla-observatory","comments":[{"author":"Patrick","date_created":1531714643,"date_modified":1531714643,"content":"https://forums.whonix.org/t/content-security-policy-now-deployed-on-whonix-websites"}]},"PHID-TASK-swrtioavrd2v4ayfwrgl":{"id":"69","title":"Change KDE Theme and KDE Mouse Theme\n\nIt's easy to do by manually using a mouse, but I haven't found out how to do it shipping a configuration file.\n\nAfter being done, update https://www.whonix.org/wiki/Dev/KDE from TODO to Done.","status":"wontfix","priority":"Normal","author":"JasonJAyalaP","description":"Purpose: Prevent confusion of host desktop with Whonix-Gateway desktop or Whonix-Workstation desktop.\n\nIt's easy to do by manually using a mouse, but I haven't found out how to do it shipping a configuration file.\n\nAfter being done, update https://www.whonix.org/wiki/Dev/KDE from TODO to Done.","comments":[{"author":"Patrick","date_created":1542729641,"date_modified":1542729641,"content":"https://forums.whonix.org/t/user-poll-xfce-vs-kde-kde-deprecation-considered/6235"}]},"PHID-TASK-va3zo5rtggeg6xf6elof":{"id":"68","title":"use /etc/network/if-pre-up.d/ instead of /etc/network/interfaces to load Whonix's firewall","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"Debian [[ http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=700811 | bug #700811: interface comes up even if a script in /etc/network/if-pre-up.d/ ]] fails has been fixed.\n\nIt would be better to drop Whonix-Workstation's (optional) and Whonix-Gateway's firewall load hook in /etc/network/if-pre-up.d/ than doing what we're doing right now (using pre-up in /etc/network/interfaces). This would make /etc/network/interfaces cleaner, easier to port and more difficult for users to remove pre-up from /etc/network/interfaces and shoot their own feet.\n\nWe have to wait until Debian Jessie gets stable, because this bug ix not fixed in Debian Wheezy.","comments":[{"author":"Patrick","date_created":1432389010,"date_modified":1432389010,"content":"`Removed 'pre-up /usr/bin/whonix_firewall', because /etc/network/if-pre-up.d to load the firewall, because of a Debian upstream bug interface comes up even if a script in /etc/network/if-pre-up.d/ fails http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=700811 was fixed. - https://phabricator.whonix.org/T68`:\n- https://github.com/Whonix/whonix-gw-network-conf/commit/4136361ac308e8664a61eaf9c2da2fbba9c2e74b\n- https://github.com/Whonix/whonix-ws-network-conf/commit/3c6042abfa56996a4211913460b5f4438cdd2cdd\n\n`Made package more standalone. Requiring 'pre-up /usr/bin/whonix_firewall' in /etc/network/interfaces is no longer necessary. Added etc/network/if-pre-up.d/30_whonix_firewall to load the firewall, because of a Debian upstream bug 'interface comes up even if a script in /etc/network/if-pre-up.d/ fails' http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=700811 was fixed. - https://phabricator.whonix.org/T68`:\n- https://github.com/Whonix/whonix-gw-firewall/commit/5332e66f7670903bc4e4c50f1b435ca016734762\n- https://github.com/Whonix/whonix-ws-firewall/commit/b708b9e24ba9b095899bd6d2c1e861a32b58b5df\n- https://github.com/Whonix/whonix-host-firewall/commit/d8ba7f4d86f23dc36a947bd1e7734d71905bc6a1\n"},{"author":"HulaHoop","date_created":1432391225,"date_modified":1432391225,"content":"Can firewalld help here? https://packages.debian.org/jessie/firewalld"},{"author":"Patrick","date_created":1432393565,"date_modified":1432393565,"content":">>! In T68#4883, @HulaHoop wrote:\n> Can firewalld help here? https://packages.debian.org/jessie/firewalld\n\nThere is currently no problem that needs to be solved."},{"author":"Patrick","date_created":1432478142,"date_modified":1432478142,"content":"Done, tested and functional in Whonix `11.0.0.2.0-developers-only`."}]},"PHID-TASK-jel2xcxi7buvhqjwtxoh":{"id":"67","title":"Time Privacy Documentation","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"Done in Whonix 9:\n\n* Wrote a wrapper to obfuscate the time: https://github.com/adrelanos/timeprivacy. Proposed it and got it merged upstream with faketime: https://github.com/wolfcw/libfaketime/pull/16\n* Added the timeprivacy script to uwt: https://github.com/Whonix/uwt/blob/master/usr/bin/time_privacy\n* Added configuration file: https://github.com/Whonix/uwt/blob/master/etc/uwt.d/30_timeprivacy_default\n* Added it to uwt wrapper: https://github.com/Whonix/uwt/blob/master/usr/lib/uwtwrapper\n* Added man page: https://github.com/Whonix/uwt/blob/master/man/time_privacy.1.ronn\n\nCheck this out inside Whonix:\n\n```\nman time_privacy\n```\n\nShows a man page that comes with explanations, options, examples and a demonstration.\n\nForum discussion:\n- https://www.whonix.org/forum/index.php/topic,1194.0.html\n\nLeft to do:\n- User documentation for next Whonix version about this new experimental feature, how to enable, how to use.\n","comments":[]},"PHID-TASK-jmgfuy6jupejb3lwgxj3":{"id":"66","title":"Certificate Authority (CA) Pinning for whonix.org","status":"resolved","priority":"Wishlist","author":"JasonJAyalaP","description":"At the moment we are just as everyone else vulnerable to malicious certificate authorities issuing fraudulent SSL certificates.\n\nCA pinning is in the works. References:\n\n  - https://bugzilla.mozilla.org/show_bug.cgi?id=744204\n  - https://wiki.mozilla.org/Security/Features/CA_pinning_functionality\n  - https://tools.ietf.org/html/draft-evans-palmer-key-pinning-00\n\n\nNot perfect, not only pinning the certificate fingerprint, still depending on two CA's but at least not on a massive amount of them.\n\nOnce done, we should apply for it.\n\nRelated:\nT84","comments":[{"author":"Patrick","date_created":1531113629,"date_modified":1531113629,"content":"Same as T84#14765."},{"author":"Patrick","date_created":1531562540,"date_modified":1531562540,"content":"We have now a `DNS Certification Authority Authorization (CAA) Policy`."}]},"PHID-TASK-divy2d2vclykvqrrxm4p":{"id":"65","title":"drop uwt as soon as torsocks gets native stream isolation support","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"torsocks is getting native stream isolation support on the command line. Therefore #uwt becomes mostly redundant. uwtwrapper and uwtwrappers will still be required. The feature might come in #debian_stretch. \n\nWhen that happens `/usr/lib/uwtwrapper` should use `torsocks` instead of `uwt`. And `uwt` should be removed.\n\nReference:\n\n* https://trac.torproject.org/projects/tor/ticket/11726\n* https://trac.torproject.org/projects/tor/ticket/17340","comments":[{"author":"Patrick","date_created":1484731998,"date_modified":1484731998,"content":"This was done in T356."}]},"PHID-TASK-nwigwjc7azvag4ncgbmg":{"id":"64","title":"document vmdk disk shrinking and expanding","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"https://forums.whonix.org/t/the-workstation-vmdk-gets-bigger-and-bigger","comments":[{"author":"JasonJAyalaP","date_created":1421181690,"date_modified":1421181690,"content":"Patrick, do you mean describing how disk images dynamically expand, and how to shrink them? (If this involves converting the vmdk to vdi first, I don't think this will be very popular). "},{"author":"Patrick","date_created":1421182104,"date_modified":1421182104,"content":"To shrink them. Indeed, converting to vdi beforehand would be required. But that seems a good idea in any case."}]},"PHID-TASK-wpoclqurlbdcbpjqcq7w":{"id":"63","title":"whonixcheck ws message when Tor is not enabled on gateway","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"`migrated from` https://github.com/Whonix/Whonix/issues/248\n\nIn Whonix 9, on Whonix-Workstation, if Tor has not been enabled on Whonix-Gateway (DisableNetwork 1; whonixsetup has not been run), whonixcheck will say.\n\n\n```\nTor Bootstrap Result: \nWhonixcheck gave up waiting after 60 seconds. \nTor Circuit: not established \nBootstrapping 80 % done. \nTor reports: NOTICE BOOTSTRAP PROGRESS=80 TAG=conn_or SUMMARY=\"Connecting to the Tor network\". \n\nPossible issues: \n- Is the host's internet connection working? \n- Whonix-Gateway will need a few moments for bootstrapping the Tor network. \n- Did you start Whonix-Gateway beforehand? \n\nRecommendations: \n1) \nTry again: Start menu -> Applications -> System -> Whonix Check \nor in Terminal: whonixcheck \nor in Terminal with debugging: bash -x whonixcheck --verbose \n2) \nRun whonixcheck on Whonix-Gateway as well.\n```\nIs this sufficient?\n\nOr should whonixcheck get information from Whonix-Gatway?\n\nWhonix-Gateway could send information to Whonix-Workstation and tell it \"Tor not enabled yet on Whonix-Gateway\".","comments":[]},"PHID-TASK-maqtnmg4i3sgni7dipwq":{"id":"62","title":"Mail OTF for Security Review","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"1) Read\n  - https://www.opentech.fund/lab/red-team-lab\n  - https://www.opentechfund.org/article/report-how-evaluate-technical-audits-funder\n  - https://www.opentechfund.org/sites/default/files/attachments/report-public_0.pdf\n  - https://www.opentechfund.org/sites/default/files/attachments/pre-engagement_checklist.pdf\n  - https://www.opentechfund.org/sites/default/files/attachments/matrix_-_example.xls\n2) Then fill out:\n  - https://docs.google.com/forms/d/1nrbxhucjKeloQu3eSUkO1rMQ6QwdWNVOQqm-uUZVwjQ/viewform\n3) See what they say, answer further stuff.","comments":[{"author":"anonymous1","date_created":1484774495,"date_modified":1484774495,"content":"also consider OSTIF"},{"author":"Patrick","date_created":1490747365,"date_modified":1490747365,"content":"Was actually less to read and fill out than expected.\n\nPre-engagement: Project self-assessment\n\n> Your response has been recorded.\n\nFor now nothing more to do but wait."},{"author":"Patrick","date_created":1517918428,"date_modified":1517918428,"content":"OTF would do it, but $someone needs time to actually engage with OTF."}]},"PHID-TASK-b56lq6ev3nvmsutu64ct":{"id":"61","title":"GPG signatures do not authenticate filenames","status":"resolved","priority":"Normal","author":"Patrick","description":"Issue:\n\nWhen using `gpg --armor --detach-sign some-file-version-c` a file `some-file-version-c.asc` will be created.\n\nBut an adversary position to arbitrarily change file names on a mirror or so could rename it to `some-file-version-d` and `some-file-version-d.asc`.\n\nThat could trick the verifier into believing having received a more recent version than expected. The adversary could use this to mount rollback [1] (downgrade) or indefinite freeze [2] attacks.\n\n-----\n\nResearch:\n\nThe Tor Project (TPO) similar track ticket - GPG signatures do not authenticate filenames:\nhttps://trac.torproject.org/projects/tor/ticket/2340\n\nasked on gnupg-users mailing list - How to sign the name of the name as well, not just the file?\nhttp://lists.gnupg.org/pipermail/gnupg-users/2015-January/052185.html\n\n-----\n\nPossible solution: OpenPGP notations\n\nWe could use OpenPGP notations as I asked on the gnupg-users mailing list:\nhttp://lists.gnupg.org/pipermail/gnupg-users/2015-January/052191.html\n\nTry this:\n\n```\necho \"test\" > x\ngpg --armor --set-notation file@name=\"x\" --detach-sign x\ngpg --armor --verify-options show-notations --verify x.asc\n```\n\nExample output:\n\n```\n~ $ echo \"test\" > x\n~ $ gpg --armor --set-notation file@name=\"x\" --detach-sign x\n\nYou need a passphrase to unlock the secret key for\nuser: \"Patrick Schleizer <adrelanos@riseup.net>\"\n4096-bit RSA key, ID 77BB3C48, created 2014-01-16 (main key ID 2EEACCDA)\n\n~ $ gpg --armor --verify-options show-notations --verify x.asc\ngpg: Signature made Mon 12 Jan 2015 11:13:19 PM UTC using RSA key ID 77BB3C48\ngpg: Good signature from \"Patrick Schleizer <adrelanos@riseup.net>\" [ultimate]\ngpg: Signature notation: issuer-fpr@notations.openpgp.fifthhorseman.net=6E979B28A6F37C43BE30AFA1CB8D50BB77BB3C48\ngpg: Signature notation: file@name=x\n~ $ \n```\n\nThe first gpg command could be added to the `sign_images` Whonix maintainer script to easily add this notation:\nhttps://github.com/Whonix/whonix-developer-meta-files/blob/master/release/sign_images\n\nThen we could tell users in documentation to use `--verify-options show-notations` and therefore check the file name has not been tampered with.\n\n-----\n\nOther possible solutions:\n\n* creating a `sha512sums` file and signing that one - more cumbersome to download and verify\n* using `tar` and a versioned sub folder - cumbersome for `.ova` images - folder name easily overlooked","comments":[{"author":"Patrick","date_created":1421105855,"date_modified":1421105855,"content":"Since it was really easy and low effort, just now added `file@name` OpenPGP notation:\nhttps://github.com/Whonix/whonix-developer-meta-files/blob/master/release/sign_images\n\nWill be used for all further releases.\n\nHow we solve this however [ 1) user documentation saying \"look at `file@name` OpenPGP notation\" 2) signed checksum file 3) signed tarball that contains versioned sub folder and/or otherwise ] is still open for debate. [This change doesn't mean we must go the OpenPGP notation route. That notation doesn't hurt either way - if anyone is looking at it or not.]"},{"author":"Patrick","date_created":1423016305,"date_modified":1423016305,"content":"Now using OpenPGP notations:\n\n* https://www.whonix.org/wiki/Verify_the_virtual_machine_images_using_the_command_line\n* https://www.whonix.org/wiki/Verify_the_virtual_machine_images_using_Linux\n\nIf you have any feedback or suggestions, please reopen or create a new ticket."}]},"PHID-TASK-am3syyzvyxn5ef6rx7cg":{"id":"60","title":"USB Image","status":"invalid","priority":"Normal","author":"JasonJAyalaP","description":"A USB Image gives the highest mix of security/convenience/ease-of-install. This could easily be our flagship install method.\n\nThis would probably be a linux host with KVM images installed and ran at boot time.\n\nThe problem is finding a host distro with great driver support which is user friendly enough to be configured if necessary.\n\nRemember that this is not an installer image, but for a usb stick with whonix installed and ready to boot. This is uncommon in the linux distro area.\n\nRelated, \"Host Additions\":\nhttps://phabricator.whonix.org/T21","comments":[{"author":"onion_knight2","date_created":1590738808,"date_modified":1590738808,"content":"Should we close this ticket since Whonix-Host is precisely a \"usb stick with whonix installed and ready to boot\", already available as an ISO image, even if still in early stage?"},{"author":"Patrick","date_created":1590756515,"date_modified":1590756515,"content":"Indeed. The rest is tracked under component #whonix-host."}]},"PHID-TASK-f7k77csr4hvcoehq7xcy":{"id":"59","title":"whonixcheck should warn if whonix-initializer failed","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1421196816,"date_modified":1421196816,"content":"Done:\nhttps://github.com/Whonix/whonixcheck/commit/3cafb586ec1035df30b862c1bb18c3241e7360ab"}]},"PHID-TASK-vlbdk773gtxxcabwmdwz":{"id":"58","title":"whonix-initializer change path to /var/lib/whonix-initializer/status-files","status":"resolved","priority":"Normal","author":"Patrick","description":"https://github.com/Whonix/whonix-initializer/blob/master/usr/lib/first_run_initializer_gui#L81\n\nI wonder why I set `/root/.whonix/` as path. Should be better `/var/lib/whonix-initializer/status-files`, so #whonixcheck can read those and warn if there is no done_file or a yet to be created fail_file.\n\nShould keep existing done_file and skip_file that can be used to indicate whonix-initalizer should be skipped for Qubes compatibility. (At least until they updated.)","comments":[{"author":"Patrick","date_created":1421181688,"date_modified":1421181688,"content":"Done:\nhttps://github.com/Whonix/whonix-initializer/commit/49d0fa6a313bcc678cad2a0ac46d53ec581e7b6e"}]},"PHID-TASK-cwnt6vhmix2qvrzvcm5y":{"id":"57","title":"implement rads (ram adjusted desktop starter) systemd unit","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"__Introduction__:\n\nrads stands for RAM Adjusted Desktop Starter\n\n* [rads documentation](https://www.whonix.org/wiki/Desktop#RAM_Adjusted_Desktop_Starter)\n* [rads github](https://github.com/Whonix/rads)\n* Used by and useful for the Linux distribution [Whonix](https://www.whonix.org), which is primarily run inside virtual machines\n\n-----\n\n__Issues__:\n\n* rads forces to keep tty0 open -> solved in [rads systemd branch](https://github.com/Whonix/rads/tree/systemd)\n* rads tty0 still running after it started a graphical login manager (creates confusion: [bug report](https://www.whonix.org/forum/index.php/topic,1162)) -> solved in [rads systemd branch](https://github.com/Whonix/rads/tree/systemd)\n* rads is broken on jessie that uses systemd -> TODO\n\n-----\n\n__Solution__:\n\nA good approach to solve this could be to run rads before getty using systemd. [1]\n\n-----\n\n__TODO__:\n\n* [/usr/lib/ram_adjusted_desktop_starter/ram_adjusted_desktop_starter](https://github.com/Whonix/rads/blob/master/usr/lib/ram_adjusted_desktop_starter/ram_adjusted_desktop_starter) needs to be started by a systemd unit before getty\n* it needs to have stdout connected, so users can read output by rads\n* it needs to have stdin connected, so users can interact with rads\n* output by other boot processes should not mix up with output by rads\n* build upon the rads systemd branch, because it already solves most of above issues\n\n-----\n\n__Footnotes__:\n\n[1] Could work similar as whonix-initializer systemd unit:\nhttps://github.com/Whonix/whonix-initializer/blob/master/lib/systemd/system/whonix-initializer.service\n(whonix-initializer runs as an \"app\" during first boot. Its systemd unit is configured to wait until whonix-initializer finished.)\n\n-----\n\n__Bounty too low?__:\n\n1) Go to https://www.bountysource.com/issues/14466761-implement-rads-ram-adjusted-desktop-starter-systemd-unit\n2) Click on \"Developers\"\n3) Click on \"Get Started\"\n4) Select Status \"Bounty too low\"\n5) Enter your offer and press \"Save\".\n\n-----\n\nMirrored from:\nhttps://phabricator.whonix.org/T57\n\n-----\n\nMirrored to:\nhttps://github.com/Whonix/rads/issues/1\n\n-----\n\nOn bountysource:\nhttps://www.bountysource.com/issues/14466761-implement-rads-ram-adjusted-desktop-starter-systemd-unit\n","comments":[{"author":"Patrick","date_created":1431700703,"date_modified":1431700703,"content":"Done, `ported to systemd; refactoring - https://phabricator.whonix.org/T57`:\nhttps://github.com/Whonix/rads/commit/4d6de0073440f3d91e1f95f9069b555fa1c38a7f\n"},{"author":"Patrick","date_created":1432396278,"date_modified":1432396278,"content":"`Improved implementation. When there is enough RAM... On 'enter': instantly start login manager. On 'ctrl + c': instantly abort and do not start login manager. On 'timeout': start login manager. Thanks to 'dh_systemd_start --no-start' we can now use 'StandardInput=tty' and 'read' instead of 'systemd-ask-password'. Now we could even implement an interactive menu at boot (that allows to configure wait time and/or disabling rads). - https://phabricator.whonix.org/T57`:\nhttps://github.com/Whonix/rads/commit/c8c94c3dfe625dee62bd0fcbe76c5480d4e94056"}]},"PHID-TASK-irpdwjk34wfxhuol4nhb":{"id":"56","title":"Bridge Sanity Check","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"migrated from:\nhttps://github.com/Whonix/Whonix/issues/316\n\n-----\n\nThere is an attack bridges can perform on first-time users. This involves feeding old consensus data (which can be up to a week old).\n\nWe could use anondate to parse Tor consensus from two sources:\n\n* downloaded by Tor\n* (multiple times) downloaded by python-stem\n\nTreat the bridge's consensus as untrusted and not factor it in.\n\nsdwdate / sdwdate-gui has already a good infrastructure.\n\n- To inform the user about the state of network time synchronization. A progress indicator, telling them to wait until it's done before using the internet. One more sanity check that adds up to the wait is negligible. Also this is very similar to the sanity check planned in T151.\n- sdwdate prerequisite would wait until this check could even be run - A standalone bridgesanitycheck cannot run before Tor starts serving anyhow.\n\nGive it its own indicator. It shouldn't wait for sdwdate.\n\nRely on Tor stem in all cases.\n\nLet's implement `sdwdate Tor Consensus Time Sanity Check` (T151) first, see how that goes and then get back to this one.","comments":[{"author":"Patrick","date_created":1531116640,"date_modified":1531116640,"content":"From #sdwdate log. Clock was right but I got this using a bridge.\n\n```\n2018-07-09 05:54 - sdwdate - INFO - Prerequisite check: The clock is sane.\nWithin build timestamp Fri Aug  5 01:41:02 UTC 2016 and expiration timestamp Tue May 17 10:00:00 UTC 2033.\n2018-07-09 05:54 - sdwdate - INFO - Prerequisite check: The clock is fast. Clock is faster than consensus/valid-until 2018-07-09 02:00:00.\n```\n\nSo actually the clock wasn't fast but the Tor consensus was stale. Need to modify that #sdwdate message. Good reason to implement this ticket."}]},"PHID-TASK-vgvl46imcmyvhamfbvbl":{"id":"55","title":"wizard security vs usability - whonixadvsetup","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"`migrated from:`\nhttps://github.com/Whonix/Whonix/issues/319\n\nReduced usability is also a security problem. On the other hand, educated users don't need many usability features. \n\nWe can extend whonixsetup with \"whonixadvsetup\"\n\n\n```\nDo you wish to configure further settings related to security vs usability?\n```\n\n\n```\nNo, just go ahead, use recommended most usable settings.\nYes, I am willing to learn more, sacrifice usability for better security.\n```\nIf user choses no, just keep current defaults\n\nIf user chooses, yes, start explaining more stuff in sub menus. Such as:\n\n  - Explain whonixcheck's Whonix News, and that it may be substituted by regularly reading Whonix Important Blog. User can disable it.\n  - Explain whonixcheck's Tor Browser update check and that it can be substituted by watching for the small red blinking Tor Browser and how to update in that case.\n  - Explain whonixcheck's SocksPort / TransPort Test's.\n  - Explain sdwdate, explain that it can be omitted by manually keeping care of the clock.\n  - Explain CPFP, what breaks when disabling it, how to substitute it.\n  - Explain [Check for Revocation Certificates before running apt-get](https://github.com/Whonix/Whonix/issues/125) (as soon as implemented).\n  - User will be able to enable/disable all one by one and/or enable/disable all at once. (The disable all at once might be interesting for users who already know all that stuff and configure multiple workstations and such who wish to click fast through it.)\n\n\n","comments":[]},"PHID-TASK-xvfsy2zihpg7jrmkakx3":{"id":"54","title":"Move Whonix's APT repository and Whonix News to mirror.whonix.de","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"`migrated from github:`\nhttps://github.com/Whonix/Whonix/issues/178\nhttps://github.com/Whonix/Whonix/issues/339","comments":[{"author":"Patrick","date_created":1428164639,"date_modified":1428164639,"content":"The upload scripts are ready. They upload to both sourceforge and mirror.whonix.de now.\n\n* https://github.com/Whonix/whonix-developer-meta-files/blob/master/release/upload_repository\n* https://github.com/Whonix/whonix-developer-meta-files/blob/master/release/upload_whonix_news_v4\n\nTODO:\n\n* #whonix-repository: Wondering if it should just switch from sourceforge to mirror.whonix.de, have a command line option to choose and/or separate screen.\n* #whonixcheck Whonix News Download location: Wondering if it should just switch from sourceforge to mirror.whonix.de or try sourceforge as fallback if connection to mirror.whonix.de fails.\n"},{"author":"Patrick","date_created":1428167795,"date_modified":1428167795,"content":"Done  #whonixcheck, `moved Whonix News files to mirror.whonix.de and use sourceforge as fallback`:\nhttps://github.com/Whonix/whonixcheck/commit/a8907e768fc9bf3920767a2d11b8a4c4b88a0d52"},{"author":"Patrick","date_created":1428169225,"date_modified":1428169225,"content":"#whonix-repository:\n* `refactoring`, \"made baseuri configurable through WHONIX_APT_REPOSITORY_BASEURI environment and /etc/whonix.d configuration variable\":\nhttps://github.com/Whonix/whonix-repository/commit/3d7dbd91f53a516292e11b24181e1daae380e862\n* `moved Whonix APT Repository default baseuri from http://sourceforge.net/projects/whonixdevelopermetafiles/files/internal/ to http://mirror.whonix.de/whonixdevelopermetafiles/internal/`:\nhttps://github.com/Whonix/whonix-repository/commit/fa4621e7b54b8114d4b33ad6c4ce473de0a0abd9\n* `made baseuri (WHONIX_APT_REPOSITORY_BASEURI) configurable through --baseuri command line parameter`:\nhttps://github.com/Whonix/whonix-repository/commit/5577a3dda1577362c0475d368a3bea2f53ba4a0e\n* `add WHONIX_APT_REPOSITORY_BASEURI to auto generated configuration file`:\nhttps://github.com/Whonix/whonix-repository/commit/21475cb81882d598c63503ba4d21ef386572ce51"}]},"PHID-TASK-tybzonnfues5ci7mfy6o":{"id":"53","title":"Contributors License Agreement (CLA) / Developer Certificate of Origin (DCO) / Fiduciary License Agreement (FLA)","status":"open","priority":"Normal","author":"JasonJAyalaP","description":"`migrated from:`\nhttps://github.com/Whonix/Whonix/issues/355\n\nWe have https://github.com/Whonix/Whonix/blob/master/CONTRIBUTING.md but formalizing it in form of a CLA, DCO or FLA should be done some day. Patrick and Hula like the FLA. Needs research.\n\nThere is a tension between encouraging new contributions and making sure legal issues are settled.\n\n* info: http://producingoss.com/en/copyright-assignment.html\n* CLA: http://harmonyagreements.org/\n* DCO: https://www.kernel.org/doc/Documentation/SubmittingPatches under 12) Sign your work\n* FLA: https://fsfe.org/activities/ftf/fla.en.html\n* Q&A: http://programmers.stackexchange.com/questions/168020/how-signing-out-a-cla-prevents-legal-issues-in-open-source-projects/168026#168026\n\nPerhaps we can make consent part of the pull request (via CLAHub)? This feature is in development but perhaps stalled:\nhttps://github.com/clahub/clahub/issues/82\n\nphabricator has a sign document feature. Interesting is both, the signature feature as well as their wording. See:\nhttps://secure.phabricator.com/L28\n\n(And they got a separate one for cooperates:\nhttps://secure.phabricator.com/L30)","comments":[{"author":"Patrick","date_created":1421098355,"date_modified":1421098355,"content":"phabricator has a sign document feature. Interesting is both, the signature feature as well as their wording. See:\nhttps://secure.phabricator.com/L28\n\n(And they got a separate one for cooperates:\nhttps://secure.phabricator.com/L30)\n"},{"author":"Patrick","date_created":1421098450,"date_modified":1421098450,"content":"HulaHoop wrote:\n\n> I am liking the FLA. I think it strikes the right balance by allowing project leaders the dexterity they need to manage the project while assuring contributors that their work will never be closed off under a proprietary license. Again I know your intentions are good and you wouldn't do such things but this type of agreement encourages and puts new coders at ease, ones who are not necessarily familiar with your philosophy and outlook.\n\nI tend to agree.\n\nNeeds more research."},{"author":"Patrick","date_created":1421152354,"date_modified":1421152354,"content":"Moritz Bartl would talk to FSFE if we have any questions regarding FLA."}]},"PHID-TASK-qjb22voz6ez6w5vgt6f3":{"id":"52","title":"Using cowbuilder for build-steps.d/1200_create-debian-packages?","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"`migrated from github:`\nhttps://github.com/Whonix/Whonix/issues/356\n\n\nI am considering to revise build-steps.d/1200_create-debian-packages.\n\nCurrent issues:\n\n* dpkg-buildpackage unfortunately does not support a --outputdir option ([feature request](https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=657401)), so .deb packages end up in ../ or in other words in whonix_source_folder/packages directory.\n* When creating a package, debhelper creates temporary files within whonix_source_folder/packages/$package_name/debian and as far I know this cannot be prevented either.\n* Needless to say, having temporary and binary (.deb's) within Whonix source folder is non-ideal. (Risk of custom builders committing them to git or asking when/how/if they can be deleted.)\n* Therefore an ugly [cleanup step](https://github.com/Whonix/Whonix/blob/master/help-steps/cleanup-files) is required, which risks wiping files which others added in meanwhile.\n\nUnfortunately, this task will have to wait, because cowbuilder does not produce deterministic builds in neither wheezy nor jessie.\n\nProduced a work in progress cowbuilder branch:\nhttps://github.com/Whonix/Whonix/tree/cowbuilder\n\nThat modifies:\nhttps://github.com/Whonix/Whonix/blob/cowbuilder/build-steps.d/1200_create-debian-packages\n\nThere is a new function create_whonix_debian_packages_using_cowbuilder:\nhttps://github.com/Whonix/Whonix/blob/cowbuilder/build-steps.d/1200_create-debian-packages#L250\n\nUnfortunately, this task will have to wait, because `cowbuilder` does not produce deterministic builds in neither `wheezy` nor `jessie`.\n\nNo upstream bugreport necessary, because it is fixed in `sid` + reproducible builds custom build environment (https://wiki.debian.org/ReproducibleBuilds#Custom_build_environment). I guess this will be possible in `jessie` + 1 (#Debian_Stretch).","comments":[{"author":"Patrick","date_created":1484631542,"date_modified":1484631542,"content":"https://github.com/Whonix/genmkfile/commit/b919fd8fb05c69c0245bd922ab76bd1f943565d7\nhttps://github.com/Whonix/genmkfile/commit/0228b6e57c810979a8e616479e84c886a107c60e\nhttps://github.com/Whonix/genmkfile/commit/87d8bfac5841c40d3c958323f2fedb699063268b\nhttps://github.com/Whonix/genmkfile/commit/cf76682b8bc3dc4544c66b82838f0e8ad128175f\nhttps://github.com/Whonix/Whonix/commit/5b7abae678fdc3932f7be85fe061ff41144033bc\n\nTODO:\n\n* multiple rebuilds and check if packages are deterministic every time"},{"author":"Patrick","date_created":1484916427,"date_modified":1484916427,"content":"Using cowbuilder now. Origin and debian archives as well as (much more importantly) Whonix debian packages are deterministic when being build inside two different VMs. However, to claim full reproducibility, more work is required. Follow up task: T615\n\n----\n\nhttps://github.com/Whonix/genmkfile/commit/b919fd8fb05c69c0245bd922ab76bd1f943565d7\nhttps://github.com/Whonix/genmkfile/commit/0228b6e57c810979a8e616479e84c886a107c60e\nhttps://github.com/Whonix/genmkfile/commit/87d8bfac5841c40d3c958323f2fedb699063268b\nhttps://github.com/Whonix/genmkfile/commit/cf76682b8bc3dc4544c66b82838f0e8ad128175f\nhttps://github.com/Whonix/genmkfile/commit/b9cfe434424acda481c77d8cda55a54810967d7b\nhttps://github.com/Whonix/genmkfile/commit/d0fa541d94174abc19da61632ea8bca493d8c1e2\nhttps://github.com/Whonix/genmkfile/commit/99ae35a14d55a77a2118d3a9ccac222c24521cab\nhttps://github.com/Whonix/genmkfile/commit/2915c81f71ee6d775cd0c7a393b52d2c95f2f378\nhttps://github.com/Whonix/genmkfile/commit/0fe840b4dd3c82b88a2d62550de94d11c3f5731d\nhttps://github.com/Whonix/genmkfile/commit/9be69e85ec5344c804bf4d94b5fc7365e01f8a6c\nhttps://github.com/Whonix/genmkfile/commit/b9c2df4a290064aaa6f64156237545f8e927568e\nhttps://github.com/Whonix/genmkfile/commit/d91eef7154e28d141b301a13c50ee17865afce34\nhttps://github.com/Whonix/genmkfile/commit/3b52c8ed69c1a95d32705bad749e9864d6c25bd6\nhttps://github.com/Whonix/genmkfile/commit/762fadce053464ba0687ac2ccde4e44807c3253c\nhttps://github.com/Whonix/genmkfile/commit/f8615d73f1f110132bf7f8c7bb94ff4b02385126\nhttps://github.com/Whonix/genmkfile/commit/3073894b6ac8b44d4472f7e70bc9b0cf9c2303fb\nhttps://github.com/Whonix/genmkfile/commit/2ed270f729a8baac9ed7360c26118711ebbae0d2\n\nhttps://github.com/Whonix/Whonix/commit/5b7abae678fdc3932f7be85fe061ff41144033bc\nhttps://github.com/Whonix/Whonix/commit/179af7f9c2da0c78bd63e553c78c3c31ba588150\nhttps://github.com/Whonix/Whonix/commit/cc94059795af9fe83abca1355cf554f054d71f18\nhttps://github.com/Whonix/Whonix/commit/718ddec27ced37074f7f1e9b4bf6cba355f09b4a\nhttps://github.com/Whonix/Whonix/commit/8eef504afdd3f17dc649f5ee2e8c5bbb33c21d57\nhttps://github.com/Whonix/Whonix/commit/9002f2d06f8cb372ee62710270d10202a2e40500\nhttps://github.com/Whonix/Whonix/commit/87c458d837a1d20cde04a476a9b72233f9809ecd\n"}]},"PHID-TASK-7aieakhhxw7wu3j4syir":{"id":"51","title":"list of git tags messed up when running \"git tag\"","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"`migrated from github:`\nhttps://github.com/Whonix/Whonix/issues/357\n\nThis is a follow up task that results out of:\n[[ https://github.com/Whonix/Whonix/issues/276 | \"better git tag names that reflect stable, testers-only, developers-only\" ]]\n\nCurrently when one runs in Whonix/Whonix source folder.\n\n\n```\ngit tag\n```\n\nThey'll get this.\n\n\n```\n[...]\n0.5.6\n0.6.0\n0.6.1\n10.0.0.0.1-developers-only\n10.0.0.0.2-developers-only\n10.0.0.0.3-developers-only\n10.0.0.0.4-developers-only\n10.0.0.0.5-developers-only\n10.0.0.0.6-developers-only\n6\n6.1\n6.2\n[...]\n8.6.6.9\n9\n9.1\n9.2\n9.3\n\n```\nTags names 10.0.0.0.6-developers-only and similar follow the schema that was implemented in [[ https://github.com/Whonix/Whonix/issues/276 | #276 ]].\n\nWhat's the issue? That -developers-only tag ends up somewhere in the middle. Someone who just runs git tag might easily miss it and think 9.3 is the latest one.\n\nAny idea what we could do about this?\n","comments":[{"author":"Patrick","date_created":1423739343,"date_modified":1423739343,"content":"The only option that comes to mind is to delete the git tags that are using the old naming scheme and to archive them in another git repository."}]},"PHID-TASK-e225wlkovfhcuv7rvchl":{"id":"50","title":"systemd spams journal due to time changed by sclockadj, rewrite of sclockadj, sclockadj2","status":"resolved","priority":"Normal","author":"JasonJAyalaP","description":"bug 1\n100 % CPU bug:\n\n* https://forums.whonix.org/t/reopened-sclockadj-stuck-at-100-cpu/732/26\n* [100% CPU but happens reproducibly after suspend and resume in Qubes-Whonix](https://github.com/QubesOS/qubes-issues/issues/1764#issuecomment-187089419)\n\n-----\n\nbug 2\nsystemd spams journal due to time changed by sclockadj\n\n-----\n\nAvdN built a sclockadj replacement written in #python, but more work is needed:\nhttps://github.com/Whonix/sdwdate/pull/4\n\n-----\n\nForum discussion:\nhttps://forums.whonix.org/t/sclockadj2-slow-clock-adjuster-prevent-fingerprintable-clock-adjustments\n\n-----\n\nRelated:\nT621\n\n-----\n\nDeprecated:\n\n~~Patrick asked on stackexchange:~~\nhttps://unix.stackexchange.com/questions/166639/how-to-disable-systemds-time-has-been-changed-message-spam-in-systemd-journal\n\n~~Jason:~~\n~~The only way I see to avoid systemd spam is to change the logging level in the conf file. How is it that adjtimex changes the clock without a systemd message? Maybe sclockadj can do that.~~\n\n~~Migrated from github:~~\nhttps://github.com/Whonix/Whonix/issues/363","comments":[{"author":"Patrick","date_created":1532500501,"date_modified":1532500501,"content":"sclockadj3 is done -> T686.\n\nlog spam is in different ticket -> T691."}]},"PHID-TASK-ipw7273gnez2wixfqprv":{"id":"49","title":"NAT vs Bridged Networking for Whonix-Gateway","status":"open","priority":"Normal","author":"Patrick","description":"Every now and then the NAT vs Bridged Networking topic comes up (on IRC and also forums?). Bridged Network lovers would love to see switching from NAT to Bridged by default.\n\nLast time we discussed this at length was here:\nhttps://sourceforge.net/p/whonix/discussion/general/thread/3a0b673a\n\nMaybe it's time to rehash that topic.\n\nI am not proposing we change from NAT to Bridged Networking. But there should be a chapter in the wiki that summarizes the differences, advantages and disadvantages of both. Once that exists, we can decide if we keep the current default (NAT) or move to bridged.\n\nEventually we'll provide instructions to switch from one to another.","comments":[]},"PHID-TASK-d7ifltplijxh7fcvwsm3":{"id":"48","title":"use errtrace would lead to fewer traps required","status":"resolved","priority":"Normal","author":"Patrick","description":"Most `ERR` `trap`s for individual #bash functions could be omitted by using at the beginning of the script:\n\n```\nset -o errtrace\n```\n\nand declaring for example `trap \"error_handler\" ERR` just once.\n\nThis is quite a big #refactoring task. Applies to Whonix's #build script as well as most packages with scripts.","comments":[{"author":"Patrick","date_created":1421100983,"date_modified":1422529623,"content":"Done:\n* sdwdate\n* anon-shared-helper-scripts\n* tb-updater\n* tb-starter\n* whonixcheck"},{"author":"Patrick","date_created":1429638081,"date_modified":1429638081,"content":"Done:\n* https://github.com/Whonix/whonix-developer-meta-files/commit/0a92e00aaa9b9b749468780260b9f11d65d60133\n* https://github.com/Whonix/Whonix/commit/5684681422ba1c0b6122434f941f6e342d364250"}]},"PHID-TASK-mjrrdzwznndsvmlifcwe":{"id":"47","title":"Whonix-Custom-Workstation should show VirtualBox First Run Wizard","status":"resolved","priority":"Normal","author":"Patrick","description":"It's currently not the case as a user reported on IRC, which is a usability issue.\n\nApparently not hard to fix:\n* https://forums.virtualbox.org/viewtopic.php?f=6&t=26400\n* `VBoxManage setextradata \"<VMName>\" \"GUI/FirstRun\" yes`","comments":[{"author":"Patrick","date_created":1420908565,"date_modified":1420908565,"content":"The `setextradata` command has been tested by me and worked.\n\nImplemented:\nhttps://github.com/Whonix/Whonix/commit/6b51e18b0a870555685a4197fafd35653bfaab19\n\nNew build not yet tested. Should work, because it's a quite simple change. Maybe there will be a new Whonix-Custom-Workstation release with #Whonix_10."}]},"PHID-TASK-klkfxv6icnesmdpcg2zj":{"id":"46","title":"whonixcheck should check for dpkg problems","status":"resolved","priority":"Normal","author":"Patrick","description":"Before `whonixcheck` checks if a package manager is currently running, it should check if there are any issues with `dpkg`. Such as if `dpkg` was interrupted and now in a broken state that would prevent running `apt-get dist-upgrade`.\n\nA follow up task of:\nhttps://github.com/Whonix/Whonix/issues/353\n","comments":[{"author":"Patrick","date_created":1674125700,"date_modified":1674125700,"content":"This is implemented in `/usr/libexec/systemcheck/check_dpkg.bsh` for a long time already."}]},"PHID-TASK-sxyxfywcgpvurbxfgue6":{"id":"45","title":"bump debian/compat from 8 to 9 for all packages","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1420660084,"date_modified":1420660084,"content":"Done."}]},"PHID-TASK-s7udgcl3o2gmeqggydql":{"id":"44","title":"build option to download official image + analyze it + build own image + diff them","status":"open","priority":"Normal","author":"Patrick","description":"Verifiable Builds should be simplified further. If there was an easily accessible build parameter to to download official image + analyze it + build own image + diff them, then much more could be motivated to do this.\n\nRelated to:\nT43\n\nRelated:\n[Secure Whonix Downloader](https://www.whonix.org/wiki/Dev/SecureDownloader)\n","comments":[]},"PHID-TASK-27avinqfjijhfv5zaoaf":{"id":"43","title":"write a wrapper to simplify analyze_image","status":"open","priority":"Normal","author":"Patrick","description":"Looks like using https://github.com/Whonix/Whonix/blob/master/help-steps/analyze_image is currently too cumbersome. Haven't heard from anyone using it yet.\n\nThe first step to simplify it could be writing a wrapper that takes two images as input, such as:\n```\nsudo tool-name /path/to/first/file.ova /path/to/second/file.ova\n```\n\nTherefore wraps/abstracts the `analyze_image` script and sets the required parameters.\n\nRelated to:\nhttps://phabricator.whonix.org/T42\n","comments":[]},"PHID-TASK-2lxbtizt7hm3bwyvdsrf":{"id":"42","title":"convert analyze_image into a standalone package","status":"open","priority":"Normal","author":"Patrick","description":"script in question:\nhttps://github.com/Whonix/Whonix/blob/master/help-steps/analyze_image\n\nmight be helpful for the Debian project:\nhttps://wiki.debian.org/ReproducibleBuilds/Contribute#Working_on_installation_media_or_live_systems\n\nNot that simple, because there is no lib that abstracts mounting / unmounting images:\n\n* https://github.com/Whonix/Whonix/blob/master/help-steps/unmount-raw\n* https://github.com/Whonix/Whonix/blob/master/help-steps/mount-raw\n\nMaybe such a lib should be created beforehand.\n","comments":[]},"PHID-TASK-7ommwyyjihmecuqfc2kx":{"id":"41","title":"TBB signing key will change?","status":"resolved","priority":"Normal","author":"Patrick","description":"https://trac.torproject.org/projects/tor/ticket/13407\n\nhttps://trac.torproject.org/projects/tor/ticket/13407#comment:14","comments":[{"author":"Patrick","date_created":1420648908,"date_modified":1420648908,"content":"added new key tbb-team.asc as per https://trac.torproject.org/projects/tor/ticket/13407 which I verified to be signed by Georg Koppen:\nhttps://github.com/Whonix/tb-updater/commit/599a3e5a12cb315aaaa4c31f0478f7e0d80b959d"},{"author":"Patrick","date_created":1421275758,"date_modified":1421275758,"content":"Let's just hope they don't change the key before the release of Whonix 10. Then this would require a stable upgrade for Whonix 9."}]},"PHID-TASK-te74mdn2u6dns4shuv3h":{"id":"40","title":"consider transition from XChat to HexChat","status":"resolved","priority":"Normal","author":"Patrick","description":"A user on IRC reported, that XChat is no longer maintained upstream and that there is a actively maintained replacement called HexChat.\n\nhttps://packages.debian.org/jessie/hexchat\n\nTODO:\n\n* Learn more about HexChat, check if we should and can replace XChat with HexChat\n\nDepending on that, TODO:\n\n* deprecate #xchat-improved-privacy, make it `hexchat-improved-privacy`\n* feature request \"improved privacy mode\" against HexChat that could obsolete `hexchat-improved-privacy`\n* deprecate https://github.com/Whonix/apparmor-profile-xchat\n** consider making it https://github.com/Whonix/apparmor-profile-hexchat\n** ask upstream if they are interested to maintain an AppArmor profile\n\nForum discussion:\nhttps://forums.whonix.org/t/xchat-outdated-app-still-considered-safe-to-use/1647","comments":[{"author":"Patrick","date_created":1451910958,"date_modified":1451910958,"content":"`hexchat AppArmor profile for better security`:\nhttps://github.com/hexchat/hexchat/issues/1577"},{"author":"Patrick","date_created":1451911894,"date_modified":1451911894,"content":"`privacy mode`:\nhttps://github.com/hexchat/hexchat/issues/1578"},{"author":"Patrick","date_created":1451913407,"date_modified":1451913407,"content":"apparmor-profile-xchat now supports also HexChat. I thought that's the better solution than renaming the package.\n\n* https://github.com/Whonix/apparmor-profile-xchat/commit/def9ad7f435fca4eb58ae228524b3f9957f436f4\n* https://github.com/Whonix/apparmor-profile-xchat/commit/253d79bc0d112b2b9133041a69b5598fc39aae94\n* https://github.com/Whonix/apparmor-profile-xchat/commit/d5917bfabfa1d6ba9986fc9f4032cced4f9aa19b\n* https://github.com/Whonix/apparmor-profile-xchat/commit/8e4bfba23c077f3f6df194b860a45e6fc15414c0\n\nNot thoroughly tested yet. Please test, review and merge. @troubadour\n\nUnfortunately, upstream [does not](https://github.com/hexchat/hexchat/issues/1577#issuecomment-168668385) wish to merge the AppArmor profile."},{"author":"Patrick","date_created":1451945487,"date_modified":1451945487,"content":"Added a bunch of commits to https://github.com/Whonix/xchat-improved-privacy. Both, https://github.com/Whonix/xchat-improved-privacy and https://github.com/Whonix/apparmor-profile-xchat do now also support HexChat. This was the simpler solution than renaming these packages.\n\n```\ntransition from xchat to hexchat\n\nhave anon-workstation-default-applications depend on hexchat rather than xchat\n```\nhttps://github.com/Whonix/anon-meta-packages/commit/c3e851fb58370ee1aeb06428c00428d6f06097af\n\nTODO:\nCheck if HexChat has all the expected privacy settings after a new build."},{"author":"Patrick","date_created":1461704498,"date_modified":1461704498,"content":"https://github.com/Whonix/whonix-ws-irc-chat-support/commit/ad98f8b66bf1e2b8c1cb8b1425330748a69acde0\nhttps://github.com/Whonix/xchat-improved-privacy/commit/d91d06969170d704eba214faaeadf52c551b9143\nhttps://github.com/Whonix/xchat-improved-privacy/commit/6bc6d90e1ba400f831536208ac0b317954e556bb"},{"author":"Patrick","date_created":1461801697,"date_modified":1461801697,"content":"https://github.com/Whonix/qubes-whonix/commit/ce2a36ebab3a645e70e4a9b49cab707583d5e518\nhttps://github.com/Whonix/qubes-whonix/commit/d352376bdef192607d2d50bf6099e20f66f70db2\n"}]},"PHID-TASK-uiiueuqvaew4tfrowsp5":{"id":"39","title":"x3","status":"invalid","priority":"Low","author":"adretest","description":"x3","comments":[]},"PHID-TASK-ddi7ja7idgcez3bjvbyf":{"id":"38","title":"test create new subtask of T37","status":"invalid","priority":"Low","author":"WhonixQubes","description":"testing\n\nqubes","comments":[]},"PHID-TASK-icnpm4pf6d3ea4rzyoez":{"id":"37","title":"test create new qubes ticket","status":"invalid","priority":"Low","author":"WhonixQubes","description":"testing\n\nqubes","comments":[]},"PHID-TASK-jbwp56my4rivqlrpn566":{"id":"36","title":"x2","status":"resolved","priority":"Low","author":"adretest","description":"x2","comments":[]},"PHID-TASK-lbpyrtuxadjx73tgdumt":{"id":"35","title":"x","status":"invalid","priority":"Low","author":"adretest","description":"x","comments":[]},"PHID-TASK-xfnsvvjnbw2xtageqheu":{"id":"34","title":"test 2 phabricator notification","status":"invalid","priority":"Low","author":"Patrick","description":"Let's see if you get notification.","comments":[{"author":"WhonixQubes","date_created":1420312459,"date_modified":1420312459,"content":"Success. Got email notification."},{"author":"Patrick","date_created":1420640087,"date_modified":1420640087,"content":"Great."}]},"PHID-TASK-d2sbihdx6cb6t4lqebbu":{"id":"33","title":"test phabricator notification","status":"resolved","priority":"Normal","author":"Patrick","description":"Let's see if you got a notification.","comments":[{"author":"WhonixQubes","date_created":1420307930,"date_modified":1420307930,"content":"No notification. Testing a response."},{"author":"Patrick","date_created":1438967364,"date_modified":1438967364,"content":"Writing some text.\n\nSome more text.\n"},{"author":"Patrick","date_created":1438967401,"date_modified":1438967401,"content":"Test top posting first line.\n\nSecond line top posting.\n\nPatrick (Patrick Schleizer):\n> Patrick added a comment.\n> \n> Writing some text.\n> \n> Some more text.\n> \n> \n> TASK DETAIL\n>   https://phabricator.whonix.org/T33\n> \n> EMAIL PREFERENCES\n>   https://phabricator.whonix.org/settings/panel/emailpreferences/\n> \n> To: Patrick\n> Cc: Patrick\n>"},{"author":"Patrick","date_created":1438967519,"date_modified":1438967519,"content":"Patrick Schleizer:"},{"author":"Patrick","date_created":1438967582,"date_modified":1438967582,"content":"Another top posting test."},{"author":"Patrick","date_created":1438967718,"date_modified":1438967718,"content":"Another top posting test.\n\nTest:"},{"author":"Patrick","date_created":1438968507,"date_modified":1438968507,"content":"Again, another top posting test.\n\nTest:"},{"author":"Patrick","date_created":1447436153,"date_modified":1447436153,"content":"Test\n\nhttps://github.com/Whonix/Whonix/commit/5a31f2f22015a2b99f4d8cc38fd3a8d372081e1e\n\nhttps://phabricator.whonix.org/rWHONIX5a31f2f22015a2b99f4d8cc38fd3a8d372081e1e\n"}]},"PHID-TASK-w4mt7nym34qkzu57fj34":{"id":"32","title":"check if the haveged entropy gathering daemon passes entropy tests in Qubes","status":"resolved","priority":"Normal","author":"Patrick","description":"General info on entropy:\nhttps://www.whonix.org/wiki/Dev/Entropy\n\nInstructions on how to test haveged:\nhttps://www.whonix.org/wiki/Dev/Entropy#haveged\n\n\n\nForum Discussion:\n- https://www.whonix.org/forum/index.php/topic,871.0.html","comments":[{"author":"WhonixQubes","date_created":1425247124,"date_modified":1425247124,"content":"Still have to get to this later, but...\n\nJust saw T202.\n\nRan this several times in a row on Qubes + Whonix:\n\n```\ncat /proc/sys/kernel/random/entropy_avail\n```\n\nFor me, it is consistently putting out results steadily in the 4000+ down to 1000+ range and then replenishing back up to 4000+ as it gets used up, across every ~10 seconds.\n\n# Check entropy available bits, 112 is FIPS-140 requirement\n\nHopefully this is a gauge of the same general entropy pool for the system and hopefully a positive indicator."},{"author":"Patrick","date_created":1425247317,"date_modified":1425247317,"content":"Yeah, well, I don't think this /proc/sys/kernel/random/entropy_avail test is particularly meaningful."},{"author":"WhonixQubes","date_created":1425247548,"date_modified":1425247548,"content":"Ok, good to know. Will certainly have to get to a more thorough review of Whonix entropy in Qubes."},{"author":"Patrick","date_created":1440008228,"date_modified":1440008228,"content":"Couldn't find any irregularities compared to non-Qubes systems."}]},"PHID-TASK-tetamvbpphxryc3gsxom":{"id":"31","title":"forward randomness from /dev/random to VMs in Qubes","status":"open","priority":"Normal","author":"Patrick","description":"Talked to Joanna at C1C3.\n\nQubes does not forward real randomness from `/dev/random` to VMs yet. They have no plans to add this feature yet.\n\nAlthough Qubes installs `haveged` by default, it's not clear if that is random enough. Randomness is a very difficult topic. Difficult to get down the rabbit hole. It's better to bootstrap `haveged` with strong entropy and to have multiple sources of randomness.\n\nIn comparison, for `KVM` there is `VirtIO RNG`.\n\n> VirtIO RNG is a paravirtualized device that is exposed as a hardware RNG device to the guest.\n\nAnd I don't think they implemented this because they were bored. I think in this case it's better to be safe than sorry.\n\nShe said one could implement this using `qrexec` and that they would merge a patch implementing this.\n\nSee also:\n- https://github.com/QubesOS/qubes-issues/issues/673\n- https://github.com/QubesOS/qubes-issues/issues/673#issuecomment-108585795\n\nGeneral info on randomness:\n- https://www.whonix.org/wiki/Dev/Entropy\n\n\n\nForum Discussion:\n- https://www.whonix.org/forum/index.php/topic,870.0.html","comments":[]},"PHID-TASK-a3hyvlrc7qmnhr45bh7y":{"id":"30","title":"sdwdate sclockadj ruby-inline require bug","status":"resolved","priority":"Normal","author":"Patrick","description":"```\n5767: Launching into background:       sudo          INLINEDIR=/var/cache/sdwdate             /usr/lib/sdwdate/sclockadj                --no-verbose                --no-debug                --no-first-wait                                --move-min 500000                --move-max 500000                --wait-min 1000000000                --wait-max 1000000000                --subtract 1290159494    \n5767: Started subshell for sclockadj with pid: 25369\n5767: sdwdate_subshell_read: start\n5767: dispatching post_success (SDW_MODE: daemon): /usr/lib/timesync/timesync_post_success --autostart --identifier \"timesync\" --progressbaridx \"$ID\" --mode \"$SDW_MODE\" --whoami \"$who_ami\"\n5767: sdwdate_subshell_read: sclockadj reports: Time before running sclockadj: 1418677914.833885947 [Mon Dec 15 21:11:54 UTC 2014]\n5767: sdwdate_subshell_read: sclockadj reports: sdwdate_subshell_wait: Waiting for pid to finish SDWDATE_SCLOCKADJ_COMMAND_PID: 25380\n5767: sdwdate_subshell_read: sclockadj reports: /usr/lib/ruby/1.9.1/rubygems/custom_require.rb:36:in `require': cannot load such file -- /var/cache/sdwdate/.ruby_inline/ruby-1.9.1/Inline_Cinline_45aeaf467303ff06d9c25b91daa74e32.so (LoadError)\n5767: sdwdate_subshell_read: sclockadj reports: from /usr/lib/ruby/1.9.1/rubygems/custom_require.rb:36:in `require'\n5767: sdwdate_subshell_read: sclockadj reports: from /usr/lib/ruby/vendor_ruby/inline.rb:531:in `load'\n5767: sdwdate_subshell_read: sclockadj reports: from /usr/lib/ruby/vendor_ruby/inline.rb:844:in `inline'\n5767: sdwdate_subshell_read: sclockadj reports: from /usr/lib/sdwdate/sclockadj:189:in `<class:Cinline>'\n5767: sdwdate_subshell_read: sclockadj reports: from /usr/lib/sdwdate/sclockadj:187:in `<main>'\n5767: sdwdate_subshell_read: sclockadj reports: sdwdate_subshell_wait: SDWDATE_SCLOCKADJ_COMMAND_PID: 25380 | SDWDATE_SCLOCKADJ_COMMAND_EXIT_CODE: 1\n5767: sdwdate_subshell_read: sclockadj reports: was running for 0 s [~ 0.00 min] [~ 0.00 h].\n5767: sdwdate_subshell_read: sclockadj reports: Time after running sclockadj: 1418677914.953156268 [Mon Dec 15 21:11:54 UTC 2014]\n5767: sdwdate_subshell_read: sclockadj reports: exit code: 1\n5767: sdwdate_subshell_read: end\n```\n\nSpontaneously happened out of nowhere. Worked before.\n\nCould not reproduce this by running\n```\nsudo          INLINEDIR=/var/cache/sdwdate             /usr/lib/sdwdate/sclockadj                --no-verbose                --no-debug                --no-first-wait                                --move-min 500000                --move-max 500000                --wait-min 1000000000                --wait-max 1000000000                --subtract 1290159494\n````\nmanually afterwards.\n\nAny idea why this could happen?","comments":[{"author":"Patrick","date_created":1418692195,"date_modified":1418692195,"content":"By the way, this also happed before changing `INLINEDIR` once.\n\nThat's what originally was motivated me to do this:\n\n* [sclockadj indent fix #369](https://github.com/Whonix/Whonix/issues/369)\n* [sclockadj does not fail when run without right to change clock / clock_(gettime/settime) return code checking #370 ](https://github.com/Whonix/Whonix/issues/370)\n* [sclockadj home folder permission issue #365](https://github.com/Whonix/Whonix/issues/365)\n\nSeems to happen only seldom. [But happens apparently.](https://github.com/Whonix/Whonix/issues/373)\n"},{"author":"Patrick","date_created":1418692323,"date_modified":1418692323,"content":"Probably unrelated: [sclockadj stuck at 100% CPU](https://www.whonix.org/forum/index.php/topic,804)."},{"author":"Patrick","date_created":1418693658,"date_modified":1418693658,"content":"After some searching, I conclude, it could be related to permissions:\nhttps://github.com/Whonix/sdwdate/blob/master/debian/sdwdate.postinst#L28\nWould perhaps be better if owned by `root`."},{"author":"Patrick","date_created":1418694245,"date_modified":1418694245,"content":"Attempt to fix:\nhttps://github.com/Whonix/sdwdate/commit/ddab4502cfa5959279c735f0f283401cd67d9be6"},{"author":"Patrick","date_created":1418695105,"date_modified":1418695105,"content":"Added more debugging info:\nhttps://github.com/Whonix/sdwdate/commit/2b768717083fc9e7b1ff12d9e6ae58e975e5a1c6"},{"author":"Patrick","date_created":1421342662,"date_modified":1421342662,"content":"Any idea @JasonJAyalaP?"},{"author":"JasonJAyalaP","date_created":1421436151,"date_modified":1421436151,"content":"It looks like ruby_inline thinks there's pre-compiled code in the inline dir, tries to load it, but fails. I don't know if that's because there isn't the compiled code (and ruby inline should have compiled it) or some other reason. That load error is too generic to be sure."},{"author":"Patrick","date_created":1421436611,"date_modified":1421436611,"content":"Ok. Closed for now. Should be fixed. Didn't run into this issue for a while now. And if it happens again, there will be helpful debug output. In case I notice again, I'll reopen."}]},"PHID-TASK-k64d7m7is7oa75lykalw":{"id":"29","title":"link open \"Firefox is already running, but is not responding.\" bug -> always start Tor Browser with --allow-remote","status":"resolved","priority":"Normal","author":"Patrick","description":"Always start Tor Browser with `--allow-remote`.\n\nOtherwise there will be an error message:\n`Firefox is already running, but is not responding. To open a new window, you must first close the existing Firefox process, or restart your system.`","comments":[{"author":"Patrick","date_created":1418347630,"date_modified":1418347630,"content":"Fixed:\nhttps://github.com/Whonix/tb-starter/commit/72e59d4a64f145437d2056405df17b0d83a939fb"},{"author":"WhonixQubes","date_created":1420584543,"date_modified":1420584543,"content":"I am independently developing some Qubes software which will also benefit Whonix on the Qubes platform. And am in need of this --allow-remote functionality as a default for Whonix Qubes in upcoming months.\n\nI see that T24 \"wait for Debian jessie to become the new Debian stable release\" is setup as a blocker for Whonix 10 and this is T29 is also tagged for Whonix 10.\n\nWondering if Whonix 10 and Debian Jessie stable will hold up this important --allow-remote functionality for Tor Browser for longer than 3 months or so? Could certainly use --allow-remote as default in the near future! :)"},{"author":"Patrick","date_created":1420587968,"date_modified":1420587968,"content":"> I see that T24 \"wait for Debian jessie to become the new Debian stable release\" is setup as a blocker for Whonix 10 and this is T29 is also tagged for Whonix 10.\n\nThe tracker is not all that strict. Having jessie or not is not a strict blocker for Whonix 10. Gladly, the policy still man made and debatable. :)\n\nIf Whonix 10 will be based on jessie or wheezy depends on whether jessie will be blessed stable by then. It would be nice to have Whonix 10 ready to be upgraded from wheezy to jessie at least. Quite some [systemd work TODO](https://www.whonix.org/forum/index.php/topic,707).\n\n> Wondering if Whonix 10 and Debian Jessie stable will hold up this important --allow-remote functionality for Tor Browser for longer than 3 months or so? Could certainly use --allow-remote as default in the near future! :)\n\nIf you need it just for private use, just install latest version of [`tb-starter`](https://github.com/Whonix/tb-starter), which includes the fix or just replace your existing script with the updated https://github.com/Whonix/tb-starter/blob/master/usr/bin/torbrowser - same effect.\n\nHope that helps. Otherwise please elaborate."},{"author":"WhonixQubes","date_created":1420674740,"date_modified":1420674740,"content":"Thanks Patrick! More an issue of the time to wait for --allow-remote becoming shipped in Whonix by default.\n\nI have already implemented --allow-remote for myself, but am looking to have my new upcoming Qubes application utilize --allow-remote for Whonix on other people's Whonix Qubes machines.\n\nSo just expressing timeframe desires for assuming --allow-remote as an upstream Whonix default."},{"author":"Patrick","date_created":1420737390,"date_modified":1420737390,"content":"There is no ETA for Whonix 10 yet. Please open a forum discussion or ticket if you want to discuss that."}]},"PHID-TASK-f2fiw5mxdrcm5slzwhu2":{"id":"28","title":"RELATED,ESTABLISHED -> ESTABLISHED","status":"resolved","priority":"Normal","author":"Patrick","description":"Source of inspiration:\n[Tails-dev] Reducing attack surface of kernel and tightening firewall/sysctls \nhttps://www.mail-archive.com/tails-dev@boum.org/msg07483.html\n\nIn https://github.com/Whonix/whonix-gw-firewall/blob/master/usr/bin/whonix_firewall#L249\n\nchanging\n\n```\niptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT\n```\n\nto\n\n```\niptables -A INPUT -m state --state ESTABLISHED -j ACCEPT\n```\n\nCurrently testing on my local machine.\n\nOther testers welcome.","comments":[{"author":"Patrick","date_created":1418989533,"date_modified":1418989533,"content":"Done:\nhttps://github.com/Whonix/whonix-gw-firewall/commit/414c2105149e02dcff82303e4c5b2dcd60ebbd29"},{"author":"Patrick","date_created":1683622818,"date_modified":1683622818,"content":"Fixed link:\nhttps://github.com/Whonix/whonix-firewall/commit/414c2105149e02dcff82303e4c5b2dcd60ebbd29"},{"author":"Patrick","date_created":1683624242,"date_modified":1683624242,"content":"related:\nhttps://forums.whonix.org/t/tails-features-ideas/2611\n"}]},"PHID-TASK-dkawe7776qulrrqd5cku":{"id":"27","title":"create grub-screen-resolution package","status":"resolved","priority":"Normal","author":"Patrick","description":"Now that [grub-enable-apparmor](https://phabricator.whonix.org/T25) gets simplified, the unrelated settings it applied should be put into separate packages.\n\nThe grub-screen-resolution package should inject \"vga=0x0317\" into GRUB_CMDLINE_LINUX_DEFAULT using `/etc/default/grub.d` in order to set a higher screen resolution (1024x768) during boot. For better usability, to make things easier to read, so they pass through a little slower and to ease debugging in case of issues.","comments":[{"author":"Patrick","date_created":1434329362,"date_modified":1434329362,"content":"`Fixed \"vga=ext is deprecated. Use set gfxpayload=text before linux command instead\". Upgraded for grub2 / Debian jessie.`:\nhttps://github.com/Whonix/grub-screen-resolution/commit/c3b653a27c95f2b513953c63b714962746ae09a3\n"}]},"PHID-TASK-eogfmgyaf7at2qm5q6qi":{"id":"26","title":"create grub-output-verbose package","status":"resolved","priority":"Normal","author":"Patrick","description":"Now that [grub-enable-apparmor](https://phabricator.whonix.org/T25) gets simplified, the unrelated settings it applied should be put into separate packages.\n\nThe grub-output-verbose package should remove \"quiet\" from GRUB_CMDLINE_LINUX_DEFAULT using `/etc/default/grub.d` in order to enable verbose output during boot. For better usability, so it doesn't look like boot hangs on slow systems and to ease debugging in case of issues.","comments":[]},"PHID-TASK-rhfu4gypyer3c7pidvvr":{"id":"25","title":"simplify grub-enable-apparmor for Debian jessie","status":"resolved","priority":"Normal","author":"Patrick","description":"Thanks to the new `/etc/default/grub.d` configuration folder, the `grub-enable-apparmor` can be greatly simplified. No longer need to config-package-dev divert `/etc/default/grub`.\n\nProduced a branch that implements this:\nhttps://github.com/Whonix/grub-enable-apparmor/tree/jessie\n","comments":[{"author":"Patrick","date_created":1429718798,"date_modified":1429718798,"content":"Done:\nhttps://github.com/Whonix/grub-enable-apparmor/commit/4f91452b701b467ae9471291f270b95ba4d85479\n"}]},"PHID-TASK-qbguoxkoid6vj3mcrst7":{"id":"24","title":"maybe wait for Debian jessie to become the new Debian stable release","status":"resolved","priority":"Normal","author":"Patrick","description":"There are a few things we cannot do before `jessie` has become the next Debian `stable`.\n\nThis ticket will function as a blocker in meanwhile.\n\n\"Maybe\" means, when when #Whonix_10 tasks are done, i.e. when #Whonix_10 is ready for release, but `jessie` has not become Debian `stable` at that point, then #Whonix_10 would be released using `jessie`. One of @Patrick's goals for #Whonix_10 is being ready for `jessie`, i.e. have #Whonix_10 being capable of being upgraded to `jessie`.","comments":[{"author":"Patrick","date_created":1427991010,"date_modified":1427991010,"content":"Quote https://lists.debian.org/debian-devel-announce/2015/03/msg00002.html:\n\n> an April release is /a possibility/ - *however*\n"},{"author":"Patrick","date_created":1429929462,"date_modified":1429929462,"content":"Quote https://lists.debian.org/debian-devel-announce/2015/03/msg00016.html:\n> We now have a target release date of Saturday the 25th of April.\n"},{"author":"Patrick","date_created":1430144391,"date_modified":1430144391,"content":"Debian 8 \"Jessie\" released:\nhttps://www.debian.org/News/2015/20150426\n"}]},"PHID-TASK-tqcfgjme3htbnxkqqsmy":{"id":"23","title":"add su-to-root (menu) to anon-shared-packages-recommended","status":"resolved","priority":"Normal","author":"Patrick","description":"Install `menu` (contains `su-to-root`) by default.\n\nRelated to:\nhttps://phabricator.whonix.org/T22\n","comments":[{"author":"Patrick","date_created":1418068254,"date_modified":1418068254,"content":"Done:\nhttps://github.com/Whonix/anon-meta-packages/commit/5beecc1e2b825e68916e3083e9e6dbf41681f17d"}]},"PHID-TASK-rwsmxi3xwc3flyflqd2b":{"id":"22","title":"replace kdesudo with su-to-root in documentation","status":"open","priority":"Normal","author":"Patrick","description":"Rather than using.\n\n```\nkdesudo kate ...\n```\n\nWhich is KDE specific. What about changing documentation to.\n\n```\nsu-to-root -X -c kate ...\n```\n\nThat command is slightly more complicated (just the extra `-X -c`), but that command is agnostic about the desktop environment. [Other desktop environments](https://www.whonix.org/wiki/Other_Desktop_Environments) such as Gnome that come with `gksudo` by default would then be easier to use.\n\nIf that sounds good, I could easily and quickly mass search and replace that string in the wiki thanks to the [replace text mediawiki extension](https://www.mediawiki.org/wiki/Extension:Replace_Text).\n\nStatus:\n\n* work on https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=793376 needed","comments":[{"author":"Patrick","date_created":1421276033,"date_modified":1421276033,"content":"Not all that simple, because `su-to-root` lacks support for passing command line arguments to applications."},{"author":"Patrick","date_created":1437574777,"date_modified":1437574777,"content":">>! In T22#834, @Patrick wrote:\n> Not all that simple, because `su-to-root` lacks support for passing command line arguments to applications.\n\nI was wrong. We could use something like following example. With quotes. The syntax is not a pretty due to quotes. (Working on a patch: T85)\n\n```\nsu-to-root -X -c 'whonix-setup-wizard setup'\nsu-to-root -X -c \"kate /etc/apt/sources.list\"\n```\n\nUnfortunately, su-to-root does not prefer kdesudo (that honors /etc/sudoers.d) over gksu (that does not). TODO: consider shipping a config file that prefers kdesudo or writing a patch upstream that gives higher priority to kdesudo for the su tool autodetection code."},{"author":"Patrick","date_created":1437682092,"date_modified":1437682092,"content":"> TODO: consider shipping a config file that prefers kdesudo or writing a patch upstream that gives higher priority to kdesudo for the su tool autodetection code.\n\nDone:\n\n* http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=793376\n* https://github.com/adrelanos/menu/pull/1"},{"author":"Patrick","date_created":1437684590,"date_modified":1437684590,"content":"Let's consider adding the following `/etc/su-to-rootrc` [using config-package-dev] to the #usability-misc package for #Whonix_12:\n```\n## This file is part of Whonix.\n## Copyright (C) 2012 - 2014 Patrick Schleizer <adrelanos@riseup.net>\n## See the file COPYING for copying conditions.\n\n## For better usability.\n## Using this until/if Debian upstream feature request\n## su-to-root: higher priority for kdesudo and gksudo\n## https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=793376\n## gets implemented.\n## Otherwise su-to-root would default to gksu, which always\n## asks for a password and ignores /etc/sudoers(.d).\n## Feel free to delete this file or to change its settings.\n\nSU_TO_ROOT_X=kdesudo\n```\n"},{"author":"Patrick","date_created":1443551421,"date_modified":1443551421,"content":"https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=793376"}]},"PHID-TASK-qalkfzu32umbcg4jv2fy":{"id":"21","title":"Whonix Host Additions","status":"open","priority":"Normal","author":"Patrick","description":"Important:\n\n* Host firewall - still unfinished - still untested - https://github.com/Whonix/whonix-host-firewall\n* ~~tcp timestamps: install [tcp-timestamps-disable](https://github.com/Whonix/tcp-timestamps-disable)~~ (done: `anon-host-additions` depends on `anon-shared-packages-dependencies` which depends on `tcp-timestamps-disable`)\n* ~~icmp timestamps~~ (done: blocked by https://github.com/Whonix/whonix-host-firewall)\n* ~~sdwdate / timesync~~ (done: `anon-host-additions` depends on `anon-shared-packages-dependencies` which depends on `sdwdate`, `timesync`,etc.)\n\n-----\n\nBonus:\n\n* `corridor` firewall feature, see this [post](https://www.whonix.org/forum/index.php/topic,416.msg3119.html#msg3119) \n\n* ~~AppArmor for VBox~~ (whonix-host-virtualbox suggests apparmor-profile-virtualbox)\n* ~~AppArmor for KVM~~ (Not required. libvirt comes with svirt.)\n\n* ~~ksm~~\n * ~~https://github.com/dnaeon/ksm-init.d-debian ~~\n * ~~https://www.whonix.org/wiki/Dev/KVM#Kernel_Samepage_Merging_.28KSM.29 ~~\n * ~~Not enabled by default as per https://www.whonix.org/forum/index.php/topic,605.0/topicseen.html ~~\n\n* Shared Folder Settings\n\n* Backup of hidden service keys.\n\n* ~~Apply instructions from https://whonix.org/wiki/Advanced_Security_Guide#Network_Time_Synchronization ~~ (no longer needed thanks to https://github.com/Whonix/bootclockrandomization)\n* create original snapshots of Virtual Machines ([not for VirtualBox due to bug in VirtualBox](https://www.whonix.org/wiki/Security_Guide#Reliable_Alternative_To_Virtualbox_VM_Snapshots))\n\n-----\n\nIf needed, we can split this ticket into separate ones.\n\n-----\n\nUpdate:\nRemoved defunct `./whonix_host` folder in meanwhile.\n\n* https://github.com/Whonix/Whonix/blob/5404ab9f71f43b08c961f2b8f5b96974fb64b115/whonix_host/dev_clearnet\n* https://github.com/Whonix/Whonix/blob/5404ab9f71f43b08c961f2b8f5b96974fb64b115/whonix_host/whonix_firewall","comments":[{"author":"Patrick","date_created":1418984987,"date_modified":1418984987,"content":"Packaged `ksm`:\nhttps://github.com/Whonix/ksm"},{"author":"Patrick","date_created":1418988434,"date_modified":1418988434,"content":"Work on Whonix Host:\nhttps://github.com/Whonix/anon-meta-packages/commit/82ca3c10a8b145f23fa5bf6d9ed4421503da1162"},{"author":"HulaHoop","date_created":1434320553,"date_modified":1434320553,"content":"The hypothetical Corridor package should have apt-transport-tor as a dependency to make sure the system can update when its enabled. Also tb-updater as a dependency so a user can still browse the internet."},{"author":"HulaHoop","date_created":1434324378,"date_modified":1434324378,"content":"The shared-folder-help package does similar functions to what would be needed to create a shared folder on the Host. "},{"author":"HulaHoop","date_created":1459262445,"date_modified":1459262445,"content":"Can sdwdate/timesync and tbb-downloader work with system Tor on the Host without any changes?"},{"author":"Patrick","date_created":1459263764,"date_modified":1459263764,"content":"HulaHoop (HulaHoop):\n>   Can sdwdate/timesync and tbb-downloader work with system Tor on the Host without any changes?\n\nIt should, but there is no one maintaining (testing, documenting, user\nsupport) this use case."}]},"PHID-TASK-cikunpxyynzhut4v5seh":{"id":"20","title":"proxy warning in documentation","status":"resolved","priority":"Normal","author":"Patrick","description":"Please review if\n\n* https://www.whonix.org/wiki/Tunnel_Tor_through_proxy_or_VPN_or_SSH#Tunnel_Tor_through_proxy\n* https://www.whonix.org/wiki/Tunnel_Proxy_or_SSH_or_VPN_through_Tor#Tunnel_proxy_through_Tor\n* https://www.whonix.org/wiki/Comparison_Of_Tor_with_CGI_Proxies,_Proxy_Chains,_and_VPN_Services#Comparison_of_Tor_and_Proxies\n\nmakes sense.","comments":[{"author":"JasonJAyalaP","date_created":1416869457,"date_modified":1416869457,"content":"I reviewed and edited. I simplified it a lot. I might have misunderstood a few points, so please review, Patrick.\n\nHowever, it seems our stance on/documentation/support for proxies should be simply: Don't use them. They're bad. You don't need them with Whonix. We don't support them. They're stupid. Bad idea. Don't use them.\n"},{"author":"Patrick","date_created":1416871302,"date_modified":1416871302,"content":"> I reviewed and edited. I simplified it a lot. I might have misunderstood a few points, so please review, Patrick.\n\nSmall change, big difference:\nhttps://www.whonix.org/w/index.php?title=Comparison_Of_Tor_with_CGI_Proxies%2C_Proxy_Chains%2C_and_VPN_Services&diff=13291&oldid=13290\n\n> However, it seems our stance on/documentation/support for proxies should be simply: Don't use them. They're bad. You don't need them with Whonix. We don't support them. They're stupid. Bad idea. Don't use them.\n\nWell, it depends what one wants to do with them.\n\n* For using proxies instead of Tor/Whonix, the simple version of the comparison could indeed just say, \"the short answer is, recommended against, forget about them\". The technical details could be buried below an \"expand\" button ([we already got quite some expand buttons (example)](https://www.whonix.org/wiki/Dev/Build_Documentation/10_full#Warning)). The technical details are important for those who still believe their myths (\"I am behind 10 proxies, so what.\") and don't trust the short explanation without further explanations and references.\n* user -> proxy -> Tor -> destination: If it helps someone circumvent ISP Tor bans and they understand the details, why not.\n* user -> Tor -> proxy -> destination: If it helps someone reach a website the banned whole Tor and thy understand the details, why not.\n\nWe can consider to deter more users adding a \"advanced users only\" warning box."},{"author":"JasonJAyalaP","date_created":1416892639,"date_modified":1416892639,"content":"I see.\n\nReady to close?"},{"author":"Patrick","date_created":1416933301,"date_modified":1416933301,"content":"Yes."}]},"PHID-TASK-4jcojwvhkiw7pw5427ih":{"id":"19","title":"clean unused (spam bot) wiki accounts","status":"resolved","priority":"Normal","author":"Patrick","description":"","comments":[{"author":"Patrick","date_created":1416770592,"date_modified":1416770592,"content":"Done.\n\n`cd /var/www/w/maintenance`\n`php removeUnusedAccounts.php --ignore-groups translator --delete`\n"}]},"PHID-TASK-vwjaqio2z6erjyjlvuxn":{"id":"18","title":"using torbrowser-launcher by default instead of tb-updater in Whonix","status":"open","priority":"Normal","author":"Patrick","description":"Being discussed here:\nWhonix Development Forum - using torbrowser-launcher instead of tb-updater in Whonix:\nhttps://forums.whonix.org/t/using-torbrowser-launcher-instead-of-tb-updater-in-whonix/385","comments":[]},"PHID-TASK-xj7ae2xzdjwwtkvrqvuk":{"id":"17","title":"ARP spoofing defense","status":"open","priority":"Normal","author":"Patrick","description":"In context of [Multiple Whonix-Workstations](https://www.whonix.org/wiki/Multiple_Whonix-Workstations) it would increase security to have secure [Connections between Whonix-Gateway and Whonix-Workstation](https://www.whonix.org/wiki/Connections_between_Whonix-Gateway_and_Whonix-Workstation).\n\nTODO:\n\n* research if ARP spoofing defense could be applied in context of Whonix\n* consider implementing it","comments":[]},"PHID-TASK-xmwyceyeuc2ho7x2gl7y":{"id":"16","title":"iptables ddos protection","status":"open","priority":"Normal","author":"Patrick","description":"TODO:\n\n* research if adding any iptables ddos protection rules by default would make sense in context of Whonix\n** improving ddos resistance\n** not opening new privacy issues\n** not opening new fingerprinting vectors\n* consider implementing them","comments":[{"author":"HulaHoop","date_created":1416719747,"date_modified":1416719747,"content":"Basic research I did: http://people.netfilter.org/hawk/presentations/devconf2014/iptables-ddos-mitigation_JesperBrouer.pdf\n\nsome things like enabling tcp timestamps dont make sense from a privacy perspective so ignore them."},{"author":"Patrick","date_created":1416766719,"date_modified":1416766719,"content":"> http://people.netfilter.org/hawk/presentations/devconf2014/iptables-ddos-mitigation_JesperBrouer.pdf\n\nCorresponding video:\nhttps://www.youtube.com/watch?v=BklSqr9t4uA\n"},{"author":"infinitnet","date_created":1461147277,"date_modified":1461147277,"content":"Apart from SYNPROXY there are more effective iptables rules for DDoS mitigation discussed here: https://javapipe.com/iptables-ddos-protection\nSome of those should be added to whonix-gw-firewall as well imo."}]},"PHID-TASK-wghdh46kv36yp63ust3s":{"id":"15","title":"iptables anti-spoofing rules","status":"open","priority":"Normal","author":"Patrick","description":"TODO:\n\n* research if anti-spoofing rules would make sense in context of Whonix\n** http://www.fwbuilder.org/4.0/docs/users_guide5/anti-spoofing-rules.shtml\n** http://www.sns.ias.edu/~jns/files/iptables_ruleset\n* consider implementing them\n","comments":[]},"PHID-TASK-4qodydjmhpbntpflokpr":{"id":"14","title":"apparmor: deprecate consoles.anondist?","status":"resolved","priority":"Normal","author":"Patrick","description":"Since tlsdate turned out not be be usable for out sdwdate use case (cannot connect to Tor hidden services) (and more, see also: https://github.com/Whonix/Whonix/issues/349) we should deprecate consoles.anondist for simplicity?\n\nTODO:\n* delete https://github.com/Whonix/apparmor-profile-anondist/blob/master/etc/apparmor.d/abstractions/consoles.anondist\n* remove from https://github.com/Whonix/apparmor-profile-anondist/blob/master/debian/control\n","comments":[{"author":"Patrick","date_created":1421540571,"date_modified":1421540571,"content":"@troubadour, what do you think?"},{"author":"troubadour","date_created":1421784811,"date_modified":1421784811,"content":"Yes, we can remove it. Actually, I have not used it for a long time (since we started with tlsdate, I think), and it does not break anything."},{"author":"Patrick","date_created":1421787808,"date_modified":1421787808,"content":"Done, removed:\nhttps://github.com/Whonix/apparmor-profile-anondist/commit/5fd67d78ba96fb1cf28072bd3fda51b8f8f8348b\n\nDidn't remove whole config-package-dev, because we're still using it for `/etc/apparmor.d/abstractions/base`."}]},"PHID-TASK-xaureqwwmme2i735viyd":{"id":"13","title":"virtualbox-guest-x11 installed by default?","status":"resolved","priority":"Normal","author":"Patrick","description":"Discussion:\nhttps://www.whonix.org/forum/index.php/topic,758","comments":[]},"PHID-TASK-igsd5s4aupeexzb2hajg":{"id":"12","title":"virtualizer: enforce maximum system resources a virtual machine may use","status":"open","priority":"Normal","author":"Patrick","description":"An adversary could stress either/and CPU, HDD, RAM, network connection and other Whonix-Workstations and perhaps also the host would suffer. This is bad:\n\n* attacks on anonymity when using multiple workstations (whether behind same gateway or not)\n* host ddos\n\nVirtual machines (VM) can use an unlimited amount of resources. I.e.\n\n* CPU load\n* network load\n* I/O (hdd) load\n* graphic calculation load\n* (RAM load?)\n\nThis might happen because some application inside a VM has a bug and starts draining resources or because a VM has been compromised.\n\nIdeally the virtualizer on the host would enforce maximum system resources the VM may use.\n\nThis ticket is a reminder to implement this protection for all virtualizers supported by Whonix some day.\n\nIf someone wants to implement this feature for a particular virtualizer, please create a sub task to keep things separated.\n\nRelated:\nT530","comments":[{"author":"HulaHoop","date_created":1432516481,"date_modified":1432516574,"content":"For CPU, setting the Linux scheduler to the Nice level for a VM process can limit effect of CPU DoS. Using cgroups, virtual machines can also be restricted to CPU limits which supports the prevention of denial of service.\n\nFor memory, reducing or disabling swap puts limits on memory DoS. \n\n\nEven without any changes to Host DoS can be effectively mitigated:\nLimiting the number of logical CPUs for a VM in its settings limits the amount of Host cores it can use.\nLinux's OOM-killer will identify and kill the offending VM process if causing the host to run out of memory.\n"},{"author":"HulaHoop","date_created":1433692335,"date_modified":1433692335,"content":"virsh can set disk activity limits per vm:\n\nhttps://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Virtualization_Tuning_and_Optimization_Guide/sect-Virtualization_Tuning_Optimization_Guide-BlockIO-Techniques.html"},{"author":"Patrick","date_created":1478875500,"date_modified":1478875500,"content":">>! In T567#10647, @HulaHoop wrote:\n> blkiotune and iotune can restrict io (KVM only)\n> \n> https://libvirt.org/formatdomain.html#elementsBlockTuning\n"},{"author":"HulaHoop","date_created":1478906408,"date_modified":1478906408,"content":"There's a problem with setting this. SSD vs HDD io throughput is very different. What is reasonable for one will be excessive or too low for the other."},{"author":"Patrick","date_created":1478917332,"date_modified":1478917332,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n>   There's a problem with setting this. SSD vs HDD io throughput is very different. What is reasonable for one will be excessive or too low for the other.\n\nSet the limit to protect against excessive use of SSD then. SSD users\nare better off then and HDD users not any worse. (HDD users would have\nto manually adjust that value.) (Or auto detect somehow?)"},{"author":"HulaHoop","date_created":1479530361,"date_modified":1479530361,"content":"Though I agree with anonym's argument that resource exhaustion goes against the purpose of advanced malware that wants to hide - I still looked at io limits in case you still think its valuable to set.\n\nTurns out blkiotune can partition resources using \"weighting\" aka percentage besides setting arbitrary limits.\n\nI think by \"host block device\" they refer to the physical device /dev/sda rather than getting into partition numbers like sda2. The latter would have made this option very messy.\n\nhttps://www.debian.org/releases/stable/i386/apcs04.html.en\n\nhttps://libvirt.org/formatdomain.html#elementsBlockTuning"},{"author":"Patrick","date_created":1479577890,"date_modified":1479577890,"content":"HulaHoop (HulaHoop):\n> HulaHoop added a comment.\n> \n> \n> Though I agree with anonym's argument that resource exhaustion goes\n> against the purpose of advanced malware that wants to hide\n\nMaybe. However, I wouldn't assume that no type of malware ever tries\nresource exhaustion.\n\n> I still looked at io limits in case you still think its valuable to set.\n\nYes, very much worthwhile. Should have always been a standard feature of\nany virtualizer. It's what one can reasonably expect, that no VM (or\napplication) is capable to exhaust resources so everything else suffers.\nEven if not malware, but just a bug, it still is a huge usability issue\nto run into cases where one thing can look up the whole computer."},{"author":"HulaHoop","date_created":1479654965,"date_modified":1479654965,"content":"Should limits be enforced for GW too?"},{"author":"Patrick","date_created":1479658063,"date_modified":1479658063,"content":"Yes."},{"author":"HulaHoop","date_created":1480288717,"date_modified":1480288717,"content":"Done. Added io limit commits to open pull requests. Each vm can only use a maximum of 25% of the host io resources."},{"author":"Patrick","date_created":1577003204,"date_modified":1577003204,"content":"cgroups were [mentioned](http://forums.whonix.org/t/etc-security-hardening/8592/5) by @madaidan\n\n> Cgroups may be a better option for that. Systemd uses cgroups and user sessions are run under a systemd slice by default AFAIK so we can just edit that https://www.freedesktop.org/software/systemd/man/systemd.resource-control.html\n"},{"author":"madaidan","date_created":1577130870,"date_modified":1577130870,"content":"We should be able to create a drop-in file at /lib/systemd/system/user-.slice.d/ and add something such as\n\n```\n[Slice]\nMemoryAccounting=yes\nMemoryMax=4G\n```\n\nwhich would prevent all users from using more than 4gb of memory.\n\nThere's more documentation on user slices at https://www.freedesktop.org/software/systemd/man/user@.service.html"}]},"PHID-TASK-rdrp56ekmv427squnaid":{"id":"11","title":"update technical design documentation","status":"open","priority":"Normal","author":"Patrick","description":"Now, that Whonix has been split into multiple packages, Whonix's technical design documentation needs to be updated.\n\nLink primary:\nhttps://www.whonix.org/wiki/Dev/Design-Detailed\n\nRelated:\nhttps://www.whonix.org/wiki/Dev","comments":[]},"PHID-TASK-5ivs3hgvlllusfrzxoqf":{"id":"10","title":"build script should provide better optical separation of build steps","status":"resolved","priority":"Normal","author":"Patrick","description":"When looking through the build log, it would be helpful if there was a clearer optical separation between build steps.","comments":[{"author":"Patrick","date_created":1427216401,"date_modified":1427216401,"content":"I needed to get rid of run-parts anyhow due to some unrelated issue (https://lists.gnu.org/archive/html/help-bash/2015-03/msg00066.html) that messed up the error handler. From there it was little effort to implement this one. Done:\nhttps://github.com/Whonix/Whonix/commit/d2347212a5f404a36a1d652839b2ce5ed9d9aa21\n\nThis is how it will look like (+ cyan color + bold + underline).\n\n```\n+ true '############################################################'\n+ true '############################################################'\n+ true '############################################################'\n+ true 'INFO: BEGIN: whonix_build_one_build_step_current: ./build-steps.d/1100_prepare-build-machine'\n```\n\n```\n...\n[usual output]\n...\n```\n\n```\n+ true 'INFO: END  : whonix_build_one_build_step_current: ./build-steps.d/1100_prepare-build-machine'\n+ true '############################################################'\n+ true '############################################################'\n+ true '############################################################'\n```\n\nIf you have other suggestions regarding formatting, colors and whatnot, please reopen this one."}]},"PHID-TASK-jv7mv4pvmsgpw5m4kbcz":{"id":"9","title":"tb-default-browser support for Gnome","status":"open","priority":"Normal","author":"Patrick","description":"tb-default-browser doesn't work in Gnome yet?\n\nTODO:\n\n* Find answer to above question.\n* Figure out Gnome's default browser mechanism.\n* Patch open-link-confirmation to support gnome.","comments":[{"author":"Patrick","date_created":1416507583,"date_modified":1416507583,"content":"Related:\nhttps://phabricator.whonix.org/T8"}]},"PHID-TASK-qlzpxnun5ydqwegoutbp":{"id":"8","title":"open-link-confirmation support for Gnome","status":"open","priority":"Normal","author":"Patrick","description":"open-link-confirmation doesn't work in Gnome yet?\n\nTODO:\n\n* Find answer to above question.\n* Figure out Gnome's default browser mechanism.\n* Patch open-link-confirmation to support gnome.","comments":[{"author":"Patrick","date_created":1416507570,"date_modified":1416507570,"content":"Related:\nhttps://phabricator.whonix.org/T9"},{"author":"HulaHoop","date_created":1458619306,"date_modified":1458619306,"content":"Can this question be answered by installing Gnome-shell and seeing what happens?"},{"author":"HulaHoop","date_created":1458619890,"date_modified":1458619890,"content":"dconf-editor provides a GUI for the browsing and editing of settings. It presents the hierarchy of settings in a tree-view and also displays additional information about each setting, including the description, type and default value. gsettings can be used to display and set dconf values. It also includes Bash completion for commands and settings. gsettings can be used to automate configuration in shell scripts. \n\nhttps://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/Desktop_Migration_and_Administration_Guide/browsing-gsettings-values-for-applications.html"},{"author":"Patrick","date_created":1458634401,"date_modified":1458634401,"content":"HulaHoop (HulaHoop):\n>   Can this question be answered by installing Gnome-shell and seeing what happens?\n\nYes."},{"author":"HulaHoop","date_created":1458746563,"date_modified":1458746563,"content":"I installed gnome-shell alongside kde and its badly broken that it won't login/start. Setting gdm3 as the default display server makes the system hang up at boot indefintiely."},{"author":"HulaHoop","date_created":1487696617,"date_modified":1487696617,"content":"This can be closed now since we are on KDE? Same with T9"},{"author":"Patrick","date_created":1487701261,"date_modified":1487701261,"content":"Should still be implemented to complete the package and to some day\nbetter support other desktop environments."}]},"PHID-TASK-3ajhspd73grzukns7gqy":{"id":"7","title":"donation currency","status":"resolved","priority":"Normal","author":"Patrick","description":"Accept donations in USD, EUR, multiple, otherwise?\n\nhttps://www.whonix.org/forum/index.php/topic,752\n","comments":[]},"PHID-TASK-yh3c7zjcfmvs3bnnv3a3":{"id":"6","title":"mediawiki: prevent spam bots from signing up","status":"resolved","priority":"Normal","author":"Patrick","description":"~5 automated bot accounts per hour are being created in Whonix wiki.\n\nSee them in action:\nhttps://www.whonix.org/wiki/Special:RecentChanges\n\nSee what (spam prevention) plugins are already installed:\nhttps://www.whonix.org/wiki/Special:Version\n\n* Current captcha's don't stop them.\n* ConfirmEdit questy captcha doesn't stop them.\n* E-mail verification doesn't stop them.\n\nTODO:\n* find a suited spam prevention plugin (https://www.mediawiki.org/wiki/Category:Spam_management_extensions)\n* install it on whonix.org","comments":[{"author":"Patrick","date_created":1416768291,"date_modified":1416768291,"content":"Went through that list. (https://www.mediawiki.org/wiki/Category:Spam_management_extensions) Most cannot be used for whonix.org wiki. Either they don't apply to this issue (bad words, bad files) or we cannot use them (popular spam filters that are IP based and also ban Tor users) or they're too weak.\n\nChanged the questy captcha question just now (~18:20 UTC). Let's see how long that works.\n\nThe ConfirmEdit module \"[Are You A Human](https://www.mediawiki.org/wiki/Extension:ConfirmEdit#Are_You_A_Human_.28aka_PlayThru.29)\" might work, but it would require manual merging and I don't know if it would contact google (the demo does so for audio captcha).\n\nIf that ends up soon inside the spam bot, I got another idea. Maybe a \"secret\" questy captcha word for registration that only Whonix team members know. We give it to anyone we think is a human.\n\nLast resort would be manual creation of accounts by wiki admins."},{"author":"Patrick","date_created":1417054300,"date_modified":1417054300,"content":"No more spam bot sign ups since then. Works for now."}]},"PHID-TASK-e6adie7ujvgmuihqy7vq":{"id":"5","title":"anon-ws-disable-stacked-tor breaks installation of onioncat due to missing sysvinit script","status":"resolved","priority":"Normal","author":"Patrick","description":"anon-ws-disable-stacked-tor `debian/control`: `Provides: tor`\n\nOnioncat (and perhaps others) expect Tor's sysvinit script / systemd service to be enabled before installation (as per `debian/control` `Pre-Depends: tor`). Therefore installation of onioncat (and perhaps other packages) is currently broken on Whonix-Workstation. This is a bug in anon-ws-disable-stacked-tor.\n\nSolution:\n* provide a dummy sysvinit script that `# Provides:          tor`\n* provide a dummy systemd service\n\nOriginal user issue:\nhttps://www.whonix.org/forum/index.php/topic,742.0.html\n\nWorkaround in meanwhile:\nmanually install Tor before installing onioncat.\n\nInstall Tor. (There will be no Tor over Tor - because of anon-ws-disable-stacked-tor.)\n\nsudo apt-get install tor\n\nThen install onioncat.\n\nsudo apt-get install onioncat\n","comments":[{"author":"Patrick","date_created":1423753812,"date_modified":1423753812,"content":"> provide a dummy sysvinit script that `# Provides:          tor`\n\nProduced a branch that implements this:\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/tree/tor_init_script\n\nIt doesn't work when the `tor` package is already installed.\n\n```\ninsserv: script tor.anondist: service tor already provided!\ninsserv: exiting now!\nupdate-rc.d: error: insserv rejected the script header\n```\n"},{"author":"Patrick","date_created":1423755751,"date_modified":1423755751,"content":"Found a fix:\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/commit/ccbbd7588315e007878f3e772133112af340f689\n\nDone:\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/commit/68e57a2fe5694302d6b1fa906c37ef2c85240a9a\n"},{"author":"Patrick","date_created":1423776412,"date_modified":1423776412,"content":"Fix:\nhttps://github.com/Whonix/anon-ws-disable-stacked-tor/commit/3268b3e63c7908ab3c5ae9267c06795684459e7f"}]},"PHID-TASK-onvam6pysxt4onl2nf77":{"id":"4","title":"sdwdate --cache-dir command line parameter","status":"resolved","priority":"Normal","author":"Patrick","description":"sdwdate lacks a --cache-dir command line parameter.","comments":[{"author":"Patrick","date_created":1418068376,"date_modified":1418068376,"content":"Might not be needed if we switch to sclockadj2. References:\nhttps://github.com/Whonix/Whonix/issues/363\nhttps://github.com/Whonix/sdwdate/pull/4\n"},{"author":"Patrick","date_created":1424716701,"date_modified":1424716701,"content":"Done:\nhttps://github.com/Whonix/sdwdate/commit/099757a1d4a77d056371f5edf319b2bc0bcf02bc"}]},"PHID-TASK-v6etgadn4so6o4loicda":{"id":"3","title":"sdwdate --temp-dir command line parameter","status":"resolved","priority":"Normal","author":"Patrick","description":"sdwdate lacks a --temp-dir command line parameter.","comments":[{"author":"Patrick","date_created":1424716681,"date_modified":1424716681,"content":"Done:\nhttps://github.com/Whonix/sdwdate/commit/099757a1d4a77d056371f5edf319b2bc0bcf02bc"}]},"PHID-TASK-zaap6xmozkasmjns35rl":{"id":"2","title":"obsolete make_mydir variable","status":"resolved","priority":"Normal","author":"Patrick","description":"Obsolete make_mydir variable in\n* debug-steps/packaging-helper-script\n* build-steps.d/1200_create-debian-packages in `cowbuilder` branch","comments":[]},"PHID-TASK-g22jdwmnjfvll6kvrexd":{"id":"1","title":"makefile for generic packages changes","status":"resolved","priority":"Normal","author":"Patrick","description":"* ~~to use/not use '--rootcmd=\"$PWD/debian/gain-root-command\"'~~ (done)\n* ~~to use/not set upstream/debian tarball file name to lower case~~ (done)\n* ~~to use/not use lintian~~ (done)\n* ~~do net set DEBMAIL to my adrelanos personal e-mail address if not set~~ (done)\n* ~~make git-tag-sign (for devs: git tag sign latest debian/changelog version)~~ (done)\n* ~~make git-tag-verify (for devs: verify latest git tag)~~ (done)\n* ~~make git-tag-check (for devs: check if current git head is a signed git tag)~~ (done)\n* ~~make git-commit-verify (for devs: check if current git head is a signed git commit)~~ (done)\n* ~~make git-verify (dev devs: combination of tag-check and commit-verify)~~ (done)\n* compatibility with setup.py packaging method\n** run `build_deb.sh` if existing\n** ~~make deb-clean: also delete `deb_dist` folder~~ (done)\n** move created deb to parent folder","comments":[{"author":"Patrick","date_created":1416500584,"date_modified":1416500584,"content":"https://www.whonix.org/forum/index.php/topic,378.0.html"}]}}